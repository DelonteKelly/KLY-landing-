<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cosmic Navigator — Starship Guidance System</title>

  <!-- Fonts & tiny animation lib -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --space-dark:#0a0a20;
      --energy-blue:#00b4ff;
      --hologram-teal:#00ffcc;
      --star-gold:#ffd700;
      --panel-glow:rgba(0,180,255,0.22);
      --muted:#9aa0c7;
      --warn:#ff5577;
      --ok:#2ecc71;
      --bsc:#F0B90B;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    body{
      font-family: 'Exo 2', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--space-dark);
      color: #e8eefc;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2rem;
      overflow-x:hidden;
    }

    .container{width:100%;max-width:980px;z-index:10;position:relative;text-align:center}

    h1{
      font-family:'Orbitron', monospace;color:var(--energy-blue);
      font-weight:900;letter-spacing:3px;font-size:2.6rem;text-transform:uppercase;
      text-shadow:0 0 18px rgba(0,180,255,0.18);margin-bottom:.5rem;
    }
    .subtitle{color:var(--hologram-teal);margin-bottom:1.35rem;font-size:1rem;font-weight:300}

    .panel{
      background: rgba(8, 12, 25, 0.86);
      border-radius:12px;padding:2rem;
      box-shadow: 0 0 38px var(--panel-glow), inset 0 0 18px rgba(0,180,255,0.03);
      border:1px solid rgba(0,180,255,0.08);backdrop-filter: blur(6px);transform: translateZ(0);
    }

    .prompt{font-size:1.05rem;color:var(--muted);margin-bottom:1rem;max-width:820px;margin-inline:auto}

    .gate{
      margin: .6rem auto 1rem auto;max-width:820px;text-align:center;font-size:.95rem;
      padding:.6rem .8rem;border-radius:8px;border-left:4px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    }

    .wallet-row{
      display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-bottom:.6rem
    }

    .status{
      display:flex;gap:.5rem;align-items:center;justify-content:center;flex-wrap:wrap;
      font-size:.95rem;color:var(--muted);margin-bottom:.6rem
    }
    .badge{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.35rem .6rem;border-radius:999px;font-size:.85rem;border:1px solid rgba(255,255,255,.1)
    }
    .bsc{ background: rgba(240,185,11,.12); color:#fff; border-color: rgba(240,185,11,.4) }
    .locked{ background: rgba(255,85,119,.12); color:#fff; border-color: rgba(255,85,119,.4) }
    .unlocked{ background: rgba(46,204,113,.12); color:#fff; border-color: rgba(46,204,113,.4) }

    .input-row{display:flex;gap:1rem;justify-content:center;align-items:flex-start;flex-wrap:wrap;margin:1rem 0}
    textarea#query{
      width:100%;max-width:740px;min-height:100px;padding:14px;border-radius:8px;
      border:1px solid rgba(0,180,255,0.14);background: rgba(2,8,20,0.6);color:#eaf6ff;
      resize:vertical;font-size:1rem;font-family: inherit;
    }
    textarea#query::placeholder{ color: #8f95b8 }

    .controls{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-top:.75rem}
    button.btn{
      background: linear-gradient(135deg,var(--energy-blue), #9c27b0);
      border:none;color:#071226;padding:14px 26px;border-radius:8px;
      font-weight:700;letter-spacing:.8px;cursor:pointer;min-width:200px;
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s;
      font-family: 'Orbitron', monospace;
    }
    button.btn.secondary{background: linear-gradient(135deg,#2b2b4d,#4a4a8a);color:#e8eefc;min-width:160px}
    button.btn:active{ transform:translateY(2px) }
    button.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none }

    .loading{color:var(--hologram-teal);font-family:'Orbitron', monospace;margin-top:.6rem;display:none}
    .loading.show{ display:inline-block }

    .response{
      margin-top:1.25rem;max-width:820px;margin-inline:auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-left:4px solid var(--hologram-teal);padding:1.15rem 1.25rem;border-radius:8px;
      color:#e9f7ff;font-style:italic;display:none;text-align:left;white-space:pre-wrap;font-size:1rem;
    }
    .response.revealed{ display:block; animation: fadeInUp .9s ease both }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }

    .meta{margin-top:1rem;color:var(--muted);font-size:.9rem}

    .starfield{position:fixed; inset:0; z-index:0; pointer-events:none}
    .star{ position:absolute; background:white; border-radius:50%; opacity:.9 }

    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    @media (prefers-reduced-motion:reduce) {
      .star { animation:none !important; }
      .container, .panel, button { transition:none !important; animation:none !important; }
    }
    @media (max-width:720px) {
      h1{ font-size:1.9rem }
      .prompt{ font-size:.95rem }
      button.btn{ min-width: 140px; padding:12px 16px }
      textarea#query{ min-height:90px }
    }
  </style>
</head>
<body>
  <!-- Starfield background -->
  <div class="starfield" id="starfield" aria-hidden="true"></div>

  <main class="container" role="main">
    <h1 class="animate__animated animate__fadeInDown">COSMIC NAVIGATOR</h1>
    <p class="subtitle">Starship Guidance System — wallet-gated by 100 KLY (BSC)</p>

    <section class="panel" aria-labelledby="panelTitle">
      <h2 id="panelTitle" class="sr-only">Navigation Panel</h2>
      <p class="prompt">
        Connect your wallet on <strong>BSC</strong>. Holding <strong>≥ 100 KLY</strong> unlocks the Navigator.<br/>
        Type your route request and plot your course through the blockchain cosmos.
      </p>

      <!-- Wallet + gate -->
      <div class="wallet-row">
        <button id="connectBtn" class="btn secondary">Connect Wallet</button>
        <button id="refreshBtn" class="btn secondary">Refresh Balance</button>
      </div>

      <div class="status" id="statusBar">
        <span class="badge bsc" id="netBadge">Network: unknown</span>
        <span class="badge locked" id="gateBadge">Gate: locked (need ≥ 100 KLY)</span>
      </div>
      <div class="gate" id="gateInfo">
        Address: <span id="addr">Not connected</span> • KLY Balance: <span id="klyBal">0</span>
      </div>

      <div class="input-row" role="form" aria-labelledby="panelTitle">
        <label for="query" class="sr-only">Navigation query</label>
        <textarea id="query" placeholder="e.g. 'Route to liquidity pool X. Avoid whales.'"></textarea>
      </div>

      <div class="controls">
        <button id="plotBtn" class="btn" aria-controls="navigationResponse" disabled>Plot Course</button>
        <button id="clearBtn" class="btn secondary" aria-label="Clear input">Clear</button>
      </div>

      <div class="loading" id="loading" aria-live="polite">Calculating trajectory…</div>

      <div id="navigationResponse" class="response" role="status" aria-live="polite"></div>

      <p class="meta">Demo uses faux AI responses locally. Wallet balance read comes from your wallet’s BSC RPC. No backend or keys required.</p>
    </section>
  </main>

  <!-- Web3.js for wallet & contract reads -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script>
    /******************************************************************
     * Config — BSC + KLY
     ******************************************************************/
    const REQUIRED_KLY = 100; // gate threshold
    const BSC_MAINNET = {
      chainId: '0x38',
      chainName: 'Binance Smart Chain Mainnet',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: ['https://bsc-dataseed.binance.org/'],
      blockExplorerUrls: ['https://bscscan.com']
    };

    const KLY_ADDRESS = '0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52';
    const ERC20_ABI = [
      { "constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function" },
      { "constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function" },
      { "constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function" }
    ];

    let web3, provider, accounts = [], chainId, klyDecimals = 18;

    function isWeb3Installed(){ return typeof window.ethereum !== 'undefined'; }

    async function switchToBSC(){
      try{
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[BSC_MAINNET] });
        return true;
      }catch(e){ console.error('Switch to BSC error:', e); return false; }
    }

    async function connectWallet(){
      if(!isWeb3Installed()){
        alert('Please install MetaMask or a Web3 wallet extension.');
        return;
      }
      try{
        provider = window.ethereum;
        accounts = await provider.request({ method: 'eth_requestAccounts' });
        chainId = await provider.request({ method: 'eth_chainId' });

        if(chainId !== BSC_MAINNET.chainId){
          if(confirm('This app uses BSC. Switch now?')){
            const ok = await switchToBSC();
            if(!ok) alert('Please switch to BSC in your wallet.');
            chainId = await provider.request({ method:'eth_chainId' });
          }
        }

        web3 = new Web3(provider);
        await updateNetworkBadge();
        await refreshKly();

        // listeners
        provider.on('accountsChanged', async (a)=>{
          accounts = a;
          await refreshKly();
        });
        provider.on('chainChanged', async (cid)=>{
          chainId = cid;
          await updateNetworkBadge();
          await refreshKly();
        });
      }catch(err){
        console.error('Wallet connect error:', err);
      }
    }

    function shortAddr(addr){
      return (addr && addr.length > 8) ? `${addr.slice(0,6)}...${addr.slice(-4)}` : addr || 'Not connected';
    }

    async function updateNetworkBadge(){
      const netBadge = document.getElementById('netBadge');
      if(chainId === '0x38'){
        netBadge.textContent = 'Network: BSC Mainnet';
        netBadge.className = 'badge bsc';
      }else if(chainId){
        netBadge.textContent = `Network: ${chainId}`;
        netBadge.className = 'badge';
      }else{
        netBadge.textContent = 'Network: unknown';
        netBadge.className = 'badge';
      }
    }

    async function refreshKly(){
      const addrEl = document.getElementById('addr');
      const balEl = document.getElementById('klyBal');
      const gateBadge = document.getElementById('gateBadge');
      const plotBtn = document.getElementById('plotBtn');

      const addr = accounts && accounts[0] ? accounts[0] : null;
      addrEl.textContent = shortAddr(addr);

      if(!addr || chainId !== BSC_MAINNET.chainId){
        balEl.textContent = '0';
        gateBadge.textContent = 'Gate: locked (need ≥ 100 KLY)';
        gateBadge.className = 'badge locked';
        plotBtn.disabled = true;
        return;
      }

      try{
        const token = new web3.eth.Contract(ERC20_ABI, KLY_ADDRESS);
        // get decimals once (cache)
        try { klyDecimals = await token.methods.decimals().call(); } catch(_) {}
        const raw = await token.methods.balanceOf(addr).call();
        const human = Number(web3.utils.fromWei(raw, 'ether')) * Math.pow(10, 18 - klyDecimals); // adjust if decimals ≠ 18
        // Safer: use formatUnits logic equivalent (when decimals ≠ 18)
        const adj = Number(raw) / Math.pow(10, klyDecimals);
        const display = isFinite(adj) ? adj : human;

        balEl.textContent = display.toLocaleString(undefined, { maximumFractionDigits: 6 });

        if(display >= REQUIRED_KLY){
          gateBadge.textContent = 'Gate: unlocked (≥ 100 KLY)';
          gateBadge.className = 'badge unlocked';
          plotBtn.disabled = false;
        }else{
          gateBadge.textContent = 'Gate: locked (need ≥ 100 KLY)';
          gateBadge.className = 'badge locked';
          plotBtn.disabled = true;
        }
      }catch(err){
        console.error('KLY read error:', err);
        balEl.textContent = '—';
        gateBadge.textContent = 'Gate: error reading KLY';
        gateBadge.className = 'badge locked';
        plotBtn.disabled = true;
      }
    }

    /******************************************************************
     * Faux AI (50 responses) — local only, no backend needed
     ******************************************************************/
    const FAUX_RESPONSES = [
      "Course plotted. Stellar confirmations align within three cycles.",
      "Quantum drive engaged. Liquidity nebula ahead — maintain thrust.",
      "Decentralized wormhole detected. Path is optimal.",
      "Thrusters balanced. Transaction warp speed nominal.",
      "Stellar ledger synchronization complete. Proceed.",
      "Cosmic validators approve your trajectory.",
      "Fuel cells stable. Layer-2 shortcut recommended.",
      "Course intersects with starlight of governance. Safe passage.",
      "Covenant coordinates verified. Navigation greenlit.",
      "Consensus achieved — route secure.",
      "Space-time hash locked. Prepare for confirmation.",
      "Entropy low. Gas costs minimal. Warp drive optimal.",
      "Orbital nodes report: stability confirmed.",
      "Stellar relay confirms quorum. Push forward.",
      "Nebula cleared. Multi-sig constellations aligned.",
      "Solar beacon detected — route efficiency high.",
      "Your signal echoes across validator galaxies. Safe to proceed.",
      "Planetary chain finality assured.",
      "Protocol stargate open. Warp complete in 2 blocks.",
      "Quantum checksum verified. No anomalies.",
      "Stellar liquidity pools detected — path smooth.",
      "Energy resonance matches covenant frequency.",
      "Your ship aligns with covenant star charts.",
      "Navigation satellites approve trajectory.",
      "Wormhole to Layer-2 active. Course accelerated.",
      "Zero-knowledge veil engaged — stealth passage guaranteed.",
      "Cross-chain constellations visible. Bridge stable.",
      "The block horizon clears. Your path is luminous.",
      "Validators chant in harmony. Proceed through cosmos.",
      "Time dilation minimal. Gas stable.",
      "Stellar hash sync verified. Warp countdown initiated.",
      "Governance council approves quantum route.",
      "Liquidity gravity wells avoided. Path secure.",
      "Entropy mitigation successful. Navigation clear.",
      "Your signal encoded in cosmic scrolls. Proceed.",
      "Multiverse routers confirm the way is open.",
      "Covenant stars align. Trajectory flawless.",
      "Starlight index stable — no slippage expected.",
      "Comet trail confirms fast settlement.",
      "Nebula hash scatter balanced. Travel smooth.",
      "Plasma conduits charge complete.",
      "Prophecy of the Oracle: confirmations flow soon.",
      "Staking constellations lend stability to your course.",
      "Signal to chain noise ratio excellent.",
      "Finality horizon visible — secure destination ahead.",
      "Quantum entanglement lock established. No drift.",
      "The great validator ring hums in approval.",
      "Energy cores resonate with covenant pulse.",
      "Navigation matrix locked. Stellar epoch aligned.",
      "Your course is woven into the cosmic chain. Destiny awaits."
    ];

    function seedFromString(str) {
      let seed = 0;
      for (let i = 0; i < str.length; i++) {
        seed = ((seed << 5) - seed) + str.charCodeAt(i);
        seed |= 0;
      }
      return Math.abs(seed);
    }

    function fauxAI(query) {
      if (!query || !query.trim()) {
        return "Please enter a navigation query. Try: “Route to liquidity pool X, avoid large slippage.”";
      }
      const baseSeed = seedFromString(query);
      const timeSlice = Math.floor(Date.now() / (1000 * 60 * 60));
      const mixed = (baseSeed ^ timeSlice) >>> 0;

      const idx = mixed % FAUX_RESPONSES.length;
      const etaBlocks = 1 + (mixed % 4);
      const tips = [
        "Consider a staggered approach to reduce slip.",
        "Keep gas limits conservative during high volatility.",
        "If bridged, verify bridge contract addresses.",
        "A small delay reduces MEV risk.",
        "Use a reputable relayer for cross-chain hops.",
        "Split into smaller transactions if whale activity is suspected."
      ];
      const tip = tips[(mixed >>> 3) % tips.length];

      const main = FAUX_RESPONSES[idx];
      return `${main}\n\nGuidance: ${tip}\nETA: approx. ${etaBlocks} block(s).`;
    }

    /******************************************************************
     * UI Wiring
     ******************************************************************/
    const plotBtn = document.getElementById('plotBtn');
    const clearBtn = document.getElementById('clearBtn');
    const connectBtn = document.getElementById('connectBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const queryEl = document.getElementById('query');
    const loadingEl = document.getElementById('loading');
    const respEl = document.getElementById('navigationResponse');

    plotBtn.addEventListener('click', async () => {
      // hard gate: must have wallet + ≥ 100 KLY
      if(!(accounts && accounts[0]) || chainId !== BSC_MAINNET.chainId){
        alert('Connect your wallet on BSC to proceed.');
        return;
      }
      if(plotBtn.disabled){
        alert('Gate locked — you need ≥ 100 KLY to access the Navigator.');
        return;
      }

      const q = queryEl.value.trim();
      if (!q) {
        alert('Please enter a navigation query or coordinates.');
        queryEl.focus();
        return;
      }

      loadingEl.classList.add('show');
      plotBtn.disabled = true;
      clearBtn.disabled = true;
      respEl.className = 'response';
      respEl.style.display = 'none';
      respEl.textContent = '';

      setTimeout(() => {
        try {
          const answer = fauxAI(q);
          respEl.textContent = answer;
          respEl.classList.add('revealed');
          respEl.setAttribute('aria-live', 'polite');
        } catch (e) {
          respEl.textContent = 'Navigation systems offline. Try again later.';
          respEl.classList.add('revealed');
        } finally {
          loadingEl.classList.remove('show');
          // Keep gate enforced; user can clear and ask again
          clearBtn.disabled = false;
        }
      }, 650 + (Math.random() * 600));
    });

    clearBtn.addEventListener('click', () => {
      queryEl.value = '';
      respEl.className = 'response';
      respEl.style.display = 'none';
      respEl.textContent = '';
      // Re-enable plot only if gate is satisfied; refreshKly controls disabled state
      refreshKly();
      queryEl.focus();
    });

    connectBtn.addEventListener('click', connectWallet);
    refreshBtn.addEventListener('click', refreshKly);

    queryEl.addEventListener('keydown', (ev) => {
      if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
        plotBtn.click();
      }
    });

    /********** Starfield generation **********/
    function createStarfield() {
      const container = document.getElementById('starfield');
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const total = reduceMotion ? 40 : 140;

      for (let i = 0; i < total; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        const size = (Math.random() * 2.8) + 0.6;
        s.style.width = `${size}px`;
        s.style.height = `${size}px`;
        s.style.left = `${Math.random() * 100}%`;
        s.style.top = `${Math.random() * 100}%`;
        const dur = (Math.random() * 8) + 3;
        if (!reduceMotion) {
          s.style.animation = `twinkle ${dur}s linear ${Math.random() * 5}s infinite`;
        }
        s.style.opacity = `${0.3 + Math.random() * 0.9}`;
        container.appendChild(s);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      createStarfield();
      queryEl.focus();
      // If wallet already authorized in some browsers, attempt silent init
      if(window.ethereum && window.ethereum.selectedAddress){
        connectWallet();
      }
    });
  </script>

  <style>
    /* Twinkle animation (kept separate so JS can toggle it via reduced motion) */
    @keyframes twinkle {
      0%, 100% { opacity: 0.25; }
      50% { opacity: 1; }
    }
  </style>
</body>
</html>
