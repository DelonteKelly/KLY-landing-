<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oracle Codex: Scrolls of the Chain</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
  <style>
    /* ---------- your original styles (trimmed) ---------- */
    :root{--parchment:#f5e9d9;--ink:#3a3226;--gold:#d4af37;--magic-blue:#4fc3f7;--magic-purple:#9c27b0;--shadow-blue:rgba(79,195,247,.5);--shadow-purple:rgba(156,39,176,.5)}
    body{font-family:'Cinzel','Times New Roman',serif;background:#0a0a12;color:var(--ink);text-align:center;margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow-x:hidden;background-image:
      radial-gradient(circle at 10% 20%, rgba(79,195,247,.1) 0%, transparent 20%),
      radial-gradient(circle at 90% 80%, rgba(156,39,176,.1) 0%, transparent 20%),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230a0a12"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23333" stroke-width="0.5"/></svg>')}
    .container{max-width:900px;margin:2rem auto;position:relative;perspective:1000px;z-index:10}
    h1{font-size:3.5em;color:var(--gold);text-shadow:0 0 10px rgba(212,175,55,.7);margin-bottom:2rem;letter-spacing:2px;font-weight:700;text-transform:uppercase}
    h1::after{content:"";display:block;width:200px;height:4px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:15px auto;box-shadow:0 0 15px var(--gold)}
    .scroll-container{position:relative;padding:2rem 0;overflow:hidden;transform-style:preserve-3d}
    .scroll{background:var(--parchment);padding:4rem 5rem;margin:0 auto;border-radius:5px;box-shadow:0 0 30px rgba(212,175,55,.5),0 0 60px rgba(79,195,247,.3);position:relative;transform-style:preserve-3d;transition:all .8s cubic-bezier(.175,.885,.32,1.275);max-height:0;opacity:0;overflow:hidden;border:1px solid rgba(212,180,131,.7);transform:rotateX(15deg) translateY(50px)}
    .scroll.active{max-height:1600px;opacity:1;animation:fadeIn 1.5s ease-out,glowPulse 8s infinite alternate;transform:rotateX(0) translateY(0)}
    .scroll::before,.scroll::after{content:"";position:absolute;height:100%;width:50px;top:0;background:linear-gradient(to right,var(--parchment),rgba(212,180,131,.8),var(--parchment));box-shadow:0 0 25px rgba(212,175,55,.7);z-index:5}
    .scroll::before{left:-25px;border-radius:8px 0 0 8px;transform:rotateY(-30deg) translateX(-10px)}
    .scroll::after{right:-25px;border-radius:0 8px 8px 0;transform:rotateY(30deg) translateX(10px)}
    .scroll-content{min-height:400px;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;z-index:2}
    .initial-prompt{font-size:1.2em;margin-bottom:1.25rem;line-height:1.6;max-width:700px;padding:1rem;background:rgba(255,255,255,.2);border-radius:8px;border-left:4px solid var(--gold);font-family:'MedievalSharp',cursive}
    .qbox{width:100%;max-width:700px;margin:0 0 1rem 0;display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
    .qbox textarea{flex:1;min-height:80px;padding:12px;border-radius:8px;border:1px solid rgba(212,175,55,.4);background:rgba(255,255,255,.9);font-family:serif;font-size:1rem}
    .button-group{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin:1rem 0}
    button{background:linear-gradient(135deg,var(--magic-purple),var(--magic-blue));color:#fff;border:none;padding:14px 28px;font-size:1.05em;border-radius:30px;cursor:pointer;transition:.3s;box-shadow:0 5px 20px rgba(0,0,0,.3);font-family:'Cinzel',serif;text-transform:uppercase;letter-spacing:1px;min-width:220px;border:1px solid rgba(255,255,255,.2)}
    button.secondary{background:linear-gradient(135deg,#3a3226,#5d5342)}
    .oracle-message{font-style:italic;font-size:1.3em;line-height:1.7;margin:1.25rem 0;padding:1.25rem;border-radius:8px;background:rgba(255,255,255,.4);border-left:4px solid var(--gold);display:none;max-width:700px;font-family:'MedievalSharp',cursive;backdrop-filter:blur(5px)}
    .oracle-message.revealed{display:block;animation:messageAppear 1s forwards}
    /* FIX: real quotes instead of """ */
    .oracle-message::before{content:"“";font-size:2.2em;color:var(--gold);opacity:.35;position:absolute;top:-10px;left:-6px}
    .oracle-message::after{content:"”";font-size:2.2em;color:var(--gold);opacity:.35;position:absolute;bottom:-20px;right:-6px}
    .web3-section{margin-top:1rem;padding:1.25rem;background:rgba(15,15,25,.8);border-radius:12px;border:1px solid var(--magic-blue);display:none;width:100%;max-width:700px;backdrop-filter:blur(5px);box-shadow:0 0 30px rgba(79,195,247,.2)}
    .web3-section.visible{display:block}
    .wallet-address{font-family:monospace;word-break:break-all;color:var(--gold);background:rgba(0,0,0,.3);padding:.5rem 1rem;border-radius:4px;border:1px solid rgba(212,175,55,.3)}
    .network-info{display:flex;justify-content:center;align-items:center;gap:.5rem;margin:.5rem 0}
    .network-indicator{width:12px;height:12px;border-radius:50%;background:#4CAF50;box-shadow:0 0 10px #4CAF50}
    .spinner{display:none;margin-top:.5rem;font-size:.95rem;color:#ddd}
    .spinner.show{display:inline-block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes glowPulse{0%{box-shadow:0 0 30px rgba(212,175,55,.5),0 0 60px rgba(79,195,247,.3)}50%{box-shadow:0 0 50px rgba(212,175,55,.7),0 0 100px rgba(79,195,247,.5)}100%{box-shadow:0 0 30px rgba(212,175,55,.5),0 0 60px rgba(79,195,247,.3)}}
    @keyframes messageAppear{0%{transform:scale(.97);opacity:0}80%{transform:scale(1.01);opacity:1}100%{transform:scale(1);opacity:1}}
    /* responsive rules kept as-is or trimmed for brevity */
  </style>
</head>
<body>
  <div class="container">
    <h1 class="animate__animated animate__fadeInDown">Web3 Oracle Scrolls</h1>

    <div class="scroll-container">
      <div class="scroll" id="oracleScroll">
        <div class="scroll-content">
          <div class="initial-prompt">
            Ask one clear question below and invoke the Oracle. Wisdom returns with on-chain precision.
          </div>

          <!-- NEW: user question box -->
          <div class="qbox">
            <textarea id="userQuestion" placeholder="Type your question for the Oracle..."></textarea>
          </div>

          <div class="button-group">
            <button id="consultButton" class="animate__animated animate__pulse animate__infinite">Invoke the Oracle</button>
            <button id="connectWallet" class="secondary">Connect Web3 Wallet</button>
          </div>

          <div class="spinner" id="loadingSpinner">Consulting the Oracle…</div>
          <div class="oracle-message" id="oracleMessage"></div>

          <div class="web3-section" id="web3Section">
            <h3>Web3 Revelation</h3>
            <div id="walletInfo">
              <div class="network-info">
                <div class="network-indicator" id="networkIndicator"></div>
                <span id="networkName">Binance Smart Chain</span>
              </div>
              <p>Connected Wallet: <span class="wallet-address" id="walletAddress">Not connected</span></p>
              <p class="token-balance">Balance: <span id="tokenBalance">0</span> <span id="tokenSymbol">BNB</span></p>
            </div>
          </div>

          <button id="tryAgain" class="secondary" style="display:none;">Seek Further Wisdom</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script>
    /* ------------------ CONFIG ------------------ */
    // Point this to your real backend route
    const ORACLE_ENDPOINT = '/api/oracle';  // e.g. '/api/oracle' or 'https://yourdomain.com/api/oracle'

    // Minimal random lines kept as a graceful fallback
    const fallbackMessages = [
      "The DAO of your destiny votes unanimously: the path forward is decentralized.",
      "A smart contract in your future bears unexpected fruit. Verify all variables before signing.",
      "Look to Layer 2 when the mainnet grows congested.",
      "When patience meets the next epoch, your transaction confirms in abundance."
    ];

    /* ------------- Wallet / Web3 state ---------- */
    let web3, provider, accounts = [], chainId, walletConnected = false;

    const BSC_MAINNET = {
      chainId: '0x38',
      chainName: 'Binance Smart Chain Mainnet',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: ['https://bsc-dataseed.binance.org/'],
      blockExplorerUrls: ['https://bscscan.com']
    };

    function isWeb3Installed(){ return typeof window.ethereum !== 'undefined'; }

    async function switchToBSC(){
      try{
        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [BSC_MAINNET] });
        return true;
      }catch(e){ console.error('Failed to switch to BSC:', e); return false; }
    }

    async function initWeb3(){
      if(!isWeb3Installed()){
        alert('Please install MetaMask or a Web3 wallet extension!');
        const btn = document.getElementById('connectWallet');
        btn.textContent = 'Install Wallet';
        btn.onclick = ()=> window.open('https://metamask.io/', '_blank');
        return;
      }
      try{
        const btn = document.getElementById('connectWallet');
        btn.textContent = 'Connecting...'; btn.disabled = true;

        provider = window.ethereum;
        accounts = await provider.request({ method: 'eth_requestAccounts' });
        chainId = await provider.request({ method: 'eth_chainId' });

        if(chainId !== BSC_MAINNET.chainId){
          if(confirm('This dapp works on BSC. Switch now?')){
            const switched = await switchToBSC();
            if(!switched) alert('Please switch to BSC manually in your wallet.');
            chainId = await provider.request({ method: 'eth_chainId' });
          }
        }

        web3 = new Web3(provider);
        updateWalletInfo(accounts[0], chainId);
        walletConnected = true;
        setupEventListeners();
        loadWalletData(accounts[0]);

      }catch(err){
        console.error('Wallet connect error:', err);
        resetWalletConnection();
      }
    }

    function updateWalletInfo(address, chainIdHex){
      const short = `${address.slice(0,6)}...${address.slice(-4)}`;
      document.getElementById('walletAddress').textContent = short;
      document.getElementById('walletAddress').title = address;

      const btn = document.getElementById('connectWallet');
      btn.textContent = 'Connected';
      btn.style.background = 'linear-gradient(135deg,#4CAF50,#2E7D32)';
      btn.disabled = false;

      const indicator = document.getElementById('networkIndicator');
      const nameEl = document.getElementById('networkName');
      const map = { '0x1': {name:'Ethereum Mainnet', color:'#29b6af'}, '0x38': {name:'BSC Mainnet', color:'#F0B90B'} };
      const meta = map[chainIdHex] || { name:`Unsupported (${chainIdHex})`, color:'#ff5722' };
      nameEl.textContent = meta.name; indicator.style.backgroundColor = meta.color; indicator.style.boxShadow = `0 0 10px ${meta.color}`;
    }

    async function loadWalletData(address){
      try{
        document.getElementById('tokenBalance').textContent = 'Loading...';
        const balWei = await web3.eth.getBalance(address);
        document.getElementById('tokenBalance').textContent = parseFloat(web3.utils.fromWei(balWei,'ether')).toFixed(4);
        document.getElementById('web3Section').classList.add('visible');
      }catch(e){
        console.error('Balance error:', e);
        document.getElementById('tokenBalance').textContent = 'Error';
      }
    }

    function setupEventListeners(){
      if(!provider) return;
      provider.on('accountsChanged', (a)=>{ accounts = a; a.length ? (updateWalletInfo(a[0], chainId), loadWalletData(a[0])) : resetWalletConnection(); });
      provider.on('chainChanged', (cid)=>{ chainId = cid; updateWalletInfo(accounts[0]||'0x0', cid); if(accounts.length) loadWalletData(accounts[0]); });
    }

    function resetWalletConnection(){
      walletConnected = false; accounts = [];
      document.getElementById('walletAddress').textContent = 'Not connected';
      const btn = document.getElementById('connectWallet');
      btn.textContent = 'Connect Web3 Wallet';
      btn.style.background = 'linear-gradient(135deg,var(--magic-purple),var(--magic-blue))';
      btn.disabled = false;
      document.getElementById('tokenBalance').textContent = '0';
    }

    /* ------------- ORACLE CALL --------------- */
    async function callOracle(question){
      const spinner = document.getElementById('loadingSpinner');
      const msgEl = document.getElementById('oracleMessage');
      spinner.classList.add('show');
      msgEl.className = 'oracle-message'; msgEl.style.display = 'none'; msgEl.textContent = '';

      try{
        const payload = {
          question,
          address: (accounts[0] || null),
          chainId: chainId || null
        };

        const res = await fetch(ORACLE_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          // Show any error string sent by backend if present
          const maybeText = await res.text().catch(()=> '');
          throw new Error(maybeText || `Oracle HTTP ${res.status}`);
        }

        const data = await res.json();
        const answer = (data && (data.answer || data.message)) || 'The Oracle is silent…';
        msgEl.textContent = answer;
      }catch(err){
        console.error('Oracle error:', err);
        // graceful fallback so the UI still “works”
        const fallback = fallbackMessages[Math.floor(Math.random()*fallbackMessages.length)];
        msgEl.textContent = `${fallback}\n\n[offline fallback shown due to: ${err.message}]`;
      }finally{
        spinner.classList.remove('show');
        msgEl.classList.add('revealed');
        msgEl.style.display = 'block';
        document.getElementById('consultButton').style.display = 'none';
        document.getElementById('tryAgain').style.display = 'block';
      }
    }

    /* ------------- UI EVENTS ----------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      // simple “unfurl”
      setTimeout(()=> document.getElementById('oracleScroll').classList.add('active'), 400);

      document.getElementById('consultButton').addEventListener('click', ()=>{
        const q = (document.getElementById('userQuestion').value || '').trim();
        if(!q){ alert('Ask the Oracle a clear question first.'); return; }
        callOracle(q);
      });

      document.getElementById('connectWallet').addEventListener('click', initWeb3);

      document.getElementById('tryAgain').addEventListener('click', ()=>{
        document.getElementById('oracleMessage').className = 'oracle-message';
        document.getElementById('oracleMessage').style.display = 'none';
        document.getElementById('consultButton').style.display = 'block';
        document.getElementById('tryAgain').style.display = 'none';
        document.getElementById('userQuestion').focus();
      });

      // Auto-connect if wallet already authorized in some browsers
      if(window.ethereum && window.ethereum.selectedAddress){ initWeb3(); }
    });
  </script>
</body>
</html>
