<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚ö° Sovereign Nexus | Tamaquah Nation</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    :root {
      --primary: #00f0ff;
      --secondary: #0a0a20;
      --accent: #7b2dff;
      --text: #e0e0ff;
      --error: #ff3860;
      --success: #2dff9e;
    }

    body {
      background: radial-gradient(circle at center, #0a0a30 0%, #000010 100%);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: radial-gradient(circle at center, #0a0a30 0%, #000010 100%);
    }

    .cyber-glowing { animation: glitch 2s infinite; }
    @keyframes glitch {
      0%, 100% { text-shadow: 0 0 10px var(--primary); }
      20% { text-shadow: -2px 0 red; }
      40% { text-shadow: 2px 0 cyan; }
      60% { text-shadow: -1px 0 lime; }
      80% { text-shadow: 1px 0 yellow; }
    }

    .neon-pulse { animation: pulse 2s infinite alternate; }
    @keyframes pulse {
      from { box-shadow: 0 0 5px var(--primary); }
      to { box-shadow: 0 0 20px var(--primary), 0 0 30px var(--accent); }
    }

    #introOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: black; z-index: 9999;
      display: flex; justify-content: center; align-items: center;
      font-size: 1.8rem;
    }

    .container {
      max-width: 1000px; margin: 3rem auto;
      background: rgba(10, 10, 30, 0.8); backdrop-filter: blur(10px);
      padding: 2.5rem; border-radius: 16px; border: 1px solid var(--primary);
      box-shadow: 0 0 30px rgba(0, 240, 255, 0.2), inset 0 0 20px rgba(0, 240, 255, 0.1);
    }

    h1 { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }
    .hidden { display: none; }

    .wallet-info, .success-message, .error-message { margin-top: 1rem; }
    .wallet-info {
      padding: 1.5rem; background: rgba(123, 45, 255, 0.1);
      border: 1px solid var(--accent); border-radius: 8px;
    }

    .btn {
      padding: 10px 20px; font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none; border-radius: 6px; color: #000; font-weight: bold;
      cursor: pointer; margin: 0.5rem 0; transition: 0.3s ease;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 240, 255, 0.4); }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-left: 0.5rem; }

    .vault-content { margin-top: 2rem; animation: fadeInScale 1.2s ease-out; opacity: 0; animation-fill-mode: forwards; }
    @keyframes fadeInScale { 0% { opacity: 0; transform: scale(0.95);} 100% { opacity: 1; transform: scale(1);} }

    .document-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
    .document-card { background: rgba(20, 20, 50, 0.6); padding: 1.5rem; border: 1px solid var(--accent); border-radius: 12px; backdrop-filter: blur(6px); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .document-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(123, 45, 255, 0.3); }
    .document-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }
    .document-actions { display: flex; margin-top: 1rem; gap: 0.5rem; flex-wrap: wrap; }
    .document-progress { margin-top: 1rem; }

    .cyber-terminal { margin-top: 2rem; background: rgba(0, 0, 20, 0.8); padding: 1rem; font-family: monospace; border: 1px solid var(--primary); border-radius: 8px; max-height: 300px; overflow-y: auto; }
    .cyber-terminal input { width: 100%; background: transparent; border: none; border-top: 1px solid var(--primary); padding: 0.5rem; color: var(--text); font-family: monospace; margin-top: 0.5rem; }

    footer { margin-top: 3rem; text-align: center; color: rgba(224, 224, 255, 0.4); }

    #assistantModal {
      position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
      background: #0a0a30; padding: 2rem; border: 2px solid var(--primary); border-radius: 12px;
      box-shadow: 0 0 20px var(--primary); max-width: 600px; width: 90%; z-index: 10000;
    }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .close-btn { background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; }
    .chat-history { height: 300px; overflow-y: auto; margin-bottom: 1rem; border-bottom: 1px solid rgba(0, 240, 255, 0.2); padding-bottom: 1rem; }
    .chat-message { margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 4px; }
    .chat-message.user { background: rgba(0, 240, 255, 0.1); }
    .chat-message.ai { background: rgba(123, 45, 255, 0.1); }
    .chat-input { display: flex; gap: 0.5rem; }
    .chat-input input { flex: 1; padding: 0.5rem; background: rgba(0, 0, 20, 0.8); border: 1px solid var(--primary); color: var(--text); border-radius: 4px; }
    .modal-footer { margin-top: 1rem; font-size: 0.8rem; text-align: center; color: rgba(224, 224, 255, 0.6); }

    :focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    @media (prefers-reduced-motion) { .cyber-glowing, .neon-pulse { animation: none !important; } }
    @media (max-width: 768px) { .container { padding: 1.5rem; } h1 { font-size: 2rem; } }
    @media (max-width: 480px) {
      .container { margin: 1rem; padding: 1rem; }
      .document-grid { grid-template-columns: 1fr; }
      .btn { padding: 8px 16px; font-size: 0.9rem; }
      .document-actions { flex-direction: column; }
      .btn-outline { margin-left: 0; }
    }
  </style>
</head>
<body>
<div id="particles-js"></div>

<!-- Intro Overlay -->
<div id="introOverlay" class="animate__animated animate__fadeIn">
  <h1 class="cyber-glowing">Decrypting Sovereign Nexus...</h1>
</div>

<div class="container">
  <h1 class="cyber-glowing">‚ö° SOVEREIGN NEXUS</h1>
  <p>Access the <strong>Decentralized Sovereignty Protocol</strong> with your Diamond Core NFT.</p>

  <div id="walletConnectSection">
    <button id="connectWallet" class="btn">ACTIVATE WALLET</button>
    <button id="switchToBSC" class="btn btn-outline hidden">SWITCH TO BSC</button>
    <div id="errorMessage" class="error-message hidden" style="color: var(--error); font-weight:bold;"></div>
    <div id="successMessage" class="success-message hidden" style="color: var(--success); font-weight:bold;"></div>
  </div>

  <!-- If user doesn't own the NFT -->
  <div id="mintSection" class="hidden" style="margin-top: 1rem;">
    <button id="mintDiamond" class="btn">MINT DIAMOND CORE NFT</button>
  </div>
  
  <div id="walletConnectedInfo" class="wallet-info hidden">
    <p>üõ°Ô∏è <strong>Wallet:</strong> <span id="walletAddress"></span></p>
    <p id="walletNetwork"></p>
    <p id="walletBalance"></p>
    <p id="nftStatus">üîí Checking Sovereignty Badge...</p>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <button id="disconnectWallet" class="btn">DISCONNECT</button>
      <button id="recheckNFT" class="btn btn-outline">RECHECK ACCESS</button>
    </div>
  </div>

  <!-- Sovereign ID Section -->
  <div id="sovereignSection" class="hidden" style="margin-top: 1rem;">
    <h3>ü™™ Sovereign ID</h3>
    <p>Create a signed DID tied to your wallet. (Local file, no server.)</p>
    <div class="document-actions">
      <button id="claimDid" class="btn">MINT DID</button>
      <button id="viewDid" class="btn btn-outline">VIEW</button>
      <button id="mintSovereign" class="btn btn-outline">MINT SOVEREIGN ID NFT</button>
    </div>
    <div class="document-progress hidden" id="sovereignProgress">
      <progress value="0" max="100"></progress>
    </div>
  </div>

  <div id="vaultContent" class="vault-content hidden">
    <h2>üîì SOVEREIGN VAULT UNLOCKED</h2>
    <!-- NFT Image -->
    <div id="nftImageContainer" style="margin-top: 2rem;">
      <h3>Your Sovereign NFT</h3>
      <img id="nftImage" src="" alt="Diamond Core NFT" style="max-width: 300px; border: 2px solid var(--primary); border-radius: 12px;" />
    </div>
    <p>Welcome, recognized sovereign. Access your tools below:</p>

    <div class="document-grid">
      <div class="document-card neon-pulse">
        <div class="document-icon">ü™™</div>
        <h3>Sovereign ID</h3>
        <p>Decentralized Identity (DID) with verifiable credentials</p>
        <div class="document-actions">
          <button id="claimDid2" class="btn">MINT DID</button>
          <button id="viewDid2" class="btn btn-outline">VIEW</button>
        </div>
        <div class="document-progress hidden" id="didProgress">
          <progress value="0" max="100"></progress>
        </div>
      </div>
      <div class="document-card neon-pulse">
        <div class="document-icon">üîê</div>
        <h3>Encrypted Vault</h3>
        <p>Secure storage for sovereign documents</p>
        <div class="document-actions">
          <button id="accessVault" class="btn">UNLOCK</button>
          <input type="file" id="vaultFile" class="hidden" />
          <button id="uploadDoc" class="btn btn-outline">UPLOAD</button>
          <a id="downloadEnc" class="btn btn-outline hidden" download="vault.encrypted">DOWNLOAD ENCRYPTED</a>
        </div>
        <small id="vaultHint" class="hidden">File encrypted locally with AES-GCM. Keep your download safe.</small>
      </div>
      <div class="document-card neon-pulse">
        <div class="document-icon">ü§ñ</div>
        <h3>AI Sovereignty Guide</h3>
        <p>Chat-based document assistant</p>
        <div class="document-actions">
          <button id="openAssistant" class="btn">CHAT</button>
          <button id="askQuestion" class="btn btn-outline">ASK</button>
        </div>
      </div>
      <div class="document-card neon-pulse">
        <div class="document-icon">üíé</div>
        <h3>Premium Access</h3>
        <p>Unlock premium guidance (requires 100 KLY)</p>
        <div class="document-actions">
          <button id="buyMembershipBtn" class="btn">BUY PREMIUM ACCESS (100 KLY)</button>
          <button id="checkPremiumBtn" class="btn btn-outline">CHECK STATUS</button>
        </div>
        <small id="premiumStatus"></small>
      </div>
    </div>

    <div class="cyber-terminal" id="cyberTerminal">
      > Initializing Sovereign Nexus Protocol...
      <div id="terminalOutput"></div>
      <input type="text" id="terminalInput" placeholder="Type 'help' for commands...">
    </div>
  </div>
</div>

<!-- AI Modal -->
<div id="assistantModal" class="hidden">
  <div class="modal-header">
    <h3 class="cyber-glowing">üß† AI Sovereignty Guide</h3>
    <button class="close-btn">&times;</button>
  </div>
  <div class="modal-body">
    <div id="chatHistory" class="chat-history"></div>
    <div class="chat-input">
      <input type="text" id="userQuery" placeholder="Ask about sovereignty, law, or tribal matters...">
      <button id="sendQuery" class="btn">SEND</button>
    </div>
  </div>
  <div class="modal-footer">
    <small>Powered by Tamaquah Sovereign AI (local)</small>
  </div>
</div>

<footer>
  <p>¬© <span id="currentYear"></span> Tamaquah Nation | Sovereign Technology Division</p>
</footer>

<script>
  /************** CONFIG **************/
  const NFT_CONTRACT = "0xDA76d35742190283E340dbeE2038ecc978a56950";
  const DIAMOND_TOKEN_ID = 3;
  const SOVEREIGN_TOKEN_ID = 5; // informational; not required for mintTo by URI

  const DIAMOND_URI = "ipfs://bafybeidq66s77zvhjdr3bwnmkgh5in4km56hals27xlidekblkpa25qzpq";
  const SOVEREIGN_URI = "ipfs://bafybeifaxqwjruycz5bznll5jkykb43ixmsc2mlvvnip7pva34psb63ufm";

  const KLY_TOKEN = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52"; // ERC-20
  const TREASURY_ADDR = "0x1111111111111111111111111111111111111111"; // TODO: replace with your receiving wallet
  const PREMIUM_KEY = "tn_premium_paid";

  const BSC_CHAIN_ID_HEX = "0x38"; // 56

  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function symbol() view returns (string)",
    "function transfer(address to, uint256 amount) returns (bool)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];

  const ERC721_ABI = [
    "function ownerOf(uint256 tokenId) view returns (address)",
    "function mintTo(address to, string memory uri) public"
  ];

  /************** UI ELEMENTS **************/
  const connectBtn = document.getElementById("connectWallet");
  const switchToBSCBtn = document.getElementById("switchToBSC");
  const disconnectBtn = document.getElementById("disconnectWallet");
  const walletInfo = document.getElementById("walletConnectedInfo");
  const walletAddress = document.getElementById("walletAddress");
  const walletNetwork = document.getElementById("walletNetwork");
  const walletBalance = document.getElementById("walletBalance");
  const nftStatus = document.getElementById("nftStatus");
  const successMsg = document.getElementById("successMessage");
  const errorMsg = document.getElementById("errorMessage");
  const vaultContent = document.getElementById("vaultContent");
  const terminalOutput = document.getElementById("terminalOutput");
  const mintSection = document.getElementById("mintSection");
  const mintBtn = document.getElementById("mintDiamond");
  const nftImage = document.getElementById("nftImage");

  const sovereignSection = document.getElementById("sovereignSection");
  const sovereignMintBtn = document.getElementById("mintSovereign");
  const sovereignProgress = document.getElementById("sovereignProgress");

  const claimDid = document.getElementById("claimDid");
  const viewDid = document.getElementById("viewDid");
  const claimDid2 = document.getElementById("claimDid2");
  const viewDid2 = document.getElementById("viewDid2");

  const assistantModal = document.getElementById("assistantModal");
  const openAssistantBtn = document.getElementById("openAssistant");
  const closeModalBtn = document.querySelector(".close-btn");
  const terminalInput = document.getElementById("terminalInput");

  const askQuestionBtn = document.getElementById("askQuestion");
  const userQueryInput = document.getElementById("userQuery");
  const sendQueryBtn = document.getElementById("sendQuery");
  const chatHistory = document.getElementById("chatHistory");

  const accessVaultBtn = document.getElementById("accessVault");
  const uploadDocBtn = document.getElementById("uploadDoc");
  const vaultFileInput = document.getElementById("vaultFile");
  const downloadEncLink = document.getElementById("downloadEnc");
  const vaultHint = document.getElementById("vaultHint");

  const recheckNFTBtn = document.getElementById("recheckNFT");
  const buyMembershipBtn = document.getElementById("buyMembershipBtn");
  const checkPremiumBtn = document.getElementById("checkPremiumBtn");
  const premiumStatus = document.getElementById("premiumStatus");

  /************** STATE **************/
  let provider, signer, userAddressCached, klySymbol = "KLY", klyDecimals = 18;

  /************** HELPERS **************/
  function ipfsToUrl(ipfsUri) {
    return ipfsUri.startsWith("ipfs://")
      ? "https://ipfs.io/ipfs/" + ipfsUri.replace("ipfs://", "")
      : ipfsUri;
  }

  function logToTerminal(message) {
    const line = document.createElement("div");
    line.textContent = "> " + message;
    terminalOutput.appendChild(line);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }

  function fmt(amount, decimals = 18, precision = 4) {
    try { return Number(ethers.utils.formatUnits(amount, decimals)).toFixed(precision); }
    catch { return String(amount); }
  }

  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }

  async function ensureBSC() {
    const current = await provider.send("eth_chainId", []);
    if (current !== BSC_CHAIN_ID_HEX) {
      walletNetwork.textContent = "‚ö†Ô∏è Wrong network. Please switch to BNB Smart Chain.";
      show(switchToBSCBtn);
      return false;
    }
    walletNetwork.textContent = "‚úÖ BNB Smart Chain (Mainnet)";
    hide(switchToBSCBtn);
    return true;
  }

  async function switchToBSC() {
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: BSC_CHAIN_ID_HEX }],
      });
      walletNetwork.textContent = "‚úÖ BNB Smart Chain (Mainnet)";
      hide(switchToBSCBtn);
      logToTerminal("üîÅ Switched to BSC.");
      return true;
    } catch (e) {
      if (e.code === 4902) {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: BSC_CHAIN_ID_HEX,
            chainName: "BNB Smart Chain",
            nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
            rpcUrls: ["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls: ["https://bscscan.com"]
          }]
        });
        return true;
      }
      logToTerminal("‚ùå Switch failed: " + (e?.message || e));
      return false;
    }
  }

  async function getKLYMeta() {
    const erc20 = new ethers.Contract(KLY_TOKEN, ERC20_ABI, provider);
    try {
      klySymbol = await erc20.symbol();
      klyDecimals = await erc20.decimals();
    } catch { /* default */ }
    return erc20;
  }

  async function refreshBalances() {
    const erc20 = await getKLYMeta();
    const bal = await erc20.balanceOf(userAddressCached);
    walletBalance.textContent = `üí∞ ${klySymbol} Balance: ${fmt(bal, klyDecimals)} ${klySymbol}`;
  }

  async function hasDiamondCore(address) {
    const contract = new ethers.Contract(NFT_CONTRACT, ERC721_ABI, provider);
    try {
      const owner = await contract.ownerOf(DIAMOND_TOKEN_ID);
      return owner.toLowerCase() === address.toLowerCase();
    } catch (err) {
      logToTerminal("‚ö†Ô∏è NFT ownership check error: " + err.message);
      return false;
    }
  }

  /************** CORE FLOWS **************/
  async function connectWallet() {
    try {
      if (!window.ethereum) throw new Error("MetaMask (or compatible) is required.");
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddressCached = await signer.getAddress();

      walletAddress.textContent = userAddressCached.slice(0, 6) + "..." + userAddressCached.slice(-4);
      show(walletInfo); hide(connectBtn); hide(errorMsg); hide(successMsg);

      const ok = await ensureBSC();
      if (!ok) { show(errorMsg); errorMsg.textContent = "Wrong network. Switch to BSC to continue."; return; }

      await refreshBalances();
      logToTerminal("‚úÖ Wallet connected: " + userAddressCached);

      const verified = await verifySignature();
      if (!verified) { show(errorMsg); errorMsg.textContent = "Signature required to continue."; return; }

      await gateAndRender();
    } catch (err) {
      show(errorMsg); errorMsg.textContent = err.message || String(err);
      logToTerminal("‚ùå Wallet connection failed: " + (err?.message || err));
    }
  }

  async function gateAndRender() {
    nftStatus.textContent = "üîé Verifying Diamond Core...";
    const hasMembership = await hasDiamondCore(userAddressCached);
    if (hasMembership) {
      nftStatus.textContent = "‚úÖ Diamond Core NFT Detected";
      successMsg.textContent = "Access granted. Welcome, sovereign.";
      show(successMsg);
      show(vaultContent);
      vaultContent.style.opacity = "1";
      logToTerminal("‚úÖ NFT ownership verified (Diamond Core)");
      nftImage.src = ipfsToUrl(DIAMOND_URI);
      show(sovereignSection);
    } else {
      nftStatus.textContent = "‚ùå No valid Diamond Core NFT.";
      errorMsg.textContent = "Access denied. You must mint the Diamond Core NFT.";
      show(errorMsg); show(mintSection);
      hide(vaultContent); hide(sovereignSection);
      logToTerminal("‚ùå NFT not found. Prompting mint option.");
    }
  }

  async function mintDiamondNFT() {
    try {
      const contract = new ethers.Contract(NFT_CONTRACT, ERC721_ABI, signer);
      logToTerminal("‚è≥ Minting Diamond Core NFT...");
      const tx = await contract.mintTo(userAddressCached, DIAMOND_URI);
      logToTerminal("üöÄ Tx sent: " + tx.hash);
      await tx.wait();
      logToTerminal("‚úÖ Diamond Core NFT minted!");
      hide(mintSection);
      await gateAndRender();
    } catch (err) {
      logToTerminal("‚ùå Diamond minting failed: " + (err?.message || err));
    }
  }

  async function mintSovereignNFT() {
    try {
      const contract = new ethers.Contract(NFT_CONTRACT, ERC721_ABI, signer);
      show(sovereignProgress);
      sovereignProgress.querySelector("progress").value = 20;
      logToTerminal("‚è≥ Minting Sovereign ID NFT...");

      // (Optional) gas estimate & buffer
      let gas = undefined;
      try {
        const est = await contract.estimateGas.mintTo(userAddressCached, SOVEREIGN_URI);
        gas = est.mul(2);
      } catch {}
      const tx = await contract.mintTo(userAddressCached, SOVEREIGN_URI, gas ? { gasLimit: gas } : {});
      sovereignProgress.querySelector("progress").value = 60;
      logToTerminal("üöÄ Tx sent: " + tx.hash);
      await tx.wait();
      sovereignProgress.querySelector("progress").value = 100;
      logToTerminal("‚úÖ Sovereign ID NFT minted!");
      setTimeout(() => hide(sovereignProgress), 800);
    } catch (error) {
      logToTerminal("‚ùå Sovereign mint failed: " + (error?.message || error));
      hide(sovereignProgress);
    }
  }

  async function verifySignature() {
    try {
      const message = "I am verifying my sovereignty on Tamaquah Nexus";
      const signature = await signer.signMessage(message);
      logToTerminal("üñã Signature: " + signature.slice(0, 10) + "...");
      return true;
    } catch (err) {
      logToTerminal("‚ùå Signature failed: " + err.message);
      return false;
    }
  }

  function disconnectWallet() {
    hide(walletInfo); hide(vaultContent); show(connectBtn);
    hide(successMsg); hide(errorMsg); hide(mintSection); hide(sovereignSection);
    logToTerminal("üîå Wallet disconnected");
  }

  /************** PREMIUM (KLY transfer) **************/
  async function purchaseMembership() {
    try {
      if (!signer) throw new Error("Connect your wallet first.");
      const ok = await ensureBSC(); if (!ok) throw new Error("Switch to BSC to continue.");

      const erc20 = new ethers.Contract(KLY_TOKEN, ERC20_ABI, signer);
      const amount = ethers.utils.parseUnits("100", klyDecimals); // 100 KLY
      logToTerminal(`‚è≥ Transferring 100 ${klySymbol} to treasury...`);
      const tx = await erc20.transfer(TREASURY_ADDR, amount);
      logToTerminal("üöÄ Tx sent: " + tx.hash);
      await tx.wait();
      localStorage.setItem(PREMIUM_KEY, "true");
      premiumStatus.textContent = `‚úÖ Premium active on ${new Date().toLocaleString()}`;
      logToTerminal("‚úÖ Premium access activated.");
      await refreshBalances();
    } catch (e) {
      logToTerminal("‚ùå Premium purchase failed: " + (e?.message || e));
    }
  }

  function checkPremium() {
    const active = localStorage.getItem(PREMIUM_KEY) === "true";
    premiumStatus.textContent = active ? "‚úÖ Premium is active on this browser." : "‚ùå Premium not active here.";
    return active;
  }

  /************** DID (local JSON) **************/
  async function mintLocalDID() {
    try {
      const addr = userAddressCached;
      const now = new Date().toISOString();
      const did = `did:tn:${addr.toLowerCase()}`;
      const doc = {
        id: did,
        controller: did,
        created: now,
        updated: now,
        verificationMethod: [{
          id: did + "#owner",
          type: "EcdsaSecp256k1RecoveryMethod2020",
          controller: did,
          blockchain: "bnb:56",
          publicKeyJwk: null
        }],
        authentication: [did + "#owner"],
        service: [{
          id: did + "#sovereign-vault",
          type: "TamaquahSovereignVault",
          serviceEndpoint: "local://sovereign-vault"
        }]
      };
      const blob = new Blob([JSON.stringify(doc, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      // Save to browser
      localStorage.setItem("tn_did_doc", JSON.stringify(doc));
      downloadFile(url, "sovereign-did.json");
      logToTerminal("‚úÖ DID minted locally. Keep your file safe.");
    } catch (e) {
      logToTerminal("‚ùå DID mint failed: " + (e?.message || e));
    }
  }

  function viewLocalDID() {
    const raw = localStorage.getItem("tn_did_doc");
    if (!raw) { logToTerminal("‚ÑπÔ∏è No local DID found. Mint one first."); return; }
    const data = JSON.parse(raw);
    alert("DID: " + data.id + "\nServices: " + (data.service?.map(s => s.type).join(", ") || "none"));
  }

  function downloadFile(url, filename) {
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  /************** VAULT (client-side AES-GCM) **************/
  let vaultKey = null, encBlobUrl = null;

  async function ensureVaultKey() {
    if (vaultKey) return vaultKey;
    vaultKey = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
    return vaultKey;
  }

  async function encryptFile(file) {
    await ensureVaultKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = new Uint8Array(await file.arrayBuffer());
    const enc = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, vaultKey, data);
    const packed = new Blob([iv, new Uint8Array(enc)], { type: "application/octet-stream" });
    return packed;
  }

  async function handleUpload() {
    try {
      if (!vaultFileInput.files?.length) { vaultFileInput.click(); return; }
      const file = vaultFileInput.files[0];
      logToTerminal("üîê Encrypting file: " + file.name + " ...");
      const encrypted = await encryptFile(file);
      if (encBlobUrl) URL.revokeObjectURL(encBlobUrl);
      encBlobUrl = URL.createObjectURL(encrypted);
      downloadEncLink.href = encBlobUrl;
      show(downloadEncLink); show(vaultHint);
      logToTerminal("‚úÖ Encrypted. You can download the encrypted blob now.");
      // Clear selection
      vaultFileInput.value = "";
    } catch (e) {
      logToTerminal("‚ùå Vault encryption failed: " + (e?.message || e));
    }
  }

  /************** AI (local helper) **************/
  const kb = [
    { k: /diamond|sovereign.*nft/i, a: "Diamond Core (tokenId 3) unlocks the Vault. Use 'Mint Diamond' if you don‚Äôt have it. The Sovereign ID NFT can be minted after you connect." },
    { k: /premium|100\s*kly/i, a: "Premium costs 100 KLY via ERC-20 transfer to the treasury. Click 'BUY PREMIUM ACCESS' to proceed." },
    { k: /did|identity/i, a: "Your DID is generated locally and saved as a JSON file tied to your wallet address." },
    { k: /vault|encrypt/i, a: "Vault uploads are encrypted client-side with AES-GCM and offered as a downloadable blob. Keep it safe or upload to your storage." },
    { k: /network|bsc|binance/i, a: "Make sure your wallet is on BNB Smart Chain (chainId 56). Use the 'SWITCH TO BSC' button if needed." },
  ];

  function aiReply(q) {
    const hit = kb.find(x => x.k.test(q));
    if (hit) return hit.a;
    // fallback guidance
    return "Sovereign, connect wallet ‚Üí verify signature ‚Üí ensure Diamond Core ‚Üí unlock Vault. Ask specifics like 'How do I mint Sovereign ID?' or 'How do I encrypt a file?'.";
  }

  function pushChat(role, text) {
    const div = document.createElement("div");
    div.className = "chat-message " + (role === "user" ? "user" : "ai");
    div.textContent = text;
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  /************** TERMINAL **************/
  async function handleTerminalCommand(cmd) {
    const c = cmd.trim().toLowerCase();
    switch (c) {
      case "help":
        logToTerminal("Commands: help, connect, disconnect, mint, verify, balance, premium, network");
        break;
      case "connect":
        await connectWallet(); break;
      case "disconnect":
        disconnectWallet(); break;
      case "mint":
        await mintDiamondNFT(); break;
      case "verify":
        await gateAndRender(); break;
      case "balance":
        await refreshBalances(); break;
      case "premium":
        await purchaseMembership(); break;
      case "network":
        await ensureBSC(); break;
      default:
        logToTerminal("Unknown command. Type 'help'.");
    }
  }

  /************** INIT & EVENTS **************/
  document.addEventListener("DOMContentLoaded", () => {
    connectBtn.onclick = connectWallet;
    switchToBSCBtn.onclick = switchToBSC;
    disconnectBtn.onclick = disconnectWallet;
    mintBtn.onclick = mintDiamondNFT;

    // Sovereign NFT mint button
    sovereignMintBtn.onclick = mintSovereignNFT;

    // DID buttons
    claimDid.onclick = mintLocalDID;
    viewDid.onclick = viewLocalDID;
    claimDid2.onclick = mintLocalDID;
    viewDid2.onclick = viewLocalDID;

    // Premium
    buyMembershipBtn.onclick = purchaseMembership;
    checkPremiumBtn.onclick = checkPremium;

    // Modal open/close
    document.getElementById("openAssistant")?.addEventListener("click", () => show(assistantModal));
    document.querySelector(".close-btn")?.addEventListener("click", () => hide(assistantModal));

    // Quick ask (opens modal and seeds input)
    askQuestionBtn.addEventListener("click", () => {
      show(assistantModal);
      userQueryInput.value = "How do I mint the Sovereign ID?";
      userQueryInput.focus();
    });

    // Chat send
    sendQueryBtn.addEventListener("click", () => {
      const q = userQueryInput.value.trim();
      if (!q) return;
      pushChat("user", q);
      const a = aiReply(q);
      pushChat("ai", a);
      userQueryInput.value = "";
    });

    // Terminal input
    terminalInput?.addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        const command = terminalInput.value;
        logToTerminal("User: " + command);
        terminalInput.value = "";
        await handleTerminalCommand(command);
      }
    });

    // Vault
    accessVaultBtn.addEventListener("click", async () => {
      await ensureVaultKey();
      logToTerminal("üîì Vault ready (local AES-GCM).");
    });
    uploadDocBtn.addEventListener("click", () => {
      vaultFileInput.click();
    });
    vaultFileInput.addEventListener("change", handleUpload);

    // Recheck gate
    recheckNFTBtn.addEventListener("click", gateAndRender);

    // Particles background
    particlesJS.load('particles-js', {
      particles: {
        number: { value: 80, density: { enable: true, value_area: 800 } },
        color: { value: "#00f0ff" },
        shape: { type: "circle", stroke: { width: 0, color: "#000000" } },
        opacity: { value: 0.5, random: true, anim: { enable: true, speed: 1, opacity_min: 0.1, sync: false } },
        size: { value: 3, random: true, anim: { enable: true, speed: 2, size_min: 0.1, sync: false } },
        line_linked: { enable: true, distance: 150, color: "#7b2dff", opacity: 0.4, width: 1 },
        move: { enable: true, speed: 1, direction: "none", random: true, straight: false, out_mode: "out", bounce: false, attract: { enable: true, rotateX: 600, rotateY: 1200 } }
      },
      interactivity: {
        detect_on: "canvas",
        events: { onhover: { enable: true, mode: "grab" }, onclick: { enable: true, mode: "push" }, resize: true },
        modes: { grab: { distance: 140, line_linked: { opacity: 1 } }, push: { particles_nb: 4 } }
      },
      retina_detect: true
    });
  });

  // Overlay fade-out
  window.addEventListener('load', () => {
    const overlay = document.getElementById("introOverlay");
    overlay.classList.add('animate__animated', 'animate__fadeOut');
    setTimeout(() => { overlay.style.display = "none"; }, 1000);
  });

  // Set current year
  document.getElementById("currentYear").textContent = new Date().getFullYear();
</script>
</body>
</html>
