<!DOCTYPE html>
<html lang="en" id="top">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KLY ‚Äî Web3 Academy & DeFi DAO</title>
  <meta name="description" content="KLY Token ‚Äî tokenized education, DeFi, and DAO governance on BNB Chain. Build wealth. Own legacy.">
  <meta name="theme-color" content="#0b0b0f">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Web3 deps -->
  <script defer src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/web3modal@1.9.7/dist/index.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0f; --surface:#12121a; --ink:#f6f5f2; --muted:#b9b6c8;
      --gold:#e6c15a; --gold2:#d4a82c; --brd:rgba(230,193,90,.22); --ring:rgba(230,193,90,.45);
      --accent:#6c3dbf; --success:#3dbf6c; --danger:#bf3d3d; --w:1200px; --r:14px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 50% -10%,rgba(108,61,191,.12),transparent),var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{width:min(var(--w),92%);margin:0 auto}

    /* Header / Nav */
    .nav{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 16px;background:rgba(12,12,16,.6);backdrop-filter:blur(10px);border-bottom:1px solid var(--brd)}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{font-family:Orbitron,system-ui;font-weight:900;letter-spacing:.14em;text-transform:uppercase}
    .nav-center{display:flex;justify-content:center;flex:1}
    .nav-links{display:flex;gap:1.5rem;align-items:center}
    .nav-link{color:#e9e4d2;opacity:.9;padding:.5rem .8rem;border-radius:8px}
    .nav-link:hover{opacity:1;background:rgba(255,255,255,.06)}

    /* Ecosystem dropdown (your original, adapted) */
    .nav-dropdown{position:relative;display:inline-block}
    .nav-button{background:transparent;border:0;color:#f6f5f2;font-family:Orbitron,system-ui;font-weight:700;letter-spacing:.06em;cursor:pointer;padding:.5rem 1rem;border-radius:8px;display:flex;align-items:center;gap:.5rem}
    .nav-button:hover{background:rgba(255,255,255,.06)}
    .dropdown-content{display:none;position:absolute;left:50%;transform:translateX(-50%);top:110%;min-width:260px;background:rgba(18,18,18,.95);border:1px solid rgba(230,193,90,.2);border-radius:10px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.45);padding:.6rem 0}
    .dropdown-content a{display:block;padding:.7rem 1rem;color:#f6f5f2;transition:.2s}
    .dropdown-content a:hover{background:rgba(230,193,90,.1);color:var(--gold);padding-left:1.3rem}
    .nav-dropdown:focus-within .dropdown-content,
    .nav-dropdown:hover .dropdown-content{display:block}

    .btn{padding:.72rem 1.1rem;border-radius:999px;border:1px solid var(--brd);background:linear-gradient(135deg,var(--gold),var(--gold2));color:#1b1206;font-family:Orbitron,system-ui;font-weight:800;letter-spacing:.04em;cursor:pointer;transition:transform .15s ease}
    .btn:hover{transform:translateY(-2px)}
    .btn--ghost{background:rgba(255,255,255,.06);color:#f1ebdc;border-color:var(--brd)}
    .chip{display:inline-flex;gap:.4rem;align-items:center;background:rgba(255,255,255,.06);border:1px solid var(--brd);padding:.28rem .55rem;border-radius:999px}
    .mono{font-family:ui-monospace,Menlo,Consolas,Monaco,monospace}

    .hero{display:grid;grid-template-columns:1.3fr .9fr;gap:18px;align-items:start;padding:40px 0 22px}
    .hero__title{font-family:Orbitron,system-ui;font-weight:900;letter-spacing:.1em;text-transform:uppercase;font-size:clamp(28px,5.6vw,56px);margin:0 0 8px;background:linear-gradient(90deg,var(--gold),#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero__sub{color:#dcd6c4;margin:0 0 14px}
    .hero__cta{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 16px}
    .strip{display:flex;gap:18px;justify-content:center;align-items:center;padding:12px 0;color:#e4dfd1;opacity:.9}

    .hud{border:1px solid var(--brd);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(8px);border-radius:var(--r);padding:14px;display:grid;grid-template-columns:1fr;gap:8px}
    .hud__row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .ident{width:54px;height:54px;border-radius:10px;border:1px solid var(--brd);background:#0f1016}
    .bar{--p:0%;position:relative;height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(230,193,90,.2);overflow:hidden}
    .bar::after{content:"";position:absolute;inset:0;transform-origin:left center;transform:scaleX(var(--p));background:linear-gradient(90deg,#6a4a16,#e6c15a)}

    .rule{display:flex;align-items:center;gap:12px;color:#e2dccb;margin:26px 0 12px;font-family:Orbitron,system-ui;letter-spacing:.14em;text-transform:uppercase}
    .rule::before,.rule::after{content:"";height:1px;flex:1;background:linear-gradient(90deg,transparent,rgba(230,193,90,.35),transparent)}
    .how{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:18px 0}
    .how__card{border:1px solid var(--brd);background:rgba(255,255,255,.05);border-radius:12px;padding:16px;text-align:center}
    .t{font-family:Orbitron,system-ui;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);font-size:1.1rem;margin:0 0 10px}

    .quests{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .quest{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--brd);background:rgba(255,255,255,.05);border-radius:12px;padding:12px}
    .quest.done{opacity:.75;filter:saturate(.7)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .card{border:1px solid var(--brd);background:rgba(255,255,255,.05);border-radius:12px;padding:16px}

    .faq .item{border:1px solid var(--brd);background:rgba(255,255,255,.05);border-radius:10px;margin-bottom:8px;overflow:hidden}
    .faq .q{width:100%;text-align:left;background:transparent;border:0;color:inherit;padding:12px;font-weight:700;display:flex;justify-content:space-between}
    .faq .a{max-height:0;overflow:hidden;transition:max-height .3s ease;padding:0 12px;color:#d9d3c5}
    .faq .item.open .a{max-height:240px;padding:0 12px 12px}

    .cta-band{border:1px dashed var(--brd);background:rgba(255,255,255,.04);border-radius:12px;padding:14px;display:flex;justify-content:center;gap:10px;align-items:center;margin:18px 0}
    .footer{border-top:1px solid var(--brd);color:#d7d1c2;padding:24px 0 60px;text-align:center}

    .loot{border:none;background:transparent}
    .loot::backdrop{background:rgba(0,0,0,.6)}
    .loot__box{width:min(520px,94vw);padding:16px;border:1px solid var(--brd);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(8px);text-align:center}
    .chest{position:relative;margin:10px auto;width:220px;height:140px}
    .chest__base,.chest__lid{position:absolute;inset:auto 0;left:0;right:0;margin:auto;border:1px solid var(--brd);border-radius:10px;background:rgba(230,193,90,.08)}
    .chest__base{bottom:0;height:70%}.chest__lid{top:0;height:40%;transform-origin:bottom center;transition:transform .6s ease}
    .chest.open .chest__lid{transform:rotateX(65deg)}
    .confetti{position:fixed;inset:auto 0 0 0;pointer-events:none;z-index:30}

    @media (max-width:980px){ .hero{grid-template-columns:1fr} .how{grid-template-columns:1fr 1fr} .col-6{grid-column:1/-1} }
    @media (max-width:640px){ .nav-center{display:none} .how{grid-template-columns:1fr} }
    :focus-visible{outline:3px solid var(--ring);outline-offset:2px}
  </style>
</head>
<body>
<header class="nav wrap">
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden="true"><defs><radialGradient id="g" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#fdeab3"/><stop offset="55%" stop-color="#e7c874"/><stop offset="100%" stop-color="#6a4a16"/></radialGradient></defs><circle cx="32" cy="32" r="30" fill="url(#g)" stroke="#000" stroke-opacity=".22" stroke-width="1.5"/></svg>
    <strong class="logo">KLY</strong>
  </div>

  <!-- YOUR ECOSYSTEM NAV (centered) -->
  <div class="nav-center">
    <div class="nav-dropdown">
      <button class="nav-button" aria-haspopup="true" aria-expanded="false">
        Ecosystem <span>‚ñæ</span>
      </button>
      <div class="dropdown-content" role="menu">
        <a href="/jointhetribe.html" role="menuitem">Join the Tribe</a>
        <a href="/founders.html" role="menuitem" style="background:#e6c15a;color:#121212;border-radius:8px;margin:.35rem 8px;">Founders Circle</a>
        <a href="/marketplace.html" role="menuitem" style="background:#d6b25e;color:#121212;border-radius:8px;margin:.35rem 8px;">Marketplace</a>
        <a href="/mint.html" role="menuitem">Mint NFTs</a>
        <a href="/kly-academy.html" role="menuitem">KLY Academy</a>
        <a href="/stake.html" role="menuitem">Stake</a>
        <a href="/oracle.html" role="menuitem">Oracle Scrolls</a>
        <a href="/dao.html" role="menuitem">DAO Governance</a>
        <a href="/course.html" role="menuitem">Course</a>
        <a href="/launchpad.html" role="menuitem">Launchpad</a>
        <a href="/nft-drop.html" role="menuitem">NFT Drop</a>
        <a href="/KLY-vault.html" role="menuitem">KLY Vault <span class="chip" style="margin-left:.4rem">NEW</span></a>
      </div>
    </div>
    <nav class="nav-links" aria-label="Primary">
      <a class="nav-link" href="#how">How it works</a>
      <a class="nav-link" href="#quests">Quests</a>
      <a class="nav-link" href="#tokenomics">Tokenomics</a>
      <a class="nav-link" href="#roadmap">Roadmap</a>
      <a class="nav-link" href="#faq">FAQ</a>
    </nav>
  </div>

  <div>
    <span id="addrChip" class="chip mono" style="display:none;"><span id="addrShort">0x‚Ä¶</span></span>
    <button id="connectBtn" class="btn" type="button">Connect</button>
  </div>
</header>

<main class="wrap" id="main">
  <!-- HERO + HUD -->
  <section class="hero" id="hero">
    <div>
      <h1 class="hero__title">Web3 Academy & DeFi DAO</h1>
      <p class="hero__sub">Build wealth. Own legacy. On BNB Chain with tokenized education, staking yields, and DAO governance.</p>
      <div class="hero__cta">
        <button id="ctaJoin" class="btn" type="button">Join the Tribe</button>
        <a class="btn btn--ghost mono" href="https://bscscan.com/token/0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52" target="_blank" rel="noopener noreferrer">üîç BscScan</a>
      </div>
      <div class="strip">
        <span class="chip">Audited ‚úî</span>
        <span class="chip mono">BNB Chain</span>
        <span class="chip">Community-Owned</span>
      </div>
    </div>

    <!-- Player HUD -->
    <aside class="hud" aria-label="Player HUD">
      <div class="hud__row">
        <canvas id="ident" class="ident" width="54" height="54" aria-hidden="true"></canvas>
        <div style="flex:1">
          <div class="mono" id="hudAddr">Not connected</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">
            <span class="chip"><small>Lvl</small><strong id="hudLvl">1</strong></span>
            <span class="chip"><small>XP</small><strong id="hudXP">0</strong>/<span id="hudNext">100</span></span>
            <span class="chip"><small>KLY</small><strong id="hudBal">0.00</strong></span>
            <span class="chip"><small>üî• Streak</small><strong id="hudStreak">0</strong></span>
          </div>
        </div>
      </div>
      <div class="bar" id="xpBar" style="--p:0%"></div>
      <div class="hud__row">
        <button id="dailyBtn" class="btn btn--ghost" type="button">Daily Check-in</button>
        <button id="lootBtn" class="btn" type="button" disabled>Open Loot Chest</button>
      </div>
    </aside>
  </section>

  <!-- How it works -->
  <section id="how">
    <div class="rule">How it works</div>
    <div class="how">
      <div class="how__card"><div class="t">1 ‚Ä¢ Acquire</div><p>Get KLY on supported DEXs.</p></div>
      <div class="how__card"><div class="t">2 ‚Ä¢ Stake</div><p>Stake KLY to earn rewards and rise levels.</p></div>
      <div class="how__card"><div class="t">3 ‚Ä¢ Govern</div><p>Vote on proposals and shape the protocol.</p></div>
    </div>
  </section>

  <!-- Quests -->
  <section id="quests">
    <div class="rule">Quests</div>
    <div class="quests">
      <article class="quest" data-quest="connect">
        <div><strong>Connect Wallet</strong><div class="muted">Prove you are you. Start your journey.</div></div>
        <div>
          <div class="chip">+25 XP</div>
          <button class="btn btn--ghost qbtn" data-action="connect">Connect</button>
        </div>
      </article>
      <article class="quest" data-quest="bscscan">
        <div><strong>Scout the Chain</strong><div class="muted">Open KLY on BscScan and return.</div></div>
        <div>
          <div class="chip">+10 XP</div>
          <a class="btn btn--ghost qbtn" data-action="bscscan" target="_blank" rel="noopener" href="https://bscscan.com/token/0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52">Open</a>
        </div>
      </article>
      <article class="quest" data-quest="stake10">
        <div><strong>Stake ‚â• 10 KLY</strong><div class="muted">On-chain verification.</div></div>
        <div>
          <div class="chip">+60 XP</div>
          <button class="btn btn--ghost qbtn" data-action="verify-stake">Verify</button>
        </div>
      </article>
      <article class="quest" data-quest="mintkey">
        <div><strong>Mint KLY Key</strong><div class="muted">Summon your badge (ERC-721).</div></div>
        <div>
          <div class="chip">+50 XP</div>
          <button class="btn btn--ghost qbtn" data-action="mint-nft">Mint</button>
        </div>
      </article>
      <article class="quest" data-quest="referral">
        <div><strong>Share Your Summons</strong><div class="muted">Copy referral link.</div></div>
        <div>
          <div class="chip">+20 XP</div>
          <button class="btn btn--ghost qbtn" data-action="copy-ref">Copy</button>
        </div>
      </article>
    </div>
  </section>

  <!-- Utility / Tokenomics / Roadmap / FAQ (wireframe cards) -->
  <section id="tokenomics">
    <div class="rule">Token Utility</div>
    <div class="grid">
      <div class="card col-6"><div class="t">Education</div><p>Token-gated courses & NFT certs.</p></div>
      <div class="card col-6"><div class="t">DeFi</div><p>Stake, LP, earn rewards.</p></div>
      <div class="card col-6"><div class="t">DAO</div><p>Vote & propose upgrades.</p></div>
      <div class="card col-6"><div class="t">Launchpad</div><p>Fund & launch ecosystem projects.</p></div>
    </div>

    <div class="rule">Distribution</div>
    <div class="grid">
      <div class="card col-6"><div class="t">Key Numbers</div><p>Total Supply: 1,000,000,000 KLY</p><p>Staking: 30% ‚Ä¢ Liquidity: 25% ‚Ä¢ Team: 15% ‚Ä¢ Eco: 20% ‚Ä¢ Airdrop:5% ‚Ä¢ Advisors:5%</p></div>
      <div class="card col-6"><div class="t">Visual</div><p>(Pie chart placeholder)</p></div>
    </div>
  </section>

  <section id="roadmap">
    <div class="rule">Roadmap</div>
    <div class="grid">
      <div class="card col-6"><strong>Q1 2025</strong> ‚Äî Genesis Launch ‚úÖ</div>
      <div class="card col-6"><strong>Q2 2025</strong> ‚Äî Staking Live ‚úÖ</div>
      <div class="card col-6"><strong>Q3 2025</strong> ‚Äî DAO Governance üîÑ</div>
      <div class="card col-6"><strong>Q4 2025</strong> ‚Äî Education Platform üöÄ</div>
    </div>
  </section>

  <section id="faq">
    <div class="rule">FAQ</div>
    <div class="faq">
      <div class="item">
        <button class="q" type="button">What is KLY?<span>‚ñæ</span></button>
        <div class="a"><p>KLY is the token powering the KLY Academy + DeFi + DAO ecosystem on BNB Chain.</p></div>
      </div>
      <div class="item">
        <button class="q" type="button">How do I start?<span>‚ñæ</span></button>
        <div class="a"><p>Connect wallet, complete quests, and stake KLY to level up.</p></div>
      </div>
    </div>
  </section>

  <section class="cta-band">
    <strong>Ready to start your ascent?</strong>
    <button class="btn" id="ctaBottom" type="button">Connect & Begin</button>
    <a class="btn btn--ghost" href="white-paper.html">Read Whitepaper</a>
  </section>
</main>

<footer class="footer wrap">
  <div>¬© 2025 KLY ‚Ä¢ Contract: <span class="mono">0x2e4f‚Ä¶B4E52</span> ‚Ä¢ BNB Chain</div>
  <div style="margin-top:8px"><a class="nav-link" href="#top">‚Üë Top</a></div>
</footer>

<!-- Loot Modal + Confetti -->
<dialog id="lootDlg" class="loot">
  <div class="loot__box">
    <div class="chest" id="chest"><div class="chest__lid"></div><div class="chest__base"></div></div>
    <div id="lootText">Opening‚Ä¶</div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:10px">
      <button class="btn" id="lootClaim" type="button">Claim</button>
      <button class="btn btn--ghost" id="lootClose" type="button">Close</button>
    </div>
  </div>
</dialog>
<canvas id="confetti" class="confetti" width="1" height="1" aria-hidden="true"></canvas>

<script>
/* ========= Web3 + Gamification (ethers + Web3Modal v1) ========= */
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const short = a => a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : 'Not connected';

  // ------- Contracts / ABIs -------
  const ADDR = {
    KLY:   "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52",
    STAKE: "0xe9417Fbe4e1D1E70aaE00b76e9B54599707c49e0",
    NFT:   "0xDA76d35742190283E340dbeE2038ecc978a56950"
  };
  const ABI = {
    TOKEN: [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)"
    ],
    STAKE_VIEW_TRY: [
      "function staked(address) view returns (uint256)",
      "function userInfo(address) view returns (uint256)"
    ],
    STAKE_TX: ["function stake(uint256 _amount)","function claim()","function withdraw()"],
    NFT: ["function mintTo(address to, string uri) public"]
  };

  // ------- Web3 state -------
  let web3Modal, wcInstance, provider, signer, userAddress, klyToken, stakeRead, nftContract, klyDecimals=18;

  // ------- UI -------
  const el = {
    connect: $('#connectBtn'), ctaJoin: $('#ctaJoin'), ctaBottom: $('#ctaBottom'),
    addrChip: $('#addrChip'), addrShort: $('#addrShort'),
    hudAddr: $('#hudAddr'), hudLvl: $('#hudLvl'), hudXP: $('#hudXP'), hudNext: $('#hudNext'),
    hudBal: $('#hudBal'), hudStreak: $('#hudStreak'), bar: $('#xpBar'), ident: $('#ident'),
    daily: $('#dailyBtn'), lootBtn: $('#lootBtn'),
    lootDlg: $('#lootDlg'), lootText: $('#lootText'), lootClaim: $('#lootClaim'), lootClose: $('#lootClose'),
    confetti: $('#confetti')
  };

  // ------- Gamification model -------
  const STATE = { addr:null, xp:0, streak:0, lastCheck:0, completed:{}, lootClaimed:false, balance:0 };
  const XP = { connect:25, bscscan:10, daily:15, stake10:60, mintkey:50, referral:20 };
  const levelOf = xp => 1 + Math.floor(Math.sqrt(xp/100));
  const nextXP = lvl => (lvl*lvl)*100;

  function load(addr){
    const raw = localStorage.getItem(`kly_wire_onchain_${addr||'anon'}`);
    Object.assign(STATE, {addr, xp:0, streak:0, lastCheck:0, completed:{}, lootClaimed:false, balance:0});
    if(raw) try{ Object.assign(STATE, JSON.parse(raw)); }catch{}
  }
  function save(){ if(!STATE.addr) return; localStorage.setItem(`kly_wire_onchain_${STATE.addr}`, JSON.stringify(STATE)); }

  // ------- Identicon -------
  function drawIdent(addr){
    const c=el.ident, ctx=c.getContext('2d'), size=8, s=7;
    const seed = Array.from((addr||'anon')).reduce((a,ch)=>(a*33+ch.charCodeAt(0))>>>0,5381);
    const hue = seed%360;
    ctx.clearRect(0,0,54,54); ctx.fillStyle='#0f1016'; ctx.fillRect(0,0,54,54);
    for(let y=0;y<size;y++){
      for(let x=0;x<size/2;x++){
        const bit = ((seed>>((x+y)&15)) & 1);
        if(bit){ ctx.fillStyle=`hsl(${hue},70%,${45 + ((x+y)%20)}%)`;
          ctx.fillRect(4+x*s,4+y*s,s-1,s-1); ctx.fillRect(4+(size-1-x)*s,4+y*s,s-1,s-1);
        }
      }
    }
  }

  // ------- Confetti -------
  const Confetti = (()=>{
    let parts=[], ctx, w=1,h=1, active=false;
    function init(){ const c=el.confetti; ctx=c.getContext('2d'); resize(); addEventListener('resize', resize, {passive:true}); }
    function resize(){ const c=el.confetti; w=c.width=innerWidth; h=c.height=Math.min(300, innerHeight*0.4); }
    function burst(n=120){
      if(matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      parts = Array.from({length:n}).map(()=>({x:Math.random()*w, y:-10, vx:(Math.random()-.5)*2, vy:1+Math.random()*2, s:4+Math.random()*4, c:`hsl(${Math.random()*360},80%,60%)`, r:Math.random()*6}));
      if(!active){ active=true; loop(); setTimeout(()=>active=false,1500); }
    }
    function loop(){ if(!active) return; ctx.clearRect(0,0,w,h); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.r+=.12; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r); ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();}); parts=parts.filter(p=>p.y<h+20); requestAnimationFrame(loop); }
    init(); return { burst };
  })();

  // ------- UI render -------
  function render(){
    const lvl = levelOf(STATE.xp);
    el.hudLvl.textContent = lvl;
    el.hudXP.textContent = STATE.xp;
    el.hudNext.textContent = nextXP(lvl);
    const p = Math.min(1, STATE.xp / nextXP(lvl)); el.bar.style.setProperty('--p', (p*100)+'%');
    el.hudStreak.textContent = STATE.streak;
    el.hudBal.textContent = Number(STATE.balance||0).toFixed(2);
    el.hudAddr.textContent = short(STATE.addr);
    drawIdent(STATE.addr);

    if(STATE.addr){
      el.addrChip.style.display='inline-flex';
      el.addrShort.textContent = short(STATE.addr);
      el.connect.textContent='Disconnect';
    } else {
      el.addrChip.style.display='none';
      el.connect.textContent='Connect';
    }

    $$('.quest').forEach(q=>{
      const id = q.dataset.quest;
      q.classList.toggle('done', !!STATE.completed[id]);
      const btn = q.querySelector('.qbtn');
      if(btn){ btn.textContent = STATE.completed[id] ? 'Completed' :
        btn.dataset.action==='bscscan' ? 'Open' : btn.dataset.action==='copy-ref' ? 'Copy' : 'Do it'; }
    });

    el.lootBtn.disabled = !(lvl>=3 && !STATE.lootClaimed);
  }

  function addXP(amount, reason=''){
    STATE.xp += amount;
    save(); render();
    toast(`+${amount} XP${reason?` ‚Ä¢ ${reason}`:''}`);
    Confetti.burst(100);
  }

  function toast(msg){
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;right:16px;bottom:16px;background:rgba(255,255,255,.08);border:1px solid rgba(230,193,90,.3);padding:10px 12px;border-radius:10px;backdrop-filter:blur(8px);z-index:50';
    t.textContent = msg; document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),220); }, 2600);
  }

  // ------- Web3Modal init / connect -------
  async function initWeb3Modal(){
    const providerOptions = {
      walletconnect: { 
        package: (window.WalletConnectProvider && window.WalletConnectProvider.default) || window.WalletConnectProvider, 
        options: { rpc:{56:"https://bsc-dataseed.binance.org/"} } 
      },
      injected: {
        package: null,
        display: { name: "MetaMask", description: "Browser wallet" }
      },
      binancechainwallet: { package: true }
    };
    web3Modal = new window.Web3Modal({ cacheProvider:true, providerOptions, theme:'dark' });
  }

  async function ensureBSC(){
    const eth = provider?.provider || window.ethereum;
    if(!eth) return false;
    const net = await provider.getNetwork().catch(()=>({chainId:0}));
    if(net.chainId === 56) return true;
    try{
      await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x38' }]});
      return true;
    }catch(e){
      if(e.code===4902){
        await eth.request({ method:'wallet_addEthereumChain', params:[{ chainId:'0x38', chainName:'BNB Smart Chain', nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18}, rpcUrls:['https://bsc-dataseed.binance.org/'], blockExplorerUrls:['https://bscscan.com'] }]});
        return true;
      }
      return false;
    }
  }

  async function connect(){
    // Toggle disconnect
    if(userAddress){
      try{ web3Modal?.clearCachedProvider?.(); wcInstance?.disconnect?.(); }catch{}
      userAddress = null; load(null); render(); return;
    }

    try{
      wcInstance = await web3Modal.connect();
      provider = new ethers.providers.Web3Provider(wcInstance);
      if(!(await ensureBSC())) throw new Error('Please switch to BNB Smart Chain (56).');
      signer = provider.getSigner(); userAddress = await signer.getAddress();

      // Contracts
      klyToken = new ethers.Contract(ADDR.KLY, ABI.TOKEN, signer);
      nftContract = new ethers.Contract(ADDR.NFT, ABI.NFT, signer);

      // stakeRead: try to detect a view
      let viewSig = null;
      if(await hasRead(ADDR.STAKE, "staked(address)")) viewSig = "function staked(address) view returns (uint256)";
      else if(await hasRead(ADDR.STAKE, "userInfo(address)")) viewSig = "function userInfo(address) view returns (uint256)";

      const viewAbi = viewSig ? [viewSig] : [];
      stakeRead = new ethers.Contract(ADDR.STAKE, [...viewAbi, ...ABI.STAKE_TX], signer);

      bindProviderEvents();
      onConnected();
    }catch(e){
      if(e?.code===4001) return toast('User rejected');
      console.error(e); toast('Wallet connection failed');
    }
  }

  async function hasRead(addr, sig){
    try{
      const itf = new ethers.utils.Interface([`function ${sig}`]);
      const data = itf.encodeFunctionData(sig.split('(')[0], [ethers.constants.AddressZero]);
      await provider.call({ to: addr, data }).catch(()=>{ throw 0; });
      return true;
    }catch{ return false; }
  }

  function bindProviderEvents(){
    const base = provider.provider;
    if(base?.on){
      base.on('accountsChanged', async (acc)=>{ if(!acc?.length){ web3Modal.clearCachedProvider(); userAddress=null; load(null); render(); } else { userAddress=acc[0]; onConnected(); }});
      base.on('chainChanged', ()=> location.reload());
      base.on('disconnect', ()=>{ web3Modal.clearCachedProvider(); userAddress=null; load(null); render(); });
    }
  }

  async function onConnected(){
    load(userAddress); save(); render(); complete('connect');
    try{
      const [raw, dec] = await Promise.all([klyToken.balanceOf(userAddress), klyToken.decimals()]);
      klyDecimals = dec; STATE.balance = Number(ethers.utils.formatUnits(raw, dec)); save(); render();
    }catch(e){ console.warn('balance read failed', e); }
  }

  // ------- Quests -------
  function complete(id){
    if(STATE.completed[id]) return;
    STATE.completed[id] = true; addXP(XP[id]||10, id); save(); render();
  }

  async function dailyCheck(){
    if(!userAddress) return toast('Connect first');
    const d = new Date(); d.setHours(0,0,0,0);
    if(STATE.lastCheck >= d.getTime()) return toast('Already checked in today');
    try{
      const msg = `KLY Daily Check-in ‚Ä¢ ${new Date().toISOString().slice(0,10)} ‚Ä¢ ${userAddress}`;
      await signer.signMessage(msg);
      STATE.lastCheck = d.getTime(); STATE.streak = (STATE.streak||0)+1; save(); addXP(XP.daily,'Daily');
    }catch(e){ if(e?.code!==4001) alert('Check-in failed: ' + (e?.message||e)); }
  }

  async function verifyStake(){
    if(!userAddress) return toast('Connect first');
    const ten = ethers.utils.parseUnits('10', klyDecimals || 18);
    try{
      // Prefer on-contract read if available
      let staked = ethers.constants.Zero;
      if(stakeRead.functions?.staked){ staked = await stakeRead.staked(userAddress); }
      else if(stakeRead.functions?.userInfo){ const ui = await stakeRead.userInfo(userAddress); staked = ui?.amount || ui?.[0] || ethers.constants.Zero; }
      if(staked.gte(ten)) { complete('stake10'); return; }
    }catch(e){ /* fall through */ }

    // Fallback heuristic: allowance + balance
    try{
      const [allow, bal] = await Promise.all([
        klyToken.allowance(userAddress, ADDR.STAKE),
        klyToken.balanceOf(userAddress)
      ]);
      if(allow.gte(ten) || bal.gte(ten)) { complete('stake10'); return; }
    }catch(e){ console.warn('fallback verify error', e); }

    alert('Stake ‚â• 10 KLY not detected yet.\nStake and try Verify again.');
  }

  async function mintKey(){
    if(!userAddress) return toast('Connect first');
    try{
      const tokenURI = "https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeifssvwf74gv25c3r76cxfdqraerll7l4kgruqaox6cskrqsu2e2by";
      const tx = await nftContract.mintTo(userAddress, tokenURI);
      toast('Mint submitted‚Ä¶'); await tx.wait(); complete('mintkey');
    }catch(e){ if(e?.code===4001) return toast('User rejected'); alert('Mint failed: ' + (e?.data?.message||e?.message||e)); }
  }

  function copyRef(){
    if(!userAddress) return toast('Connect first');
    const url = location.origin + location.pathname + '?ref=' + encodeURIComponent(userAddress);
    navigator.clipboard.writeText(url).then(()=> toast('Referral link copied')); complete('referral');
  }

  // ------- Loot -------
  const LOOT = [
    'üéüÔ∏è +5% APY promo (KLY-APY5)',
    'ü™ô Airdrop allowlist (Wave 1)',
    'üéì Academy course voucher',
    'üí† KLY Key artwork (HD)',
    'üéÅ Mystery NFT allowlist'
  ];
  function openLoot(){
    $('#chest').classList.remove('open'); el.lootText.textContent='Opening‚Ä¶';
    setTimeout(()=> $('#chest').classList.add('open'), 200);
    setTimeout(()=> { el.lootText.textContent = LOOT[Math.floor(Math.random()*LOOT.length)]; }, 700);
  }
  function claimLoot(){
    STATE.lootClaimed = true; save(); render(); toast('Loot claimed!'); el.lootDlg.close();
  }

  // ------- UI events -------
  el.connect.addEventListener('click', connect);
  el.ctaJoin.addEventListener('click', connect);
  el.ctaBottom.addEventListener('click', connect);
  el.daily.addEventListener('click', dailyCheck);
  el.lootBtn.addEventListener('click', ()=>{ el.lootDlg.showModal(); openLoot(); });
  el.lootClose.addEventListener('click', ()=> el.lootDlg.close());
  el.lootClaim.addEventListener('click', claimLoot);

  $$('.faq .q').forEach(btn=> btn.addEventListener('click',()=> btn.parentElement.classList.toggle('open')));

  $$('.qbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const act = btn.dataset.action;
      if(act==='connect') return connect();
      if(act==='bscscan'){ sessionStorage.setItem('kly_seen_bsc', '1'); return; }
      if(act==='verify-stake') return verifyStake();
      if(act==='mint-nft') return mintKey();
      if(act==='copy-ref') return copyRef();
    });
  });
  window.addEventListener('focus', ()=>{
    if(sessionStorage.getItem('kly_seen_bsc')==='1'){
      sessionStorage.removeItem('kly_seen_bsc'); complete('bscscan');
    }
  });

  // ------- Boot -------
  (async function boot(){
    await initWeb3Modal();
    // auto-connect if cached
    if(web3Modal.cachedProvider){ connect(); }
    load(null); render();
  })();
})();
</script>
</body>
</html>
