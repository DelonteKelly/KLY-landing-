<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mint Exclusive & Rare NFTs | Tamaquah Nation</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg:#0A1A24; --bg2:#051018; --ink:#EAF7FF; --sub:#9CCBE3; --accent:#73E1FF; --gold:#e2c675;
      --metamask:#f6851b; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --success:#4ade80; --error:#f87171; --warning:#fbbf24;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Space Grotesk',system-ui,sans-serif}
    html,body{background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);min-height:100vh}
    .wrap{max-width:1200px;margin:0 auto;padding:2rem}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--stroke)}
    .brand{font-weight:800;letter-spacing:.08em;font-size:1.5rem;color:var(--accent);text-shadow:0 0 10px rgba(115,225,255,.3);text-transform:uppercase}
    .hero{text-align:center;padding:2rem 0;margin-bottom:3rem}
    .hero h1{font-size:clamp(2rem,5vw,3.5rem);margin:0 0 1rem;text-transform:uppercase;letter-spacing:.06em;
      background:linear-gradient(90deg,var(--accent),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero p{color:var(--sub);margin:0 auto;max-width:600px;line-height:1.6;font-size:1.1rem}
    .wallet-section{display:flex;flex-direction:column;align-items:center;gap:1rem;margin-bottom:2rem}
    .btn{background:linear-gradient(90deg,var(--metamask),#f8a34d);color:#fff;border:none;border-radius:12px;padding:1rem 2rem;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:.5rem}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(246,133,27,.3)}
    .btn:disabled{opacity:.7;cursor:not-allowed;transform:none!important}
    .wallet-info{display:flex;gap:1rem;align-items:center;background:rgba(0,0,0,.2);padding:.75rem 1.5rem;border-radius:999px;font-size:.95rem;flex-wrap:wrap;justify-content:center}
    .wallet-address{font-family:monospace;font-size:.9rem}
    .balance{display:flex;gap:.5rem;align-items:center}
    .network-indicator{display:inline-flex;align-items:center;gap:.5rem;font-size:.85rem;padding:.5rem 1rem;border-radius:999px;background:rgba(0,0,0,.2)}
    .network-indicator.valid{background:rgba(74,222,128,.1);color:var(--success)}
    .network-indicator.invalid{background:rgba(248,113,113,.1);color:var(--error)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:2rem;margin-top:2rem}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:1.5rem;box-shadow:0 16px 60px rgba(0,0,0,.35);position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent),var(--gold))}
    .card h2{margin:0 0 1rem;font-size:1.5rem}
    .contract-address{font-size:.85rem;word-break:break-all;color:var(--sub);margin-bottom:1rem;display:block}
    .form-group{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;margin:1rem 0}
    select,input[type=number]{background:#0c1d27;color:var(--ink);border:1px solid var(--stroke);border-radius:10px;padding:.75rem 1rem;min-width:120px}
    .preview{display:flex;gap:1.5rem;margin:1.5rem 0;align-items:flex-start}
    .preview img{width:180px;height:180px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(45deg,#0c1d27,#0a2738)}
    .meta{flex:1}
    .nft-name{margin:0 0 .5rem;font-size:1.25rem}
    .stat{display:flex;justify-content:space-between;margin:.5rem 0;font-size:.95rem}
    .stat-label{color:var(--sub)}
    .stat-value{font-weight:600}
    .mint-btn{background:linear-gradient(90deg,var(--accent),#a9ffcb);color:#001018;border:none;border-radius:12px;padding:1rem 1.5rem;font-weight:700;cursor:pointer;width:100%;margin-top:1rem}
    .status{min-height:24px;font-size:.9rem;margin-top:.5rem;text-align:center}
    .status.success{color:var(--success)} .status.error{color:var(--error)} .status.warning{color:var(--warning)}
    .loading{position:relative;color:transparent!important}
    .loading:after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
    footer{margin-top:3rem;text-align:center;color:var(--sub);font-size:.9rem;padding:1rem}
    @media (max-width:768px){.wrap{padding:1.5rem}.grid{grid-template-columns:1fr}.preview{flex-direction:column}.preview img{width:100%;height:auto;max-height:300px}}
    .security-warning{position:fixed;top:0;left:0;right:0;background:#FEF3C7;color:#92400E;padding:1rem;z-index:1000;border-bottom:1px solid #F59E0B}
    .warning-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:1rem}
    .warning-close{background:none;border:none;color:inherit;font-size:1.5rem;cursor:pointer;padding:.25rem .5rem}
  </style>
</head>
<body>
  <!-- Security Warning -->
  <div class="security-warning">
    <div class="warning-content">
      <div><strong>Security Notice:</strong> Only connect your wallet to trusted sites. Verify the URL before minting.</div>
      <button class="warning-close" onclick="this.closest('.security-warning').remove()">&times;</button>
    </div>
  </div>

  <div class="wrap">
    <header><div class="brand">TAMAQUAH VAULT</div></header>

    <section class="hero">
      <h1>Mint Exclusive & Rare NFTs</h1>
      <p>Connect your wallet to mint these unique digital artifacts from our collections.</p>
    </section>

    <div class="wallet-section">
      <button id="connectBtn" class="btn">
        <svg width="20" height="20" viewBox="0 0 40 37" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M36.0115 3.33203L22.2221 14.2493C21.2623 14.9929 19.7377 14.9929 18.7779 14.2493L4.9885 3.33203" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <path d="M26.2086 23.5947L23.3333 26.0413C21.4609 27.6545 18.5391 27.6545 16.6667 26.0413L13.7914 23.5947" stroke="white" stroke-width="6" stroke-linecap="round"/>
          <rect x="1" y="1" width="38" height="35" rx="6" stroke="white" stroke-width="2"/>
        </svg>
        Connect Wallet
      </button>

      <div id="walletInfo" style="display:none">
        <div class="wallet-info">
          <span id="walletAddress" class="wallet-address"></span>
          <span class="network-indicator"><span id="networkName">BSC</span></span>
        </div>
        <div class="wallet-info">
          <span class="balance">Balance: <span id="balanceAmount" class="balance-amount">0</span> <span id="balanceCurrency">BNB</span></span>
        </div>
      </div>
      <div id="connStatus" class="status"></div>
    </div>

    <section class="grid">
      <div class="card" id="mechsCard">
        <h2>Ancestral Mechs: Bloodline Codex</h2>
        <span class="contract-address">Contract: 0x2EB40e1dCaA7faFc14040352d7aa37C6D6FBA989</span>
        <div class="form-group">
          <label for="mechsTokenId">Token ID</label>
          <select id="mechsTokenId"></select>
          <label for="mechsQty">Quantity</label>
          <input id="mechsQty" type="number" min="1" max="10" value="1"/>
        </div>
        <div class="preview">
          <img id="mechsImg" alt="Preview" loading="lazy"/>
          <div class="meta">
            <h3 id="mechsName" class="nft-name">—</h3>
            <div class="stat"><span class="stat-label">Price/Token:</span><span id="mechsPrice" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Currency:</span><span id="mechsCurrency" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Supply:</span><span id="mechsSupply" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Your Balance:</span><span id="mechsBalance" class="stat-value">—</span></div>
          </div>
        </div>
        <button id="mechsMint" class="mint-btn">Mint Mech</button>
        <div id="mechsStatus" class="status"></div>
      </div>

      <div class="card" id="cryptidsCard">
        <h2>Tribal Punk Cryptids</h2>
        <span class="contract-address">Contract: 0xF98796F28c40b2d0A238B951E72C14Cdf2C4Da11</span>
        <div class="form-group">
          <label for="cryptidTokenId">Token ID</label>
          <select id="cryptidTokenId"></select>
          <label for="cryptidQty">Quantity</label>
          <input id="cryptidQty" type="number" min="1" max="10" value="1" disabled/>
        </div>
        <div class="preview">
          <img id="cryptidImg" alt="Preview" loading="lazy"/>
          <div class="meta">
            <h3 id="cryptidName" class="nft-name">—</h3>
            <div class="stat"><span class="stat-label">Price/Token:</span><span id="cryptidPrice" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Currency:</span><span id="cryptidCurrency" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Supply:</span><span id="cryptidSupply" class="stat-value">—</span></div>
            <div class="stat"><span class="stat-label">Your Balance:</span><span id="cryptidBalance" class="stat-value">—</span></div>
          </div>
        </div>
        <button id="cryptidMint" class="mint-btn" disabled>Mint Cryptid (requires signature)</button>
        <div id="cryptidStatus" class="status warning">Mint requires a signed voucher. Not enabled on this page.</div>
      </div>
    </section>

    <footer>They took the land. We took the future.</footer>
  </div>

  <!-- LIVE MODE SCRIPT -->
  <script type="module">
    /* =================== CONFIG =================== */
    const BSC_CHAIN_ID = 56;
    const READ_RPC = "https://bsc-dataseed.binance.org/";
    const CONTRACT_MECHS    = "0x2EB40e1dCaA7faFc14040352d7aa37C6D6FBA989"; // Drop1155 (BNB)
    const CONTRACT_CRYPTIDS = "0xF98796F28c40b2d0A238B951E72C14Cdf2C4Da11"; // (preview only)
    const FORCED_MECHS_PRICE_BNB = null; // leave null to use on-chain price

    /* =================== TOKEN LISTS =================== */
    const MECHS = [
      { id: 0, name: "Skybone Leviathan",                           uri: "ipfs://QmXZaUkWziGrd2ooyXdQavJmPXCtWFjZrGL9239n4Nu7yU/0" },
      { id: 1, name: "Obsidian Jaguar",                             uri: "ipfs://Qmc7FAsop9nLMNfof4aYumKfSJ71sTWHhiAroKL5mA1Z4h/1" },
      { id: 2, name: "Red Clay Colossus",                           uri: "ipfs://QmdKMicaGDbmAGkaJiXNgHU6TJWrq8AB1purSBd4fyJmB7/2" },
      { id: 3, name: "SERPENT COIL MK-VII — River & Data Guardian", uri: "ipfs://Qmc1U4xsf4Yaw8D7B86v5TcDpWSFaftxX98Sh28TtU38x1/3" },
      { id: 4, name: "Void Sifu",                                   uri: "ipfs://QmXtzw2ASNnzhp3EyJXRGWQJ62RDy2b6MdCkH4dDiMY17p/4" },
    ];
    const CRYPTIDS = [
      { id:0,  name:"Wendigo.EXE",                    uri:"ipfs://QmV2X7oUrG5i284sKQPHQJAbQV8HkL788mbZexuCA5oTvx/0" },
      { id:1,  name:"Mask of Memory",                 uri:"ipfs://Qmbu7rbrAoG3cJTYEJGGJ6iZsPGpDQxhkJBsKt4QuBJj8N/0" },
      { id:2,  name:"Wolf of Wounded Knee",           uri:"ipfs://QmQm8nSAL56mGypS45f4AZ44xejVPWuktWidfZqAHdJtmk/0" },
      { id:3,  name:"Coastal Sasquatch Punk",         uri:"ipfs://QmV91qcvQmzwUEu4hin91iXqzVn7hn1F9gZ9bmfxnFTQje/0" },
      { id:4,  name:"Anishinaabe Wendigo Protocol",   uri:"ipfs://QmStEaLkFwNREJ3M4t42hNKvphwjHK1MxjA7CUdW15d6BE/0" },
      { id:5,  name:"Desert Skinwalker Punk",         uri:"ipfs://QmcW6m3B1ygPoMrsr4qVMaNC4uCL1s4EAq2LcdEsCj6iUS/0" },
      { id:6,  name:"Métis Rougarou Rider",           uri:"ipfs://Qmeg78oUMrM1fUGNMVzUNG2G5dEDuD8TLoB9Mh3j3X6zEF/0" },
      { id:7,  name:"Cherokee Skinwalker Firewall",   uri:"ipfs://QmWNsSbcy2iBmYjK2TCzELZTfzD1ezGj1WvktYiwnWnjjg/0" },
      { id:8,  name:"Wabanaki Webworm",               uri:"ipfs://QmdadZMbe1QMUW5i51smLxEDuWvRWKanLiiHdyb4zH2mbM/0" },
      { id:9,  name:"Deer Woman DAO",                 uri:"ipfs://QmTmrUDMXuqnffe1duAEYdJGAKNeSdEsVvKe8dT8YKR4i7/0" },
      { id:10, name:"The Cipherskin Codex",           uri:"ipfs://QmPcWyNf93hwKXxBH5QpseeqmkE296arM1jkg4zcvi3bgC/0" },
      { id:11, name:"Treaty.Exe",                     uri:"ipfs://QmeGbsj4E3w9zaaEnQiSsDUrPUbbTWumn8BemBnsHNdFuR/0" },
      { id:12, name:"Scroll of Unburied Seeds",       uri:"ipfs://QmNXhjcuNvaYDW7PdDi7Erh1jbkhQb6ep15FAYcXVZUByE/0" },
      { id:13, name:"The Disentrancer",               uri:"ipfs://QmQP3hP9YyAkFZwKNkrw5apxEcZ7nAZecshsaE1sdpyGaz/0" },
      { id:14, name:"Ledger Shaman",                  uri:"ipfs://QmNj8tHVjp4X1HNBFbm4nbw6mb2vzdMHrYDd8wQuE35qFw/0" },
      { id:15, name:"The Ghost of Paper Genocide",    uri:"ipfs://QmWbTfxSn4Mybnw3deUiFn3T8PVyyJkiCPZD9C91Sqz9Kk/0" },
      { id:16, name:"Ironroot Codewalker",            uri:"ipfs://QmWMhG22wfXFZufu7E2haVkqoc1XYf4bU8KXvVL6xUZZXW/0" },
      { id:17, name:"Deer Woman 9.0",                 uri:"ipfs://QmRieQJ4gpkjMsJkaB99t2M5BX5sns6CWVJPa3HNwASCEB/0" },
      { id:18, name:"Thunderbird 9G",                 uri:"ipfs://QmPnk3rYUeqeCevm7pjjfp31WrsUp8CzBP96TVRmmFky7h/0" },
      { id:19, name:"Skinwalker 9S",                  uri:"ipfs://Qmbv4hEy6gW68XSUUW46nzYmptaxiWS1vFGig3457W1Wez/0" },
    ];

    /* =================== ABIs =================== */
    const MECHS_READ_ABI = [
      "function uri(uint256) view returns (string)",
      "function getActiveClaimConditionId(uint256 _tokenId) view returns (uint256)",
      "function getClaimConditionById(uint256 _tokenId,uint256 _conditionId) view returns (tuple(uint256 startTimestamp,uint256 maxClaimableSupply,uint256 supplyClaimed,uint256 quantityLimitPerWallet,bytes32 merkleRoot,uint256 pricePerToken,address currency,string metadata) condition)"
    ];
    const MECHS_CLAIM_ABI = [
      "function claim(address _receiver,uint256 _tokenId,uint256 _quantity,address _currency,uint256 _pricePerToken,(bytes32[] proof,uint256 quantityLimitPerWallet,uint256 pricePerToken,address currency) _allowlistProof,bytes _data) payable"
    ];
    const MECHS_ERROR_ABI = [
      "error DropNoActiveCondition()",
      "error DropClaimNotStarted(uint256 expected,uint256 actual)",
      "error DropClaimExceedMaxSupply(uint256 expected,uint256 actual)",
      "error DropClaimExceedLimit(uint256 expected,uint256 actual)",
      "error DropClaimInvalidTokenPrice(address expectedCurrency,uint256 expectedPricePerToken,address actualCurrency,uint256 actualExpectedPricePerToken)"
    ];

    /* =================== Providers / State =================== */
    const readProvider = new ethers.JsonRpcProvider(READ_RPC);
    let browserProvider = null, signer = null, userAddr = null;

    /* =================== Utils =================== */
    const ZERO = ethers.ZeroAddress;
    const shorten = a => a ? `${a.slice(0,6)}…${a.slice(-4)}` : "—";
    const fmtEth = v => ethers.formatEther(v);
    const idToHex = n => n.toString(16).padStart(64,"0").toLowerCase();
    const ipfsHttp = (u,i=0)=> u?.startsWith("ipfs://")
      ? ["https://ipfs.io/ipfs/","https://cloudflare-ipfs.com/ipfs/","https://gateway.pinata.cloud/ipfs/"][Math.min(i,2)] + u.slice(7)
      : (u||"");
    const FULL_IFACE = new ethers.Interface([...MECHS_CLAIM_ABI, ...MECHS_ERROR_ABI]);
    const prettyRevert = (e)=>{
      const data = e?.data || e?.error?.data || e?.info?.error?.data || e?.error?.error?.data;
      if (typeof data === "string" && data.startsWith("0x")) { try { return FULL_IFACE.decodeErrorResult(data).name; } catch {} }
      return e?.reason || e?.shortMessage || e?.message || "Transaction failed";
    };

    async function fetchJsonWithFallback(url){
      let lastErr;
      for (let i=0;i<3;i++){
        try { const r = await fetch(ipfsHttp(url,i)); if (!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json(); }
        catch(e){ lastErr=e; }
      }
      throw lastErr || new Error("Fetch failed");
    }

    /* =================== Reads =================== */
    async function readClaim(tokenId){
      const c = new ethers.Contract(CONTRACT_MECHS, MECHS_READ_ABI, readProvider);
      const condId = await c.getActiveClaimConditionId(tokenId);
      const cond = await c.getClaimConditionById(tokenId, condId);
      return cond;
    }
    async function load1155Meta(tokenId){
      const c = new ethers.Contract(CONTRACT_MECHS, MECHS_READ_ABI, readProvider);
      const base = await c.uri(tokenId);
      const url = base.includes("{id}") ? base.replace("{id}", idToHex(tokenId)) : base;
      return await fetchJsonWithFallback(url);
    }

    /* =================== Wallet =================== */
    async function connectWallet(){
      const btn = document.getElementById('connectBtn');
      const info = document.getElementById('walletInfo');
      const statusEl = document.getElementById('connStatus');
      try{
        if(!window.ethereum) throw new Error("MetaMask not detected");
        btn.disabled = true; btn.textContent = "Connecting…";
        statusEl.className = "status warning"; statusEl.textContent = "Requesting connection…";

        browserProvider = new ethers.BrowserProvider(window.ethereum,'any');
        await browserProvider.send('eth_requestAccounts',[]);
        const net = await browserProvider.getNetwork();
        if (Number(net.chainId) !== BSC_CHAIN_ID){
          try{
            await browserProvider.send('wallet_switchEthereumChain',[{ chainId:'0x'+BSC_CHAIN_ID.toString(16) }]);
          }catch(err){
            if (err?.code === 4902){
              await browserProvider.send('wallet_addEthereumChain',[{
                chainId:'0x'+BSC_CHAIN_ID.toString(16),
                chainName:'Binance Smart Chain',
                nativeCurrency:{ name:'BNB', symbol:'BNB', decimals:18 },
                rpcUrls:['https://bsc-dataseed1.bnbchain.org','https://bsc-dataseed2.bnbchain.org','https://bsc-dataseed.binance.org'],
                blockExplorerUrls:['https://bscscan.com/']
              }]);
            } else throw err;
          }
        }

        signer = await browserProvider.getSigner();
        userAddr = await signer.getAddress();

        window.ethereum.on?.('accountsChanged', acc=>{
          if (!acc?.length) return disconnectWallet();
          userAddr = acc[0]; document.getElementById('walletAddress').textContent = shorten(userAddr); updateBalance(); updateMechPreview();
        });
        window.ethereum.on?.('chainChanged', async ()=>{
          browserProvider = new ethers.BrowserProvider(window.ethereum,'any');
          await updateNetworkIndicator(); await updateBalance(); await updateMechPreview();
        });

        document.getElementById('walletAddress').textContent = shorten(userAddr);
        info.style.display = "flex";
        await updateNetworkIndicator();
        await updateBalance();

        statusEl.className = "status success"; statusEl.textContent = "Wallet connected!";
        btn.style.display = "none";
      }catch(e){
        statusEl.className = "status error"; statusEl.textContent = prettyRevert(e);
        btn.disabled = false; btn.textContent = "Connect Wallet";
      }
    }
    function disconnectWallet(){
      try{
        window.ethereum?.removeListener?.('accountsChanged', ()=>{});
        window.ethereum?.removeListener?.('chainChanged',   ()=>{});
      }catch{}
      browserProvider = null; signer = null; userAddr = null;
      document.getElementById('connectBtn').textContent = 'Connect Wallet';
      document.getElementById('walletInfo').style.display = 'none';
      document.getElementById('connStatus').textContent = '';
    }
    async function updateNetworkIndicator(){
      const indicator = document.querySelector('.network-indicator');
      if (!browserProvider || !indicator) return;
      const net = await browserProvider.getNetwork();
      const cid = Number(net.chainId);
      document.getElementById('networkName').textContent = (cid===56?'BSC':`Chain ${cid}`);
      indicator.className = 'network-indicator ' + (cid===BSC_CHAIN_ID ? 'valid' : 'invalid');
    }
    async function updateBalance(){
      if (!browserProvider || !userAddr) return;
      const bal = await browserProvider.getBalance(userAddr);
      document.getElementById('balanceAmount').textContent = fmtEth(bal);
      document.getElementById('balanceCurrency').textContent = 'BNB';
      document.getElementById('mechsBalance').textContent = `${fmtEth(bal)} BNB`;
    }

    /* =================== Renderers =================== */
    function populateSelect(selectEl, items){
      selectEl.innerHTML = '';
      for (const it of items){
        const opt = document.createElement('option');
        opt.value = String(it.id);
        opt.textContent = `#${it.id} — ${it.name}`;
        selectEl.appendChild(opt);
      }
    }

    async function updateMechPreview(){
      const tokenId = Number(document.getElementById('mechsTokenId').value);
      const mech = MECHS.find(m => m.id === tokenId);
      const nameEl = document.getElementById('mechsName');
      const imgEl  = document.getElementById('mechsImg');
      const priceEl= document.getElementById('mechsPrice');
      const currEl = document.getElementById('mechsCurrency');
      const supEl  = document.getElementById('mechsSupply');
      const status = document.getElementById('mechsStatus');

      nameEl.textContent = mech?.name || `#${tokenId}`;
      imgEl.src = ""; imgEl.alt = "Preview"; imgEl.classList.add("loading");
      priceEl.textContent = "loading…"; currEl.textContent = "loading…"; supEl.textContent = "—";
      status.className = "status"; status.textContent = "";

      try {
        // Metadata & image
        const meta = mech?.uri ? await fetchJsonWithFallback(mech.uri) : await load1155Meta(tokenId);
        const rawImg = meta?.image || meta?.image_url || meta?.imageUri || "";
        let i=0; const setNext=()=> imgEl.src = ipfsHttp(rawImg,i++);
        imgEl.onerror = ()=>{ if(i<3) setNext(); }; setNext();
        imgEl.classList.remove("loading");

        // Claim read
        let claim;
        try {
          claim = await readClaim(tokenId);
        } catch (err) {
          // No active phase (common): show friendly message and bail gracefully
          status.className = "status warning";
          status.textContent = "No active claim for this token yet.";
          priceEl.textContent = "—"; currEl.textContent = "—"; supEl.textContent = "—";
          return;
        }

        const isNative = String(claim.currency).toLowerCase() === ZERO.toLowerCase();
        const pricePer = FORCED_MECHS_PRICE_BNB ? ethers.parseEther(FORCED_MECHS_PRICE_BNB) : claim.pricePerToken;

        currEl.textContent = isNative ? "BNB" : "ERC20";
        priceEl.textContent = isNative ? `${ethers.formatEther(pricePer)} BNB` : pricePer.toString();
        supEl.textContent = `${(claim.supplyClaimed||0n).toString()} / ${(claim.maxClaimableSupply||0n).toString()}`;
      } catch(e){
        status.className = "status warning";
        status.textContent = "Metadata unavailable or claim read failed.";
        imgEl.classList.remove("loading");
      }
    }

    /* =================== Mint =================== */
    async function mintMech(){
      const status = document.getElementById('mechsStatus');
      const btn = document.getElementById('mechsMint');
      const qty = Math.max(1, Number(document.getElementById('mechsQty').value) || 1);
      const tokenId = Number(document.getElementById('mechsTokenId').value);

      try{
        if(!signer) await connectWallet();
        if(!signer) return;

        status.className = "status warning"; status.textContent = "Preparing transaction…"; btn.disabled = true;

        // read claim
        const claim = await readClaim(tokenId);
        const isNative = String(claim.currency).toLowerCase() === ZERO.toLowerCase();
        const pricePer = FORCED_MECHS_PRICE_BNB ? ethers.parseEther(FORCED_MECHS_PRICE_BNB) : claim.pricePerToken;
        const totalValue = isNative ? (pricePer * BigInt(qty)) : 0n;

        // funds check (BNB path)
        if (isNative) {
          const bal = await browserProvider.getBalance(userAddr);
          if (bal < totalValue) throw new Error(`Insufficient BNB. Need ${ethers.formatEther(totalValue)} BNB.`);
        }

        // build args
        const allowlist = { proof: [], quantityLimitPerWallet: 0n, pricePerToken: pricePer, currency: isNative ? ZERO : claim.currency };
        const args = [ (await signer.getAddress()), tokenId, qty, isNative ? ZERO : claim.currency, pricePer, allowlist, "0x" ];

        // simulate (eth_call)
        const data = FULL_IFACE.encodeFunctionData("claim", args);
        await signer.call({ to: CONTRACT_MECHS, data, value: totalValue });

        // estimate + send raw tx
        let gasLimit;
        try { const est = await signer.estimateGas({ to: CONTRACT_MECHS, data, value: totalValue }); gasLimit = (est*120n)/100n; } catch {}
        status.className = "status warning"; status.textContent = "Sending transaction…";
        const tx = await signer.sendTransaction({ to: CONTRACT_MECHS, data, value: totalValue, ...(gasLimit?{gasLimit}:{}) });
        const rec = await tx.wait();

        status.className = "status success"; status.textContent = `Minted! Tx: ${rec.transactionHash.slice(0,10)}…`;
        await updateMechPreview();
      }catch(e){
        status.className = "status error"; status.textContent = `❌ ${prettyRevert(e)}`;
      }finally{
        btn.disabled = false;
      }
    }

    /* =================== Cryptids (preview only) =================== */
    function populateCryptids(){
      const sel = document.getElementById('cryptidTokenId');
      sel.innerHTML = '';
      for (const it of CRYPTIDS){
        const opt = document.createElement('option');
        opt.value = String(it.id);
        opt.textContent = `#${it.id} — ${it.name}`;
        sel.appendChild(opt);
      }
      // simple placeholder preview
      const img = document.getElementById('cryptidImg');
      const name = document.getElementById('cryptidName');
      sel.addEventListener('change', ()=>{
        const id = Number(sel.value);
        const entry = CRYPTIDS.find(x=>x.id===id);
        name.textContent = entry?.name || `Token #${id}`;
        img.src = "https://via.placeholder.com/180x180/0c1d27/73E1FF?text=Cryptid+"+id;
      });
      sel.dispatchEvent(new Event('change'));
    }

    /* =================== Boot =================== */
    function boot(){
      // populate selects
      populateSelect(document.getElementById('mechsTokenId'), MECHS);
      populateCryptids();
      // initial preview
      updateMechPreview();

      // events
      document.getElementById('connectBtn').addEventListener('click', connectWallet);
      document.getElementById('mechsTokenId').addEventListener('change', updateMechPreview);
      document.getElementById('mechsQty').addEventListener('change', updateMechPreview);
      document.getElementById('mechsMint').addEventListener('click', mintMech);

      // auto-connect if already authorized
      (async ()=>{
        if (window.ethereum){
          const acc = await window.ethereum.request({ method:'eth_accounts' });
          if (acc?.length){
            browserProvider = new ethers.BrowserProvider(window.ethereum,'any');
            signer = await browserProvider.getSigner();
            userAddr = acc[0];
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('walletInfo').style.display = 'flex';
            document.getElementById('walletAddress').textContent = shorten(userAddr);
            await updateNetworkIndicator(); await updateBalance();
            window.ethereum.on?.('accountsChanged', ()=>{}); // attached in connectWallet too
            window.ethereum.on?.('chainChanged',  ()=>{});
          }
        }
      })();
    }
    boot();
  </script>
</body>
</html>
