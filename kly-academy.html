<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0B0D17" />
  <title>KLY Academy â€” DeFi Mastery</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Motion & FX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Web3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#0B0D17; --bg-2:#0E1020; --panel:rgba(255,255,255,.06); --panel-2:rgba(255,255,255,.08);
      --glass:rgba(255,255,255,.08); --border:rgba(255,255,255,.14); --muted:rgba(255,255,255,.72);
      --txt:#EAF2FF; --txt-dim:#B7C3D9;
      --pri:#7A5CFF; --pri-2:#A690FF; --acc:#00E0FF; --sec:#FF7D05;
      --good:#00C853; --warn:#FFAB00; --bad:#FF3D00;
      --shadow:0 10px 40px rgba(0,0,0,.4);
      --radius:14px;
      --ring:0 0 0 3px rgba(0,224,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); background:
        radial-gradient(1200px 800px at 10% -10%, rgba(122,92,255,.16), transparent 60%),
        radial-gradient(1200px 800px at 110% 0%, rgba(0,224,255,.12), transparent 60%), var(--bg);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      line-height:1.55; overflow-x:hidden;
    }
    a{color:var(--acc); text-decoration:none}
    a:hover{opacity:.9}
    [hidden]{display:none!important}
    .container{max-width:1200px; margin:0 auto; padding:20px}
    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(10px);
      background:linear-gradient(180deg, rgba(11,13,23,.7), rgba(11,13,23,.4));
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 20px}
    .brand{display:flex; align-items:center; gap:12px; font-family:"Space Grotesk", Inter, sans-serif}
    .brand i{font-size:22px; color:var(--pri)}
    .brand span{font-weight:800; letter-spacing:.5px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:var(--panel); border:1px solid var(--border); color:var(--txt-dim); font-size:13px}
    .chip i{color:var(--acc)}
    .top-actions{display:flex; align-items:center; gap:10px}
    .btn{
      appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--txt); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; transition:.2s; display:inline-flex; gap:10px; align-items:center
    }
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
    .btn-primary{background:linear-gradient(90deg, var(--pri), var(--acc)); border-color:transparent}
    .btn-ghost{background:transparent}
    .wallet-pill{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:var(--txt-dim)}
    /* Hero */
    .hero{
      display:grid; grid-template-columns:1.2fr .8fr; gap:18px; margin-top:22px;
    }
    .hero-card{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); position:relative; overflow:hidden;
    }
    .hero h1{margin:0 0 8px; font-family:"Space Grotesk", Inter; font-weight:700; font-size:36px; letter-spacing:.2px}
    .hero h1 .grad{background:linear-gradient(90deg, var(--pri), var(--acc)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .hero p{color:var(--txt-dim); margin:0 0 18px}
    .mini-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .stat{
      background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:14px;
      display:flex; align-items:center; gap:12px; color:var(--txt-dim); font-size:13px
    }
    .stat i{color:var(--acc)}
    /* Right hero card */
    .balance-card .row{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .ring{
      --size:84px; width:var(--size); height:var(--size); border-radius:50%; position:relative; display:grid; place-items:center;
      background:
        radial-gradient(closest-side, #0000 79%, #0000 80% 100%),
        conic-gradient(var(--pri) var(--p,0%), #2B2F45 0);
    }
    .ring::before{
      content:attr(data-label); position:absolute; inset:8px; border-radius:50%; display:grid; place-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--border); color:#AFC3FF; font-weight:700; font-size:12px;
    }
    .balance-card .kpi{display:flex; align-items:center; gap:12px}
    .balance-card .kpi strong{font-size:18px}
    /* Main layout */
    .grid{
      display:grid; grid-template-columns:300px 1fr 320px; gap:18px; margin-top:18px;
    }
    @media (max-width:1100px){ .hero{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
    /* Panels */
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border)}
    .panel .hd h3{margin:0; font-size:16px; letter-spacing:.2px}
    .panel .bd{padding:16px 18px}
    /* Sidebar (left) */
    .profile{display:flex; align-items:center; gap:12px}
    .avatar{width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, var(--pri), var(--acc)); display:grid; place-items:center; font-weight:800}
    .profile .addr{font-family:ui-monospace, monospace; color:var(--txt-dim); font-size:13px}
    .menu{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .menu button{
      text-align:left; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding:12px; border-radius:10px; color:var(--txt); display:flex; align-items:center; gap:10px; cursor:pointer
    }
    .menu button.active{outline:var(--ring); border-color:transparent}
    .menu .badge{margin-left:auto; background:var(--sec); color:#0B0D17; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}
    /* Curriculum (center) */
    .accordion{display:flex; flex-direction:column; gap:10px}
    .acc{
      border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border-radius:12px; overflow:hidden
    }
    .acc-sum{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; cursor:pointer; user-select:none
    }
    .acc-sum h4{margin:0; font-size:15px}
    .acc-sum .left{display:flex; align-items:center; gap:12px}
    .acc-sum .left .num{width:34px; height:34px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg, var(--pri), var(--acc)); font-weight:800}
    .acc-sum .right{display:flex; align-items:center; gap:10px}
    .acc-body{display:none; padding:0 16px 16px 16px; color:var(--txt-dim)}
    .acc.open .acc-body{display:block}
    .acc .callout{margin:12px 0; border-left:3px solid var(--acc); padding:10px 12px; background:rgba(0,224,255,.08); border-radius:0 10px 10px 0}
    .acc .list{padding-left:18px}
    .acc .list li{margin:6px 0}
    .acc .actions{display:flex; gap:8px; flex-wrap:wrap}
    .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--txt-dim)}
    .btn-mark{background:linear-gradient(90deg, var(--pri), var(--acc)); border-color:transparent; color:white}
    /* Right column */
    .card{padding:16px}
    .kv{display:grid; grid-template-columns:auto 1fr; gap:6px 12px; color:var(--txt-dim); font-size:14px}
    .kv strong{color:var(--txt)}
    .cert-img{border-radius:12px; overflow:hidden; border:1px solid var(--border); margin:8px 0 14px 0}
    .cert-img img{display:block; width:100%}
    .muted{color:var(--txt-dim)}
    /* Notification */
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:60; padding:14px 16px; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); color:var(--txt); display:flex; gap:10px; align-items:flex-start; box-shadow:var(--shadow)
    }
    .toast i{margin-top:2px}
    .toast.good{border-left:4px solid var(--good)}
    .toast.bad{border-left:4px solid var(--bad)}
    .toast.warn{border-left:4px solid var(--warn)}
    .toast .x{background:none; border:0; color:var(--txt-dim); margin-left:8px; cursor:pointer}
    /* Accessibility */
    :focus-visible{outline:none; box-shadow:var(--ring)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i>
        <span>KLY ACADEMY</span>
        <span class="chip"><i class="fa-regular fa-circle-check"></i> DeFi Track</span>
      </div>
      <div class="top-actions">
        <span id="progress-chip" class="chip"><i class="fa-solid fa-chart-simple"></i><span id="chip-text">0/12 Complete</span></span>
        <button id="btn-connect" class="btn btn-primary"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <span id="wallet-pill" class="chip wallet-pill" hidden><i class="fa-solid fa-user-astronaut"></i> <span id="addr-short">0xâ€¦</span></span>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <section class="hero">
      <div class="hero-card animate__animated animate__fadeInUp">
        <h1>Learn. Earn. <span class="grad">Own Finance.</span></h1>
        <p>Unlock an interactive DeFi curriculum. Pass each module, track your progress, and mint an on-chain certificate when youâ€™re done.</p>
        <div class="mini-grid">
          <div class="stat"><i class="fa-solid fa-shield-halved"></i><div><div><strong>Self-Custody</strong></div><small>Keys stay with you</small></div></div>
          <div class="stat"><i class="fa-solid fa-bolt"></i><div><div><strong>Hands-on</strong></div><small>Practical tasks</small></div></div>
          <div class="stat"><i class="fa-solid fa-certificate"></i><div><div><strong>On-chain Proof</strong></div><small>NFT certificate</small></div></div>
        </div>
      </div>
      <div class="hero-card balance-card panel animate__animated animate__fadeInUp" style="--animate-delay:.05s">
        <div class="row">
          <h3 style="margin:0">Access Gate</h3>
          <div class="ring" id="ring" style="--p:0%" data-label="0%"></div>
        </div>
        <p class="muted">You need <strong>â‰¥ 100 KLY</strong> on BNB Chain to unlock the course.</p>
        <div class="kpi"><i class="fa-solid fa-coins" style="color:var(--acc)"></i><div><div class="muted">Your KLY balance</div><strong id="kly-balance">â€”</strong></div></div>
        <div class="kpi" style="margin-top:10px"><i class="fa-solid fa-network-wired" style="color:var(--pri)"></i><div><div class="muted">Network</div><strong id="net-name">Not connected</strong></div></div>
      </div>
    </section>

    <!-- Main Grid -->
    <section class="grid">
      <!-- LEFT: Profile + Menus -->
      <aside class="panel">
        <div class="hd">
          <h3>Profile</h3>
          <button id="btn-disconnect" class="btn btn-ghost" hidden><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        </div>
        <div class="bd">
          <div class="profile">
            <div class="avatar" id="avatar">KA</div>
            <div>
              <div style="font-weight:700">Learner</div>
              <div id="addr-full" class="addr">Not connected</div>
            </div>
          </div>

          <div style="margin-top:16px; border-top:1px solid var(--border); padding-top:14px">
            <div class="muted" style="margin-bottom:8px">Jump to module</div>
            <div id="menu-beginner" class="menu"></div>
            <div style="height:10px"></div>
            <div class="muted" style="margin-bottom:8px">Master series</div>
            <div id="menu-master" class="menu"></div>
          </div>
        </div>
      </aside>

      <!-- CENTER: Curriculum -->
      <main class="panel">
        <div class="hd"><h3>Curriculum</h3></div>
        <div class="bd">
          <div id="accordion" class="accordion"></div>
        </div>
      </main>

      <!-- RIGHT: Certificate -->
      <aside class="panel">
        <div class="hd"><h3>Certificate</h3></div>
        <div class="bd card">
          <div class="cert-img"><img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="KLY Academy Certificate"></div>
          <p class="muted">Complete all modules to mint your NFT certificate on BNB Chain.</p>
          <div class="kv" style="margin:10px 0 14px">
            <div>Progress</div><strong id="cert-progress">0 / 12</strong>
            <div>Status</div><strong id="cert-status">Locked</strong>
          </div>
          <button id="btn-mint" class="btn btn-primary" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
          <div id="mint-status" class="muted" style="margin-top:10px"></div>
        </div>
      </aside>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden>
    <i id="toast-icon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toast-title" style="font-weight:800; margin-bottom:4px">Info</div>
      <div id="toast-msg" class="muted">Message</div>
    </div>
    <button class="x" onclick="hideToast()"><i class="fa-solid fa-xmark"></i></button>
  </div>

<script>
/* ========= CONFIG ========= */
const KLY_TOKEN_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const NFT_CONTRACT_ADDRESS = "0xc1a2E9A475779EfD04247EA473638717E26cd5C5";
const KLY_TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const NFT_CONTRACT_ABI = [
  "function mintTo(address to, string uri) public"
];
const TOTAL_MODULES = 12;
const BSC = { idDec:56, idHex:"0x38", name:"BNB Smart Chain", rpc:"https://bsc-dataseed.binance.org/" };

/* ========= STATE ========= */
let web3Modal, provider, signer, account = null;
let completed = JSON.parse(localStorage.getItem("kly_completed_v2") || "[]");
let opened = null;

/* ========= UI EL ========= */
const btnConnect = document.getElementById("btn-connect");
const btnDisconnect = document.getElementById("btn-disconnect");
const walletPill = document.getElementById("wallet-pill");
const addrShort = document.getElementById("addr-short");
const addrFull = document.getElementById("addr-full");
const avatar = document.getElementById("avatar");
const ring = document.getElementById("ring");
const klyBalanceEl = document.getElementById("kly-balance");
const netNameEl = document.getElementById("net-name");
const progressChip = document.getElementById("chip-text");
const certProgress = document.getElementById("cert-progress");
const certStatus = document.getElementById("cert-status");
const btnMint = document.getElementById("btn-mint");
const mintStatus = document.getElementById("mint-status");
const toast = document.getElementById("toast");
const toastIcon = document.getElementById("toast-icon");
const toastTitle = document.getElementById("toast-title");
const toastMsg = document.getElementById("toast-msg");

/* ========= DATA ========= */
const modules = [
  // Beginner 1â€“5
  {
    id:"module1", group:"beginner", n:1, title:"DeFi Basics",
    bullets:["What is DeFi?","Core components (Blockchain, Smart Contracts, DAOs, dApps)","Why DeFi matters: access, fees, transparency"],
    callout:["Key insight","Your keys, your crypto. Self-custody is the foundation of sovereignty."]
  },
  { id:"module2", group:"beginner", n:2, title:"Wallet Setup",
    bullets:["Hot vs Hardware wallets","Setup & seed phrase security","Fund with BNB (gas) + KLY (access)"],
    callout:["Security","Never store your recovery phrase digitally. Offline only."] },
  { id:"module3", group:"beginner", n:3, title:"Using DEXs",
    bullets:["AMMs & non-custodial swaps","Slippage, gas, price impact","Top venues: PancakeSwap / Uniswap / 1inch"],
    callout:["Advantage","DEXs never hold your assets â€” you do."] },
  { id:"module4", group:"beginner", n:4, title:"Earning with DeFi",
    bullets:["Staking & Lending","LP fees & incentives","Yield farming risks (IL, emissions decay)"],
    callout:["Rule of thumb","Higher APY = higher risk. Diversify and size positions."] },
  { id:"module5", group:"beginner", n:5, title:"Safety & Strategy",
    bullets:["Common threats (phishing, rugs, approvals)","Risk limits + checklists","Stay informed & document theses"],
    callout:["Golden rule","If it looks too good to be true, it probably is."] },
  // Master 1â€“7
  { id:"mdf-1", group:"master", n:1, title:"Sovereign Mindset",
    bullets:["Owner-operator identity","Replace scarcity patterns","AM/PM review rituals"],
    callout:["Practice","Write 5 money beliefs. Reframe them in first-principles language."] },
  { id:"mdf-2", group:"master", n:2, title:"Blockchain & Tokenomics",
    bullets:["Consensus & security","ERC-20 / 721 / 1155 basics","Token utility, emissions, vesting"],
    callout:["Due diligence","Verify contracts, proxies, vesting, and on-chain usage trends."] },
  { id:"mdf-3", group:"master", n:3, title:"Wealth via Ecosystems",
    bullets:["Utility-first vs narrative-first","Roles: Holder / LP / Contributor","Participation flywheel"],
    callout:["Security setup","Hot wallet for ops; hardware for vault; schedule approval revokes."] },
  { id:"mdf-4", group:"master", n:4, title:"DeFi Mastery",
    bullets:["Yield spectrum & sizing","AMMs & impermanent loss","Vault automation & exits"],
    callout:["Playbook","Define target APY, max drawdown, and farm pause triggers."] },
  { id:"mdf-5", group:"master", n:5, title:"NFTs as Wealth Vehicles",
    bullets:["Utility matrix (access/identity/revenue)","Mint design & royalties","Trading: volume, holders, wash trading"],
    callout:["Tracks","Creator: one-pager; Trader: pre-trade checklist & risk limits."] },
  { id:"mdf-6", group:"master", n:6, title:"Multiple Web3 Incomes",
    bullets:["Freelance & bounties","Education & communities","DAO ops & grants"],
    callout:["Matrix","Balance stable income, token upside, and royalties; track KPIs monthly."] },
  { id:"mdf-7", group:"master", n:7, title:"Sovereign Wealth Strategy",
    bullets:["Core/Satellite/Venture allocation","Protection: hardware, multisig, estate basics","Compounding flywheel & reviews"],
    callout:["Drills","Recovery simulation; quarterly premortem on portfolio risks."] },
];

/* ========= RENDER ========= */
function renderMenus(){
  const beg = document.getElementById("menu-beginner");
  const mst = document.getElementById("menu-master");
  beg.innerHTML = ""; mst.innerHTML = "";
  modules.filter(m=>m.group==="beginner").forEach(m=>{
    beg.appendChild(menuButton(m));
  });
  modules.filter(m=>m.group==="master").forEach(m=>{
    mst.appendChild(menuButton(m));
  });
}
function menuButton(m){
  const b = document.createElement("button");
  b.innerHTML = `<i class="fa-solid fa-book-open"></i> ${m.title} <span class="badge">${m.group==="beginner"?m.n:m.n}</span>`;
  b.onclick = ()=>toggleAcc(m.id, true);
  b.id = `menu-${m.id}`;
  return b;
}
function renderAccordion(){
  const wrap = document.getElementById("accordion");
  wrap.innerHTML = "";
  modules.forEach(m=>{
    const acc = document.createElement("div");
    acc.className = "acc"; acc.id = `acc-${m.id}`;
    const done = completed.includes(m.id);
    acc.innerHTML = `
      <div class="acc-sum" role="button" aria-expanded="false">
        <div class="left">
          <div class="num">${m.group==="beginner"?m.n:"M"+m.n}</div>
          <h4>${m.title}</h4>
          ${done?`<span class="pill" style="border-color:rgba(0,200,83,.4); color:#9CF7C1"><i class="fa-solid fa-circle-check"></i> Completed</span>`:""}
        </div>
        <div class="right">
          <button class="btn btn-ghost"><i class="fa-solid fa-chevron-down"></i></button>
        </div>
      </div>
      <div class="acc-body">
        <div class="callout"><strong>${m.callout[0]}:</strong> ${m.callout[1]}</div>
        <ul class="list">${m.bullets.map(li=>`<li>${li}</li>`).join("")}</ul>
        <div class="actions">
          <button class="btn btn-mark" onclick="markComplete('${m.id}')"><i class="fa-solid fa-check"></i> Mark Complete</button>
          <span class="pill"><i class="fa-solid fa-clock"></i> ~10â€“15 min</span>
          <span class="pill"><i class="fa-solid fa-signal"></i> ${m.group==="beginner"?"Beginner":"Master"}</span>
        </div>
      </div>
    `;
    acc.querySelector(".acc-sum").onclick = ()=>toggleAcc(m.id, false);
    wrap.appendChild(acc);
  });
}
function toggleAcc(id, viaMenu){
  const acc = document.getElementById(`acc-${id}`);
  const isOpen = acc.classList.contains("open");
  // close all
  document.querySelectorAll(".acc").forEach(a=>{
    a.classList.remove("open");
    a.querySelector(".acc-sum").setAttribute("aria-expanded","false");
  });
  if(!isOpen){ acc.classList.add("open"); acc.querySelector(".acc-sum").setAttribute("aria-expanded","true"); opened = id; }
  // highlight menu
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  const btn = document.getElementById(`menu-${id}`); if(btn) btn.classList.add("active");
  if(viaMenu){ acc.scrollIntoView({behavior:"smooth", block:"start"}); }
}

/* ========= PROGRESS ========= */
function markComplete(id){
  if(!completed.includes(id)){ completed.push(id); localStorage.setItem("kly_completed_v2", JSON.stringify(completed)); }
  notify("Success","Module marked complete","good","fa-circle-check");
  renderAccordion();
  updateProgressUI();
  pulseConfetti();
}
function updateProgressUI(){
  const unique = [...new Set(completed)].filter(id => modules.some(m => m.id === id));
  const done = unique.length;
  const pct = Math.min(100, Math.round((done / TOTAL_MODULES) * 100));
  progressChip.textContent = `${done}/${TOTAL_MODULES} Complete`;
  certProgress.textContent = `${done} / ${TOTAL_MODULES}`;
  ring.style.setProperty("--p", pct + "%");
  ring.setAttribute("data-label", pct + "%");
  if(done >= TOTAL_MODULES){
    certStatus.textContent = "Ready to Mint";
    btnMint.disabled = false;
    btnMint.classList.remove("btn-ghost");
  }else{
    certStatus.textContent = "Locked";
    btnMint.disabled = true;
  }
}

/* ========= NOTIFY ========= */
function notify(title, msg, type="info", icon="fa-circle-info"){
  toastTitle.textContent = title; toastMsg.textContent = msg;
  toastIcon.className = `fa-solid ${icon}`;
  toast.classList.remove("good","bad","warn");
  if(type==="good") toast.classList.add("good");
  else if(type==="bad") toast.classList.add("bad");
  else if(type==="warn") toast.classList.add("warn");
  toast.hidden = false;
  clearTimeout(notify._t); notify._t = setTimeout(()=>{ toast.hidden = true; }, 4200);
}
function hideToast(){ toast.hidden = true; }

/* ========= CONFETTI ========= */
function pulseConfetti(){
  if(typeof confetti!=="function") return;
  confetti({ particleCount:80, spread:60, origin:{y:0.8}, colors:["#7A5CFF","#00E0FF","#FF7D05"] });
}

/* ========= WEB3 ========= */
async function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { [BSC.idDec]: BSC.rpc }, chainId: BSC.idDec }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:"dark" });
}
async function connect(){
  try{
    btnConnect.disabled = true; btnConnect.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connectingâ€¦';
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance, "any");
    signer = provider.getSigner();
    account = await signer.getAddress();

    // chain
    const net = await provider.getNetwork();
    if(net.chainId !== BSC.idDec){
      try{
        await instance.request({ method:"wallet_switchEthereumChain", params:[{ chainId:BSC.idHex }] });
      }catch(e){
        if(e?.code===4902){
          await instance.request({ method:"wallet_addEthereumChain", params:[{
            chainId:BSC.idHex, chainName:BSC.name, nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
            rpcUrls:[BSC.rpc], blockExplorerUrls:["https://bscscan.com"]
          }]}).catch(()=>{});
        }
      }
      // re-check
      const net2 = await provider.getNetwork(); if(net2.chainId !== BSC.idDec){ notify("Switch Network","Please switch to BNB Smart Chain","warn","fa-triangle-exclamation"); resetConnectUI(); return; }
    }

    // listeners
    instance.on?.("accountsChanged", accs => { if(!accs?.length) return disconnect(); account = accs[0]; afterConnectUI(); });
    instance.on?.("chainChanged", async () => { const n = await provider.getNetwork(); if(n.chainId !== BSC.idDec) { notify("Wrong Network","Switch to BNB Chain","warn","fa-plug"); } afterConnectUI(); });
    instance.on?.("disconnect", () => disconnect());

    await afterConnectUI();
  }catch(err){
    notify("Connection Failed", err?.message || "User rejected", "bad", "fa-circle-xmark");
    resetConnectUI();
  }
}
function resetConnectUI(){
  btnConnect.disabled = false; btnConnect.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
}
async function afterConnectUI(){
  const short = `${account.slice(0,6)}â€¦${account.slice(-4)}`;
  addrShort.textContent = short; addrFull.textContent = account;
  avatar.textContent = account.slice(2,4).toUpperCase();
  walletPill.hidden = false; btnDisconnect.hidden = false;
  btnConnect.hidden = true;

  // Read KLY balance
  try{
    const kly = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const [raw, dec] = await Promise.all([kly.balanceOf(account), kly.decimals()]);
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    klyBalanceEl.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:4})} KLY`;
    netNameEl.textContent = BSC.name;

    // Update ring to 100% if gate cleared
    const p = Math.max(0, Math.min(100, Math.round((Math.min(bal, 100) / 100)*100)));
    ring.style.setProperty("--p", p + "%"); ring.setAttribute("data-label", p + "%");

    if(bal >= 100){
      notify("Access Granted","You have enough KLY to unlock the course.","good","fa-unlock-keyhole");
    }else{
      notify("Access Locked","You need â‰¥ 100 KLY to unlock. Buy on PancakeSwap.","warn","fa-lock");
    }
  }catch(e){
    klyBalanceEl.textContent = "â€”";
    notify("Read Error","Could not read KLY balance","bad","fa-bug");
  }
}
async function disconnect(){
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  provider = signer = null; account = null;
  btnConnect.hidden = false; btnDisconnect.hidden = true; walletPill.hidden = true;
  addrFull.textContent = "Not connected"; avatar.textContent = "KA";
  resetConnectUI();
  notify("Disconnected","Wallet disconnected","good","fa-right-from-bracket");
}

/* ========= MINT ========= */
async function mint(){
  if(!signer) return notify("Connect Wallet","Please connect your wallet first.","warn","fa-wallet");
  if(completed.length < TOTAL_MODULES) return notify("Finish Modules","Complete all modules to mint.","warn","fa-list-check");
  try{
    btnMint.disabled = true; btnMint.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mintingâ€¦';
    const to = await signer.getAddress();
    const nft = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
    const tokenURI = "ipfs://bafybeihkmkaf2mgx7xkrnkhmzd2uvhr6ddgj6z3vkqcgnvlaa3z7x263r4";

    let gas = await nft.estimateGas.mintTo(to, tokenURI).catch(()=>null);
    if(!gas){ notify("Gas Estimation Failed","Are you authorized to mint?","bad","fa-engine-warning"); btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate'; return; }

    const tx = await nft.mintTo(to, tokenURI, { gasLimit: gas.mul(120).div(100) });
    mintStatus.innerHTML = `Tx submitted: <a href="https://bscscan.com/tx/${tx.hash}" target="_blank" rel="noopener">view on BscScan</a>`;
    await tx.wait();
    notify("Minted","Certificate minted successfully!","good","fa-certificate");
    btnMint.innerHTML = '<i class="fa-solid fa-circle-check"></i> Minted';
    pulseConfetti();
  }catch(e){
    notify("Mint Failed", e?.message || "Unknown error", "bad", "fa-circle-xmark");
    btnMint.disabled = false; btnMint.innerHTML = '<i class="fa-solid fa-certificate"></i> Mint Certificate';
  }
}

/* ========= INIT ========= */
function initUI(){
  renderMenus();
  renderAccordion();
  updateProgressUI();
  // Open first by default
  toggleAcc(modules[0].id, false);
  // Cached session?
  if(localStorage.getItem("kly_opened")) toggleAcc(localStorage.getItem("kly_opened"), false);
}
btnConnect.addEventListener("click", connect);
btnDisconnect.addEventListener("click", disconnect);
btnMint.addEventListener("click", mint);
window.addEventListener("beforeunload", () => { if(opened) localStorage.setItem("kly_opened", opened); });

window.addEventListener("load", async ()=>{
  initUI();
  await initWeb3Modal();
  if(window.Web3Modal && web3Modal.cachedProvider){ try{ await connect(); }catch{} }
});
</script>
</body>
</html>
