<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#060713"/>
  <title>KLY Academy — DeFi Neon • Private</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Motion & FX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Web3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#060713; --bg2:#0a0c1f;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --border:rgba(132,255,255,.18);
      --txt:#E9EEFF; --muted:#B9C3E5;
      --cyn:#00eaff; --pnk:#ff3bff; --vio:#9333ff; --sun:#ffb300; --lime:#00ff95;
      --gold:#FFD98A; --gold2:#FFB74A; --danger:#ff3d3d;

      --glow-cyn:0 0 24px rgba(0,234,255,.35);
      --glow-pnk:0 0 24px rgba(255,59,255,.35);
      --glow-vio:0 0 24px rgba(147,51,255,.35);

      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--txt);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1100px 700px at 12% -8%, rgba(0,234,255,.10), transparent 60%),
        radial-gradient(900px 600px at 100% -10%, rgba(255,59,255,.10), transparent 60%),
        linear-gradient(180deg,#050611, #0a0c1f 60%, #07081a);
      overflow-x:hidden;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        radial-gradient(50% 35% at 70% -10%, rgba(255,217,138,.15), transparent 60%),
        conic-gradient(from 230deg at 20% 10%, rgba(0,234,255,.08), transparent 45%);
      filter: blur(18px);
      animation: drift 18s ease-in-out infinite alternate;
    }
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='table' tableValues='0 0 0 .08 0'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity:.7; mix-blend-mode:overlay;
    }
    @keyframes drift{ 0%{transform:translateY(-2%) scale(1);} 100%{transform:translateY(2%) scale(1.04);} }

    a{color:var(--cyn); text-decoration:none}
    a:hover{opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(1.2);
      background:linear-gradient(180deg, rgba(6,7,19,.88), rgba(6,7,19,.52));
      border-bottom:1px solid var(--border);
      box-shadow:var(--glow-cyn);
    }
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:12px;font-family:"Space Grotesk",Inter}
    .brand i{font-size:22px;color:var(--cyn);filter:drop-shadow(0 0 8px rgba(0,234,255,.6))}
    .brand .text{font-weight:800;letter-spacing:.6px}
    .ribbon{
      display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        linear-gradient(90deg, rgba(255,183,74,.20), rgba(255,217,138,.12));
      border:1px solid rgba(255,217,138,.25);
      color:#ffeac0; box-shadow:0 0 0 1px rgba(255,183,74,.15);
    }
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--muted);font-size:13px;box-shadow:0 0 0 1px rgba(147,51,255,.15), var(--glow-vio)}
    .btn{
      border:1px solid var(--border);color:var(--txt);
      background:
        linear-gradient(90deg, rgba(0,234,255,.18), rgba(255,59,255,.18));
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center;
      box-shadow:var(--glow-cyn);transition:transform .2s, box-shadow .2s
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--glow-pnk)}
    .btn-ghost{background:transparent}

    .grid-hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:20px}
    @media (max-width:1100px){ .grid-hero{grid-template-columns:1fr} }
    .card{
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); padding:24px; box-shadow:var(--glow-cyn);
      overflow:hidden;
    }
    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
      background:linear-gradient(120deg, rgba(255,255,255,.06), transparent 35%, rgba(255,255,255,.07) 50%, transparent 65%);
      transform:translateX(-30%); transition:transform .9s ease;
    }
    .card:hover::after{ transform:translateX(0%) }

    h1{margin:0 0 10px;font-family:"Space Grotesk";font-size:36px; letter-spacing:.2px}
    .grad{background:linear-gradient(90deg,var(--cyn),var(--pnk));-webkit-background-clip:text;background-clip:text;color:transparent}
    p{color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .stat{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);display:flex;gap:10px;align-items:center}
    .stat i{color:var(--cyn);text-shadow:0 0 10px rgba(0,234,255,.7)}

    .ring{--p:0;--size:90px;width:var(--size);height:var(--size);border-radius:50%;background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--cyn) var(--p), #202442 0);position:relative}
    .ring::before{content:attr(data-label);position:absolute;inset:8px;border-radius:50%;display:grid;place-items:center;color:#a8f9ff;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}

    .grid-main{display:grid;grid-template-columns:300px 1fr 320px;gap:18px;margin-top:18px}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }

    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;font-weight:800;background:
      radial-gradient(circle at 30% 30%, #fff3, #0000 40%),
      linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .addr{font-family:ui-monospace,monospace;color:var(--muted);font-size:13px}
    .menu{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .menu button{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.03);color:var(--txt);text-align:left;cursor:pointer;display:flex;gap:10px;align-items:center}
    .menu button.active{box-shadow:var(--glow-pnk)}
    .badge{margin-left:auto;background:linear-gradient(90deg,var(--pnk),var(--vio));padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}

    .acc{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04)}
    .acc + .acc{margin-top:12px}
    .acc-sum{display:flex;justify-content:space-between;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
    .acc-sum .left{display:flex;gap:12px;align-items:center}
    .num{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .acc-body{display:none;padding:0 16px 16px}
    .acc.open .acc-body{display:block}
    .callout{border-left:3px solid var(--cyn);background:rgba(0,234,255,.08);padding:12px;border-radius:0 12px 12px 0;margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .code{
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#a5ffcf;
      background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.25));
      border:1px solid rgba(0,255,149,.25); border-radius:10px; padding:10px; box-shadow:0 0 12px rgba(0,255,149,.1);
      overflow:auto
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .btn-mark{background:linear-gradient(90deg,var(--cyn),var(--pnk));border:0;color:#06101a;border-radius:10px;padding:10px 14px;font-weight:800}

    .cert-img{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--glow-vio);max-height:320px;height:320px;background:#0b0f1c}
    .cert-img img{display:block;width:100%;height:100%;object-fit:contain;object-position:center;background:transparent}
    .cert-img .seal{ z-index:2; }
    [hidden]{ display:none !important; }

    .lock-wrap{ position:relative }
    .locked .lock-blur{ filter:blur(4px); pointer-events:none; user-select:none; }
    .lock-overlay{
      position:absolute; inset:0; display:none; place-items:center; text-align:center;
      background:linear-gradient(180deg, rgba(6,7,19,.78), rgba(6,7,19,.82));
      border:1px dashed rgba(255,217,138,.35); border-radius:var(--radius);
    }
    .locked .lock-overlay{ display:grid }

    .overlay-card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,217,138,.35); border-radius:16px;
      padding:16px; box-shadow:0 0 0 1px rgba(255,183,74,.15), 0 16px 50px rgba(0,0,0,.55);
      max-width:560px;
    }
    .overlay-card h3{ margin:6px 0 8px }
    .vip-input{display:flex; gap:8px; margin-top:8px;background:rgba(255,255,255,.05); border:1px solid rgba(255,217,138,.25);padding:8px; border-radius:12px;}
    .vip-input input{flex:1; background:transparent; border:0; color:var(--txt); outline:none;font-family:ui-monospace,Menlo,Consolas,monospace; letter-spacing:.6px;}
    .vip-btn{ background:linear-gradient(90deg,#FFB74A,#FFD98A); color:#17120B; font-weight:800 }

    .toast{position:fixed;right:16px;bottom:16px;z-index:60;padding:14px 16px;border:1px solid var(--border);border-left:4px solid var(--cyn);border-radius:14px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);display:flex;gap:10px;align-items:flex-start;box-shadow:var(--glow-cyn)}
    .toast .x{background:transparent;border:0;color:var(--muted);cursor:pointer}
    .toast.good{border-left-color:var(--lime)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--sun)}

    .topbar{ padding-top: env(safe-area-inset-top); }
    .toast{ right: max(16px, env(safe-area-inset-right)); bottom: max(16px, env(safe-area-inset-bottom)); max-width: min(92vw, 520px); touch-action: pan-y; }

    @media (max-width: 680px){
      .container{ padding:14px; }
      .topbar-inner{ padding:12px 14px; gap:10px; }
      .brand .text{ font-size:14px; letter-spacing:.4px; }
      .chip{ padding:6px 10px; font-size:12px }
      .btn{ padding:8px 12px; border-radius:10px; }
      h1{ font-size:28px; line-height:1.15; }
      .grid-hero{ gap:12px; margin-top:14px; }
      .card{ padding:16px; border-radius:14px; }
      .mini{ grid-template-columns:1fr; gap:10px; }
      .stat{ padding:10px; gap:8px }
      .ring{ --size:72px; }
      .grid-main{ grid-template-columns:1fr; gap:12px; margin-top:12px; }
      .menu button{ padding:10px; }
      .num{ width:32px; height:32px; }
      .acc-sum{ padding:12px; }
      .acc-body{ padding:0 12px 12px; }
      .two{ grid-template-columns:1fr; }
    }

    /* NEW: pretty Sources styling */
    .sources summary{cursor:pointer;user-select:none;font-weight:700;color:#a7c3ff}
    .sources{margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px;background:rgba(255,255,255,.04)}
    .sources ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i>
        <div class="text">KLY ACADEMY</div>
        <span class="ribbon"><i class="fa-solid fa-lock"></i> Private Cohort</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="chip-progress" class="chip"><i class="fa-solid fa-chart-simple"></i> <span id="chip-text">0/12 Complete</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <span id="pill-addr" class="chip" hidden><i class="fa-solid fa-user-astronaut"></i> <span id="addr-short">0x…</span></span>
        <button id="btn-about" class="btn btn-ghost" title="About Membership"><i class="fa-regular fa-gem"></i></button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <section class="grid-hero">
      <div class="card animate__animated animate__fadeInUp">
        <h1><span class="grad">Own</span> the Future of Finance</h1>
        <p>Invitation-only, action-first curriculum for sovereign builders. Complete the track and mint your on-chain credential.</p>
        <div class="mini">
          <div class="stat"><i class="fa-solid fa-shield-halved"></i><div><strong>Self-Custody</strong><br><small>Keys stay with you</small></div></div>
          <div class="stat"><i class="fa-solid fa-bolt"></i><div><strong>Action-based</strong><br><small>Do not just read</small></div></div>
          <div class="stat"><i class="fa-solid fa-certificate"></i><div><strong>Proof</strong><br><small>NFT certificate</small></div></div>
        </div>
      </div>
      <div class="card animate__animated animate__fadeInUp" style="--animate-delay:.06s">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Access Gate</h3>
          <div class="ring" id="ring" data-label="0%"></div>
        </div>
        <p class="muted">Unlock with <strong>≥ 100 KLY</strong> on <strong>BNB Chain</strong> <em>or</em> an <strong>Invite Code</strong>.</p>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-coins" style="color:var(--cyn)"></i>
          <div><div class="muted">Your KLY balance</div><strong id="kly-balance">—</strong></div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-network-wired" style="color:var(--pnk)"></i>
          <div><div class="muted">Network</div><strong id="net-name">Not connected</strong></div>
        </div>
        <div class="vip-input" style="margin-top:12px">
          <input id="invite-code" inputmode="latin" placeholder="Enter Invite Code (e.g., AURORA-777)" aria-label="Invite Code">
          <button id="btn-redeem" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <small class="muted">Codes are single-use per wallet. Keep yours private.</small>
      </div>
    </section>

    <!-- Main -->
    <section class="grid-main">
      <!-- Sidebar -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px">
          <h3 style="margin:0">Profile</h3>
          <button id="btn-disconnect" class="btn btn-ghost" hidden><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        </div>
        <div class="profile">
          <div class="avatar" id="avatar">KA</div>
          <div>
            <div style="font-weight:800">Learner</div>
            <div id="addr-full" class="addr">Not connected</div>
          </div>
        </div>

        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="muted" style="margin-bottom:8px">Beginner</div>
          <div id="menu-beginner" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Master</div>
          <div id="menu-master" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Right Knowledge</div>
          <div id="menu-right" class="menu"></div>
        </div>
      </aside>

      <!-- Lessons (locked until access) -->
      <main id="curriculum-wrap" class="card lock-wrap locked">
        <div class="lock-blur">
          <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; display:flex; align-items:center; gap:8px">
            <h3 style="margin:0">Curriculum</h3>
            <span class="chip" title="Members Only"><i class="fa-solid fa-lock"></i> Members Only</span>
          </div>
          <div id="accordion"></div>
        </div>
        <div class="lock-overlay">
          <div class="overlay-card">
            <h3 style="margin:0"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Exclusive Access</h3>
            <p class="muted" style="margin:6px 0 10px">Connect a wallet with ≥ 100 KLY or redeem your invite. Welcome to the inner circle.</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button id="btn-overlay-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
              <a href="#apply" id="btn-waitlist" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Request Invite</a>
            </div>
          </div>
        </div>
      </main>

      <!-- Certificate -->
      <aside class="card">
        <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; position:relative">
          <h3 style="margin:0">Certificate</h3>
        </div>
        <div class="cert-img">
          <span class="seal">Founder’s Seal</span>
          <img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="KLY Certificate">
        </div>
        <p class="muted">Finish all modules to mint your NFT certificate.</p>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin:10px 0 14px">
          <div>Progress</div><strong id="cert-progress">0 / 12</strong>
          <div>Status</div><strong id="cert-status">Locked</strong>
        </div>
        <button id="btn-mint" class="btn" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
        <div id="mint-status" class="muted" style="margin-top:10px"></div>
      </aside>
    </section>

    <footer class="container" style="opacity:.7; text-align:center; margin-top:20px">
      <small>© <span id="year"></span> KLY Academy • Private Cohort</small>
    </footer>
  </div>

  <!-- About Membership Modal -->
  <div id="modal" class="topbar" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(6,7,19,.85); backdrop-filter:blur(10px)">
    <div class="container" style="max-width:820px; margin-top:60px">
      <div class="card" style="position:relative">
        <button id="modal-close" class="btn btn-ghost" style="position:absolute; top:10px; right:10px"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin:0 0 6px"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Membership</h3>
        <p class="muted">This is a private cohort. Access requires a qualifying on-chain balance or an invite code issued by the team. Invitations are non-transferable and bound to your wallet.</p>
        <div class="vip-input" style="margin-top:10px">
          <input id="invite-code-2" placeholder="Enter Invite Code" aria-label="Invite Code">
          <button id="btn-redeem-2" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <button id="btn-modal-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
          <a href="#apply" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Join Waitlist</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden>
    <i id="toast-icon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toast-title" style="font-weight:800;margin-bottom:4px">Info</div>
      <div id="toast-msg" class="muted">Message</div>
    </div>
    <button class="x" onclick="hideToast()"><i class="fa-solid fa-xmark"></i></button>
  </div>

<script>
/* ==============================
   CONFIG
============================== */
const KLY_TOKEN_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const NFT_CONTRACT_ADDRESS = "0xc1a2E9A475779EfD04247EA473638717E26cd5C5";
const KLY_TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const NFT_CONTRACT_ABI = [
  "function mintTo(address to, string uri) public"
];

// === Certificate scope toggle ===
// true  -> RK modules count toward certificate
// false -> RK modules are extra (don’t block mint)
const INCLUDE_RK_IN_CERT = true;

let TOTAL_MODULES = 12; // will be overridden by UI updates
const BSC = { idDec:56, idHex:"0x38", name:"BNB Smart Chain", rpc:"https://bsc-dataseed.binance.org/" };

/* Invite codes (client-side demo). Replace with your backend/allowlist when ready. */
const INVITES = new Set(["AURORA-777","AURORA-888","KLY-ALPHA","NEON-PRIME"]);

/* ==============================
   STATE
============================== */
let web3Modal, provider, signer, account = null, walletInstance=null;
let completed = JSON.parse(localStorage.getItem("kly_completed_neon") || "[]");
let opened = null;
let inviteUnlocked = localStorage.getItem("kly_invite_unlocked")==="1";

/* ==============================
   DOM
============================== */
const el = (id)=>document.getElementById(id);
const btnConnect   = el("btn-connect");
const btnDisconnect= el("btn-disconnect");
const btnAbout     = el("btn-about");
const modal        = el("modal");
const modalClose   = el("modal-close");
const btnModalConn = el("btn-modal-connect");

const pillAddr  = el("pill-addr");
const addrShort = el("addr-short");
const addrFull  = el("addr-full");
const avatar    = el("avatar");
const ring      = el("ring");
const klyBalanceEl = el("kly-balance");
const netNameEl = el("net-name");
const chipText  = el("chip-text");
const certProgress = el("cert-progress");
const certStatus   = el("cert-status");
const btnMint   = el("btn-mint");
const mintStatus= el("mint-status");

const toast = el("toast"), toastIcon = el("toast-icon"), toastTitle = el("toast-title"), toastMsg = el("toast-msg");

const inviteInput  = el("invite-code");
const inviteInput2 = el("invite-code-2");
const btnRedeem    = el("btn-redeem");
const btnRedeem2   = el("btn-redeem-2");
const btnOverlayConnect = el("btn-overlay-connect");

const curriculumWrap = el("curriculum-wrap");

/* ==============================
   LESSON CONTENT
============================== */
const M = (id, level, num, title, sections) => ({id, level, num, title, sections});

const modules = [
  /* ====== BEGINNER ====== */
  M("module1","Beginner",1,"DeFi Basics",[ /* ...unchanged content... */ 
    {label:"What You’ll Learn", html:`<ul><li>What decentralized finance is <em>and isn’t</em>.</li><li>How blockchains, smart contracts, DAOs, and dApps fit together.</li><li>Why self-custody flips the incentives.</li></ul>`},
    {label:"DeFi Map (30s Overview)", html:`<div class="two"><div class="callout"><strong>Users</strong> ↔ <strong>dApps</strong> ↔ <strong>Smart Contracts</strong> on a <strong>Blockchain</strong><br>Money Legos = contracts that compose (DEX ↔ lending ↔ vaults).</div><div class="callout"><strong>Key Properties</strong><br>Permissionless, transparent, programmable, global 24/7 settlement.</div></div>`},
    {label:"Core Definitions", html:`<ul><li><strong>Blockchain:</strong> append-only ledger secured by consensus.</li><li><strong>Smart Contract:</strong> code that holds assets & enforces rules.</li><li><strong>dApp:</strong> interface that calls contract functions.</li><li><strong>DAO:</strong> on-chain governance using tokens/votes.</li><li><strong>Self-custody:</strong> you control the private key → you control funds.</li></ul>`},
    {label:"How a Transaction Flows", html:`<ol><li>You sign a message with your wallet (private key).</li><li>The tx hits nodes/mempool → validators order it into a block.</li><li>Contract code executes (e.g., swap, lend) → state updates.</li><li>Finality: after X blocks, reversal becomes economically infeasible.</li></ol>`},
    {label:"Pitfalls to Avoid", html:`<ul><li><strong>UI ≠ contract:</strong> bookmarks can be faked; verify contract address.</li><li><strong>Approvals:</strong> “infinite allowance” can let contracts move tokens later.</li><li><strong>Impersonation:</strong> fake support, fake airdrops, DM scams.</li></ul>`},
    {label:"Hands-On", html:`<ol><li>Open <a target="_blank" rel="noopener" href="https://bscscan.com/">BscScan</a> and paste your wallet address → identify tokens & approvals.</li><li>Write a one-sentence DeFi definition a friend would understand.</li><li>List 3 differences between bank transfer vs DEX swap (custody, speed, transparency).</li></ol>`},
    {label:"Mini-Quiz", html:`<details><summary>Which part actually holds your funds?</summary><p><strong>The smart contract or your wallet</strong> (via your private key). The UI never “holds” funds.</p></details><details><summary>Why is composability powerful?</summary><p>Contracts can chain together like “money legos,” enabling new products without permission.</p></details>`},
    {label:"Resources", html:`<ul><li><a target="_blank" rel="noopener" href="https://ethereum.org/en/defi/">ethereum.org/defi</a></li><li><a target="_blank" rel="noopener" href="https://defillama.com/">DeFiLlama (TVL, chains, protocols)</a></li></ul>`}
  ]),
  M("module2","Beginner",2,"Wallet Setup",[ /* ...content from your last paste... */ ]),
  M("module3","Beginner",3,"Using DEXs",[ /* ...content from your last paste... */ ]),
  M("module4","Beginner",4,"Earning with DeFi",[ /* ...content from your last paste... */ ]),
  M("module5","Beginner",5,"Safety & Strategy",[ /* ...content from your last paste... */ ]),

  /* ====== MASTER ====== */
  M("mdf-1","Master",1,"Sovereign Mindset",[ /* ...content from your last paste... */ ]),
  M("mdf-2","Master",2,"Blockchain & Tokenomics",[ /* ... */ ]),
  M("mdf-3","Master",3,"Wealth via Ecosystems",[ /* ... */ ]),
  M("mdf-4","Master",4,"DeFi Mastery",[ /* ... */ ]),
  M("mdf-5","Master",5,"NFTs as Wealth Vehicles",[ /* ... */ ]),
  M("mdf-6","Master",6,"Multiple Web3 Income Streams",[ /* ... */ ]),
  M("mdf-7","Master",7,"Sovereign Wealth Strategy",[ /* ... */ ])
];

/* ===== RIGHT KNOWLEDGE — Wisdom-first Restructure ===== */
const RK = (num, title, sections)=> M(`rk-${num}`, "Right", num, title, sections);

// Remove any legacy RK modules if present
for(let i=modules.length-1;i>=0;i--){ if(String(modules[i].id).startsWith("rk-")) modules.splice(i,1); }

/* RK-1 */
modules.push(RK(1,"Epistemic OS: From Facts to Wisdom",[
  {label:"Facts (verified)", html:`<ul>
    <li><strong>Belief ≠ Knowledge:</strong> knowledge needs justification beyond belief (Gettier problem shows gaps).</li>
    <li><strong>Right Knowledge</strong> = empirical, logical, practical.</li>
    <li>Unproven claims stay in a <em>Pending File</em>.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li><a href="https://plato.stanford.edu/entries/knowledge-analysis/" target="_blank" rel="noopener">Stanford Encyclopedia: Knowledge</a></li>
    <li><a href="https://iep.utm.edu/gettier/" target="_blank" rel="noopener">IEP: Gettier</a></li>
  </ul>`},
  {label:"Wisdom Core", html:`<div class="callout"><strong>Rules:</strong> Verify → Label uncertainty → Track predictions.</div>`},
  {label:"Overstanding (5m)", html:`<ol><li>Pick one strong opinion; write its disconfirming evidence.</li><li>Classify: True / False / Pending (why?).</li></ol>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary><ul><li>Stanford Encyclopedia; IEP.</li></ul></details>`}
]));

/* RK-2 */
modules.push(RK(2,"Bioenergetics & Melanin (what science shows)",[
  {label:"Facts (verified)", html:`<ul>
    <li>Eumelanin: broadband UV–visible absorber; photoprotection via ultrafast nonradiative decay; radical scavenger.</li>
    <li>Protection limited (approx. SPF ~1.5–4); behavior still matters.</li>
  </ul>`},
  {label:"Evidence", html:`<ul>
    <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2671032/" target="_blank" rel="noopener">Brenner & Hearing 2008</a></li>
    <li><a href="https://www.mdpi.com/1420-3049/25/7/1537" target="_blank" rel="noopener">Solano 2020</a></li>
  </ul>`},
  {label:"Wisdom Core", html:`<ul><li>Prefer mechanism-level, peer-reviewed claims.</li></ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>Read one abstract and note: measure, method, limits.</li></ol>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary><ul><li>See above links.</li></ul></details>`}
]));

/* RK-3 */
modules.push(RK(3,"Time Systems & Historical Frames",[
  {label:"Facts (verified)", html:`<ul>
    <li>Gregorian reform (1582) fixed Julian drift; century leap years only if divisible by 400.</li>
    <li>Adoption staggered by country → mixed regimes for centuries.</li>
  </ul>`},
  {label:"Wisdom Core", html:`<ul><li>Calendars shape narratives; keep a personal chronology.</li></ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>Mark ancestors’ key dates and your nation’s Gregorian adoption.</li></ol>`}
]));

/* RK-4 */
modules.push(RK(4,"Language & Symbolic Power",[
  {label:"Facts (verified)", html:`<ul>
    <li>English “God” is Germanic (Proto-Germanic *gudą), not from “good.”</li>
    <li><em>mdw-nṯr</em> often glossed “divine words/speech”; semantics vary.</li>
  </ul>`},
  {label:"Wisdom Core", html:`<ul><li>Separate etymology (history) from doctrine (belief).</li></ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>Pick 2 sacred names; log etymology vs. modern meaning.</li></ol>`}
]));

/* RK-5 */
modules.push(RK(5,"Divine Purpose",[
  {label:"Facts (verified)", html:`<ul>
    <li>Purpose predicts better health behaviors and longevity (psychology literature).</li>
    <li>Purpose aligns with autonomy/competence/relatedness (SDT).</li>
  </ul>`},
  {label:"Wisdom Core", html:`<ul><li>Values → Purpose themes → Projects → If-then plans.</li></ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>“I build ___ for ___.” + one daily if-then.</li></ol>`}
]));

/* RK-6 */
modules.push(RK(6,"Source Hygiene & Contested Claims",[
  {label:"Facts (verified)", html:`<ul>
    <li>Dogon–Sirius B extraordinary claim not replicated (van Beek, 1991).</li>
  </ul>`},
  {label:"Wisdom Core", html:`<ul><li>Extraordinary claims need primary sources + replication.</li></ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>Pick a viral claim; find earliest primary source; label status.</li></ol>`}
]));

/* RK-7 */
modules.push(RK(7,"Sovereign Decision Frameworks",[
  {label:"Facts (verified)", html:`<ul>
    <li>Checklists reduce error in complex domains.</li>
    <li>Implementation intentions (if-then) increase follow-through.</li>
  </ul>`},
  {label:"Overstanding (5m)", html:`<ol><li>Create a 6-line approval checklist.</li></ol>`}
]));

/* BONUS */
modules.push(M("rk-bonus","Right",8,"⚡ Myths of Return & Cycles (label meaning vs. fact)",[
  {label:"Facts vs Narrative", html:`<ul><li><strong>Anunnaki</strong>: deities in Mesopotamian texts; modern “ancient aliens” interpretations are not scholarly consensus.</li></ul>`},
  {label:"Wisdom Core", html:`<p>Value mythic meaning while clearly labeling empirical status.</p>`}
]));

/* ==============================
   RENDER MENUS + ACCORDION
============================== */
function menuBtn(m){
  const b = document.createElement("button");
  b.id = `menu-${m.id}`;
  const badge = (m.level==='Beginner') ? m.num : (m.level==='Master' ? ('M'+m.num) : ('RK'+m.num));
  b.innerHTML = `<i class="fa-solid ${m.level==='Beginner'?'fa-book-open': (m.level==='Master'?'fa-crown':'fa-scroll') }"></i> ${m.title} <span class="badge">${badge}</span>`;
  b.onclick = ()=>openModule(m.id, true);
  return b;
}
function renderMenus(){
  const beg = document.getElementById("menu-beginner");
  const mst = document.getElementById("menu-master");
  const rgt = document.getElementById("menu-right");
  beg.innerHTML=""; mst.innerHTML=""; if(rgt) rgt.innerHTML="";
  modules.filter(x=>x.level==="Beginner").forEach(m=>beg.appendChild(menuBtn(m)));
  modules.filter(x=>x.level==="Master").forEach(m=>mst.appendChild(menuBtn(m)));
  if(rgt){ modules.filter(x=>x.level==="Right").forEach(m=>rgt.appendChild(menuBtn(m))); }
}
function renderAccordion(){
  const elA = document.getElementById("accordion");
  elA.innerHTML = "";
  modules.forEach(m=>{
    const acc = document.createElement("div");
    acc.className = "acc"; acc.id = `acc-${m.id}`;
    const done = completed.includes(m.id);
    // FIX: proper badge per level (Beginner #, Master M#, Right RK#)
    const badgeText = (m.level==='Beginner') ? m.num : (m.level==='Master' ? ('M'+m.num) : ('RK'+m.num));

    const sectionsHTML = (m.sections||[]).map(s=>`
      <section style="margin-top:12px">
        <h4 style="margin:6px 0 8px;color:#a7c3ff"><i class="fa-solid fa-sparkles" style="color:var(--cyn)"></i> ${s.label}</h4>
        ${s.html||""}
      </section>
    `).join("");

    acc.innerHTML = `
      <div class="acc-sum" role="button" aria-expanded="false">
        <div class="left">
          <div class="num">${badgeText}</div>
          <div>
            <div style="font-weight:800">${m.title}</div>
            <small class="muted">${m.level}</small>
          </div>
          ${done?`<span class="pill" style="border-color:rgba(0,255,149,.35);color:#a5ffcf"><i class="fa-solid fa-circle-check"></i> Completed</span>`:""}
        </div>
        <div><button class="btn btn-ghost"><i class="fa-solid fa-chevron-down"></i></button></div>
      </div>
      <div class="acc-body">
        ${sectionsHTML}
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-mark" onclick="markComplete('${m.id}')"><i class="fa-solid fa-check"></i> Mark Complete</button>
          <span class="pill"><i class="fa-solid fa-clock"></i> ~12–20 min</span>
          <span class="pill"><i class="fa-solid fa-signal"></i> ${m.level}</span>
        </div>
      </div>
    `;
    acc.querySelector(".acc-sum").onclick = ()=>openModule(m.id, false);
    elA.appendChild(acc);
  });
}
function openModule(id, fromMenu){
  const acc = document.getElementById(`acc-${id}`);
  if(!acc) return;
  const isOpen = acc.classList.contains("open");
  document.querySelectorAll(".acc").forEach(a=>{ a.classList.remove("open"); a.querySelector(".acc-sum").setAttribute("aria-expanded","false"); });
  if(!isOpen){ acc.classList.add("open"); acc.querySelector(".acc-sum").setAttribute("aria-expanded","true"); opened = id; }
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  const btn = document.getElementById(`menu-${id}`); if(btn) btn.classList.add("active");
  if(fromMenu) acc.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ==============================
   PROGRESS (counts with toggle)
============================== */
function markComplete(id){
  if(!completed.includes(id)){ completed.push(id); localStorage.setItem("kly_completed_neon", JSON.stringify(completed)); }
  notify("Saved","Module marked complete","good","fa-circle-check");
  renderAccordion(); updateProgress();
  if(typeof confetti==="function"){ confetti({particleCount:90, spread:60, origin:{y:.8}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
}
function updateProgress(){
  // which modules count toward certificate?
  const eligible = modules.filter(m => INCLUDE_RK_IN_CERT ? true : (m.level !== "Right"));

  const uniqueDone = [...new Set(completed)].filter(id => eligible.some(m => m.id === id));
  const done = uniqueDone.length;
  const total = eligible.length;

  // keep the global TOTAL_MODULES for other UI, but progress uses "eligible"
  TOTAL_MODULES = modules.length;

  const pct = total ? Math.min(100, Math.round(done/total*100)) : 0;
  chipText.textContent = `${done}/${total} Complete`;
  certProgress.textContent = `${done} / ${total}`;
  ring.style.setProperty("--p", pct + "%"); ring.setAttribute("data-label", pct + "%");
  if(done >= total){ certStatus.textContent = "Ready to Mint"; btnMint.disabled = false; }
  else { certStatus.textContent = "Locked"; btnMint.disabled = true; }
}

/* ==============================
   TOAST
============================== */
function notify(title, msg, kind="info", icon="fa-circle-info"){
  const safeTitle = (title && String(title).trim()) || "Notice";
  const safeMsg   = (msg   && String(msg).trim())   || "All set.";
  toastTitle.textContent = safeTitle;
  toastMsg.textContent   = safeMsg;
  toastIcon.className = `fa-solid ${icon || "fa-circle-info"}`;
  toast.classList.remove("good","bad","warn");
  if(kind==="good") toast.classList.add("good");
  else if(kind==="bad") toast.classList.add("bad");
  else if(kind==="warn") toast.classList.add("warn");
  toast.hidden = false;
  if(notify._timer){ clearTimeout(notify._timer); notify._timer=null; }
  if(notify._raf){ cancelAnimationFrame(notify._raf); notify._raf=null; }
  notify._timer = setTimeout(hideToast, 4200);
  const start = performance.now();
  function loop(t){ if(t - start > 4500){ hideToast(); return; } notify._raf = requestAnimationFrame(loop); }
  notify._raf = requestAnimationFrame(loop);
}
function hideToast(){
  if(notify._timer){ clearTimeout(notify._timer); notify._timer=null; }
  if(notify._raf){ cancelAnimationFrame(notify._raf); notify._raf=null; }
  toast.hidden = true;
}

/* ==============================
   WEB3
============================== */
async function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { [BSC.idDec]: BSC.rpc }, chainId: BSC.idDec }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:"dark" });
}
function setConnectUI(state){
  if(state === 'connecting'){
    btnConnect.disabled = true; btnConnect.hidden = false;
    btnConnect.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connecting…';
  }else if(state === 'connected'){
    btnConnect.disabled = false; btnConnect.hidden = true; btnDisconnect.hidden = false; pillAddr.hidden = false;
    btnConnect.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
  }else{
    btnConnect.disabled = false; btnConnect.hidden = false; btnDisconnect.hidden = true; pillAddr.hidden = true;
    btnConnect.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
  }
}
function notifyAuto(title, msg, kind="info", icon="fa-circle-info"){
  notify(title, msg, kind, icon);
  clearTimeout(notifyAuto._t);
  notifyAuto._t = setTimeout(()=>hideToast(), 4200);
}
async function connect(){
  setConnectUI('connecting');
  try{
    walletInstance = await web3Modal.connect();
    walletInstance.removeAllListeners?.();
    provider = new ethers.providers.Web3Provider(walletInstance, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();

    const net = await provider.getNetwork().catch(()=>({ chainId: 0 }));
    if(net.chainId !== BSC.idDec){
      try{
        await walletInstance.request({ method:"wallet_switchEthereumChain", params:[{ chainId:BSC.idHex }] });
      }catch(e){
        if(e?.code === 4902){
          await walletInstance.request({ method:"wallet_addEthereumChain", params:[{
            chainId:BSC.idHex, chainName:BSC.name,
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls:[BSC.rpc], blockExplorerUrls:["https://bscscan.com"]
          }] });
        }else{ throw e; }
      }
      provider = new ethers.providers.Web3Provider(walletInstance, "any");
      signer = provider.getSigner();
      account = await signer.getAddress();
    }

    walletInstance.on?.("accountsChanged", async (accs)=>{
      if(!accs?.length) return disconnect();
      account = accs[0];
      await afterConnect();
    });
    walletInstance.on?.("chainChanged", async ()=>{
      provider = new ethers.providers.Web3Provider(walletInstance, "any");
      signer   = provider.getSigner();
      account  = await signer.getAddress().catch(()=>account);
      await afterConnect();
    });
    walletInstance.on?.("disconnect", ()=> disconnect());

    await afterConnect();
    setConnectUI('connected');
  }catch(err){
    console.error('[connect] failed:', err);
    notifyAuto("Connection Failed", err?.message || "User rejected", "bad", "fa-circle-xmark");
    setConnectUI('idle');
  }
}
async function afterConnect(){
  try{
    if(!provider || !signer || !account) throw new Error('Missing provider/signer/account');
    const short = `${account.slice(0,6)}…${account.slice(-4)}`;
    addrShort.textContent = short;
    addrFull.textContent  = account;
    avatar.textContent    = account.slice(2,4).toUpperCase();
    netNameEl.textContent = BSC.name;

    const kly = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const [raw, dec] = await Promise.all([kly.balanceOf(account), kly.decimals().catch(()=>18)]);
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    klyBalanceEl.textContent = `${bal.toLocaleString(undefined,{ maximumFractionDigits: 4 })} KLY`;

    const p = Math.min(100, Math.round((Math.min(bal, 100) / 100) * 100));
    ring.style.setProperty("--p", p + "%");
    ring.setAttribute("data-label", p + "%");

    updateAccessState(bal);
    updateProgress();
  }catch(e){
    console.error('[afterConnect] error:', e);
    notifyAuto("Read Error","Could not read KLY balance.","bad","fa-bug");
  }
}
async function disconnect(){
  try{ await walletInstance?.disconnect?.(); }catch{}
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  walletInstance = null;
  provider = signer = account = null;

  addrFull.textContent = "Not connected";
  avatar.textContent   = "KA";
  netNameEl.textContent= "Not connected";
  klyBalanceEl.textContent = "—";
  ring.style.setProperty("--p", "0%");
  ring.setAttribute("data-label", "0%");
  setConnectUI('idle');
  updateAccessState(0);
  notifyAuto("Disconnected","Wallet disconnected","good","fa-right-from-bracket");
}

/* ==============================
   ACCESS
============================== */
function hasTokenAccess(bal){ return bal >= 100; }
function hasInviteAccess(){ return inviteUnlocked === true; }
function updateAccessState(balanceNum){
  const access = hasTokenAccess(balanceNum) || hasInviteAccess();
  curriculumWrap.classList.toggle('locked', !access);
  if(access){ notifyAuto("Welcome","Access granted. Enjoy the course.","good","fa-unlock"); }
}

/* ==============================
   INVITES
============================== */
function redeemInvite(codeRaw){
  const code = (codeRaw||"").trim().toUpperCase();
  if(!code){ notify("Missing Code","Enter your invite code.","warn","fa-key"); return; }
  if(!INVITES.has(code)){ notify("Invalid Code","Please check your invite.","bad","fa-circle-xmark"); return; }
  inviteUnlocked = true;
  localStorage.setItem("kly_invite_unlocked","1");
  INVITES.delete(code);
  notify("Invite Accepted","Your membership has been activated.","good","fa-gem");
  curriculumWrap.classList.remove('locked');
  if(typeof confetti==="function"){ confetti({particleCount:120, spread:70, origin:{y:.7}, colors:["#FFD98A","#00eaff","#ff3bff"]}); }
}

/* ==============================
   MINT
============================== */
async function mint(){
  if(!signer) return notify("Connect Wallet","Please connect your wallet first.","warn","fa-wallet");
  // require completion of all "eligible" modules (respect toggle)
  const eligible = modules.filter(m => INCLUDE_RK_IN_CERT ? true : (m.level !== "Right"));
  const doneEligible = new Set(completed.filter(id => eligible.some(m=>m.id===id)));
  if(doneEligible.size < eligible.length) return notify("Finish Modules","Complete all required modules first.","warn","fa-list-check");

  try{
    btnMint.disabled=true; btnMint.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Minting…';
    const to = await signer.getAddress();
    const nft = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
    const tokenURI = "ipfs://bafybeihkmkaf2mgx7xkrnkhmzd2uvhr6ddgj6z3vkqcgnvlaa3z7x263r4";
    let gas = await nft.estimateGas.mintTo(to, tokenURI).catch(()=>null);
    if(!gas){ notify("Gas Estimation Failed","Are you authorized to mint?","bad","fa-engine-warning"); btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate'; return; }
    const tx = await nft.mintTo(to, tokenURI, { gasLimit: gas.mul(120).div(100) });
    mintStatus.innerHTML = `Tx submitted: <a target="_blank" rel="noopener" href="https://bscscan.com/tx/${tx.hash}">view on BscScan</a>`;
    await tx.wait();
    notify("Minted","Certificate minted successfully!","good","fa-certificate");
    btnMint.innerHTML = '<i class="fa-solid fa-circle-check"></i> Minted';
    if(typeof confetti==="function"){ confetti({particleCount:160, spread:70, origin:{y:.7}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
  }catch(e){
    notify("Mint Failed", e?.message || "Unknown error", "bad", "fa-circle-xmark");
    btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate';
  }
}

/* ==============================
   INIT
============================== */
function initUI(){
  renderMenus(); renderAccordion(); updateProgress();
  if(modules[0]) openModule(modules[0].id, false);
  const year = new Date().getFullYear(); el("year").textContent = year;
}
btnConnect.addEventListener("click", connect);
btnDisconnect.addEventListener("click", disconnect);
btnMint.addEventListener("click", mint);
document.getElementById("btn-overlay-connect").addEventListener("click", connect);

btnRedeem.addEventListener("click", ()=> redeemInvite(inviteInput.value));
btnRedeem2.addEventListener("click", ()=> redeemInvite(inviteInput2.value));

btnAbout.addEventListener("click", ()=> modal.style.display="block");
modalClose.addEventListener("click", ()=> modal.style.display="none");
btnModalConn.addEventListener("click", ()=> connect());

window.addEventListener("beforeunload", ()=>{ if(opened) localStorage.setItem("kly_open_neon", opened); });

window.addEventListener("load", async ()=>{
  initUI();
  await initWeb3Modal();
  if(inviteUnlocked){ curriculumWrap.classList.remove('locked'); }
  if(window.Web3Modal && web3Modal.cachedProvider){ try{ await connect(); }catch{} }
});
</script>
</body>
</html>
