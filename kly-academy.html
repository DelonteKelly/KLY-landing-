<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#060713"/>
  <title>KLY Academy — DeFi Neon • Private</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Motion & FX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Web3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      /* Neon + Gold palette (exclusive) */
      --bg:#060713; --bg2:#0a0c1f;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --border:rgba(132,255,255,.18);
      --txt:#E9EEFF; --muted:#B9C3E5;
      --cyn:#00eaff; --pnk:#ff3bff; --vio:#9333ff; --sun:#ffb300; --lime:#00ff95;
      --gold:#FFD98A; --gold2:#FFB74A;
      --danger:#ff3d3d;

      --glow-cyn:0 0 24px rgba(0,234,255,.35);
      --glow-pnk:0 0 24px rgba(255,59,255,.35);
      --glow-vio:0 0 24px rgba(147,51,255,.35);

      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--txt);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1100px 700px at 12% -8%, rgba(0,234,255,.10), transparent 60%),
        radial-gradient(900px 600px at 100% -10%, rgba(255,59,255,.10), transparent 60%),
        linear-gradient(180deg,#050611, #0a0c1f 60%, #07081a);
      overflow-x:hidden;
    }

    /* Subtle aurora + grain overlay for exclusivity */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        radial-gradient(50% 35% at 70% -10%, rgba(255,217,138,.15), transparent 60%),
        conic-gradient(from 230deg at 20% 10%, rgba(0,234,255,.08), transparent 45%);
      filter: blur(18px);
      animation: drift 18s ease-in-out infinite alternate;
    }
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='table' tableValues='0 0 0 .08 0'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity:.7; mix-blend-mode:overlay;
    }
    @keyframes drift{
      0%{ transform:translateY(-2%) scale(1); }
      100%{ transform:translateY(2%) scale(1.04); }
    }

    a{color:var(--cyn); text-decoration:none}
    a:hover{opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(1.2);
      background:linear-gradient(180deg, rgba(6,7,19,.88), rgba(6,7,19,.52));
      border-bottom:1px solid var(--border);
      box-shadow:var(--glow-cyn);
    }
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:12px;font-family:"Space Grotesk",Inter}
    .brand i{font-size:22px;color:var(--cyn);filter:drop-shadow(0 0 8px rgba(0,234,255,.6))}
    .brand .text{font-weight:800;letter-spacing:.6px}
    .ribbon{
      display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        linear-gradient(90deg, rgba(255,183,74,.20), rgba(255,217,138,.12));
      border:1px solid rgba(255,217,138,.25);
      color:#ffeac0; box-shadow:0 0 0 1px rgba(255,183,74,.15);
    }
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--muted);font-size:13px;box-shadow:0 0 0 1px rgba(147,51,255,.15), var(--glow-vio)}
    .btn{
      border:1px solid var(--border);color:var(--txt);
      background:
        linear-gradient(90deg, rgba(0,234,255,.18), rgba(255,59,255,.18));
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center;
      box-shadow:var(--glow-cyn);transition:transform .2s, box-shadow .2s
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--glow-pnk)}
    .btn-ghost{background:transparent}

    /* Hero */
    .grid-hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:20px}
    @media (max-width:1100px){ .grid-hero{grid-template-columns:1fr} }
    .card{
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); padding:24px; box-shadow:var(--glow-cyn);
      overflow:hidden;
    }
    /* premium card sheen */
    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
      background:linear-gradient(120deg, rgba(255,255,255,.06), transparent 35%, rgba(255,255,255,.07) 50%, transparent 65%);
      transform:translateX(-30%); transition:transform .9s ease;
    }
    .card:hover::after{ transform:translateX(0%) }

    h1{margin:0 0 10px;font-family:"Space Grotesk";font-size:36px; letter-spacing:.2px}
    .grad{background:linear-gradient(90deg,var(--cyn),var(--pnk));-webkit-background-clip:text;background-clip:text;color:transparent}
    p{color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .stat{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);display:flex;gap:10px;align-items:center}
    .stat i{color:var(--cyn);text-shadow:0 0 10px rgba(0,234,255,.7)}

    /* KPI ring */
    .ring{--p:0;--size:90px;width:var(--size);height:var(--size);border-radius:50%;background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--cyn) var(--p), #202442 0);position:relative}
    .ring::before{content:attr(data-label);position:absolute;inset:8px;border-radius:50%;display:grid;place-items:center;color:#a8f9ff;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}

    /* Main grid */
    .grid-main{display:grid;grid-template-columns:300px 1fr 320px;gap:18px;margin-top:18px}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }

    /* Sidebar */
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;font-weight:800;background:
      radial-gradient(circle at 30% 30%, #fff3, #0000 40%),
      linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .addr{font-family:ui-monospace,monospace;color:var(--muted);font-size:13px}
    .menu{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .menu button{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.03);color:var(--txt);text-align:left;cursor:pointer;display:flex;gap:10px;align-items:center}
    .menu button.active{box-shadow:var(--glow-pnk)}
    .badge{margin-left:auto;background:linear-gradient(90deg,var(--pnk),var(--vio));padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}

    /* Lessons */
    .acc{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04)}
    .acc + .acc{margin-top:12px}
    .acc-sum{display:flex;justify-content:space-between;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
    .acc-sum .left{display:flex;gap:12px;align-items:center}
    .num{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .acc-body{display:none;padding:0 16px 16px}
    .acc.open .acc-body{display:block}
    .callout{border-left:3px solid var(--cyn);background:rgba(0,234,255,.08);padding:12px;border-radius:0 12px 12px 0;margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .code{
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#a5ffcf;
      background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.25));
      border:1px solid rgba(0,255,149,.25); border-radius:10px; padding:10px; box-shadow:0 0 12px rgba(0,255,149,.1);
      overflow:auto
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .btn-mark{background:linear-gradient(90deg,var(--cyn),var(--pnk));border:0;color:#06101a;border-radius:10px;padding:10px 14px;font-weight:800}

/* --- Certificate sizing: make the NFT fit cleanly --- */
.cert-img{
  position:relative;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--glow-vio);

  /* choose ONE of the two approaches below */

  /* A) Fixed visual height (good for sidebars) */
  max-height: 320px;         /* tweak to your taste */
  height: 320px;
  background: #0b0f1c;       /* subtle frame behind transparent PNGs */

  /* B) Or: aspect-ratio based (comment A out, uncomment below) */
  /* aspect-ratio: 4 / 3;   */
}

.cert-img img{
  display:block;
  width:100%;
  height:100%;
  object-fit: contain;        /* show the whole artwork, no crop */
  object-position: center;
  background: transparent;    /* PNG edges look clean */
}

/* optional: keep the "Founder’s Seal" above the image always */
.cert-img .seal{ z-index:2; }

/* make the HTML hidden attribute actually hide elements */
[hidden]{ display:none !important; }

    /* Members-only blur overlay */
    .lock-wrap{ position:relative }
    .locked .lock-blur{ filter:blur(4px); pointer-events:none; user-select:none; }
    .lock-overlay{
      position:absolute; inset:0; display:none; place-items:center; text-align:center;
      background:linear-gradient(180deg, rgba(6,7,19,.78), rgba(6,7,19,.82));
      border:1px dashed rgba(255,217,138,.35); border-radius:var(--radius);
    }
    .locked .lock-overlay{ display:grid }

    .overlay-card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,217,138,.35); border-radius:16px;
      padding:16px; box-shadow:0 0 0 1px rgba(255,183,74,.15), 0 16px 50px rgba(0,0,0,.55);
      max-width:560px;
    }
    .overlay-card h3{ margin:6px 0 8px }
    .vip-input{
      display:flex; gap:8px; margin-top:8px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,217,138,.25);
      padding:8px; border-radius:12px;
    }
    .vip-input input{
      flex:1; background:transparent; border:0; color:var(--txt); outline:none;
      font-family:ui-monospace,Menlo,Consolas,monospace; letter-spacing:.6px;
    }
    .vip-btn{ background:linear-gradient(90deg,#FFB74A,#FFD98A); color:#17120B; font-weight:800 }

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:60;padding:14px 16px;border:1px solid var(--border);border-left:4px solid var(--cyn);border-radius:14px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);display:flex;gap:10px;align-items:flex-start;box-shadow:var(--glow-cyn)}
    .toast .x{background:transparent;border:0;color:var(--muted);cursor:pointer}
    .toast.good{border-left-color:var(--lime)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--sun)}

    /* Mobile polish + safe-area */
    .topbar{ padding-top: env(safe-area-inset-top); }
    .toast{
      right: max(16px, env(safe-area-inset-right));
      bottom: max(16px, env(safe-area-inset-bottom));
      max-width: min(92vw, 520px);
      touch-action: pan-y;
    }
    @media (max-width: 680px){
      .container{ padding:14px; }
      .topbar-inner{ padding:12px 14px; gap:10px; }
      .brand .text{ font-size:14px; letter-spacing:.4px; }
      .chip{ padding:6px 10px; font-size:12px }
      .btn{ padding:8px 12px; border-radius:10px; }
      h1{ font-size:28px; line-height:1.15; }
      .grid-hero{ gap:12px; margin-top:14px; }
      .card{ padding:16px; border-radius:14px; }
      .mini{ grid-template-columns:1fr; gap:10px; }
      .stat{ padding:10px; gap:8px }
      .ring{ --size:72px; }
      .grid-main{ grid-template-columns:1fr; gap:12px; margin-top:12px; }
      .menu button{ padding:10px; }
      .num{ width:32px; height:32px; }
      .acc-sum{ padding:12px; }
      .acc-body{ padding:0 12px 12px; }
      .two{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i>
        <div class="text">KLY ACADEMY</div>
        <span class="ribbon"><i class="fa-solid fa-lock"></i> Private Cohort</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="chip-progress" class="chip"><i class="fa-solid fa-chart-simple"></i> <span id="chip-text">0/12 Complete</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <span id="pill-addr" class="chip" hidden><i class="fa-solid fa-user-astronaut"></i> <span id="addr-short">0x…</span></span>
        <button id="btn-about" class="btn btn-ghost" title="About Membership"><i class="fa-regular fa-gem"></i></button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <section class="grid-hero">
      <div class="card animate__animated animate__fadeInUp">
        <h1><span class="grad">Own</span> the Future of Finance</h1>
        <p>Invitation-only, action-first curriculum for sovereign builders. Complete the track and mint your on-chain credential.</p>
        <div class="mini">
          <div class="stat"><i class="fa-solid fa-shield-halved"></i><div><strong>Self-Custody</strong><br><small>Keys stay with you</small></div></div>
          <div class="stat"><i class="fa-solid fa-bolt"></i><div><strong>Action-based</strong><br><small>Do, not just read</small></div></div>
          <div class="stat"><i class="fa-solid fa-certificate"></i><div><strong>Proof</strong><br><small>NFT certificate</small></div></div>
        </div>
      </div>
      <div class="card animate__animated animate__fadeInUp" style="--animate-delay:.06s">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Access Gate</h3>
          <div class="ring" id="ring" data-label="0%"></div>
        </div>
        <p class="muted">Unlock with <strong>≥ 100 KLY</strong> on <strong>BNB Chain</strong> <em>or</em> an <strong>Invite Code</strong>.</p>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-coins" style="color:var(--cyn)"></i>
          <div><div class="muted">Your KLY balance</div><strong id="kly-balance">—</strong></div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-network-wired" style="color:var(--pnk)"></i>
          <div><div class="muted">Network</div><strong id="net-name">Not connected</strong></div>
        </div>
        <div class="vip-input" style="margin-top:12px">
          <input id="invite-code" inputmode="latin" placeholder="Enter Invite Code (e.g., AURORA-777)" aria-label="Invite Code">
          <button id="btn-redeem" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <small class="muted">Codes are single-use per wallet. Keep yours private.</small>
      </div>
    </section>

    <!-- Main -->
    <section class="grid-main">
      <!-- Sidebar -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px">
          <h3 style="margin:0">Profile</h3>
          <button id="btn-disconnect" class="btn btn-ghost" hidden><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        </div>
        <div class="profile">
          <div class="avatar" id="avatar">KA</div>
          <div>
            <div style="font-weight:800">Learner</div>
            <div id="addr-full" class="addr">Not connected</div>
          </div>
        </div>

        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="muted" style="margin-bottom:8px">Beginner</div>
          <div id="menu-beginner" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Master</div>
          <div id="menu-master" class="menu"></div>
        </div>
      </aside>

      <!-- Lessons (locked until access) -->
      <main id="curriculum-wrap" class="card lock-wrap locked">
        <div class="lock-blur">
          <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; display:flex; align-items:center; gap:8px">
            <h3 style="margin:0">Curriculum</h3>
            <span class="chip" title="Members Only"><i class="fa-solid fa-lock"></i> Members Only</span>
          </div>
          <div id="accordion"></div>
        </div>
        <div class="lock-overlay">
          <div class="overlay-card">
            <h3 style="margin:0"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Exclusive Access</h3>
            <p class="muted" style="margin:6px 0 10px">Connect a wallet with ≥ 100 KLY or redeem your invite. Welcome to the inner circle.</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button id="btn-overlay-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
              <a href="#apply" id="btn-waitlist" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Request Invite</a>
            </div>
          </div>
        </div>
      </main>

      <!-- Certificate -->
      <aside class="card">
        <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; position:relative">
          <h3 style="margin:0">Certificate</h3>
        </div>
        <div class="cert-img">
          <span class="seal">Founder’s Seal</span>
          <img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="KLY Certificate">
        </div>
        <p class="muted">Finish all modules to mint your NFT certificate.</p>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin:10px 0 14px">
          <div>Progress</div><strong id="cert-progress">0 / 12</strong>
          <div>Status</div><strong id="cert-status">Locked</strong>
        </div>
        <button id="btn-mint" class="btn" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
        <div id="mint-status" class="muted" style="margin-top:10px"></div>
      </aside>
    </section>

    <footer class="container" style="opacity:.7; text-align:center; margin-top:20px">
      <small>© <span id="year"></span> KLY Academy • Private Cohort</small>
    </footer>
  </div>

  <!-- About Membership Modal -->
  <div id="modal" class="topbar" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(6,7,19,.85); backdrop-filter:blur(10px)">
    <div class="container" style="max-width:820px; margin-top:60px">
      <div class="card" style="position:relative">
        <button id="modal-close" class="btn btn-ghost" style="position:absolute; top:10px; right:10px"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin:0 0 6px"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Membership</h3>
        <p class="muted">This is a private cohort. Access requires a qualifying on-chain balance or an invite code issued by the team. Invitations are non-transferable and bound to your wallet.</p>
        <div class="vip-input" style="margin-top:10px">
          <input id="invite-code-2" placeholder="Enter Invite Code" aria-label="Invite Code">
          <button id="btn-redeem-2" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <button id="btn-modal-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
          <a href="#apply" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Join Waitlist</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden>
    <i id="toast-icon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toast-title" style="font-weight:800;margin-bottom:4px">Info</div>
      <div id="toast-msg" class="muted">Message</div>
    </div>
    <button class="x" onclick="hideToast()"><i class="fa-solid fa-xmark"></i></button>
  </div>

<script>
/* ==============================
   CONFIG
============================== */
const KLY_TOKEN_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const NFT_CONTRACT_ADDRESS = "0xc1a2E9A475779EfD04247EA473638717E26cd5C5";
const KLY_TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const NFT_CONTRACT_ABI = [
  "function mintTo(address to, string uri) public"
];
const TOTAL_MODULES = 12;
const BSC = { idDec:56, idHex:"0x38", name:"BNB Smart Chain", rpc:"https://bsc-dataseed.binance.org/" };

/* Invite codes (client-side demo). Replace with your backend/allowlist when ready. */
const INVITES = new Set([
  "AURORA-777", "AURORA-888", "KLY-ALPHA", "NEON-PRIME"
]);

/* ==============================
   STATE
============================== */
let web3Modal, provider, signer, account = null, walletInstance=null;
let completed = JSON.parse(localStorage.getItem("kly_completed_neon") || "[]");
let opened = null;
let inviteUnlocked = localStorage.getItem("kly_invite_unlocked")==="1";

/* ==============================
   DOM
============================== */
const el = (id)=>document.getElementById(id);
const btnConnect   = el("btn-connect");
const btnDisconnect= el("btn-disconnect");
const btnAbout     = el("btn-about");
const modal        = el("modal");
const modalClose   = el("modal-close");
const btnModalConn = el("btn-modal-connect");

const pillAddr  = el("pill-addr");
const addrShort = el("addr-short");
const addrFull  = el("addr-full");
const avatar    = el("avatar");
const ring      = el("ring");
const klyBalanceEl = el("kly-balance");
const netNameEl = el("net-name");
const chipText  = el("chip-text");
const certProgress = el("cert-progress");
const certStatus   = el("cert-status");
const btnMint   = el("btn-mint");
const mintStatus= el("mint-status");

const toast = el("toast"), toastIcon = el("toast-icon"), toastTitle = el("toast-title"), toastMsg = el("toast-msg");

const inviteInput  = el("invite-code");
const inviteInput2 = el("invite-code-2");
const btnRedeem    = el("btn-redeem");
const btnRedeem2   = el("btn-redeem-2");
const btnOverlayConnect = el("btn-overlay-connect");

const curriculumWrap = el("curriculum-wrap");

/* ==============================
   LESSON CONTENT
============================== */
const M = (id, level, num, title, sections) => ({id, level, num, title, sections});

const modules = [
  M("module1","Beginner",1,"DeFi Basics",[
    {label:"Objectives", html:`<ul>
      <li>Understand what DeFi is and why it matters</li>
      <li>Identify core building blocks (chains, contracts, DAOs, dApps)</li>
      <li>See how self-custody changes incentives</li></ul>`},
    {label:"Key Concepts", html:`<div class="two">
      <div><div class="callout"><strong>DeFi = Open Finance</strong><br/>Protocols are permissionless and composable; anyone can build on top.</div></div>
      <div><div class="callout"><strong>Self-Custody</strong><br/>“Not your keys, not your coins.” You own assets directly via private keys.</div></div>
    </div>`},
    {label:"Example", html:`<p>Sending 10 USDT on a DEX involves signing a transaction that moves funds from <em>your</em> address to a pool. No bank holds them for you.</p>`},
    {label:"Quick Exercise", html:`<ol>
      <li>Write <em>one sentence</em> defining DeFi for a friend.</li>
      <li>List 3 differences between a bank transfer and a DEX swap.</li></ol>`},
    {label:"Resources", html:`<ul>
      <li><a target="_blank" rel="noopener" href="https://ethereum.org/en/defi/">ethereum.org/defi</a></li>
      <li><a target="_blank" rel="noopener" href="https://defillama.com/">DeFiLlama TVL dashboards</a></li></ul>`}
  ]),
  M("module2","Beginner",2,"Wallet Setup",[
    {label:"Objectives", html:`<ul><li>Choose a wallet (hot vs hardware)</li><li>Secure your recovery phrase</li><li>Fund with BNB (gas) + KLY (access)</li></ul>`},
    {label:"Security First", html:`<div class="callout"><strong>Never</strong> store your seed phrase online or in screenshots.</div>`},
    {label:"Steps", html:`<ol>
      <li>Install MetaMask/Trust from official site/app store</li>
      <li>Create wallet → write 12–24 words (offline)</li>
      <li>Add BNB Chain → fund with small BNB for gas</li>
      <li>Acquire KLY for course access</li></ol>`},
    {label:"Tip", html:`<p>Use a second “approval wallet” for dApps to limit exposure.</p>`}
  ]),
  M("module3","Beginner",3,"Using DEXs",[
    {label:"Objectives", html:`<ul><li>Understand AMMs</li><li>Execute a swap safely</li><li>Configure slippage & gas</li></ul>`},
    {label:"How AMMs Work", html:`<p>AMMs keep a pool of two tokens; the product <code class="code">x * y = k</code> stays constant.</p>`},
    {label:"Swap Checklist", html:`<ul>
      <li>Verify token contract (official link)</li>
      <li>Set slippage (1–3% typical)</li>
      <li>Check price impact and route</li></ul>`}
  ]),
  M("module4","Beginner",4,"Earning with DeFi",[
    {label:"Objectives", html:`<ul><li>Compare staking, lending, LP fees</li><li>Understand impermanent loss</li><li>Size positions prudently</li></ul>`},
    {label:"Yield Menu", html:`<div class="two"><div>
      <ul><li>Staking</li><li>Lending</li><li>LP (IL risk)</li></ul>
    </div><div class="callout"><strong>Thumb Rule:</strong> Higher APY → higher risk.</div></div>`}
  ]),
  M("module5","Beginner",5,"Safety & Strategy",[
    {label:"Threats", html:`<ul><li>Phishing & fake sites</li><li>Rugpulls</li><li>Malicious approvals</li></ul>`},
    {label:"Protection", html:`<ul><li>Bookmark official links</li><li>Hardware wallet</li><li>Revoke approvals monthly</li></ul>`}
  ]),
  /* Master 1–7 */
  M("mdf-1","Master",1,"Sovereign Mindset",[
    {label:"Objectives", html:`<ul><li>Owner-operator</li><li>Spot scarcity</li><li>Install review rituals</li></ul>`}
  ]),
  M("mdf-2","Master",2,"Blockchain & Tokenomics",[
    {label:"Objectives", html:`<ul><li>Consensus</li><li>Standards</li><li>Emissions & utility</li></ul>`}
  ]),
  M("mdf-3","Master",3,"Wealth via Ecosystems",[
    {label:"Objectives", html:`<ul><li>Utility flywheel</li><li>Choose role</li><li>Plan & KPIs</li></ul>`}
  ]),
  M("mdf-4","Master",4,"DeFi Mastery",[
    {label:"Objectives", html:`<ul><li>Yield map</li><li>IL math</li><li>Automation</li></ul>`}
  ]),
  M("mdf-5","Master",5,"NFTs as Wealth Vehicles",[
    {label:"Objectives", html:`<ul><li>Collectible vs utility</li><li>Mint+royalty</li><li>Liquidity quality</li></ul>`}
  ]),
  M("mdf-6","Master",6,"Multiple Web3 Income Streams",[
    {label:"Objectives", html:`<ul><li>3–5 lanes</li><li>Prospect & deliver</li><li>Track metrics</li></ul>`}
  ]),
  M("mdf-7","Master",7,"Sovereign Wealth Strategy",[
    {label:"Objectives", html:`<ul><li>5y plan</li><li>Protection</li><li>Cadences</li></ul>`}
  ])
];

/* ==============================
   RENDER
============================== */
function menuBtn(m){
  const b = document.createElement("button");
  b.id = `menu-${m.id}`;
  b.innerHTML = `<i class="fa-solid ${m.level==='Beginner'?'fa-book-open':'fa-crown'}"></i> ${m.title} <span class="badge">${m.level==='Beginner'?m.num:'M'+m.num}</span>`;
  b.onclick = ()=>openModule(m.id, true);
  return b;
}
function renderMenus(){
  const beg = document.getElementById("menu-beginner");
  const mst = document.getElementById("menu-master");
  beg.innerHTML=""; mst.innerHTML="";
  modules.filter(x=>x.level==="Beginner").forEach(m=>beg.appendChild(menuBtn(m)));
  modules.filter(x=>x.level==="Master").forEach(m=>mst.appendChild(menuBtn(m)));
}
function renderAccordion(){
  const elA = document.getElementById("accordion");
  elA.innerHTML = "";
  modules.forEach(m=>{
    const acc = document.createElement("div");
    acc.className = "acc"; acc.id = `acc-${m.id}`;
    const done = completed.includes(m.id);
    const sectionsHTML = (m.sections||[]).map(s=>`
      <section style="margin-top:12px">
        <h4 style="margin:6px 0 8px;color:#a7c3ff"><i class="fa-solid fa-sparkles" style="color:var(--cyn)"></i> ${s.label}</h4>
        ${s.html||""}
      </section>
    `).join("");
    acc.innerHTML = `
      <div class="acc-sum" role="button" aria-expanded="false">
        <div class="left">
          <div class="num">${m.level==='Beginner'?m.num:'M'+m.num}</div>
          <div>
            <div style="font-weight:800">${m.title}</div>
            <small class="muted">${m.level}</small>
          </div>
          ${done?`<span class="pill" style="border-color:rgba(0,255,149,.35);color:#a5ffcf"><i class="fa-solid fa-circle-check"></i> Completed</span>`:""}
        </div>
        <div><button class="btn btn-ghost"><i class="fa-solid fa-chevron-down"></i></button></div>
      </div>
      <div class="acc-body">
        ${sectionsHTML}
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-mark" onclick="markComplete('${m.id}')"><i class="fa-solid fa-check"></i> Mark Complete</button>
          <span class="pill"><i class="fa-solid fa-clock"></i> ~12–20 min</span>
          <span class="pill"><i class="fa-solid fa-signal"></i> ${m.level}</span>
        </div>
      </div>
    `;
    acc.querySelector(".acc-sum").onclick = ()=>openModule(m.id, false);
    elA.appendChild(acc);
  });
}
function openModule(id, fromMenu){
  const acc = document.getElementById(`acc-${id}`);
  if(!acc) return;
  const isOpen = acc.classList.contains("open");
  document.querySelectorAll(".acc").forEach(a=>{ a.classList.remove("open"); a.querySelector(".acc-sum").setAttribute("aria-expanded","false"); });
  if(!isOpen){ acc.classList.add("open"); acc.querySelector(".acc-sum").setAttribute("aria-expanded","true"); opened = id; }
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  const btn = document.getElementById(`menu-${id}`); if(btn) btn.classList.add("active");
  if(fromMenu) acc.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ==============================
   PROGRESS
============================== */
function markComplete(id){
  if(!completed.includes(id)){ completed.push(id); localStorage.setItem("kly_completed_neon", JSON.stringify(completed)); }
  notify("Saved","Module marked complete","good","fa-circle-check");
  renderAccordion(); updateProgress();
  if(typeof confetti==="function"){ confetti({particleCount:90, spread:60, origin:{y:.8}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
}
function updateProgress(){
  const unique = [...new Set(completed)].filter(id => modules.some(m => m.id === id));
  const done = unique.length;
  const pct = Math.min(100, Math.round(done/TOTAL_MODULES*100));
  chipText.textContent = `${done}/${TOTAL_MODULES} Complete`;
  certProgress.textContent = `${done} / ${TOTAL_MODULES}`;
  ring.style.setProperty("--p", pct + "%"); ring.setAttribute("data-label", pct + "%");
  if(done >= TOTAL_MODULES){ certStatus.textContent = "Ready to Mint"; btnMint.disabled = false; } else { certStatus.textContent = "Locked"; btnMint.disabled = true; }
}

/* ==============================
   TOAST
============================== */
function notify(title, msg, kind="info", icon="fa-circle-info"){
  // 1) sane fallbacks so it's never empty
  const safeTitle = (title && String(title).trim()) || "Notice";
  const safeMsg   = (msg   && String(msg).trim())   || "All set.";

  toastTitle.textContent = safeTitle;
  toastMsg.textContent   = safeMsg;

  // 2) icon + tone
  toastIcon.className = `fa-solid ${icon || "fa-circle-info"}`;
  toast.classList.remove("good","bad","warn");
  if(kind==="good") toast.classList.add("good");
  else if(kind==="bad") toast.classList.add("bad");
  else if(kind==="warn") toast.classList.add("warn");

  // 3) show
  toast.hidden = false;

  // 4) clear previous timers/loops (prevents “sticky” toasts)
  if(notify._timer){ clearTimeout(notify._timer); notify._timer=null; }
  if(notify._raf){ cancelAnimationFrame(notify._raf); notify._raf=null; }

  // 5) auto-hide
  notify._timer = setTimeout(hideToast, 4200);

  // (optional) RAF backup for throttled timers on some mobiles
  const start = performance.now();
  function loop(t){
    if(t - start > 4500){ hideToast(); return; }
    notify._raf = requestAnimationFrame(loop);
  }
  notify._raf = requestAnimationFrame(loop);
}

function hideToast(){
  // kill timers first
  if(notify._timer){ clearTimeout(notify._timer); notify._timer=null; }
  if(notify._raf){ cancelAnimationFrame(notify._raf); notify._raf=null; }

  // actually hide (CSS [hidden] rule enforces display:none)
  toast.hidden = true;

  // optional: clear text so it never “looks empty” if shown mid-update
  // toastTitle.textContent = "Info";
  // toastMsg.textContent = "Message";
}

/* ==============================
   WEB3
============================== */
async function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { [BSC.idDec]: BSC.rpc }, chainId: BSC.idDec }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:"dark" });
}

function setConnectUI(state){
  // state: 'idle' | 'connecting' | 'connected'
  if(state === 'connecting'){
    btnConnect.disabled = true;
    btnConnect.hidden = false;
    btnConnect.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connecting…';
  }else if(state === 'connected'){
    btnConnect.disabled = false;
    btnConnect.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
    btnConnect.hidden = true;
    btnDisconnect.hidden = false;
    pillAddr.hidden = false;
  }else{
    btnConnect.disabled = false;
    btnConnect.hidden = false;
    btnDisconnect.hidden = true;
    pillAddr.hidden = true;
    btnConnect.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
  }
}

function notifyAuto(title, msg, kind="info", icon="fa-circle-info"){
  notify(title, msg, kind, icon);
  clearTimeout(notifyAuto._t);
  notifyAuto._t = setTimeout(()=>hideToast(), 4200);
}

async function connect(){
  setConnectUI('connecting');
  try{
    walletInstance = await web3Modal.connect();
    walletInstance.removeAllListeners?.();

    provider = new ethers.providers.Web3Provider(walletInstance, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();

    const net = await provider.getNetwork().catch(()=>({ chainId: 0 }));
    if(net.chainId !== BSC.idDec){
      try{
        await walletInstance.request({ method:"wallet_switchEthereumChain", params:[{ chainId:BSC.idHex }] });
      }catch(e){
        if(e?.code === 4902){
          await walletInstance.request({ method:"wallet_addEthereumChain", params:[{
            chainId:BSC.idHex, chainName:BSC.name,
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls:[BSC.rpc], blockExplorerUrls:["https://bscscan.com"]
          }] });
        }else{ throw e; }
      }
      provider = new ethers.providers.Web3Provider(walletInstance, "any");
      signer = provider.getSigner();
      account = await signer.getAddress();
    }

    walletInstance.on?.("accountsChanged", async (accs)=>{
      if(!accs?.length) return disconnect();
      account = accs[0];
      await afterConnect();
    });
    walletInstance.on?.("chainChanged", async ()=>{
      provider = new ethers.providers.Web3Provider(walletInstance, "any");
      signer   = provider.getSigner();
      account  = await signer.getAddress().catch(()=>account);
      await afterConnect();
    });
    walletInstance.on?.("disconnect", ()=> disconnect());

    await afterConnect();
    setConnectUI('connected');
  }catch(err){
    console.error('[connect] failed:', err);
    notifyAuto("Connection Failed", err?.message || "User rejected", "bad", "fa-circle-xmark");
    setConnectUI('idle');
  }
}

async function afterConnect(){
  try{
    if(!provider || !signer || !account) throw new Error('Missing provider/signer/account');
    const short = `${account.slice(0,6)}…${account.slice(-4)}`;
    addrShort.textContent = short;
    addrFull.textContent  = account;
    avatar.textContent    = account.slice(2,4).toUpperCase();
    netNameEl.textContent = BSC.name;

    const kly = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const [raw, dec] = await Promise.all([kly.balanceOf(account), kly.decimals().catch(()=>18)]);
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    klyBalanceEl.textContent = `${bal.toLocaleString(undefined,{ maximumFractionDigits: 4 })} KLY`;

    const p = Math.min(100, Math.round((Math.min(bal, 100) / 100) * 100));
    ring.style.setProperty("--p", p + "%");
    ring.setAttribute("data-label", p + "%");

    updateAccessState(bal);
    updateProgress();
  }catch(e){
    console.error('[afterConnect] error:', e);
    notifyAuto("Read Error","Could not read KLY balance.","bad","fa-bug");
  }
}

async function disconnect(){
  try{ await walletInstance?.disconnect?.(); }catch{}
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}

  walletInstance = null;
  provider = signer = account = null;

  addrFull.textContent = "Not connected";
  avatar.textContent   = "KA";
  netNameEl.textContent= "Not connected";
  klyBalanceEl.textContent = "—";
  ring.style.setProperty("--p", "0%");
  ring.setAttribute("data-label", "0%");
  setConnectUI('idle');
  updateAccessState(0); // re-lock UI
  notifyAuto("Disconnected","Wallet disconnected","good","fa-right-from-bracket");
}

/* ==============================
   ACCESS: Token OR Invite
============================== */
function hasTokenAccess(bal){ return bal >= 100; }
function hasInviteAccess(){ return inviteUnlocked === true; }

function updateAccessState(balanceNum){
  const access = hasTokenAccess(balanceNum) || hasInviteAccess();
  curriculumWrap.classList.toggle('locked', !access);
  if(access){
    notifyAuto("Welcome","Access granted. Enjoy the course.","good","fa-unlock");
  }else{
    // show a gentle note but don't spam
  }
}

/* Redeem invite (client-side demo) */
function redeemInvite(codeRaw){
  const code = (codeRaw||"").trim().toUpperCase();
  if(!code){ notify("Missing Code","Enter your invite code.","warn","fa-key"); return; }
  if(!INVITES.has(code)){ notify("Invalid Code","Please check your invite.","bad","fa-circle-xmark"); return; }
  inviteUnlocked = true;
  localStorage.setItem("kly_invite_unlocked","1");
  INVITES.delete(code); // one-time (client-side simulation)
  notify("Invite Accepted","Your membership has been activated.","good","fa-gem");
  curriculumWrap.classList.remove('locked');
  if(typeof confetti==="function"){ confetti({particleCount:120, spread:70, origin:{y:.7}, colors:["#FFD98A","#00eaff","#ff3bff"]}); }
}

/* ==============================
   MINT
============================== */
async function mint(){
  if(!signer) return notify("Connect Wallet","Please connect your wallet first.","warn","fa-wallet");
  const unique = [...new Set(completed)].filter(id => modules.some(m => m.id === id));
  if(unique.length < TOTAL_MODULES) return notify("Finish Modules","Complete all modules first.","warn","fa-list-check");
  try{
    btnMint.disabled=true; btnMint.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Minting…';
    const to = await signer.getAddress();
    const nft = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
    const tokenURI = "ipfs://bafybeihkmkaf2mgx7xkrnkhmzd2uvhr6ddgj6z3vkqcgnvlaa3z7x263r4";
    let gas = await nft.estimateGas.mintTo(to, tokenURI).catch(()=>null);
    if(!gas){ notify("Gas Estimation Failed","Are you authorized to mint?","bad","fa-engine-warning"); btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate'; return; }
    const tx = await nft.mintTo(to, tokenURI, { gasLimit: gas.mul(120).div(100) });
    mintStatus.innerHTML = `Tx submitted: <a target="_blank" rel="noopener" href="https://bscscan.com/tx/${tx.hash}">view on BscScan</a>`;
    await tx.wait();
    notify("Minted","Certificate minted successfully!","good","fa-certificate");
    btnMint.innerHTML = '<i class="fa-solid fa-circle-check"></i> Minted';
    if(typeof confetti==="function"){ confetti({particleCount:160, spread:70, origin:{y:.7}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
  }catch(e){
    notify("Mint Failed", e?.message || "Unknown error", "bad", "fa-circle-xmark");
    btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate';
  }
}

/* ==============================
   INIT
============================== */
function initUI(){
  renderMenus(); renderAccordion(); updateProgress();
  if(modules[0]) openModule(modules[0].id, false);
  const year = new Date().getFullYear(); el("year").textContent = year;
}
btnConnect.addEventListener("click", connect);
btnDisconnect.addEventListener("click", disconnect);
btnMint.addEventListener("click", mint);
document.getElementById("btn-overlay-connect").addEventListener("click", connect);

btnRedeem.addEventListener("click", ()=> redeemInvite(inviteInput.value));
btnRedeem2.addEventListener("click", ()=> redeemInvite(inviteInput2.value));

btnAbout.addEventListener("click", ()=> modal.style.display="block");
modalClose.addEventListener("click", ()=> modal.style.display="none");
btnModalConn.addEventListener("click", ()=> connect());

window.addEventListener("beforeunload", ()=>{ if(opened) localStorage.setItem("kly_open_neon", opened); });

window.addEventListener("load", async ()=>{
  initUI();
  await initWeb3Modal();
  // restore invite access on load
  if(inviteUnlocked){ curriculumWrap.classList.remove('locked'); }
  if(window.Web3Modal && web3Modal.cachedProvider){ try{ await connect(); }catch{} }
});
</script>
</body>
</html>
