<!DOCTYPE html>
<html lang="en">
<head> 
  <!-- Meta -->
<meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#060713"/>
  <title>KLY Academy — DeFi Neon • Private</title>
  <meta name="description" content="Token-gated KLY Academy with wallet access, course progress, and on-chain certificate minting." />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/J6MdG8V1bZK1FQ6VZb6T1Zr3S9e8T+1iFqPq+M3e0r4c5pXb9qN9oC3m5p4hZQf1YFqZlAK2g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Motion & FX -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-b7nE5n+ZV4QpQv0uQeQmLw8m1zj3G0Yp3w0k4s2X3kQmY0m8Cw+vQk8dQ1lD3gUQn0kQ8zH1H8f2wT2QDs2F2Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

  <!-- ✅ Ethers v5 UMD (global window.ethers, no defer/async) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" data-cfasync="false"></script>
<script>
  // Fallback if the first CDN fails
  if (!window.ethers) {
    document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>');
  }
</script>
  <style>
    :root{
      /* Neon + Gold palette (exclusive) */
      --bg:#060713; --bg2:#0a0c1f;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --border:rgba(132,255,255,.18);
      --txt:#E9EEFF; --muted:#B9C3E5;
      --cyn:#00eaff; --pnk:#ff3bff; --vio:#9333ff; --sun:#ffb300; --lime:#00ff95;
      --gold:#FFD98A; --gold2:#FFB74A;
      --danger:#ff3d3d;

      --glow-cyn:0 0 24px rgba(0,234,255,.35);
      --glow-pnk:0 0 24px rgba(255,59,255,.35);
      --glow-vio:0 0 24px rgba(147,51,255,.35);

      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--txt);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1100px 700px at 12% -8%, rgba(0,234,255,.10), transparent 60%),
        radial-gradient(900px 600px at 100% -10%, rgba(255,59,255,.10), transparent 60%),
        linear-gradient(180deg,#050611, #0a0c1f 60%, #07081a);
      overflow-x:hidden;
    }

    /* Subtle aurora + grain overlay for exclusivity */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        radial-gradient(50% 35% at 70% -10%, rgba(255,217,138,.15), transparent 60%),
        conic-gradient(from 230deg at 20% 10%, rgba(0,234,255,.08), transparent 45%);
      filter: blur(18px);
      animation: drift 18s ease-in-out infinite alternate;
    }
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='table' tableValues='0 0 0 .08 0'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity:.7; mix-blend-mode:overlay;
    }
    @keyframes drift{
      0%{ transform:translateY(-2%) scale(1); }
      100%{ transform:translateY(2%) scale(1.04); }
    }

    a{color:var(--cyn); text-decoration:none}
    a:hover{opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(1.2);
      background:linear-gradient(180deg, rgba(6,7,19,.88), rgba(6,7,19,.52));
      border-bottom:1px solid var(--border);
      box-shadow:var(--glow-cyn);
    }
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:12px;font-family:"Space Grotesk",Inter}
    .brand i{font-size:22px;color:var(--cyn);filter:drop-shadow(0 0 8px rgba(0,234,255,.6))}
    .brand .text{font-weight:800;letter-spacing:.6px}
    .ribbon{
      display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        linear-gradient(90deg, rgba(255,183,74,.20), rgba(255,217,138,.12));
      border:1px solid rgba(255,217,138,.25);
      color:#ffeac0; box-shadow:0 0 0 1px rgba(255,183,74,.15);
    }
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--muted);font-size:13px;box-shadow:0 0 0 1px rgba(147,51,255,.15), var(--glow-vio)}
    .btn{
      border:1px solid var(--border);color:var(--txt);
      background:
        linear-gradient(90deg, rgba(0,234,255,.18), rgba(255,59,255,.18));
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center;
      box-shadow:var(--glow-cyn);transition:transform .2s, box-shadow .2s
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--glow-pnk)}
    .btn-ghost{background:transparent}

    /* Hero */
    .grid-hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:20px}
    @media (max-width:1100px){ .grid-hero{grid-template-columns:1fr} }
    .card{
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); padding:24px; box-shadow:var(--glow-cyn);
      overflow:hidden;
    }
    /* premium card sheen */
    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
      background:linear-gradient(120deg, rgba(255,255,255,.06), transparent 35%, rgba(255,255,255,.07) 50%, transparent 65%);
      transform:translateX(-30%); transition:transform .9s ease;
    }
    .card:hover::after{ transform:translateX(0%) }

    h1{margin:0 0 10px;font-family:"Space Grotesk";font-size:36px; letter-spacing:.2px}
    .grad{background:linear-gradient(90deg,var(--cyn),var(--pnk));-webkit-background-clip:text;background-clip:text;color:transparent}
    p{color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .stat{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);display:flex;gap:10px;align-items:center}
    .stat i{color:var(--cyn);text-shadow:0 0 10px rgba(0,234,255,.7)}

    /* KPI ring */
    .ring{--p:0;--size:90px;width:var(--size);height:var(--size);border-radius:50%;background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--cyn) var(--p), #202442 0);position:relative}
    .ring::before{content:attr(data-label);position:absolute;inset:8px;border-radius:50%;display:grid;place-items:center;color:#a8f9ff;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}

    /* Main grid */
    .grid-main{display:grid;grid-template-columns:300px 1fr 320px;gap:18px;margin-top:18px}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }

    /* Sidebar */
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;font-weight:800;background:
      radial-gradient(circle at 30% 30%, #fff3, #0000 40%),
      linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .addr{font-family:ui-monospace,monospace;color:var(--muted);font-size:13px}
    .menu{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .menu button{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.03);color:var(--txt);text-align:left;cursor:pointer;display:flex;gap:10px;align-items:center}
    .menu button.active{box-shadow:var(--glow-pnk)}
    .badge{margin-left:auto;background:linear-gradient(90deg,var(--pnk),var(--vio));padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}

    /* Lessons */
    .acc{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04)}
    .acc + .acc{margin-top:12px}
    .acc-sum{display:flex;justify-content:space-between;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
    .acc-sum .left{display:flex;gap:12px;align-items:center}
    .num{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .acc-body{display:none;padding:0 16px 16px}
    .acc.open .acc-body{display:block}
    .callout{border-left:3px solid var(--cyn);background:rgba(0,234,255,.08);padding:12px;border-radius:0 12px 12px 0;margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .code{
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#a5ffcf;
      background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.25));
      border:1px solid rgba(0,255,149,.25); border-radius:10px; padding:10px; box-shadow:0 0 12px rgba(0,255,149,.1);
      overflow:auto
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .btn-mark{background:linear-gradient(90deg,var(--cyn),var(--pnk));border:0;color:#06101a;border-radius:10px;padding:10px 14px;font-weight:800}

/* --- Certificate sizing: make the NFT fit cleanly --- */
.cert-img{
  position:relative;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--glow-vio);

  /* choose ONE of the two approaches below */

  /* A) Fixed visual height (good for sidebars) */
  max-height: 320px;         /* tweak to your taste */
  height: 320px;
  background: #0b0f1c;       /* subtle frame behind transparent PNGs */

  /* B) Or: aspect-ratio based (comment A out, uncomment below) */
  /* aspect-ratio: 4 / 3;   */
}

.cert-img img{
  display:block;
  width:100%;
  height:100%;
  object-fit: contain;        /* show the whole artwork, no crop */
  object-position: center;
  background: transparent;    /* PNG edges look clean */
}

/* optional: keep the "Founder’s Seal" above the image always */
.cert-img .seal{ z-index:2; }

/* make the HTML hidden attribute actually hide elements */
[hidden]{ display:none !important; }

    /* Members-only blur overlay */
    .lock-wrap{ position:relative }
    .locked .lock-blur{ filter:blur(4px); pointer-events:none; user-select:none; }
    .lock-overlay{
      position:absolute; inset:0; display:none; place-items:center; text-align:center;
      background:linear-gradient(180deg, rgba(6,7,19,.78), rgba(6,7,19,.82));
      border:1px dashed rgba(255,217,138,.35); border-radius:var(--radius);
    }
    .locked .lock-overlay{ display:grid }

    .overlay-card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,217,138,.35); border-radius:16px;
      padding:16px; box-shadow:0 0 0 1px rgba(255,183,74,.15), 0 16px 50px rgba(0,0,0,.55);
      max-width:560px;
    }
    .overlay-card h3{ margin:6px 0 8px }
    .vip-input{
      display:flex; gap:8px; margin-top:8px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,217,138,.25);
      padding:8px; border-radius:12px;
    }
    .vip-input input{
      flex:1; background:transparent; border:0; color:var(--txt); outline:none;
      font-family:ui-monospace,Menlo,Consolas,monospace; letter-spacing:.6px;
    }
    .vip-btn{ background:linear-gradient(90deg,#FFB74A,#FFD98A); color:#17120B; font-weight:800 }

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:60;padding:14px 16px;border:1px solid var(--border);border-left:4px solid var(--cyn);border-radius:14px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);display:flex;gap:10px;align-items:flex-start;box-shadow:var(--glow-cyn)}
    .toast .x{background:transparent;border:0;color:var(--muted);cursor:pointer}
    .toast.good{border-left-color:var(--lime)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--sun)}

    /* Mobile polish + safe-area */
    .topbar{ padding-top: env(safe-area-inset-top); }
    .toast{
      right: max(16px, env(safe-area-inset-right));
      bottom: max(16px, env(safe-area-inset-bottom));
      max-width: min(92vw, 520px);
      touch-action: pan-y;
    }
    @media (max-width: 680px){
      .container{ padding:14px; }
      .topbar-inner{ padding:12px 14px; gap:10px; }
      .brand .text{ font-size:14px; letter-spacing:.4px; }
      .chip{ padding:6px 10px; font-size:12px }
      .btn{ padding:8px 12px; border-radius:10px; }
      h1{ font-size:28px; line-height:1.15; }
      .grid-hero{ gap:12px; margin-top:14px; }
      .card{ padding:16px; border-radius:14px; }
      .mini{ grid-template-columns:1fr; gap:10px; }
      .stat{ padding:10px; gap:8px }
      .ring{ --size:72px; }
      .grid-main{ grid-template-columns:1fr; gap:12px; margin-top:12px; }
      .menu button{ padding:10px; }
      .num{ width:32px; height:32px; }
      .acc-sum{ padding:12px; }
      .acc-body{ padding:0 12px 12px; }
      .two{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i>
        <div class="text">KLY ACADEMY</div>
        <span class="ribbon"><i class="fa-solid fa-lock"></i> Private Cohort</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="chip-progress" class="chip"><i class="fa-solid fa-chart-simple"></i> <span id="chip-text">0/12 Complete</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <span id="pill-addr" class="chip" hidden><i class="fa-solid fa-user-astronaut"></i> <span id="addr-short">0x…</span></span>
        <button id="btn-about" class="btn btn-ghost" title="About Membership"><i class="fa-regular fa-gem"></i></button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <section class="grid-hero">
      <div class="card animate__animated animate__fadeInUp">
        <h1><span class="grad">Own</span> the Future of Finance</h1>
        <p>Invitation-only, action-first curriculum for sovereign builders. Complete the track and mint your on-chain credential.</p>
        <div class="mini">
          <div class="stat"><i class="fa-solid fa-shield-halved"></i><div><strong>Self-Custody</strong><br><small>Keys stay with you</small></div></div>
          <div class="stat"><i class="fa-solid fa-bolt"></i><div><strong>Action-based</strong><br><small>Do not just read</small></div></div>
          <div class="stat"><i class="fa-solid fa-certificate"></i><div><strong>Proof</strong><br><small>NFT certificate</small></div></div>
        </div>
      </div>
      <div class="card animate__animated animate__fadeInUp" style="--animate-delay:.06s">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Access Gate</h3>
          <div class="ring" id="ring" data-label="0%"></div>
        </div>
        <p class="muted">Unlock with <strong>≥ 100 KLY</strong> on <strong>BNB Chain</strong> <em>or</em> an <strong>Invite Code</strong>.</p>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-coins" style="color:var(--cyn)"></i>
          <div><div class="muted">Your KLY balance</div><strong id="kly-balance">—</strong></div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-network-wired" style="color:var(--pnk)"></i>
          <div><div class="muted">Network</div><strong id="net-name">Not connected</strong></div>
        </div>
        <div class="vip-input" style="margin-top:12px">
          <input id="invite-code" inputmode="latin" placeholder="Enter Invite Code (e.g., AURORA-777)" aria-label="Invite Code">
          <button id="btn-redeem" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <small class="muted">Codes are single-use per wallet. Keep yours private.</small>
      </div>
    </section>

    <!-- Main -->
    <section class="grid-main">
      <!-- Sidebar -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px">
          <h3 style="margin:0">Profile</h3>
          <button id="btn-disconnect" class="btn btn-ghost" hidden><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        </div>
        <div class="profile">
          <div class="avatar" id="avatar">KA</div>
          <div>
            <div style="font-weight:800">Learner</div>
            <div id="addr-full" class="addr">Not connected</div>
          </div>
        </div>

        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="muted" style="margin-bottom:8px">Beginner</div>
          <div id="menu-beginner" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Master</div>
          <div id="menu-master" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Right Knowledge</div>
         <div id="menu-right" class="menu"></div>
        </div>
        </aside>

      <!-- Lessons (locked until access) -->
      <main id="curriculum-wrap" class="card lock-wrap locked">
        <div class="lock-blur">
          <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; display:flex; align-items:center; gap:8px">
            <h3 style="margin:0">Curriculum</h3>
            <span class="chip" title="Members Only"><i class="fa-solid fa-lock"></i> Members Only</span>
          </div>
          <div id="accordion"></div>
        </div>
        <div class="lock-overlay">
          <div class="overlay-card">
            <h3 style="margin:0"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Exclusive Access</h3>
            <p class="muted" style="margin:6px 0 10px">Connect a wallet with ≥ 100 KLY or redeem your invite. Welcome to the inner circle.</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button id="btn-overlay-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
              <a href="#apply" id="btn-waitlist" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Request Invite</a>
            </div>
          </div>
        </div>
      </main>

      <!-- Certificate -->
      <aside class="card">
        <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px; position:relative">
          <h3 style="margin:0">Certificate</h3>
        </div>
        <div class="cert-img">
          <span class="seal">Founder’s Seal</span>
          <img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="KLY Certificate">
        </div>
        <p class="muted">Finish all modules to mint your NFT certificate.</p>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin:10px 0 14px">
          <div>Progress</div><strong id="cert-progress">0 / 12</strong>
          <div>Status</div><strong id="cert-status">Locked</strong>
        </div>
        <button id="btn-mint" class="btn" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
        <div id="mint-status" class="muted" style="margin-top:10px"></div>
      </aside>
    </section>

    <footer class="container" style="opacity:.7; text-align:center; margin-top:20px">
      <small>© <span id="year"></span> KLY Academy • Private Cohort</small>
    </footer>
  </div>

  <!-- About Membership Modal -->
  <div id="modal" class="topbar" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(6,7,19,.85); backdrop-filter:blur(10px)">
    <div class="container" style="max-width:820px; margin-top:60px">
      <div class="card" style="position:relative">
        <button id="modal-close" class="btn btn-ghost" style="position:absolute; top:10px; right:10px"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin:0 0 6px"><i class="fa-solid fa-gem" style="color:var(--gold2)"></i> Membership</h3>
        <p class="muted">This is a private cohort. Access requires a qualifying on-chain balance or an invite code issued by the team. Invitations are non-transferable and bound to your wallet.</p>
        <div class="vip-input" style="margin-top:10px">
          <input id="invite-code-2" placeholder="Enter Invite Code" aria-label="Invite Code">
          <button id="btn-redeem-2" class="btn vip-btn"><i class="fa-solid fa-key"></i> Redeem</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <button id="btn-modal-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet</button>
          <a href="#apply" class="btn btn-ghost"><i class="fa-regular fa-envelope"></i> Join Waitlist</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden>
    <i id="toast-icon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toast-title" style="font-weight:800;margin-bottom:4px">Info</div>
      <div id="toast-msg" class="muted">Message</div>
    </div>
    <button class="x" onclick="hideToast()"><i class="fa-solid fa-xmark"></i></button>
  </div>

<script>
/* ==============================
   CONFIG
============================== */
const KLY_TOKEN_ADDRESS   = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const NFT_CONTRACT_ADDRESS= "0xDA76d35742190283E340dbeE2038ecc978a56950"; // Thirdweb ERC-721 you control

const KLY_TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];
const NFT_CONTRACT_ABI = [
  "function mintTo(address to, string uri) public returns (uint256)"
];

const REQUIRED_KLY = 100; // match UI: ≥ 100 KLY

const BSC = {
  idDec: 56,
  idHex: "0x38",
  name: "BNB Smart Chain",
  rpc:  "https://bsc-dataseed.binance.org/",
  explorer: "https://bscscan.com"
};

/* WalletConnect v2 (UMD) */
const WC_PROJECT_ID = "df8063092ef3c627437d698df0977bc1";

/* Invite codes (client-side demo only) */
const INVITES = new Set(["AURORA-777", "AURORA-888", "KLY-ALPHA", "NEON-PRIME"]);

/* ==============================
   STATE
============================== */
let provider   = null;    // ethers.js Web3Provider
let signer     = null;
let account    = null;
let wcProvider = null;    // WalletConnect EIP-1193 instance (if used)

let completed = JSON.parse(localStorage.getItem("kly_completed_neon") || "[]");
let opened    = localStorage.getItem("kly_open_neon") || null;
let inviteUnlocked = localStorage.getItem("kly_invite_unlocked")==="1";

let modules = window.modules || [];     // ensure defined (page may overwrite later)
let TOTAL_MODULES = modules.length || 12;

/* ==============================
   DOM (safe getters)
============================== */
const el = (id)=>document.getElementById(id);
const btnConnect         = el("btn-connect");
const btnDisconnect      = el("btn-disconnect");
const btnAbout           = el("btn-about");
const modal              = el("modal");
const modalClose         = el("modal-close");
const btnModalConn       = el("btn-modal-connect");
const pillAddr           = el("pill-addr");
const addrShort          = el("addr-short");
const addrFull           = el("addr-full");
const avatar             = el("avatar");
const ring               = el("ring");
const klyBalanceEl       = el("kly-balance");
const netNameEl          = el("net-name");
const chipText           = el("chip-text");
const certProgress       = el("cert-progress");
const certStatus         = el("cert-status");
const btnMint            = el("btn-mint");
const mintStatus         = el("mint-status");
const toast              = el("toast");
const toastIcon          = el("toast-icon");
const toastTitle         = el("toast-title");
const toastMsg           = el("toast-msg");
const inviteInput        = el("invite-code");
const inviteInput2       = el("invite-code-2");
const btnRedeem          = el("btn-redeem");
const btnRedeem2         = el("btn-redeem-2");
const btnOverlayConnect  = el("btn-overlay-connect");
const curriculumWrap     = el("curriculum-wrap");
const accordionRoot      = el("accordion");
const menuBeginner       = el("menu-beginner");
const menuMaster         = el("menu-master");
const menuRight          = el("menu-right");

/* ==============================
   UTIL
============================== */
const short = (addr)=> addr ? `${addr.slice(0,6)}…${addr.slice(-4)}` : "";
const fmt = (n, d=2)=> Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
function toUnits(bn, decimals){ return Number(ethers.utils.formatUnits(bn, decimals)); }

/* Toast */
function notify(title, msg, kind="info", icon="fa-circle-info"){
  const safeTitle = (title && String(title).trim()) || "Notice";
  const safeMsg   = (msg   && String(msg).trim())   || "All set.";
  if (!toast) return alert(`${safeTitle}: ${safeMsg}`);

  toastTitle && (toastTitle.textContent = safeTitle);
  toastMsg   && (toastMsg.textContent   = safeMsg);
  if (toastIcon) toastIcon.className = `fa-solid ${icon || "fa-circle-info"}`;

  toast.classList.remove("good","bad","warn");
  if(kind==="good") toast.classList.add("good");
  else if(kind==="bad") toast.classList.add("bad");
  else if(kind==="warn") toast.classList.add("warn");

  toast.hidden = false;
  clearTimeout(notify._timer); notify._timer = setTimeout(hideToast, 4800);
}
function hideToast(){ clearTimeout(notify._timer); toast && (toast.hidden = true); }

/* Focus outline for keyboard users (A11y) */
document.addEventListener("keydown", e=>{
  if(e.key==="Tab") document.body.classList.add("kbd");
});

/* ==============================
   PROGRESS
============================== */
function markComplete(id){
  if(!completed.includes(id)){
    completed.push(id);
    localStorage.setItem("kly_completed_neon", JSON.stringify(completed));
  }
  notify("Saved","Module marked complete","good","fa-circle-check");
  renderAccordion();
  updateProgress();
  if(typeof confetti==="function"){
    confetti({particleCount:90, spread:60, origin:{y:.8}, colors:["#00eaff","#ff3bff","#9333ff"]});
  }
}
function updateProgress(){
  if (!chipText || !certProgress || !ring || !certStatus || !btnMint) return;
  const validIds = new Set((modules||[]).map(m=>m.id));
  const unique = [...new Set(completed)].filter(id => validIds.has(id));
  const done = unique.length;
  TOTAL_MODULES = (modules && modules.length) ? modules.length : TOTAL_MODULES;
  const pct  = Math.min(100, Math.round(done / TOTAL_MODULES * 100));
  chipText.textContent     = `${done}/${TOTAL_MODULES} Complete`;
  certProgress.textContent = `${done} / ${TOTAL_MODULES}`;
  ring.style.setProperty("--p", pct + "%");
  ring.setAttribute("data-label", pct + "%");
  if(done >= TOTAL_MODULES){
    certStatus.textContent = "Ready to Mint";
    btnMint.disabled = false;
  }else{
    certStatus.textContent = "Locked";
    btnMint.disabled = true;
  }
}

/* ==============================
   ACCESS: Token OR Invite
============================== */
function hasTokenAccess(bal){ return bal >= REQUIRED_KLY; }
function hasInviteAccess(){ return inviteUnlocked === true; }
function updateAccessState(balanceNum){
  const access = hasTokenAccess(balanceNum) || hasInviteAccess();
  curriculumWrap?.classList.toggle('locked', !access);
  if(access){ notify("Welcome","Access granted. Enjoy the course.","good","fa-unlock"); }
}
function redeemInvite(codeRaw){
  const code = (codeRaw||"").trim().toUpperCase();
  if(!code){ return notify("Missing Code","Enter your invite code.","warn","fa-key"); }
  if(!INVITES.has(code)){ return notify("Invalid Code","Please check your invite.","bad","fa-circle-xmark"); }
  inviteUnlocked = true;
  localStorage.setItem("kly_invite_unlocked","1");
  INVITES.delete(code); // client-side simulate single-use
  notify("Invite Accepted","Your membership has been activated.","good","fa-gem");
  curriculumWrap?.classList.remove('locked');
  if(typeof confetti==="function"){
    confetti({particleCount:120, spread:70, origin:{y:.7}, colors:["#FFD98A","#00eaff","#ff3bff"]});
  }
}

const ETHERS_UMD_URLS = [
  "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js",
  "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js",
  "https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"
];

async function ensureEthersUMD(){
  if (window.ethers && window.ethers.providers) return;
  await new Promise((res, rej)=>{
    const s=document.createElement("script");
    s.src=ETHERS_UMD_URLS[0];
    s.onload=res; s.onerror=()=>rej(new Error("ethers load failed"));
    document.head.appendChild(s);
  });
  if (!(window.ethers && window.ethers.providers)) {
    throw new Error("Ethers (UMD) failed to load.");
  }
}
  
/* ==============================
   WalletConnect v2 + ethers v5 (UMD)
============================== */
const WC_UMD_URLS = {
  modal: [
    "https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.umd.js",
    "https://cdn.jsdelivr.net/npm/@walletconnect/modal@2.6.2/dist/index.umd.js",
    "https://cdnjs.cloudflare.com/ajax/libs/@walletconnect/modal/2.6.2/index.umd.min.js"
  ],
  ethereumProvider: [
    "https://unpkg.com/@walletconnect/ethereum-provider@2.12.1/dist/umd/index.min.js",
    "https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.12.1/dist/umd/index.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/@walletconnect/ethereum-provider/2.12.1/index.umd.min.js"
  ]
};

function getWCEGlobal(){
  // prefer new name, keep legacy fallbacks
  return (
    window.EthereumProvider ||
    window.WalletConnectEthereumProvider ||
    window.WalletConnectProvider || null
  );
}
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if ([...document.scripts].some(s => s.src === src)) return resolve();
    const s = document.createElement("script");
    s.src = src; s.async = true; s.crossOrigin="anonymous"; s.referrerPolicy="no-referrer";
    s.onload = resolve; s.onerror = ()=>reject(new Error(`Failed to load ${src}`));
    document.head.appendChild(s);
  });
}
async function loadFromAny(urls){
  let lastErr;
  for(const u of urls){ try{ await loadScriptOnce(u); return; } catch(e){ lastErr=e; } }
  throw lastErr || new Error("All CDN URLs failed");
}
async function ensureWalletConnectUMD(){
  if (getWCEGlobal()?.init) return;
  try { await loadFromAny(WC_UMD_URLS.modal); } catch(_) { /* optional */ }
  await loadFromAny(WC_UMD_URLS.ethereumProvider);
  if (!getWCEGlobal()?.init){
    const keys = Object.keys(window).filter(k=>k.toLowerCase().includes("walletconnect")).slice(0,20);
    throw new Error(`WalletConnect UMD not available (found: ${keys.join(", ")||"none"})`);
  }
}

/* Prefer injected; fallback to WC v2 QR */
async function getProviderInjectedOrWC(){
  if (window.ethereum) {
    await window.ethereum.request({ method:"eth_requestAccounts" });
    return new ethers.providers.Web3Provider(window.ethereum, "any");
  }
  await ensureWalletConnectUMD();
  const WCE = getWCEGlobal();
  wcProvider = await WCE.init({
    projectId: WC_PROJECT_ID,
    chains: [BSC.idDec],
    rpcMap: { [BSC.idDec]: BSC.rpc },
    showQrModal: true,
    methods: [
      "eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign",
      "eth_signTypedData","wallet_switchEthereumChain","wallet_addEthereumChain"
    ],
    events: ["chainChanged","accountsChanged","disconnect"],
    metadata: {
      name: "KLY Academy",
      description: "KLY — Web3 Academy & DeFi DAO",
      url: location.origin,
      icons: [location.origin + "/favicon.ico"]
    }
  });
  // listeners
  wcProvider.removeAllListeners?.();
  wcProvider.on?.("accountsChanged", async (accs)=>{
    if(!accs?.length) return window.disconnect();
    account = accs[0];
    await window.afterConnect();
  });
  wcProvider.on?.("chainChanged", async ()=>{
    provider = new ethers.providers.Web3Provider(wcProvider, "any");
    signer   = provider.getSigner();
    account  = await signer.getAddress().catch(()=>account);
    await window.afterConnect();
  });
  wcProvider.on?.("disconnect", ()=> window.disconnect());

  return new ethers.providers.Web3Provider(wcProvider, "any");
}

/* Ensure BSC network */
async function ensureBsc(providerLike){
  const net = await providerLike.getNetwork().catch(()=>({ chainId:0 }));
  if (Number(net.chainId) === Number(BSC.idDec)) return;

  const eip1193 = providerLike.provider || providerLike; // ethers provider → underlying EIP-1193
  try{
    await eip1193.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BSC.idHex }] });
  }catch(e){
    if(e?.code === 4902){
      await eip1193.request({ method:"wallet_addEthereumChain", params:[{
        chainId: BSC.idHex, chainName: BSC.name,
        nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
        rpcUrls:[BSC.rpc], blockExplorerUrls:[BSC.explorer]
      }]});
    }else{ throw e; }
  }
}

/* ==============================
   CONNECT / DISCONNECT (globals)
============================== */
window.connect = async function(){
  window.setConnectUI?.('connecting');
  try{
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if(!isSecure){ throw new Error('Wallets require HTTPS or localhost.'); }

    // ✅ guarantee ethers is loaded before any use
    await ensureEthersUMD();

    provider = await getProviderInjectedOrWC();
    await ensureBsc(provider);

    signer  = provider.getSigner();
    account = await signer.getAddress();

    await window.afterConnect?.();
    window.setConnectUI?.('connected');
  }catch(err){
    console.error('[connect] failed:', err);
    notify?.("Connection Failed", err?.message || "Unable to connect", "bad", "fa-circle-xmark");
    window.setConnectUI?.('idle');
  }
};
  // React to account / chain changes for injected wallets
if (window.ethereum && window.ethereum.on) {
  window.ethereum.removeAllListeners?.('accountsChanged');
  window.ethereum.removeAllListeners?.('chainChanged');

  window.ethereum.on('accountsChanged', async (accs)=>{
    if(!accs?.length) return window.disconnect();
    account = accs[0];
    await window.afterConnect();
  });

  window.ethereum.on('chainChanged', async ()=>{
    provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
    signer   = provider.getSigner();
    account  = await signer.getAddress().catch(()=>account);
    await window.afterConnect();
  });
}
  
window.disconnect = async function(){
  try{ await wcProvider?.disconnect?.(); }catch{}
  wcProvider = null;
  provider   = null;
  signer     = null;
  account    = null;

  addrFull && (addrFull.textContent = "Not connected");
  addrShort && (addrShort.textContent = "");
  avatar   && (avatar.textContent   = "KA");
  netNameEl&& (netNameEl.textContent= "Not connected");
  klyBalanceEl && (klyBalanceEl.textContent = "—");
  if (ring){ ring.style.setProperty("--p","0%"); ring.setAttribute("data-label","0%"); }
  updateAccessState(0);
  window.setConnectUI('idle');
  notify("Disconnected","Wallet disconnected","good","fa-right-from-bracket");
};

window.setConnectUI = function(state){
  const isConn = state==="connected";
  const isBusy = state==="connecting";

  btnConnect        && (btnConnect.disabled = isBusy, btnConnect.innerHTML = isBusy ? '<i class="fa-solid fa-spinner fa-spin"></i> Connecting' : (isConn ? '<i class="fa-solid fa-wallet"></i> Connected' : '<i class="fa-solid fa-wallet"></i> Connect Wallet'));
  btnModalConn      && (btnModalConn.disabled = isBusy);
  btnOverlayConnect && (btnOverlayConnect.disabled = isBusy);

  btnDisconnect && (btnDisconnect.hidden = !isConn);
  pillAddr      && (pillAddr.hidden = !isConn);
};

window.afterConnect = async function(){
  try{
    const addr = await signer.getAddress();
    const net  = await provider.getNetwork();

    addrFull  && (addrFull.textContent  = addr);
    addrShort && (addrShort.textContent = short(addr));
    pillAddr  && (pillAddr.hidden = false);
    avatar    && (avatar.textContent = (addr.slice(2,4)+addr.slice(-2)).toUpperCase());
    netNameEl && (netNameEl.textContent = (Number(net.chainId)===Number(BSC.idDec) ? BSC.name : `Chain ${net.chainId}`));

    // Read KLY balance (and symbol)
    const erc20 = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const [raw, dec] = await Promise.all([
      erc20.balanceOf(addr),
      erc20.decimals().catch(()=>18)
    ]);
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    klyBalanceEl && (klyBalanceEl.textContent = `${fmt(bal, 4)} KLY`);
    updateAccessState(bal);
  }catch(e){
    console.error("[afterConnect]", e);
    notify("Wallet Error", e?.message || "Could not read wallet state", "bad", "fa-circle-xmark");
  }
};

/* Wire buttons to globals (guarded) */
btnConnect        && btnConnect.addEventListener("click", window.connect);
btnModalConn      && btnModalConn.addEventListener("click", window.connect);
btnOverlayConnect && btnOverlayConnect.addEventListener("click", window.connect);
btnDisconnect     && btnDisconnect.addEventListener("click", window.disconnect);

/* ==============================
   MINT
============================== */
async function mint(){
  if(!signer) return notify("Connect Wallet","Please connect your wallet first.","warn","fa-wallet");

  // ensure modules list is loaded
  modules = window.modules || modules || [];
  TOTAL_MODULES = modules.length || TOTAL_MODULES;

  const validIds = new Set((modules||[]).map(m=>m.id));
  const unique   = [...new Set(completed)].filter(id => validIds.has(id));
  if(unique.length < TOTAL_MODULES) return notify("Finish Modules","Complete all modules first.","warn","fa-list-check");

  try{
    btnMint && (btnMint.disabled=true, btnMint.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Minting…');

    const to = await signer.getAddress();
    const nft = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
    const tokenURI = "ipfs://bafybeihkmkaf2mgx7xkrnkhmzd2uvhr6ddgj6z3vkqcgnvlaa3z7x263r4";

    const gas = await nft.estimateGas.mintTo(to, tokenURI).catch(()=>null);
    const opts = gas ? { gasLimit: gas.mul(120).div(100) } : {};
    const tx = await nft.mintTo(to, tokenURI, opts);

    mintStatus && (mintStatus.innerHTML = `Tx submitted: <a target="_blank" rel="noopener" href="${BSC.explorer}/tx/${tx.hash}">view on BscScan</a>`);
    await tx.wait();
    notify("Minted","Certificate minted successfully!","good","fa-certificate");
    btnMint && (btnMint.innerHTML = '<i class="fa-solid fa-circle-check"></i> Minted');
    if(typeof confetti==="function"){
      confetti({particleCount:160, spread:70, origin:{y:.7}, colors:["#00eaff","#ff3bff","#9333ff"]});
    }
  }catch(e){
    console.error("[mint]", e);
    notify("Mint Failed", e?.data?.message || e?.reason || e?.message || "Unknown error", "bad", "fa-circle-xmark");
    btnMint && (btnMint.disabled=false, btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate');
  }
}

/* ==============================
   CONTENT RENDERERS
============================== */
function renderMenus(){
  if(!Array.isArray(modules)) return;
  const groups = { Beginner:[], Master:[], Right:[] };
  modules.forEach(m => groups[m.level]?.push(m));

  const mkBtn = (m)=> {
    const b = document.createElement("button");
    b.innerHTML = `<i class="fa-solid fa-book-open"></i> ${m.num}. ${m.title}`;
    b.onclick = ()=> openModule(m.id, true);
    if(opened===m.id) b.classList.add("active");
    return b;
  };

  if(menuBeginner) menuBeginner.innerHTML = "";
  if(menuMaster)   menuMaster.innerHTML   = "";
  if(menuRight)    menuRight.innerHTML    = "";

  groups.Beginner.forEach(m => menuBeginner?.appendChild(mkBtn(m)));
  groups.Master.forEach(m   => menuMaster?.appendChild(mkBtn(m)));
  groups.Right.forEach(m    => menuRight?.appendChild(mkBtn(m)));
}

function renderAccordion(){
  if(!accordionRoot) return;
  accordionRoot.innerHTML = "";

  (modules||[]).forEach(m => {
    const acc = document.createElement("div");
    acc.className = "acc";
    if(opened===m.id) acc.classList.add("open");

    const sum = document.createElement("div");
    sum.className = "acc-sum";
    sum.innerHTML = `
      <div class="left">
        <div class="num">${m.num}</div>
        <div><strong>${m.title}</strong><br><small>${m.level}</small></div>
      </div>
      <button class="btn btn-ghost" aria-label="Mark complete"><i class="fa-solid fa-check"></i></button>
    `;

    const body = document.createElement("div");
    body.className = "acc-body";
    body.innerHTML = (m.sections||[]).map(s => `
      <h4 style="margin:12px 0 6px">${s.label}</h4>
      <div>${s.html}</div>
    `).join("");

    sum.addEventListener("click", (e)=>{
      if(e.target.closest("button")) return; // prevent toggle when clicking "complete"
      opened = (opened===m.id)? null : m.id;
      localStorage.setItem("kly_open_neon", opened || "");
      renderAccordion();
    });

    // Mark complete
    sum.querySelector("button")?.addEventListener("click", (e)=>{
      e.stopPropagation();
      markComplete(m.id);
    });

    acc.appendChild(sum);
    acc.appendChild(body);
    accordionRoot.appendChild(acc);
  });
}

function openModule(id, scrollIntoView=false){
  opened = id;
  localStorage.setItem("kly_open_neon", opened || "");
  renderMenus();
  renderAccordion();
  if(scrollIntoView){
    accordionRoot?.querySelector(".acc.open")?.scrollIntoView({behavior:"smooth", block:"start"});
  }
}

/* ==============================
   EVENT WIRING
============================== */
btnMint && btnMint.addEventListener("click", mint);

if(btnRedeem)  btnRedeem.addEventListener("click", ()=> redeemInvite(inviteInput?.value));
if(btnRedeem2) btnRedeem2.addEventListener("click",()=> redeemInvite(inviteInput2?.value));

/* Optional: preload WC so QR opens instantly on desktop */
window.addEventListener("load", async ()=>{
  try { await ensureWalletConnectUMD(); } catch (e) { console.warn("WC preload failed", e); }
  // If modules were defined later via window.modules, rebuild UI now
  modules = window.modules || modules || [];
  TOTAL_MODULES = modules.length || TOTAL_MODULES;
  renderMenus();
  renderAccordion();
  updateProgress();
});
  
/* ==============================
   LESSON CONTENT
============================== */
const M = (id, level, num, title, sections) => ({id, level, num, title, sections});

// Assign to existing variable instead of redeclaring it
modules = [
  /* =========================
     BEGINNER 1–5
  ========================= */
  M("module1","Beginner",1,"DeFi Basics",[
    {label:"What You’ll Learn", html:`<ul>
      <li>What decentralized finance is <em>and isn’t</em>.</li>
      <li>How blockchains, smart contracts, DAOs, and dApps fit together.</li>
      <li>Why self-custody flips the incentives.</li></ul>`},

    {label:"DeFi Map (30s Overview)", html:`<div class="two">
      <div class="callout"><strong>Users</strong> ↔ <strong>dApps</strong> ↔ <strong>Smart Contracts</strong> on a <strong>Blockchain</strong><br>Money Legos = contracts that compose (DEX ↔ lending ↔ vaults).</div>
      <div class="callout"><strong>Key Properties</strong><br>Permissionless, transparent, programmable, global 24/7 settlement.</div>
    </div>`},

    {label:"Core Definitions", html:`<ul>
      <li><strong>Blockchain:</strong> append-only ledger secured by consensus.</li>
      <li><strong>Smart Contract:</strong> code that holds assets & enforces rules.</li>
      <li><strong>dApp:</strong> interface that calls contract functions.</li>
      <li><strong>DAO:</strong> on-chain governance using tokens/votes.</li>
      <li><strong>Self-custody:</strong> you control the private key → you control funds.</li></ul>`},

    {label:"How a Transaction Flows", html:`<ol>
      <li>You sign a message with your wallet (private key).</li>
      <li>The tx hits nodes/mempool → validators order it into a block.</li>
      <li>Contract code executes (e.g., swap, lend) → state updates.</li>
      <li>Finality: after X blocks, reversal becomes economically infeasible.</li>
    </ol>`},

    {label:"Pitfalls to Avoid", html:`<ul>
      <li><strong>UI ≠ contract:</strong> bookmarks can be faked; verify contract address.</li>
      <li><strong>Approvals:</strong> “infinite allowance” can let contracts move tokens later.</li>
      <li><strong>Impersonation:</strong> fake support, fake airdrops, DM scams.</li></ul>`},

    {label:"Hands-On", html:`<ol>
      <li>Open <a target="_blank" rel="noopener" href="https://bscscan.com/">BscScan</a> and paste your wallet address → identify tokens & approvals.</li>
      <li>Write a one-sentence DeFi definition a friend would understand.</li>
      <li>List 3 differences between bank transfer vs DEX swap (custody, speed, transparency).</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>Which part actually holds your funds?</summary><p><strong>The smart contract or your wallet</strong> (via your private key). The UI never “holds” funds.</p></details>
    <details><summary>Why is composability powerful?</summary><p>Contracts can chain together like “money legos,” enabling new products without permission.</p></details>`},

    {label:"Resources", html:`<ul>
      <li><a target="_blank" rel="noopener" href="https://ethereum.org/en/defi/">ethereum.org/defi</a></li>
      <li><a target="_blank" rel="noopener" href="https://defillama.com/">DeFiLlama (TVL, chains, protocols)</a></li>
    </ul>`}
  ]),

  M("module2","Beginner",2,"Wallet Setup",[
    {label:"Objectives", html:`<ul>
      <li>Choose hot vs hardware wallets based on risk.</li>
      <li>Back up seed phrases correctly (and recover safely).</li>
      <li>Add BNB Chain + fund with BNB (gas) & KLY (access).</li></ul>`},

    {label:"Choosing a Wallet", html:`<div class="two">
      <div><ul>
        <li><strong>Hot wallet</strong> (MetaMask/Trust): daily ops, approvals, low balances.</li>
        <li><strong>Hardware wallet</strong> (Ledger/Trezor): long-term vault, large balances.</li>
      </ul></div>
      <div class="callout"><strong>Separation of concerns:</strong> run two wallets:
      <br>• <em>Approval wallet</em> for interacting with dApps.<br>• <em>Vault wallet</em> cold/hardware for storage.</div>
    </div>`},

    {label:"Backups & Recovery", html:`<ul>
      <li>Write seed on paper/metal. <strong>No screenshots/cloud.</strong></li>
      <li>Store in 2 locations; test a recovery on a spare device with no funds.</li>
      <li>Use a passphrase if supported; don’t reuse PINs.</li></ul>`},

    {label:"Add BNB Chain (MetaMask quick steps)", html:`<ol>
      <li>Settings → Networks → Add: Chain ID <code class="code">56</code>, RPC <code class="code">https://bsc-dataseed.binance.org/</code>, Explorer <code class="code">https://bscscan.com</code>.</li>
      <li>Fund a small amount of BNB for gas (e.g., $5–10 equivalent to start).</li>
      <li>Add KLY token by contract address so it displays in wallet.</li>
    </ol>`},

    {label:"Approval Hygiene", html:`<p>Before trying new dApps, set <em>custom spend limits</em> (not infinite). Monthly, revoke unused approvals with tools like revoke.cash.</p>`},

    {label:"Hands-On", html:`<ol>
      <li>Write your seed phrase (offline). Verify two words at random.</li>
      <li>Add BNB Chain; send a dust BNB amount from an exchange or friend.</li>
      <li>Connect to a known dApp <em>read-only</em> (don’t approve) and observe prompts.</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>Where should your seed phrase live?</summary><p>Offline only (paper/metal), never in photos or cloud.</p></details>
    <details><summary>Why two wallets?</summary><p>Limit blast radius. Approvals in a small hot wallet; savings in a hardware vault.</p></details>`}
  ]),

  M("module3","Beginner",3,"Using DEXs",[
    {label:"Objectives", html:`<ul>
      <li>Understand constant-product AMMs and routing.</li>
      <li>Execute safe swaps (slippage, gas, min received).</li>
      <li>Detect fake tokens and sandwich risk.</li></ul>`},

    {label:"AMM 101", html:`<p>AMMs keep reserves <code class="code">x</code> & <code class="code">y</code> for a pair; product <code class="code">x*y=k</code> stays constant. Your trade moves the price along the curve. More size ⇒ more price impact.</p>`},

    {label:"Safe-Swap Checklist", html:`<ul>
      <li><strong>Contract verification:</strong> add token via official link/contract, not by name.</li>
      <li><strong>Slippage:</strong> start 0.5–1.0% for liquid majors; raise only if needed.</li>
      <li><strong>Min received:</strong> verify before signing; avoid 0 if UI allows.</li>
      <li><strong>Route & price impact:</strong> prefer routes with deep liquidity.</li>
      <li><strong>Gas:</strong> set reasonable gas; avoid peak mempool spikes.</li>
    </ul>`},

    {label:"Sandwich Defense", html:`<p>Front-run risk grows with large orders and high slippage. Defenses: smaller splits, lower slippage, use aggregators with MEV protection where available.</p>`},

    {label:"Hands-On (No-Confirm)", html:`<ol>
      <li>On PancakeSwap, simulate 0.05 BNB → KLY. Record: route, slippage, expected output, min received.</li>
      <li>Open the pool page and inspect liquidity/reserve sizes.</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>If price impact shows 8%, what should you do?</summary><p>Split the order or find deeper liquidity; 8% is very high.</p></details>
    <details><summary>What does “min received” protect you from?</summary><p>Excessive slippage due to volatility/MEV; below that threshold, tx reverts.</p></details>`}
  ]),

  M("module4","Beginner",4,"Earning with DeFi",[
    {label:"Objectives", html:`<ul>
      <li>Compare staking, lending, and LP fees realistically.</li>
      <li>Estimate impermanent loss (IL) vs. rewards.</li>
      <li>Build a simple position-sizing rule.</li></ul>`},

    {label:"Yield Sources & Trade-offs", html:`<div class="two">
      <div><ul>
        <li><strong>Staking:</strong> Protocol rewards; lower variance; smart-contract & lockup risk.</li>
        <li><strong>Lending:</strong> Interest from borrowers; oracle/liquidation risks on some markets.</li>
        <li><strong>LP Fees:</strong> Earn swap fees; suffer IL if prices diverge.</li>
      </ul></div>
      <div class="callout"><strong>Reality Check:</strong> APR headlines ignore <em>reward token price risk</em> and gas. Evaluate in base currency.</div>
    </div>`},

    {label:"Impermanent Loss (intuition)", html:`<div class="code">IL ≈ 2√P/(1+P) − 1, where P = newPrice/oldPrice</div>
    <p>If one asset doubles (P≈2), IL ≈ 2√2/(3) − 1 ≈ 0.414 − 1 = −58.6% on that leg (pair level effect smaller). Fees/incentives must offset IL.</p>`},

    {label:"Position Sizing", html:`<ul>
      <li>Cap any single strategy at <strong>1–5%</strong> of portfolio until proven.</li>
      <li>Exit or rotate if incentives decay or TVL concentration rises.</li>
    </ul>`},

    {label:"Hands-On", html:`<ol>
      <li>Pick a pool (e.g., KLY/BNB). Note fee tier, volume, and TVL.</li>
      <li>Model 30 days: <em>fees ≈ volume × fee × your share / days</em>. Compare against two price paths (+20%, −20%).</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>High APR always good?</summary><p>No. Ask: who pays it, how long, in what token, and what risks (IL, emissions)?</p></details>
    <details><summary>Two assets diverge 50% in price. LP likely…</summary><p>Underperforms HODL unless fees/incentives offset IL.</p></details>`}
  ]),

  M("module5","Beginner",5,"Safety & Strategy",[
    {label:"Threat Model", html:`<ul>
      <li>Phishing: look-alike URLs, airdrop bait, “support” DMs.</li>
      <li>Malicious approvals: infinite allowances to shady contracts.</li>
      <li>Rugpulls: upgradeable proxies, owner-only mint/withdraw.</li>
    </ul>`},

    {label:"Protection Playbook", html:`<ul>
      <li>Bookmark official links; verify contracts; use read-only first.</li>
      <li>Hardware wallet for vault funds; hot wallet for approvals.</li>
      <li>Monthly approval review (revoke.cash / BscScan approvals).</li>
      <li>Alert words: “urgent,” “send seed,” “connect to claim.”</li>
    </ul>`},

    {label:"Tactical Routine", html:`<div class="two">
      <div><strong>Before a tx</strong><ul>
        <li>Check contract on explorer (source verified? renounced?</li>
        <li>Review what the signature allows (spender/amount).</li>
      </ul></div>
      <div><strong>Weekly</strong><ul>
        <li>Note P&L and exposures; trim outliers.</li>
        <li>Back up fresh addresses + notes in a password manager.</li>
      </ul></div>
    </div>`},

    {label:"Hands-On", html:`<ol>
      <li>Revoke one unused token approval now.</li>
      <li>Create a 3-line checklist you’ll run <em>every</em> time you approve.</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>Support asks for your seed to help. Respond?</summary><p>It’s a scam. No legitimate service needs your seed phrase—ever.</p></details>
    <details><summary>Why separate “approval” wallet?</summary><p>To limit damage if a contract turns malicious or is exploited.</p></details>`}
  ]),

  /* =========================
     MASTER 1–7
  ========================= */
  M("mdf-1","Master",1,"Sovereign Mindset",[
    {label:"Objectives", html:`<ul>
      <li>Move from reacting to <em>rules-based</em> operating.</li>
      <li>Replace external validation with written theses.</li>
      <li>Install lightweight review rituals.</li></ul>`},

    {label:"Patterns → Reframes", html:`<div class="two">
      <div class="callout"><strong>Chasing Pumps → Rules</strong><br>Define entry/invalidations, max loss, time-stop before you buy.</div>
      <div class="callout"><strong>Noise → Thesis</strong><br>Each position needs 3 bullets: why now, key risk, exit trigger.</div>
    </div>`},

    {label:"Daily/Weekly Ritual", html:`<ul>
      <li><strong>AM:</strong> 3-minute breath + top 1 objective.</li>
      <li><strong>PM:</strong> 3 wins + 1 improvement.</li>
      <li><strong>Weekly:</strong> KPI review (win-rate, avg R multiple, adherence).</li>
    </ul>`},

    {label:"Exercise", html:`<p>Write 5 money beliefs. Tag Scarcity/Sovereign. Rewrite each as a concrete operating rule (e.g., “Risk ≤ 1% per idea”).</p>`}
  ]),

  M("mdf-2","Master",2,"Blockchain & Tokenomics",[
    {label:"Objectives", html:`<ul>
      <li>Understand PoS security budgets & validator decentralization.</li>
      <li>Read token standards (ERC-20/721/1155) at a glance.</li>
      <li>Assess emissions, unlocks, and utility flows.</li></ul>`},

    {label:"Due Diligence Grid", html:`<ul>
      <li><strong>Code:</strong> verified? proxy/upgradeable? timelocks? admin multisig?</li>
      <li><strong>Supply:</strong> total, circulating, emission schedule, unlock cliffs.</li>
      <li><strong>Utility:</strong> fee sinks, staking rights, governance, real demand.</li>
      <li><strong>On-chain use:</strong> fees, active users, TVL trend, retention.</li>
    </ul>`},

    {label:"Token Standards (cheatsheet)", html:`<ul>
      <li><strong>ERC-20:</strong> fungible balanceOf/transfer/approve.</li>
      <li><strong>ERC-721:</strong> unique tokenId → ownerOf; metadata URI.</li>
      <li><strong>ERC-1155:</strong> batch-friendly semi-fungible; gas efficient for sets.</li>
    </ul>`},

    {label:"Hands-On", html:`<ol>
      <li>On BscScan, open any token → note total supply, top-10 % concentration, recent transfers.</li>
      <li>Draw a 12-month unlock chart; mark potential supply shocks.</li>
    </ol>`},

    {label:"Mini-Quiz", html:`<details><summary>Why can proxies be risky?</summary><p>Upgrades by admins can change logic; need timelocks, multisig, and transparency.</p></details>
    <details><summary>Best single metric?</summary><p>No silver bullet—triangulate: usage, supply, security, incentives.</p></details>`}
  ]),

  M("mdf-3","Master",3,"Wealth via Ecosystems",[
    {label:"Objectives", html:`<ul>
      <li>Pick one ecosystem where you’ll compound skill + network.</li>
      <li>Choose your role: Holder, LP, or Contributor.</li>
      <li>Define compounding KPIs.</li></ul>`},

    {label:"Flywheel", html:`<p>Use → Earn → Reinvest → Vote → Improve → Repeat. The earlier you embed, the more you benefit from network effects.</p>`},

    {label:"Security Layout", html:`<ul>
      <li>Hot wallet (ops), hardware (vault), approval wallet (experiments).</li>
      <li>Monthly revoke cadence; quarterly threat review.</li>
    </ul>`},

    {label:"Hands-On", html:`<p>Pick one protocol. Write a 1-paragraph usage thesis and 3 KPIs (e.g., fees earned, proposals voted, PRs merged). Set monthly checkpoints.</p>`}
  ]),

  M("mdf-4","Master",4,"DeFi Mastery",[
    {label:"Objectives", html:`<ul>
      <li>Group strategies by risk band.</li>
      <li>Model IL vs fee APR quickly.</li>
      <li>Automate compounding without overexposure.</li></ul>`},

    {label:"Playbook", html:`<ul>
      <li><strong>Low risk:</strong> blue-chip staking/lending.</li>
      <li><strong>Medium:</strong> stable/major LPs with real volume.</li>
      <li><strong>High:</strong> incentive-heavy farms, volatile pairs.</li>
    </ul>`},

    {label:"Math Snippet", html:`<div class="code">Net APR ≈ Fee APR + Incentives − IL − Gas − Slippage drag</div>
    <p>Track in base currency. If Net APR ≈ 0 or negative, rotate.</p>`},

    {label:"Hands-On", html:`<ol>
      <li>Take one pool; compute Fee APR from 7-day volume & fee tier.</li>
      <li>Run three price paths (+20/0/−20%) and check IL vs fees.</li>
    </ol>`}
  ]),

  M("mdf-5","Master",5,"NFTs as Wealth Vehicles",[
    {label:"Objectives", html:`<ul>
      <li>Differentiate collectible/brand vs utility/access NFTs.</li>
      <li>Design mint, royalties, and on-chain perks.</li>
      <li>Assess liquidity quality (not just spikes).</li></ul>`},

    {label:"Utility Matrix", html:`<ul>
      <li><strong>Access:</strong> token-gated courses, events, allowlists.</li>
      <li><strong>Identity/Credentials:</strong> provable achievements/skills (SBTs).</li>
      <li><strong>Revenue alignment:</strong> points/royalties where compliant.</li>
    </ul>`},

    {label:"Market Hygiene", html:`<ul>
      <li>Holder distribution (avoid mega-whales dominating supply).</li>
      <li>Wash trading signs (loop wallets, abnormal bid/ask churn).</li>
      <li>Volume stability; community retention over hype spikes.</li>
    </ul>`},

    {label:"Hands-On", html:`<p>Create a one-pager: purpose, supply, mint price, royalty %, allowlist criteria, utility roadmap, and 90-day post-mint plan.</p>`}
  ]),

  M("mdf-6","Master",6,"Multiple Web3 Income Streams",[
    {label:"Objectives", html:`<ul>
      <li>Design 3–5 lanes (freelance, grants/DAOs, education, analytics).</li>
      <li>Set prospecting & delivery loops.</li>
      <li>Track revenue, costs, and pipeline.</li></ul>`},

    {label:"Lanes & Loops", html:`<div class="two">
      <div><ul>
        <li><strong>Freelance/Bounties:</strong> weekly pitches, public artifacts.</li>
        <li><strong>DAO Ops/Grants:</strong> proposals with measurable deliverables.</li>
        <li><strong>Education:</strong> paid guides, token-gated cohorts.</li>
      </ul></div>
      <div class="callout"><strong>Offer Formula:</strong> Problem → Specific Outcome → Proof → Price → Next step.</div>
    </div>`},

    {label:"Hands-On", html:`<ol>
      <li>Draft a one-page offer. Include 2 proof points (links or metrics).</li>
      <li>Send 5 targeted pitches; log responses and iterate copy.</li>
    </ol>`}
  ]),

  M("mdf-7","Master",7,"Sovereign Wealth Strategy",[
    {label:"Objectives", html:`<ul>
      <li>Draft a 5-year plan with core/satellite/venture buckets.</li>
      <li>Implement protection & recovery (hardware, multisig, estate basics).</li>
      <li>Install weekly/monthly/quarterly cadences.</li></ul>`},

    {label:"Allocation Frame", html:`<ul>
      <li><strong>Core:</strong> BTC/ETH/majors (conviction, long horizon).</li>
      <li><strong>Satellite:</strong> select L2/DeFi strategies.</li>
      <li><strong>Venture:</strong> experiments/early bets.</li>
    </ul>`},

    {label:"Protection", html:`<ul>
      <li>Hardware wallets + metal backups; test recovery annually.</li>
      <li>Threshold multisig for treasuries; role separation.</li>
      <li>Estate notes: access instructions, beneficiaries, encrypted vault.</li>
    </ul>`},

    {label:"Cadence", html:`<ul>
      <li><strong>Weekly:</strong> dashboard review, notes, cleanup approvals.</li>
      <li><strong>Monthly:</strong> rebalance & thesis refresh.</li>
      <li><strong>Quarterly:</strong> premortem (what could break?) + tax prep.</li>
    </ul>`},

    {label:"Hands-On", html:`<p>Write a 1-page plan: targets, allocation bands, rebalance rules, security steps. Do a seed recovery simulation and verify balances.</p>`}
  ])
];

  /* ==============================
   RIGHT KNOWLEDGE — Wisdom-first Restructure
   Facts → Evidence → Wisdom → Overstanding → Debates → Sources
============================== */
const RK = (num, title, sections)=> M(`rk-${num}`, "Right", num, title, sections);

// Remove any old RK modules to avoid duplicates (optional hard reset)
for(let i=modules.length-1;i>=0;i--){ if(String(modules[i].id).startsWith("rk-")) modules.splice(i,1); }

/* RK-1 — Epistemic Operating System */
modules.push(
RK(1, "Epistemic OS: From Facts to Wisdom", [
  {label:"Facts (verified)", html:`<ul>
    <li><strong>Belief ≠ Knowledge:</strong> knowledge requires justification beyond belief (see Gettier problem).</li>
    <li><strong>Right Knowledge</strong>= empirical (observable/testable), logical (non-contradictory), and practical (predictive/useful).</li>
    <li>Unproven claims belong in a neutral <em>Pending File</em> until verified.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Analysis of knowledge — <a href="https://plato.stanford.edu/entries/knowledge-analysis/" target="_blank" rel="noopener">Stanford Encyclopedia</a></li>
    <li>Gettier problem — <a href="https://iep.utm.edu/gettier/" target="_blank" rel="noopener">IEP summary</a></li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<div class="callout"><strong>3 Rules:</strong> 1) Verify before you echo. 2) Label uncertainty (“Pending”). 3) Track predictions; keep score.</div>
  <ul><li><strong>Cui bono?</strong> Always ask: who benefits if I accept this?</li><li>Separate primary sources from commentary.</li></ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Pick one strong opinion. Write what would disconfirm it (falsifier).</li>
    <li>Classify its status: True / False / Pending (why?).</li>
  </ol>`},
  {label:"Debates", html:`<p>Whether knowledge must be “justified true belief” is debated; modern views add reliability, safety, or virtue-epistemology layers.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Stanford Encyclopedia — Knowledge analysis; Gettier.</li>
      <li>IEP — Gettier overview.</li>
    </ul>
  </details>`}
]));

/* RK-2 — Bioenergetics & Melanin */
modules.push(
RK(2, "Bioenergetics & Melanin (what science actually shows)", [
  {label:"Facts (verified)", html:`<ul>
    <li>Eumelanin = <strong>broadband UV–visible absorber</strong> with ultra-fast nonradiative decay → photoprotection; radical scavenger.</li>
    <li>Protection is real but limited (roughly SPF ~1.5–4). Sun behavior still matters.</li>
    <li>Melanin has redox/photothermal properties under active research.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Brenner & Hearing 2008 (melanogenesis & photoprotection) — NIH/PMC</li>
    <li>Solano 2020 (melanin biochemistry review) — MDPI</li>
    <li>Grieco 2023 (photophysics) — Wiley</li>
    <li>Fajuyigbe & Young 2016 (photoprotection nuances) — NIH/PMC</li>
    <li>Nature Comms 2020 (photothermal) — Nature</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Prefer peer-reviewed, mechanism-level claims over viral anecdotes.</li>
    <li>Keep “mystical” or extraordinary claims in Pending until measured.</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Read one abstract (above). Write: what was measured? method? limits?</li>
    <li>Set a safe light routine today (shade, sunscreen, hydration) and note outcomes.</li>
  </ol>`},
  {label:"Debates", html:`<p>Human hair as an EM antenna: interesting but evidence is preliminary; treat as unverified for humans pending better studies.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Brenner & Hearing 2008 — <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2671032/" target="_blank" rel="noopener">PMC</a></li>
      <li>Solano 2020 — <a href="https://www.mdpi.com/1420-3049/25/7/1537" target="_blank" rel="noopener">MDPI</a></li>
      <li>Grieco 2023 — <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/php.13731" target="_blank" rel="noopener">Wiley</a></li>
      <li>Fajuyigbe & Young 2016 — <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5132026/" target="_blank" rel="noopener">PMC</a></li>
      <li>Nature Comms 2020 — <a href="https://www.nature.com/articles/s41467-020-18393-w" target="_blank" rel="noopener">Nature</a></li>
    </ul>
  </details>`}
]));

/* RK-3 — Time Systems & Historical Frames */
modules.push(
RK(3, "Time Systems & Historical Frames", [
  {label:"Facts (verified)", html:`<ul>
    <li>Gregorian reform (1582) corrected Julian drift by skipping 10 days; new rule: century years leap only if divisible by 400.</li>
    <li>Adoption was staggered across countries → mixed “time regimes.”</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Britannica — Gregorian calendar overview</li>
    <li>Wired — explainer on skipped days</li>
    <li>Prussian schooling/system aims — UCSD study summary; overview pages</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Calendars are power tools; whoever sets time frames sets narratives.</li>
    <li>Use personal chronology (dates → decisions → consequences) to counter distortion.</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Mark your ancestors’ key dates; note when your country adopted Gregorian time.</li>
    <li>Write one decision you’d change if you measured time by cycles (weekly/lunar).</li>
  </ol>`},
  {label:"Debates", html:`<p>Afrocentric claims (e.g., Olmec heads as African) vs. Mesoamerican consensus (local rulers). Label claim vs. consensus clearly.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Britannica — Gregorian calendar.</li>
      <li>Wired — skipped days explainer.</li>
      <li>UCSD — schooling aims study summary.</li>
      <li>Dumbarton Oaks — Olmec art corpus.</li>
    </ul>
  </details>`}
]));

/* RK-4 — Language & Symbolic Power */
modules.push(
RK(4, "Language & Symbolic Power", [
  {label:"Facts (verified)", html:`<ul>
    <li>English “God” is Germanic (OE <em>god</em> ← Proto-Germanic *<em>gudą</em>), likely from PIE “to invoke/call”; not from “good.”</li>
    <li>mdw-nṯr (Medu Neter) often glossed “divine words/speech”; <em>netjer</em> for deity/divine force (semantics vary across Egyptology).</li>
    <li>English is hybrid (Norse/Norman/Latin), enabling puns & “spelling” rhetoric.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Etymology of “god” — Etymonline, overviews</li>
    <li>Netjer/Medu Neter entries — Encyclopedia sources (with caveats on old summaries)</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Separate <em>etymology</em> (word history) from <em>doctrine</em> (belief content).</li>
    <li>Beware sound-alike traps across languages; phonetics ≠ shared meaning.</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Pick 2 sacred names across languages; write verified etymologies and modern meanings—see where shifts occurred.</li>
  </ol>`},
  {label:"Debates", html:`<p>Budge’s translations are historic but dated; modern Egyptology revises meanings via newer philology.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Etymonline — “god”.</li>
      <li>Encyclopedia.com — Netjer terminology; Budge (with modern caveats).</li>
    </ul>
  </details>`}
]));

/* RK-5 — Divine Purpose (you asked to swap Astral → Purpose) */
modules.push(
RK(5, "Divine Purpose", [
  {label:"Facts (verified)", html:`<ul>
    <li><strong>Purpose</strong> in psychology: stable intention beyond the self; predicts lower mortality and better health behaviors.</li>
    <li>Purpose links to autonomy/competence/relatedness (Self-Determination Theory), boosting well-being vs. extrinsic goals.</li>
    <li>Narrative identity coherence correlates with purpose and adaptive functioning.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Hill & Turiano 2014 — mortality & purpose (Psychological Science)</li>
    <li>Alimujiang et al. 2019 — JAMA Net Open (older adults)</li>
    <li>Deci & Ryan 2000 — SDT</li>
    <li>McAdams & McLean 2013 — narrative identity</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Values → Purpose themes → Long goals → Near projects → If-then plans.</li>
    <li>Purpose that benefits others sustains energy and resilience.</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Write one purpose line: “I build ___ for ___.”</li>
    <li>Create one if-then: “If it’s 9am, then I draft 10 minutes on ___.”</li>
  </ol>`},
  {label:"Debates", html:`<p>“Divine” framing varies by tradition; the measurable piece (health, persistence) is supported in psychology irrespective of theology.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Hill & Turiano (2014); Alimujiang et al. (2019); Deci & Ryan (2000); McAdams & McLean (2013).</li>
    </ul>
  </details>`}
]));

/* RK-6 — Source Hygiene & Contested Claims */
modules.push(
RK(6, "Source Hygiene & Contested Claims (Dogon, Sirius, etc.)", [
  {label:"Facts (verified)", html:`<ul>
    <li>Dogon-Sirius B extraordinary claim was not replicated in later fieldwork (van Beek 1991) → treat as unproven without primary data.</li>
    <li>Right Knowledge rule: extraordinary claims need primary sources + replication.</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>van Beek 1991 — Dogon restudied (PDF)</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Separate mythic truth (meaning) from historical fact (evidence) but value both—just label them.</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Pick one viral claim. Find the earliest primary source; if none, classify as legend/story—don’t teach as fact.</li>
  </ol>`},
  {label:"Debates", html:`<p>Popular books vs. ethnographic skepticism; hold “Pending” unless primary data is produced.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul><li><a href="https://pure.uvt.nl/ws/portalfiles/portal/1002365/dogonrestudied.pdf" target="_blank" rel="noopener">van Beek 1991 PDF</a></li></ul>
  </details>`}
]));

/* RK-7 — Sovereign Decision Frameworks */
modules.push(
RK(7, "Sovereign Decision Frameworks (turn knowledge into choices)", [
  {label:"Facts (verified)", html:`<ul>
    <li><strong>Checklists</strong> reduce errors in complex domains (medicine/aviation research).</li>
    <li><strong>Premortems</strong> (Gary Klein): imagine failure first → plan mitigations.</li>
    <li><strong>Implementation intentions</strong> (“if-then” plans) increase follow-through (Gollwitzer).</li>
  </ul>`},
  {label:"Evidence (quick links)", html:`<ul>
    <li>Gawande — checklists; randomized evidence in safety domains.</li>
    <li>Gollwitzer 1999 — implementation intentions (American Psychologist).</li>
  </ul>`},
  {label:"Wisdom Core (principles)", html:`<ul>
    <li>Document your rules once; reuse for faster, safer choices.</li>
    <li>Bias-proof with “red team” prompts: What would prove me wrong fast?</li>
  </ul>`},
  {label:"Overstanding (apply in 5 minutes)", html:`<ol>
    <li>Create a 6-line approval checklist (who/what/spend limit/risks/exit/confirm).</li>
    <li>Write one if-then that executes your purpose daily.</li>
  </ol>`},
  {label:"Debates", html:`<p>Rigid rules vs. flexible judgment; best practice is <em>minimal</em> rules + periodic review.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Gollwitzer (1999) implementation intentions.</li>
      <li>Safety/quality improvement literature on checklists (e.g., WHO surgical checklist).</li>
    </ul>
  </details>`}
]));

/* BONUS — Myths & Returns (Labeling Meaning vs. Fact) */
modules.push(
M("rk-bonus","Right",8,"⚡ Myths of Return & Cycles (label meaning vs. fact)",[
  {label:"Facts (verified vs. narrative)", html:`<ul>
    <li><strong>Anunnaki</strong> = deities in Sumerian/Akkadian texts (scholarly corpus); “ancient aliens/Nibiru” claims are modern reinterpretations, not consensus.</li>
  </ul>`},
  {label:"Wisdom Core", html:`<p>Myths carry meaning; Right Knowledge labels what is evidence vs. symbolism so both can instruct without confusion.</p>`},
  {label:"Sources", html:`<details class="sources"><summary>Show sources</summary>
    <ul>
      <li>Britannica — Anunnaki summary; NASA-linked outreach on Nibiru debunking (Morrison 2010).</li>
    </ul>
  </details>`}
])
);

(function finalizeModules(){
  try{
    TOTAL_MODULES = (typeof modules !== "undefined" ? modules.length : TOTAL_MODULES);
  }catch{}
})();

/* ==============================
   INIT
============================== */
function initUI(){
  renderMenus();
  renderAccordion();
  updateProgress();
  if (modules && modules[0]) openModule(opened || modules[0].id, false);

  const y = el("year");
  if (y) y.textContent = new Date().getFullYear();

  // Restore invite access on load
  if (inviteUnlocked && curriculumWrap) {
    curriculumWrap.classList.remove('locked');
  }

  // A11y: toast announces updates
  if (toast) {
    toast.setAttribute("role","status");
    toast.setAttribute("aria-live","polite");
  }
}

// Bind events (guarded) — use GLOBAL versions
btnConnect        && btnConnect.addEventListener("click", window.connect);
btnDisconnect     && btnDisconnect.addEventListener("click", window.disconnect);
btnOverlayConnect && btnOverlayConnect.addEventListener("click", window.connect);
btnMint           && btnMint.addEventListener("click", mint);
btnRedeem         && btnRedeem.addEventListener("click", ()=> redeemInvite(inviteInput?.value));
btnRedeem2        && btnRedeem2.addEventListener("click", ()=> redeemInvite(inviteInput2?.value));
btnAbout          && btnAbout.addEventListener("click", ()=> { if (modal) modal.style.display="block"; });
modalClose        && modalClose.addEventListener("click", ()=> { if (modal) modal.style.display="none"; });

window.addEventListener("beforeunload", ()=> {
  if (opened) localStorage.setItem("kly_open_neon", opened);
});

window.addEventListener("load", async ()=>{
  initUI();
  // Optional: preload WC UMD so QR opens instantly on desktop.
  // (Do NOT call makeWCProvider here; we only initialize WC when needed.)
  try { await ensureWalletConnectUMD(); } catch (e) { console.warn("WC preload failed", e); }
});
</script>
</body>
</html>
