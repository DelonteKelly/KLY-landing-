<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#060713"/>
  <title>KLY Academy — DeFi Neon</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Motion & FX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Web3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      /* Neon palette */
      --bg:#060713; --bg2:#0a0c1f;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --border:rgba(132,255,255,.18);
      --txt:#E9EEFF; --muted:#B9C3E5;
      --cyn:#00eaff; --pnk:#ff3bff; --vio:#9333ff; --sun:#ffb300; --lime:#00ff95;
      --danger:#ff3d3d;
      --glow-cyn:0 0 24px rgba(0,234,255,.35);
      --glow-pnk:0 0 24px rgba(255,59,255,.35);
      --glow-vio:0 0 24px rgba(147,51,255,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(0,234,255,.08), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(255,59,255,.08), transparent 60%),
        linear-gradient(180deg,#050611,#0a0c1f 60%, #07081a);
      overflow-x:hidden;
    }
    a{color:var(--cyn); text-decoration:none}
    a:hover{opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(1.2);
      background:linear-gradient(180deg, rgba(6,7,19,.85), rgba(6,7,19,.55));
      border-bottom:1px solid var(--border);
      box-shadow:var(--glow-cyn);
    }
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:12px;font-family:"Space Grotesk",Inter}
    .brand i{font-size:22px;color:var(--cyn);filter:drop-shadow(0 0 8px rgba(0,234,255,.6))}
    .brand .text{font-weight:800;letter-spacing:.6px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--muted);font-size:13px;box-shadow:0 0 0 1px rgba(147,51,255,.15), var(--glow-vio)}
    .btn{
      border:1px solid var(--border);color:var(--txt);
      background:linear-gradient(90deg, rgba(0,234,255,.18), rgba(255,59,255,.18));
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center;
      box-shadow:var(--glow-cyn);transition:transform .2s, box-shadow .2s
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--glow-pnk)}
    .btn-ghost{background:transparent}
    /* Hero */
    .grid-hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:20px}
    @media (max-width:1100px){ .grid-hero{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); padding:24px; box-shadow:var(--glow-cyn);
    }
    h1{margin:0 0 10px;font-family:"Space Grotesk";font-size:36px}
    .grad{background:linear-gradient(90deg,var(--cyn),var(--pnk));-webkit-background-clip:text;background-clip:text;color:transparent}
    p{color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .stat{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);display:flex;gap:10px;align-items:center}
    .stat i{color:var(--cyn);text-shadow:0 0 10px rgba(0,234,255,.7)}
    /* KPI ring */
    .ring{--p:0;--size:90px;width:var(--size);height:var(--size);border-radius:50%;background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--cyn) var(--p), #202442 0);position:relative}
    .ring::before{content:attr(data-label);position:absolute;inset:8px;border-radius:50%;display:grid;place-items:center;color:#a8f9ff;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
    /* Main grid */
    .grid-main{display:grid;grid-template-columns:300px 1fr 320px;gap:18px;margin-top:18px}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }
    /* Sidebar */
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:54px;height:54px;border-radius:50%;display:grid;place-items:center;font-weight:800;background:
      radial-gradient(circle at 30% 30%, #fff3, #0000 40%),
      linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .addr{font-family:ui-monospace,monospace;color:var(--muted);font-size:13px}
    .menu{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .menu button{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.03);color:var(--txt);text-align:left;cursor:pointer;display:flex;gap:10px;align-items:center}
    .menu button.active{box-shadow:var(--glow-pnk)}
    .badge{margin-left:auto;background:linear-gradient(90deg,var(--pnk),var(--vio));padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
    /* Lessons */
    .acc{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04)}
    .acc + .acc{margin-top:12px}
    .acc-sum{display:flex;justify-content:space-between;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
    .acc-sum .left{display:flex;gap:12px;align-items:center}
    .num{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:linear-gradient(135deg,var(--cyn),var(--pnk));box-shadow:var(--glow-cyn)}
    .acc-body{display:none;padding:0 16px 16px}
    .acc.open .acc-body{display:block}
    .callout{border-left:3px solid var(--cyn);background:rgba(0,234,255,.08);padding:12px;border-radius:0 12px 12px 0;margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .code{
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#a5ffcf;
      background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.25));
      border:1px solid rgba(0,255,149,.25); border-radius:10px; padding:10px; box-shadow:0 0 12px rgba(0,255,149,.1);
      overflow:auto
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .btn-mark{background:linear-gradient(90deg,var(--cyn),var(--pnk));border:0;color:#06101a;border-radius:10px;padding:10px 14px;font-weight:800}
    /* Certificate */
    .cert-img{border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--glow-vio)}
    .cert-img img{display:block;width:100%}
    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:60;padding:14px 16px;border:1px solid var(--border);border-left:4px solid var(--cyn);border-radius:14px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);display:flex;gap:10px;align-items:flex-start;box-shadow:var(--glow-cyn)}
    .toast .x{background:transparent;border:0;color:var(--muted);cursor:pointer}
    .toast.good{border-left-color:var(--lime)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--sun)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <i class="fa-solid fa-graduation-cap"></i>
        <div class="text">KLY ACADEMY</div>
        <span class="chip"><i class="fa-regular fa-circle-check"></i> DeFi Neon Track</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="chip-progress" class="chip"><i class="fa-solid fa-chart-simple"></i> <span id="chip-text">0/12 Complete</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <span id="pill-addr" class="chip" hidden><i class="fa-solid fa-user-astronaut"></i> <span id="addr-short">0x…</span></span>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <section class="grid-hero">
      <div class="card animate__animated animate__fadeInUp">
        <h1><span class="grad">Own</span> the Future of Finance</h1>
        <p>Learn DeFi the right way: first principles + hands-on practice. Finish the modules and mint your on-chain certificate.</p>
        <div class="mini">
          <div class="stat"><i class="fa-solid fa-shield-halved"></i><div><strong>Self-Custody</strong><br><small>Keys stay with you</small></div></div>
          <div class="stat"><i class="fa-solid fa-bolt"></i><div><strong>Action-based</strong><br><small>Do, not just read</small></div></div>
          <div class="stat"><i class="fa-solid fa-certificate"></i><div><strong>Proof</strong><br><small>NFT certificate</small></div></div>
        </div>
      </div>
      <div class="card animate__animated animate__fadeInUp" style="--animate-delay:.06s">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Access Gate</h3>
          <div class="ring" id="ring" data-label="0%"></div>
        </div>
        <p class="muted">You need <strong>≥ 100 KLY</strong> on <strong>BNB Chain</strong> to unlock the full course.</p>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-coins" style="color:var(--cyn)"></i>
          <div><div class="muted">Your KLY balance</div><strong id="kly-balance">—</strong></div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px">
          <i class="fa-solid fa-network-wired" style="color:var(--pnk)"></i>
          <div><div class="muted">Network</div><strong id="net-name">Not connected</strong></div>
        </div>
      </div>
    </section>

    <!-- Main -->
    <section class="grid-main">
      <!-- Sidebar -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px">
          <h3 style="margin:0">Profile</h3>
          <button id="btn-disconnect" class="btn btn-ghost" hidden><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        </div>
        <div class="profile">
          <div class="avatar" id="avatar">KA</div>
          <div>
            <div style="font-weight:800">Learner</div>
            <div id="addr-full" class="addr">Not connected</div>
          </div>
        </div>

        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="muted" style="margin-bottom:8px">Beginner</div>
          <div id="menu-beginner" class="menu"></div>
          <div class="muted" style="margin:16px 0 8px">Master</div>
          <div id="menu-master" class="menu"></div>
        </div>
      </aside>

      <!-- Lessons -->
      <main class="card">
        <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px"><h3 style="margin:0">Curriculum</h3></div>
        <div id="accordion"></div>
      </main>

      <!-- Certificate -->
      <aside class="card">
        <div style="border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px"><h3 style="margin:0">Certificate</h3></div>
        <div class="cert-img"><img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="KLY Certificate"></div>
        <p class="muted">Finish all modules to mint your NFT certificate.</p>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin:10px 0 14px">
          <div>Progress</div><strong id="cert-progress">0 / 12</strong>
          <div>Status</div><strong id="cert-status">Locked</strong>
        </div>
        <button id="btn-mint" class="btn" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
        <div id="mint-status" class="muted" style="margin-top:10px"></div>
      </aside>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" hidden>
    <i id="toast-icon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toast-title" style="font-weight:800;margin-bottom:4px">Info</div>
      <div id="toast-msg" class="muted">Message</div>
    </div>
    <button class="x" onclick="hideToast()"><i class="fa-solid fa-xmark"></i></button>
  </div>

<script>
/* ==============================
   CONFIG
============================== */
const KLY_TOKEN_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const NFT_CONTRACT_ADDRESS = "0xc1a2E9A475779EfD04247EA473638717E26cd5C5";
const KLY_TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const NFT_CONTRACT_ABI = [
  "function mintTo(address to, string uri) public"
];
const TOTAL_MODULES = 12;
const BSC = { idDec:56, idHex:"0x38", name:"BNB Smart Chain", rpc:"https://bsc-dataseed.binance.org/" };

/* ==============================
   STATE
============================== */
let web3Modal, provider, signer, account = null;
let completed = JSON.parse(localStorage.getItem("kly_completed_neon") || "[]");
let opened = null;

/* ==============================
   DOM
============================== */
const btnConnect = document.getElementById("btn-connect");
const btnDisconnect = document.getElementById("btn-disconnect");
const pillAddr = document.getElementById("pill-addr");
const addrShort = document.getElementById("addr-short");
const addrFull = document.getElementById("addr-full");
const avatar = document.getElementById("avatar");
const ring = document.getElementById("ring");
const klyBalanceEl = document.getElementById("kly-balance");
const netNameEl = document.getElementById("net-name");
const chipText = document.getElementById("chip-text");
const certProgress = document.getElementById("cert-progress");
const certStatus = document.getElementById("cert-status");
const btnMint = document.getElementById("btn-mint");
const mintStatus = document.getElementById("mint-status");
const toast = document.getElementById("toast");
const toastIcon = document.getElementById("toast-icon");
const toastTitle = document.getElementById("toast-title");
const toastMsg = document.getElementById("toast-msg");

/* ==============================
   LESSON CONTENT
   Each module has: title, level, num, sections[ {label, html} ]
============================== */
const M = (id, level, num, title, sections) => ({id, level, num, title, sections});

const modules = [
  // Beginner 1–5
  M("module1","Beginner",1,"DeFi Basics",[
    {label:"Objectives", html:`<ul>
      <li>Understand what DeFi is and why it matters</li>
      <li>Identify core building blocks (chains, contracts, DAOs, dApps)</li>
      <li>See how self-custody changes incentives</li></ul>`},
    {label:"Key Concepts", html:`<div class="two">
      <div><div class="callout"><strong>DeFi = Open Finance</strong><br/>Protocols are permissionless and composable; anyone can build on top.</div></div>
      <div><div class="callout"><strong>Self-Custody</strong><br/>“Not your keys, not your coins.” You own assets directly via private keys.</div></div>
    </div>`},
    {label:"Example", html:`<p>Sending 10 USDT on a DEX involves signing a transaction that moves funds from <em>your</em> address to a pool. No bank holds them for you.</p>`},
    {label:"Quick Exercise", html:`<ol>
      <li>Write <em>one sentence</em> defining DeFi for a friend.</li>
      <li>List 3 differences between a bank transfer and a DEX swap.</li></ol>`},
    {label:"Resources", html:`<ul>
      <li><a target="_blank" rel="noopener" href="https://ethereum.org/en/defi/">ethereum.org/defi</a></li>
      <li><a target="_blank" rel="noopener" href="https://defillama.com/">DeFiLlama TVL dashboards</a></li></ul>`}
  ]),
  M("module2","Beginner",2,"Wallet Setup",[
    {label:"Objectives", html:`<ul><li>Choose a wallet (hot vs hardware)</li><li>Secure your recovery phrase</li><li>Fund with BNB (gas) + KLY (access)</li></ul>`},
    {label:"Security First", html:`<div class="callout"><strong>Never</strong> store your seed phrase online or in screenshots. Use paper/metal backups & a safe place.</div>`},
    {label:"Steps", html:`<ol>
      <li>Install MetaMask/Trust from official site/app store</li>
      <li>Create wallet → write 12–24 words (offline)</li>
      <li>Add BNB Chain → fund with small BNB for gas</li>
      <li>Acquire KLY for course access</li></ol>`},
    {label:"Tip", html:`<p>Use a second “approval wallet” for dApps to limit exposure.</p>`}
  ]),
  M("module3","Beginner",3,"Using DEXs",[
    {label:"Objectives", html:`<ul><li>Understand AMMs</li><li>Execute a swap safely</li><li>Configure slippage & gas</li></ul>`},
    {label:"How AMMs Work", html:`<p>AMMs keep a pool of two tokens; the product <code class="code">x * y = k</code> stays constant. Your trade shifts the ratio, which sets price.</p>`},
    {label:"Swap Checklist", html:`<ul>
      <li>Verify token contract (official link)</li>
      <li>Set slippage (1–3% typical)</li>
      <li>Check price impact and route</li></ul>`},
    {label:"Exercise", html:`<p>Simulate swapping 0.1 BNB → KLY on PancakeSwap (no need to confirm). Note slippage and expected output.</p>`}
  ]),
  M("module4","Beginner",4,"Earning with DeFi",[
    {label:"Objectives", html:`<ul><li>Compare staking, lending, LP fees</li><li>Understand impermanent loss</li><li>Size positions prudently</li></ul>`},
    {label:"Yield Menu", html:`<div class="two"><div>
      <ul><li>Staking (lower variance)</li><li>Lending (supply to money markets)</li><li>LP (fees + incentives; IL risk)</li></ul>
    </div><div class="callout"><strong>Thumb Rule:</strong> Higher APY → higher risk. Diversify and cap position sizes.</div></div>`},
    {label:"Mini-Calc", html:`<div class="code">Real APY ≈ (rewards − gas − price drag) / capital</div>`}
  ]),
  M("module5","Beginner",5,"Safety & Strategy",[
    {label:"Threats", html:`<ul><li>Phishing & fake sites</li><li>Rugpulls</li><li>Malicious approvals (infinite allowance)</li></ul>`},
    {label:"Protection", html:`<ul><li>Bookmark official links</li><li>Use hardware wallet for vault funds</li><li>Revoke unused approvals monthly</li></ul>`},
    {label:"Exercise", html:`<p>Use an approval-revoke tool and clear at least one unused token allowance.</p>`}
  ]),

  /* MASTER 1–7 — expanded “real lesson” content */
  M("mdf-1","Master",1,"Sovereign Mindset",[
    {label:"Objectives", html:`<ul><li>Shift from consumer to owner-operator</li><li>Spot scarcity patterns</li><li>Install review rituals</li></ul>`},
    {label:"Patterns → Reframes", html:`<div class="two">
      <div class="callout"><strong>Chasing Pumps → Rules-Based Entries</strong><br/>Decide risk upfront: max loss, invalidation, time-stop.</div>
      <div class="callout"><strong>External Validation → Written Thesis</strong><br/>Buy/sell only for reasons documented beforehand.</div>
    </div>`},
    {label:"Daily Rituals", html:`<ul><li><strong>AM:</strong> 3-min breath + top 1 objective</li><li><strong>PM:</strong> 3 wins + 1 improvement</li></ul>`},
    {label:"Exercise", html:`<p>Write 5 money beliefs. Tag (Scarcity/Sovereign). Rewrite each in first-principles language.</p>`}
  ]),
  M("mdf-2","Master",2,"Blockchain & Tokenomics",[
    {label:"Objectives", html:`<ul><li>Understand consensus + security budgets</li><li>Read token standards</li><li>Evaluate emissions & utility</li></ul>`},
    {label:"Consensus", html:`<p>PoS relies on economic penalties (slashing). Validator decentralization and client diversity matter for resilience.</p>`},
    {label:"Token Standards", html:`<ul><li>ERC-20: <em>name, symbol, decimals, totalSupply</em></li><li>ERC-721: unique NFTs</li><li>ERC-1155: semi-fungible batches</li></ul>`},
    {label:"Due Diligence", html:`<ul><li>Contract verified? Proxy?</li><li>Token distribution & unlock schedule</li><li>On-chain usage trending up (fees, DAU, TVL)?</li></ul>`},
    {label:"Exercise", html:`<div class="code">Open a token on BscScan → record total supply, holders, top-10 %, recent transfers. Sketch a vesting curve.</div>`}
  ]),
  M("mdf-3","Master",3,"Wealth via Ecosystems",[
    {label:"Objectives", html:`<ul><li>Identify utility-first ecosystems</li><li>Choose your role (Holder/LP/Contributor)</li><li>Design a measurable plan</li></ul>`},
    {label:"Flywheel", html:`<p>Use → Earn → Reinvest → Vote → Improve utility → Repeat. Network effects compound over time.</p>`},
    {label:"Security Layout", html:`<ul><li>Hot wallet (ops), hardware (vault)</li><li>Separate approval wallet</li><li>Monthly revoke cadence</li></ul>`},
    {label:"Exercise", html:`<p>Pick one protocol. Write a 1-paragraph usage thesis, role chosen, and 3 KPIs (e.g., fees earned, proposals voted, issues closed).</p>`}
  ]),
  M("mdf-4","Master",4,"DeFi Mastery",[
    {label:"Objectives", html:`<ul><li>Compare yield strategies across risk bands</li><li>Quantify impermanent loss (IL)</li><li>Automate compounding</li></ul>`},
    {label:"AMM Math", html:`<div class="code">Given pool 50/50, price change Δ → IL ≈ 2√(P)/(1+P) − 1, where P = newPrice/oldPrice</div>`},
    {label:"Playbook", html:`<ul><li>Target APY band; define max drawdown</li><li>Position sizing 1–5% per strategy</li><li>Exit when incentives decay or TVL concentration rises</li></ul>`},
    {label:"Exercise", html:`<p>Model a 30-day LP (fees 0.2%/trade, daily volume X). Check three price paths and decide if IL is acceptable.</p>`}
  ]),
  M("mdf-5","Master",5,"NFTs as Wealth Vehicles",[
    {label:"Objectives", html:`<ul><li>Separate collectible vs utility NFTs</li><li>Design mint + royalty flows</li><li>Assess liquidity quality</li></ul>`},
    {label:"Utility Matrix", html:`<ul><li>Access (courses, events)</li><li>Identity (credentials, SBTs)</li><li>Revenue share/points (where compliant)</li></ul>`},
    {label:"Market Hygiene", html:`<ul><li>Holder distribution (no mega-whales)</li><li>Wash-trade detection (suspicious loops)</li><li>Volume stability vs spikes</li></ul>`},
    {label:"Exercise", html:`<p>Creator: one-pager (purpose, supply, price, royalty, roadmap). Trader: checklist (team, wallets, 7-day volume, retention).</p>`}
  ]),
  M("mdf-6","Master",6,"Multiple Web3 Income Streams",[
    {label:"Objectives", html:`<ul><li>Design 3–5 income lanes</li><li>Set prospecting & delivery loops</li><li>Track revenue/costs</li></ul>`},
    {label:"Lanes", html:`<ul><li>Freelance/bounties (dev, design, community, data)</li><li>Education (courses, guides, token-gated communities)</li><li>DAO ops (grants, proposals)</li></ul>`},
    {label:"Matrix", html:`<p>Target split: e.g., 50% stable invoicing, 30% token upside, 20% royalties. KPI review monthly.</p>`},
    {label:"Exercise", html:`<p>Create a one-page offer (problem → solution → proof → price). Pitch 5 prospects; log outcomes.</p>`}
  ]),
  M("mdf-7","Master",7,"Sovereign Wealth Strategy",[
    {label:"Objectives", html:`<ul><li>Draft a 5-year plan</li><li>Implement protection & recovery</li><li>Install review cadences</li></ul>`},
    {label:"Allocation", html:`<ul><li>Core (BTC/ETH/majors)</li><li>Satellite (select L2/DeFi)</li><li>Venture (experiments)</li></ul>`},
    {label:"Protection", html:`<ul><li>Hardware wallets + metal backups</li><li>Threshold multisig for > $X</li><li>Estate basics: instructions, beneficiaries, encrypted vault</li></ul>`},
    {label:"Cadence", html:`<ul><li>Weekly: dashboard & notes</li><li>Monthly: rebalance & thesis refresh</li><li>Quarterly: premortem + tax prep</li></ul>`},
    {label:"Exercise", html:`<p>Write a 1-page plan (targets, bands, rebalance cadence). Run a seed recovery simulation and verify balances.</p>`}
  ])
];

/* ==============================
   RENDER
============================== */
function menuBtn(m){
  const b = document.createElement("button");
  b.id = `menu-${m.id}`;
  b.innerHTML = `<i class="fa-solid ${m.level==='Beginner'?'fa-book-open':'fa-crown'}"></i> ${m.title} <span class="badge">${m.level==='Beginner'?m.num:'M'+m.num}</span>`;
  b.onclick = ()=>openModule(m.id, true);
  return b;
}
function renderMenus(){
  const beg = document.getElementById("menu-beginner");
  const mst = document.getElementById("menu-master");
  beg.innerHTML=""; mst.innerHTML="";
  modules.filter(x=>x.level==="Beginner").forEach(m=>beg.appendChild(menuBtn(m)));
  modules.filter(x=>x.level==="Master").forEach(m=>mst.appendChild(menuBtn(m)));
}
function renderAccordion(){
  const el = document.getElementById("accordion");
  el.innerHTML = "";
  modules.forEach(m=>{
    const acc = document.createElement("div");
    acc.className = "acc"; acc.id = `acc-${m.id}`;
    const done = completed.includes(m.id);
    const sectionsHTML = m.sections.map(s=>`
      <section style="margin-top:12px">
        <h4 style="margin:6px 0 8px;color:#a7c3ff"><i class="fa-solid fa-sparkles" style="color:var(--cyn)"></i> ${s.label}</h4>
        ${s.html}
      </section>
    `).join("");
    acc.innerHTML = `
      <div class="acc-sum" role="button" aria-expanded="false">
        <div class="left">
          <div class="num">${m.level==='Beginner'?m.num:'M'+m.num}</div>
          <div>
            <div style="font-weight:800">${m.title}</div>
            <small class="muted">${m.level}</small>
          </div>
          ${done?`<span class="pill" style="border-color:rgba(0,255,149,.35);color:#a5ffcf"><i class="fa-solid fa-circle-check"></i> Completed</span>`:""}
        </div>
        <div><button class="btn btn-ghost"><i class="fa-solid fa-chevron-down"></i></button></div>
      </div>
      <div class="acc-body">
        ${sectionsHTML}
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-mark" onclick="markComplete('${m.id}')"><i class="fa-solid fa-check"></i> Mark Complete</button>
          <span class="pill"><i class="fa-solid fa-clock"></i> ~12–20 min</span>
          <span class="pill"><i class="fa-solid fa-signal"></i> ${m.level}</span>
        </div>
      </div>
    `;
    acc.querySelector(".acc-sum").onclick = ()=>openModule(m.id, false);
    el.appendChild(acc);
  });
}
function openModule(id, fromMenu){
  const acc = document.getElementById(`acc-${id}`);
  const isOpen = acc.classList.contains("open");
  document.querySelectorAll(".acc").forEach(a=>{ a.classList.remove("open"); a.querySelector(".acc-sum").setAttribute("aria-expanded","false"); });
  if(!isOpen){ acc.classList.add("open"); acc.querySelector(".acc-sum").setAttribute("aria-expanded","true"); opened = id; }
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  const btn = document.getElementById(`menu-${id}`); if(btn) btn.classList.add("active");
  if(fromMenu) acc.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ==============================
   PROGRESS
============================== */
function markComplete(id){
  if(!completed.includes(id)){ completed.push(id); localStorage.setItem("kly_completed_neon", JSON.stringify(completed)); }
  notify("Saved","Module marked complete","good","fa-circle-check");
  renderAccordion(); updateProgress();
  if(typeof confetti==="function"){ confetti({particleCount:90, spread:60, origin:{y:.8}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
}
function updateProgress(){
  const unique = [...new Set(completed)].filter(id => modules.some(m => m.id === id));
  const done = unique.length;
  const pct = Math.min(100, Math.round(done/TOTAL_MODULES*100));
  chipText.textContent = `${done}/${TOTAL_MODULES} Complete`;
  certProgress.textContent = `${done} / ${TOTAL_MODULES}`;
  ring.style.setProperty("--p", pct + "%"); ring.setAttribute("data-label", pct + "%");
  if(done >= TOTAL_MODULES){ certStatus.textContent = "Ready to Mint"; btnMint.disabled = false; } else { certStatus.textContent = "Locked"; btnMint.disabled = true; }
}

/* ==============================
   TOAST
============================== */
function notify(title, msg, kind="info", icon="fa-circle-info"){
  toastTitle.textContent = title; toastMsg.textContent = msg;
  toastIcon.className = `fa-solid ${icon}`;
  toast.classList.remove("good","bad","warn");
  if(kind==="good") toast.classList.add("good");
  else if(kind==="bad") toast.classList.add("bad");
  else if(kind==="warn") toast.classList.add("warn");
  toast.hidden = false;
  clearTimeout(notify._t); notify._t = setTimeout(()=>toast.hidden=true, 4200);
}
function hideToast(){ toast.hidden = true; }

/* ==============================
   WEB3
============================== */
async function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { [BSC.idDec]: BSC.rpc }, chainId: BSC.idDec }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:"dark" });
}
async function connect(){
  try{
    btnConnect.disabled=true; btnConnect.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Connecting…';
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance, "any");
    signer = provider.getSigner(); account = await signer.getAddress();

    // Network check/switch
    const net = await provider.getNetwork();
    if(net.chainId !== BSC.idDec){
      try{ await instance.request({ method:"wallet_switchEthereumChain", params:[{ chainId:BSC.idHex }] }); }
      catch(e){
        if(e?.code===4902){
          await instance.request({ method:"wallet_addEthereumChain", params:[{
            chainId:BSC.idHex, chainName:BSC.name, nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
            rpcUrls:[BSC.rpc], blockExplorerUrls:["https://bscscan.com"]
          }]});
        }
      }
    }

    instance.on?.("accountsChanged", accs => { if(!accs?.length) return disconnect(); account = accs[0]; afterConnect(); });
    instance.on?.("chainChanged", afterConnect);
    instance.on?.("disconnect", disconnect);

    await afterConnect();
  }catch(err){
    notify("Connection Failed", err?.message || "User rejected", "bad", "fa-circle-xmark");
    btnConnect.disabled=false; btnConnect.innerHTML='<i class="fa-solid fa-wallet"></i> Connect Wallet';
  }
}
async function afterConnect(){
  const short = `${account.slice(0,6)}…${account.slice(-4)}`;
  addrShort.textContent = short; addrFull.textContent = account; avatar.textContent = account.slice(2,4).toUpperCase();
  pillAddr.hidden=false; btnDisconnect.hidden=false; btnConnect.hidden=true;
  netNameEl.textContent = BSC.name;

  try{
    const kly = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const [raw, dec] = await Promise.all([kly.balanceOf(account), kly.decimals()]);
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    klyBalanceEl.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:4})} KLY`;
    const p = Math.min(100, Math.round((Math.min(bal, 100) / 100) * 100));
    ring.style.setProperty("--p", p + "%"); ring.setAttribute("data-label", p + "%");
    if(bal >= 100){ notify("Access Granted","You have enough KLY to unlock content.","good","fa-unlock"); }
    else { notify("Access Locked","Need ≥ 100 KLY. Use PancakeSwap to acquire.","warn","fa-lock"); }
  }catch(e){
    notify("Read Error","Could not read KLY balance.","bad","fa-bug");
  }

  // restore
  updateProgress();
}
async function disconnect(){
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  provider = signer = account = null;
  btnConnect.hidden=false; btnDisconnect.hidden=true; pillAddr.hidden=true;
  addrFull.textContent="Not connected"; avatar.textContent="KA";
  btnConnect.disabled=false; btnConnect.innerHTML='<i class="fa-solid fa-wallet"></i> Connect Wallet';
  notify("Disconnected","Wallet disconnected","good","fa-right-from-bracket");
}

/* ==============================
   MINT
============================== */
async function mint(){
  if(!signer) return notify("Connect Wallet","Please connect your wallet first.","warn","fa-wallet");
  if(completed.length < TOTAL_MODULES) return notify("Finish Modules","Complete all modules first.","warn","fa-list-check");
  try{
    btnMint.disabled=true; btnMint.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Minting…';
    const to = await signer.getAddress();
    const nft = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
    const tokenURI = "ipfs://bafybeihkmkaf2mgx7xkrnkhmzd2uvhr6ddgj6z3vkqcgnvlaa3z7x263r4";
    let gas = await nft.estimateGas.mintTo(to, tokenURI).catch(()=>null);
    if(!gas){ notify("Gas Estimation Failed","Are you authorized to mint?","bad","fa-engine-warning"); btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate'; return; }
    const tx = await nft.mintTo(to, tokenURI, { gasLimit: gas.mul(120).div(100) });
    mintStatus.innerHTML = `Tx submitted: <a target="_blank" rel="noopener" href="https://bscscan.com/tx/${tx.hash}">view on BscScan</a>`;
    await tx.wait();
    notify("Minted","Certificate minted successfully!","good","fa-certificate");
    btnMint.innerHTML = '<i class="fa-solid fa-circle-check"></i> Minted';
    if(typeof confetti==="function"){ confetti({particleCount:160, spread:70, origin:{y:.7}, colors:["#00eaff","#ff3bff","#9333ff"]}); }
  }catch(e){
    notify("Mint Failed", e?.message || "Unknown error", "bad", "fa-circle-xmark");
    btnMint.disabled=false; btnMint.innerHTML='<i class="fa-solid fa-certificate"></i> Mint Certificate';
  }
}

/* ==============================
   INIT
============================== */
function initUI(){
  renderMenus(); renderAccordion(); updateProgress();
  openModule(modules[0].id, false);
  if(localStorage.getItem("kly_open_neon")) openModule(localStorage.getItem("kly_open_neon"), false);
}
btnConnect.addEventListener("click", connect);
btnDisconnect.addEventListener("click", disconnect);
btnMint.addEventListener("click", mint);
window.addEventListener("beforeunload", ()=>{ if(opened) localStorage.setItem("kly_open_neon", opened); });

window.addEventListener("load", async ()=>{
  initUI();
  await initWeb3Modal();
  if(window.Web3Modal && web3Modal.cachedProvider){ try{ await connect(); }catch{} }
});
</script>
</body>
</html>
