<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KLY â€” XP Claims & Mining Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <style>
    :root {
      --primary:#6E44FF; --secondary:#D4AF37;
      --bg-dark:#0b0d14; --bg-card:#121525; --bg-input:#0f1220;
      --text-main:#e9e9f0; --text-muted:rgba(255,255,255,.6);
      --border:rgba(255,255,255,.12);
      --success:#4ade80; --warning:#facc15; --danger:#f87171; --info:#60a5fa;
      --mining:#10b981; --mining-bg:rgba(16,185,129,.1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg-dark);color:var(--text-main);line-height:1.5;min-height:100vh}
    .wrap{max-width:1400px;margin:0 auto;padding:24px}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    h1,h2{margin:0 0 16px;font-weight:700;line-height:1.2}
    h1{font-size:28px;background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-block}
    h2{font-size:22px;color:var(--text-main);display:flex;align-items:center;gap:8px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0;align-items:center}
    .col{display:flex;flex-direction:column;gap:12px}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--border);font-size:14px;display:inline-flex;align-items:center;gap:6px}
    input,select,textarea{flex:1;min-width:200px;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-main);font-size:14px;transition:border-color .2s,box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(110,68,255,.2)}
    button{padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;white-space:nowrap}
    button:disabled{opacity:.6;cursor:not-allowed}
    .primary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#0b0b0b}
    .ghost{background:rgba(255,255,255,.08);color:var(--text-main);border:1px solid var(--border)}
    .ghost:hover:not(:disabled){background:rgba(255,255,255,.12)}
    .danger{background:var(--danger);color:#fff}
    .mining{background:var(--mining);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{opacity:.85;font-weight:600;color:var(--text-muted);text-transform:uppercase;font-size:13px;letter-spacing:.5px}
    tr:hover td{background:rgba(255,255,255,.03)}
    .meta{opacity:.85;font-size:14px;margin-top:8px;color:var(--text-muted)}
    .bar{height:16px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin:12px 0}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .5s cubic-bezier(.65,0,.35,1)}
    .badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px}
    .badge-success{background:rgba(74,222,128,.15);color:var(--success)}
    .badge-mining{background:var(--mining-bg);color:var(--mining)}
    .status{display:inline-flex;align-items:center;gap:6px}
    .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
    .status-online{background:var(--success)} .status-offline{background:var(--danger)}
    .toast{position:fixed;bottom:20px;right:20px;padding:16px 24px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);transform:translateY(100px);opacity:0;transition:all .3s cubic-bezier(.68,-.55,.265,1.55);z-index:1000;max-width:400px;display:flex;align-items:center;gap:12px}
    .toast.show{transform:translateY(0);opacity:1}
    .toast-success{border-left:4px solid var(--success)}
    .toast-error{border-left:4px solid var(--danger)}
    .toast-warning{border-left:4px solid var(--warning)}
    .toast-info{border-left:4px solid var(--info)}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .tooltip{position:relative;display:inline-block}
    .tooltip .tooltip-text{visibility:hidden;width:200px;background-color:var(--bg-card);color:var(--text-main);text-align:center;border-radius:6px;padding:8px;position:absolute;z-index:1;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .3s;font-size:13px;border:1px solid var(--border);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .tooltip:hover .tooltip-text{visibility:visible;opacity:1}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .tab-container{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px}
    .tab{position:relative;padding:8px 16px;cursor:pointer;font-weight:500;color:var(--text-muted);transition:all .2s}
    .tab:hover:not(.active){color:var(--text-main)}
    .tab.active{color:var(--text-main)}
    .tab.active:after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--primary),var(--secondary))}
    .chart-container{position:relative;height:300px;width:100%}
    .mining-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin:16px 0}
    .stat-card{padding:16px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid var(--border)}
    .stat-value{font-size:24px;font-weight:700;margin:8px 0;color:var(--text-main)}
    .stat-label{font-size:14px;color:var(--text-muted)}
    .mining-config{padding:16px;border-radius:12px;background:rgba(255,255,255,.03);border:1px dashed var(--border);margin-bottom:16px}
    .mining-config h3{margin-bottom:12px;font-size:16px}
    .mining-controls{display:flex;gap:12px;flex-wrap:wrap}
    .mining-log{height:200px;overflow-y:auto;padding:12px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);font-family:monospace;font-size:13px;white-space:pre-wrap}
    .log-entry{margin-bottom:4px}
    .log-time{color:var(--text-muted);margin-right:8px}
    .log-info{color:var(--text-main)}
    .log-warning{color:var(--warning)}
    .log-error{color:var(--danger)}
    .log-success{color:var(--success)}
    .log-mining{color:var(--mining)}
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
    @media (max-width:768px){
      .wrap{padding:16px}.card{padding:16px}h1{font-size:24px}h2{font-size:20px}
      input,select,button,textarea{min-width:100%} table{font-size:13px} th,td{padding:8px}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card animate__animated animate__fadeIn">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h1><i class="fas fa-trophy"></i> KLY XP & Mining Dashboard</h1>
      <div class="status">
        <span class="status-dot" id="connectionStatus"></span>
        <span id="connectionText">Connecting...</span>
      </div>
    </div>
    <div class="row">
      <label for="projectUrl" class="sr-only">Supabase URL</label>
      <input id="projectUrl" placeholder="https://your-project.supabase.co" />
      <label for="anonKey" class="sr-only">Supabase anon key</label>
      <input id="anonKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6Ik..." />
      <button id="saveCfg" class="ghost" aria-label="Save configuration"><i class="fas fa-save"></i> Save Config</button>
    </div>
    <div class="meta">
      <i class="fas fa-info-circle"></i> Configuration is saved in local storage.
      <span class="pill"><i class="fas fa-database"></i> Supabase v2</span>
      <span class="pill"><i class="fab fa-ethereum"></i> Ethers v5</span>
    </div>
  </div>

  <div class="tab-container">
    <div class="tab active" data-tab="xp">XP Dashboard</div>
    <div class="tab" data-tab="mining">Mining</div>
    <div class="tab" data-tab="analytics">Analytics</div>
  </div>

  <!-- XP Dashboard Tab -->
  <div id="xp-tab" class="tab-content">
    <div class="card animate__animated animate__fadeIn animate__delay-1s">
      <h2><i class="fas fa-user"></i> Player Profile</h2>
      <div class="row">
        <label for="addr" class="sr-only">Wallet address</label>
        <input id="addr" placeholder="0x... wallet address" autocomplete="off" />
        <button id="connect" class="ghost"><i class="fab fa-ethereum"></i> MetaMask</button>
        <button id="refreshXp" class="ghost"><i class="fas fa-sync-alt"></i> Refresh XP</button>
        <span class="pill"><i class="fas fa-star"></i> Total XP: <b id="xpTotal">0</b></span>
      </div>
      <div class="bar" aria-label="XP progress"><div id="xpFill" class="fill"></div></div>
      <div class="row" style="justify-content: space-between;">
        <div class="meta"><b id="rankName">Initiate</b> â€” <span id="xpVal">0</span>/<span id="xpReq">100</span> XP</div>
        <div class="meta" id="nextRankInfo"></div>
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-2s">
      <h2><i class="fas fa-plus-circle"></i> Add XP Claim</h2>
      <div class="row">
        <div class="tooltip" style="flex:1;">
          <label for="questId" class="sr-only">Quest ID</label>
          <input id="questId" placeholder="quest_id (e.g., q_connect)" />
          <span class="tooltip-text">Enter quest identifier (e.g., q_twitter_follow)</span>
        </div>
        <div class="tooltip" style="flex:1;">
          <label for="xpAmount" class="sr-only">XP amount</label>
          <input id="xpAmount" type="number" step="1" min="1" placeholder="XP amount (uses in4)" />
          <span class="tooltip-text">XP amount stored in column "in4"</span>
        </div>
        <button id="addClaim" class="primary" disabled><i class="fas fa-plus"></i> Add Claim</button>
      </div>
      <div class="meta">
        <i class="fas fa-code"></i> Writes to <code>xp_claims</code>: <code>addr</code>, <code>quest_id</code>, <code>in4</code>, <code>created_at</code>.
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-3s">
      <h2><i class="fas fa-history"></i> Recent Claims</h2>
      <div class="row">
        <button id="refreshClaims" class="ghost"><i class="fas fa-sync-alt"></i> Refresh</button>
        <button id="toggleFilter" class="ghost"><i class="fas fa-users"></i> Show All</button>
        <label for="limitSelect" class="sr-only">Row limit</label>
        <select id="limitSelect">
          <option value="10">10 rows</option>
          <option value="20" selected>20 rows</option>
          <option value="50">50 rows</option>
          <option value="100">100 rows</option>
        </select>
        <span class="pill"><i class="fas fa-list"></i> Rows: <b id="rowCount">0</b></span>
        <span class="pill"><i class="fas fa-filter"></i> Filter: <b id="filterStatus">All</b></span>
      </div>
      <div class="table-responsive">
        <table aria-describedby="claims table of recent XP claims">
          <thead>
            <tr>
              <th>ID</th><th>Address</th><th>Quest</th><th>in2</th><th>in4 (XP)</th><th>in8</th><th>Created</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="claimsBody">
            <tr><td colspan="8" style="text-align:center;padding:24px;">No data available. Connect to Supabase and load claims.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button id="loadMore" class="ghost" style="display:none;"><i class="fas fa-arrow-down"></i> Load More</button>
      </div>
    </div>
  </div>

  <!-- Mining Tab -->
  <div id="mining-tab" class="tab-content" style="display:none;">
    <div class="card animate__animated animate__fadeIn">
      <h2><i class="fas fa-hard-hat"></i> Mining Configuration</h2>
      
      <div class="mining-config">
        <h3><i class="fas fa-cog"></i> Mining Parameters</h3>
        <div class="row">
          <div class="col" style="flex:1;">
            <label for="miningBatchSize">Batch Size</label>
            <input id="miningBatchSize" type="number" min="1" max="1000" value="50" />
            <div class="meta">Number of claims to process per batch</div>
          </div>
          <div class="col" style="flex:1;">
            <label for="miningDelay">Delay (ms)</label>
            <input id="miningDelay" type="number" min="100" max="10000" value="1000" />
            <div class="meta">Delay between batches in milliseconds</div>
          </div>
          <div class="col" style="flex:1;">
            <label for="miningXpAmount">XP Amount</label>
            <input id="miningXpAmount" type="number" min="1" value="10" />
            <div class="meta">XP to award per claim</div>
          </div>
        </div>
        <div class="row">
          <div class="col" style="flex:1;">
            <label for="miningQuestId">Quest ID</label>
            <input id="miningQuestId" value="q_mining" />
            <div class="meta">Quest identifier for mining claims</div>
          </div>
          <div class="col" style="flex:1;">
            <label for="miningAddressList">Addresses (comma separated)</label>
            <textarea id="miningAddressList" rows="3" placeholder="0x...,0x...,0x..."></textarea>
            <div class="meta">Or leave empty to mine for all users</div>
          </div>
        </div>
      </div>

      <div class="mining-controls">
        <button id="startMining" class="mining"><i class="fas fa-play"></i> Start Mining</button>
        <button id="stopMining" class="danger" disabled><i class="fas fa-stop"></i> Stop Mining</button>
        <button id="testMining" class="ghost"><i class="fas fa-vial"></i> Test Run</button>
        <button id="clearMiningLog" class="ghost"><i class="fas fa-trash"></i> Clear Log</button>
        <span class="pill"><i class="fas fa-bolt"></i> Status: <b id="miningStatus">Idle</b></span>
        <span class="pill"><i class="fas fa-database"></i> Processed: <b id="miningProcessed">0</b></span>
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-1s">
      <h2><i class="fas fa-terminal"></i> Mining Log</h2>
      <div class="mining-log" id="miningLog">
        <div class="log-entry"><span class="log-time">[SYSTEM]</span> <span class="log-info">Mining module ready. Configure parameters and start mining.</span></div>
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-2s">
      <h2><i class="fas fa-chart-line"></i> Mining Statistics</h2>
      <div class="mining-stats">
        <div class="stat-card">
          <div class="stat-label">Total Processed</div>
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">addresses</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">XP Distributed</div>
          <div class="stat-value" id="statXp">0</div>
          <div class="stat-label">total XP</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Current Speed</div>
          <div class="stat-value" id="statSpeed">0</div>
          <div class="stat-label">claims/min</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Estimated Time</div>
          <div class="stat-value" id="statTime">0</div>
          <div class="stat-label">remaining</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Tab -->
  <div id="analytics-tab" class="tab-content" style="display:none;">
    <div class="card animate__animated animate__fadeIn">
      <h2><i class="fas fa-chart-pie"></i> XP Distribution</h2>
      <div class="chart-container">
        <canvas id="xpChart"></canvas>
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-1s">
      <h2><i class="fas fa-chart-bar"></i> Top Users</h2>
      <div class="chart-container">
        <canvas id="topUsersChart"></canvas>
      </div>
    </div>

    <div class="card animate__animated animate__fadeIn animate__delay-2s">
      <h2><i class="fas fa-table"></i> Leaderboard</h2>
      <div class="row">
        <button id="refreshLeaderboard" class="ghost"><i class="fas fa-sync-alt"></i> Refresh</button>
        <label for="leaderboardLimit" class="sr-only">Top N</label>
        <select id="leaderboardLimit">
          <option value="10">Top 10</option>
          <option value="20" selected>Top 20</option>
          <option value="50">Top 50</option>
          <option value="100">Top 100</option>
        </select>
        <span class="pill"><i class="fas fa-users"></i> Showing: <b id="leaderboardCount">0</b></span>
      </div>
      <div class="table-responsive">
        <table aria-describedby="leaderboard table">
          <thead>
            <tr>
              <th>Rank</th><th>Address</th><th>Total XP</th><th>Claims</th><th>Rank</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr><td colspan="5" style="text-align:center;padding:24px;">No data available. Load leaderboard.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
</div>

<script>
  // 0) Constants
  const DEFAULT_SUPABASE_URL = "https://mkutuyliszscfmexgqsj.supabase.co";
  const DEFAULT_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rdXR1eWxpc3pzY2ZtZXhncXNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5Nzc0MTYsImV4cCI6MjA3MDU1MzQxNn0.PXLOzZZNy_8-G8LrWTiVC7lpXy6cv_i6zFNjUfmQPkU";

  const RANKS = [
    { name:'Initiate',req:100,icon:'ðŸ§‘â€ðŸŽ“',color:'#6b7280' },
    { name:'Pathfinder',req:300,icon:'ðŸ§­',color:'#3b82f6' },
    { name:'Keyholder',req:800,icon:'ðŸ”‘',color:'#8b5cf6' },
    { name:'Vault Guardian',req:1500,icon:'ðŸ›¡ï¸',color:'#d946ef' },
    { name:'Master Builder',req:2500,icon:'ðŸ‘‘',color:'#f59e0b' },
    { name:'Legend',req:5000,icon:'ðŸŒŸ',color:'#ec4899' }
  ];

  // 1) State
  let sb = null, currentPage = 1, hasMoreData = false, currentFilter = 'all';
  let miningInterval = null, miningStats = { processed: 0, xpDistributed: 0, startTime: null };
  let xpChart = null, topUsersChart = null;

  // 2) DOM utils
  const $ = (id) => document.getElementById(id);
  const el = (tag, cls, text) => { const e=document.createElement(tag); if(cls) e.className=cls; if(text!==undefined) e.textContent=text; return e; };

  // 3) Toasts
  function showToast(message, type='info', duration=5000){
    const t = el('div',`toast toast-${type}`);
    t.setAttribute('role','status'); t.tabIndex=0;
    const icon = type==='success'?'check-circle':type==='error'?'times-circle':type==='warning'?'exclamation-circle':'info-circle';
    t.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
    $('toastContainer').appendChild(t);
    setTimeout(()=>t.classList.add('show'),10);
    if(duration>0){ setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); },duration); }
    t.addEventListener('click',()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); });
    t.addEventListener('keydown',e=>{ if(e.key==='Escape') t.click(); });
    return t;
  }

  // 4) Config + Client
  const getCfg = () => ({
    url: localStorage.getItem('sb_url') || DEFAULT_SUPABASE_URL,
    key: localStorage.getItem('sb_key') || DEFAULT_SUPABASE_ANON_KEY
  });
  const setCfg = (url,key)=>{ localStorage.setItem('sb_url',url.trim()); localStorage.setItem('sb_key',key.trim()); };

  async function testConnection(url, key){
    if(!window.supabase){ updateConnectionStatus(false,'Supabase library not loaded'); return false; }
    try{
      const c = window.supabase.createClient(url,key);
      const { error } = await c.from('xp_claims').select('id',{ head:true, count:'exact' }).limit(1);
      if(error){ updateConnectionStatus(false, error.message); return false; }
      updateConnectionStatus(true,'Connected to Supabase'); return true;
    }catch(e){ updateConnectionStatus(false, e.message || 'Connection error'); return false; }
  }

  function updateConnectionStatus(connected, message=''){
    const dot=$('connectionStatus'), txt=$('connectionText');
    if(connected){ dot.className='status-dot status-online'; txt.textContent='Connected to Supabase'; txt.style.color='var(--success)'; }
    else{ dot.className='status-dot status-offline'; txt.textContent=message||'Disconnected'; txt.style.color='var(--danger)'; }
  }

  async function initClient(url,key){
    const ok = await testConnection(url,key);
    if(!ok) return false;
    sb = window.supabase.createClient(url,key);
    subscribeRealtime();
    showToast('Supabase client initialized', 'success');
    loadClaims(); // initial
    loadLeaderboard(); // initial leaderboard
    loadAnalytics(); // initial analytics
    return true;
  }

  // 5) Ranks + Bar
  function setBar(totalXp){
    let rank=RANKS[0], next=RANKS[1], prevReq=0;
    for(let i=0;i<RANKS.length;i++){
      if(totalXp >= RANKS[i].req){ rank=RANKS[i]; next=RANKS[i+1]||null; prevReq=RANKS[i].req; } else break;
    }
    const span = next ? (next.req - rank.req) : 100;
    const pct = Math.round(Math.max(0, Math.min(1, (totalXp - prevReq)/span)) * 100);
    $('xpFill').style.width = pct + '%';
    $('rankName').innerHTML = `<span style="color:${rank.color}">${rank.icon} ${rank.name}</span>`;
    $('xpVal').textContent = totalXp;
    $('xpReq').textContent = next ? next.req : 'MAX';
    $('xpTotal').textContent = totalXp;
    $('nextRankInfo').innerHTML = next ? `Next: <span style="color:${next.color}">${next.icon} ${next.name}</span> (need ${next.req-totalXp} more XP)` : `<span style="color:${rank.color}">Maximum rank achieved!</span>`;
  }

  // 6) Safe row builder (prevents XSS)
  function appendClaimRow(r){
    const tr = document.createElement('tr');
    const td = (text)=>{ const t=document.createElement('td'); t.textContent=(text ?? '').toString(); return t; };

    tr.appendChild(td(r.id));

    const addrTd = el('td','tooltip');
    const shortSpan = el('span','', short(r.addr));
    const tip = el('span','tooltip-text', r.addr);
    addrTd.append(shortSpan, tip); tr.appendChild(addrTd);

    tr.appendChild(td(r.quest_id));
    tr.appendChild(td(r.in2 ?? '-'));

    const in4Td = document.createElement('td');
    const badge = el('span','badge badge-success', (r.in4 ?? 0).toString());
    in4Td.appendChild(badge); tr.appendChild(in4Td);

    tr.appendChild(td(r.in8 ?? '-'));
    tr.appendChild(td(formatDate(r.created_at)));

    const actions = document.createElement('td');
    const del = el('button','ghost'); del.style.cssText='padding:4px 8px;font-size:12px;'; del.innerHTML='<i class="fas fa-trash"></i>';
    del.addEventListener('click',()=>deleteClaim(r.id));
    actions.appendChild(del); tr.appendChild(actions);

    return tr;
  }

  function appendLeaderboardRow(r, index){
    const tr = document.createElement('tr');
    const td = (text)=>{ const t=document.createElement('td'); t.textContent=(text ?? '').toString(); return t; };

    tr.appendChild(td(index + 1));

    const addrTd = el('td','tooltip');
    const shortSpan = el('span','', short(r.addr));
    const tip = el('span','tooltip-text', r.addr);
    addrTd.append(shortSpan, tip); tr.appendChild(addrTd);

    tr.appendChild(td(r.total_xp));

    const claimsTd = document.createElement('td');
    const badge = el('span','badge', r.claims_count.toString());
    claimsTd.appendChild(badge); tr.appendChild(claimsTd);

    const rank = getRankForXp(r.total_xp);
    const rankTd = document.createElement('td');
    const rankBadge = el('span','badge', `${rank.icon} ${rank.name}`);
    rankBadge.style.color = rank.color;
    rankTd.appendChild(rankBadge); tr.appendChild(rankTd);

    return tr;
  }

  function getRankForXp(xp){
    for(let i=RANKS.length-1;i>=0;i--){
      if(xp >= RANKS[i].req) return RANKS[i];
    }
    return RANKS[0];
  }

  // 7) Data ops
  async function loadClaims(page=1, limit=null){
    if(!sb){ showToast('Supabase client not initialized','error'); return; }
    const loading = showToast('Loading claims...','info',0);
    const limitValue = limit || parseInt($('limitSelect').value);
    const addrInput = normalizeAddr($('addr').value);
    try{
      let q = sb.from('xp_claims').select('id,addr,quest_id,in2,in4,in8,created_at',{ count:'exact' })
        .order('id',{ ascending:false }).range((page-1)*limitValue, page*limitValue-1);

      if(addrInput && currentFilter!=='all'){ q = q.eq('addr', addrInput.toLowerCase()); }

      const { data, error, count } = await q;
      if(error) throw error;

      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);

      const tb=$('claimsBody');
      if(page===1){ tb.innerHTML=''; currentPage=1; }

      if(!data || !data.length){
        if(page===1) tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;">No claims found</td></tr>';
        $('rowCount').textContent='0'; $('loadMore').style.display='none'; hasMoreData=false; return;
      }

      $('rowCount').textContent = count ?? data.length;
      hasMoreData = count ? (count > page*limitValue) : (data.length===limitValue);
      $('loadMore').style.display = hasMoreData ? 'inline-flex' : 'none';

      data.forEach(r => tb.appendChild(appendClaimRow(r)));
      showToast(`Loaded ${data.length} claims`,'success');
    }catch(e){
      console.error('loadClaims error:', e);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Failed to load claims: ${e.message}`,'error');
    }
  }

  async function loadXP(){
    if(!sb){ showToast('Supabase client not initialized','error'); return; }
    const a = normalizeAddr($('addr').value);
    if(!a){ setBar(0); showToast('Enter a valid wallet address','warning'); return; }
    const loading = showToast('Calculating XP...','info',0);
    try{
      const { data, error } = await sb.from('xp_claims').select('in4').eq('addr', a.toLowerCase());
      if(error) throw error;
      const total = (data||[]).reduce((s,r)=>s+(r.in4||0),0);
      setBar(total);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Total XP: ${total}`,'success');
    }catch(e){
      console.error('loadXP error:', e);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Failed to calculate XP: ${e.message}`,'error'); setBar(0);
    }
  }

  async function loadLeaderboard(){
    if(!sb) return;
    const limit = parseInt($('leaderboardLimit').value);
    const loading = showToast('Loading leaderboard...','info',0);
    try{
      const { data, error } = await sb.rpc('get_leaderboard', { limit_count: limit });
      if(error) throw error;
      
      const tb=$('leaderboardBody');
      tb.innerHTML='';
      
      if(!data || !data.length){
        tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;">No leaderboard data available</td></tr>';
        $('leaderboardCount').textContent='0';
        return;
      }
      
      $('leaderboardCount').textContent = data.length;
      data.forEach((r, i) => tb.appendChild(appendLeaderboardRow(r, i)));
      
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Leaderboard loaded with ${data.length} entries`,'success');
    }catch(e){
      console.error('loadLeaderboard error:', e);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Failed to load leaderboard: ${e.message}`,'error');
    }
  }

  async function loadAnalytics(){
    if(!sb) return;
    try{
      // Load data for XP distribution chart
      const { data: xpData, error: xpError } = await sb.rpc('get_xp_distribution');
      if(xpError) throw xpError;
      
      // Load data for top users chart
      const { data: usersData, error: usersError } = await sb.rpc('get_top_users', { limit_count: 10 });
      if(usersError) throw usersError;
      
      // Create or update charts
      updateCharts(xpData, usersData);
    }catch(e){
      console.error('loadAnalytics error:', e);
      showToast(`Failed to load analytics: ${e.message}`,'error');
    }
  }

  function updateCharts(xpData, usersData){
    // Destroy existing charts if they exist
    if(xpChart) xpChart.destroy();
    if(topUsersChart) topUsersChart.destroy();
    
    // XP Distribution Chart (Pie)
    const xpCtx = document.getElementById('xpChart').getContext('2d');
    xpChart = new Chart(xpCtx, {
      type: 'pie',
      data: {
        labels: xpData.map(d => d.range),
        datasets: [{
          data: xpData.map(d => d.count),
          backgroundColor: [
            '#6E44FF', '#D4AF37', '#4ade80', '#facc15', '#f87171', '#60a5fa', '#ec4899'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
    
    // Top Users Chart (Bar)
    const usersCtx = document.getElementById('topUsersChart').getContext('2d');
    topUsersChart = new Chart(usersCtx, {
      type: 'bar',
      data: {
        labels: usersData.map(d => short(d.addr)),
        datasets: [{
          label: 'Total XP',
          data: usersData.map(d => d.total_xp),
          backgroundColor: '#6E44FF',
          borderColor: '#D4AF37',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#e9e9f0' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          x: {
            ticks: { color: '#e9e9f0' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              afterLabel: function(context) {
                const data = usersData[context.dataIndex];
                return `Address: ${data.addr}\nClaims: ${data.claims_count}`;
              }
            }
          }
        }
      }
    });
  }

  async function insertClaim(){
  if(!sb){ showToast('Supabase client not initialized','error'); return; }

  const addrPretty = normalizeAddr($('addr').value);
  const quest = ($('questId').value || '').trim() || 'q_demo';
  const xp = Number($('xpAmount').value || '0');

  if(!addrPretty){ showToast('Enter a valid wallet address','warning'); return; }
  if(!(xp>0)){ showToast('XP amount must be greater than 0','warning'); return; }

  const loading = showToast('Adding XP claim...','info',0);
  const row = { addr: addrPretty.toLowerCase(), quest_id: quest, in4: xp, created_at: new Date().toISOString() };

  try{
    // Pre-check to avoid unique violation
    const { data: exists, error: chkErr } = await sb
      .from('xp_claims')
      .select('id')
      .eq('addr', row.addr)
      .eq('quest_id', row.quest_id)
      .limit(1);

    if (chkErr) throw chkErr;

    if (exists && exists.length) {
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast('Already claimed â€” no changes made','warning');
    } else {
      const { error } = await sb.from('xp_claims').insert(row);
      if (error) throw error;
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Added ${xp} XP for ${short(addrPretty)} (${quest})`,'success');
    }

    $('questId').value=''; $('xpAmount').value=''; updateAddBtnState();
    await Promise.all([loadXP(), loadClaims(), loadLeaderboard(), loadAnalytics()]);
  }catch(e){
    // If the unique error still sneaks through, treat it as a no-op
    if (String(e.message).includes('unique_claim_per_quest')) {
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast('Already claimed â€” skipped','warning');
      await Promise.all([loadXP(), loadClaims(), loadLeaderboard(), loadAnalytics()]);
      return;
    }
    console.error('insertClaim error:', e);
    loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
    showToast(`Failed to add claim: ${e.message}`,'error');
  }
}

  async function deleteClaim(id){
    if(!confirm('Delete this XP claim?')) return;
    if(!sb){ showToast('Supabase client not initialized','error'); return; }
    const loading = showToast('Deleting claim...','info',0);
    try{
      const { error } = await sb.from('xp_claims').delete().eq('id', id);
      if(error) throw error;
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast('Claim deleted','success');
      await Promise.all([loadXP(), loadClaims(), loadLeaderboard(), loadAnalytics()]);
    }catch(e){
      console.error('deleteClaim error:', e);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Failed to delete claim: ${e.message}`,'error');
    }
  }

  // 8) Wallet
  async function connectMM(){
    if(!window.ethereum){ showToast('MetaMask not detected','warning'); return; }
    const loading = showToast('Connecting to MetaMask...','info',0);
    try{
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      const signer = provider.getSigner();
      const addr = await signer.getAddress();
      $('addr').value = ethers.utils.getAddress(addr);
      localStorage.setItem('addr', $('addr').value);
      currentFilter='user'; $('filterStatus').textContent='User Only'; $('toggleFilter').textContent='Show All';
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Connected: ${short(addr)}`,'success');
      await Promise.all([loadXP(), loadClaims()]);
    }catch(e){
      console.error('connectMM error:', e);
      loading.classList.remove('show'); setTimeout(()=>loading.remove(),300);
      showToast(`Wallet error: ${e.message}`,'error');
    }
  }

  // 9) Mining Functions
async function processMiningBatch(){
  if(!sb) return;

  const batchSize = parseInt($('miningBatchSize').value) || 50;
  const xpAmount  = parseInt($('miningXpAmount').value) || 10;
  const questId   = ($('miningQuestId').value || 'q_mining').trim();
  const addressList = getAddressList();

  try {
    // 1) Figure out which addresses to process this batch
    let addressesToProcess = [];
    if (addressList === null) {
      // Distinct addresses, stable order
      const from = miningStats.processed;
      const to   = miningStats.processed + batchSize - 1;
      const { data, error } = await sb
        .from('xp_claims')
        .select('addr', { count: 'exact', distinct: true })
        .order('addr', { ascending: true })
        .range(from, to);
      if (error) throw error;
      addressesToProcess = (data || []).map(r => r.addr);
    } else {
      addressesToProcess = addressList.slice(miningStats.processed, miningStats.processed + batchSize);
    }

    if (addressesToProcess.length === 0) {
      addMiningLog('No more addresses to process. Mining complete.', 'success');
      stopMining();
      return;
    }

    // 2) Pull existing claims for THIS quest to avoid duplicates
    const lowerAddrs = addressesToProcess.map(a => a.toLowerCase());
    const { data: existing, error: exErr } = await sb
      .from('xp_claims')
      .select('addr, quest_id')
      .eq('quest_id', questId)
      .in('addr', lowerAddrs);

    if (exErr) throw exErr;

    const already = new Set((existing || []).map(r => `${r.addr}|${r.quest_id}`));
    const freshAddrs = lowerAddrs.filter(a => !already.has(`${a}|${questId}`));

    if (freshAddrs.length === 0) {
      addMiningLog('Batch skipped â€” all addresses already claimed this quest.', 'warning');
      // Still move the window forward so we donâ€™t get stuck
      miningStats.processed += addressesToProcess.length;
      $('miningProcessed').textContent = miningStats.processed;
      updateMiningStats();
      return;
    }

    // 3) Insert only the fresh ones
    const now = new Date().toISOString();
    const claims = freshAddrs.map(addr => ({
      addr,
      quest_id: questId,
      in4: xpAmount,
      created_at: now
    }));

    const { error } = await sb.from('xp_claims').insert(claims);
    if (error) throw error;

    // 4) Update stats/log
    miningStats.processed     += addressesToProcess.length; // we advanced the window
    miningStats.xpDistributed += freshAddrs.length * xpAmount;

    $('miningProcessed').textContent = miningStats.processed;
    updateMiningStats();

    addMiningLog(`Processed ${freshAddrs.length}/${addressesToProcess.length} (skipped duplicates) â€” +${xpAmount} XP each`, 'mining');
  } catch (e) {
    console.error('Mining batch error:', e);
    addMiningLog(`Error processing batch: ${e.message}`, 'error');
    stopMining();
  }
}

  // 10) Utils
  function normalizeAddr(a){ try{ return ethers.utils.getAddress((a||'').trim()); }catch{return null;} }
  function isAddr(a){ return !!normalizeAddr(a); }
  function short(a){ return a ? a.slice(0,6)+'â€¦'+a.slice(-4) : ''; }
  function formatDate(iso){ const d=new Date(iso); return new Intl.DateTimeFormat([], {month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d); }

  // 11) Realtime (optional but enabled)
  function subscribeRealtime(){
    if(!sb) return;
    const ch = sb.channel('xp_claims_changes');
    ch.on('postgres_changes',{ event:'*', schema:'public', table:'xp_claims' }, () => {
      clearTimeout(window._rt);
      window._rt = setTimeout(()=>{ loadXP(); loadClaims(1); loadLeaderboard(); loadAnalytics(); }, 300);
    }).subscribe();
  }

  // 12) Events
  function updateAddBtnState(){
    const okAddr = isAddr($('addr').value);
    const xpOk = Number($('xpAmount').value) > 0;
    const questOk = ($('questId').value || '').trim().length > 0;
    $('addClaim').disabled = !(okAddr && xpOk && questOk);
  }

  function setupEventListeners(){
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        
        tab.classList.add('active');
        $(`${tab.dataset.tab}-tab`).style.display = 'block';
        
        // Load data when switching to analytics tab
        if(tab.dataset.tab === 'analytics'){
          loadAnalytics();
        }
      });
    });
    
    $('saveCfg').addEventListener('click', async ()=>{
      const url=$('projectUrl').value, key=$('anonKey').value;
      if(!url || !key){ showToast('Provide both URL and anon key','warning'); return; }
      $('saveCfg').disabled=true; $('saveCfg').innerHTML='<div class="spinner"></div> Saving...';
      try{ const ok=await initClient(url,key); if(ok){ setCfg(url,key); showToast('Configuration saved','success'); } }
      finally{ $('saveCfg').disabled=false; $('saveCfg').innerHTML='<i class="fas fa-save"></i> Save Config'; }
    });

    $('connect').addEventListener('click', connectMM);
    $('refreshXp').addEventListener('click', loadXP);
    $('addr').addEventListener('input', ()=>{ updateAddBtnState(); });
    $('addr').addEventListener('change', ()=>{
      const a = normalizeAddr($('addr').value);
      if(a){ $('addr').value = a; localStorage.setItem('addr', a); loadXP(); loadClaims(); }
      else{ setBar(0); }
    });

    $('addClaim').addEventListener('click', insertClaim);
    $('refreshClaims').addEventListener('click', ()=>loadClaims());
    $('limitSelect').addEventListener('change', ()=>loadClaims());
    $('loadMore').addEventListener('click', ()=>{ currentPage++; loadClaims(currentPage); });

    $('toggleFilter').addEventListener('click', ()=>{
      currentFilter = (currentFilter==='all') ? 'user' : 'all';
      $('filterStatus').textContent = currentFilter==='all' ? 'All' : 'User Only';
      $('toggleFilter').textContent = currentFilter==='all' ? 'Show Mine' : 'Show All';
      loadClaims(1);
    });

    // Leaderboard events
    $('refreshLeaderboard').addEventListener('click', loadLeaderboard);
    $('leaderboardLimit').addEventListener('change', loadLeaderboard);
    
    // Mining events
    $('startMining').addEventListener('click', startMining);
    $('stopMining').addEventListener('click', stopMining);
    $('testMining').addEventListener('click', testMining);
    $('clearMiningLog').addEventListener('click', clearMiningLog);

    ['questId','xpAmount'].forEach(id=>{
      $(id).addEventListener('input', updateAddBtnState);
      $(id).addEventListener('keydown', e=>{ if(e.ctrlKey && e.key==='Enter' && id==='questId') $('addClaim').click(); });
    });

    if(window.ethereum){
      window.ethereum.on('accountsChanged', (accounts)=>{
        if(accounts.length>0){
          $('addr').value = ethers.utils.getAddress(accounts[0]);
          localStorage.setItem('addr', $('addr').value);
          loadXP(); loadClaims();
        }else{ $('addr').value=''; localStorage.removeItem('addr'); setBar(0); }
      });
    }
  }

  // 13) Boot
  async function boot(){
    setupEventListeners();
    const cfg = getCfg();
    $('projectUrl').value = cfg.url; $('anonKey').value = cfg.key;
    await initClient(cfg.url, cfg.key);

    const savedAddr = localStorage.getItem('addr');
    if(savedAddr){ $('addr').value = savedAddr; await Promise.all([loadXP(), loadClaims()]); }

    showToast('Dashboard initialized','success');
  }

  window.addEventListener('DOMContentLoaded', boot);
  window.deleteClaim = deleteClaim;
</script>
</body>
</html>
