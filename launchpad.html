<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KLY Launchpad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background: #050505;
      color: #e0e0e0;
      font-family: 'Rajdhani', sans-serif;
      padding: 2rem;
    }
    h1 {
      font-family: 'Orbitron', sans-serif;
      color: #00ffe7;
      text-align: center;
      margin-bottom: 2rem;
    }
    .wallet-button {
      background: linear-gradient(135deg, #00ffe7, #ff00aa);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      color: #050505;
    }
    .wallet-button.connected {
      background: transparent;
      color: #00ffe7;
      border: 1px solid #00ffe7;
    }
    .status-message {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 6px;
      display: none;
    }
    .status-processing { background: #ffaa0022; color: #ffaa00; }
    .status-success { background: #00ffaa22; color: #00ffaa; }
    .status-error { background: #ff555522; color: #ff5555; }
    .launch-form, .token-card {
      background: #111;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #00ffe722;
      margin-bottom: 2rem;
    }
    input {
      width: 100%;
      padding: 0.8rem;
      border-radius: 6px;
      border: 1px solid #00ffe7;
      margin-bottom: 1rem;
      background: #000;
      color: #fff;
    }
    .launch-button {
      background: linear-gradient(135deg, #00ffe7, #ff00aa);
      padding: 1rem;
      width: 100%;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .token-card {
      color: #ccc;
    }
    .token-card h3 {
      margin: 0 0 0.5rem;
      color: #00ffe7;
    }
  </style>
</head>
<body>

  <h1>KLY Launchpad</h1>

  <div style="text-align: center; margin-bottom: 2rem;">
    <button id="connectWallet" class="wallet-button"><i class="fas fa-wallet"></i> Connect Wallet</button>
    <div id="walletAddress" style="margin-top: 0.5rem; color: #00ffe7;"></div>
  </div>

  <div id="statusMessage" class="status-message">
    <span id="statusText">Status message here</span>
  </div>

  <div class="launch-form">
    <h3>Create New Token</h3>
    <input id="tokenName" placeholder="Token Name" />
    <input id="tokenSymbol" placeholder="Symbol (e.g. KLY)" maxlength="6" />
    <input id="initialSupply" placeholder="Initial Supply" type="number" min="1000" />
    <button id="launchTokenBtn" class="launch-button">Launch Token</button>
  </div>

  <div id="launchedTokensList"></div>

  <script type="module">
    import { ThirdwebSDK } from "https://cdn.jsdelivr.net/npm/@thirdweb-dev/sdk@3/+esm";
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm";

    const treasury = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
    const klyToken = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
    const minKLY = 10000;

    let wallet, signer, sdk;

    const connectBtn = document.getElementById("connectWallet");
    const launchBtn = document.getElementById("launchTokenBtn");
    const walletAddressEl = document.getElementById("walletAddress");
    const statusEl = document.getElementById("statusMessage");
    const statusText = document.getElementById("statusText");
    const tokensListEl = document.getElementById("launchedTokensList");

    connectBtn.onclick = connectWallet;

    async function connectWallet() {
      try {
        showStatus("Connecting...", "processing");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        wallet = await signer.getAddress();
        sdk = new ThirdwebSDK(signer);

        walletAddressEl.textContent = `Connected: ${wallet.slice(0, 6)}...${wallet.slice(-4)}`;
        connectBtn.classList.add("connected");
        connectBtn.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
        showStatus("Wallet connected", "success");
      } catch (err) {
        console.error(err);
        showStatus("Connection failed", "error");
      }
    }

    function showStatus(msg, type) {
      statusText.textContent = msg;
      statusEl.className = `status-message status-${type}`;
      statusEl.style.display = "block";
    }

    launchBtn.onclick = async () => {
      const name = document.getElementById("tokenName").value.trim();
      const symbol = document.getElementById("tokenSymbol").value.trim();
      const supply = document.getElementById("initialSupply").value.trim();

      if (!wallet || !sdk) return showStatus("Connect wallet first", "error");
      if (!name || symbol.length < 2 || !supply || isNaN(supply)) return showStatus("Fill all fields correctly", "error");

      try {
        showStatus("Checking KLY balance...", "processing");
        const kly = new ethers.Contract(klyToken, ["function balanceOf(address) view returns (uint256)"], signer);
        const balance = await kly.balanceOf(wallet);
        const formatted = parseFloat(ethers.utils.formatUnits(balance, 18));
        if (formatted < minKLY) return showStatus(`You need at least ${minKLY} KLY`, "error");

        showStatus("Deploying token...", "processing");
        const tokenAddress = await sdk.deployer.deployToken({
          name,
          symbol,
          primary_sale_recipient: wallet,
          total_supply: supply.toString()
        });

        showStatus("Sending 5% to treasury...", "processing");
        const token = await sdk.getContract(tokenAddress);
        const fivePercent = Math.floor(parseInt(supply) * 0.05).toString();
        await token.call("transfer", [treasury, fivePercent]);

        const tokens = JSON.parse(localStorage.getItem("launchedTokens") || "[]");
        tokens.unshift({ name, symbol, supply, address: tokenAddress, timestamp: new Date().toISOString() });
        localStorage.setItem("launchedTokens", JSON.stringify(tokens));

        showStatus(`${name} (${symbol}) launched successfully!`, "success");
        document.getElementById("tokenName").value = "";
        document.getElementById("tokenSymbol").value = "";
        document.getElementById("initialSupply").value = "";
        displayTokens();
      } catch (err) {
        console.error(err);
        showStatus("Launch failed: " + (err.message || "Unknown error"), "error");
      }
    };

    function displayTokens() {
      const tokens = JSON.parse(localStorage.getItem("launchedTokens") || "[]");
      if (!tokens.length) return tokensListEl.innerHTML = "<p>No tokens launched yet.</p>";
      tokensListEl.innerHTML = tokens.map(t => `
        <div class="token-card">
          <h3>${t.name} (${t.symbol})</h3>
          <p>Supply: ${parseInt(t.supply).toLocaleString()}</p>
          <p><strong>Address:</strong><br>${t.address}</p>
          <a href="https://bscscan.com/address/${t.address}" target="_blank" style="color:#00ffe7;">View on BscScan</a>
        </div>
      `).join("");
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectWallet();
      }
      displayTokens();
    });
  </script>

</body>
</html>
