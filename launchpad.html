<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KLY Launchpad - BNB Chain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="KLY Launchpad - The premier platform for initial DEX offerings on BNB Chain">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Web3 Libraries (compatible versions) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

  <style>
    :root{
      --primary:#00ffe7;--secondary:#ff00aa;--bg-dark:#0b0b0b;--bg-darker:#050505;--text-light:#e0e0e0;
      --success:#00ff88;--error:#ff3860;--warning:#ffaa00;--bnb-yellow:#F0B90B;
      --glow-primary:0 0 15px rgba(0,255,231,.5);--glow-secondary:0 0 15px rgba(255,0,170,.5)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Rajdhani',sans-serif;background:var(--bg-darker);color:var(--text-light);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;position:relative;overflow-x:hidden}
    #particles-js{position:absolute;inset:0;z-index:-1;pointer-events:none}
    .grid-overlay{position:fixed;inset:0;background:
      linear-gradient(rgba(0,255,231,.03) 1px,transparent 1px),
      linear-gradient(90deg,rgba(0,255,231,.03) 1px,transparent 1px);
      background-size:40px 40px;z-index:-1;pointer-events:none}
    .card{background:rgba(15,15,15,.8);padding:2.5rem;border-radius:20px;border:1px solid rgba(0,255,231,.2);
      backdrop-filter:blur(10px);box-shadow:var(--glow-primary);text-align:center;max-width:620px;width:100%;position:relative;overflow:hidden;transition:.3s}
    .card:hover{box-shadow:0 0 30px rgba(0,255,231,.6)}
    .card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:radial-gradient(circle,rgba(0,255,231,.1) 0%,transparent 70%);transform:rotate(45deg);z-index:-1;animation:rot 20s linear infinite}
    @keyframes rot{to{transform:rotate(360deg)}}
    h1{font-family:'Orbitron',sans-serif;color:var(--primary);text-shadow:0 0 10px var(--primary);margin-bottom:.5rem;font-size:2.5rem;letter-spacing:2px;position:relative;display:inline-block}
    h1::after{content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:100px;height:3px;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:3px}
    .network-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(240,185,11,.1);color:var(--bnb-yellow);
      padding:.5rem 1.2rem;border-radius:20px;font-size:.9rem;margin-bottom:1.5rem;border:1px solid var(--bnb-yellow);box-shadow:0 0 10px rgba(240,185,11,.3)}
    .subtitle{opacity:.9;font-size:1.05rem;line-height:1.6;margin-bottom:1.2rem}
    button{background:linear-gradient(135deg,var(--primary),var(--secondary));border:none;color:#000;font-weight:700;
      padding:14px 28px;border-radius:12px;cursor:pointer;margin-top:1rem;width:100%;font-size:1.1rem;transition:.3s;position:relative;overflow:hidden;z-index:1;font-family:'Montserrat',sans-serif}
    button::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--secondary),var(--primary));opacity:0;transition:.3s;z-index:-1}
    button:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,255,231,.6)}button:hover::before{opacity:1}
    button:disabled{opacity:.6;cursor:not-allowed;background:linear-gradient(135deg,#555,#777);transform:none!important}
    #walletStatus{margin:1rem 0 0;font-family:'Orbitron',sans-serif;color:var(--primary);word-break:break-all;padding:1rem;background:rgba(0,0,0,.3);border-radius:12px;border:1px solid rgba(0,255,231,.2);position:relative}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.8rem;margin-top:.5rem;border:1px solid rgba(255,255,255,.2)}
    .token-info{margin-top:1.2rem;text-align:left;background:rgba(0,0,0,.3);padding:1rem;border-radius:12px;border:1px solid rgba(0,255,231,.2);position:relative}
    .token-info h3{font-family:'Orbitron',sans-serif;color:var(--primary);margin-bottom:.5rem;font-size:1.1rem}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:.4rem 0}
    .row .label{opacity:.8}
    .row .val{font-family:'Orbitron',sans-serif;color:var(--primary)}
    .action-buttons{display:flex;gap:1rem;margin-top:1.3rem}
    .action-buttons button{flex:1;display:flex;align-items:center;justify-content:center;gap:8px}
    .notification{position:fixed;top:20px;right:20px;background:rgba(20,20,20,.95);padding:1.1rem;border-left:4px solid var(--primary);color:#fff;max-width:360px;border-radius:8px;transform:translateX(120%);transition:transform .3s cubic-bezier(.68,-.55,.265,1.55);z-index:1000;box-shadow:0 5px 15px rgba(0,0,0,.3);display:flex;align-items:center;gap:12px}
    .notification.show{transform:translateX(0)} .notification.error{border-left-color:var(--error)} .notification.success{border-left-color:var(--success)} .notification.warning{border-left-color:var(--warning)}
    .tx-status{margin-top:1rem;padding:1rem;border-radius:8px;background:rgba(0,0,0,.3);border:1px solid rgba(0,255,231,.2);display:none}
    .tx-hash{display:flex;align-items:center;gap:8px;font-size:.9rem;margin-bottom:.4rem;word-break:break-all}
    .progress-container{width:100%;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));width:0;transition:width .3s}
    .countdown{display:flex;justify-content:center;gap:1rem;margin:1rem 0}
    .countdown-item{background:rgba(0,0,0,.3);padding:.6rem;border-radius:8px;min-width:70px;text-align:center;border:1px solid rgba(0,255,231,.2)}
    .countdown-number{font-size:1.4rem;font-weight:700;color:var(--primary);font-family:'Orbitron',sans-serif}
    .countdown-label{font-size:.7rem;opacity:.7;text-transform:uppercase;margin-top:4px}
    @media(max-width:768px){.card{padding:1.8rem}h1{font-size:2rem}.action-buttons{flex-direction:column}}
  </style>
</head>
<body>
  <div id="particles-js"></div>
  <div class="grid-overlay"></div>

  <div class="card">
    <h1>KLY LAUNCHPAD</h1>
    <div class="network-badge"><i class="fab fa-btc"></i> BNB Smart Chain</div>
    <p class="subtitle">Two‚Äëtoken growth: <strong>KLY</strong> gates access & governance; <strong>S√≥lCoin</strong> powers utility & community.</p>

    <div class="countdown">
      <div class="countdown-item"><div class="countdown-number" id="days">00</div><div class="countdown-label">Days</div></div>
      <div class="countdown-item"><div class="countdown-number" id="hours">00</div><div class="countdown-label">Hours</div></div>
      <div class="countdown-item"><div class="countdown-number" id="minutes">00</div><div class="countdown-label">Minutes</div></div>
      <div class="countdown-item"><div class="countdown-number" id="seconds">00</div><div class="countdown-label">Seconds</div></div>
    </div>

    <button id="connectWallet"><i class="fas fa-wallet"></i> <span id="buttonText">Connect Wallet</span></button>
    <div id="walletStatus">Not connected</div>

    <div class="token-info" id="tokenInfo" style="display:none;">
      <h3>Balances</h3>
      <div class="row"><span class="label">KLY Contract</span><span class="val" id="klyAddress">‚Äî</span></div>
      <div class="row"><span class="label">KLY Balance</span><span class="val" id="klyBalance">‚Äî</span></div>
      <div class="row"><span class="label">S√≥lCoin (Drop)</span><span class="val" id="solAddress">‚Äî</span></div>
      <div class="row"><span class="label">S√≥lCoin Balance</span><span class="val" id="solBalance">‚Äî</span></div>
      <div class="pill" id="gateInfo">Gate: requires <span id="klyThresholdText">‚Äî</span> KLY to claim S√≥lCoin</div>
    </div>

    <div class="action-buttons" id="actionButtons" style="display:none;">
      <button id="getTokensButton"><i class="fas fa-coins"></i> Mint KLY</button>
      <button id="buySolBtn" disabled title="Requires gate"><i class="fas fa-bolt"></i> Buy S√≥lCoin</button>
      <button id="viewExplorer"><i class="fas fa-external-link-alt"></i> Explorer</button>
    </div>

    <div class="tx-status" id="txStatus">
      <div class="tx-hash"><i class="fas fa-exchange-alt"></i><a href="#" target="_blank" id="txHashLink">Transaction pending...</a></div>
      <div class="progress-container"><div class="progress-bar" id="txProgress"></div></div>
    </div>
  </div>

  <div id="notification" class="notification"><i class="fas fa-info-circle"></i><span id="notificationMessage">Notification</span></div>

  <script>
    /********** Config **********/
    const CONTRACT_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52"; // KLY ERC20 (mintTo)
    const SOL_DROP_ADDRESS = "0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026"; // S√≥lCoin (ERC20 + Drop claim)
    const BSC_CHAIN_ID = 56;
    const EXPLORER_URL = "https://bscscan.com";
    const NATIVE_TOKEN_SENTINEL = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";

    // üîê Gate: how much KLY you need to enable S√≥lCoin purchase (human units)
    const KLY_THRESHOLD_HUMAN = "1000"; // change to taste

    const RPC_URLS = [
      "https://bsc-dataseed.binance.org/",
      "https://bsc-dataseed1.defibit.io/",
      "https://bsc-dataseed1.ninicoin.io/"
    ];

    /********** ABIs **********/
    const TOKEN_ABI = [
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function mintTo(address to, uint256 amount)"
    ];
    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 value) returns (bool)"
    ];
    const DROP20_ABI = [
      "function getActiveClaimConditionId() view returns (uint256)",
      "function getClaimConditionById(uint256) view returns (tuple(uint256 startTimestamp,uint256 maxClaimableSupply,uint256 supplyClaimed,uint256 quantityLimitPerWallet,bytes32 merkleRoot,uint256 pricePerToken,address currency,string metadata))",
      "function claim(address _receiver,uint256 _quantity,address _currency,uint256 _pricePerToken,(bytes32[] proof,uint256 quantityLimitPerWallet,uint256 pricePerToken,address currency) _allowlistProof,bytes _data) payable"
    ];

    /********** State & DOM **********/
    let web3Modal, provider, externalProvider, signer, userAddress;
    let kly, solToken, drop;
    let klyDecimals = 18, solDecimals = 18;
    let txInterval;

    const connectBtn = document.getElementById("connectWallet");
    const buttonText = document.getElementById("buttonText");
    const walletStatus = document.getElementById("walletStatus");

    const tokenInfo = document.getElementById("tokenInfo");
    const actionButtons = document.getElementById("actionButtons");

    const klyAddressEl = document.getElementById("klyAddress");
    const klyBalanceEl = document.getElementById("klyBalance");
    const solAddressEl = document.getElementById("solAddress");
    const solBalanceEl = document.getElementById("solBalance");
    const klyThresholdText = document.getElementById("klyThresholdText");
    const buySolBtn = document.getElementById("buySolBtn");

    const getTokensButton = document.getElementById("getTokensButton");
    const viewExplorer = document.getElementById("viewExplorer");
    const notification = document.getElementById("notification");
    const txStatus = document.getElementById("txStatus");
    const txHashLink = document.getElementById("txHashLink");
    const txProgress = document.getElementById("txProgress");

    const daysEl = document.getElementById("days");
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");
    const secondsEl = document.getElementById("seconds");

    /********** Web3Modal **********/
    function setupWeb3Modal() {
      web3Modal = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions: {
          walletconnect: {
            package: window.WalletConnectProvider.default,
            options: { rpc: { [BSC_CHAIN_ID]: RPC_URLS[0] }, chainId: BSC_CHAIN_ID, qrcode: true }
          }
        },
        theme: "dark"
      });
    }

    /********** Connect **********/
    async function connectWallet() {
      try {
        showNotification("Connecting wallet...", "warning");
        connectBtn.disabled = true;
        buttonText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting';

        externalProvider = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(externalProvider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (network.chainId !== BSC_CHAIN_ID) {
          const ok = await ensureBscChain();
          if (!ok) {
            showNotification("Please switch to BNB Smart Chain (56)", "error");
            buttonText.innerHTML = '<i class="fas fa-wallet"></i> Connect Wallet';
            connectBtn.disabled = false;
            return;
          }
        }

        // Contracts
        kly = new ethers.Contract(CONTRACT_ADDRESS, TOKEN_ABI, signer);
        solToken = new ethers.Contract(SOL_DROP_ADDRESS, ERC20_ABI, signer);
        drop = new ethers.Contract(SOL_DROP_ADDRESS, DROP20_ABI, signer);

        // Check code exists
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if (!code || code === "0x") {
          showNotification("KLY contract not found on BNB Chain", "error");
          resetUiToDisconnected();
          return;
        }

        walletStatus.textContent = formatAddress(userAddress);
        buttonText.innerHTML = '<i class="fas fa-check-circle"></i> Connected';

        await loadBalancesAndGate();
        tokenInfo.style.display = "block";
        actionButtons.style.display = "flex";
        showNotification("Wallet connected successfully", "success");

        if (externalProvider.on) {
          externalProvider.on("accountsChanged", handleAccountsChanged);
          externalProvider.on("chainChanged", () => window.location.reload());
          externalProvider.on("disconnect", () => {
            web3Modal.clearCachedProvider?.();
            resetUiToDisconnected();
            showNotification("Wallet disconnected", "error");
          });
        }
      } catch (err) {
        console.error("Connection error:", err);
        showNotification("Connection failed", "error");
        buttonText.innerHTML = '<i class="fas fa-wallet"></i> Connect Wallet';
      } finally {
        connectBtn.disabled = false;
      }
    }

    async function ensureBscChain() {
      const hexChainId = "0x" + BSC_CHAIN_ID.toString(16);
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: hexChainId }]);
        return true;
      } catch (e) {
        if (e.code === 4902 || e?.data?.originalError?.code === 4902) {
          try {
            await provider.send("wallet_addEthereumChain", [{
              chainId: hexChainId,
              chainName: "BNB Smart Chain",
              nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
              rpcUrls: RPC_URLS,
              blockExplorerUrls: [EXPLORER_URL]
            }]);
            return true;
          } catch (e2) { return false; }
        }
        return false;
      }
    }

    function handleAccountsChanged(accounts) {
      if (!accounts.length) {
        web3Modal.clearCachedProvider?.();
        resetUiToDisconnected();
        showNotification("Wallet disconnected", "error");
      } else {
        userAddress = accounts[0];
        walletStatus.textContent = formatAddress(userAddress);
        loadBalancesAndGate();
        showNotification("Wallet account changed", "warning");
      }
    }

    function resetUiToDisconnected() {
      walletStatus.textContent = "Not connected";
      buttonText.innerHTML = '<i class="fas fa-wallet"></i> Connect Wallet';
      tokenInfo.style.display = "none";
      actionButtons.style.display = "none";
      txStatus.style.display = "none";
      buySolBtn.disabled = true;
    }

    /********** Balances & Gate **********/
    async function loadBalancesAndGate() {
      try {
        // Read decimals & symbols (with fallbacks)
        klyDecimals = await readDecimalsOr(kly, 18);
        solDecimals = await readDecimalsOr(solToken, 18);
        const [klySym, solSym] = await Promise.all([safeSymbol(kly), safeSymbol(solToken)]);

        const [klyBal, solBal] = await Promise.all([
          kly.balanceOf(userAddress),
          solToken.balanceOf(userAddress)
        ]);

        const klyHuman = ethers.utils.formatUnits(klyBal, klyDecimals);
        const solHuman = ethers.utils.formatUnits(solBal, solDecimals);

        klyAddressEl.textContent = formatAddress(CONTRACT_ADDRESS);
        solAddressEl.textContent = formatAddress(SOL_DROP_ADDRESS);
        klyBalanceEl.textContent = `${klyHuman} ${klySym}`;
        solBalanceEl.textContent = `${solHuman} ${solSym}`;

        // Gate text
        klyThresholdText.textContent = `${KLY_THRESHOLD_HUMAN} ${klySym}`;

        // Gate check
        const thresholdBase = ethers.utils.parseUnits(KLY_THRESHOLD_HUMAN, klyDecimals);
        const passed = klyBal.gte(thresholdBase);

        buySolBtn.disabled = !passed;
        buySolBtn.title = passed ? "Eligible to buy S√≥lCoin" : `Requires at least ${KLY_THRESHOLD_HUMAN} ${klySym}`;

        // subtle UI hint
        const gateInfo = document.getElementById("gateInfo");
        gateInfo.style.borderColor = passed ? "rgba(0,255,136,.7)" : "rgba(255,56,96,.6)";
        gateInfo.style.color = passed ? "var(--success)" : "var(--error)";
      } catch (err) {
        console.error("Balance/gate error:", err);
        showNotification("Failed to load balances", "error");
      }
    }

    /********** Mint KLY **********/
    async function mintTokens() {
      if (!signer) return showNotification("Please connect your wallet first", "error");
      try {
        showNotification("Preparing KLY mint...", "warning");
        getTokensButton.disabled = true;
        getTokensButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
        txStatus.style.display = "block";
        txHashLink.textContent = "Preparing transaction...";
        txHashLink.href = "#";
        txProgress.style.width = "10%";

        const mintAmount = ethers.utils.parseUnits("100", klyDecimals);

        let gasLimit;
        try { const est = await kly.estimateGas.mintTo(userAddress, mintAmount); gasLimit = est.mul(120).div(100); }
        catch { gasLimit = ethers.BigNumber.from(250000); }

        const tx = await kly.mintTo(userAddress, mintAmount, { gasLimit });
        txHashLink.textContent = formatAddress(tx.hash);
        txHashLink.href = `${EXPLORER_URL}/tx/${tx.hash}`;
        txProgress.style.width = "30%";

        let progress = 30;
        txInterval = setInterval(()=>{ progress+=1; if(progress<90) txProgress.style.width = `${progress}%`; }, 500);
        await tx.wait();
        clearInterval(txInterval);
        txProgress.style.width = "100%";

        await loadBalancesAndGate();
        showNotification("KLY minted successfully!", "success");
      } catch (err) {
        clearInterval(txInterval);
        const msg = err?.error?.message || err?.message || "unknown error";
        showNotification("Mint failed: " + msg, "error");
        txStatus.style.display = "none";
      } finally {
        getTokensButton.disabled = false;
        getTokensButton.innerHTML = '<i class="fas fa-coins"></i> Mint KLY';
      }
    }

    /********** Buy / Claim S√≥lCoin **********/
    async function buySolCoin(humanQty = "1") {
      if (!signer) return showNotification("Please connect your wallet first", "error");

      // Gate check before doing anything
      const currentKlyBal = await kly.balanceOf(userAddress);
      const thresholdBase = ethers.utils.parseUnits(KLY_THRESHOLD_HUMAN, klyDecimals);
      if (currentKlyBal.lt(thresholdBase)) {
        return showNotification(`Gate not met: need at least ${KLY_THRESHOLD_HUMAN} KLY`, "error");
      }

      try {
        // Optional: quick inspect in console
        // await inspectClaim();

        // 1) Read condition
        const condId = await drop.getActiveClaimConditionId();
        const cond = await drop.getClaimConditionById(condId);
        const pricePerToken = ethers.BigNumber.from(cond.pricePerToken);
        const currencyAddr = cond.currency; // keep exact value

        // 2) Qty in base units
        const qtyBase = ethers.utils.parseUnits(String(humanQty), solDecimals);

        // 3) Native vs ERC20 payment (for overrides/approvals only)
        const isNative =
          currencyAddr === ethers.constants.AddressZero ||
          (typeof currencyAddr === "string" && currencyAddr.toLowerCase() === NATIVE_TOKEN_SENTINEL.toLowerCase());

        // 4) Total cost
        const scale = ethers.BigNumber.from(10).pow(solDecimals);
        const totalCost = pricePerToken.mul(qtyBase).div(scale);

        let overrides = {};
        if (!pricePerToken.isZero()) {
          if (isNative) {
            const myBNB = await provider.getBalance(userAddress);
            if (myBNB.lt(totalCost)) {
              return showNotification(`Insufficient BNB. Need ${ethers.utils.formatEther(totalCost)} BNB`, "error");
            }
            overrides = { value: totalCost };
          } else {
            const payToken = new ethers.Contract(currencyAddr, ERC20_ABI, signer);
            const [dec, bal, allowance] = await Promise.all([
              payToken.decimals(), payToken.balanceOf(userAddress), payToken.allowance(userAddress, SOL_DROP_ADDRESS)
            ]);
            if (bal.lt(totalCost)) {
              const sym = await safeSymbol(payToken);
              return showNotification(`Insufficient ${sym}. Need ${ethers.utils.formatUnits(totalCost, dec)} ${sym}`, "error");
            }
            if (allowance.lt(totalCost)) {
              const approveTx = await payToken.approve(SOL_DROP_ADDRESS, totalCost);
              await approveTx.wait();
            }
          }
        }

        // 5) Allowlist proof (blank unless you have one)
        const allowlistProof = {
          proof: [],
          quantityLimitPerWallet: ethers.constants.Zero,
          pricePerToken: ethers.constants.Zero,
          currency: ethers.constants.AddressZero
        };

        // 6) Dry run
        await drop.callStatic.claim(
          userAddress, qtyBase, currencyAddr, pricePerToken, allowlistProof, "0x", overrides
        );

        // 7) Send tx
        const tx = await drop.claim(
          userAddress, qtyBase, currencyAddr, pricePerToken, allowlistProof, "0x", overrides
        );
        showNotification("Claim submitted...", "warning", `${EXPLORER_URL}/tx/${tx.hash}`);
        await tx.wait();

        await loadBalancesAndGate();
        showNotification("‚úÖ S√≥lCoin purchase confirmed!", "success", `${EXPLORER_URL}/tx/${tx.hash}`);
      } catch (err) {
        const reason = await decodeRevert(err);
        console.error("Buy S√≥lCoin error:", err);
        showNotification(`Buy S√≥lCoin failed: ${reason}`, "error");
      }
    }

    /********** Inspect & Helpers **********/
    async function inspectClaim() {
      const condId = await drop.getActiveClaimConditionId();
      const c = await drop.getClaimConditionById(condId);
      const now = Math.floor(Date.now() / 1000);
      console.table({
        condId: condId.toString(),
        start: `${c.startTimestamp} (${toDate(Number(c.startTimestamp))})`,
        active: now >= Number(c.startTimestamp),
        pricePerToken_raw: c.pricePerToken.toString(),
        currency: c.currency,
        perWallet: c.quantityLimitPerWallet?.toString?.(),
        maxSupply: c.maxClaimableSupply?.toString?.(),
        claimed: c.supplyClaimed?.toString?.(),
        merkleRoot: c.merkleRoot
      });
    }
    function toDate(ts){ if(!ts)return "0"; const d=new Date(Number(ts)*1000||Number(ts)); return isNaN(d.getTime())?String(ts):d.toISOString(); }
    function selectorOf(data){ return (typeof data==="string" && data.startsWith("0x")) ? data.slice(0,10) : null; }
    async function decodeRevert(error){
      try{
        const data = error?.error?.data || error?.data || error?.receipt?.revertReason || error?.message || "";
        const sel = selectorOf(data);
        if (sel === "0x08c379a0") { const [reason]=ethers.utils.defaultAbiCoder.decode(["string"],"0x"+data.slice(10)); return reason; }
        if (sel === "0x4e487b71") { const [code]=ethers.utils.defaultAbiCoder.decode(["uint256"],"0x"+data.slice(10)); return `Panic: ${code.toString()}`; }
        const iface = new ethers.utils.Interface([
          "error NotAuthorized()","error NotInMerkleProof()","error NotEnoughTokens()",
          "error ClaimInactive(uint256,uint256)","error ExceedsMaxPerWallet(uint256,uint256)",
          "error ExceedsMaxSupply(uint256,uint256)","error InvalidCurrency(address,address)",
          "error InsufficientFunds()","error WrongPrice(uint256,uint256)"
        ]);
        try{ const parsed=iface.parseError(data); if(parsed) return parsed.name+(parsed.args?.length?` ${parsed.args.map(a=>a.toString()).join(", ")}`:""); }catch{}
        return sel?`Reverted (${sel})`:(typeof data==="string"?data:"Transaction reverted");
      }catch{return "Transaction reverted";}
    }
    async function safeSymbol(erc20){ try{ return await erc20.symbol(); } catch { return "TOKEN"; } }
    async function readDecimalsOr(erc20, fallback=18){ try{ return await erc20.decimals(); } catch { return fallback; } }

    /********** UI utils **********/
    function viewOnExplorer(){ window.open(`${EXPLORER_URL}/token/${CONTRACT_ADDRESS}`, "_blank"); }
    function formatAddress(addr){ return addr ? `${addr.slice(0,6)}...${addr.slice(-4)}` : ""; }
    function showNotification(message, type="info", link=null){
      const el = notification;
      const icon = type==="error"?"fas fa-exclamation-circle":type==="success"?"fas fa-check-circle":type==="warning"?"fas fa-exclamation-triangle":"fas fa-info-circle";
      el.innerHTML = `<i class="${icon}"></i><span id="notificationMessage">${message}</span>${link?`<a href="${link}" target="_blank" style="color: var(--primary); margin-left: auto;"><i class="fas fa-external-link-alt"></i></a>`:""}`;
      el.className = `notification ${type} show`;
      clearTimeout(el.timeout); el.timeout = setTimeout(()=>el.classList.remove("show"), 5000);
    }

    /********** Countdown **********/
    function startCountdown(){
      const target=new Date(); target.setDate(target.getDate()+7);
      const update=()=>{
        const diff=+target-+new Date(); if(diff<=0){["days","hours","minutes","seconds"].forEach(id=>document.getElementById(id).textContent="00"); return;}
        const d=Math.floor(diff/86400000), h=Math.floor(diff%86400000/3600000), m=Math.floor(diff%3600000/60000), s=Math.floor(diff%60000/1000);
        daysEl.textContent=String(d).padStart(2,"0"); hoursEl.textContent=String(h).padStart(2,"0"); minutesEl.textContent=String(m).padStart(2,"0"); secondsEl.textContent=String(s).padStart(2,"0");
      };
      update(); setInterval(update,1000);
    }

    /********** Events & Init **********/
    function setupEventListeners(){
      connectBtn.addEventListener("click", connectWallet);
      getTokensButton.addEventListener("click", mintTokens);
      viewExplorer.addEventListener("click", viewOnExplorer);
      buySolBtn.addEventListener("click", ()=> buySolCoin("1"));
    }
    function initParticles(){
      particlesJS('particles-js',{
        particles:{number:{value:80,density:{enable:true,value_area:800}},color:{value:["#00ffe7","#ff00aa"]},
          shape:{type:"circle"},opacity:{value:.5,random:true},size:{value:3,random:true},
          line_linked:{enable:true,distance:150,color:"#00ffe7",opacity:.2,width:1},move:{enable:true,speed:1,random:true}},
        interactivity:{events:{onhover:{enable:true,mode:"grab"}}},retina_detect:true});
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      initParticles();
      setupWeb3Modal();
      setupEventListeners();
      startCountdown();
      if (web3Modal?.cachedProvider) connectWallet();
    });
  </script>
</body>
</html>
