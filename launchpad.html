<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KLY Launchpad — BNB Chain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="KLY Launchpad — Two-token growth on BNB Chain: KLY gates access & governance; SólCoin powers utility & community.">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Rajdhani:wght@500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <!-- BG -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

  <style>
    :root{
      --primary:#00ffe7; --secondary:#ff00aa;
      --accent:#e6c15a; --bnb:#F0B90B;
      --bg:#050506; --panel:#0d0e10; --panel-2:#111217;
      --text:#e9f0f0; --muted:#a9b0b5;
      --error:#ff3860; --ok:#00ff88; --warn:#ffaa00;
      --glow-1:0 0 18px rgba(0,255,231,.45);
      --glow-2:0 0 22px rgba(255,0,170,.35);
      --ring:1px solid rgba(0,255,231,.22);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 1200px at 10% 5%,rgba(0,255,231,.06),transparent 60%),
                 radial-gradient(1200px 1200px at 90% 10%,rgba(255,0,170,.05),transparent 60%),
                 var(--bg);
      color:var(--text); font-family:'Rajdhani',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      overflow-x:hidden;
    }
    /* Header */
    .site-header{
      position:sticky; top:0; z-index:50; backdrop-filter: blur(8px);
      background:linear-gradient(180deg,rgba(5,6,7,.85),rgba(5,6,7,.55) 60%,transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .header-inner{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:16px}
    .logo{font-family:'Orbitron',sans-serif;font-weight:700;letter-spacing:1.5px}
    .logo span{color:var(--primary);text-shadow:0 0 10px var(--primary)}
    .nav{margin-left:auto;display:flex;gap:14px;align-items:center}
    .nav a,.nav button.link{
      color:var(--text);opacity:.9;text-decoration:none;border:none;background:transparent;cursor:pointer;
      padding:8px 12px;border-radius:10px;font-family:'Montserrat',sans-serif;font-weight:600
    }
    .nav a:hover,.nav button.link:hover{background:rgba(255,255,255,.06)}
    .chain-pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(240,185,11,.35); color:var(--bnb); background:rgba(240,185,11,.12);
      box-shadow:0 0 10px rgba(240,185,11,.25) inset;
      font-size:.9rem
    }

    /* Hero / Card */
    .wrap{max-width:1100px;margin:38px auto;padding:0 18px}
    .hero{
      display:grid;grid-template-columns: 1.1fr .9fr; gap:24px;
    }
    @media(max-width:940px){ .hero{grid-template-columns:1fr} }
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      border:var(--ring); border-radius:20px; box-shadow:var(--glow-1),var(--glow-2);
      padding:26px; position:relative; overflow:hidden;
    }
    .panel::before{
      content:''; position:absolute; inset:-40%; background:
      radial-gradient(circle at 20% 0%, rgba(0,255,231,.12), transparent 45%),
      radial-gradient(circle at 80% -10%, rgba(255,0,170,.12), transparent 45%);
      transform:rotate(8deg); pointer-events:none;
    }

    h1.title{
      font-family:'Orbitron',sans-serif; font-weight:700; letter-spacing:1px; margin:0 0 6px;
      color:var(--primary); text-shadow:0 0 8px rgba(0,255,231,.6);
    }
    .subtitle{color:var(--muted); font-family:'Montserrat',sans-serif; line-height:1.6}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); margin:16px 0}

    .countdown{display:flex;gap:12px;flex-wrap:wrap}
    .cd-item{
      min-width:84px;text-align:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25)
    }
    .cd-num{font-size:1.5rem;font-weight:800;color:var(--primary);font-family:'Orbitron'}
    .cd-label{font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;color:#b9c2c8}

    .cta-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:800;
      font-family:'Montserrat',sans-serif; letter-spacing:.2px; transition:.25s;
      background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#081113;
      box-shadow:0 10px 26px rgba(0,255,231,.28);
    }
    .btn:hover{transform:translateY(-2px)}
    .btn.secondary{
      color:var(--text); background:linear-gradient(135deg,#2a2d34,#16181c);
      border:1px solid rgba(255,255,255,.14)
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .status{
      margin-top:14px;padding:12px;border-radius:12px;background:rgba(0,0,0,.35);
      border:1px solid rgba(0,255,231,.2); font-family:'Montserrat';
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Balances / Gate */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:520px){ .grid{grid-template-columns:1fr} }
    .block{
      padding:14px;border-radius:12px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.12)
    }
    .block h3{margin:0 0 8px;font-family:'Orbitron';font-size:1.05rem;color:var(--primary)}
    .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;color:#dfe6ea}
    .row .label{opacity:.8}
    .addr{display:inline-flex;align-items:center;gap:8px}
    .copy{border:none;background:transparent;color:var(--primary);cursor:pointer}
    .gate-pill{
      display:flex;align-items:center;gap:10px;margin-top:10px;padding:8px 10px;border-radius:999px;font-size:.9rem;
      border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.35)
    }
    .meter{height:8px;width:100%;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
    .meter > span{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));width:0%}

    /* Transaction panel */
    .tx{display:none;margin-top:14px;padding:12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12)}
    .tx .hash{display:flex;align-items:center;gap:10px;word-break:break-all}
    .progress{height:6px;background:rgba(255,255,255,.12);border-radius:6px;overflow:hidden;margin-top:8px}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));width:0%}

    /* Toast */
    .toast{
      position:fixed; right:20px; top:20px; z-index:1000; max-width:380px;
      transform:translateX(120%); transition:transform .35s cubic-bezier(.2,.8,.2,1);
      background:rgba(15,16,20,.96); color:#fff; border-left:4px solid var(--primary);
      padding:12px 14px; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.35); display:flex; gap:12px; align-items:center
    }
    .toast.show{transform:translateX(0)}
    .toast.ok{border-left-color:var(--ok)} .toast.err{border-left-color:var(--error)} .toast.warn{border-left-color:var(--warn)}

    /* Overlay badge on right card */
    .badge{
      position:absolute; right:14px; top:14px; padding:6px 10px; border-radius:999px; font-size:.82rem;
      border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.07); color:#dfe6ea
    }

    /* Particles layer */
    #particles-js{position:fixed; inset:0; z-index:-1; pointer-events:none}
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <header class="site-header">
    <div class="header-inner">
      <div class="logo">KLY<span>TOKEN</span></div>
      <div class="chain-pill"><i class="fa-brands fa-btc"></i> BNB Smart Chain • Mainnet</div>
      <nav class="nav">
        <a href="/index.html">Home</a>
        <a href="/vault.html">Vault</a>
        <a href="/oracle">Oracle</a>
        <button class="link" id="openExplorer"><i class="fa-solid fa-up-right-from-square"></i> Explorer</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <!-- Left: Call-to-action / Countdown -->
      <div class="panel">
        <h1 class="title">KLY LAUNCHPAD</h1>
        <p class="subtitle">Two-token growth: <b>KLY</b> gates access & governance; <b>SólCoin</b> powers utility & community.</p>
        <div class="divider"></div>

        <div class="countdown" aria-label="Countdown to next opening">
          <div class="cd-item"><div class="cd-num" id="d">00</div><div class="cd-label">Days</div></div>
          <div class="cd-item"><div class="cd-num" id="h">00</div><div class="cd-label">Hours</div></div>
          <div class="cd-item"><div class="cd-num" id="m">00</div><div class="cd-label">Minutes</div></div>
          <div class="cd-item"><div class="cd-num" id="s">00</div><div class="cd-label">Seconds</div></div>
        </div>

        <div class="cta-row">
          <button class="btn" id="connect"><i class="fa-solid fa-wallet"></i><span id="connectText">Connect Wallet</span></button>
          <button class="btn secondary" id="thirdwebSol"><i class="fa-solid fa-bolt"></i> Buy SólCoin (Thirdweb)</button>
          <button class="btn secondary" id="thirdwebNFT"><i class="fa-solid fa-cubes"></i> Mint NFT (Thirdweb)</button>
        </div>

        <div class="status" id="status">
          <div><i class="fa-solid fa-circle-dot" style="color:var(--primary)"></i> <span id="netText">Not connected</span></div>
          <div class="mono" id="addr">—</div>
        </div>

        <div class="tx" id="txBox" aria-live="polite">
          <div class="hash"><i class="fa-solid fa-arrows-rotate"></i> <a id="txHref" href="#" target="_blank" rel="noopener">Transaction pending...</a></div>
          <div class="progress"><span id="txProg"></span></div>
        </div>
      </div>

      <!-- Right: Balances / Gate / Actions -->
      <div class="panel">
        <span class="badge">Access Gate</span>

        <div class="grid">
          <div class="block">
            <h3>Contracts</h3>
            <div class="row">
              <span class="label">KLY</span>
              <span class="addr mono" id="klyAddr">— <button class="copy" data-copy-target="klyAddrFull" title="Copy"><i class="fa-regular fa-copy"></i></button></span>
              <span id="klyAddrFull" style="display:none;"></span>
            </div>
            <div class="row">
              <span class="label">SólCoin</span>
              <span class="addr mono" id="solAddr">— <button class="copy" data-copy-target="solAddrFull" title="Copy"><i class="fa-regular fa-copy"></i></button></span>
              <span id="solAddrFull" style="display:none;"></span>
            </div>
          </div>

          <div class="block">
            <h3>Balances</h3>
            <div class="row"><span class="label">KLY</span><span class="mono" id="klyBal">—</span></div>
            <div class="row"><span class="label">SólCoin</span><span class="mono" id="solBal">—</span></div>
          </div>
        </div>

        <div class="gate-pill" id="gatePill">
          <i class="fa-solid fa-lock"></i>
          <span>Gate requires <b id="threshTxt">—</b></span>
        </div>
        <div class="meter" style="margin-top:10px"><span id="gateMeter"></span></div>

        <div class="divider"></div>

        <div class="grid" id="actionGrid">
          <div class="block">
            <h3>Mint KLY</h3>
            <p class="subtitle" style="margin:6px 0 12px">Quick faucet for onboarding & testing. (Owner-gated on chain.)</p>
            <button class="btn" id="mintKLY"><i class="fa-solid fa-coins"></i> Mint 100 KLY</button>
            <small id="mintHint" class="subtitle">If mint is disabled, we’ll route you to explorer/Thirdweb.</small>
          </div>
          <div class="block">
            <h3>Buy SólCoin</h3>
            <div class="row" style="gap:10px">
              <span class="label">Quantity</span>
              <input id="solQty" type="number" min="1" step="1" value="1" style="width:120px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.35);color:var(--text)">
            </div>
            <button class="btn" id="buySol" disabled title="Requires gate"><i class="fa-solid fa-bolt"></i> Purchase</button>
            <small class="subtitle">Uses active claim condition (Thirdweb Drop20).</small>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"><i class="fa-solid fa-circle-info"></i><span id="toastMsg">Notice</span></div>

  <script>
    /********** Config **********/
    const CONTRACT_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52"; // KLY (ERC20)
    const SOL_DROP_ADDRESS = "0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026"; // SólCoin (ERC20/Drop)
    const BSC_CHAIN_ID = 56;
    const EXPLORER = "https://bscscan.com";
    const RPC_URL = "https://bsc-dataseed.binance.org/";
    const NATIVE_SENTINEL = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";

    // Gate
    const KLY_THRESHOLD_HUMAN = "1000"; // TODO: adjust
    const DEFAULT_MINT_AMOUNT = "100";

    // Helpful outbound links
    const THIRDWEB_SOL_LINK = "https://thirdweb.com/binance/0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026"; // TODO: direct SólCoin claim link
    const THIRDWEB_NFT_LINK = "https://thirdweb.com/"; // TODO: direct NFT mint link

    /********** ABIs **********/
    const TOKEN_MIN_ABI = [
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)"
    ];
    const TOKEN_WITH_MINT = [
      ...TOKEN_MIN_ABI,
      "function mintTo(address to, uint256 amount)"
    ];
    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 value) returns (bool)"
    ];
    const DROP20_ABI = [
      "function getActiveClaimConditionId() view returns (uint256)",
      "function getClaimConditionById(uint256) view returns (tuple(uint256 startTimestamp,uint256 maxClaimableSupply,uint256 supplyClaimed,uint256 quantityLimitPerWallet,bytes32 merkleRoot,uint256 pricePerToken,address currency,string metadata))",
      "function claim(address _receiver,uint256 _quantity,address _currency,uint256 _pricePerToken,(bytes32[] proof,uint256 quantityLimitPerWallet,uint256 pricePerToken,address currency) _allowlistProof,bytes _data) payable"
    ];

    /********** State **********/
    let web3Modal, extProvider, provider, signer, me;
    let kly, solErc20, drop;
    let klyDec = 18, solDec = 18;
    let canMint = false; // feature detect for mintTo
    let txTicker;

    /********** DOM **********/
    const el = (id)=>document.getElementById(id);
    const connectBtn = el("connect");
    const connectText = el("connectText");
    const netText = el("netText");
    const addrEl = el("addr");
    const txBox = el("txBox"), txHref = el("txHref"), txProg = el("txProg");
    const klyAddr = el("klyAddr"), klyAddrFull = el("klyAddrFull");
    const solAddr = el("solAddr"), solAddrFull = el("solAddrFull");
    const klyBal = el("klyBal"), solBal = el("solBal");
    const threshTxt = el("threshTxt");
    const gatePill = el("gatePill"), gateMeter = el("gateMeter");
    const mintBtn = el("mintKLY"), mintHint = el("mintHint");
    const buyBtn = el("buySol"), qtyInp = el("solQty");
    const toast = el("toast"), toastMsg = el("toastMsg");

    /********** Particles **********/
    particlesJS('particles-js',{
      particles:{ number:{value:80, density:{enable:true, value_area:800}},
        color:{value:["#00ffe7","#ff00aa"]}, shape:{type:"circle"},
        opacity:{value:.5,random:true}, size:{value:3,random:true},
        line_linked:{enable:true, distance:150, color:"#00ffe7", opacity:.2, width:1},
        move:{enable:true, speed:1, random:true}
      },
      interactivity:{events:{onhover:{enable:true,mode:"grab"}}}, retina_detect:true
    });

    /********** Countdown (7 days rolling) **********/
    (function startCountdown(){
      const t=new Date(); t.setDate(t.getDate()+7);
      const pad=(n)=>String(n).padStart(2,"0");
      const tick=()=>{
        const diff=t - new Date();
        let d=0,h=0,m=0,s=0;
        if(diff>0){
          d=Math.floor(diff/86400000);
          h=Math.floor(diff%86400000/3600000);
          m=Math.floor(diff%3600000/60000);
          s=Math.floor(diff%60000/1000);
        }
        el("d").textContent=pad(d); el("h").textContent=pad(h);
        el("m").textContent=pad(m); el("s").textContent=pad(s);
      };
      tick(); setInterval(tick,1000);
    })();

    /********** Web3Modal **********/
    function setupWeb3Modal(){
      web3Modal = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions:{
          walletconnect:{
            package: window.WalletConnectProvider.default,
            options:{ rpc:{ [BSC_CHAIN_ID]: RPC_URL }, chainId:BSC_CHAIN_ID, qrcode:true }
          }
        },
        theme:"dark"
      });
    }

    async function connect(){
      try{
        showToast("Connecting wallet…","warn");
        connectBtn.disabled = true;
        connectText.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Connecting`;

        extProvider = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(extProvider);
        signer = provider.getSigner();
        me = await signer.getAddress();

        const net = await provider.getNetwork();
        if(net.chainId !== BSC_CHAIN_ID){
          const ok = await ensureBsc();
          if(!ok){ showToast("Please switch to BNB Smart Chain (56)","err"); resetDisconnected(); return; }
        }

        // Feature-detect contract
        // Use a permissive ABI first; if mintTo exists, we'll enable it.
        kly = new ethers.Contract(CONTRACT_ADDRESS, TOKEN_WITH_MINT, signer);
        solErc20 = new ethers.Contract(SOL_DROP_ADDRESS, ERC20_ABI, signer);
        drop = new ethers.Contract(SOL_DROP_ADDRESS, DROP20_ABI, signer);

        // Ensure code exists
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if(!code || code === "0x"){
          showToast("KLY contract not found on BNB Chain","err");
          resetDisconnected(); return;
        }

        // Detect mintTo support safely
        canMint = !!kly.interface.functions["mintTo(address,uint256)"];

        // Wire provider events
        if(extProvider.on){
          extProvider.on("accountsChanged", (acc)=>{
            if(!acc?.length){ handleDisconnect(); return; }
            me = acc[0]; loadAll();
            showToast("Account switched","warn");
          });
          extProvider.on("chainChanged", ()=>window.location.reload());
          extProvider.on("disconnect", handleDisconnect);
        }

        netText.textContent = "Connected";
        addrEl.textContent = short(me);
        connectText.innerHTML = `<i class="fa-solid fa-check"></i> Connected`;

        await loadAll();
        showToast("Wallet connected","ok");
      }catch(e){
        console.error(e);
        showToast("Connection failed","err");
      }finally{
        connectBtn.disabled = false;
      }
    }

    function handleDisconnect(){
      web3Modal.clearCachedProvider?.();
      resetDisconnected();
      showToast("Wallet disconnected","err");
    }

    async function ensureBsc(){
      const hex = "0x"+BSC_CHAIN_ID.toString(16);
      try{
        await provider.send("wallet_switchEthereumChain", [{ chainId: hex }]);
        return true;
      }catch(e){
        if(e?.code === 4902 || e?.data?.originalError?.code === 4902){
          try{
            await provider.send("wallet_addEthereumChain",[{
              chainId:hex, chainName:"BNB Smart Chain",
              nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
              rpcUrls:[RPC_URL], blockExplorerUrls:[EXPLORER]
            }]);
            return true;
          }catch{ return false; }
        }
        return false;
      }
    }

    function resetDisconnected(){
      netText.textContent = "Not connected";
      addrEl.textContent = "—";
      connectText.innerHTML = `Connect Wallet`;
      document.querySelectorAll("#klyBal,#solBal,#klyAddr,#solAddr").forEach(n=>n.textContent="—");
      klyAddrFull.textContent = ""; solAddrFull.textContent = "";
      threshTxt.textContent = "—"; gateMeter.style.width = "0%";
      buyBtn.disabled = true; txBox.style.display="none";
    }

    /********** Loads **********/
    async function loadAll(){
      try{
        // decimals & symbols
        klyDec = await readDecimalsOr(kly, 18);
        solDec = await readDecimalsOr(solErc20, 18);
        const [klySym, solSym] = await Promise.all([safeSymbol(kly,"KLY"), safeSymbol(solErc20,"SOL")]);

        // contract addrs UI
        klyAddr.textContent = fmtAddr(CONTRACT_ADDRESS);
        solAddr.textContent = fmtAddr(SOL_DROP_ADDRESS);
        klyAddrFull.textContent = CONTRACT_ADDRESS;
        solAddrFull.textContent = SOL_DROP_ADDRESS;

        // balances
        const [kb, sb] = await Promise.all([kly.balanceOf(me), solErc20.balanceOf(me)]);
        const kbH = ethers.utils.formatUnits(kb, klyDec);
        const sbH = ethers.utils.formatUnits(sb, solDec);
        klyBal.textContent = `${kbH} ${klySym}`;
        solBal.textContent = `${sbH} ${solSym}`;

        // gate
        const needBase = ethers.utils.parseUnits(KLY_THRESHOLD_HUMAN, klyDec);
        const have = kb;
        const pct = Math.max(0, Math.min(100, have.mul(10000).div(needBase).toNumber()/100));
        gateMeter.style.width = `${pct}%`;
        threshTxt.textContent = `${KLY_THRESHOLD_HUMAN} ${klySym}`;
        const passed = have.gte(needBase);

        gatePill.style.borderColor = passed ? "rgba(0,255,136,.7)" : "rgba(255,56,96,.6)";
        gatePill.style.color = passed ? "var(--ok)" : "var(--error)";
        buyBtn.disabled = !passed;
        buyBtn.title = passed ? "Eligible to buy SólCoin" : `Requires at least ${KLY_THRESHOLD_HUMAN} ${klySym}`;

        // Mint capability hint
        mintBtn.disabled = !canMint;
        mintHint.textContent = canMint
          ? "Mint is enabled on this contract."
          : "Mint function not detected. Use Thirdweb/Explorer instead.";
      }catch(e){
        console.error(e); showToast("Failed to load balances","err");
      }
    }

    /********** Actions **********/
    async function doMint(){
      if(!signer) return showToast("Connect your wallet first","err");
      if(!canMint){
        window.open(`${EXPLORER}/token/${CONTRACT_ADDRESS}`,'_blank'); return;
      }
      try{
        showToast("Preparing KLY mint…","warn");
        txBox.style.display="block"; txHref.textContent="Preparing transaction…"; txHref.href="#"; setProg(12);

        const amt = ethers.utils.parseUnits(DEFAULT_MINT_AMOUNT, klyDec);

        let gas;
        try{ const est = await kly.estimateGas.mintTo(me, amt); gas = est.mul(120).div(100); }
        catch{ gas = ethers.BigNumber.from(250000); }

        const tx = await kly.mintTo(me, amt, { gasLimit: gas });
        txHref.textContent = short(tx.hash); txHref.href = `${EXPLORER}/tx/${tx.hash}`;
        animateProgTo(88);

        await tx.wait(); setProg(100);
        await loadAll();
        confetti(); showToast("KLY minted successfully","ok");
      }catch(err){
        console.error(err);
        txBox.style.display="none";
        showToast(parseRevert(err) || "Mint failed","err");
      }
    }

    async function buySol(){
      if(!signer) return showToast("Connect your wallet first","err");

      // Re-check gate swiftly
      try{
        const bal = await kly.balanceOf(me);
        const need = ethers.utils.parseUnits(KLY_THRESHOLD_HUMAN, klyDec);
        if(bal.lt(need)) return showToast(`Gate not met: need ${KLY_THRESHOLD_HUMAN} KLY`,"err");
      }catch{}

      try{
        const qtyHuman = (qtyInp.value||"1").toString();
        const condId = await drop.getActiveClaimConditionId();
        const c = await drop.getClaimConditionById(condId);
        const pricePer = ethers.BigNumber.from(c.pricePerToken);
        const currency = c.currency;

        const qtyBase = ethers.utils.parseUnits(qtyHuman, solDec);

        // compute total cost = pricePer * qty in token units (Drop20: price is per whole unit)
        const totalCost = pricePer.mul(qtyBase).div(ethers.BigNumber.from(10).pow(solDec));

        let overrides={};
        if(!pricePer.isZero()){
          const isNative = (currency === ethers.constants.AddressZero) ||
                           (typeof currency==="string" && currency.toLowerCase()===NATIVE_SENTINEL.toLowerCase());
          if(isNative){
            const bnb = await provider.getBalance(me);
            if(bnb.lt(totalCost)) return showToast(`Insufficient BNB. Need ${ethers.utils.formatEther(totalCost)} BNB`,"err");
            overrides = { value: totalCost };
          }else{
            const pay = new ethers.Contract(currency, ERC20_ABI, signer);
            const [dec, bal, allow] = await Promise.all([
              pay.decimals(), pay.balanceOf(me), pay.allowance(me, SOL_DROP_ADDRESS)
            ]);
            if(bal.lt(totalCost)){
              const sym = await safeSymbol(pay,"PAY");
              return showToast(`Insufficient ${sym}. Need ${ethers.utils.formatUnits(totalCost,dec)} ${sym}`,"err");
            }
            if(allow.lt(totalCost)){
              showToast("Approving spend…","warn");
              const atx = await pay.approve(SOL_DROP_ADDRESS, totalCost); await atx.wait();
            }
          }
        }

        // Optional allowlist proof (blank)
        const allowlist = { proof:[], quantityLimitPerWallet:0, pricePerToken:0, currency:ethers.constants.AddressZero };

        // Dry-run
        await drop.callStatic.claim(me, qtyBase, currency, pricePer, allowlist, "0x", overrides);

        showToast("Submitting purchase…","warn");
        txBox.style.display="block"; setProg(20);
        const tx = await drop.claim(me, qtyBase, currency, pricePer, allowlist, "0x", overrides);
        txHref.textContent = short(tx.hash); txHref.href = `${EXPLORER}/tx/${tx.hash}`;
        animateProgTo(85);
        await tx.wait();
        setProg(100);
        await loadAll();
        confetti(); showToast("SólCoin purchase confirmed","ok");
      }catch(err){
        console.error(err);
        txBox.style.display="none";
        showToast(`Buy SólCoin failed: ${parseRevert(err) || 'Reverted'}`,"err");
      }
    }

    /********** Helpers **********/
    function short(a){ return a ? `${a.slice(0,6)}…${a.slice(-4)}` : "—"; }
    function fmtAddr(a){ return a ? `${a.slice(0,6)}…${a.slice(-4)}` : "—"; }
    function setProg(p){ txProg.style.width = p+"%"; }
    function animateProgTo(target){
      let w = parseInt(txProg.style.width||"0"); clearInterval(txTicker);
      txTicker = setInterval(()=>{ w += 1; if(w >= target){ clearInterval(txTicker); } txProg.style.width = w+"%"; }, 400);
    }
    function showToast(msg, kind="info", timeout=4800){
      toast.className = "toast show";
      if(kind==="ok") toast.classList.add("ok");
      else if(kind==="err") toast.classList.add("err");
      else if(kind==="warn") toast.classList.add("warn");
      toastMsg.textContent = msg;
      clearTimeout(toast._t); toast._t = setTimeout(()=> toast.className="toast", timeout);
    }
    async function safeSymbol(erc20, fallback="TOKEN"){ try{ return await erc20.symbol(); } catch { return fallback; } }
    async function readDecimalsOr(erc20, fb=18){ try{ return await erc20.decimals(); } catch { return fb; } }

    function parseRevert(error){
      try{
        const data = error?.error?.data || error?.data || "";
        if(typeof data === "string" && data.startsWith("0x08c379a0")){
          const [reason] = ethers.utils.defaultAbiCoder.decode(["string"], "0x"+data.slice(10));
          return reason;
        }
      }catch{}
      return error?.reason || error?.message;
    }

    // Light confetti burst without external deps
    function confetti(){
      try{
        const n=28, root=document.body;
        for(let i=0;i<n;i++){
          const s=document.createElement('span');
          s.style.position='fixed';
          s.style.left=(50+Math.random()*10-5)+'%';
          s.style.top='-10px';
          s.style.width=s.style.height=(6+Math.random()*8)+'px';
          s.style.background = ['#00ffe7','#ff00aa','#e6c15a','#00ff88'][i%4];
          s.style.borderRadius='2px';
          s.style.pointerEvents='none';
          s.style.zIndex=9999;
          s.style.transform=`rotate(${Math.random()*360}deg)`;
          s.style.transition='transform 1.6s ease, top 1.6s ease, opacity 1.8s ease';
          root.appendChild(s);
          requestAnimationFrame(()=>{
            s.style.top = '110%';
            s.style.transform += ` translate(${(Math.random()*2-1)*140}px,0) rotate(${(Math.random()*2-1)*360}deg)`;
            s.style.opacity='0';
          });
          setTimeout(()=>s.remove(),1900);
        }
      }catch{}
    }

    /********** Events **********/
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.copy')){
        const targetId = e.target.closest('.copy').dataset.copyTarget;
        const val = document.getElementById(targetId)?.textContent?.trim();
        if(val){ navigator.clipboard.writeText(val); showToast("Address copied","ok",2000); }
      }
    });
    connectBtn.addEventListener('click', connect);
    el('openExplorer').addEventListener('click', ()=> window.open(`${EXPLORER}/token/${CONTRACT_ADDRESS}`,'_blank'));
    el('thirdwebSol').addEventListener('click', ()=> window.open(THIRDWEB_SOL_LINK,'_blank'));
    el('thirdwebNFT').addEventListener('click', ()=> window.open(THIRDWEB_NFT_LINK,'_blank'));
    mintBtn.addEventListener('click', doMint);
    buyBtn.addEventListener('click', buySol);

    /********** Init **********/
    (function init(){
      setupWeb3Modal();
      // Show contract addresses immediately for copying
      klyAddr.textContent = fmtAddr(CONTRACT_ADDRESS); klyAddrFull.textContent = CONTRACT_ADDRESS;
      solAddr.textContent = fmtAddr(SOL_DROP_ADDRESS); solAddrFull.textContent = SOL_DROP_ADDRESS;
      threshTxt.textContent = `${KLY_THRESHOLD_HUMAN} KLY`;

      if(window.Web3Modal && web3Modal?.cachedProvider){ connect(); }
    })();
  </script>
</body>
</html>
