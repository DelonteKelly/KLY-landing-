<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sovereignty Mastery — Aurora Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Token-gated sovereignty mastery program with Web3 integration" />

<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=General+Sans:wght@400;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- Motion & Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- Web3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
  :root{
    /* Aurora palette */
    --bg:#070a12; --bg2:#0b0f1c; --glass:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.08);
    --ink:#e9eefc; --muted:#b5c1de; --line:rgba(177,198,255,.16);
    --cyn:#7ae9ff; --vio:#8d7bff; --pnk:#ff77e1; --mint:#69ffb4; --sun:#ffc56b; --red:#ff5d6c;
    --ring:0 0 0 2px rgba(122,233,255,.25);
    --radius:16px; --radius-sm:12px; --shadow:0 18px 60px rgba(0,0,0,.45);
    --ease:cubic-bezier(.2,.7,.1,1); --time:.25s;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{scroll-behavior:smooth}
  body{
    margin:0; color:var(--ink);
    font-family:"General Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 800px at 10% -5%, rgba(122,233,255,.12), transparent 60%),
      radial-gradient(1000px 700px at 100% -20%, rgba(141,123,255,.12), transparent 60%),
      conic-gradient(from 210deg at 60% 0%, rgba(255,119,225,.07), transparent 40%),
      linear-gradient(180deg, var(--bg), var(--bg2) 55%, #070915);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  a{color:var(--cyn); text-decoration:none}
  a:hover{opacity:.9}
  button{font-family:inherit}

  /* Reduce motion respect */
  @media (prefers-reduced-motion:reduce){
    *{animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important}
  }

  /* Global shells */
  .shell{display:grid; grid-template-rows:auto 1fr auto; min-height:100vh}
  .top{
    position:sticky; top:0; z-index:50; backdrop-filter:blur(10px) saturate(1.05);
    background:linear-gradient(180deg, rgba(7,10,18,.9), rgba(7,10,18,.65));
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:14px 18px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand i{color:var(--cyn); filter:drop-shadow(0 0 10px rgba(122,233,255,.6))}
  .brand-title{font-family:"Space Grotesk"; font-weight:800; letter-spacing:.4px}
  .rchip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); color:#cfe2ff; background:var(--glass)}

  /* Buttons with animated gradient motion */
  .btn{
    --grad-x:0%;
    border:1px solid var(--line); color:var(--ink);
    background:linear-gradient(90deg, rgba(122,233,255,.18), rgba(141,123,255,.18));
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px;
    box-shadow:0 0 0 1px rgba(122,233,255,.12);
    transition:transform var(--time) var(--ease), box-shadow var(--time), background-position .6s var(--ease);
    background-size:200% 100%; background-position:var(--grad-x) 50%;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(141,123,255,.2); --grad-x:100%}
  .btn-ghost{background:transparent}

  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .hide{display:none!important}

  /* HERO — cinematic landing */
  .hero{
    position:relative; overflow:hidden;
    border-bottom:1px solid var(--line);
    background:
      radial-gradient(1200px 800px at 10% -5%, rgba(122,233,255,.12), transparent 60%),
      radial-gradient(1200px 800px at 90% -10%, rgba(141,123,255,.12), transparent 60%);
  }
  .hero-wrap{max-width:1150px; margin:0 auto; padding:56px 18px 32px}
  .hero-grid{display:grid; grid-template-columns:1.2fr .8fr; gap:22px; align-items:center}
  @media (max-width:980px){ .hero-grid{grid-template-columns:1fr} }
  .hero-title{font-family:"Space Grotesk"; font-weight:800; letter-spacing:.4px; font-size:clamp(28px, 5vw, 48px); line-height:1.06; margin:0 0 10px}
  .hero-sub{color:var(--muted); margin:0 0 16px}
  .hero-cta{display:flex; gap:10px; flex-wrap:wrap}
  .hero-card{background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.03)); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow)}
  .callouts{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px}
  @media (max-width:780px){ .callouts{grid-template-columns:1fr} }
  .aurora-waves{
    position:absolute; inset:-20% -10% auto -10%; height:180px; pointer-events:none; opacity:.55;
    background:linear-gradient(90deg, rgba(122,233,255,.25), rgba(141,123,255,.2), rgba(255,119,225,.18));
    filter:blur(24px);
    animation:wave 9s var(--ease) infinite alternate;
  }
  @keyframes wave{
    0%{transform:translateY(0) skewX(-5deg)}
    100%{transform:translateY(-20px) skewX(5deg)}
  }
  /* Particle canvas (subtle) */
  #auroraParticles{position:absolute; inset:0; z-index:0; opacity:.25}

  /* MAIN LAYOUT */
  .main{display:grid; grid-template-columns:280px 1fr 320px; gap:18px; padding:18px}
  @media (max-width:1100px){ .main{grid-template-columns:1fr} }

  /* Panels */
  .panel{
    position:relative;
    background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.03));
    border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
  }
  .panel h3{margin:0 0 10px}

  /* Sidebar */
  .profile{display:flex; align-items:center; gap:12px; padding-bottom:12px; border-bottom:1px dashed var(--line); margin-bottom:12px}
  .avatar{width:48px; height:48px; border-radius:50%; display:grid; place-items:center; font-weight:800;
    background:
      radial-gradient(closest-side, #ffffff22 30%, #0000 60%),
      linear-gradient(135deg, var(--cyn), var(--vio));
    box-shadow:0 0 0 3px rgba(122,233,255,.15);
  }
  .side-menu{display:flex; flex-direction:column; gap:10px; margin-top:8px}
  .sbtn{
    width:100%; text-align:left; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
    background:rgba(255,255,255,.04); color:var(--ink); display:flex; align-items:center; gap:10px; cursor:pointer; transition:.2s var(--ease);
  }
  .sbtn:hover{transform:translateX(4px); border-color:rgba(122,233,255,.35)}
  .badge{min-width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
    background:rgba(122,233,255,.12); border:1px solid rgba(122,233,255,.25); color:#bff1ff; font-weight:800;
  }
  .tag{margin-left:auto; background:linear-gradient(90deg, var(--mint), var(--cyn)); color:#06101a; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}

  /* Center */
  .searchbar{display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.06); border:1px solid var(--line); padding:8px 12px; border-radius:999px}
  .searchbar input{flex:1; background:transparent; border:0; color:var(--ink); outline:none}
  .filter-row{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px}
  .chip{background:rgba(255,255,255,.06); border:1px solid var(--line); color:#cfe2ff; border-radius:999px; padding:6px 10px; cursor:pointer}
  .chip.active{background:linear-gradient(90deg, var(--cyn), var(--vio)); color:#06101a; border:0}

  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--line); border-radius:var(--radius-sm); padding:14px; display:flex; flex-direction:column; gap:10px; position:relative; overflow:hidden;
  }
  .card:hover{border-color:rgba(141,123,255,.5)}
  .card.lock{opacity:.85}
  .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .muted{color:var(--muted)}
  .progress{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--cyn), #b0a8ff, var(--pnk)); width:0%; transition:width .5s var(--ease)}

  /* Lock overlay + preview */
  .lock-overlay{
    position:absolute; inset:0; display:grid; place-items:center;
    background:linear-gradient(180deg, rgba(7,10,18,.4), rgba(7,10,18,.65));
    backdrop-filter:blur(2px);
  }
  .lock-box{
    display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center;
    background:rgba(255,255,255,.06); border:1px dashed var(--line); padding:12px; border-radius:12px;
  }
  .preview-snippet{max-height:64px; overflow:hidden; mask-image:linear-gradient(180deg, #000 60%, transparent); font-size:13px}

  .detail{margin-top:12px; border:1px solid var(--line); border-radius:var(--radius); padding:18px; display:none}
  .detail.show{display:block}
  .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; color:#cfe2ff}
  .pill.ready{border-color:rgba(105,255,180,.4); color:#c4ffe3}
  .lesson{background:rgba(122,233,255,.08); border-left:3px solid var(--cyn); padding:12px; border-radius:0 10px 10px 0; margin:10px 0}

  /* Right column: gate + cert */
  .ring{--p:0; --size:88px; width:var(--size); height:var(--size); border-radius:50%;
    background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--mint) var(--p), #23273a 0);
    position:relative; transition:background .6s var(--ease);
  }
  .ring::before{
    content:attr(data-label); position:absolute; inset:8px; border-radius:50%; display:grid; place-items:center; color:#a8f9ff;
    border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    font-weight:800;
  }
  .cert-img{border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.45)}
  .cert-img img{display:block; width:100%}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(7,10,18,.86); backdrop-filter:blur(10px); z-index:1000}
  .modal.show{display:grid}
  .modal-card{width:min(900px,90vw); max-height:90vh; overflow:auto; background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:18px; padding:18px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); padding-bottom:10px; margin-bottom:12px}
  .x{background:transparent; border:0; color:var(--ink); cursor:pointer}
  .x:hover{color:var(--red)}

  /* Conversion sections */
  .section{padding:24px 18px; border-top:1px solid var(--line)}
  .faq dt{font-weight:800; margin-top:12px}
  .faq dd{margin:6px 0 12px; color:var(--muted)}
  .testis{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px}
  .quote{border:1px solid var(--line); border-radius:12px; padding:14px; background:rgba(255,255,255,.04)}
  .pricing{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px}
  .price-card{border:1px solid var(--line); border-radius:14px; padding:16px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))}
  .price{font-size:28px; font-weight:800}

  /* Footer */
  footer{border-top:1px solid var(--line); padding:16px 18px; color:var(--muted); text-align:center}

  /* Mobile nudges */
  @media (max-width:860px){
    .topbar{gap:8px}
    .rchip.hide-sm{display:none}
  }
  <style>
  :root{
    --sm-gold:#ffd36e; --sm-emerald:#00ffa3; --sm-ink:#0b0d12; --sm-panel:#141a2b; --sm-text:#e8f0ff;
  }
  .sm-btn{
    --pad-y:10px; --pad-x:16px; --radius:12px;
    display:inline-flex; align-items:center; gap:.6rem;
    padding:var(--pad-y) var(--pad-x); border-radius:var(--radius);
    text-decoration:none; font-weight:700; letter-spacing:.25px;
    color:var(--sm-text); background:linear-gradient(180deg,#1b2337,#131a2c);
    border:1px solid rgba(255,255,255,.12); box-shadow: 0 0 0 2px rgba(255,211,110,.08);
    transition: transform .15s ease, border-color .15s ease, box-shadow .15s ease, opacity .15s ease;
  }
  .sm-btn:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,.25); box-shadow:0 0 0 3px rgba(0,255,163,.18); }
  .sm-btn:active{ transform:translateY(0); opacity:.95; }

  .sm-btn--primary{
    background:linear-gradient(90deg,var(--sm-gold),var(--sm-emerald));
    color:#0b0d12; border-color:rgba(0,0,0,.15);
  }
  .sm-btn--ghost{
    background:transparent; border:1px solid rgba(255,255,255,.18);
  }
  .sm-btn--outline{
    background:transparent;
    border-image: linear-gradient(90deg,var(--sm-gold),var(--sm-emerald)) 1;
  }

  .sm-btn--lg{ --pad-y:14px; --pad-x:22px; font-size:1.05rem; border-radius:14px; }
  .sm-btn--sm{ --pad-y:8px;  --pad-x:12px; font-size:.92rem;  border-radius:10px; }

  .sm-btn__icon{ display:inline-grid; place-items:center; width:1.15em; height:1.15em; }
</style>
</style>
</head>
<body>
<div class="shell">

  <!-- HEADER -->
  <header class="top">
    <div class="wrap topbar" role="navigation" aria-label="Global">
      <div class="brand">
        <i class="fa-solid fa-crown"></i>
        <div>
          <div class="brand-title">Sovereignty Mastery</div>
          <small class="muted">Aurora Edition</small>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <span id="chip-progress" class="rchip hide-sm"><i class="fa-solid fa-chart-simple"></i><span id="chip-text">0/21 Complete</span></span>
        <span id="xp-chip" class="rchip hide-sm"><i class="fa-solid fa-bolt"></i><span id="xp-text">0 XP</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect</button>
        <span id="addr-chip" class="rchip addr hide" aria-live="polite"><i class="fa-solid fa-user-astronaut"></i><span id="addr-short">0x…</span></span>
      </div>
    </div>
  </header>

  <!-- 🔮 HERO / LANDING -->
  <section class="hero" id="hero">
    <canvas id="auroraParticles" aria-hidden="true"></canvas>
    <div class="aurora-waves"></div>
    <div class="hero-wrap">
      <div class="hero-grid">
        <div>
          <h1 class="hero-title">Reclaim Your Authority.<br/>Live Sovereign.</h1>
          <p class="hero-sub">
            Sovereignty Mastery is a token-gated path into inner authority, aligned decision-making, and embodied leadership.
            Web3 access proves ownership and unlocks the Sovereign track when you hold the required tokens.
          </p>
          <div class="hero-cta">
            <button id="hero-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet & Begin</button>
            <a href="#dashboard" class="btn btn-ghost"><i class="fa-regular fa-circle-play"></i> Preview the Curriculum</a>
          </div>
          <div class="callouts">
            <div class="hero-card"><strong>Why Web3?</strong><div class="muted">Ownership, portability, and on-chain proof of progress.</div></div>
            <div class="hero-card"><strong>Gate Logic</strong><div class="muted">Hold tokens → unlock Sovereign modules.</div></div>
            <div class="hero-card"><strong>On-chain Certificate</strong><div class="muted">Mint an ERC-721 NFT when complete.</div></div>
          </div>
        </div>
        <div class="hero-card">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <strong>Access Status</strong>
            <div class="ring" id="hero-ring" data-label="0%"></div>
          </div>
          <p id="hero-msg" class="muted" style="margin:8px 0 0">Connect wallet to explore Sovereignty Mastery.</p>
          <div style="display:flex; gap:8px; margin-top:10px">
            <span class="rchip"><i class="fa-solid fa-coins"></i> Required: <strong style="margin-left:6px" id="req-tokens">5</strong></span>
            <span class="rchip"><i class="fa-solid fa-shield"></i> Chain: BNB</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <a class="sm-btn sm-btn--primary sm-btn--lg"
   href="/right-knowledge.html"
   target="_self"
   role="button"
   aria-label="Enter Right Knowledge Portal">
  <span class="sm-btn__icon">📜</span>
  Enter Right Knowledge
</a>

  <!-- MAIN -->
  <div class="wrap main" id="dashboard">

    <!-- LEFT: SIDEBAR -->
    <aside class="panel" aria-label="Navigation">
      <div class="profile">
        <div class="avatar" id="avatar">SM</div>
        <div>
          <div style="font-weight:800">Learner</div>
          <div id="addr-full" class="addr muted">Not connected</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:10px">
        <button id="btn-disconnect" class="btn btn-ghost hide"><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        <button id="btn-reconnect" class="btn btn-ghost hide"><i class="fa-solid fa-plug-circle-bolt"></i> Reconnect</button>
      </div>

      <h3 style="margin-top:4px">Areas</h3>
      <div id="menu" class="side-menu"></div>

      <h3 style="margin-top:16px">Shortcuts</h3>
      <div class="side-menu">
        <button class="sbtn" data-tab="overview"><i class="fa-regular fa-grid-2"></i> Overview <span class="tag">Home</span></button>
        <button class="sbtn" data-tab="syllabus"><i class="fa-regular fa-list-check"></i> Syllabus <span class="tag">All</span></button>
        <button class="sbtn" data-tab="progress"><i class="fa-regular fa-chart-line"></i> Progress <span class="tag">Stats</span></button>
        <button class="sbtn" data-tab="resources"><i class="fa-regular fa-folder-open"></i> Resources <span class="tag">Links</span></button>
      </div>
    </aside>

    <!-- CENTER: CURRICULUM -->
    <main class="panel" aria-live="polite">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div class="searchbar" role="search"><i class="fa-solid fa-magnifying-glass"></i><input id="search" type="search" placeholder="Search modules, themes, objectives…" aria-label="Search modules"></div>
        <div class="filter-row" id="filters">
          <button class="chip active" data-filter="all">All</button>
          <button class="chip" data-filter="core">Core</button>
          <button class="chip" data-filter="sovereign">Sovereign</button>
          <button class="chip" data-filter="not-started">Not started</button>
          <button class="chip" data-filter="in-progress">In progress</button>
          <button class="chip" data-filter="completed">Completed</button>
        </div>
      </div>

      <div id="views">
        <!-- Overview -->
        <section id="view-overview">
          <div id="grid-overview" class="grid" role="list"></div>
        </section>

        <!-- Syllabus -->
        <section id="view-syllabus" class="hide">
          <div id="grid-syllabus" class="grid" role="list"></div>
        </section>

        <!-- Progress -->
        <section id="view-progress" class="hide">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
            <div class="card">
              <div class="row"><strong>Total Completion</strong><span class="pill" id="pill-total">0%</span></div>
              <div class="progress"><span id="bar-total"></span></div>
              <div class="muted"><span id="done-total">0</span>/<span id="count-total">0</span> modules</div>
            </div>
            <div class="card">
              <div class="row"><strong>Core</strong><span class="pill" id="pill-core">0%</span></div>
              <div class="progress"><span id="bar-core"></span></div>
              <div class="muted"><span id="done-core">0</span>/<span id="count-core">0</span></div>
            </div>
            <div class="card">
              <div class="row"><strong>Sovereign</strong><span class="pill" id="pill-sov">0%</span></div>
              <div class="progress"><span id="bar-sov"></span></div>
              <div class="muted"><span id="done-sov">0</span>/<span id="count-sov">0</span></div>
            </div>

            <!-- 📊 Gamification cards -->
            <div class="card">
              <div class="row"><strong>XP</strong><span class="pill" id="pill-xp">0</span></div>
              <div class="muted">Earn +50 XP per module completion. <span id="streak-text" class="pill" style="margin-left:6px">Streak: 0</span></div>
            </div>
            <div class="card">
              <div class="row"><strong>Rank</strong><span class="pill" id="pill-rank">—</span></div>
              <div class="muted" id="rank-desc">Complete more to boost your rank.</div>
            </div>
          </div>
          <div id="grid-progress" class="grid" style="margin-top:12px"></div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="hide">
          <div class="card">
            <h3 style="margin:6px 0 8px">Resources & Downloads</h3>
            <ul class="muted">
              <li>📝 Worksheets: Sovereignty Audit, Resource Audit, Boundaries Scripts</li>
              <li>🎧 Practices: Deep Listening, Micro-Surrender, Box Breathing (4-4-6-2)</li>
              <li>📚 Reading: Presence, Nonviolent Communication, Essentialism</li>
            </ul>
          </div>
        </section>
      </div>

      <!-- Detail (inline) -->
      <section id="detail" class="detail" aria-describedby="detail-title">
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <div style="display:flex; align-items:center; gap:10px">
            <div class="badge" id="detail-num">1</div>
            <h3 id="detail-title" style="margin:0">Module</h3>
          </div>
        <span class="pill" id="detail-area">Area</span>
        <span class="pill" id="detail-status">Not Started</span>
        <span class="pill" id="detail-theme">Theme</span>
        </div>
        <div id="detail-body" style="margin-top:8px"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn btn-ghost" id="btn-prev"><i class="fa-solid fa-arrow-left-long"></i> Prev</button>
          <div style="flex:1"></div>
          <button class="chip" id="btn-mark"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
          <button class="btn" id="btn-full"><i class="fa-regular fa-expand"></i> Full View</button>
          <button class="btn btn-ghost" id="btn-next">Next <i class="fa-solid fa-arrow-right-long"></i></button>
        </div>
      </section>
    </main>

    <!-- RIGHT: GATE + CERT -->
    <aside class="panel" aria-label="Access & Certificate">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Access Gate</h3>
        <div class="ring" id="ring" data-label="0%"></div>
      </div>
      <p class="muted" id="gate-note">Connect wallet to explore Sovereignty Mastery.</p>
      <div class="card">
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center">
            <i class="fa-solid fa-coins" style="color:var(--mint)"></i>
            <div><div class="muted">Your balance</div><strong id="token-balance">—</strong></div>
          </div>
          <button id="btn-gate-connect" class="btn btn-ghost"><i class="fa-solid fa-plug-circle-bolt"></i> Connect</button>
        </div>
      </div>

      <h3 style="margin:12px 0 8px">Certificate</h3>
      <div class="cert-img"><img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="Certificate"/></div>
      <div class="row" style="margin:10px 0"><span class="muted">Status</span><strong id="cert-status">Locked</strong></div>
      <div class="row" style="margin:6px 0"><span class="muted">Progress</span><strong id="cert-progress">0 / 21</strong></div>
      <button class="btn" id="btn-mint" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
      <div id="mint-status" class="muted" style="margin-top:8px"></div>

      <!-- Metadata preview -->
      <div id="nft-preview" class="card" style="margin-top:12px; display:none">
        <div class="row"><strong>Certificate Preview</strong><span class="pill" id="nft-edition">Edition —</span></div>
        <div class="muted" id="nft-name">—</div>
        <div class="muted" id="nft-attrs" style="margin-top:6px">Attributes: —</div>
        <div id="share-wrap" style="margin-top:10px; display:none">
          <a id="share-x" class="btn btn-ghost" target="_blank" rel="noopener"><i class="fa-brands fa-x-twitter"></i> Share on X</a>
        </div>
      </div>
    </aside>

  </div>

  <!-- 🔗 Conversion Sections -->
  <section class="section wrap">
    <h3>FAQ</h3>
    <dl class="faq">
      <dt>What is token-gated access?</dt>
      <dd>Holding the required tokens unlocks the Sovereign track automatically when your wallet is connected.</dd>
      <dt>Which chain?</dt>
      <dd>BNB Smart Chain (BSC). You’ll be prompted to switch or add the network if needed.</dd>
      <dt>Do I need crypto to learn?</dt>
      <dd>No. You can preview Core content and locked lesson snippets without tokens.</dd>
    </dl>
  </section>

  <section class="section wrap">
    <h3>What Learners Say</h3>
    <div class="testis">
      <blockquote class="quote">“This program gave me language and structure for power I always felt but couldn’t name.” — <strong>Amara</strong></blockquote>
      <blockquote class="quote">“The daily practices + Web3 proof of progress hit different.” — <strong>Jalen</strong></blockquote>
      <blockquote class="quote">“Sovereignty finally feels embodied, not theoretical.” — <strong>Rae</strong></blockquote>
    </div>
  </section>

  <section class="section wrap">
    <h3>Access Tiers</h3>
    <div class="pricing">
      <div class="price-card">
        <div class="price">Free</div>
        <div class="muted">Preview Core lessons, see Sovereign snippets.</div>
      </div>
      <div class="price-card">
        <div class="price">Sovereign</div>
        <div class="muted">Hold required tokens to unlock all modules + on-chain certificate.</div>
      </div>
    </div>
  </section>

  <footer>© Sovereignty Mastery — Built with love & Web3 ✨</footer>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="modal-title" style="margin:0; display:flex; align-items:center; gap:10px"><span class="badge" id="modal-num">1</span> <span id="modal-name">Module</span></h3>
      <button class="x" id="modal-close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG — TOKEN GATE + NFT
========================= */
const TOKEN_ADDRESS    = '0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026'; // ERC-20
const REQUIRED_TOKENS  = 5;
const CHAIN_ID         = 56;  // BNB Smart Chain
const CHAIN_NAME       = 'BNB Smart Chain';
const RPC_URL          = 'https://bsc-dataseed.binance.org';

const NFT_ADDRESS      = '0xDA76d35742190283E340dbeE2038ecc978a56950'; // ERC-721 (Thirdweb-style)
const TOKEN_URI        = 'ipfs://bafybeifssvwf74gv25c3r76cxfdqraerll7l4kgruqaox6cskrqsu2e2by';

/* Minimal ABIs */
const ERC20_ABI       = ['function balanceOf(address) view returns (uint256)','function decimals() view returns (uint8)','function symbol() view returns (string)'];
const ERC721_MINT_ABI = ['function mintTo(address _to, string _uri) payable'];

/* Utils */
const toHex = (n)=>'0x'+Number(n).toString(16);
function showError(msg){
  console.error(msg);
  const el = document.getElementById('gate-note');
  if(el) el.innerHTML = `<span style="color:#ff9aa8"><i class="fa-solid fa-triangle-exclamation"></i> ${msg}</span>`;
}

/* =========================
   COURSE DATA (Core 7 + Sovereign 14)
   — enriched with deeper knowledge & practical insight
========================= */
const COURSE = {
  areas: [
    {
      id:'core', name:'Core Program', description:'7-module path to awakening & embodiment', modules: [
        { id:'1', order:1, title:'Foundations of Self-Awareness', theme:'Becoming the Observer',
          objectives:[
            'Lost-in-thought vs observing thought','Daily mindfulness practices',
            'Journaling for clarity','3-Layer Belief Audit'
          ],
          preview:`Train meta-awareness (awareness of experience). Build reliable, repeatable habits that make clarity inevitable.`,
          content:`
            <h3>Core Concept</h3>
            <p>Self-awareness is <em>meta-attention</em>—noticing sensations, thoughts, and feelings as events in awareness rather than as the whole truth. This shift (often called “decentering” or “cognitive defusion”) reduces reactivity and increases choice.</p>

            <h3>What to Notice (Three Channels)</h3>
            <ul>
              <li><strong>Interoception</strong> (inside): breath, heartbeat, gut tension.</li>
              <li><strong>Exteroception</strong> (outside): sights, sounds, touch.</li>
              <li><strong>Mental</strong> (labels): images, words, narratives.</li>
            </ul>

            <div class="lesson"><strong>Practice — 5x1 Micro-Check</strong>
              <p>Five times/day: one slow breath while labeling: <em>“Body… Breath… Sound.”</em> If a thought appears, silently note <em>“thinking”</em> and return to the labels.</p>
            </div>

            <h3>3-Layer Belief Audit</h3>
            <ol>
              <li><strong>Story:</strong> The raw thought (e.g., “I’m behind”).</li>
              <li><strong>Assumption:</strong> The rule beneath it (“Worth = output”).</li>
              <li><strong>Upgrade:</strong> A testable, kinder belief (“My value isn’t linear with today’s tasks”).</li>
            </ol>

            <h3>Metrics</h3>
            <ul><li><em>Reactivity half-life:</em> time it takes for a spike of irritation to settle.</li>
                <li><em>Recall rate:</em> how often you noticed being lost in thought (not a failure—evidence of awareness).</li></ul>

            <details><summary>Pitfalls & How to Avoid</summary>
              <ul>
                <li><strong>Self-critiquing the practice:</strong> Replace “I’m bad at this” with “I noticed → success.”</li>
                <li><strong>Over-intellectualizing:</strong> Keep 80% attention in the body.</li>
              </ul>
            </details>

            <h3>Journaling Prompts</h3>
            <ul>
              <li>What thought loop showed up 3+ times?</li>
              <li>What body signal did I ignore?</li>
              <li>Which single cue will I use to remember the 5x1 check tomorrow?</li>
            </ul>
          `
        },

        { id:'2', order:2, title:'Breaking the Illusion of Ego', theme:'You Are Not Your Story',
          objectives:['Ego vs Essence','Roles & labels','Silent Watcher practice','Ego defenses'],
          preview:`Disentangle your identity from roles and narratives. Learn to spot common ego defenses in real-time.`,
          content:`
            <h3>Core Concept</h3>
            <p>“Ego” is a protective model of self built from memories, roles, and rules. Useful—but partial. Essence is the aware presence prior to the story. When you identify as awareness, roles become tools, not prisons.</p>

            <h3>Common Ego Defenses (Spot→Name→Soften)</h3>
            <ul>
              <li><strong>Rationalizing:</strong> over-explaining to avoid discomfort → <em>one-sentence truth</em>.</li>
              <li><strong>Projection:</strong> seeing in others what’s disowned in self → <em>“Where is this in me?”</em></li>
              <li><strong>Deflection:</strong> changing topic when vulnerable → <em>“I feel exposed; can we pause?”</em></li>
            </ul>

            <div class="lesson"><strong>Practice — Identity Inventory</strong>
              <p>List 8 labels (founder, parent, helper…). For each, ask: <em>“Without this, am I still here?”</em> Note the body’s response. Breathe with any constriction for 90 seconds.</p>
            </div>

            <h3>Micro-Skill: The Silent Watcher</h3>
            <ol>
              <li>Feel your feet; soften the jaw.</li>
              <li>Let sounds come and go by themselves.</li>
              <li>Notice thoughts as clouds; ask: “What knows this?” Rest as that.</li>
            </ol>

            <details><summary>Pitfall</summary>
              <p><strong>Spiritual bypass:</strong> using “I’m awareness” to avoid feelings. Antidote: name the feeling and feel it somatically <em>before</em> any insight.</p>
            </details>
          `
        },

        { id:'3', order:3, title:'Entering the Now', theme:'Presence is Power',
          objectives:['Past/Future fixation','Sensory anchoring','Listening as meditation','Finding the silent gap'],
          preview:`Exit mental time travel. Stabilize presence with reliable anchors and measurable signals.`,
          content:`
            <h3>Core Concept</h3>
            <p>Presence is trained by repeatedly returning attention to <em>one</em> anchor (breath, sound, contact). Neuroplasticity favors what you practice most.</p>

            <h3>Anchors (pick 1)</h3>
            <ul>
              <li><strong>Breath:</strong> feel air at nostrils; count “in-1, out-1… in-10, out-10,” then reset.</li>
              <li><strong>Sound:</strong> receive sound as one continuous field (no labeling).</li>
              <li><strong>Touch:</strong> feel both feet; widen to whole body contact.</li>
            </ul>

            <div class="lesson"><strong>Practice — 4-Minute Deep Listening</strong>
              <p>Timer 4 min; just sound. When thoughts arise, silently note <em>“hearing”</em> and return. After: rate presence 1–10; track this number for a week.</p>
            </div>

            <h3>Indicators You’re Present</h3>
            <ul><li>Lower jaw tension; slower exhale.</li><li>Wider, softer attention (not tunnel vision).</li><li>Less urgency to fix/finish.</li></ul>

            <details><summary>Pitfall</summary>
              <p><strong>Chasing bliss:</strong> Presence is accuracy, not a permanent state. Count returns, not minutes “perfect.”</p>
            </details>
          `
        },

        { id:'4', order:4, title:'Surrender & Emotional Alchemy', theme:'Freedom Through Letting Go',
          objectives:['What surrender is','Somatic flow of emotion','3-Step alchemy','Forgiveness as liberation'],
          preview:`Let feelings move through, not run the show. Build body-first regulation skills.`,
          content:`
            <h3>Core Concept</h3>
            <p>Surrender = <em>willing contact</em> with what is, without collapsing or suppressing. Emotions are body waves that peak and pass when fully felt.</p>

            <h3>3-Step Alchemy (90–120s)</h3>
            <ol>
              <li><strong>Locate:</strong> where exactly? size, texture, temperature.</li>
              <li><strong>Allow:</strong> breathe around the edges; lengthen exhale 1–2s.</li>
              <li><strong>Let:</strong> let it shake, heat, cool, yawn; stay out of story.</li>
            </ol>

            <div class="lesson"><strong>Practice — Micro-Surrender Drill</strong>
              <p>Pick a tiny irritation today. Whisper “Yes, this too.” Track before/after intensity (0–10). Journal one sentence of learning.</p>
            </div>

            <h3>Forgiveness = Nervous System Relief</h3>
            <p>Forgiving doesn’t mean approving; it means releasing the stuck energy to reclaim attention.</p>

            <details><summary>Pitfalls</summary>
              <ul>
                <li><strong>Overthinking feelings:</strong> Drop analysis; feel 10% more.</li>
                <li><strong>Flooding:</strong> Too intense? Ground: feel soles; open eyes; name 5 objects.</li>
              </ul>
            </details>
          `
        },

        { id:'5', order:5, title:'The Illusion of Separation', theme:'Remembering Oneness',
          objectives:['Seeing through duality','Relational mirrors','Nature as teacher','Entanglement & connection'],
          preview:`Use relationships and nature as real-time mirrors to reveal hidden assumptions.`,
          content:`
            <h3>Core Concept</h3>
            <p>Separation is a useful interface, not the ultimate truth. In direct experience, awareness is continuous and inclusive.</p>

            <h3>Relational Mirror Method</h3>
            <ol>
              <li>Name the trigger precisely (the behavior, not the person).</li>
              <li>Ask: “What does this reflect about my needs/values/fears?”</li>
              <li>Choose a micro-repair (clarify, request, boundary).</li>
            </ol>

            <div class="lesson"><strong>Practice — Nature Sync (10 min)</strong>
              <p>Match breath to a natural rhythm (tree sway, waves). Write one metaphor nature gave you and one practical action it suggests.</p>
            </div>

            <details><summary>Quick Check</summary>
              <p>Am I relating to my image of them, or the living person in front of me?</p>
            </details>
          `
        },

        { id:'6', order:6, title:'Embodied Enlightenment', theme:'Wisdom in Action',
          objectives:['Transcendence → integration','4 pillars of embodiment','Shadow & wholeness','Chop wood, carry water'],
          preview:`Turn insight into default behavior by designing body, speech, attention, and service systems.`,
          content:`
            <h3>Core Concept</h3>
            <p>Embodiment = repeated, environment-supported actions that align with what you know is true. Design beats willpower.</p>

            <h3>Four Pillars</h3>
            <ul>
              <li><strong>Body:</strong> sleep window, movement minimum, stabilizing food.</li>
              <li><strong>Speech:</strong> fewer, clearer commitments; renegotiate early.</li>
              <li><strong>Attention:</strong> daily anchor (2–10 min beats 0–60).</li>
              <li><strong>Service:</strong> contribute where you have real leverage.</li>
            </ul>

            <div class="lesson"><strong>Practice — Keystone Habit</strong>
              <p>Pick one habit that improves others (e.g., lights out window). Track 14 days with a simple 0/1 log.</p>
            </div>

            <details><summary>Pitfall</summary>
              <p><strong>All-or-nothing:</strong> Missed once? Resume next rep. Never “start over,” just continue.</p>
            </details>
          `
        },

        { id:'7', order:7, title:'Living as Awareness', theme:'The Unfolding Mystery',
          objectives:['Form & formlessness','Flow & spontaneity','Gift of impermanence','Beyond seeking'],
          preview:`Trade control for accuracy. Let truth, not ego, set the cadence.`,
          content:`
            <h3>Core Concept</h3>
            <p>As identification softens, action becomes more precise and less effortful. You optimize for aliveness over image.</p>

            <h3>Practices</h3>
            <ul>
              <li><strong>True No → True Yes:</strong> decline one misaligned request this week; note the space it creates.</li>
              <li><strong>Impermanence Gratitude:</strong> Name three things you cherish <em>because</em> they pass.</li>
            </ul>

            <div class="lesson"><strong>Integration — Weekly Review (20 min)</strong>
              <ol>
                <li>Where did I act from fear vs. clarity?</li>
                <li>What will I amplify/retire next week?</li>
                <li>One conversation to have; one thing to forgive.</li>
              </ol>
            </div>
          `
        }
      ]
    },

    {
      id:'sovereign', name:'The Sovereign Self', description:'14-module journey into inner authority & stewardship', modules: [
        { id:'sv1',order:1, title:'Foundation of Sovereignty', theme:'Understanding Personal Power',
          objectives:['Roots of sovereignty','Where you surrendered authority','Ego vs soul power','Daily practice','Declaration'],
          preview:`Sovereignty = the capacity to choose accurately under pressure. Build it like strength: reps + rest.`,
          content:`
            <h3>Core Concept</h3>
            <p>Personal sovereignty is self-governance across four domains: <strong>attention</strong>, <strong>time</strong>, <strong>body</strong>, <strong>word</strong>. It grows through clear rules + compassionate enforcement.</p>

            <h3>Four Levers</h3>
            <ul>
              <li><strong>Attention:</strong> limit distractions; single-task sprints.</li>
              <li><strong>Time:</strong> time-boxed blocks; visible calendar boundaries.</li>
              <li><strong>Body:</strong> energy rhythms; movement micro-breaks.</li>
              <li><strong>Word:</strong> commitments you can keep; fast renegotiation.</li>
            </ul>

            <div class="lesson"><strong>Action — 48-Hour Reclaim</strong>
              <p>Pick one lever (e.g., first 30 minutes device-free). Declare it to a buddy. Keep notes on resistance and benefits.</p>
            </div>

            <h3>Declaration</h3>
            <p>“I steward my time, attention, body, and word. I choose responses that honor truth and dignity.”</p>
          `
        },

        { id:'sv2',order:2, title:'Boundaries & Energy Protection', theme:'Creating Safe Containers',
          objectives:['Map patterns','Guilt-free limits','Protection techniques','Respond to violations','Context rules'],
          preview:`Boundaries are <em>your</em> commitments to act a certain way. They’re about behavior, not blame.`,
          content:`
            <h3>Core Concept</h3>
            <p>A boundary is a personal policy coupled with an action plan. Example: “I don’t take calls after 7pm; I’ll schedule for tomorrow.”</p>

            <h3>Boundary Ladder (3 levels)</h3>
            <ul>
              <li><strong>Gentle Ask:</strong> “Can we keep this to 20 minutes?”</li>
              <li><strong>Firm No:</strong> “I’m not available for this tonight.”</li>
              <li><strong>Consequence:</strong> “If it continues, I’ll leave and follow up tomorrow.”</li>
            </ul>

            <div class="lesson"><strong>Practice — One Policy Per Context</strong>
              <p>Define one boundary for time, one for space, one for energy. Write & rehearse each out loud.</p>
            </div>

            <details><summary>Pitfall</summary>
              <p>Weaponizing boundaries (controlling others). Remedy: keep language “I-based” and behavior-focused.</p>
            </details>
          `
        },

        { id:'sv3',order:3, title:'Authentic Decision Making', theme:'Listening to Inner Wisdom',
          objectives:['Spot fear patterns','Guidance rituals','Decondition reactivity','Values filters','Act on intuition'],
          preview:`Blend data + values + body signals. Favor small reversible steps to learn fast.`,
          content:`
            <h3>Core Concept</h3>
            <p>Good decisions respect <strong>probability</strong> (data), <strong>principles</strong> (values), and <strong>physiology</strong> (body signals). Intuition improves with reps & feedback.</p>

            <h3>Values Filter (3 questions)</h3>
            <ul>
              <li>Does this honor my top 3 values?</li>
              <li>Does my body feel open/steady?</li>
              <li>Would Future-Me thank me for this step?</li>
            </ul>

            <div class="lesson"><strong>Practice — Two Chairs</strong>
              <p>2 min in “Head” chair (reasons), 2 min in “Body” chair (sensations). Decide the smallest reversible step. Review outcome in 72 hours.</p>
            </div>
          `
        },

        { id:'sv4',order:4, title:'Sovereign Communication', theme:'Expressing Truth with Power',
          objectives:['Express needs','Active listening','Center conflict','Release blame','Language upgrades'],
          preview:`Own your experience, make clean requests, and separate facts from story.`,
          content:`
            <h3>Core Concept</h3>
            <p>Clarity = observation + impact + need + request. Power comes from specificity and non-accusatory tone.</p>

            <h3>Map (O-I-N-R)</h3>
            <ol>
              <li><strong>Observation:</strong> “When the meeting ran 20m over…”</li>
              <li><strong>Impact:</strong> “…I felt stressed and missed my next call.”</li>
              <li><strong>Need:</strong> “I need predictability.”</li>
              <li><strong>Request:</strong> “Can we end on time or re-scope?”</li>
            </ol>

            <div class="lesson"><strong>Practice — 3 Clean Requests</strong>
              <p>Send three requests this week with a deadline and “ok to say no.” Track responses & your emotional aftertaste.</p>
            </div>
          `
        },

        { id:'sv5',order:5, title:'Financial Sovereignty', theme:'Wealth as Energy Exchange',
          objectives:['Audit beliefs','Align income','Spend by values','Flow mindset','Systems'],
          preview:`Design simple rules + systems so money serves life, not the other way around.`,
          content:`
            <h3>Core Concept</h3>
            <p>Money management = rules + automation + review. Reduce decisions; increase consistency.</p>

            <h3>Simple System</h3>
            <ul>
              <li><strong>3 Buckets:</strong> Essentials • Growth • Play.</li>
              <li><strong>Autopilot:</strong> sweep to savings/investing first; spend last.</li>
              <li><strong>Weekly Review:</strong> 30 minutes to reconcile & adjust.</li>
            </ul>

            <div class="lesson"><strong>Practice — Belief & Behavior Swap</strong>
              <p>List 3 limiting beliefs (e.g., “I’m bad with money”). Replace each with a rule you can execute (e.g., “I move 10% of every inflow within 24h”).</p>
            </div>

            <details><summary>Pitfall</summary>
              <p>All-at-once overhauls. Instead: change one lever for 30 days, then add the next.</p>
            </details>
          `
        },

        { id:'sv6',order:6, title:'Sovereign Relationships', theme:'Connecting Without Losing Self',
          objectives:['Spot patterns','Self-connection','Mutual respect','Closeness/space','Ask clearly'],
          preview:`Balance closeness and autonomy. Repair beats perfection.`,
          content:`
            <h3>Core Concept</h3>
            <p>Healthy bonds contain <em>two</em> regulated selves and <em>one</em> shared space. You can pursue closeness <em>and</em> keep boundaries.</p>

            <h3>Common Patterns</h3>
            <ul>
              <li><strong>Pursuer:</strong> closes distance with talk; antidote = self-soothing + timed check-ins.</li>
              <li><strong>Withdrawer:</strong> creates space to regulate; antidote = name the need + promise a return time.</li>
            </ul>

            <div class="lesson"><strong>Practice — Repair Script</strong>
              <p>“I care about us. I felt X when Y. I see my part Z. Next time I’ll do A. Are you willing to try B together?”</p>
            </div>
          `
        },

        { id:'sv7',order:7, title:'Living as Sovereign Being', theme:'Integration & Mastery',
          objectives:['Daily ritualization','Resilience','Environment design','Aligned default','Intentional creation'],
          preview:`Default wins: shape space, time, and cues so sovereignty is the easiest option.`,
          content:`
            <h3>Core Concept</h3>
            <p>Rituals + environment beat motivation. Design frictions (make the default the desired behavior).</p>

            <h3>Environment Design</h3>
            <ul>
              <li>Phone: grayscale, no social icons on home screen.</li>
              <li>Space: a visible “start ritual” corner (timer, notebook, water).</li>
              <li>Time: first 30 minutes device-free, last 30 minutes wind-down.</li>
            </ul>

            <div class="lesson"><strong>Practice — 14-Day Keystone</strong>
              <p>Pick one keystone (sleep window, journaling, walk). Track 0/1 daily; review what made it inevitable.</p>
            </div>
          `
        },

        { id:'sv8',order:8, title:'Lawful Foundations', theme:'Rights, Duties, Jurisdiction',
          objectives:['Rights vs privileges','Jurisdictions','Identity docs','Lawful comms','Records'],
          preview:`Orient before acting: venue, rules, roles, and records. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal advice)</h3>
            <p>Effective action starts with orientation: <strong>What venue am I in?</strong> (public/private, civil/criminal, admin), <strong>what rules apply?</strong>, <strong>what evidence/identity is recognized?</strong></p>

            <h3>Clarity Checklist</h3>
            <ul>
              <li>Venue & governing rules/procedures.</li>
              <li>Your role/capacity as it appears in records.</li>
              <li>What document proves each claim?</li>
            </ul>

            <div class="lesson"><strong>Practice — Order Your Docs</strong>
              <p>Create a folder with: ID, key agreements, receipts, dated logs. Keep a one-page index and note where originals live.</p>
            </div>
          `
        },

        { id:'sv9',order:9, title:'Status Correction Essentials', theme:'Identity, Notice, Standing',
          objectives:['Map status','Declarations','Timelines','Consistency','Avoid contradictions'],
          preview:`Clarity + consistency in records and conduct. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal advice)</h3>
            <p>“Status” relates to how you appear within a process. Declarations should be specific, consistent across documents, and matched by conduct.</p>

            <h3>Consistency Rules</h3>
            <ul>
              <li>Use one name format across documents.</li>
              <li>Date/sign; track when/where items were served or filed.</li>
              <li>Avoid making claims you won’t act on.</li>
            </ul>

            <div class="lesson"><strong>Practice — Timeline Sheet</strong>
              <p>One page listing: date, document, method of service/filing, response windows, next action.</p>
            </div>
          `
        },

        { id:'sv10',order:10, title:'Affidavits & Notices', theme:'Truth in the Record',
          objectives:['Structure','Facts not fluff','Service','Track responses','Close loop'],
          preview:`Facts, not feelings. Clear structure, clear timelines. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal advice)</h3>
            <p><strong>Affidavit:</strong> a sworn statement of fact. <strong>Notice:</strong> a dated communication that informs, sets expectations, and may start a timeline.</p>

            <h3>Structure</h3>
            <ol>
              <li>Header & parties.</li>
              <li>Numbered factual statements (observable, verifiable).</li>
              <li>Signature + date + witness/notary if required.</li>
            </ol>

            <div class="lesson"><strong>Practice — 5-Line Notice Draft</strong>
              <p>Who it’s to, what occurred (facts), what you seek, by when, and how to respond. Keep tone neutral; avoid threats.</p>
            </div>
          `
        },

        { id:'sv11',order:11, title:'Trusts & PMA', theme:'Private Structures',
          objectives:['Purpose','Roles & duties','Bylaws','Separate capacities','Minutes & records'],
          preview:`Clarity of purpose and records improves integrity. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal/financial advice)</h3>
            <p>Trusts/PMAs organize stewardship and membership. Effective operation requires defined purpose, roles/duties, decision rules, and record-keeping.</p>

            <h3>Clarity Points</h3>
            <ul>
              <li>Purpose & scope (what it is / isn’t for).</li>
              <li>Roles, duties, and limits of authority.</li>
              <li>Decision rules (quorum, voting, tie-breaks).</li>
              <li>Minutes, resolutions, and document storage.</li>
            </ul>

            <div class="lesson"><strong>Practice — One-Page Charter</strong>
              <p>Draft purpose, roles, decision method, membership rules, and record cadence. Keep it simple and test in practice.</p>
            </div>
          `
        },

        { id:'sv12',order:12, title:'Right to Travel (Education)', theme:'Safety, Notice, Documentation',
          objectives:['ID packet','Calm scripts','Escalation','Recording','Debrief'],
          preview:`Preparation turns pressure into poise. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal advice)</h3>
            <p>Preparation and calm communication reduce risk in stressful interactions. Keep documents organized; know your de-escalation steps.</p>

            <h3>Poise Toolkit</h3>
            <ul>
              <li>Organized documents (as applicable).</li>
              <li>Short, respectful scripts; slow breathing.</li>
              <li>Record interactions where lawful; debrief after.</li>
            </ul>

            <div class="lesson"><strong>Practice — 60-Second Drill</strong>
              <p>In a mirror: your calm intro + simple request for clarity. Focus on tone, posture, and breath cadence.</p>
            </div>
          `
        },

        { id:'sv13',order:13, title:'Commercial Remedies (Education)', theme:'Invoices, Liens, Cures',
          objectives:['Remedy ladder','Notices before claims','Track timelines','Avoid frivolous','Seek counsel'],
          preview:`Escalate appropriately; document everything. <em>(Educational only)</em>`,
          content:`
            <h3>Educational Overview (not legal/financial advice)</h3>
            <p>Typical escalation: information → notice → opportunity to cure → claim, according to venue rules. Precision and documentation matter more than volume.</p>

            <h3>Principles</h3>
            <ul>
              <li>Match remedy to facts and venue.</li>
              <li>Keep tone factual; avoid threats or opinions.</li>
              <li>Log dates, delivery method, and deadlines.</li>
            </ul>

            <div class="lesson"><strong>Practice — Remedy Ladder Map</strong>
              <p>Draw a hypothetical ladder for a dispute: facts → notice → response window → next step.</p>
            </div>
          `
        },

        { id:'sv14',order:14, title:'Record & Publish', theme:'Make it Real in the World',
          objectives:['Choose venues','Organize repos','Consistent formats','Versioning','Cold backups'],
          preview:`If it isn’t recorded, it’s hard to prove. If it isn’t organized, it’s hard to use.`,
          content:`
            <h3>Core Concept</h3>
            <p>Reliability = organized records + consistent naming + backups. Aim for “one glance finds it.”</p>

            <h3>System</h3>
            <ul>
              <li>Folder tree: <em>Identity • Agreements • Notices • Evidence • Logs</em>.</li>
              <li>File names: <code class="code">YYYY-MM-DD_context_v1.pdf</code></li>
              <li>Versioning: bump suffixes; keep a change log.</li>
              <li>Backups: offline + cloud; test restore quarterly.</li>
            </ul>

            <div class="lesson"><strong>Practice — 30-Minute Archive Sprint</strong>
              <p>Create the tree; rename 10 files to the standard; export a 1-page index with locations and checksums (optional).</p>
            </div>
          `
        }
      ]
    }
  ]
};

/* =========================
   STATE, ELEMENTS, STORAGE
========================= */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const STORAGE = { PROGRESS:'sv_progress_v4', OPEN:'sv_open_v1', XP:'sv_xp_v1', STREAK:'sv_streak_v1' };

let accessGranted=false, tokenSymbolCached='TOKEN';
let state={ tab:'overview', filter:'all', search:'', openId:null };
let web3Modal, extProvider, provider, signer, token, account=null;

const E = {
  // header + hero
  btnConnect: $('#btn-connect'), heroConnect: $('#hero-connect'),
  addrChip: $('#addr-chip'), addrShort: $('#addr-short'),
  chipText: $('#chip-text'), xpChip: $('#xp-chip'), xpText: $('#xp-text'),
  heroMsg: $('#hero-msg'), heroRing: $('#hero-ring'), reqTokens: $('#req-tokens'),
  // sidebar
  avatar: $('#avatar'), addrFull: $('#addr-full'),
  btnDisconnect: $('#btn-disconnect'), btnReconnect: $('#btn-reconnect'),
  menu: $('#menu'),
  // center
  filters: $('#filters'), search: $('#search'),
  viewOverview: $('#view-overview'), viewSyllabus: $('#view-syllabus'), viewProgress: $('#view-progress'), viewResources: $('#view-resources'),
  gridOverview: $('#grid-overview'), gridSyllabus: $('#grid-syllabus'), gridProgress: $('#grid-progress'),
  detail: $('#detail'), detailNum: $('#detail-num'), detailTitle: $('#detail-title'),
  detailArea: $('#detail-area'), detailStatus: $('#detail-status'), detailTheme: $('#detail-theme'), detailBody: $('#detail-body'),
  btnPrev: $('#btn-prev'), btnNext: $('#btn-next'), btnFull: $('#btn-full'), btnMark: $('#btn-mark'),
  // right
  ring: $('#ring'), tokenBalance: $('#token-balance'), tokenSymbol: $('#tokenSymbol'),
  btnGateConnect: $('#btn-gate-connect'), certStatus: $('#cert-status'), certProgress: $('#cert-progress'),
  btnMint: $('#btn-mint'), mintStatus: $('#mint-status'),
  // progress KPIs
  pillTotal: $('#pill-total'), barTotal: $('#bar-total'), doneTotal: $('#done-total'), countTotal: $('#count-total'),
  pillCore: $('#pill-core'), barCore: $('#bar-core'), doneCore: $('#done-core'), countCore: $('#count-core'),
  pillSov: $('#pill-sov'), barSov: $('#bar-sov'), doneSov: $('#done-sov'), countSov: $('#count-sov'),
  // gamification
  pillXP: $('#pill-xp'), streakText: $('#streak-text'), pillRank: $('#pill-rank'), rankDesc: $('#rank-desc'),
  // modal
  modal: $('#modal'), modalClose: $('#modal-close'),
  modalNum: $('#modal-num'), modalName: $('#modal-name'), modalBody: $('#modal-body'),
  // nft preview
  nftPreview: $('#nft-preview'), nftName: $('#nft-name'), nftAttrs: $('#nft-attrs'), nftEdition: $('#nft-edition'), shareWrap: $('#share-wrap'), shareX: $('#share-x'),
};
if(E.reqTokens) E.reqTokens.textContent = REQUIRED_TOKENS;

/* =========================
   HELPERS: Progress / XP / Streak
========================= */
function allModules(){ return COURSE.areas.flatMap(a => a.modules.map(m => ({...m, areaId:a.id, areaName:a.name}))); }
function progressLoad(){ try{return JSON.parse(localStorage.getItem(STORAGE.PROGRESS))||{}}catch{return{}} }
function progressSave(p){ localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(p)); }
function keyOf(m){ return `${m.areaId}:${m.id}` }
function progressOf(m){ const p=progressLoad(); return p[keyOf(m)]||{status:'not-started', percent:0} }
function setProgress(m, status){
  const p = progressLoad(); const k = keyOf(m);
  const prev = p[k] || {percent:0};
  p[k] = { status, percent: status==='completed' ? 100 : status==='in-progress' ? Math.max(prev.percent,25) : 0 };
  progressSave(p);
  if(status==='completed' && prev.percent<100){ addXP(50); tickStreak(); }
  renderAll();
}
function percentCompleted(areaId){
  const mods = allModules().filter(m => !areaId || m.areaId===areaId);
  const done = mods.filter(m => progressOf(m).status==='completed').length;
  return {done, total:mods.length, pct:mods.length ? Math.round(done/mods.length*100) : 0};
}
function gateLocked(areaId){ return areaId==='sovereign' && !accessGranted; }
function notifyOK(msg){ if(typeof confetti==='function'){ confetti({particleCount:90, spread:64, origin:{y:.85}, colors:["#7ae9ff","#8d7bff","#69ffb4"]}); } console.log(msg); }
function loadXP(){ return Number(localStorage.getItem(STORAGE.XP)||0); }
function saveXP(v){ localStorage.setItem(STORAGE.XP, String(v)); }
function addXP(n){ const v=loadXP()+n; saveXP(v); }
function loadStreak(){ try{return JSON.parse(localStorage.getItem(STORAGE.STREAK))||{count:0,last:''}}catch{return{count:0,last:''}} }
function saveStreak(s){ localStorage.setItem(STORAGE.STREAK, JSON.stringify(s)); }
function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
function tickStreak(){
  const s=loadStreak(); const t=todayStr();
  if(s.last===t) return;
  const last = s.last ? new Date(s.last) : null;
  const diff = last ? Math.round((new Date(t)-last)/86400000) : null;
  s.count = diff===1 ? s.count+1 : 1;
  s.last=t; saveStreak(s);
}

/* =========================
   RENDER — SIDEBAR, CARDS, LISTS, PROGRESS
========================= */
function renderSidebar(){
  E.menu.innerHTML='';
  COURSE.areas.forEach(area=>{
    const head = document.createElement('button');
    head.className='sbtn'; head.innerHTML=`<i class="fa-solid fa-layer-group"></i> ${area.name} <span class="tag">${area.modules.length}</span>`;
    head.onclick = ()=>{ switchTab('syllabus'); setFilter(area.id); };
    E.menu.appendChild(head);
    area.modules.forEach(m=>{
      const st = progressOf({areaId:area.id, id:m.id}).status;
      const badge = st==='completed' ? '<i class="fa-solid fa-check"></i>' : st==='in-progress' ? '•' : '–';
      const btn = document.createElement('button');
      btn.className='sbtn'; if(gateLocked(area.id)) btn.classList.add('lock');
      btn.innerHTML = `<span class="badge" title="${st}">${badge}</span> <strong>${area.id==='core'?m.order:m.id.replace('sv','')}</strong> ${m.title} <span class="tag">${area.id==='core'?'Core':'Sovereign'}</span>`;
      btn.onclick = ()=> gateLocked(area.id) ? E.btnGateConnect.click() : openModule(area.id, m.id);
      E.menu.appendChild(btn);
    });
  });
}
function matchFilters(m){
  const st = progressOf(m).status;
  const f = state.filter;
  const byStatus = f==='all' ? true :
    f==='not-started'? st==='not-started' :
    f==='in-progress'? st==='in-progress' :
    f==='completed'? st==='completed' :
    f===m.areaId;
  const s = state.search.trim().toLowerCase();
  const bySearch = !s || [m.title, m.theme, ...(m.objectives||[]), m.preview||''].join(' ').toLowerCase().includes(s);
  return byStatus && bySearch;
}
function cardFor(m){
  const p = progressOf(m);
  const el = document.createElement('div');
  el.className = 'card' + (gateLocked(m.areaId)?' lock':'');
  el.setAttribute('role','listitem');
  el.innerHTML = `
    <div class="row">
      <div style="display:flex; gap:10px; align-items:center">
        <div class="badge">${m.areaId==='core'?m.order:m.id.replace('sv','')}</div>
        <div><strong>${m.title}</strong><div class="muted">${m.theme}</div></div>
      </div>
      <span class="pill">${m.areaId==='core'?'Core':'Sovereign'}</span>
    </div>
    <div class="muted preview-snippet">${m.preview||'—'}</div>
    <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
    <div class="row">
      <span class="muted">${p.status==='completed'?'Completed':p.status==='in-progress'?'In Progress':'Not Started'}</span>
      <div style="display:flex; gap:8px">
        <button class="chip" data-act="in">Mark In-Progress</button>
        <button class="btn" data-act="open"><i class="fa-regular fa-book-open"></i> ${gateLocked(m.areaId)?'Unlock':'Open'}</button>
      </div>
    </div>
  `;
  el.querySelector('[data-act="in"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : setProgress(m,'in-progress');
  el.querySelector('[data-act="open"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : openModule(m.areaId, m.id);

  if(gateLocked(m.areaId)){
    const overlay = document.createElement('div'); overlay.className='lock-overlay';
    overlay.innerHTML = `
      <div class="lock-box">
        <i class="fa-solid fa-lock"></i>
        <div><strong>Locked</strong></div>
        <div class="muted" style="max-width:360px">You hold <span id="overlay-hold">0</span> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock Sovereign track.</div>
        <button class="btn btn-ghost" data-act="connect"><i class="fa-solid fa-plug-circle-bolt"></i> Connect</button>
      </div>`;
    overlay.querySelector('[data-act="connect"]').onclick = ()=> E.btnGateConnect.click();
    el.appendChild(overlay);
  }
  return el;
}
function renderOverview(){
  E.gridOverview.innerHTML = '';
  allModules().filter(matchFilters).sort((a,b)=> (a.areaId===b.areaId ? (a.order||0)-(b.order||0) : a.areaId.localeCompare(b.areaId))).forEach(m=>{
    E.gridOverview.appendChild(cardFor(m));
  });
}
function renderSyllabus(){
  E.gridSyllabus.innerHTML = '';
  COURSE.areas.forEach(area=>{
    const head = document.createElement('div');
    head.className='card';
    head.innerHTML = `<div class="row"><div style="display:flex; gap:10px; align-items:center"><i class="fa-solid fa-layer-group"></i><strong>${area.name}</strong></div><span class="muted">${area.description}</span></div>`;
    E.gridSyllabus.appendChild(head);
    area.modules.filter(m=>matchFilters({...m, areaId:area.id})).forEach(m=>{
      E.gridSyllabus.appendChild(cardFor({...m, areaId:area.id, areaName:area.name}));
    });
  });
}
function renderProgress(){
  const all = percentCompleted(); const core = percentCompleted('core'); const sov = percentCompleted('sovereign');
  E.doneTotal.textContent = all.done; E.countTotal.textContent = all.total; E.pillTotal.textContent = all.pct+'%'; E.barTotal.style.width = all.pct+'%';
  E.doneCore.textContent = core.done; E.countCore.textContent = core.total; E.pillCore.textContent = core.pct+'%'; E.barCore.style.width = core.pct+'%';
  E.doneSov.textContent = sov.done; E.countSov.textContent = sov.total; E.pillSov.textContent = sov.pct+'%'; E.barSov.style.width = sov.pct+'%';

  const xp = loadXP(); if(E.pillXP) E.pillXP.textContent = xp+' XP'; if(E.xpText) E.xpText.textContent = xp+' XP';
  const sr = loadStreak(); if(E.streakText) E.streakText.textContent = 'Streak: '+sr.count;

  const maxXP = (all.total)*50;
  const percentile = maxXP ? Math.round((xp/maxXP)*100) : 0;
  const rankTxt = percentile>=90?'Top 10%':percentile>=70?'Top 30%':percentile>=50?'Top 50%':'Rising';
  if(E.pillRank) E.pillRank.textContent = rankTxt;
  if(E.rankDesc) E.rankDesc.textContent = `You’ve earned ${xp} / ${maxXP} XP (${percentile}%).`;

  E.gridProgress.innerHTML='';
  allModules().forEach(m=> E.gridProgress.appendChild(cardFor(m)));
}

/* =========================
   DETAIL & MODAL
========================= */
function openModule(areaId, id){
  state.tab = 'syllabus';
  const list = allModules();
  const idx = list.findIndex(x=>x.areaId===areaId && x.id===id);
  const m = list[idx]; if(!m) return;

  if(progressOf(m).status==='not-started') setProgress(m,'in-progress');

  $('#view-syllabus').classList.add('hide');
  E.detail.classList.add('show'); state.openId = keyOf(m); localStorage.setItem(STORAGE.OPEN, state.openId);

  E.detailNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.detailTitle.textContent = m.title;
  E.detailArea.textContent = m.areaName;
  E.detailTheme.textContent = m.theme;
  const st = progressOf(m).status; E.detailStatus.textContent = st==='completed'?'Completed':st==='in-progress'?'In Progress':'Not Started';
  E.detailBody.innerHTML = `<h3>Objectives</h3><ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>${m.content||''}`;

  E.btnPrev.onclick = ()=>{
    const prev = list[idx-1] || list[list.length-1];
    return gateLocked(prev.areaId) ? E.btnGateConnect.click() : openModule(prev.areaId, prev.id);
  };
  E.btnNext.onclick = ()=>{
    const next = list[idx+1] || list[0];
    return gateLocked(next.areaId) ? E.btnGateConnect.click() : openModule(next.areaId, next.id);
  };
  E.btnFull.onclick = ()=> openModal(m);
  E.btnMark.onclick = ()=>{
    const cur = progressOf(m).status;
    setProgress(m, cur==='completed' ? 'in-progress' : 'completed');
    openModule(areaId, id);
  };
  renderTabs();
}
function openModal(m){
  E.modal.classList.add('show');
  E.modalNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.modalName.textContent = m.title;
  E.modalBody.innerHTML = `
    <div class="muted" style="margin-bottom:8px">${m.areaName} • ${m.theme}</div>
    <h3>Objectives</h3>
    <ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>
    ${m.content||''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
      <button class="chip" id="modal-mark-in"><i class="fa-regular fa-bookmark"></i> Save Progress</button>
      <button class="btn" id="modal-mark-done"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
    </div>`;
  $('#modal-mark-in').onclick = ()=> setProgress(m,'in-progress');
  $('#modal-mark-done').onclick = ()=>{
    setProgress(m,'completed');
    const all = percentCompleted(); if(all.done===all.total){ notifyOK('All modules complete!'); }
  };
}
if(E.modalClose) E.modalClose.onclick = ()=> E.modal.classList.remove('show');
if(E.modal) E.modal.addEventListener('click', e=>{ if(e.target===E.modal) E.modal.classList.remove('show'); });

/* =========================
   TABS, FILTERS, SEARCH
========================= */
function renderTabs(){
  E.viewOverview.classList.toggle('hide', state.tab!=='overview');
  E.viewSyllabus.classList.toggle('hide', state.tab!=='syllabus' || !!state.openId);
  E.viewProgress.classList.toggle('hide', state.tab!=='progress');
  E.viewResources.classList.toggle('hide', state.tab!=='resources');
  if(state.tab!=='syllabus'){ E.detail.classList.remove('show'); state.openId=null; localStorage.removeItem(STORAGE.OPEN); }
}
function switchTab(tab){ state.tab = tab; renderTabs(); }
function setFilter(f){
  state.filter = f;
  $$('#filters .chip').forEach(c=> c.classList.toggle('active', c.dataset.filter===f));
  renderCenter();
}
function renderCenter(){ renderOverview(); renderSyllabus(); renderProgress(); }

/* =========================
   HEADER/RIGHT/ HERO UI
========================= */
function updateHeaderAndRight(){
  const all = percentCompleted();
  E.chipText.textContent = `${all.done}/${all.total} Complete`;
  E.certProgress.textContent = `${all.done} / ${all.total}`;
  const pct = Math.min(100, all.pct);
  E.ring.style.setProperty('--p', pct+'%'); E.ring.setAttribute('data-label', pct+'%');
  if(E.heroRing){ E.heroRing.style.setProperty('--p', pct+'%'); E.heroRing.setAttribute('data-label', pct+'%'); }
  const canMint = all.done===all.total;
  E.certStatus.textContent = canMint ? 'Ready to Mint' : 'Locked';
  E.btnMint.disabled = !canMint;
}

/* =========================
   WEB3: CONNECT / GATE / MINT
========================= */
function setupWeb3(){
  if(!window.Web3Modal){ showError('Web3Modal script not found.'); return; }
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider?.default || window.WalletConnectProvider,
      options: { rpc: { [CHAIN_ID]: RPC_URL }, chainId: CHAIN_ID }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:'dark' });
}

async function connect(){
  try{
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if(!isSecure){ showError('Wallets require HTTPS or localhost.'); return; }

    extProvider = await web3Modal.connect();
    if(!extProvider){ showError('No wallet provider returned.'); return; }

    provider = new ethers.providers.Web3Provider(extProvider, 'any');
    signer = provider.getSigner(); account = await signer.getAddress().catch(()=>null);

    extProvider.removeAllListeners?.();
    extProvider.on?.('accountsChanged', accs=>{ if(!accs?.length) return disconnect(); account=accs[0]; checkGate(); });
    extProvider.on?.('chainChanged', ()=>{ provider = new ethers.providers.Web3Provider(extProvider,'any'); signer = provider.getSigner(); token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider); checkGate(); });
    extProvider.on?.('disconnect', ()=> disconnect());

    const net = await provider.getNetwork();
    if(Number(net.chainId) !== Number(CHAIN_ID)){
      try{
        await extProvider.request({ method:'wallet_switchEthereumChain', params:[{ chainId: toHex(CHAIN_ID) }] });
      }catch(switchErr){
        try{
          await extProvider.request({ method:'wallet_addEthereumChain', params:[{
            chainId: toHex(CHAIN_ID), chainName: CHAIN_NAME,
            nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18},
            rpcUrls:[RPC_URL], blockExplorerUrls:['https://bscscan.com']
          }] });
        }catch(addErr){ showError(`Please switch to ${CHAIN_NAME} in your wallet.`); throw addErr; }
      }
    }

    token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

    E.btnConnect?.classList.add('hide'); E.addrChip?.classList.remove('hide');
    const short = account ? `${account.slice(0,6)}…${account.slice(-4)}` : '0x…';
    if(E.addrShort) E.addrShort.textContent = short;
    if(E.addrFull)  E.addrFull.textContent  = account || '—';
    if(E.avatar && account) E.avatar.textContent = account.slice(2,4).toUpperCase();
    E.btnDisconnect?.classList.remove('hide'); E.btnReconnect?.classList.add('hide');

    await checkGate();
  }catch(err){
    console.error('connect() failed:', err);
    showError('Could not connect. If using WalletConnect, try MetaMask/injected or refresh over HTTPS.');
    E.btnReconnect?.classList.remove('hide');
  }
}

async function disconnect(){
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  try{ if(extProvider?.disconnect && typeof extProvider.disconnect==='function'){ await extProvider.disconnect(); } }catch{}
  provider=signer=token=extProvider=null; account=null; accessGranted=false;
  E.btnConnect?.classList.remove('hide'); E.addrChip?.classList.add('hide'); E.btnDisconnect?.classList.add('hide'); E.btnReconnect?.classList.add('hide');
  if(E.addrFull) E.addrFull.textContent='Not connected'; if(E.avatar) E.avatar.textContent='SM'; if(E.tokenBalance) E.tokenBalance.textContent='—';
  if(E.heroMsg) E.heroMsg.textContent = 'Connect wallet to explore Sovereignty Mastery.';
  renderAll();
}

async function checkGate(){
  try{
    if(!provider || !account){
      const node = $('#gate-note'); if(node) node.textContent='Connect wallet to explore Sovereignty Mastery.';
      if(E.heroMsg) E.heroMsg.textContent='Connect wallet to explore Sovereignty Mastery.';
      return;
    }
    const read = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);
    const [raw, dec, sym] = await Promise.all([
      read.balanceOf(account),
      read.decimals().catch(()=>18),
      read.symbol().catch(()=> 'TOKEN')
    ]);
    tokenSymbolCached = sym || 'TOKEN';
    if(E.tokenSymbol) E.tokenSymbol.textContent = tokenSymbolCached;
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    if(E.tokenBalance) E.tokenBalance.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:4})} ${tokenSymbolCached}`;

    const gateNote = $('#gate-note');
    if(bal < REQUIRED_TOKENS){
      if(E.heroMsg) E.heroMsg.innerHTML = `You hold <strong>${bal}</strong> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock Sovereign track.`;
      if(gateNote) gateNote.innerHTML = `You hold <strong>${bal}</strong> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock the Sovereign track.`;
    }else{
      if(E.heroMsg) E.heroMsg.innerHTML = `<strong>Access Granted.</strong> Sovereign modules unlocked.`;
      if(gateNote) gateNote.innerHTML = `Access granted. You can open all Sovereign modules.`;
    }

    accessGranted = bal >= REQUIRED_TOKENS;
    renderAll();
  }catch(e){ console.error('Gate read error', e); showError('Failed to read token balance. Check RPC/contract.'); }
}

/* Bind connect controls */
if(E.btnGateConnect) E.btnGateConnect.addEventListener('click', connect);
E.btnConnect?.addEventListener('click', connect);
E.heroConnect?.addEventListener('click', connect);
E.btnDisconnect?.addEventListener('click', disconnect);
E.btnReconnect?.addEventListener('click', connect);

/* =========================
   CERT MINT — ERC-721 mintTo
========================= */
E.btnMint?.addEventListener('click', async ()=>{
  const all = percentCompleted();
  if(all.done!==all.total) return;
  if(!signer){ await connect(); if(!signer) return; }
  try{
    E.btnMint.disabled = true; if(E.mintStatus) E.mintStatus.textContent = 'Minting…';
    const nft = new ethers.Contract(NFT_ADDRESS, ERC721_MINT_ABI, signer);
    const tx = await nft.mintTo(account, TOKEN_URI);
    const receipt = await tx.wait();
    notifyOK('Certificate minted!');
    if(E.nftPreview){ E.nftPreview.style.display='block'; }
    if(E.nftName)    E.nftName.textContent = 'Sovereignty Mastery — Key of Ascension';
    if(E.nftEdition) E.nftEdition.textContent = 'Edition: On-chain';
    if(E.nftAttrs)   E.nftAttrs.textContent = 'Attributes: Completion, Sovereign Track, Proof of Mastery';
    if(E.shareWrap && E.shareX){
      const shareText = encodeURIComponent('I just minted my Sovereignty Mastery certificate on BNB. On-chain proof of progress. #Web3 #Sovereignty');
      const shareUrl  = encodeURIComponent('https://bscscan.com/tx/'+receipt.transactionHash);
      E.shareWrap.style.display='block'; E.shareX.href = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;
    }
    if(E.mintStatus) E.mintStatus.innerHTML = '<span style="color:#a5ffcf"><i class="fa-solid fa-check"></i> Minted!</span>';
  }catch(err){
    console.error(err);
    if(E.mintStatus) E.mintStatus.innerHTML = '<span style="color:#ff9aa8"><i class="fa-solid fa-triangle-exclamation"></i> Mint failed. Check console.</span>';
    E.btnMint.disabled = false;
  }
});

/* =========================
   EVENTS — FILTERS, SEARCH, TABS
========================= */
E.filters?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip'); if(!btn) return;
  setFilter(btn.dataset.filter);
});
E.search?.addEventListener('input', e=>{ state.search = e.target.value; renderCenter(); });
$$('.side-menu .sbtn[data-tab]').forEach(b=> b.addEventListener('click', ()=> { switchTab(b.dataset.tab); renderAll(); window.scrollTo({top:0, behavior:'smooth'}); }));

/* =========================
   PARTICLES — soft floating stars
========================= */
(function particles(){
  const c = document.getElementById('auroraParticles'); if(!c) return;
  const ctx = c.getContext('2d'); let W=0,H=0, dots=[];
  function resize(){ W=c.width=window.innerWidth; H=c.height=Math.min(360, window.innerHeight*0.36); dots = Array.from({length:80}, ()=>({x:Math.random()*W,y:Math.random()*H, r:Math.random()*1.6+0.3, vx:(Math.random()-0.5)*0.15, vy:(Math.random()-0.5)*0.15})); }
  function step(){
    ctx.clearRect(0,0,W,H); ctx.globalAlpha=0.7;
    dots.forEach(d=>{
      d.x+=d.vx; d.y+=d.vy;
      if(d.x<0||d.x>W) d.vx*=-1; if(d.y<0||d.y>H) d.vy*=-1;
      ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
      ctx.fillStyle='rgba(122,233,255,.35)'; ctx.fill();
    });
    requestAnimationFrame(step);
  }
  window.addEventListener('resize', resize); resize(); step();
})();

/* =========================
   ROUTING & INIT
========================= */
function renderAll(){ renderSidebar(); renderCenter(); renderTabs(); updateHeaderAndRight(); }
function route(){
  const hash = location.hash.replace(/^#\//,'');
  if(!hash){ switchTab('overview'); return; }
  const [kind,a,b] = hash.split('/');
  if(kind==='tab'){ switchTab(a||'overview'); return; }
  if(kind==='module' && a && b){ switchTab('syllabus'); openModule(a,b); return; }
  switchTab('overview');
}
function restoreOpenDetail(){
  const openKey = localStorage.getItem(STORAGE.OPEN);
  if(openKey){
    const [areaId, id] = openKey.split(':');
    if(areaId && id){ switchTab('syllabus'); openModule(areaId, id); }
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  setupWeb3();
  renderAll();
  route();
  restoreOpenDetail();
  if(window.Web3Modal && web3Modal?.cachedProvider){ connect().catch(()=>{}); }
});
window.addEventListener('hashchange', route);
</script>
</body>
</html>
