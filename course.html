<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sovereignty Mastery Program</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
  :root{
    --bg:#0b0f14; --panel:#0e1320; --card:#121825; --muted:#9fb0c9; --text:#eaf2ff;
    --accent:#7c7cff; --accent-2:#5fe1b9; --gold:#f6c667; --ok:#22c55e; --warn:#f59e0b;
    --border:rgba(255,255,255,.08); --shadow:0 12px 30px rgba(0,0,0,.35); --radius:14px;
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0e1320 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  /* Sidebar */
  .sidebar{position:sticky;top:0;align-self:start;height:100dvh;background:rgba(12,18,31,.7);backdrop-filter:blur(8px);border-right:1px solid var(--border);padding:18px;overflow:auto}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:18px}
  .brand i{color:var(--accent)}
  .brand h1{font-size:1.1rem;margin:0;font-weight:800;letter-spacing:.2px}
  .nav-section{margin-top:16px}
  .nav-section h4{margin:14px 8px 8px;font-size:.8rem;text-transform:uppercase;letter-spacing:.1em;color:#cbd5ff}
  .tree{display:flex;flex-direction:column;gap:6px}
  .tree button{width:100%;text-align:left;background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .tree button:hover{background:rgba(255,255,255,.05)}
  .tree .leaf{margin-left:12px;border-color:transparent;background:rgba(255,255,255,.04)}
  .leaf.active{outline:2px solid rgba(124,124,255,.45)}
  .pill{font-size:.75rem;color:#cfe2ff;background:rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
  /* Main */
  .main{padding:22px 24px}
  .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  .search{flex:1;display:flex;align-items:center;background:#0f1522;border:1px solid var(--border);border-radius:999px;padding:8px 12px;gap:8px}
  .search input{flex:1;background:transparent;border:0;color:var(--text);outline:none}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,.06);border:1px solid var(--border);color:#cfe2ff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#0b0f14;border:0}
  .tabs{display:flex;gap:8px;margin:12px 0 18px}
  .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.05);cursor:pointer}
  .tab.active{background:linear-gradient(90deg,var(--accent),#8a7cff);color:#fff;border:0}
  .breadcrumb{color:var(--muted);font-size:.9rem;margin:6px 0 14px}
  /* Cards grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .card{background:linear-gradient(180deg,var(--card),#0f1522);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
  .badge{height:38px;width:38px;border-radius:10px;background:rgba(124,124,255,.16);border:1px solid rgba(124,124,255,.3);display:grid;place-items:center;font-weight:800;color:#bfbfff}
  .title{font-weight:700;margin:0}
  .muted{color:var(--muted)}
  .progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#8a7cff,var(--gold))}
  .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .btn{background:linear-gradient(90deg,var(--accent),#8a7cff);border:0;color:#fff;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center}
  .btn.secondary{background:transparent;border:1px solid var(--border);color:#cfe2ff}
  .btn:hover{transform:translateY(-1px)}
  /* Syllabus list */
  .syllabus{display:flex;flex-direction:column;gap:10px}
  .syllabus .item{display:grid;grid-template-columns:38px 1fr auto;gap:12px;align-items:center;background:rgba(255,255,255,.04);border:1px solid var(--border);padding:12px;border-radius:12px}
  .status-dot{width:10px;height:10px;border-radius:50%;background:#777}
  .status-dot.done{background:var(--ok);box-shadow:0 0 10px rgba(34,197,94,.5)}
  .status-dot.progress{background:var(--warn);box-shadow:0 0 10px rgba(245,158,11,.5)}
  /* Detail */
  .detail{background:linear-gradient(180deg,#0f1522,#0b101b);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
  .detail h2{margin:.2rem 0 0}
  .detail .theme{color:var(--muted);margin-bottom:8px}
  .detail .content{line-height:1.7}
  .detail .content h3{margin:1.1rem 0 .5rem;color:var(--accent-2)}
  .detail .content .practice{background:rgba(124,124,255,.08);border:1px dashed rgba(124,124,255,.35);border-radius:12px;padding:12px;margin:12px 0}
  .detail-nav{display:flex;justify-content:space-between;gap:10px;margin-top:14px}
  /* Progress view */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:14px}
  .kpi{background:rgba(255,255,255,.04);border:1px solid var(--border);padding:14px;border-radius:12px}
  .kpi h4{margin:0 0 6px}
  .bar{height:12px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
  .bar > span{height:100%;display:block;background:linear-gradient(90deg,var(--accent),#8a7cff,var(--gold))}
  /* Toast */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f1422;color:#eaf2ff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:.3s;z-index:1000}
  .toast.show{opacity:1}
  /* Responsive */
  @media (max-width: 980px){
    .app{grid-template-columns:1fr}
    .sidebar{position:relative;height:auto}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Program Navigation">
    <div class="brand">
      <i class="fa-solid fa-crown"></i>
      <h1>Sovereignty Mastery</h1>
    </div>
    <div class="nav-section">
      <h4>Areas</h4>
      <div class="tree" id="areaTree">
        <!-- populated by JS -->
      </div>
    </div>
    <div class="nav-section">
      <h4>Shortcuts</h4>
      <div class="tree">
        <button class="leaf" data-action="open-tab" data-tab="overview"><span><i class="fa-solid fa-grid-2"></i> Overview</span><span class="pill">Home</span></button>
        <button class="leaf" data-action="open-tab" data-tab="syllabus"><span><i class="fa-solid fa-list-check"></i> Syllabus</span><span class="pill">All</span></button>
        <button class="leaf" data-action="open-tab" data-tab="progress"><span><i class="fa-solid fa-chart-line"></i> Progress</span><span class="pill">Stats</span></button>
        <button class="leaf" data-action="open-tab" data-tab="resources"><span><i class="fa-solid fa-folder-open"></i> Resources</span><span class="pill">Links</span></button>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main" id="main">
    <div class="topbar">
      <div class="search" role="search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="searchInput" type="search" placeholder="Search modules, objectives, or lessons…" aria-label="Search modules">
      </div>
      <div class="filters" id="filters">
        <button class="chip active" data-filter="all">All</button>
        <button class="chip" data-filter="core">Core</button>
        <button class="chip" data-filter="sovereign">Sovereign Self</button>
        <button class="chip" data-filter="not-started">Not started</button>
        <button class="chip" data-filter="in-progress">In progress</button>
        <button class="chip" data-filter="completed">Completed</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Views">
      <button class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
      <button class="tab" data-tab="syllabus" role="tab" aria-selected="false">Syllabus</button>
      <button class="tab" data-tab="progress" role="tab" aria-selected="false">Progress</button>
      <button class="tab" data-tab="resources" role="tab" aria-selected="false">Resources</button>
      <button class="tab" data-tab="community" role="tab" aria-selected="false">Community</button>
    </div>

    <div class="breadcrumb" id="breadcrumb">Home</div>

    <!-- Views -->
    <section id="view-overview" class="view">
      <div class="grid" id="overviewGrid"></div>
    </section>

    <section id="view-syllabus" class="view" hidden>
      <div class="syllabus" id="syllabusList"></div>
    </section>

    <section id="view-progress" class="view" hidden>
      <div class="kpis">
        <div class="kpi">
          <h4>Total Completion</h4>
          <div class="bar"><span id="totalBar" style="width:0%"></span></div>
          <p class="muted"><span id="totalPct">0%</span> • <span id="completedCount">0</span>/<span id="totalCount">0</span> modules</p>
        </div>
        <div class="kpi">
          <h4>Core Program</h4>
          <div class="bar"><span id="coreBar" style="width:0%"></span></div>
          <p class="muted"><span id="corePct">0%</span> complete</p>
        </div>
        <div class="kpi">
          <h4>Sovereign Self</h4>
          <div class="bar"><span id="svBar" style="width:0%"></span></div>
          <p class="muted"><span id="svPct">0%</span> complete</p>
        </div>
        <div class="kpi">
          <h4>Time Spent</h4>
          <p class="muted" id="timeSpent">0h 0m</p>
          <button class="btn secondary" id="toggleTimer"><i class="fa-regular fa-clock"></i> Start Timer</button>
        </div>
      </div>
      <div class="grid" id="progressGrid"></div>
    </section>

    <section id="view-resources" class="view" hidden>
      <div class="card">
        <h3 class="title">Resources & Downloads</h3>
        <ul class="muted">
          <li>📝 Worksheets: Sovereignty Audit, Resource Audit</li>
          <li>🎧 Guided Practices: Deep Listening, Micro-Surrender</li>
          <li>📚 Reading List: Presence, Shadow Work, Non-Duality</li>
        </ul>
      </div>
    </section>

    <section id="view-community" class="view" hidden>
      <div class="card">
        <h3 class="title">Community</h3>
        <p class="muted">Host circles, Q&A, and office hours here. Embed your platform or link out.</p>
      </div>
    </section>

    <!-- Module Detail -->
    <section id="moduleDetail" class="detail" hidden aria-live="polite">
      <div class="breadcrumb" id="detailCrumb">Home</div>
      <h2 id="detailTitle">Module</h2>
      <div class="theme" id="detailTheme">Theme</div>
      <div class="row" style="gap:8px;margin:8px 0 12px">
        <span class="pill" id="detailAreaPill">Area</span>
        <span class="pill" id="detailStatusPill">Not Started</span>
      </div>
      <div id="detailContent" class="content"></div>
      <div class="detail-nav">
        <button class="btn secondary" id="btnBack"><i class="fa-solid fa-arrow-left"></i> Back</button>
        <div style="display:flex;gap:8px">
          <button class="btn secondary" id="btnPrev"><i class="fa-solid fa-arrow-left-long"></i> Prev</button>
          <button class="btn" id="btnNext">Next <i class="fa-solid fa-arrow-right-long"></i></button>
        </div>
        <button class="btn" id="btnToggleComplete"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
      </div>
    </section>
  </main>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite">Saved</div>

<script>
/* =========================
   Data Model (edit here)
========================= */
const COURSE = {
  areas: [
    {
      id: 'core',
      name: 'Core Program',
      description: '7-module path to awakening & embodiment',
      modules: [
        { id:'1', order:1, title:'Foundations of Self-Awareness', theme:'Becoming the Observer',
          objectives:['Lost-in-thought vs observing thought','Daily mindfulness practices','Journaling for clarity','3-Layer Belief Audit'],
          content: `
            <h3>Core Concept</h3>
            <p>Self-awareness is the foundation of awakening—stepping out of unconscious streams to observe with clarity and compassion.</p>
            <div class="practice"><h4>Practice — Thought Observation</h4><p>Set a 5-minute timer and label thoughts “thinking…” as they arise. Let them pass.</p></div>
            <h3>Journaling</h3><ul><li>What thoughts keep recurring?</li><li>What emotions am I skipping?</li><li>Where did I operate on autopilot?</li></ul>
          `
        },
        { id:'2', order:2, title:'Breaking the Illusion of Ego', theme:'You Are Not Your Story',
          objectives:['Ego vs Essence','Roles, labels & identity','Silent Watcher practice','Ego defenses'],
          content: `
            <h3>Core Concept</h3><p>See through roles and labels; meet the silent watcher beyond narrative identity.</p>
            <div class="practice"><h4>Practice — Identity Inventory</h4><p>List identities you wear; ask: “Without this, am I still here?”</p></div>
            <h3>Ego Defenses</h3><ul><li>Projection</li><li>Rationalization</li><li>Identification</li><li>Resistance</li></ul>
          `
        },
        { id:'3', order:3, title:'Entering the Now', theme:'Presence is Power',
          objectives:['Past/Future fixation','Sensory anchoring','Listening as meditation','Finding the silent gap'],
          content: `
            <h3>Core Concept</h3><p>Anchor attention in breath and senses; find the gap between thoughts.</p>
            <div class="practice"><h4>Practice — Deep Listening</h4><p>Offer another your full attention; return to pure hearing whenever mind wanders.</p></div>
          `
        },
        { id:'4', order:4, title:'Surrender & Emotional Alchemy', theme:'Freedom Through Letting Go',
          objectives:['What surrender truly is','Somatic flow of emotion','3-Step alchemy','Forgiveness as liberation'],
          content: `
            <h3>Core Concept</h3><p>Transmute emotion by allowing, feeling, and releasing.</p>
            <div class="practice"><h4>Practice — Micro-Surrender</h4><p>Choose one irritation today; say a conscious “yes” to it and feel the shift.</p></div>
          `
        },
        { id:'5', order:5, title:'The Illusion of Separation', theme:'Remembering Oneness',
          objectives:['Seeing through duality','Relational mirrors','Nature as teacher','Entanglement & connection'],
          content: `
            <h3>Core Concept</h3><p>See the unity behind duality; meet relationships and nature as mirrors.</p>
          `
        },
        { id:'6', order:6, title:'Embodied Enlightenment', theme:'Wisdom in Action',
          objectives:['Transcendence → integration','4 pillars of embodiment','Shadow & wholeness','Chop wood, carry water'],
          content: `
            <h3>Core Concept</h3><p>Integrate realization into daily life: design rhythms, embrace shadow, act with presence.</p>
          `
        },
        { id:'7', order:7, title:'Living as Awareness', theme:'The Unfolding Mystery',
          objectives:['Form & formlessness','Flow & spontaneity','Gift of impermanence','Beyond seeking'],
          content: `
            <h3>Core Concept</h3><p>Rest as awareness; move with spontaneity, impermanence, and effortless action.</p>
          `
        }
      ]
    },
    {
      id:'sovereign',
      name:'The Sovereign Self',
      description:'7-module journey into inner authority & stewardship',
      modules: [
        { id:'sv1', order:1, title:'The Call to Sovereignty', theme:'Claim your inner throne',
          objectives:['Identify where authority was surrendered','Trust the sovereign whisper','Discern ego vs soul','Commit to the call'],
          content:`<h3>Key Lessons</h3><ol><li>Recognizing the Whisper</li><li>Where You Gave Power Away</li><li>The Archetype of The Sovereign</li><li>The Sovereignty Audit</li></ol>`
        },
        { id:'sv2', order:2, title:'Dismantling the False Thrones', theme:'Name the illusions',
          objectives:['Expose disempowering systems','Meet inner tyrants','Dissolve hidden contracts'],
          content:`<h3>Practice — Breaking the Spell</h3><p>Write one limiting myth and declare: “This no longer rules me.”</p>`
        },
        { id:'sv3', order:3, title:'The Inner Throne', theme:'Authority within',
          objectives:['Anchor core values','Presence as throne','Self-anointing rituals'],
          content:`<h3>Practice — Alignment Scan</h3><p>Sit tall, breathe, and re-seat yourself on the inner throne.</p>`
        },
        { id:'sv4', order:4, title:'Boundaries, Consent & the Language of Power', theme:'Clear, Clean, Kind',
          objectives:['Boundaries as sacred agreements','Consent as currency','C3 communication'],
          content:`<blockquote>“What you allow becomes your law.”</blockquote>`
        },
        { id:'sv5', order:5, title:'Alchemy of Resources & Right Livelihood', theme:'Stewardship',
          objectives:['Steward time/energy/money/relations','Align work with soul','Redirect resources intentionally'],
          content:`<h3>Worksheet — Resource Audit</h3><p>Find leaks & alignments across four ledgers; choose one shift.</p>`
        },
        { id:'sv6', order:6, title:'Systems of Self-Governance', theme:'Design beats discipline',
          objectives:['Rhythms & agreements','Personal constitution','Reduce decision fatigue'],
          content:`<h3>Exercise — Constitution</h3><p>5 Core Laws, 3 Practices, 2 Red Lines. Read aloud 21 days.</p>`
        },
        { id:'sv7', order:7, title:'The Sovereign in Service', theme:'Steward the commons',
          objectives:['From isolation to contribution','Gift without depletion','Lead in reciprocity'],
          content:`<h3>Exercise — Service Vision</h3><p>What gift burns to be shared? Make one move in 72 hours.</p>`
        }
      ]
    }
  ]
};

/* =========================
   State & Utilities
========================= */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const qs = new URLSearchParams(location.hash.replace(/^#\//,'').split('?')[1]);

const STORAGE_KEYS = {
  PROGRESS: 'sv_progress_v1',
  TIMER: 'sv_timer_v1'
};

const state = {
  filter: 'all',
  search: '',
  tab: 'overview',
  timer: { running:false, startedAt:null, totalMs: loadTimer() }
};

function loadProgress(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.PROGRESS)) || {} }catch{ return {} }
}
function saveProgress(p){ localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(p)); toast('Progress saved'); }
function loadTimer(){
  try{ const t = JSON.parse(localStorage.getItem(STORAGE_KEYS.TIMER)); return t?.totalMs||0 }catch{ return 0 }
}
function saveTimer(){ localStorage.setItem(STORAGE_KEYS.TIMER, JSON.stringify({ totalMs: state.timer.totalMs })); }
function toast(msg){ const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 900); }

function allModules(){
  return COURSE.areas.flatMap(a=>a.modules.map(m=>({ ...m, areaId:a.id, areaName:a.name })));
}

function getModuleByKey(areaId, id){
  return COURSE.areas.find(a=>a.id===areaId)?.modules.find(m=>m.id===id);
}

function progressOf(mod){
  const p = loadProgress();
  return p[`${mod.areaId}:${mod.id}`] || { status:'not-started', percent:0 };
}

function setProgress(mod, status){
  const p = loadProgress();
  const key = `${mod.areaId}:${mod.id}`;
  const prev = p[key] || { percent:0 };
  p[key] = { status, percent: status==='completed'?100:(status==='in-progress'?Math.max(prev.percent,25):0) };
  saveProgress(p);
  render();
}

function percentCompleted(areaFilter){
  const mods = allModules().filter(m=>!areaFilter || m.areaId===areaFilter);
  const done = mods.filter(m=>progressOf(m).status==='completed').length;
  return { done, total:mods.length, pct: mods.length? Math.round(done/mods.length*100):0 };
}

/* =========================
   Rendering
========================= */
function renderSidebar(){
  const wrap = $('#areaTree');
  wrap.innerHTML = '';
  COURSE.areas.forEach(area=>{
    const headerBtn = document.createElement('button');
    headerBtn.innerHTML = `<span><i class="fa-solid fa-layer-group"></i> ${area.name}</span><span class="pill">${area.modules.length}</span>`;
    headerBtn.addEventListener('click', ()=>{ openTab('syllabus'); setFilter(area.id); });
    wrap.appendChild(headerBtn);

    area.modules.forEach(m=>{
      const leaf = document.createElement('button');
      leaf.className = 'leaf';
      const k = `${area.id}:${m.id}`;
      const st = progressOf({areaId:area.id,id:m.id}).status;
      const dot = st==='completed' ? '<span class="status-dot done" title="Completed"></span>' :
                 st==='in-progress' ? '<span class="status-dot progress" title="In progress"></span>' :
                 '<span class="status-dot" title="Not started"></span>';
      leaf.innerHTML = `<span style="display:flex;align-items:center;gap:10px">${dot}<strong>${m.order}.</strong> ${m.title}</span>
                        <span class="pill">${area.id==='core'?'Core':'Sovereign'}</span>`;
      leaf.addEventListener('click', ()=>openModule(area.id, m.id));
      wrap.appendChild(leaf);
    });
  });
}

function moduleMatches(m){
  const st = progressOf(m).status;
  const matchesStatus =
    state.filter==='all' ? true :
    state.filter==='not-started' ? st==='not-started' :
    state.filter==='in-progress' ? st==='in-progress' :
    state.filter==='completed' ? st==='completed' :
    state.filter===m.areaId;
  const s = state.search.trim().toLowerCase();
  const matchesSearch = !s || [m.title,m.theme,...(m.objectives||[])].join(' ').toLowerCase().includes(s);
  return matchesStatus && matchesSearch;
}

function renderOverview(){
  const grid = $('#overviewGrid');
  grid.innerHTML = '';
  allModules().filter(moduleMatches).sort((a,b)=> (a.areaId===b.areaId ? a.order-b.order : a.areaId.localeCompare(b.areaId)) )
    .forEach(m=>{
      const p = progressOf(m);
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="row">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="badge">${m.areaId==='core'?m.order:m.id.replace('sv','')}</div>
            <div>
              <h3 class="title">${m.title}</h3>
              <div class="muted">${m.theme}</div>
            </div>
          </div>
          <span class="pill">${m.areaId==='core'?'Core':'Sovereign'}</span>
        </div>
        <div class="muted">Objectives: ${m.objectives.slice(0,2).join(' • ')}${m.objectives.length>2?'…':''}</div>
        <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
        <div class="row">
          <span class="muted">${p.status==='not-started'?'Not Started':p.status==='in-progress'?'In Progress':'Completed'}</span>
          <button class="btn" aria-label="Open ${m.title}"><i class="fa-regular fa-book-open"></i> Open</button>
        </div>`;
      card.querySelector('.btn').addEventListener('click', ()=>openModule(m.areaId,m.id));
      grid.appendChild(card);
    });
}

function renderSyllabus(){
  const list = $('#syllabusList');
  list.innerHTML='';
  COURSE.areas.forEach(area=>{
    const header = document.createElement('div');
    header.className='item';
    header.innerHTML = `<div class="badge"><i class="fa-solid fa-layer-group"></i></div>
                        <div><strong>${area.name}</strong><div class="muted">${area.description}</div></div>
                        <button class="btn secondary">View</button>`;
    header.querySelector('button').addEventListener('click', ()=>{ openTab('overview'); setFilter(area.id); });
    list.appendChild(header);

    area.modules.forEach(m=>{
      if(!moduleMatches({...m, areaId:area.id})) return;
      const p = progressOf({areaId:area.id,id:m.id});
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `
        <div class="badge">${area.id==='core'?m.order:m.id.replace('sv','')}</div>
        <div>
          <div style="display:flex;justify-content:space-between;gap:10px">
            <div><strong>${m.title}</strong> · <span class="muted">${m.theme}</span></div>
            <span class="muted">${p.status==='completed'?'✅ Completed':p.status==='in-progress'?'⏳ In progress':'• Not started'}</span>
          </div>
          <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
        </div>
        <button class="btn">Open</button>`;
      row.querySelector('.btn').addEventListener('click', ()=>openModule(area.id,m.id));
      list.appendChild(row);
    });
  });
}

function renderProgress(){
  const {done,total,pct} = percentCompleted();
  $('#completedCount').textContent = done; $('#totalCount').textContent = total;
  $('#totalPct').textContent = pct+'%'; $('#totalBar').style.width = pct+'%';

  const core = percentCompleted('core'); $('#corePct').textContent=core.pct+'%'; $('#coreBar').style.width=core.pct+'%';
  const sv = percentCompleted('sovereign'); $('#svPct').textContent=sv.pct+'%'; $('#svBar').style.width=sv.pct+'%';

  const grid = $('#progressGrid'); grid.innerHTML='';
  allModules().forEach(m=>{
    const p = progressOf(m);
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = `<div class="row"><strong>${m.title}</strong><span class="pill">${m.areaId==='core'?'Core':'Sovereign'}</span></div>
                   <div class="muted">${m.theme}</div>
                   <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
                   <div class="row">
                     <div class="muted">${p.status==='not-started'?'Not Started':p.status==='in-progress'?'In Progress':'Completed'}</div>
                     <div style="display:flex;gap:8px">
                       <button class="btn secondary mark-in">Mark In-Progress</button>
                       <button class="btn mark-done"><i class="fa-regular fa-circle-check"></i> Complete</button>
                     </div>
                   </div>`;
    c.querySelector('.mark-in').addEventListener('click', ()=>{ setProgress(m,'in-progress'); });
    c.querySelector('.mark-done').addEventListener('click', ()=>{ setProgress(m,'completed'); });
    grid.appendChild(c);
  });
}

function renderModuleDetail(areaId, id){
  const area = COURSE.areas.find(a=>a.id===areaId);
  const mod = area.modules.find(m=>m.id===id);
  const keyIndex = allModules().findIndex(x=>x.areaId===areaId && x.id===id);
  const list = allModules();

  $('#moduleDetail').hidden = false;
  $('#detailTitle').textContent = mod.title;
  $('#detailTheme').textContent = mod.theme;
  $('#detailAreaPill').textContent = area.name;
  const p = progressOf({areaId,id});
  $('#detailStatusPill').textContent = p.status==='completed'?'Completed':p.status==='in-progress'?'In progress':'Not Started';
  $('#detailContent').innerHTML = `
     <h3>Learning Objectives</h3>
     <ul>${mod.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>
     ${mod.content||''}
  `;
  $('#detailCrumb').innerHTML = `<a href="#/">Home</a> · <a href="#/tab/syllabus">Syllabus</a> · <span>${mod.title}</span>`;

  $('#btnBack').onclick = ()=>history.back();
  $('#btnPrev').onclick = ()=> {
    const prev = list[keyIndex-1] || list[list.length-1];
    openModule(prev.areaId, prev.id);
  };
  $('#btnNext').onclick = ()=> {
    const next = list[keyIndex+1] || list[0];
    openModule(next.areaId, next.id);
  };
  $('#btnToggleComplete').onclick = ()=>{
    const current = progressOf({areaId,id}).status;
    setProgress({areaId,id}, current==='completed'?'in-progress':'completed');
    renderModuleDetail(areaId,id);
  };
}

function renderBreadcrumb(){
  const t = state.tab;
  const map = { overview:'Home', syllabus:'Home · Syllabus', progress:'Home · Progress', resources:'Home · Resources', community:'Home · Community' };
  $('#breadcrumb').textContent = map[t] || 'Home';
}

function render(){
  renderSidebar();
  renderOverview();
  renderSyllabus();
  renderProgress();
  renderBreadcrumb();
  // views
  $$('.view').forEach(v=>v.hidden = !v.id.endsWith(state.tab));
  // tabs
  $$('.tab').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.tab===state.tab);
    btn.setAttribute('aria-selected', btn.dataset.tab===state.tab ? 'true' : 'false');
  });
}

/* =========================
   Interactions
========================= */
function openTab(tab){
  state.tab = tab;
  location.hash = `#/tab/${tab}`;
  $('#moduleDetail').hidden = true;
  render();
}

function setFilter(filter){
  state.filter = filter;
  $$('#filters .chip').forEach(c=>c.classList.toggle('active', c.dataset.filter===filter || (filter==='all' && c.dataset.filter==='all')));
  render();
}

function openModule(areaId, id){
  // set in-progress if brand new
  const p = progressOf({areaId,id});
  if(p.status==='not-started') setProgress({areaId,id}, 'in-progress');
  location.hash = `#/module/${areaId}/${id}`;
}

function applySearch(value){
  state.search = value;
  render();
}

/* Timer */
let timerTick = null;
function startTimer(){
  if(state.timer.running) return;
  state.timer.running = true;
  state.timer.startedAt = Date.now();
  $('#toggleTimer').textContent = 'Stop Timer';
  $('#toggleTimer').prepend(Object.assign(document.createElement('i'),{className:'fa-regular fa-circle-stop',style:'margin-right:8px'}));
  timerTick = setInterval(()=>{
    const total = state.timer.totalMs + (state.timer.running ? Date.now() - state.timer.startedAt : 0);
    $('#timeSpent').textContent = msToH(total);
  }, 1000);
}
function stopTimer(){
  if(!state.timer.running) return;
  state.timer.totalMs += Date.now() - state.timer.startedAt;
  state.timer.running = false; state.timer.startedAt = null;
  clearInterval(timerTick); timerTick=null;
  saveTimer();
  $('#toggleTimer').innerHTML = '<i class="fa-regular fa-clock"></i> Start Timer';
  $('#timeSpent').textContent = msToH(state.timer.totalMs);
}
function msToH(ms){ const m = Math.floor(ms/60000), h = Math.floor(m/60), mm = m%60; return `${h}h ${mm}m`; }

/* =========================
   Routing (hash-based)
========================= */
function route(){
  const hash = location.hash.replace(/^#\//,'');
  if(!hash){ openTab('overview'); return; }
  const [kind,a,b] = hash.split('/');
  if(kind==='tab' && a){ state.tab = a; $('#moduleDetail').hidden = true; render(); return; }
  if(kind==='module' && a && b){
    state.tab = 'syllabus';
    render();
    $('#moduleDetail').hidden=false;
    renderModuleDetail(a,b);
    return;
  }
  openTab('overview');
}

/* =========================
   Event Wiring
========================= */
window.addEventListener('hashchange', route);
document.addEventListener('DOMContentLoaded', ()=>{
  // Tabs
  $$('.tab').forEach(t => t.addEventListener('click', ()=>openTab(t.dataset.tab)));
  // Filters
  $$('#filters .chip').forEach(c=>c.addEventListener('click', ()=>setFilter(c.dataset.filter)));
  // Search
  $('#searchInput').addEventListener('input', e=>applySearch(e.target.value));
  // Timer
  $('#toggleTimer').addEventListener('click', ()=> state.timer.running ? stopTimer() : startTimer());

  // Sidebar quick links
  $$('.sidebar [data-action="open-tab"]').forEach(b=> b.addEventListener('click', ()=>openTab(b.dataset.tab)));

  // Initial
  render();
  route();
  // init time spent
  $('#timeSpent').textContent = msToH(state.timer.totalMs);
});

/* =========================
   Keyboard Shortcuts
========================= */
/*
  g o  -> overview
  g s  -> syllabus
  g p  -> progress
  /    -> focus search
*/
let gPressed = false;
document.addEventListener('keydown', (e)=>{
  if(e.key==='/' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ e.preventDefault(); $('#searchInput').focus(); }
  if(e.key.toLowerCase()==='g'){ gPressed = true; setTimeout(()=>gPressed=false, 800); return; }
  if(gPressed){
    if(e.key.toLowerCase()==='o') openTab('overview');
    if(e.key.toLowerCase()==='s') openTab('syllabus');
    if(e.key.toLowerCase()==='p') openTab('progress');
  }
});
</script>
</body>
</html>
