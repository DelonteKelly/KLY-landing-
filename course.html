<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sovereignty Mastery Program Â· Web3-Gated Course</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A 14-module journey to reclaim your personal power, with on-chain access, progress tracking, checklists, notes, quizzes, and certificate." />
  <meta name="theme-color" content="#0A0A1E"/>

  <!-- Preconnects to speed up font/icon loads -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">

  <!-- Animation / Confetti -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Web3 Libraries (deferred so they don't block rendering) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script defer src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script defer src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root {
      --primary: #6C4DF6;
      --primary-light: #8A6DF9;
      --secondary: #FF7D05;
      --secondary-light: #FF9A3D;
      --accent: #00E0FF;
      --accent-light: #5DEBFF;
      --dark: #0A0A1E;
      --darker: #050510;
      --light: #F5F5FF;
      --lighter: #FFFFFF;
      --success: #00C853;
      --warning: #FFAB00;
      --danger: #FF3D00;
      --card-bg: rgba(15, 15, 35, 0.8);
      --glass: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.15);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --focus: #5DEBFF;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html:focus-within { scroll-behavior: smooth; }
    body {
      background: var(--darker);
      background-image:
        radial-gradient(at 80% 0%, rgba(108, 77, 246, 0.2) 0px, transparent 50%),
        radial-gradient(at 0% 50%, rgba(0, 224, 255, 0.2) 0px, transparent 50%),
        linear-gradient(to bottom, rgba(10,10,30,0.9), rgba(5,5,16,1));
      color: var(--light);
      font-family: 'Kanit', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Reduced motion friendly */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    /* Floating Particles Background */
    .particles { position: fixed; inset: 0; z-index: -1; overflow: hidden; }
    .particle { position: absolute; border-radius: 50%; opacity: 0.3; animation: float linear infinite; }
    @keyframes float { 0% { transform: translateY(0) translateX(0); } 50% { transform: translateY(-100px) translateX(50px); } 100% { transform: translateY(0) translateX(0); } }

    /* Typography */
    h1, h2, h3, h4 { font-family: 'Space Grotesk', sans-serif; font-weight: 700; margin-bottom: 1rem; }
    h1 {
      font-size: 3rem;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      line-height: 1.2; text-transform: uppercase; letter-spacing: 1px; position: relative; display: inline-block;
    }
    h1::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 3px; }
    h2 { font-size: 2rem; color: var(--accent); position: relative; padding-bottom: 0.5rem; }
    h2::after { content: ''; position: absolute; bottom: 0; left: 0; width: 50px; height: 2px; background: var(--accent); }
    p { margin-bottom: 1rem; color: rgba(255, 255, 255, 0.85); }
    a { color: var(--accent); text-decoration: none; transition: color .2s ease; position: relative; }
    a:hover { color: var(--accent-light); }
    a:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }

    /* Layout */
    .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
    header { padding: 3rem 0 2rem; text-align: center; position: relative; }
    .logo { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 1rem; position: relative; }
    .logo-icon { color: var(--primary); font-size: 3rem; }
    .tagline { font-size: 1.2rem; color: rgba(255, 255, 255, 0.75); max-width: 760px; margin: 0 auto 1.5rem; }

    .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; padding-bottom: 4rem; }
    @media (max-width: 992px) { .main-content { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar { background: var(--card-bg); border-radius: 1.5rem; padding: 2rem; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); height: fit-content; position: sticky; top: 2rem; box-shadow: var(--shadow); }
    .user-profile { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); }
    .avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: grid; place-items: center; font-weight: 700; font-size: 1.1rem; color: white; box-shadow: 0 0 0 3px rgba(108, 77, 246, 0.3); }
    .wallet-info { font-size: 0.9rem; }
    .wallet-address { font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace; word-break: break-all; color: var(--lighter); }
    .disconnect-btn { background: none; border: 1px solid transparent; color: var(--danger); font-size: 0.85rem; cursor: pointer; margin-top: 0.4rem; padding: .25rem .5rem; border-radius: .4rem; }
    .disconnect-btn:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }

    .progress-container { margin: 2rem 0; }
    .progress-title { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.9rem; color: var(--lighter); }
    .progress-bar { height: 10px; background: var(--dark); border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 5px; width: 0%; transition: width 0.4s ease; position: relative; overflow: hidden; }
    .progress-fill::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.25) 50%, rgba(255,255,255,0) 100%); animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }

    .course-menu { margin-top: 2rem; }
    .course-menu h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--accent); display: flex; align-items: center; gap: 0.5rem; }
    .course-list-container { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
    .course-list-container::-webkit-scrollbar { width: 4px; }
    .course-list-container::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 2px; }
    .menu-item { display: flex; align-items: center; gap: 1rem; padding: .9rem; border-radius: .8rem; cursor: pointer; transition: background .2s ease, transform .2s ease; margin-bottom: .5rem; background: rgba(0,0,0,.3); border: 1px solid transparent; }
    .menu-item:hover, .menu-item:focus-visible { background: rgba(108, 77, 246, 0.2); border-color: rgba(108, 77, 246, 0.35); transform: translateX(3px); outline: none; }
    .menu-item.active { background: linear-gradient(90deg, rgba(108, 77, 246, 0.3), rgba(0, 224, 255, 0.2)); border-color: var(--glass-border); box-shadow: 0 5px 15px rgba(108,77,246,0.22); }
    .menu-icon { width: 30px; height: 30px; border-radius: 8px; background: rgba(0, 224, 255, 0.1); display: grid; place-items: center; color: var(--accent); }
    .menu-item.active .menu-icon { background: var(--primary); color: white; }
    .menu-text { flex: 1; display:flex; align-items:center; gap:.5rem; flex-wrap: wrap; }
    .menu-badge { background: var(--secondary); color: var(--darker); padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 700; }

    /* Course Content */
    .course-content { background: var(--card-bg); border-radius: 1.5rem; padding: 2.5rem; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: var(--shadow); }
    .module-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); }
    .module-title { font-size: 1.8rem; color: var(--lighter); display: flex; align-items: center; gap: 1rem; }
    .module-number { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: grid; place-items: center; color: white; font-weight: 700; }
    .module-nav { display: flex; gap: 1rem; }
    .module-body { padding: 1rem 0; }
    .module-section { margin-bottom: 2rem; }
    .module-section h3 { color: var(--secondary-light); margin-bottom: 1rem; font-size: 1.15rem; display: flex; align-items: center; gap: 0.8rem; }
    .module-section h3 i { color: var(--accent); font-size: 1.05rem; }
    .module-section ul { padding-left: 1.2rem; margin-bottom: 1rem; }
    .module-section li { margin-bottom: 0.6rem; position: relative; padding-left: 0.6rem; color: rgba(255, 255, 255, 0.9); }
    .module-section li::before { content: ''; position: absolute; left: 0; top: 0.7rem; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

    .callout { background: rgba(0, 224, 255, 0.1); border-left: 4px solid var(--accent); padding: 1.2rem; margin: 1.5rem 0; border-radius: 0 .8rem .8rem 0; position: relative; overflow: hidden; }
    .callout-icon { position: absolute; top: .9rem; right: 1rem; opacity: 0.12; font-size: 3rem; color: var(--accent); }
    .callout-title { font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-light); }

    /* Checklists & Notes */
    .checklist{margin:1rem 0;padding:1rem;border:1px dashed var(--glass-border);border-radius:.8rem}
    .check-item{display:flex;align-items:center;gap:.6rem;margin:.4rem 0}
    .notes-box{width:100%;min-height:110px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);border-radius:.6rem;color:var(--light);padding:.8rem}

    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.8rem; padding: 1rem 1.4rem; border-radius: 0.8rem; font-weight: 700; cursor: pointer; transition: transform .15s ease, box-shadow .15s ease; border: none; font-family: 'Space Grotesk', sans-serif; text-transform: uppercase; letter-spacing: 0.4px; position: relative; }
    .btn:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }
    .btn-primary { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 5px 20px rgba(108, 77, 246, 0.45); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(108, 77, 246, 0.6); }
    .btn-outline { background: transparent; border: 2px solid var(--glass-border); color: var(--light); }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 5px 15px rgba(0, 224, 255, 0.2); }
    .btn-sm { padding: 0.7rem 1.1rem; font-size: 0.9rem; }

    /* Wallet Connect Section */
    .connect-section { text-align: center; max-width: 700px; margin: 3rem auto; padding: 3rem; background: var(--card-bg); border-radius: 1.5rem; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .connect-section::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at center, rgba(108, 77, 246, 0.1) 0%, transparent 70%); animation: rotate 20s linear infinite; z-index: -1; }
    @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .connect-note { font-size: 0.95rem; color: #bbb; margin: 0.4rem 0 0.4rem; }

    /* Notification */
    .notification { position: fixed; bottom: 2rem; right: 2rem; padding: 1.0rem 1.5rem; background: var(--dark); color: white; border-radius: 0.8rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 1rem; z-index: 1000; border-left: 4px solid var(--primary); max-width: 420px; }
    .notification.success { border-left-color: var(--success); }
    .notification.error { border-left-color: var(--danger); }
    .notification.warning { border-left-color: var(--warning); }
    .notification-message { font-size: 0.92rem; opacity: 0.95; }
    .notification-close { background: none; border: none; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 1rem; }
    .notification-close:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }

    /* Modal Styles */
    .modal-overlay { position: fixed; inset: 0; background: rgba(5, 5, 16, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s ease; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-container { background: var(--card-bg); border-radius: 1.5rem; border: 1px solid var(--glass-border); width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 2.2rem; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
    .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--light); font-size: 1.3rem; cursor: pointer; width: 42px; height: 42px; border-radius: 50%; display: grid; place-items: center; }
    .modal-close:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }
    .modal-header { margin-bottom: 1.5rem; padding-right: 3rem; }
    .modal-title { font-size: 1.8rem; color: var(--lighter); margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.8rem; }
    .modal-subtitle { color: var(--accent); font-size: 1.1rem; font-weight: 600; }
    .modal-body { padding: .5rem 0; }
    .practice-box { background: rgba(0, 224, 255, 0.1); border-left: 4px solid var(--accent); padding: 1.1rem; margin: 1.3rem 0; border-radius: 0 .8rem .8rem 0; }

    /* Certificate Section */
    .certificate-section { text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--glass-border); display:none; }
    .certificate-title { font-size: 1.6rem; margin-bottom: 0.6rem; background: linear-gradient(90deg, var(--primary), var(--accent)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .certificate-desc { max-width: 600px; margin: 0 auto 1rem; font-size: 1rem; }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .container { padding: 0 1.2rem; }
      header { padding: 2rem 0 1.2rem; }
      h1 { font-size: 2.2rem; }
      .logo { font-size: 2rem; }
      .connect-section { padding: 2rem 1.2rem; }
      .module-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
      .module-nav { width: 100%; justify-content: space-between; }
      .btn { width: 100%; }
    }

    /* Bottom mobile nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,30,.95);
      border-top:1px solid var(--glass-border);backdrop-filter:blur(10px);padding:.6rem 1rem;display:none;gap:.8rem;z-index:9999}
    @media (max-width:768px){.bottom-nav{display:flex}}
    .bottom-nav .btn{flex:1}
  
/* Accessibility helpers */
.sr-only {
  position: absolute !important;
  width: 1px; height: 1px; padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
}
/* Status pill for modal state */
.status-indicator{display:inline-block;width:.7rem;height:.7rem;border-radius:50%;background:#777;margin-right:.4rem;vertical-align:middle}
.status-indicator.in-progress{background:var(--warning)}
.status-indicator.completed{background:var(--success)}

</style>
</head>
<body>
  <!-- Floating Particles Background -->
  <div class="particles" id="particles" aria-hidden="true"></div>

  <div class="container">
    <header role="banner">
      <div class="logo" aria-label="Sovereignty Mastery">
        <i class="fas fa-crown logo-icon" aria-hidden="true"></i>
        <span>Sovereignty Mastery</span>
      </div>
      <p class="tagline">A transformative journey to reclaim your personal power and live with authentic authority.</p>
    </header>

    <div class="main-content">
      <aside class="sidebar" aria-label="Sidebar">
        <div class="user-profile" id="userProfile">
          <div class="avatar" id="userAvatar" aria-hidden="true">?</div>
          <div class="wallet-info">
            <div class="wallet-address" id="walletAddress">Not connected</div>
            <button type="button" class="disconnect-btn" id="disconnectBtn" style="display: none;" aria-label="Disconnect wallet">
              <i class="fas fa-unlink" aria-hidden="true"></i> Disconnect
            </button>
          </div>
        </div>

        <div class="progress-container" aria-label="Progress">
          <div class="progress-title">
            <span>Your Progress</span>
            <span id="progressPercentage" aria-live="polite">0%</span>
          </div>
          <div id="progressBar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-labelledby="progressPercentage">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>

        <nav class="course-menu" aria-label="Course Modules">
          <h3><i class="fas fa-graduation-cap" aria-hidden="true"></i> Course Modules</h3>
          <div class="course-list-container" id="courseList">
            <!-- Menu items generated dynamically -->
          </div>
        </nav>

        <section class="streak-box" aria-label="Practice Streak">
          <div class="streak-title"><i class="fas fa-fire" aria-hidden="true"></i> Practice Streak</div>
          <div class="streak-num" id="streakNum">0 days</div>
          <div class="achievements" id="achievementsRow" aria-live="polite"></div>
        </section>
      </aside>

      <main class="course-content" id="courseContent" role="main" aria-live="polite">
        <section class="connect-section" id="connectSection" aria-label="Connect Wallet">
          <h2>Connect Your Wallet</h2>
          <p class="connect-note">
            Connect your Web3 wallet to access the complete <strong>Sovereignty Mastery Program</strong>, track your progress, and unlock all 14 modules.<br>
            Access requires holding at least <strong>5 SolCoin</strong> on <strong>BNB Smart Chain</strong>.
          </p>
          <div class="wallet-options" role="group" aria-label="Wallet Options">
            <button type="button" class="wallet-option" id="connectWalletBtn" aria-label="Connect wallet">
              <i class="fas fa-wallet wallet-icon" aria-hidden="true"></i>
              <span>Connect Wallet</span>
            </button>
          </div>
        </section>

        <section class="module-content" id="moduleContent" style="display:none;" aria-label="Module Content">
          <div class="module-header">
            <div class="module-title">
              <div class="module-number" id="moduleNumber">1</div>
              <span id="moduleTitle">Foundation of Sovereignty</span>
            </div>
            <div class="module-nav" role="group" aria-label="Module Navigation">
              <button type="button" class="btn btn-outline btn-sm" id="prevModuleBtn" disabled aria-label="Previous module">
                <i class="fas fa-chevron-left" aria-hidden="true"></i> Previous
              </button>
              <button type="button" class="btn btn-primary btn-sm" id="nextModuleBtn" aria-label="Next module">
                Next <i class="fas fa-chevron-right" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div class="module-body">
            <div class="module-section">
              <h3><i class="fas fa-bullseye" aria-hidden="true"></i> Core Concept</h3>
              <p id="moduleConcept"></p>
            </div>

            <div class="module-section">
              <h3><i class="fas fa-tasks" aria-hidden="true"></i> Learning Objectives</h3>
              <ul id="moduleObjectives"></ul>
            </div>

            <div class="module-section">
              <h3><i class="fas fa-book-open" aria-hidden="true"></i> Key Lessons</h3>
              <ul id="moduleLessons"></ul>
            </div>

            <div class="module-section">
              <h3><i class="fas fa-list-check" aria-hidden="true"></i> Your Checklist</h3>
              <div class="checklist" id="moduleChecklist"></div>
            </div>

            <div class="module-section">
              <h3><i class="fas fa-note-sticky" aria-hidden="true"></i> Notes</h3>
              <label class="sr-only" for="moduleNotes">Notes</label>
              <textarea id="moduleNotes" class="notes-box" placeholder="Insights, commitments, declarationsâ¦"></textarea>
            </div>

            <div class="practice-box" id="modulePractice" aria-label="Practice">
              <div class="practice-title">
                <i class="fas fa-pen-fancy" aria-hidden="true"></i> Sovereignty Practice
              </div>
              <p><strong>Reflection Questions:</strong></p>
              <ul id="practiceQuestions"></ul>
              <p><strong>Action Step:</strong> <span id="actionStep"></span></p>
            </div>

            <div class="callout" role="note" aria-label="Sovereign Insight">
              <i class="fas fa-lightbulb callout-icon" aria-hidden="true"></i>
              <div class="callout-title">Sovereign Insight</div>
              <p id="sovereignInsight"></p>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-top:1rem;">
              <div id="miniMeta" style="font-size:.9rem;color:#bbb;"></div>
              <div>
                <button type="button" class="btn btn-primary" id="openModal" aria-haspopup="dialog" aria-controls="modalOverlay" aria-expanded="false">
                  <i class="fas fa-expand" aria-hidden="true"></i> View Full Module Content
                </button>
              </div>
            </div>
          </div>

          <!-- Certificate CTA appears when all modules complete -->
          <section class="certificate-section" id="certificateSection" aria-label="Certificate">
            <h3 class="certificate-title">Sovereignty Mastery Certificate</h3>
            <p class="certificate-desc">Download your certificate. On-chain mint coming next.</p>
            <canvas id="certCanvas" width="1200" height="675" class="floating" style="max-width:100%;" aria-label="Certificate preview"></canvas>
            <div style="margin-top:1rem;">
              <button class="btn btn-primary" id="downloadCertBtn" aria-label="Download certificate PNG"><i class="fas fa-download" aria-hidden="true"></i> Download PNG</button>
            </div>
          </section>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-container" role="dialog" aria-modal="true" aria-labelledby="modalModuleTitle" aria-describedby="modalModuleContent" tabindex="-1">
      <button type="button" class="modal-close" id="modalClose" aria-label="Close dialog">
        <i class="fas fa-times" aria-hidden="true"></i>
      </button>

      <div class="modal-header">
        <h2 class="modal-title">
          <div class="module-number" id="modalModuleNumber">1</div>
          <span id="modalModuleTitle">Foundation of Sovereignty</span>
        </h2>
        <div class="modal-subtitle" id="modalModuleSubtitle">Understanding Personal Power</div>
      </div>

      <div class="modal-body" id="modalModuleContent"></div>

      <div class="modal-footer" style="display:flex;align-items:center;justify-content:space-between;gap:.8rem;flex-wrap:wrap;">
        <div class="module-status" aria-live="polite">
          <span class="status-indicator" id="modalStatusIndicator" aria-hidden="true"></span>
          <span class="status-text" id="modalStatusText">Not Started</span>
        </div>
        <div id="quizRow" style="margin-right:1rem;"></div>
        <div style="display:flex;gap:.6rem;">
          <button class="btn btn-outline btn-sm" id="saveProgressBtn" aria-label="Save progress">
            <i class="fas fa-bookmark" aria-hidden="true"></i> Save Progress
          </button>
          <button class="btn btn-primary btn-sm" id="markCompleteBtn" aria-label="Mark module complete">
            Mark Complete <i class="fas fa-check" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="bottom-nav" role="group" aria-label="Mobile Navigation">
    <button type="button" class="btn btn-outline btn-sm" id="mPrev" aria-label="Previous module"><i class="fas fa-chevron-left" aria-hidden="true"></i> Prev</button>
    <button type="button" class="btn btn-primary btn-sm" id="mNext" aria-label="Next module">Next <i class="fas fa-chevron-right" aria-hidden="true"></i></button>
  </div>

<script>
/* ================== CONFIG ================== */
const TOKEN_ADDRESS   = '0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026';
const REQUIRED_TOKENS = 5;

// Target network (BNB Smart Chain)
const CHAIN_ID   = 56;
const CHAIN_NAME = 'BNB Smart Chain';
const RPC_URL    = 'https://bsc-dataseed.binance.org';

// Minimal ERC-20 ABI
const ERC20_ABI = [
  'function balanceOf(address) view returns (uint256)',
  'function decimals() view returns (uint8)',
  'function symbol() view returns (string)'
];

/* ================== HELPERS / GLOBALS ================== */
function toHexChainId(id) { const n = (typeof id === 'bigint') ? id : BigInt(id); return '0x' + n.toString(16); }
const isEthersV6 = !!ethers.BrowserProvider;
const getFormatUnits = () => (ethers.utils && ethers.utils.formatUnits) ? ethers.utils.formatUnits : ethers.formatUnits;

let web3Modal, extProvider, provider, signer, tokenContract;

const STORAGE_KEY       = (addr) => `sovereigntyProgress:${(addr||'guest').toLowerCase()}`;
const LAST_MODULE_KEY   = (addr) => `sovereigntyLastModule:${(addr||'guest').toLowerCase()}`;
const STREAK_KEY        = (addr) => `sovereigntyStreak:${(addr||'guest').toLowerCase()}`;
const CHECK_KEY         = (addr,mod)=>`sovereigntyChecklist:${(addr||'guest').toLowerCase()}:${mod}`;
const NOTES_KEY         = (addr,mod)=>`sovereigntyNotes:${(addr||'guest').toLowerCase()}:${mod}`;

let currentModule = 1;
let userProgress = {};
let userAddress = null;
let tokenSymbol = 'TOKEN';
let tokenDecimals = 18;

/* ================== WEB3MODAL SETUP (FIXED) ================== */
const Web3ModalCtor      = window.Web3Modal?.default || window.Web3Modal || null;
const WalletConnectPkgV1 = window.WalletConnectProvider?.default || window.WalletConnectProvider || null;

function setupWeb3Modal() {
  if (!Web3ModalCtor) { console.warn('Web3Modal v1 not found; using injected provider only.'); return null; }
  const providerOptions = {
    walletconnect: {
      package: WalletConnectPkgV1,
      options: { rpc: { [CHAIN_ID]: RPC_URL }, chainId: CHAIN_ID }
    }
  };
  return new Web3ModalCtor({ cacheProvider: true, providerOptions, theme: 'dark' });
}
web3Modal = setupWeb3Modal();

/* ================== COURSE DATA (14 modules) ================== */
const courseModules = [
  id: 1,
    title: "Foundation of Sovereignty",
    subtitle: "Understanding Personal Power",
    concept: "Sovereignty is your birthright to complete authority over your beingâthoughts, emotions, choices, and energy.",
    objectives: [
      "Understand historical and philosophical roots of sovereignty",
      "Identify where you've surrendered personal authority",
      "Differentiate ego power vs. soul-aligned power",
      "Establish a daily sovereignty practice",
      "Write a personal sovereignty declaration"
    ],
    lessons: [
      {
        title: "Historic Context across cultures",
        core: [
          "Kemetâs Maâat frames sovereignty as alignment with cosmic order (truth, balance, reciprocity) rather than domination.",
          "Stoicism centers internal locus of control: only judgments, choices, and responses are truly âyoursâ.",
          "Indigenous frameworks treat authority as stewardship and relational responsibility, not mere entitlement."
        ]
      },
      {
        title: "Internal vs. External authority",
        core: [
          "External authority governs compliance; internal authority governs coherence with values and conscience.",
          "Power transfer happens subtly through approval seeking, fear of exclusion, and defaulting to precedent.",
          "Sovereignty doesnât reject structure; it selects structures deliberately and revokes consent when misaligned."
        ]
      },
      {
        title: "Egoâs illusion of control",
        core: [
          "Ego confuses prediction with safety; sovereignty recognizes uncertainty and optimizes for clarity and adaptability.",
          "Control attempts increase friction and fragility; influence arises from congruence, calm, and credibility.",
          "Letting go isnât passivityâit reallocates energy from micromanagement to strategic choice."
        ]
      },
      {
        title: "Daily sovereignty habits",
        core: [
          "AM/PM âbookendsâ stabilize state: intention, regulation, and reflection compress variability in behavior.",
          "Identity stacks form via repeated signals (language, posture, environment) that cue sovereign action.",
          "Consistency compounds faster than intensity; low-friction habits outpace sporadic willpower."
        ]
      },
      {
        title: "Energy management basics",
        core: [
          "Attention is the primary currency; where it flows, identity grows.",
          "Boundaries conserve voltage; context switching taxes working memory and drains presence.",
          "Recovery (sleep, breath, stillness) is a strategic capacity investment, not a luxury."
        ]
      }
    ],
    questions: [
      "Where do I defer to others' opinions over my own knowing?",
      "Which recent decision came from fear of judgment?",
      "Where do I shrink to maintain harmony?",
      "What one decision restores my power this week?"
    ],
    actionStep: "Identify one area where you've given away power and reclaim it within 48 hours.",
    insight: "Master yourself first; the inner throne is the ultimate seat of power.",
    minutes: 18,
    badge: "New",
    quiz: {
      question: "Sovereign choice is primarily:",
      options: [
        "What others prefer",
        "Aligned with core values and inner wisdom",
        "Fastest option available",
        "The most popular path"
      ],
      correctIndex: 1
    }
  },
  {
    id: 2,
    title: "Boundaries & Energy Protection",
    subtitle: "Creating Safe Containers",
    concept: "Boundaries define where you end and others begin, preserving energy and integrity.",
    objectives: [
      "Map current boundary patterns",
      "Set clear, guilt-free limits",
      "Apply energy protection techniques",
      "Respond to boundary violations",
      "Create context-specific boundaries"
    ],
    lessons: [
      {
        title: "Rigid vs. porous vs. healthy",
        core: [
          "Rigid boundaries block connection and feedback; porous ones invite overload and resentment.",
          "Healthy boundaries are context-aware, explicit, and enforceable without hostility.",
          "Calibration shifts by relationship, risk, and capacity; maturity is the ability to re-set quickly."
        ]
      },
      {
        title: "Shielding, grounding, cleansing",
        core: [
          "Shielding (breath + intent) pre-allocates attention and reduces suggestibility.",
          "Grounding (posture, breath cadence, sensory anchors) stabilizes autonomic state.",
          "Cleansing practices reset after high-load interactions and prevent cumulative depletion."
        ]
      },
      {
        title: "Saying 'No' without apology",
        core: [
          "Direct refusals preserve clarity; justifications invite negotiation you may not want.",
          "Alternatives are optional, not owed; offering them is a strategic choice, not a duty.",
          "Silence after the boundary prevents backpedaling and reactivity."
        ]
      },
      {
        title: "Boundary communication scripts",
        core: [
          "Effective scripts state standard, request, and consequence in neutral language.",
          "Repetition is a feature, not a flaw; consistent enforcement builds predictability.",
          "Escalation should be procedural, not emotional; document when stakes are high."
        ]
      },
      {
        title: "Contextual boundaries",
        core: [
          "Different contexts (work, family, digital) require distinct access rules and response times.",
          "Time-boundaries (calendar blocks, reply windows) protect creative and recovery cycles.",
          "Visibility rules (read receipts, DND, channels) reduce ambient anxiety and interruptions."
        ]
      }
    ],
    questions: [
      "Where is my energy consistently drained?",
      "What boundary have I avoided setting?",
      "How do I react to violations?",
      "What shifts if I honor limits?"
    ],
    actionStep: "Communicate one needed boundary this week.",
    insight: "Boundaries are not walls; they are intelligent gates.",
    minutes: 20,
    badge: "Hot",
    quiz: {
      question: "A healthy boundary is best described as:",
      options: [
        "A rigid wall against everyone",
        "A flexible, conscious limit that protects energy",
        "Letting others decide access",
        "Avoiding conflict at all costs"
      ],
      correctIndex: 1
    }
  },
  {
    id: 3,
    title: "Authentic Decision Making",
    subtitle: "Listening to Inner Wisdom",
    concept: "Aligned choices emerge from values, body wisdom, and intuition.",
    objectives: [
      "Identify fear-based patterns",
      "Establish inner guidance rituals",
      "Decondition reactive habits",
      "Create values-based frameworks",
      "Act on intuitive signals"
    ],
    lessons: [
      {
        title: "Fear â Alignment spectrum",
        core: [
          "Decisions rarely binary; plot them by fear load vs. value congruence.",
          "Fear signals perceived risk, not objective truth; interrogate assumptions.",
          "Alignment prioritizes long-horizon integrity over short-term comfort."
        ]
      },
      {
        title: "Somatic 'Yes/No' signals",
        core: [
          "The body encodes pattern recognition as sensations (open/contracted, warm/cold, steady/agitated).",
          "Training interoception increases decision accuracy under uncertainty.",
          "Conflicts between body and narrative often reveal hidden motives or social pressure."
        ]
      },
      {
        title: "Values as filters",
        core: [
          "Pick a minimal set of values (3â5) to avoid decision fatigue and moral drift.",
          "Score options against values to expose trade-offs explicitly.",
          "If choices tie, prefer the one that expands optionality and capability."
        ]
      },
      {
        title: "Intuition strengthening",
        core: [
          "Intuition improves with clean data: rest, silence, and reduced cognitive clutter.",
          "Ask precise questions; vague prompts yield vague signals.",
          "Track intuitive hits to build calibrated trust without magical thinking."
        ]
      },
      {
        title: "Choosing amid uncertainty",
        core: [
          "Classify choices as reversible (optimize speed) vs. irreversible (optimize accuracy).",
          "Set decision deadlines to cap analysis paralysis.",
          "Act â observe â iterate: feedback converts uncertainty into knowledge."
        ]
      }
    ],
    questions: [
      "Which recent decision was fear-driven?",
      "How does my body signal a 'Yes'?",
      "Where am I out of value alignment?",
      "How can I build decision space?"
    ],
    actionStep: "Pause before decisions and check values + body cues.",
    insight: "Alignment beats approvalâevery time.",
    minutes: 16
  },
  {
    id: 4,
    title: "Sovereign Communication",
    subtitle: "Expressing Truth with Power",
    concept: "Clarity + compassion + convictionâwithout attachment to outcome.",
    objectives: [
      "Express needs clearly",
      "Listen actively and presently",
      "Navigate conflict in center",
      "Release blame and defense",
      "Transform disempowering language"
    ],
    lessons: [
      {
        title: "NVC basics",
        core: [
          "Observe without evaluation; feelings name internal states, not accusations.",
          "Needs reveal universals (safety, respect, autonomy) beneath surface demands.",
          "Requests are specific, actionable, and allow a genuine ânoâ."
        ]
      },
      {
        title: "Presence in dialogue",
        core: [
          "Regulated breathing and pacing broadcast safety and reduce defensiveness.",
          "Mirroring and summarizing demonstrate comprehension and reduce misinterpretation.",
          "Silence is a tool; latency gives space for de-escalation and clarity."
        ]
      },
      {
        title: "Difficult truths with care",
        core: [
          "Lead with context and impact; critique behavior, not identity.",
          "Focus on standards and agreements rather than moral superiority.",
          "Offer a forward path: options, timelines, and checkpoints."
        ]
      },
      {
        title: "Conflict alchemy",
        core: [
          "Define the shared objective to transform zero-sum into co-problem-solving.",
          "Shrink claims to verifiable facts; banish mind-reading and absolutes.",
          "Use time-outs and resets to preserve relationship while solving the issue."
        ]
      },
      {
        title: "Power language swaps",
        core: [
          "Replace victim language (âhave toâ, âthey made meâ) with agency (âI chooseâ, âI wonâtâ).",
          "Shift from âshouldâ to value-aligned commitments (âBecause I value X, I will Yâ).",
          "Name limits without shame; constraints clarify priorities."
        ]
      }
    ],
    questions: [
      "Where do I hold back truth?",
      "Which patterns diminish me?",
      "How can I be clear and kind?",
      "When do I choose harmony over truth?"
    ],
    actionStep: "Speak one avoided truth this week.",
    insight: "Responsibility for deliveryânot reactionâkeeps you sovereign.",
    minutes: 15
  },
  {
    id: 5,
    title: "Financial Sovereignty",
    subtitle: "Wealth as Energy Exchange",
    concept: "Shift from scarcity to stewardship; build systems that serve freedom.",
    objectives: [
      "Audit money beliefs",
      "Align income with purpose",
      "Spend by values",
      "View money as flow",
      "Design liberating systems"
    ],
    lessons: [
      {
        title: "Beliefs inventory",
        core: [
          "Money behavior mirrors narratives absorbed in childhood, culture, and peers.",
          "Updating beliefs requires counter-evidence and new identity anchors, not slogans.",
          "Track reactions to earning, asking, and receiving to surface hidden scripts."
        ]
      },
      {
        title: "Conscious earning",
        core: [
          "Wealth grows where valuable problems are solved repeatedly with leverage.",
          "Positioning (niche, outcomes, proof) beats raw effort for pricing power.",
          "Ethical pricing respects scope, risk, and transformation delivered."
        ]
      },
      {
        title: "Value-based budgeting",
        core: [
          "Budgets allocate identity; unfunded values arenât real priorities.",
          "Fund buffers and asset building before discretionary consumption.",
          "Cutting noise purchases unlocks capital for skills and freedom."
        ]
      },
      {
        title: "Flow vs. storage",
        core: [
          "Hoarding is fear; intelligent flow cycles through buffers, investments, and generosity.",
          "Liquidity cushions (1â3 months) prevent panic decisions under stress.",
          "Compounding requires time in the market and protection from catastrophic loss."
        ]
      },
      {
        title: "Automation & buffers",
        core: [
          "Automated transfers beat willpower and reduce decision friction.",
          "Periodic reviews (weekly/monthly) correct drift and surface waste.",
          "Separate operating, buffer, and growth accounts to clarify purpose."
        ]
      }
    ],
    questions: [
      "What beliefs did I inherit?",
      "Does my money map reflect values?",
      "If money is energy, what changes?",
      "What system supports freedom?"
    ],
    actionStep: "Make one value-aligned financial shift.",
    insight: "Sovereignty is your relationship with flow, not a number.",
    minutes: 22
  },
  {
    id: 6,
    title: "Sovereign Relationships",
    subtitle: "Connecting Without Losing Self",
    concept: "Intimacy with autonomy; presence without enmeshment.",
    objectives: [
      "Spot diminishing patterns",
      "Maintain self-connection",
      "Build mutual respect",
      "Balance closeness/space",
      "Ask clearly for needs"
    ],
    lessons: [
      {
        title: "Attachment patterns",
        core: [
          "Anxious/avoidant/secure describe regulation strategies, not fixed identities.",
          "Awareness reduces projection; partners co-create security via predictability.",
          "Under stress, styles intensify; plans for repair matter more than perfection."
        ]
      },
      {
        title: "The autonomy-intimacy dance",
        core: [
          "Self-connection is a prerequisite for healthy connection; enmeshment erodes desire.",
          "Space and novelty restore polarity; routine without intention dulls attraction.",
          "Explicit agreements prevent silent score-keeping and resentment."
        ]
      },
      {
        title: "Conscious relating",
        core: [
          "Rituals of check-in and appreciation compound trust.",
          "Assumptions decay clarity; ask, donât mind-read.",
          "Transparency about capacity prevents over-promising and burnout."
        ]
      },
      {
        title: "Repair rituals",
        core: [
          "Effective repair names impact, owns contribution, and sets prevention steps.",
          "Timing matters: regulate before resolution to avoid re-injury.",
          "Closure includes acknowledgment and a concrete next step."
        ]
      },
      {
        title: "Empowered partnership",
        core: [
          "Shared vision orients choices under pressure; money and roles follow the mission.",
          "Role fluidity allows comparative advantage without ego collapse.",
          "Regular reviews keep expectations current and resentment low."
        ]
      }
    ],
    questions: [
      "Where do I self-abandon?",
      "Which past patterns repeat?",
      "How do I bring presence?",
      "Vision of a sovereign bond?"
    ],
    actionStep: "Practice a self-check mid-conversation.",
    insight: "Choose from fullness, not emptiness.",
    minutes: 17
  },
  {
    id: 7,
    title: "Living as Sovereign Being",
    subtitle: "Integration & Mastery",
    concept: "Make sovereignty your default operating system.",
    objectives: [
      "Daily ritualization",
      "Resilience under stress",
      "Environmental design",
      "Aligned default state",
      "Intentional creation"
    ],
    lessons: [
      {
        title: "AM/PM sovereignty stacks",
        core: [
          "Morning primes direction; evening consolidates learning and resets load.",
          "Minimal viable stacks beat aspirational routines that collapse under stress.",
          "Stack triggers (objects, locations, alarms) create reliable execution."
        ]
      },
      {
        title: "Nervous system mastery",
        core: [
          "State determines strategy quality; dysregulation shrinks perspective and options.",
          "Breath, temperature, movement, and sound are fast levers for state change.",
          "Track your quickest down-regulators and standardize them before high-stakes tasks."
        ]
      },
      {
        title: "Space as ally",
        core: [
          "Environment design (visibility, friction, symbolism) silently directs behavior.",
          "Remove cues for unwanted habits; surface cues for desired ones.",
          "Altars or anchors keep values salient in daily flow."
        ]
      },
      {
        title: "Identity shift",
        core: [
          "Identity precedes behavior: âI am the kind of person whoâ¦â guides micro-choices.",
          "Evidence accumulation (reps) makes identity believable to the nervous system.",
          "Language updates (âI donâtâ vs. âI canâtâ) harden boundaries."
        ]
      },
      {
        title: "From reaction to creation",
        core: [
          "Calendar your values; otherwise urgent crowds out important.",
          "Weekly reviews convert drift into course correction.",
          "Creation sessions build artifacts that compound (assets, skills, relationships)."
        ]
      }
    ],
    questions: [
      "Which ritual returns me fastest?",
      "How do I re-center quickly?",
      "What in my space helps/hurts?",
      "What does default alignment feel like?"
    ],
    actionStep: "Install one daily ritual for 30 days.",
    insight: "Sovereignty is a way of traveling, not a destination.",
    minutes: 18
  },

  /* Expansion 8â14: lawful/structural sovereignty themes */
  {
    id: 8,
    title: "Lawful Foundations",
    subtitle: "Rights, Duties, Jurisdiction",
    concept: "Know the difference between legal fictions and living beings; orient to rights/duties.",
    objectives: [
      "Understand rights vs. privileges",
      "Recognize jurisdictions",
      "Document identity clearly",
      "Communicate lawfully",
      "Keep records organized"
    ],
    lessons: [
      {
        title: "Natural vs. statutory",
        core: [
          "Natural rights exist by virtue of personhood; statutes confer limited privileges within a forum.",
          "Confusion arises when privileges are treated as rights; remedies differ accordingly.",
          "Competence is knowing which framework governs a given interaction."
        ]
      },
      {
        title: "Jurisdiction basics",
        core: [
          "Subject-matter, personal, and territorial jurisdiction must all be satisfied for authority to attach.",
          "Consent can be explicit or implied by conduct; silence in regulated contexts may equal consent.",
          "Questions clarify scope: âWhat is the subject-matter authority? Whatâs the venue? What grants standing?â"
        ]
      },
      {
        title: "Identity statements",
        core: [
          "Consistent declarations (name, capacity, domicile) avoid contradictions that weaken standing.",
          "Avoid unnecessary claims; extra assertions create attack surfaces.",
          "Plain, neutral language outruns complicated theories in real processes."
        ]
      },
      {
        title: "Notice & opportunity to cure",
        core: [
          "Due process principles: give clear statement of issue, remedy sought, and timeframe.",
          "Documentation (dates, delivery proofs) protects your position and supports escalation if needed.",
          "Cure windows are strategic: firm enough for progress, fair enough for legitimacy."
        ]
      },
      {
        title: "Record-keeping",
        core: [
          "Indexes, versioning, and consistent naming prevent self-inflicted losses in complex matters.",
          "Service logs and receipt archives often decide outcomes more than arguments do.",
          "Redundant backups (cloud, local, offline) safeguard critical history."
        ]
      }
    ],
    questions: [
      "What right do I underuse?",
      "Which jurisdiction applies where?",
      "What documents define me?",
      "Where can I simplify records?"
    ],
    actionStep: "Draft your one-paragraph rights statement.",
    insight: "Clarity cuts through confusion.",
    minutes: 19,
    badge: "New"
  },
  {
    id: 9,
    title: "Status Correction Essentials",
    subtitle: "Identity, Notice, Standing",
    concept: "Clarify status through clean declarations and consistent conduct.",
    objectives: [
      "Map current status footprint",
      "Draft simple declarations",
      "Use notices with timelines",
      "Maintain consistency",
      "Avoid contradictory behavior"
    ],
    lessons: [
      {
        title: "Declarations vs. affidavits",
        core: [
          "Declarations assert positions; affidavits attest to facts under oathâuse each appropriately.",
          "Factual minimalism increases credibility; argument belongs in briefs, not affidavits.",
          "Consistency across documents and conduct preserves standing."
        ]
      },
      {
        title: "Notices & responses",
        core: [
          "Sequencing matters: initial notice â reminder â default/closure.",
          "Each step states action requested, basis, and deadline; track meticulously.",
          "Silence after proper notice can have consequencesâknow the forumâs rules."
        ]
      },
      {
        title: "Consistency is king",
        core: [
          "Mismatched addresses, names, or capacities create doubt and delay.",
          "Update records promptly when life changes to prevent estoppel later.",
          "Public claims demand private alignmentâbehavior proves status."
        ]
      },
      {
        title: "Avoid estoppel traps",
        core: [
          "Signing without reservation or failing to object can concede positions unintentionally.",
          "Read entire instruments; strike or initial changes to prevent implied consent.",
          "Keep copies of objections and reservations with dates."
        ]
      },
      {
        title: "Documentation flow",
        core: [
          "Define a lifecycle: draft â review â execute â serve â record â archive.",
          "Version control (v1.0, v1.1) and change logs prevent confusion.",
          "Close loops: acknowledge receipt, note deadlines, log outcomes."
        ]
      }
    ],
    questions: [
      "Where is my status unclear?",
      "Which declaration matters most now?",
      "What timelines will I honor?",
      "How do I remove contradictions?"
    ],
    actionStep: "Write a one-page status summary.",
    insight: "Status speaks loudest through behavior.",
    minutes: 21
  },
  {
    id: 10,
    title: "Affidavits & Notices",
    subtitle: "Truth in the Record",
    concept: "Affidavits are sworn truth; notices establish process and opportunity to cure.",
    objectives: [
      "Structure a clean affidavit",
      "Cite facts, not fluff",
      "Serve notices properly",
      "Track responses",
      "Close the loop"
    ],
    lessons: [
      {
        title: "Elements of affidavit",
        core: [
          "Establish competency and capacity; list numbered, specific facts personally known.",
          "Attach exhibits and reference them within statements.",
          "Complete jurat (oath, date, notary) to authenticate."
        ]
      },
      {
        title: "Exhibits & evidence",
        core: [
          "Label exhibits clearly (A, B, C) and ensure legibility and provenance.",
          "Chain of custody and metadata strengthen evidentiary weight.",
          "Use summaries to guide readers through complex bundles."
        ]
      },
      {
        title: "Service methods",
        core: [
          "Choose trackable delivery (certified mail, process server) per forum norms.",
          "Correct names/addresses and service to the proper agent prevent dismissal.",
          "Keep receipts, tracking numbers, and affidavits of service."
        ]
      },
      {
        title: "Default/cure windows",
        core: [
          "State explicit deadlines and outcomes upon non-performance.",
          "Offer reasonable cure steps to show good faith and reduce conflict.",
          "Document follow-ups and closures to build a clean record."
        ]
      },
      {
        title: "Proof of service log",
        core: [
          "Chronologies (date, time, method, recipient) often carry more weight than rhetoric.",
          "Centralize logs to avoid omissions across multiple matters.",
          "Backups and redundancy ensure continuity if devices fail."
        ]
      }
    ],
    questions: [
      "What fact pattern needs affidavit?",
      "What evidence supports it?",
      "Which notice sequence fits?",
      "How do I log service cleanly?"
    ],
    actionStep: "Draft a 3-point factual affidavit outline.",
    insight: "Truth + process = power.",
    minutes: 20,
    quiz: {
      question: "The strongest affidavit focuses on:",
      options: ["Opinions", "Hearsay", "Verifiable facts with exhibits", "Emotions"],
      correctIndex: 2
    }
  },
  {
    id: 11,
    title: "Trusts & PMA",
    subtitle: "Private Structures",
    concept: "Use trusts and PMAs to structure stewardship and community in private capacity.",
    objectives: [
      "Define purpose of trust/PMA",
      "Clarify roles & duties",
      "Draft simple bylaws",
      "Separate private/public",
      "Maintain minutes & records"
    ],
    lessons: [
      {
        title: "Declarations of trust",
        core: [
          "A clear purpose clause governs trustee discretion and prevents mission drift.",
          "Identify parties (settlor, trustee, beneficiary) and initial corpus precisely.",
          "Keep instruments legible and minimal; complexity invites errors."
        ]
      },
      {
        title: "Trustee obligations",
        core: [
          "Duties of loyalty and care require minutes, segregation of assets, and avoidance of conflicts.",
          "Resolutions authorize actions; signatures must reflect capacity and title.",
          "Transparency with beneficiaries builds legitimacy and reduces disputes."
        ]
      },
      {
        title: "PMA membership terms",
        core: [
          "Define scope, conduct standards, admission, and termination in private capacity.",
          "Internal remedies and private venues reduce public exposure.",
          "Document consent to terms and data handling clearly."
        ]
      },
      {
        title: "Banking & signatures",
        core: [
          "Open accounts in proper capacity; commingling pierces structure integrity.",
          "Signature blocks must show office/role to prevent personal liability.",
          "Adopt resolutions for signers, transactions, and third-party dealings."
        ]
      },
      {
        title: "Governance basics",
        core: [
          "Bylaws should be short, reviewable, and enforced consistently.",
          "Define quorums, notice periods, and voting thresholds to avoid stalemates.",
          "Annual reviews and audits maintain trust health."
        ]
      }
    ],
    questions: [
      "What is this structure for?",
      "Who holds what duty?",
      "What bylaws are essential?",
      "What minutes will we keep?"
    ],
    actionStep: "Write a purpose clause for your trust/PMA.",
    insight: "Clear purpose attracts aligned people.",
    minutes: 23
  },
  {
    id: 12,
    title: "Right to Travel (Education)",
    subtitle: "Safety, Notice, Documentation",
    concept: "Prepare documentation, safety protocols, and communication scripts for travel.",
    objectives: [
      "Assemble ID packet",
      "Craft calm scripts",
      "Know escalation steps",
      "Record interactions",
      "Debrief & document"
    ],
    lessons: [
      {
        title: "Packet checklist",
        core: [
          "Maintain identification, relevant declarations, insurance, and emergency info in both print and digital forms.",
          "Organize for quick retrieval to reduce roadside delay and confusion.",
          "Periodically verify that documents are current and legible."
        ]
      },
      {
        title: "De-escalation language",
        core: [
          "Calm tone, slow cadence, and concise statements reduce perceived threat.",
          "Ask clarifying questions respectfully to determine scope and next steps.",
          "Avoid argumentative or speculative commentary that increases risk."
        ]
      },
      {
        title: "When to remain silent",
        core: [
          "Invoking silence prevents self-incrimination; know exact wording for your jurisdiction.",
          "Ask whether you are being detained and under what basis.",
          "Request counsel when appropriate and avoid volunteering narratives."
        ]
      },
      {
        title: "Recording laws overview",
        core: [
          "Know whether your state requires one-party or all-party consent for recordings.",
          "Keep devices visible and stable; announce recording when prudent.",
          "Back up recordings promptly to immutable storage."
        ]
      },
      {
        title: "After-action notes",
        core: [
          "Capture times, locations, names, statements, and any identifiers immediately post-interaction.",
          "Attach photos, receipts, and reference numbers; consistency beats memory.",
          "Follow with notice or complaint only when supported by clear facts."
        ]
      }
    ],
    questions: [
      "What goes in my packet?",
      "Whatâs my calm opener?",
      "When do I stop talking?",
      "How will I log the event?"
    ],
    actionStep: "Assemble your travel packet this week.",
    insight: "Preparation turns pressure into poise.",
    minutes: 18
  },
  {
    id: 13,
    title: "Commercial Remedies (Education)",
    subtitle: "Invoices, Liens, Cures (Informational)",
    concept: "Understand remedy pathways conceptually; proceed lawfully and prudently.",
    objectives: [
      "Map remedy ladder",
      "Use notices before claims",
      "Track timelines",
      "Avoid frivolous filings",
      "Seek counsel where needed"
    ],
    lessons: [
      {
        title: "Offerâacceptanceâperformance",
        core: [
          "Contracts govern most exchanges; terms, consideration, and performance define rights and duties.",
          "Implied contracts can arise by conduct; document your terms early to avoid disputes.",
          "Remedies often hinge on proving performance and notice, not rhetoric."
        ]
      },
      {
        title: "Noticeâfaultâcure",
        core: [
          "Neutral notices establish facts and expectations without unnecessary accusations.",
          "Cure periods demonstrate good faith and improve outcomes without litigation.",
          "Escalation should be procedural, referencing prior notices and evidence."
        ]
      },
      {
        title: "Evidence packages",
        core: [
          "Chronologies and tables of contents help third parties digest complex matters.",
          "Include contracts, communications, receipts, and photos with clear labeling.",
          "Summaries highlight key facts and requested remedies succinctly."
        ]
      },
      {
        title: "Risk & prudence",
        core: [
          "Frivolous or unenforceable filings can incur penalties; know elements before asserting claims.",
          "Remedy selection should match harm, forum, and facts; avoid overreach.",
          "When uncertain, pause for education or professional review."
        ]
      },
      {
        title: "Professional review",
        core: [
          "Aligned counsel saves time and reduces errors in high-stakes contexts.",
          "Prepare concise briefs for advisors: facts, timeline, documents, and desired outcomes.",
          "Record advice and decisions to maintain a clean file."
        ]
      }
    ],
    questions: [
      "What is the remedy goal?",
      "Which evidence is strong?",
      "What timeline is fair?",
      "Where do I need counsel?"
    ],
    actionStep: "Draft a neutral remedy map (one page).",
    insight: "Right remedy + right time = leverage.",
    minutes: 24
  },
  {
    id: 14,
    title: "Record & Publish",
    subtitle: "Make it Real in the World",
    concept: "Whatâs not recorded is easily forgotten; publish your truth with clarity.",
    objectives: [
      "Choose record venues",
      "Organize repositories",
      "Use consistent formats",
      "Version & timestamp docs",
      "Back up redundantly"
    ],
    lessons: [
      {
        title: "Clerk, notary, private record",
        core: [
          "Public recording timestamps existence; notarization verifies identity and signature.",
          "Private registries add redundancy but donât replace public evidencing where required.",
          "Choose venues based on purpose: notice, authenticity, or archival."
        ]
      },
      {
        title: "Digital repositories",
        core: [
          "Design top-level folders by domain and year for rapid retrieval.",
          "Control access and maintain audit trails for sensitive materials.",
          "Use interoperable formats (PDF/A, CSV) to reduce future lock-in."
        ]
      },
      {
        title: "Consistent templates",
        core: [
          "Standard headers, numbered paragraphs, and exhibit blocks reduce drafting errors.",
          "Identity blocks (name, capacity, contact) ensure traceability.",
          "Template discipline accelerates production under pressure."
        ]
      },
      {
        title: "Versioning discipline",
        core: [
          "Semantic versions (v1.0 major, v1.1 minor) + change logs clarify evolution.",
          "Archive superseded versions; never overwrite finals.",
          "Timestamping and hashing add integrity in digital chains."
        ]
      },
      {
        title: "Cold backups",
        core: [
          "Keep offline copies of critical documents to mitigate cyber and cloud failures.",
          "Test restore procedures; untested backups are assumptions, not protection.",
          "Store redundantly in separate physical locations."
        ]
      }
    ],
    questions: [
      "Where will I record?",
      "How do I organize?",
      "What template baseline?",
      "Where are my backups?"
    ],
    actionStep: "Create your recording checklist.",
    insight: "Records are the spine of sovereignty.",
    minutes: 16,
    badge: "Hot"
  }
];

/* ================== DOM REFS ================== */
const connectSection   = document.getElementById('connectSection');
const moduleContent    = document.getElementById('moduleContent');
const courseList       = document.getElementById('courseList');
const userAvatar       = document.getElementById('userAvatar');
const walletAddressEl  = document.getElementById('walletAddress');
const disconnectBtn    = document.getElementById('disconnectBtn');
const connectWalletBtn = document.getElementById('connectWalletBtn');
const progressPercentage = document.getElementById('progressPercentage');
const progressFill       = document.getElementById('progressFill');
const prevModuleBtn    = document.getElementById('prevModuleBtn');
const nextModuleBtn    = document.getElementById('nextModuleBtn');
const openModalBtn     = document.getElementById('openModal');
const modalOverlay     = document.getElementById('modalOverlay');
const modalClose       = document.getElementById('modalClose');
const miniMeta         = document.getElementById('miniMeta');

/* ================== STORAGE ================== */
function loadProgress(address = userAddress) { try { const raw = localStorage.getItem(STORAGE_KEY(address)); userProgress = raw ? JSON.parse(raw) : {}; } catch { userProgress = {}; } }
function saveProgress(address = userAddress) { localStorage.setItem(STORAGE_KEY(address), JSON.stringify(userProgress)); updateProgressUI(); }

/* ================== UI / CONTENT ================== */
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  if (!particlesContainer) return;
  const particleCount = 30;
  for (let i = 0; i < particleCount; i++) {
    const p = document.createElement('div');
    p.classList.add('particle');
    const size = Math.random() * 10 + 2;
    const posX = Math.random() * 100;
    const posY = Math.random() * 100;
    const animationDuration = Math.random() * 20 + 10;
    const animationDelay = Math.random() * 5;
    const opacity = Math.random() * 0.3 + 0.1;
    const colors = ['var(--primary)','var(--secondary)','var(--accent)','var(--primary-light)','var(--accent-light)'];
    Object.assign(p.style, { width:`${size}px`, height:`${size}px`, left:`${posX}%`, top:`${posY}%`, animationDuration:`${animationDuration}s`, animationDelay:`${animationDelay}s`, opacity });
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    particlesContainer.appendChild(p);
  }
}

  const particlesContainer = document.getElementById('particles');
  const particleCount = 30;
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    const size = Math.random() * 10 + 2;
    const posX = Math.random() * 100;
    const posY = Math.random() * 100;
    const animationDuration = Math.random() * 20 + 10;
    const animationDelay = Math.random() * 5;
    const opacity = Math.random() * 0.3 + 0.1;

    const colors = [
      'var(--primary)', 'var(--secondary)', 'var(--accent)',
      'var(--primary-light)', 'var(--accent-light)'
    ];
    Object.assign(particle.style, {
      width: `${size}px`, height: `${size}px`,
      left: `${posX}%`, top: `${posY}%`,
      animationDuration: `${animationDuration}s`,
      animationDelay: `${animationDelay}s`,
      opacity, background: `var(--accent)`
    });
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
    particlesContainer.appendChild(particle);
  }
}

function renderCourseMenu() {
  const icons = {
    1: 'fa-bullseye', 2: 'fa-shield-halved', 3: 'fa-compass', 4: 'fa-comments',
    5: 'fa-coins', 6: 'fa-heart', 7: 'fa-crown', 8: 'fa-scale-balanced',
    9: 'fa-id-card', 10: 'fa-file-circle-check', 11: 'fa-people-group',
    12: 'fa-car-side', 13: 'fa-briefcase', 14: 'fa-scroll'
  };

  courseList.innerHTML = '';
  courseModules.forEach(module => {
    const menuItem = document.createElement('button');
    menuItem.type = 'button';
    menuItem.classList.add('menu-item');
    menuItem.setAttribute('data-module-id', String(module.id));
    if (module.id === currentModule) menuItem.classList.add('active');

    const icon = icons[module.id] || 'fa-book';
    const timeBadge = module.minutes ? `<span class="menu-badge" aria-label="Estimated minutes">${module.minutes}m</span>` : '';
    const hotBadge  = module.badge ? `<div class="menu-badge" aria-label="Badge">${module.badge}</div>` : '';

    menuItem.innerHTML = `
      <div class="menu-icon" aria-hidden="true"><i class="fas ${icon}"></i></div>
      <div class="menu-text">${module.title} ${timeBadge}</div>
      ${hotBadge}
    `;
    menuItem.addEventListener('click', () => {
      currentModule = module.id;
      updateUI();
    });
    courseList.appendChild(menuItem);
  });
}

function safeList(items) {
  return Array.isArray(items) ? items : [];
}

function renderChecklist(mod) {
  const container = document.getElementById('moduleChecklist');
  const defaults = safeList(courseModules.find(m=>m.id===mod)?.objectives).slice(0,4);
  const saved = JSON.parse(localStorage.getItem(CHECK_KEY(userAddress,mod))||'{}');
  container.innerHTML = defaults.map((label,idx)=>{
    const checked = saved[idx] ? 'checked' : '';
    return `<label class="check-item"><input type="checkbox" data-idx="${idx}" ${checked} aria-checked="${checked ? 'true':'false'}"/> ${label}</label>`;
  }).join('') || '<p style="opacity:.8">No checklist items for this module.</p>';
  container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const s = JSON.parse(localStorage.getItem(CHECK_KEY(userAddress,mod))||'{}');
      s[cb.dataset.idx] = cb.checked;
      cb.setAttribute('aria-checked', cb.checked ? 'true':'false');
      localStorage.setItem(CHECK_KEY(userAddress,mod), JSON.stringify(s));
    });
  });
}

function loadNotes(mod){
  const ta = document.getElementById('moduleNotes');
  ta.value = localStorage.getItem(NOTES_KEY(userAddress,mod))||'';
  ta.oninput = ()=>localStorage.setItem(NOTES_KEY(userAddress,mod), ta.value);
}

function setActiveMenuItem() {
  document.querySelectorAll('.menu-item').forEach(item => {
    const id = Number(item.getAttribute('data-module-id'));
    if (id === currentModule) item.classList.add('active'); else item.classList.remove('active');
  });
}

function updateUI() {
  const module = courseModules.find(m => m.id === currentModule);
  if (!module) return;

  document.getElementById('moduleNumber').textContent = module.id;
  document.getElementById('moduleTitle').textContent  = module.title;
  document.getElementById('moduleConcept').textContent = module.concept;

  const objectivesList = document.getElementById('moduleObjectives');
  objectivesList.innerHTML = safeList(module.objectives).map(obj => `<li>${obj}</li>`).join('') || '<li>No objectives listed.</li>';

  const lessonsList = document.getElementById('moduleLessons');
  lessonsList.innerHTML = safeList(module.lessons).map(l => {
  if (typeof l === 'string') return `<li>${l}</li>`;
  const core = Array.isArray(l.core) && l.core.length ? `<ul>${l.core.map(p=>`<li>${p}</li>`).join('')}</ul>` : '';
  return `<li><strong>${l.title||''}</strong>${core}</li>`;
}).join('') || '<li>No lessons listed.</li>';

  const questionsList = document.getElementById('practiceQuestions');
  questionsList.innerHTML = safeList(module.questions).map(q => `<li>${q}</li>`).join('') || '<li>No questions for this module.</li>';

  document.getElementById('actionStep').textContent     = module.actionStep || 'â';
  document.getElementById('sovereignInsight').textContent = module.insight || 'â';

  prevModuleBtn.disabled = currentModule === 1;
  nextModuleBtn.disabled = currentModule === courseModules.length;
  document.getElementById('mPrev').disabled = prevModuleBtn.disabled;
  document.getElementById('mNext').disabled = nextModuleBtn.disabled;

  renderChecklist(currentModule);
  loadNotes(currentModule);
  renderAchievements();

  // Mini meta (estimated minutes)
  miniMeta.textContent = module.minutes ? `~${module.minutes} min` : '';

  updateProgressUI();
  setActiveMenuItem();

  // Deep-link reflect
  history.replaceState(null,'',`#module=${currentModule}`);

  // Remember last module for this wallet/guest
  localStorage.setItem(LAST_MODULE_KEY(userAddress||'guest'), String(currentModule));
}

function navigateModule(direction) {
  const newModule = currentModule + direction;
  if (newModule >= 1 && newModule <= courseModules.length) {
    currentModule = newModule;
    updateUI();
  }
}

function updateProgressUI() {
  const totalModules = courseModules.length;
  const completedModules = Object.values(userProgress).filter(s => s === 'completed').length;
  const progress = Math.round((completedModules / totalModules) * 100);
  progressPercentage.textContent = `${progress}%`;
  progressFill.style.width = `${progress}%`;
  document.querySelector('.progress-bar')?.setAttribute('aria-valuenow', String(progress));
  if (completedModules === totalModules) {
    showCertificateCTA(); // reveal certificate section
  }
}

/* ================== MODAL (with focus trap + keyboard) ================== */
let lastFocusedBeforeModal = null;
function setupModal() {
  openModalBtn.addEventListener('click', openModal);
  modalClose.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  document.addEventListener('keydown', (e)=>{
    if (!modalOverlay.classList.contains('active')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'Tab') trapFocus(e);
  });
}

function focusableElements(container=document) {
  return Array.from(container.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])'))
    .filter(el=>!el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
}

function trapFocus(e){
  const focusables = focusableElements(modalOverlay);
  if (focusables.length===0) return;
  const first = focusables[0];
  const last  = focusables[focusables.length-1];
  if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
  else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
}

function openModal() {
  document.getElementById('openModal')?.setAttribute('aria-expanded','true');
  const module = courseModules.find(m => m.id === currentModule);
  if (!module) return;

  document.getElementById('modalModuleNumber').textContent = module.id;
  document.getElementById('modalModuleTitle').textContent  = module.title;
  document.getElementById('modalModuleSubtitle').textContent = module.subtitle;

  const modalContent = document.getElementById('modalModuleContent');
  modalContent.innerHTML = `
    <div class="modal-section">
      <h3><i class="fas fa-bullseye" aria-hidden="true"></i> Core Concept</h3>
      <p>${module.concept}</p>
    </div>
    <div class="modal-section">
      <h3><i class="fas fa-tasks" aria-hidden="true"></i> Learning Objectives</h3>
      <ul>${safeList(module.objectives).map(o => `<li>${o}</li>`).join('')}</ul>
    </div>
    <div class="modal-section">
      <h3><i class="fas fa-book-open" aria-hidden="true"></i> Key Lessons</h3>
<ul>${safeList(module.lessons).map(l => {
  if (typeof l === "string") return `<li>${l}</li>`;
  const core = Array.isArray(l.core) && l.core.length ? `<ul>${l.core.map(p=>`<li>${p}</li>`).join("")}</ul>` : "";
  return `<li><strong>${l.title||""}</strong>${core}</li>`;
}).join("")}</ul>
    </div>
    <div class="practice-box">
      <div class="practice-title"><i class="fas fa-pen-fancy" aria-hidden="true"></i> Sovereignty Practice</div>
      <p><strong>Reflection Questions:</strong></p>
      <ul>${safeList(module.questions).map(q => `<li>${q}</li>`).join('')}</ul>
      <p><strong>Action Step:</strong> ${module.actionStep || 'â'}</p>
    </div>
    <div class="callout">
      <i class="fas fa-lightbulb callout-icon" aria-hidden="true"></i>
      <div class="callout-title">Sovereign Insight</div>
      <p>${module.insight || 'â'}</p>
    </div>
  `;

  const status = userProgress[currentModule] || 'not-started';
  const statusIndicator = document.getElementById('modalStatusIndicator');
  const statusText = document.getElementById('modalStatusText');

  statusIndicator.className = 'status-indicator';
  if (status === 'completed') {
    statusIndicator.classList.add('completed');
    statusText.textContent = 'Completed';
  } else if (status === 'in-progress') {
    statusIndicator.classList.add('in-progress');
    statusText.textContent = 'In Progress';
  } else {
    statusText.textContent = 'Not Started';
  }

  renderQuiz(); // load quiz if present

  lastFocusedBeforeModal = document.activeElement;
  modalOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  // focus first actionable
  setTimeout(()=>{
    const first = focusableElements(modalOverlay)[0];
    first?.focus();
  }, 0);
}

function closeModal() {
  document.getElementById('openModal')?.setAttribute('aria-expanded','false');
  modalOverlay.classList.remove('active');
  document.body.style.overflow = 'auto';
  lastFocusedBeforeModal?.focus();
}

/* ================== QUIZ ================== */
function renderQuiz() {
  const mod = courseModules.find(m=>m.id===currentModule);
  const row = document.getElementById('quizRow');
  if (!mod?.quiz){ row.innerHTML=''; wireDefaultComplete(); return; }
  const key = `quizAns:${(userAddress||'guest').toLowerCase()}:${currentModule}`;
  const saved = localStorage.getItem(key);
  row.innerHTML = `
    <div style="font-size:.9rem;max-width:360px;">
      <div style="margin-bottom:.4rem;"><strong>Quick Check:</strong> ${mod.quiz.question}</div>
      ${mod.quiz.options.map((opt,i)=>`
        <label style="display:block;margin:.2rem 0;">
          <input type="radio" name="q${currentModule}" value="${i}" ${saved==i?'checked':''}/> ${opt}
        </label>`).join('')}
    </div>`;
  row.querySelectorAll('input[type=radio]').forEach(r=>{
    r.addEventListener('change',()=>{ localStorage.setItem(key, r.value); });
  });

  // Gate completion to correct answer
  const completeBtn = document.getElementById('markCompleteBtn');
  completeBtn.onclick = () => {
    const chosen = Number(localStorage.getItem(key));
    if (Number.isFinite(chosen) && chosen===mod.quiz.correctIndex) {
      markModuleComplete();
    } else {
      showNotification('Select the best answer before completing.', 'warning');
    }
  };
}

// default completion when no quiz exists
function wireDefaultComplete() {
  const btn = document.getElementById('markCompleteBtn');
  btn.onclick = markModuleComplete;
}

function markModuleComplete() {
  userProgress[currentModule] = 'completed';
  saveProgress();
  renderAchievements();
  const statusIndicator = document.getElementById('modalStatusIndicator');
  const statusText = document.getElementById('modalStatusText');
  statusIndicator.className = 'status-indicator completed';
  statusText.textContent = 'Completed';

  const completed = Object.values(userProgress).filter(s => s === 'completed').length;
  if (completed === courseModules.length) {
    confetti?.({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    showNotification('Congratulations! You completed all modules!', 'success');
    showCertificateCTA();
    signCompletionProof().catch(()=>{});
  } else {
    showNotification('Module marked as complete', 'success');
  }
}

/* ================== STREAKS & ACHIEVEMENTS ================== */
function bumpStreak() {
  const key = STREAK_KEY(userAddress||'guest');
  const today = new Date().toDateString();
  const raw = JSON.parse(localStorage.getItem(key) || '{}'); // {last,tally}
  if (raw.last !== today) {
    const yesterday = new Date(Date.now()-86400000).toDateString();
    raw.tally = (raw.last === yesterday) ? (raw.tally||0)+1 : 1;
    raw.last = today;
    localStorage.setItem(key, JSON.stringify(raw));
  }
  document.getElementById('streakNum').textContent = `${(raw.tally||0)} day${(raw.tally||0)!==1?'s':''}`;
}

function renderAchievements() {
  const el = document.getElementById('achievementsRow');
  el.innerHTML = '';
  const completed = Object.values(userProgress).filter(x=>x==='completed').length;
  if (completed>=1) el.innerHTML += `<span class="ach-badge">First Steps</span>`;
  if (completed>=3) el.innerHTML += `<span class="ach-badge">Momentum</span>`;
  if (completed>=7) el.innerHTML += `<span class="ach-badge">Halfway</span>`;
  if (completed>=10) el.innerHTML += `<span class="ach-badge">Relentless</span>`;
  if (completed===courseModules.length) el.innerHTML += `<span class="ach-badge">Sovereign</span>`;
}

/* ================== CERTIFICATE ================== */
function showCertificateCTA(){
  document.getElementById('certificateSection').style.display = 'block';
  renderCertificate();
}
function renderCertificate(){
  const cv = document.getElementById('certCanvas');
  if (!cv) return;
  const ctx = cv.getContext('2d');
  // bg
  const g = ctx.createLinearGradient(0,0,1200,0);
  g.addColorStop(0, '#0A0A1E'); g.addColorStop(1, '#1b0f3a');
  ctx.fillStyle = g; ctx.fillRect(0,0,1200,675);
  // frame
  ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.lineWidth=6; ctx.strokeRect(24,24,1152,627);
  // title
  ctx.fillStyle='#ffffff'; ctx.font='bold 52px Space Grotesk';
  ctx.fillText('SOVEREIGNTY MASTERY', 100, 160);
  ctx.font='28px Kanit'; ctx.fillStyle='rgba(255,255,255,.85)';
  ctx.fillText('Certificate of Completion', 100, 210);
  // name/address
  const who = userAddress ? `${userAddress.slice(0,8)}â¦${userAddress.slice(-4)}` : 'Guest';
  ctx.font='bold 40px Kanit'; ctx.fillStyle='#6C4DF6';
  ctx.fillText(who, 100, 290);
  // date
  const date = new Date().toLocaleDateString();
  ctx.font='24px Kanit'; ctx.fillStyle='#ddd';
  ctx.fillText(`Completed on ${date}`, 100, 340);
  // seal
  ctx.globalAlpha=0.15; ctx.beginPath(); ctx.arc(1000,150,80,0,Math.PI*2); ctx.fillStyle='#00E0FF'; ctx.fill(); ctx.globalAlpha=1;
}
document.getElementById('downloadCertBtn')?.addEventListener('click',()=>{
  const url = document.getElementById('certCanvas').toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='sovereignty-certificate.png'; a.click();
});

/* Optional: local signature proof (no gas) */
async function signCompletionProof(){
  try{
    if (!signer || !userAddress) return;
    const msg = `Sovereignty Mastery completed by ${userAddress} on ${new Date().toISOString()}`;
    const signature = await signer.signMessage(msg);
    localStorage.setItem(`completionSig:${userAddress.toLowerCase()}`, JSON.stringify({msg,signature}));
    showNotification('Signed completion proof saved locally.', 'success');
  }catch(e){ showNotification('Signature declined.', 'warning'); }
}

/* ================== NOTIFICATIONS ================== */
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.classList.add('notification', type);

  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle',
    warning: 'fa-exclamation-triangle',
    info: 'fa-info-circle'
  };

  notification.innerHTML = `
    <i class="fas ${icons[type]} notification-icon" aria-hidden="true"></i>
    <div class="notification-content">
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" aria-label="Dismiss notification"><i class="fas fa-times" aria-hidden="true"></i></button>
  `;

  document.body.appendChild(notification);
  notification.querySelector('.notification-close').addEventListener('click', () => notification.remove());
  setTimeout(() => { if (notification.parentNode) notification.remove(); }, 5000);
}




/* ================== NOTIFICATIONS ================== */
function showNotification(message, type = 'info') {
  const n = document.createElement('div');
  n.classList.add('notification', type);
  const icons = { success:'fa-check-circle', error:'fa-exclamation-circle', warning:'fa-exclamation-triangle', info:'fa-info-circle' };
  n.innerHTML = `
    <i class="fas ${icons[type]} notification-icon" aria-hidden="true"></i>
    <div class="notification-content"><div class="notification-message">${message}</div></div>
    <button class="notification-close" aria-label="Dismiss notification"><i class="fas fa-times" aria-hidden="true"></i></button>`;
  document.body.appendChild(n);
  n.querySelector('.notification-close').addEventListener('click', () => n.remove());
  setTimeout(() => { if (n.parentNode) n.remove(); }, 5000);
}

/* ================== WALLET FLOW (FIXED) ================== */
async function connectWallet() {
  try {
    if (!web3Modal) web3Modal = setupWeb3Modal();

    if (web3Modal && typeof web3Modal.connect === 'function') {
      extProvider = await web3Modal.connect();
    } else if (window.ethereum?.request) {
      extProvider = window.ethereum;
      await extProvider.request({ method: 'eth_requestAccounts' });
    } else {
      throw new Error('No wallet provider found. Install MetaMask or use WalletConnect.');
    }

    provider = isEthersV6 ? new ethers.BrowserProvider(extProvider) : new ethers.providers.Web3Provider(extProvider, 'any');

    const net = await provider.getNetwork();
    const currentChainId = isEthersV6 ? Number(net.chainId) : net.chainId;
    if (currentChainId !== CHAIN_ID) {
      try {
        await extProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: toHexChainId(CHAIN_ID) }] });
      } catch {
        try {
          await extProvider.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: toHexChainId(CHAIN_ID), chainName: CHAIN_NAME, nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }, rpcUrls: [RPC_URL], blockExplorerUrls: ['https://bscscan.com'] }]
          });
        } catch {
          showNotification(`Please switch to ${CHAIN_NAME} in your wallet.`, 'warning');
          return;
        }
      }
    }

    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

    try { tokenDecimals = Number(await tokenContract.decimals()); tokenSymbol = String(await tokenContract.symbol()); } catch { tokenDecimals = 18; tokenSymbol = 'TOKEN'; }

    if (userAvatar)      userAvatar.textContent = userAddress.substring(2, 4).toUpperCase();
    if (walletAddressEl) walletAddressEl.textContent = `${userAddress.slice(0, 8)}...${userAddress.slice(-4)}`;
    if (disconnectBtn)   disconnectBtn.style.display = 'flex';

    loadProgress(userAddress);
    await checkAccess();

    try { extProvider.removeAllListeners?.(); } catch {}
    extProvider.on?.('accountsChanged', async (accounts) => {
      if (!accounts?.length) return disconnectWallet();
      userAddress = accounts[0];
      loadProgress(userAddress);
      await checkAccess();
    });
    extProvider.on?.('chainChanged', async () => {
      provider = isEthersV6 ? new ethers.BrowserProvider(extProvider) : new ethers.providers.Web3Provider(extProvider, 'any');
      tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);
      await checkAccess();
    });
    extProvider.on?.('disconnect', () => disconnectWallet());

  } catch (err) {
    console.error('[connectWallet] Error:', err);
    const cancelled = (err?.code === 4001) || /rejected/i.test(err?.message||'');
    showNotification(cancelled ? 'Connection cancelled.' : 'Connection failed.', 'error');
  }
}

async function checkAccess() {
  try {
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    const rawBal = await tokenContract.balanceOf(userAddress);
    const raw = (typeof rawBal === 'bigint') ? rawBal : (rawBal?._hex ? BigInt(rawBal._hex) : BigInt(rawBal.toString()));
    const human = Number(getFormatUnits()(raw, tokenDecimals));
    const pretty = (n)=> n.toLocaleString(undefined,{maximumFractionDigits:4});
    const need = Number(REQUIRED_TOKENS);

    if (human >= need) {
      connectSection && (connectSection.style.display = 'none');
      moduleContent  && (moduleContent.style.display  = 'block');
      showNotification(`Access granted Â· Balance: ${pretty(human)} ${tokenSymbol}`, 'success');

      const lastKey = LAST_MODULE_KEY(userAddress);
      const last = Number(localStorage.getItem(lastKey) || '1');
      if (location.hash.match(/module=(\d+)/i)) {
        applyHashModule?.();
      } else if (last >= 1 && last <= (window.courseModules?.length || 14)) {
        currentModule = last;
      }
      updateUI?.();

    } else {
      connectSection && (connectSection.style.display = 'block');
      moduleContent  && (moduleContent.style.display  = 'none');
      const deficit = Math.max(0, need - human);
      if (!document.getElementById('gateCtas') && connectSection) {
        const node = document.createElement('div');
        node.id = 'gateCtas';
        node.innerHTML = `
          <div class="connect-note">You have <strong>${pretty(human)} ${tokenSymbol}</strong>. Need <strong>${pretty(deficit)} ${tokenSymbol}</strong> more.</div>
          <div class="wallet-options" role="group" aria-label="More options">
            <a class="wallet-option" href="https://pancakeswap.finance" target="_blank" rel="noopener"><i class="fas fa-store wallet-icon" aria-hidden="true"></i><span>Buy ${tokenSymbol}</span></a>
            <a class="wallet-option" href="https://bridge.bnbchain.org" target="_blank" rel="noopener"><i class="fas fa-arrows-rotate wallet-icon" aria-hidden="true"></i><span>Bridge to BNB</span></a>
          </div>`;
        connectSection.appendChild(node);
      }
      showNotification(`Hold at least ${need} ${tokenSymbol} to unlock.`, 'warning');
    }
  } catch (e) {
    console.error('[checkAccess] Error:', e);
    showNotification('Could not read token balance. Check TOKEN_ADDRESS and network.', 'error');
  }
}

async function disconnectWallet() {
  try { if (extProvider?.disconnect && typeof extProvider.disconnect === 'function') await extProvider.disconnect(); } catch (err) { console.warn('Provider disconnect failed:', err); }
  try { if (web3Modal?.clearCachedProvider) await web3Modal.clearCachedProvider(); } catch (err) { console.warn('Clear cache failed:', err); }

  userAddress = null;
  provider = signer = tokenContract = null;

  if (userAvatar)      userAvatar.textContent = '?';
  if (walletAddressEl) walletAddressEl.textContent = 'Not connected';
  if (disconnectBtn)   disconnectBtn.style.display = 'none';
  if (connectSection)  connectSection.style.display = 'block';
  if (moduleContent)   moduleContent.style.display = 'none';

  showNotification('Wallet disconnected', 'info');
}

/* ================== HASH / DEEP LINK ================== */
function applyHashModule() {
  const match = location.hash.match(/module=(\d+)/i);
  if (match) {
    const m = Number(match[1]);
    if (m >= 1 && m <= courseModules.length) currentModule = m;
  }
}
window.addEventListener('hashchange', () => { applyHashModule(); updateUI?.(); });

/* ================== KEYBOARD NAV (global) ================== */
document.addEventListener('keydown', (e)=>{
  const tag = (document.activeElement?.tagName||'').toLowerCase();
  const typing = tag === 'textarea' || tag === 'input';
  if (typing || modalOverlay?.classList.contains('active')) return;
  if (e.key === 'ArrowLeft') navigateModule(-1);
  if (e.key === 'ArrowRight') navigateModule(1);
});

/* Secure context hint */
if (location.protocol === 'file:') {
  console.warn('Running over file:// may block some wallet features. Serve over http(s) for best results.');
  try { showNotification('Tip: Open this page over https:// (not file://) for wallet connectivity.', 'info'); } catch(e) {}
}

/* ================== INIT ================== */
function init() {
  console.log('ethers version?', ethers?.version);
  console.log('web3Modal present?', !!web3Modal);

  createParticles?.();
  setupModal?.();
  renderCourseMenu?.();

  loadProgress('guest');
  applyHashModule();
  updateUI?.();

  connectWalletBtn?.addEventListener('click', connectWallet);
  disconnectBtn?.addEventListener('click', disconnectWallet);
  prevModuleBtn?.addEventListener('click', () => navigateModule(-1));
  nextModuleBtn?.addEventListener('click', () => navigateModule(1));
  document.getElementById('mPrev')?.addEventListener('click',()=>navigateModule(-1));
  document.getElementById('mNext')?.addEventListener('click',()=>navigateModule(1));

  document.getElementById('saveProgressBtn')?.addEventListener('click', () => {
    userProgress[currentModule] = 'in-progress';
    saveProgress();
    const statusIndicator = document.getElementById('modalStatusIndicator');
    const statusText = document.getElementById('modalStatusText');
    if (statusIndicator) statusIndicator.className = 'status-indicator in-progress';
    if (statusText)      statusText.textContent = 'In Progress';
    showNotification('Progress saved', 'info');
  });
  wireDefaultComplete?.();
  bumpStreak?.();

  if (!web3Modal) web3Modal = setupWeb3Modal();
  if (web3Modal?.cachedProvider) { connectWallet().catch(()=>{}); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
