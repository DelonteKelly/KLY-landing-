<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sovereignty Mastery Program</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#0b0f14; --card:#121825; --card-2:#0f1522; --text:#e8eefc; --muted:#aeb7c9;
      --accent:#7c7cff; --accent-2:#5fe1b9; --gold:#f6c667; --danger:#ff6b6b; --ok:#22c55e;
      --border:rgba(255,255,255,.08); --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0b0f14 0%,#0e1320 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit}
    .container{max-width:1100px;margin:32px auto;padding:0 20px}
    .header{display:flex;flex-direction:column;gap:.45rem;margin-bottom:1.25rem}
    .header h1{margin:0;font-weight:800;letter-spacing:.2px}
    .header p{margin:0;color:var(--muted)}

    /* Wallet */
    .wallet-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .wallet-btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;color:#0b0f14;padding:8px 12px;border-radius:12px;font-weight:800;cursor:pointer}
    .chip{background:#0f1523;border:1px solid var(--border);border-radius:12px;padding:6px 10px;display:flex;align-items:center;gap:8px}
    .chip .dot{width:8px;height:8px;border-radius:50%;background:#777}
    .chip.ok .dot{background:var(--ok)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;letter-spacing:.2px}
    .small-btn{background:transparent;border:1px solid var(--border);color:#cfe2ff;border-radius:8px;padding:4px 8px;cursor:pointer}

    /* Progress */
    .progress-container{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 18px 20px;margin:18px 0;box-shadow:var(--shadow)}
    .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}
    .progress-title{font-weight:700}
    .progress-percentage{font-weight:700;color:var(--accent)}
    .progress-bar{height:10px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#8a7cff,var(--gold));border-radius:999px;transition:width .45s ease}
    .progress-stats{display:flex;gap:1rem;color:var(--muted);font-size:.92rem;margin-top:.6rem;flex-wrap:wrap}

    /* Modules grid */
    .modules-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin-top:18px}
    @media (max-width:980px){.modules-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.modules-grid{grid-template-columns:1fr}}
    .module-card{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
    .module-header{display:grid;grid-template-columns:auto 1fr;grid-template-rows:auto auto;column-gap:12px}
    .module-badge{height:36px;width:36px;border-radius:10px;background:rgba(124,124,255,.16);border:1px solid rgba(124,124,255,.3);display:grid;place-items:center;font-weight:800;color:#bfbfff}
    .module-title{margin:0}
    .module-theme{grid-column:2;color:var(--muted);font-size:.92rem;margin-top:-2px}
    .module-content{color:var(--muted)}
    .learning-objectives h4{margin:.3rem 0 .2rem;font-weight:700;color:#dfe6fb}
    .objectives-list{margin:.4rem 0 0 1.1rem}
    .objectives-list li{margin:.25rem 0}
    .module-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .module-status{display:flex;align-items:center;gap:8px;color:var(--muted)}
    .status-indicator{width:10px;height:10px;border-radius:50%;background:#777}
    .status-indicator.completed{background:var(--ok)}
    .status-indicator.in-progress{background:#f59e0b}
    .module-button{background:linear-gradient(90deg,var(--accent),#8a7cff);border:none;color:white;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    .module-button:focus-visible{outline:3px solid rgba(124,124,255,.45)}

    /* Detail */
    .back-to-modules{display:none;margin:18px 0 10px;text-decoration:none;color:#cfe2ff}
    .module-detail{display:none;background:linear-gradient(180deg,#0f1522, #0b101b);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:26px}
    .detail-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px}
    .detail-title{margin:0}
    .detail-theme{color:var(--muted)}
    .detail-close{background:transparent;border:1px solid var(--border);color:#98a4c8;height:36px;width:36px;border-radius:8px;cursor:pointer}

    /* Injected content helpers */
    .practice-box{background:rgba(124,124,255,.08);border:1px dashed rgba(124,124,255,.35);border-radius:12px;padding:12px;margin:12px 0}
    .key-quote{background:rgba(255,255,255,.04);border-left:4px solid var(--gold);padding:10px 14px;border-radius:8px;margin:12px 0}
    .module-complete{margin:10px 0}
    .module-next{color:#b7c7ff;text-decoration:none;cursor:pointer}
    .module-next:hover{text-decoration:underline}

    /* Wealth Codes nav */
    .nav-container{display:flex;gap:.5rem;flex-wrap:wrap;margin:1rem 0 2rem}
    .nav-button{background:#12172a;border:1px solid var(--border);color:#dfe6fb;border-radius:999px;padding:8px 12px;cursor:pointer}
    .nav-button.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#0b0f14;border:none}

    /* Hide the source content block */
    #courseContent{display:none}

    /* Toast */
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#0f1422;color:#eaf2ff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .3s ease}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sovereignty Mastery Program</h1>
      <p>A 7-module transformative journey to reclaim your personal power and live with authentic authority</p>

      <!-- Wallet bar -->
      <div class="wallet-bar">
        <button id="connectBtn" class="wallet-btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <div id="provChip" class="chip"><i class="fa-solid fa-triangle-exclamation" style="color:#ffd28a"></i> <span>No wallet detected</span></div>
        <div id="addrChip" class="chip" style="display:none"><span class="dot"></span><i class="fa-regular fa-id-card"></i> <span id="addrShort" class="mono">0x‚Ä¶</span> <button id="copyAddr" class="small-btn" title="Copy"><i class="fa-regular fa-copy"></i></button></div>
        <div id="chainChip" class="chip" style="display:none"><i class="fa-solid fa-network-wired"></i> <span id="chainName">Chain</span></div>
        <div id="balChip" class="chip" style="display:none"><i class="fa-solid fa-coins"></i> <span id="nativeBal" class="mono">0.0000</span> <button id="refreshBal" class="small-btn" title="Refresh"><i class="fa-solid fa-rotate"></i></button></div>
        <div id="gateChip" class="chip" style="display:none"><i class="fa-solid fa-key"></i> <span id="gateText">Checking access‚Ä¶</span></div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-container" aria-live="polite">
      <div class="progress-header">
        <div class="progress-title">Your Progress</div>
        <div class="progress-percentage" id="progressPct">0% Complete</div>
      </div>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-stats">
        <span id="progressCount">0 of 7 Modules Completed</span>
        <span>Estimated 12 hours to complete</span>
      </div>
    </div>

    <!-- Modules Grid -->
    <div class="modules-grid" id="modulesGrid" role="list">
      <!-- Cards 1‚Äì7 (unchanged content) -->
      <div class="module-card" role="listitem" data-module="1">
        <div class="module-header">
          <div class="module-badge">1</div>
          <h3 class="module-title">Foundations of Self-Awareness</h3>
          <div class="module-theme">Becoming the Observer</div>
        </div>
        <div class="module-content">
          <p class="module-description">Self-awareness is the foundation of awakening‚Äîstepping out of unconscious streams to observe with clarity and compassion.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-brain"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Lost-in-thought vs observing thought</li>
              <li>Daily mindfulness practices</li>
              <li>Journaling for clarity</li>
              <li>3-Layer Belief Audit</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(1)"><i class="fas fa-book-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="2">
        <div class="module-header">
          <div class="module-badge">2</div>
          <h3 class="module-title">Breaking the Illusion of Ego</h3>
          <div class="module-theme">You Are Not Your Story</div>
        </div>
        <div class="module-content">
          <p class="module-description">See through roles and labels; meet the silent watcher beyond narrative identity.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-bolt"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Ego vs Essence</li>
              <li>Roles, labels & identity</li>
              <li>Silent Watcher practice</li>
              <li>Ego defenses</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(2)"><i class="fas fa-play-circle"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="3">
        <div class="module-header">
          <div class="module-badge">3</div>
          <h3 class="module-title">Entering the Now</h3>
          <div class="module-theme">Presence is Power</div>
        </div>
        <div class="module-content">
          <p class="module-description">Anchor attention in breath and senses; find the gap between thoughts.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-water"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Past/Future fixation</li>
              <li>Sensory anchoring</li>
              <li>Listening as meditation</li>
              <li>Finding the silent gap</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(3)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="4">
        <div class="module-header">
          <div class="module-badge">4</div>
          <h3 class="module-title">Surrender & Emotional Alchemy</h3>
          <div class="module-theme">Freedom Through Letting Go</div>
        </div>
        <div class="module-content">
          <p class="module-description">Transmute emotion by allowing, feeling, and releasing; discover power in surrender.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-feather"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>What surrender truly is</li>
              <li>Somatic flow of emotion</li>
              <li>3-Step alchemy</li>
              <li>Forgiveness as liberation</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(4)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="5">
        <div class="module-header">
          <div class="module-badge">5</div>
          <h3 class="module-title">The Illusion of Separation</h3>
          <div class="module-theme">Remembering Oneness</div>
        </div>
        <div class="module-content">
          <p class="module-description">See the unity behind duality; meet relationships and nature as mirrors.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-infinity"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Seeing through duality</li>
              <li>Relational mirrors</li>
              <li>Nature as teacher</li>
              <li>Entanglement & connection</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(5)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="6">
        <div class="module-header">
          <div class="module-badge">6</div>
          <h3 class="module-title">Embodied Enlightenment</h3>
          <div class="module-theme">Wisdom in Action</div>
        </div>
        <div class="module-content">
          <p class="module-description">Integrate realization into daily life: shadow work, pillars of practice, sacred mundanity.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-seedling"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Transcendence ‚Üí integration</li>
              <li>4 pillars of embodiment</li>
              <li>Shadow & wholeness</li>
              <li>Chop wood, carry water</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(6)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="7">
        <div class="module-header">
          <div class="module-badge">7</div>
          <h3 class="module-title">Living as Awareness</h3>
          <div class="module-theme">The Unfolding Mystery</div>
        </div>
        <div class="module-content">
          <p class="module-description">Rest as awareness; move with spontaneity, impermanence, and effortless action.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-mountain-sun"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Form & formlessness</li>
              <li>Flow & spontaneity</li>
              <li>Gift of impermanence</li>
              <li>Beyond seeking</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(7)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>
    </div>

    <!-- Detail View -->
    <a href="#" class="back-to-modules" id="backToModules" onclick="hideModule();return false;">
      <i class="fas fa-arrow-left"></i> Back to All Modules
    </a>
    <div id="moduleDetail" class="module-detail" aria-live="polite">
      <div class="detail-header">
        <div>
          <h2 class="detail-title" id="detailTitle">Module</h2>
          <div class="detail-theme" id="detailTheme">Theme</div>
        </div>
        <button class="detail-close" onclick="hideModule()" aria-label="Close module details">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="detailBody"></div>
    </div>

    <!-- Hidden source Course Content (one copy only) -->
    <!-- Paste exactly what you provided (Modules 1‚Äì7, Bonus, SWC 1‚Äì7). -->
    <div id="courseContent">
      <!-- ‚Ä¶ your full Course Content block from earlier goes here (unchanged) ‚Ä¶ -->
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">Saved ‚úîÔ∏è</div>

  <!-- Ethers v5 (matches the code below) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // ===== helpers =====
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const toast=(m='Saved ‚úîÔ∏è')=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);};

    // ===== progress state =====
    const STORAGE_KEY='sovereignty-progress-v1';
    const state={ completed:new Set(JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')) };

    function updateProgressUI(){
      const keys=['awakening-1','awakening-2','awakening-3','awakening-4','awakening-5','awakening-6','awakening-7'];
      const done=keys.filter(k=>state.completed.has(k)).length;
      const pct=Math.round((done/keys.length)*100);
      $('#progressPct').textContent=`${pct}% Complete`;
      $('#progressFill').style.width=`${pct}%`;
      $('#progressCount').textContent=`${done} of ${keys.length} Modules Completed`;
      // card chips
      $$('.modules-grid .module-card').forEach(card=>{
        const n=card.getAttribute('data-module');
        const key=`awakening-${n}`;
        const ind=$('.status-indicator',card); const text=$('.status-text',card);
        if(state.completed.has(key)){ ind.classList.add('completed'); ind.classList.remove('in-progress'); text.textContent='Completed'; }
        else if(card.dataset.opened==='1'){ ind.classList.add('in-progress'); ind.classList.remove('completed'); text.textContent='In Progress'; }
        else{ ind.classList.remove('completed','in-progress'); text.textContent='Not Started'; }
      });
    }
    function saveProgress(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(state.completed))); updateProgressUI(); toast(); }

    // ===== detail view injection =====
    function injectArticle(el){
      const title=$('h3',el)?.textContent||'Module';
      const theme=$('h4',el)?.textContent?.replace(/^Theme:\s*/,'')||'';
      $('#detailTitle').textContent=title; $('#detailTheme').textContent=theme;
      const body=$('#detailBody'); body.innerHTML='';
      Array.from(el.children).forEach(ch=> body.appendChild(ch.cloneNode(true)));
      // wire completion
      $$('#detailBody .module-complete input[type="checkbox"]').forEach(cb=>{
        const k=cb.getAttribute('data-track'); cb.checked=state.completed.has(k);
        cb.addEventListener('change',e=>{ if(e.target.checked) state.completed.add(k); else state.completed.delete(k); saveProgress(); });
      });
      // Wealth Codes internal nav
      $$('#detailBody .nav-button').forEach(b=> b.addEventListener('click',()=>{
        const m=/Code\s+(\d+)/i.exec(b.textContent.trim()); if(m) showModule('swc'+m[1]);
      }));
    }
    function showModule(id){
      let src;
      if(typeof id==='number' || /^[1-7]$/.test(String(id))){
        src=$(`#courseContent article#module${id}`);
        const card=$(`.modules-grid .module-card[data-module="${id}"]`); if(card) card.dataset.opened='1';
      }else if(/^swc[1-7]$/.test(String(id))){ src=$(`#courseContent #${id}`); }
      if(!src){ console.warn('Module not found',id); return; }
      injectArticle(src);
      $('#moduleDetail').style.display='block';
      $('#backToModules').style.display='inline-block';
      $('#moduleDetail').scrollIntoView({behavior:'smooth',block:'start'});
      updateProgressUI();
    }
    function hideModule(){ $('#moduleDetail').style.display='none'; $('#backToModules').style.display='none'; }
    function restoreCheckboxes(){ $$('#courseContent .module-complete input[type="checkbox"]').forEach(cb=>{const k=cb.getAttribute('data-track'); cb.checked=state.completed.has(k);}); updateProgressUI(); }
    window.showModule=showModule; window.hideModule=hideModule;

    // ===== wallet (ethers v5) =====
    const CHAIN_NAMES={ '0x1':'Ethereum','0xaa36a7':'Sepolia','0x89':'Polygon','0xa4b1':'Arbitrum','0xa':'Optimism','0x38':'BNB' };
    const CONFIG={
      ENABLE_GATE: true,                  // set to false to disable token gate
      TOKEN_ADDRESS: '0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52', // KLY (example)
      MIN_TOKEN: 500,                     // required KLY amount
      ERC20_ABI: ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"]
    };
    let provider, signer, account, chainId;

    const connectBtn=$('#connectBtn'), provChip=$('#provChip'), addrChip=$('#addrChip'), chainChip=$('#chainChip'), balChip=$('#balChip'), gateChip=$('#gateChip');
    function short(a){return `${a.slice(0,6)}‚Ä¶${a.slice(-4)}`;}

    async function connectWallet(){
      if(!window.ethereum){ toast('Install MetaMask'); window.open('https://metamask.io/download','_blank'); return; }
      try{
        const accs=await ethereum.request({method:'eth_requestAccounts'});
        provider=new ethers.providers.Web3Provider(window.ethereum);
        signer=provider.getSigner();
        account=accs[0]; chainId=await ethereum.request({method:'eth_chainId'});
        paintWallet(); await refreshNative(); if(CONFIG.ENABLE_GATE) await checkGate();
        // listeners
        ethereum.on('accountsChanged', async a=>{
          if(!a.length){ account=null; paintWallet(); return; }
          account=a[0]; paintWallet(); await refreshNative(); if(CONFIG.ENABLE_GATE) await checkGate();
        });
        ethereum.on('chainChanged', async cid=>{
          chainId=cid; paintWallet(); await refreshNative(); if(CONFIG.ENABLE_GATE) await checkGate();
        });
      }catch(e){ console.error(e); toast('Wallet connection failed'); }
    }
    function paintWallet(){
      const hasEth=!!window.ethereum;
      provChip.style.display = hasEth ? 'none' : 'inline-flex';
      if(account){
        $('#addrShort').textContent=short(account);
        $('#chainName').textContent=CHAIN_NAMES[chainId]||`Chain ${chainId}`;
        addrChip.style.display='inline-flex'; addrChip.classList.add('ok');
        chainChip.style.display='inline-flex';
        balChip.style.display='inline-flex';
        connectBtn.textContent='Connected'; connectBtn.disabled=true;
      }else{
        addrChip.style.display='none'; chainChip.style.display='none'; balChip.style.display='none'; gateChip.style.display='none';
        connectBtn.textContent='Connect Wallet'; connectBtn.disabled=false;
      }
    }
    async function refreshNative(){
      if(!provider || !account) return;
      const wei = await provider.getBalance(account);
      const eth = Number(ethers.utils.formatEther(wei));
      $('#nativeBal').textContent = `${eth.toLocaleString(undefined,{maximumFractionDigits:6})} ${CHAIN_NAMES[chainId]==='Polygon'?'MATIC':'ETH'}`;
      toast('Balance updated ‚úîÔ∏è');
    }
    async function checkGate(){
      try{
        if(!provider || !account){ gateChip.style.display='none'; return; }
        gateChip.style.display='inline-flex'; $('#gateText').textContent='Checking access‚Ä¶';
        const token=new ethers.Contract(CONFIG.TOKEN_ADDRESS, CONFIG.ERC20_ABI, provider);
        const [raw,dec]=await Promise.all([token.balanceOf(account), token.decimals()]);
        const bal=Number(ethers.utils.formatUnits(raw,dec));
        if(bal>=CONFIG.MIN_TOKEN){
          $('#gateText').textContent=`‚úÖ ${bal.toFixed(2)} KLY ‚Äî Access Granted`;
          gateChip.classList.add('ok');
        }else{
          $('#gateText').textContent=`‚ùå ${bal.toFixed(2)} KLY ‚Äî Need ${CONFIG.MIN_TOKEN}+`;
          gateChip.classList.remove('ok');
        }
      }catch(e){ console.error(e); $('#gateText').textContent='Error checking token'; }
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      restoreCheckboxes();
      document.addEventListener('keydown',e=>{ if(e.key==='Escape') hideModule(); });
      connectBtn.addEventListener('click', connectWallet);
      $('#refreshBal').addEventListener('click', refreshNative);
      $('#copyAddr').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(account||''); toast('Address copied üìã'); }catch{ toast('Copy failed'); } });
      // Auto-open M1 once
      if(!localStorage.getItem('__opened_once__')){ showModule(1); localStorage.setItem('__opened_once__','1'); }
      // Prepaint provider hint
      paintWallet();
    });
  </script>
</body>
</html>
