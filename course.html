<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sovereignty Mastery ‚Äî Aurora Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Token-gated sovereignty mastery program with Web3 integration" />

<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=General+Sans:wght@400;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- Motion & Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- Web3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
  :root{
    /* Aurora palette */
    --bg:#070a12; --bg2:#0b0f1c; --glass:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.08);
    --ink:#e9eefc; --muted:#b5c1de; --line:rgba(177,198,255,.16);
    --cyn:#7ae9ff; --vio:#8d7bff; --pnk:#ff77e1; --mint:#69ffb4; --sun:#ffc56b; --red:#ff5d6c;
    --ring:0 0 0 2px rgba(122,233,255,.25);
    --radius:16px; --radius-sm:12px; --shadow:0 18px 60px rgba(0,0,0,.45);
    --ease:cubic-bezier(.2,.7,.1,1); --time:.25s;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{scroll-behavior:smooth}
  body{
    margin:0; color:var(--ink);
    font-family:"General Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 800px at 10% -5%, rgba(122,233,255,.12), transparent 60%),
      radial-gradient(1000px 700px at 100% -20%, rgba(141,123,255,.12), transparent 60%),
      conic-gradient(from 210deg at 60% 0%, rgba(255,119,225,.07), transparent 40%),
      linear-gradient(180deg, var(--bg), var(--bg2) 55%, #070915);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  a{color:var(--cyn); text-decoration:none}
  a:hover{opacity:.9}
  button{font-family:inherit}

  /* Reduce motion respect */
  @media (prefers-reduced-motion:reduce){
    *{animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important}
  }

  /* Layout */
  .shell{display:grid; grid-template-rows:auto 1fr; min-height:100vh}
  .top{
    position:sticky; top:0; z-index:50; backdrop-filter:blur(10px) saturate(1.05);
    background:linear-gradient(180deg, rgba(7,10,18,.9), rgba(7,10,18,.65));
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:14px 18px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand i{color:var(--cyn); filter:drop-shadow(0 0 10px rgba(122,233,255,.6))}
  .brand-title{font-family:"Space Grotesk"; font-weight:800; letter-spacing:.4px}
  .rchip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); color:#cfe2ff; background:var(--glass)}
  .btn{
    border:1px solid var(--line); color:var(--ink); background:linear-gradient(90deg, rgba(122,233,255,.18), rgba(141,123,255,.18));
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px;
    box-shadow:0 0 0 1px rgba(122,233,255,.12); transition:transform var(--time) var(--ease), box-shadow var(--time);
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(141,123,255,.2)}
  .btn-ghost{background:transparent}
  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .hide{display:none!important}

  /* Main grid */
  .main{display:grid; grid-template-columns:280px 1fr 320px; gap:18px; padding:18px}
  @media (max-width:1100px){ .main{grid-template-columns:1fr} }

  /* Panels */
  .panel{
    background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.03));
    border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
  }
  .panel h3{margin:0 0 10px}

  /* Sidebar (left) */
  .profile{display:flex; align-items:center; gap:12px; padding-bottom:12px; border-bottom:1px dashed var(--line); margin-bottom:12px}
  .avatar{width:48px; height:48px; border-radius:50%; display:grid; place-items:center; font-weight:800;
    background:
      radial-gradient(closest-side, #ffffff22 30%, #0000 60%),
      linear-gradient(135deg, var(--cyn), var(--vio));
    box-shadow:0 0 0 3px rgba(122,233,255,.15);
  }
  .side-menu{display:flex; flex-direction:column; gap:10px; margin-top:8px}
  .sbtn{
    width:100%; text-align:left; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
    background:rgba(255,255,255,.04); color:var(--ink); display:flex; align-items:center; gap:10px; cursor:pointer; transition:.2s var(--ease);
  }
  .sbtn:hover{transform:translateX(4px); border-color:rgba(122,233,255,.35)}
  .badge{min-width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
    background:rgba(122,233,255,.12); border:1px solid rgba(122,233,255,.25); color:#bff1ff; font-weight:800;
  }
  .tag{margin-left:auto; background:linear-gradient(90deg, var(--mint), var(--cyn)); color:#06101a; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}

  /* Center: curriculum + detail */
  .searchbar{display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.06); border:1px solid var(--line); padding:8px 12px; border-radius:999px}
  .searchbar input{flex:1; background:transparent; border:0; color:var(--ink); outline:none}
  .filter-row{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px}
  .chip{background:rgba(255,255,255,.06); border:1px solid var(--line); color:#cfe2ff; border-radius:999px; padding:6px 10px; cursor:pointer}
  .chip.active{background:linear-gradient(90deg, var(--cyn), var(--vio)); color:#06101a; border:0}

  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--line); border-radius:var(--radius-sm); padding:14px; display:flex; flex-direction:column; gap:10px; position:relative;
  }
  .card:hover{border-color:rgba(141,123,255,.5)}
  .card.lock{opacity:.55}
  .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .muted{color:var(--muted)}
  .progress{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--cyn), #b0a8ff, var(--pnk)); width:0%}

  .detail{margin-top:12px; border:1px solid var(--line); border-radius:var(--radius); padding:18px; display:none}
  .detail.show{display:block}
  .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; color:#cfe2ff}
  .pill.ready{border-color:rgba(105,255,180,.4); color:#c4ffe3}
  .lesson{background:rgba(122,233,255,.08); border-left:3px solid var(--cyn); padding:12px; border-radius:0 10px 10px 0; margin:10px 0}

  /* Right: gate + certificate */
  .ring{--p:0; --size:88px; width:var(--size); height:var(--size); border-radius:50%;
    background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--mint) var(--p), #23273a 0);
    position:relative;
  }
  .ring::before{
    content:attr(data-label); position:absolute; inset:8px; border-radius:50%; display:grid; place-items:center; color:#a8f9ff;
    border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    font-weight:800;
  }
  .cert-img{border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.45)}
  .cert-img img{display:block; width:100%}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(7,10,18,.86); backdrop-filter:blur(10px); z-index:1000}
  .modal.show{display:grid}
  .modal-card{width:min(900px,90vw); max-height:90vh; overflow:auto; background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:18px; padding:18px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); padding-bottom:10px; margin-bottom:12px}
  .x{background:transparent; border:0; color:var(--ink); cursor:pointer}
  .x:hover{color:var(--red)}

  /* Mobile */
  @media (max-width:860px){
    .topbar{gap:8px}
    .rchip.hide-sm{display:none}
  }
</style>
</head>
<body>
<div class="shell">

  <!-- HEADER -->
  <header class="top">
    <div class="wrap topbar" role="navigation" aria-label="Global">
      <div class="brand">
        <i class="fa-solid fa-crown"></i>
        <div>
          <div class="brand-title">Sovereignty Mastery</div>
          <small class="muted">Aurora Edition</small>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <span id="chip-progress" class="rchip hide-sm"><i class="fa-solid fa-chart-simple"></i><span id="chip-text">0/21 Complete</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect</button>
        <span id="addr-chip" class="rchip addr hide" aria-live="polite"><i class="fa-solid fa-user-astronaut"></i><span id="addr-short">0x‚Ä¶</span></span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="wrap main">

    <!-- LEFT: SIDEBAR -->
    <aside class="panel" aria-label="Navigation">
      <div class="profile">
        <div class="avatar" id="avatar">SM</div>
        <div>
          <div style="font-weight:800">Learner</div>
          <div id="addr-full" class="addr muted">Not connected</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:10px">
        <button id="btn-disconnect" class="btn btn-ghost hide"><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        <button id="btn-reconnect" class="btn btn-ghost hide"><i class="fa-solid fa-plug-circle-bolt"></i> Reconnect</button>
      </div>

      <h3 style="margin-top:4px">Areas</h3>
      <div id="menu" class="side-menu"></div>

      <h3 style="margin-top:16px">Shortcuts</h3>
      <div class="side-menu">
        <button class="sbtn" data-tab="overview"><i class="fa-regular fa-grid-2"></i> Overview <span class="tag">Home</span></button>
        <button class="sbtn" data-tab="syllabus"><i class="fa-regular fa-list-check"></i> Syllabus <span class="tag">All</span></button>
        <button class="sbtn" data-tab="progress"><i class="fa-regular fa-chart-line"></i> Progress <span class="tag">Stats</span></button>
        <button class="sbtn" data-tab="resources"><i class="fa-regular fa-folder-open"></i> Resources <span class="tag">Links</span></button>
      </div>
    </aside>

    <!-- CENTER: CURRICULUM -->
    <main class="panel" aria-live="polite">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div class="searchbar" role="search"><i class="fa-solid fa-magnifying-glass"></i><input id="search" type="search" placeholder="Search modules, themes, objectives‚Ä¶" aria-label="Search modules"></div>
        <div class="filter-row" id="filters">
          <button class="chip active" data-filter="all">All</button>
          <button class="chip" data-filter="core">Core</button>
          <button class="chip" data-filter="sovereign">Sovereign</button>
          <button class="chip" data-filter="not-started">Not started</button>
          <button class="chip" data-filter="in-progress">In progress</button>
          <button class="chip" data-filter="completed">Completed</button>
        </div>
      </div>

      <div id="views">
        <!-- Overview -->
        <section id="view-overview">
          <div id="grid-overview" class="grid" role="list"></div>
        </section>

        <!-- Syllabus -->
        <section id="view-syllabus" class="hide">
          <div id="grid-syllabus" class="grid" role="list"></div>
        </section>

        <!-- Progress -->
        <section id="view-progress" class="hide">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
            <div class="card">
              <div class="row"><strong>Total Completion</strong><span class="pill" id="pill-total">0%</span></div>
              <div class="progress"><span id="bar-total"></span></div>
              <div class="muted"><span id="done-total">0</span>/<span id="count-total">0</span> modules</div>
            </div>
            <div class="card">
              <div class="row"><strong>Core</strong><span class="pill" id="pill-core">0%</span></div>
              <div class="progress"><span id="bar-core"></span></div>
              <div class="muted"><span id="done-core">0</span>/<span id="count-core">0</span></div>
            </div>
            <div class="card">
              <div class="row"><strong>Sovereign</strong><span class="pill" id="pill-sov">0%</span></div>
              <div class="progress"><span id="bar-sov"></span></div>
              <div class="muted"><span id="done-sov">0</span>/<span id="count-sov">0</span></div>
            </div>
          </div>
          <div id="grid-progress" class="grid" style="margin-top:12px"></div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="hide">
          <div class="card">
            <h3 style="margin:6px 0 8px">Resources & Downloads</h3>
            <ul class="muted">
              <li>üìù Worksheets: Sovereignty Audit, Resource Audit, Boundaries Scripts</li>
              <li>üéß Practices: Deep Listening, Micro-Surrender, Box Breathing (4-4-6-2)</li>
              <li>üìö Reading: Presence, Nonviolent Communication, Essentialism</li>
            </ul>
          </div>
        </section>
      </div>

      <!-- Detail (inline) -->
      <section id="detail" class="detail" aria-describedby="detail-title">
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <div style="display:flex; align-items:center; gap:10px">
            <div class="badge" id="detail-num">1</div>
            <h3 id="detail-title" style="margin:0">Module</h3>
          </div>
          <span class="pill" id="detail-area">Area</span>
          <span class="pill" id="detail-status">Not Started</span>
          <span class="pill" id="detail-theme">Theme</span>
        </div>
        <div id="detail-body" style="margin-top:8px"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn btn-ghost" id="btn-prev"><i class="fa-solid fa-arrow-left-long"></i> Prev</button>
          <div style="flex:1"></div>
          <button class="chip" id="btn-mark"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
          <button class="btn" id="btn-full"><i class="fa-regular fa-expand"></i> Full View</button>
          <button class="btn btn-ghost" id="btn-next">Next <i class="fa-solid fa-arrow-right-long"></i></button>
        </div>
      </section>
    </main>

    <!-- RIGHT: GATE + CERT -->
    <aside class="panel" aria-label="Access & Certificate">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Access Gate</h3>
        <div class="ring" id="ring" data-label="0%"></div>
      </div>
      <p class="muted" id="gate-note">Hold <strong>5</strong> <span id="tokenSymbol">TOKEN</span> on BNB Chain to unlock the Sovereign track.</p>
      <div class="card">
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center">
            <i class="fa-solid fa-coins" style="color:var(--mint)"></i>
            <div><div class="muted">Your balance</div><strong id="token-balance">‚Äî</strong></div>
          </div>
          <button id="btn-gate-connect" class="btn btn-ghost"><i class="fa-solid fa-plug-circle-bolt"></i> Connect</button>
        </div>
      </div>

      <h3 style="margin:12px 0 8px">Certificate</h3>
      <div class="cert-img"><img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="Certificate"/></div>
      <div class="row" style="margin:10px 0"><span class="muted">Status</span><strong id="cert-status">Locked</strong></div>
      <div class="row" style="margin:6px 0"><span class="muted">Progress</span><strong id="cert-progress">0 / 21</strong></div>
      <button class="btn" id="btn-mint" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
      <div id="mint-status" class="muted" style="margin-top:8px"></div>
    </aside>

  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="modal-title" style="margin:0; display:flex; align-items:center; gap:10px"><span class="badge" id="modal-num">1</span> <span id="modal-name">Module</span></h3>
      <button class="x" id="modal-close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG ‚Äî TOKEN GATE
========================= */
const TOKEN_ADDRESS   = '0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026'; // <-- set your ERC-20
const REQUIRED_TOKENS = 5;
const CHAIN_ID        = 56;  // BNB Smart Chain
const CHAIN_NAME      = 'BNB Smart Chain';
const RPC_URL         = 'https://bsc-dataseed.binance.org';
const ERC20_ABI       = ['function balanceOf(address) view returns (uint256)','function decimals() view returns (uint8)','function symbol() view returns (string)'];
const toHex = (n)=>'0x'+n.toString(16);

/* =========================
   COURSE DATA (Core 7 + Sovereign 14)
   ‚Äî content kept compact; extend freely
========================= */
const COURSE = {
  areas: [
    {
      id:'core', name:'Core Program', description:'7-module path to awakening & embodiment', modules: [
        { id:'1', order:1, title:'Foundations of Self-Awareness', theme:'Becoming the Observer',
          objectives:['Lost-in-thought vs observing thought','Daily mindfulness practices','Journaling for clarity','3-Layer Belief Audit'],
          content:`<h3>Core Concept</h3><p>Self-awareness is the foundation of awakening‚Äîstepping out of unconscious streams to observe with clarity and compassion.</p>
                   <div class="lesson"><strong>Practice ‚Äî Thought Observation</strong><p>Set a 5-minute timer and label thoughts ‚Äúthinking‚Ä¶‚Äù as they arise. Let them pass.</p></div>
                   <h3>Journaling</h3><ul><li>What thoughts keep recurring?</li><li>What emotions am I skipping?</li><li>Where did I operate on autopilot?</li></ul>` },
        { id:'2', order:2, title:'Breaking the Illusion of Ego', theme:'You Are Not Your Story',
          objectives:['Ego vs Essence','Roles & labels','Silent Watcher practice','Ego defenses'],
          content:`<h3>Core Concept</h3><p>See through roles and labels; meet the silent watcher beyond narrative identity.</p>
                   <div class="lesson"><strong>Practice ‚Äî Identity Inventory</strong><p>List identities you wear; ask: ‚ÄúWithout this, am I still here?‚Äù</p></div>` },
        { id:'3', order:3, title:'Entering the Now', theme:'Presence is Power',
          objectives:['Past/Future fixation','Sensory anchoring','Listening as meditation','Finding the silent gap'],
          content:`<h3>Core Concept</h3><p>Anchor attention in breath and senses; find the gap between thoughts.</p>
                   <div class="lesson"><strong>Practice ‚Äî Deep Listening</strong><p>Offer another your full attention; return to pure hearing whenever mind wanders.</p></div>` },
        { id:'4', order:4, title:'Surrender & Emotional Alchemy', theme:'Freedom Through Letting Go',
          objectives:['What surrender is','Somatic flow of emotion','3-Step alchemy','Forgiveness as liberation'],
          content:`<h3>Core Concept</h3><p>Transmute emotion by allowing, feeling, and releasing.</p>
                   <div class="lesson"><strong>Practice ‚Äî Micro-Surrender</strong><p>Choose one irritation today; say a conscious ‚Äúyes‚Äù to it and feel the shift.</p></div>` },
        { id:'5', order:5, title:'The Illusion of Separation', theme:'Remembering Oneness',
          objectives:['Seeing through duality','Relational mirrors','Nature as teacher','Entanglement & connection'],
          content:`<h3>Core Concept</h3><p>See the unity behind duality; meet relationships and nature as mirrors.</p>` },
        { id:'6', order:6, title:'Embodied Enlightenment', theme:'Wisdom in Action',
          objectives:['Transcendence ‚Üí integration','4 pillars of embodiment','Shadow & wholeness','Chop wood, carry water'],
          content:`<h3>Core Concept</h3><p>Integrate realization into daily life: design rhythms, embrace shadow, act with presence.</p>` },
        { id:'7', order:7, title:'Living as Awareness', theme:'The Unfolding Mystery',
          objectives:['Form & formlessness','Flow & spontaneity','Gift of impermanence','Beyond seeking'],
          content:`<h3>Core Concept</h3><p>Rest as awareness; move with spontaneity, impermanence, and effortless action.</p>` }
      ]
    },
    {
      id:'sovereign', name:'The Sovereign Self', description:'14-module journey into inner authority & stewardship', modules: [
        { id:'sv1',order:1, title:'Foundation of Sovereignty', theme:'Understanding Personal Power',
          objectives:['Roots of sovereignty','Where you surrendered authority','Ego vs soul power','Daily practice','Declaration'],
          content:`<h3>Core Concept</h3><p>Sovereignty is your birthright to complete authority over your being‚Äîthoughts, emotions, choices, energy.</p>
                   <div class="lesson"><strong>Action:</strong> Reclaim one area within 48 hours.</div>` },
        { id:'sv2',order:2, title:'Boundaries & Energy Protection', theme:'Creating Safe Containers',
          objectives:['Map patterns','Guilt-free limits','Protection techniques','Respond to violations','Context rules'],
          content:`<h3>Core Concept</h3><p>Boundaries define where you end & others begin.</p>` },
        { id:'sv3',order:3, title:'Authentic Decision Making', theme:'Listening to Inner Wisdom',
          objectives:['Spot fear patterns','Guidance rituals','Decondition reactivity','Values filters','Act on intuition'],
          content:`<h3>Core Concept</h3><p>Aligned choices emerge from values, body wisdom, and intuition.</p>` },
        { id:'sv4',order:4, title:'Sovereign Communication', theme:'Expressing Truth with Power',
          objectives:['Express needs','Active listening','Center conflict','Release blame','Language upgrades'],
          content:`<h3>Core Concept</h3><p>Clarity + compassion + conviction‚Äîwithout attachment to outcome.</p>` },
        { id:'sv5',order:5, title:'Financial Sovereignty', theme:'Wealth as Energy Exchange',
          objectives:['Audit beliefs','Align income','Spend by values','Flow mindset','Systems'],
          content:`<h3>Core Concept</h3><p>Shift from scarcity to stewardship; build systems for freedom.</p>` },
        { id:'sv6',order:6, title:'Sovereign Relationships', theme:'Connecting Without Losing Self',
          objectives:['Spot patterns','Self-connection','Mutual respect','Closeness/space','Ask clearly'],
          content:`<h3>Core Concept</h3><p>Intimacy with autonomy; presence without enmeshment.</p>` },
        { id:'sv7',order:7, title:'Living as Sovereign Being', theme:'Integration & Mastery',
          objectives:['Daily ritualization','Resilience','Environment design','Aligned default','Intentional creation'],
          content:`<h3>Core Concept</h3><p>Make sovereignty your default OS.</p>` },
        { id:'sv8',order:8, title:'Lawful Foundations', theme:'Rights, Duties, Jurisdiction',
          objectives:['Rights vs privileges','Jurisdictions','Identity docs','Lawful comms','Records'],
          content:`<h3>Core Concept</h3><p>Distinguish frameworks and act accordingly.</p>` },
        { id:'sv9',order:9, title:'Status Correction Essentials', theme:'Identity, Notice, Standing',
          objectives:['Map status','Declarations','Timelines','Consistency','Avoid contradictions'],
          content:`<h3>Core Concept</h3><p>Clean declarations + consistent conduct.</p>` },
        { id:'sv10',order:10, title:'Affidavits & Notices', theme:'Truth in the Record',
          objectives:['Structure','Facts not fluff','Service','Track responses','Close loop'],
          content:`<h3>Core Concept</h3><p>Affidavits are sworn truth; notices create process.</p>` },
        { id:'sv11',order:11, title:'Trusts & PMA', theme:'Private Structures',
          objectives:['Purpose','Roles & duties','Bylaws','Separate capacities','Minutes & records'],
          content:`<h3>Core Concept</h3><p>Structure stewardship & community.</p>` },
        { id:'sv12',order:12, title:'Right to Travel (Education)', theme:'Safety, Notice, Documentation',
          objectives:['ID packet','Calm scripts','Escalation','Recording','Debrief'],
          content:`<h3>Core Concept</h3><p>Preparation turns pressure into poise.</p>` },
        { id:'sv13',order:13, title:'Commercial Remedies (Education)', theme:'Invoices, Liens, Cures',
          objectives:['Remedy ladder','Notices before claims','Track timelines','Avoid frivolous','Seek counsel'],
          content:`<h3>Core Concept</h3><p>Match remedy to facts and forum.</p>` },
        { id:'sv14',order:14, title:'Record & Publish', theme:'Make it Real in the World',
          objectives:['Choose venues','Organize repos','Consistent formats','Versioning','Cold backups'],
          content:`<h3>Core Concept</h3><p>Records are the spine of sovereignty.</p>` }
      ]
    }
  ]
};

/* =========================
   STATE & ELEMENTS
========================= */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

const E = {
  // header
  btnConnect: $('#btn-connect'),
  addrChip: $('#addr-chip'), addrShort: $('#addr-short'),
  chipText: $('#chip-text'),
  // sidebar
  avatar: $('#avatar'), addrFull: $('#addr-full'),
  btnDisconnect: $('#btn-disconnect'), btnReconnect: $('#btn-reconnect'),
  menu: $('#menu'),
  // center
  filters: $('#filters'), search: $('#search'),
  viewOverview: $('#view-overview'), viewSyllabus: $('#view-syllabus'), viewProgress: $('#view-progress'), viewResources: $('#view-resources'),
  gridOverview: $('#grid-overview'), gridSyllabus: $('#grid-syllabus'), gridProgress: $('#grid-progress'),
  detail: $('#detail'), detailNum: $('#detail-num'), detailTitle: $('#detail-title'),
  detailArea: $('#detail-area'), detailStatus: $('#detail-status'), detailTheme: $('#detail-theme'), detailBody: $('#detail-body'),
  btnPrev: $('#btn-prev'), btnNext: $('#btn-next'), btnFull: $('#btn-full'), btnMark: $('#btn-mark'),
  // right
  ring: $('#ring'), tokenBalance: $('#token-balance'), tokenSymbol: $('#tokenSymbol'),
  btnGateConnect: $('#btn-gate-connect'), certStatus: $('#cert-status'), certProgress: $('#cert-progress'),
  btnMint: $('#btn-mint'), mintStatus: $('#mint-status'),
  // progress KPIs
  pillTotal: $('#pill-total'), barTotal: $('#bar-total'), doneTotal: $('#done-total'), countTotal: $('#count-total'),
  pillCore: $('#pill-core'), barCore: $('#bar-core'), doneCore: $('#done-core'), countCore: $('#count-core'),
  pillSov: $('#pill-sov'), barSov: $('#bar-sov'), doneSov: $('#done-sov'), countSov: $('#count-sov'),
  // modal
  modal: $('#modal'), modalClose: $('#modal-close'), modalTitle: $('#modal-title'),
  modalNum: $('#modal-num'), modalName: $('#modal-name'), modalBody: $('#modal-body')
};

const STORAGE = { PROGRESS:'sv_progress_v3', OPEN:'sv_open_v1' };
let accessGranted = false;
let tokenSymbolCached = 'TOKEN';
let state = { tab:'overview', filter:'all', search:'', openId:null };

/* =========================
   HELPERS
========================= */
function allModules(){ return COURSE.areas.flatMap(a => a.modules.map(m => ({...m, areaId:a.id, areaName:a.name}))); }
function progressLoad(){ try{return JSON.parse(localStorage.getItem(STORAGE.PROGRESS))||{}}catch{ return {} } }
function progressSave(p){ localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(p)); }
function keyOf(m){ return `${m.areaId}:${m.id}` }
function progressOf(m){ const p = progressLoad(); return p[keyOf(m)] || {status:'not-started', percent:0} }
function setProgress(m, status){
  const p = progressLoad(); const k = keyOf(m);
  const prev = p[k] || {percent:0};
  p[k] = { status, percent: status==='completed' ? 100 : status==='in-progress' ? Math.max(prev.percent,25) : 0 };
  progressSave(p); renderAll();
}
function percentCompleted(areaId){
  const mods = allModules().filter(m => !areaId || m.areaId===areaId);
  const done = mods.filter(m => progressOf(m).status==='completed').length;
  return {done, total:mods.length, pct:mods.length ? Math.round(done/mods.length*100) : 0};
}
function gateLocked(areaId){ return areaId==='sovereign' && !accessGranted; }
function notifyOK(msg){ if(typeof confetti==='function'){ confetti({particleCount:80, spread:60, origin:{y:.85}, colors:["#7ae9ff","#8d7bff","#69ffb4"]}); } console.log(msg); }

/* =========================
   RENDER ‚Äî SIDEBAR & MENUS
========================= */
function renderSidebar(){
  E.menu.innerHTML='';
  COURSE.areas.forEach(area=>{
    const head = document.createElement('button');
    head.className='sbtn'; head.innerHTML=`<i class="fa-solid fa-layer-group"></i> ${area.name} <span class="tag">${area.modules.length}</span>`;
    head.onclick = ()=>{ switchTab('syllabus'); setFilter(area.id); };
    E.menu.appendChild(head);
    area.modules.forEach(m=>{
      const st = progressOf({areaId:area.id, id:m.id}).status;
      const badge = st==='completed' ? '<i class="fa-solid fa-check"></i>' : st==='in-progress' ? '‚Ä¢' : '‚Äì';
      const btn = document.createElement('button');
      btn.className='sbtn'; if(gateLocked(area.id)) btn.classList.add('lock');
      btn.innerHTML = `<span class="badge" title="${st}">${badge}</span> <strong>${area.id==='core'?m.order:m.id.replace('sv','')}</strong> ${m.title} <span class="tag">${area.id==='core'?'Core':'Sovereign'}</span>`;
      btn.onclick = ()=> gateLocked(area.id) ? E.btnGateConnect.click() : openModule(area.id, m.id);
      E.menu.appendChild(btn);
    });
  });
}

/* =========================
   RENDER ‚Äî CARDS & LISTS
========================= */
function matchFilters(m){
  const st = progressOf(m).status;
  const f = state.filter;
  const byStatus = f==='all' ? true :
    f==='not-started'? st==='not-started' :
    f==='in-progress'? st==='in-progress' :
    f==='completed'? st==='completed' :
    f===m.areaId;
  const s = state.search.trim().toLowerCase();
  const bySearch = !s || [m.title, m.theme, ...(m.objectives||[])].join(' ').toLowerCase().includes(s);
  return byStatus && bySearch;
}

function cardFor(m){
  const p = progressOf(m);
  const el = document.createElement('div');
  el.className = 'card' + (gateLocked(m.areaId)?' lock':'');
  el.setAttribute('role','listitem');
  el.innerHTML = `
    <div class="row">
      <div style="display:flex; gap:10px; align-items:center">
        <div class="badge">${m.areaId==='core'?m.order:m.id.replace('sv','')}</div>
        <div><strong>${m.title}</strong><div class="muted">${m.theme}</div></div>
      </div>
      <span class="pill">${m.areaId==='core'?'Core':'Sovereign'}</span>
    </div>
    <div class="muted">Objectives: ${m.objectives.slice(0,2).join(' ‚Ä¢ ')}${m.objectives.length>2?'‚Ä¶':''}</div>
    <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
    <div class="row">
      <span class="muted">${p.status==='completed'?'Completed':p.status==='in-progress'?'In Progress':'Not Started'}</span>
      <div style="display:flex; gap:8px">
        <button class="chip" data-act="in">Mark In-Progress</button>
        <button class="btn" data-act="open"><i class="fa-regular fa-book-open"></i> ${gateLocked(m.areaId)?'Unlock':'Open'}</button>
      </div>
    </div>
  `;
  el.querySelector('[data-act="in"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : setProgress(m,'in-progress');
  el.querySelector('[data-act="open"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : openModule(m.areaId, m.id);
  return el;
}

function renderOverview(){
  E.gridOverview.innerHTML = '';
  allModules().filter(matchFilters).sort((a,b)=> (a.areaId===b.areaId ? (a.order||0)-(b.order||0) : a.areaId.localeCompare(b.areaId))).forEach(m=>{
    E.gridOverview.appendChild(cardFor(m));
  });
}

function renderSyllabus(){
  E.gridSyllabus.innerHTML = '';
  COURSE.areas.forEach(area=>{
    // section header
    const head = document.createElement('div');
    head.className='card';
    head.innerHTML = `<div class="row"><div style="display:flex; gap:10px; align-items:center"><i class="fa-solid fa-layer-group"></i><strong>${area.name}</strong></div><span class="muted">${area.description}</span></div>`;
    E.gridSyllabus.appendChild(head);

    area.modules.filter(m=>matchFilters({...m, areaId:area.id})).forEach(m=>{
      E.gridSyllabus.appendChild(cardFor({...m, areaId:area.id, areaName:area.name}));
    });
  });
}

function renderProgress(){
  const all = percentCompleted(); const core = percentCompleted('core'); const sov = percentCompleted('sovereign');
  E.doneTotal.textContent = all.done; E.countTotal.textContent = all.total; E.pillTotal.textContent = all.pct+'%'; E.barTotal.style.width = all.pct+'%';
  E.doneCore.textContent = core.done; E.countCore.textContent = core.total; E.pillCore.textContent = core.pct+'%'; E.barCore.style.width = core.pct+'%';
  E.doneSov.textContent = sov.done; E.countSov.textContent = sov.total; E.pillSov.textContent = sov.pct+'%'; E.barSov.style.width = sov.pct+'%';

  E.gridProgress.innerHTML='';
  allModules().forEach(m=> E.gridProgress.appendChild(cardFor(m)));
}

/* =========================
   DETAIL & MODAL
========================= */
function openModule(areaId, id){
  state.tab = 'syllabus';
  const list = allModules();
  const idx = list.findIndex(x=>x.areaId===areaId && x.id===id);
  const m = list[idx]; if(!m) return;

  // mark in-progress if fresh
  if(progressOf(m).status==='not-started') setProgress(m,'in-progress');

  // show detail
  $('#view-syllabus').classList.add('hide');
  E.detail.classList.add('show'); state.openId = keyOf(m); localStorage.setItem(STORAGE.OPEN, state.openId);

  E.detailNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.detailTitle.textContent = m.title;
  E.detailArea.textContent = m.areaName;
  E.detailTheme.textContent = m.theme;
  const st = progressOf(m).status; E.detailStatus.textContent = st==='completed'?'Completed':st==='in-progress'?'In Progress':'Not Started';
  E.detailBody.innerHTML = `<h3>Objectives</h3><ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>${m.content||''}`;

  E.btnPrev.onclick = ()=>{
    const prev = list[idx-1] || list[list.length-1];
    return gateLocked(prev.areaId) ? E.btnGateConnect.click() : openModule(prev.areaId, prev.id);
  };
  E.btnNext.onclick = ()=>{
    const next = list[idx+1] || list[0];
    return gateLocked(next.areaId) ? E.btnGateConnect.click() : openModule(next.areaId, next.id);
  };
  E.btnFull.onclick = ()=> openModal(m);
  E.btnMark.onclick = ()=>{
    const cur = progressOf(m).status;
    setProgress(m, cur==='completed' ? 'in-progress' : 'completed');
    // refresh inline
    openModule(areaId, id);
  };

  renderTabs(); // ensure right view states
}

function openModal(m){
  E.modal.classList.add('show');
  E.modalNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.modalName.textContent = m.title;
  E.modalBody.innerHTML = `
    <div class="muted" style="margin-bottom:8px">${m.areaName} ‚Ä¢ ${m.theme}</div>
    <h3>Objectives</h3>
    <ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>
    ${m.content||''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
      <button class="chip" id="modal-mark-in"><i class="fa-regular fa-bookmark"></i> Save Progress</button>
      <button class="btn" id="modal-mark-done"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
    </div>
  `;
  $('#modal-mark-in').onclick = ()=> setProgress(m,'in-progress');
  $('#modal-mark-done').onclick = ()=>{
    setProgress(m,'completed');
    const all = percentCompleted(); if(all.done===all.total){ notifyOK('All modules complete!'); }
  };
}
E.modalClose.onclick = ()=> E.modal.classList.remove('show');
E.modal.addEventListener('click', e=>{ if(e.target===E.modal) E.modal.classList.remove('show'); });

/* =========================
   TABS, FILTERS, SEARCH
========================= */
function renderTabs(){
  E.viewOverview.classList.toggle('hide', state.tab!=='overview');
  E.viewSyllabus.classList.toggle('hide', state.tab!=='syllabus' || !!state.openId);
  E.viewProgress.classList.toggle('hide', state.tab!=='progress');
  E.viewResources.classList.toggle('hide', state.tab!=='resources');
  if(state.tab!=='syllabus'){ E.detail.classList.remove('show'); state.openId=null; localStorage.removeItem(STORAGE.OPEN); }
}
function switchTab(tab){ state.tab = tab; renderTabs(); }
function setFilter(f){
  state.filter = f;
  $$('#filters .chip').forEach(c=> c.classList.toggle('active', c.dataset.filter===f));
  renderCenter();
}
function renderCenter(){ renderOverview(); renderSyllabus(); renderProgress(); }

/* =========================
   HEADER/RIGHT UI
========================= */
function updateHeaderAndRight(){
  const all = percentCompleted();
  E.chipText.textContent = `${all.done}/${all.total} Complete`;
  E.certProgress.textContent = `${all.done} / ${all.total}`;
  const pct = Math.min(100, all.pct); E.ring.style.setProperty('--p', pct+'%'); E.ring.setAttribute('data-label', pct+'%');
  const canMint = all.done===all.total;
  E.certStatus.textContent = canMint ? 'Ready to Mint' : 'Locked';
  E.btnMint.disabled = !canMint;
}

/* =========================
   RENDER ALL
========================= */
function renderAll(){
  renderSidebar();
  renderCenter();
  renderTabs();
  updateHeaderAndRight();
}

/* =========================
   WEB3: CONNECT / GATE / MINT
========================= */
let web3Modal, extProvider, provider, signer, token, account=null;
function setupWeb3(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { [CHAIN_ID]: RPC_URL }, chainId: CHAIN_ID }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:'dark' });
}

async function connect(){
  try{
    extProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(extProvider, 'any');
    signer = provider.getSigner(); account = await signer.getAddress();

    const net = await provider.getNetwork();
    if(net.chainId !== CHAIN_ID){
      try{ await extProvider.request({ method:'wallet_switchEthereumChain', params:[{ chainId: toHex(CHAIN_ID) }] }); }
      catch(e){
        await extProvider.request({ method:'wallet_addEthereumChain', params:[{
          chainId: toHex(CHAIN_ID), chainName: CHAIN_NAME,
          nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18},
          rpcUrls:[RPC_URL], blockExplorerUrls:['https://bscscan.com']
        }]}).catch(()=>{ alert(`Please switch to ${CHAIN_NAME}.`); throw e; });
      }
    }

    token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

    // UI wire
    E.btnConnect.classList.add('hide'); E.addrChip.classList.remove('hide');
    const short = `${account.slice(0,6)}‚Ä¶${account.slice(-4)}`;
    E.addrShort.textContent = short; E.addrFull.textContent = account; E.avatar.textContent = account.slice(2,4).toUpperCase();
    E.btnDisconnect.classList.remove('hide'); E.btnReconnect.classList.add('hide');

    // listeners
    extProvider.removeAllListeners?.();
    extProvider.on?.('accountsChanged', accs=>{ if(!accs?.length) return disconnect(); account=accs[0]; checkGate(); });
    extProvider.on?.('chainChanged', ()=>{ provider = new ethers.providers.Web3Provider(extProvider,'any'); signer = provider.getSigner(); token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider); checkGate(); });
    extProvider.on?.('disconnect', ()=> disconnect());

    await checkGate();
  }catch(err){ console.error(err); E.btnReconnect.classList.remove('hide'); }
}
async function disconnect(){
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  try{ if(extProvider?.disconnect && typeof extProvider.disconnect==='function'){ await extProvider.disconnect(); } }catch{}
  provider=signer=token=extProvider=null; account=null; accessGranted=false;
  E.btnConnect.classList.remove('hide'); E.addrChip.classList.add('hide'); E.btnDisconnect.classList.add('hide'); E.btnReconnect.classList.add('hide');
  E.addrFull.textContent='Not connected'; E.avatar.textContent='SM'; E.tokenBalance.textContent='‚Äî';
  renderAll();
}
async function checkGate(){
  try{
    const [raw, dec, sym] = await Promise.all([
      token.balanceOf(account),
      token.decimals().catch(()=>18),
      token.symbol().catch(()=> 'TOKEN')
    ]);
    tokenSymbolCached = sym || 'TOKEN';
    E.tokenSymbol.textContent = tokenSymbolCached;
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    E.tokenBalance.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:4})} ${tokenSymbolCached}`;
    accessGranted = bal >= REQUIRED_TOKENS;
    renderAll();
  }catch(e){ console.error('Gate read error', e); }
}

E.btnConnect.addEventListener('click', connect);
E.btnGateConnect.addEventListener('click', connect);
E.btnDisconnect.addEventListener('click', disconnect);
E.btnReconnect.addEventListener('click', connect);

/* =========================
   CERT MINT (placeholder wire)
========================= */
E.btnMint.addEventListener('click', async ()=>{
  const all = percentCompleted();
  if(all.done!==all.total) return;
  // Replace with your NFT mint call if needed.
  E.btnMint.disabled = true; E.mintStatus.textContent = 'Simulating mint‚Ä¶';
  await new Promise(r=>setTimeout(r,900));
  E.mintStatus.innerHTML = '<span style="color:#a5ffcf"><i class="fa-solid fa-check"></i> Minted!</span>';
  notifyOK('Certificate minted!');
});

/* =========================
   EVENTS ‚Äî FILTERS, SEARCH, TABS
========================= */
E.filters.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip'); if(!btn) return;
  setFilter(btn.dataset.filter);
});
E.search.addEventListener('input', e=>{ state.search = e.target.value; renderCenter(); });

// sidebar quick tabs
$$('.side-menu .sbtn[data-tab]').forEach(b=> b.addEventListener('click', ()=> { switchTab(b.dataset.tab); renderAll(); window.scrollTo({top:0, behavior:'smooth'}); }));

/* =========================
   ROUTING (hash)
========================= */
function route(){
  const hash = location.hash.replace(/^#\//,'');
  if(!hash){ switchTab('overview'); return; }
  const [kind,a,b] = hash.split('/');
  if(kind==='tab'){ switchTab(a||'overview'); return; }
  if(kind==='module' && a && b){ switchTab('syllabus'); openModule(a,b); return; }
  switchTab('overview');
}
window.addEventListener('hashchange', route);

/* =========================
   INIT
========================= */
function renderInitialMenus(){
  // left quick menus already bound; render area+modules in sidebar:
  renderSidebar();
}
function restoreOpenDetail(){
  const openKey = localStorage.getItem(STORAGE.OPEN);
  if(openKey){
    const [areaId, id] = openKey.split(':');
    if(areaId && id){ switchTab('syllabus'); openModule(areaId, id); }
  }
}
function renderAllFirst(){ renderInitialMenus(); renderAll(); }

document.addEventListener('DOMContentLoaded', ()=>{
  setupWeb3();
  renderAllFirst();
  route();
  restoreOpenDetail();
  if(window.Web3Modal && web3Modal?.cachedProvider){ connect().catch(()=>{}); }
});
</script>
</body>
</html>
