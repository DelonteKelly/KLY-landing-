<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sovereignty Mastery ‚Äî Aurora Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Token-gated sovereignty mastery program with Web3 integration" />

<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=General+Sans:wght@400;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- Motion & Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- Web3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
  :root{
    /* Aurora palette */
    --bg:#070a12; --bg2:#0b0f1c; --glass:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.08);
    --ink:#e9eefc; --muted:#b5c1de; --line:rgba(177,198,255,.16);
    --cyn:#7ae9ff; --vio:#8d7bff; --pnk:#ff77e1; --mint:#69ffb4; --sun:#ffc56b; --red:#ff5d6c;
    --ring:0 0 0 2px rgba(122,233,255,.25);
    --radius:16px; --radius-sm:12px; --shadow:0 18px 60px rgba(0,0,0,.45);
    --ease:cubic-bezier(.2,.7,.1,1); --time:.25s;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{scroll-behavior:smooth}
  body{
    margin:0; color:var(--ink);
    font-family:"General Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 800px at 10% -5%, rgba(122,233,255,.12), transparent 60%),
      radial-gradient(1000px 700px at 100% -20%, rgba(141,123,255,.12), transparent 60%),
      conic-gradient(from 210deg at 60% 0%, rgba(255,119,225,.07), transparent 40%),
      linear-gradient(180deg, var(--bg), var(--bg2) 55%, #070915);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  a{color:var(--cyn); text-decoration:none}
  a:hover{opacity:.9}
  button{font-family:inherit}

  /* Reduce motion respect */
  @media (prefers-reduced-motion:reduce){
    *{animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important}
  }

  /* Global shells */
  .shell{display:grid; grid-template-rows:auto 1fr auto; min-height:100vh}
  .top{
    position:sticky; top:0; z-index:50; backdrop-filter:blur(10px) saturate(1.05);
    background:linear-gradient(180deg, rgba(7,10,18,.9), rgba(7,10,18,.65));
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:14px 18px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand i{color:var(--cyn); filter:drop-shadow(0 0 10px rgba(122,233,255,.6))}
  .brand-title{font-family:"Space Grotesk"; font-weight:800; letter-spacing:.4px}
  .rchip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); color:#cfe2ff; background:var(--glass)}

  /* Buttons with animated gradient motion */
  .btn{
    --grad-x:0%;
    border:1px solid var(--line); color:var(--ink);
    background:linear-gradient(90deg, rgba(122,233,255,.18), rgba(141,123,255,.18));
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px;
    box-shadow:0 0 0 1px rgba(122,233,255,.12);
    transition:transform var(--time) var(--ease), box-shadow var(--time), background-position .6s var(--ease);
    background-size:200% 100%; background-position:var(--grad-x) 50%;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(141,123,255,.2); --grad-x:100%}
  .btn-ghost{background:transparent}

  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .hide{display:none!important}

  /* HERO ‚Äî cinematic landing */
  .hero{
    position:relative; overflow:hidden;
    border-bottom:1px solid var(--line);
    background:
      radial-gradient(1200px 800px at 10% -5%, rgba(122,233,255,.12), transparent 60%),
      radial-gradient(1200px 800px at 90% -10%, rgba(141,123,255,.12), transparent 60%);
  }
  .hero-wrap{max-width:1150px; margin:0 auto; padding:56px 18px 32px}
  .hero-grid{display:grid; grid-template-columns:1.2fr .8fr; gap:22px; align-items:center}
  @media (max-width:980px){ .hero-grid{grid-template-columns:1fr} }
  .hero-title{font-family:"Space Grotesk"; font-weight:800; letter-spacing:.4px; font-size:clamp(28px, 5vw, 48px); line-height:1.06; margin:0 0 10px}
  .hero-sub{color:var(--muted); margin:0 0 16px}
  .hero-cta{display:flex; gap:10px; flex-wrap:wrap}
  .hero-card{background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.03)); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow)}
  .callouts{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px}
  @media (max-width:780px){ .callouts{grid-template-columns:1fr} }
  .aurora-waves{
    position:absolute; inset:-20% -10% auto -10%; height:180px; pointer-events:none; opacity:.55;
    background:linear-gradient(90deg, rgba(122,233,255,.25), rgba(141,123,255,.2), rgba(255,119,225,.18));
    filter:blur(24px);
    animation:wave 9s var(--ease) infinite alternate;
  }
  @keyframes wave{
    0%{transform:translateY(0) skewX(-5deg)}
    100%{transform:translateY(-20px) skewX(5deg)}
  }
  /* Particle canvas (subtle) */
  #auroraParticles{position:absolute; inset:0; z-index:0; opacity:.25}

  /* MAIN LAYOUT */
  .main{display:grid; grid-template-columns:280px 1fr 320px; gap:18px; padding:18px}
  @media (max-width:1100px){ .main{grid-template-columns:1fr} }

  /* Panels */
  .panel{
    position:relative;
    background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.03));
    border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
  }
  .panel h3{margin:0 0 10px}

  /* Sidebar */
  .profile{display:flex; align-items:center; gap:12px; padding-bottom:12px; border-bottom:1px dashed var(--line); margin-bottom:12px}
  .avatar{width:48px; height:48px; border-radius:50%; display:grid; place-items:center; font-weight:800;
    background:
      radial-gradient(closest-side, #ffffff22 30%, #0000 60%),
      linear-gradient(135deg, var(--cyn), var(--vio));
    box-shadow:0 0 0 3px rgba(122,233,255,.15);
  }
  .side-menu{display:flex; flex-direction:column; gap:10px; margin-top:8px}
  .sbtn{
    width:100%; text-align:left; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
    background:rgba(255,255,255,.04); color:var(--ink); display:flex; align-items:center; gap:10px; cursor:pointer; transition:.2s var(--ease);
  }
  .sbtn:hover{transform:translateX(4px); border-color:rgba(122,233,255,.35)}
  .badge{min-width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
    background:rgba(122,233,255,.12); border:1px solid rgba(122,233,255,.25); color:#bff1ff; font-weight:800;
  }
  .tag{margin-left:auto; background:linear-gradient(90deg, var(--mint), var(--cyn)); color:#06101a; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}

  /* Center */
  .searchbar{display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.06); border:1px solid var(--line); padding:8px 12px; border-radius:999px}
  .searchbar input{flex:1; background:transparent; border:0; color:var(--ink); outline:none}
  .filter-row{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px}
  .chip{background:rgba(255,255,255,.06); border:1px solid var(--line); color:#cfe2ff; border-radius:999px; padding:6px 10px; cursor:pointer}
  .chip.active{background:linear-gradient(90deg, var(--cyn), var(--vio)); color:#06101a; border:0}

  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--line); border-radius:var(--radius-sm); padding:14px; display:flex; flex-direction:column; gap:10px; position:relative; overflow:hidden;
  }
  .card:hover{border-color:rgba(141,123,255,.5)}
  .card.lock{opacity:.85}
  .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .muted{color:var(--muted)}
  .progress{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--cyn), #b0a8ff, var(--pnk)); width:0%; transition:width .5s var(--ease)}

  /* Lock overlay + preview */
  .lock-overlay{
    position:absolute; inset:0; display:grid; place-items:center;
    background:linear-gradient(180deg, rgba(7,10,18,.4), rgba(7,10,18,.65));
    backdrop-filter:blur(2px);
  }
  .lock-box{
    display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center;
    background:rgba(255,255,255,.06); border:1px dashed var(--line); padding:12px; border-radius:12px;
  }
  .preview-snippet{max-height:64px; overflow:hidden; mask-image:linear-gradient(180deg, #000 60%, transparent); font-size:13px}

  .detail{margin-top:12px; border:1px solid var(--line); border-radius:var(--radius); padding:18px; display:none}
  .detail.show{display:block}
  .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; color:#cfe2ff}
  .pill.ready{border-color:rgba(105,255,180,.4); color:#c4ffe3}
  .lesson{background:rgba(122,233,255,.08); border-left:3px solid var(--cyn); padding:12px; border-radius:0 10px 10px 0; margin:10px 0}

  /* Right column: gate + cert */
  .ring{--p:0; --size:88px; width:var(--size); height:var(--size); border-radius:50%;
    background:
      radial-gradient(closest-side,#0000 78%,#0000 0 99%,#0000 0),
      conic-gradient(var(--mint) var(--p), #23273a 0);
    position:relative; transition:background .6s var(--ease);
  }
  .ring::before{
    content:attr(data-label); position:absolute; inset:8px; border-radius:50%; display:grid; place-items:center; color:#a8f9ff;
    border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    font-weight:800;
  }
  .cert-img{border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.45)}
  .cert-img img{display:block; width:100%}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(7,10,18,.86); backdrop-filter:blur(10px); z-index:1000}
  .modal.show{display:grid}
  .modal-card{width:min(900px,90vw); max-height:90vh; overflow:auto; background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:18px; padding:18px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); padding-bottom:10px; margin-bottom:12px}
  .x{background:transparent; border:0; color:var(--ink); cursor:pointer}
  .x:hover{color:var(--red)}

  /* Conversion sections */
  .section{padding:24px 18px; border-top:1px solid var(--line)}
  .faq dt{font-weight:800; margin-top:12px}
  .faq dd{margin:6px 0 12px; color:var(--muted)}
  .testis{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px}
  .quote{border:1px solid var(--line); border-radius:12px; padding:14px; background:rgba(255,255,255,.04)}
  .pricing{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px}
  .price-card{border:1px solid var(--line); border-radius:14px; padding:16px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))}
  .price{font-size:28px; font-weight:800}

  /* Footer */
  footer{border-top:1px solid var(--line); padding:16px 18px; color:var(--muted); text-align:center}

  /* Mobile nudges */
  @media (max-width:860px){
    .topbar{gap:8px}
    .rchip.hide-sm{display:none}
  }
</style>
</head>
<body>
<div class="shell">

  <!-- HEADER -->
  <header class="top">
    <div class="wrap topbar" role="navigation" aria-label="Global">
      <div class="brand">
        <i class="fa-solid fa-crown"></i>
        <div>
          <div class="brand-title">Sovereignty Mastery</div>
          <small class="muted">Aurora Edition</small>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <span id="chip-progress" class="rchip hide-sm"><i class="fa-solid fa-chart-simple"></i><span id="chip-text">0/21 Complete</span></span>
        <span id="xp-chip" class="rchip hide-sm"><i class="fa-solid fa-bolt"></i><span id="xp-text">0 XP</span></span>
        <button id="btn-connect" class="btn"><i class="fa-solid fa-wallet"></i> Connect</button>
        <span id="addr-chip" class="rchip addr hide" aria-live="polite"><i class="fa-solid fa-user-astronaut"></i><span id="addr-short">0x‚Ä¶</span></span>
      </div>
    </div>
  </header>

  <!-- üîÆ HERO / LANDING -->
  <section class="hero" id="hero">
    <canvas id="auroraParticles" aria-hidden="true"></canvas>
    <div class="aurora-waves"></div>
    <div class="hero-wrap">
      <div class="hero-grid">
        <div>
          <h1 class="hero-title">Reclaim Your Authority.<br/>Live Sovereign.</h1>
          <p class="hero-sub">
            Sovereignty Mastery is a token-gated path into inner authority, aligned decision-making, and embodied leadership.
            Web3 access proves ownership and unlocks the Sovereign track when you hold the required tokens.
          </p>
          <div class="hero-cta">
            <button id="hero-connect" class="btn"><i class="fa-solid fa-plug-circle-bolt"></i> Connect Wallet & Begin</button>
            <a href="#dashboard" class="btn btn-ghost"><i class="fa-regular fa-circle-play"></i> Preview the Curriculum</a>
          </div>
          <div class="callouts">
            <div class="hero-card"><strong>Why Web3?</strong><div class="muted">Ownership, portability, and on-chain proof of progress.</div></div>
            <div class="hero-card"><strong>Gate Logic</strong><div class="muted">Hold tokens ‚Üí unlock Sovereign modules.</div></div>
            <div class="hero-card"><strong>On-chain Certificate</strong><div class="muted">Mint an ERC-721 NFT when complete.</div></div>
          </div>
        </div>
        <div class="hero-card">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <strong>Access Status</strong>
            <div class="ring" id="hero-ring" data-label="0%"></div>
          </div>
          <p id="hero-msg" class="muted" style="margin:8px 0 0">Connect wallet to explore Sovereignty Mastery.</p>
          <div style="display:flex; gap:8px; margin-top:10px">
            <span class="rchip"><i class="fa-solid fa-coins"></i> Required: <strong style="margin-left:6px" id="req-tokens">5</strong></span>
            <span class="rchip"><i class="fa-solid fa-shield"></i> Chain: BNB</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <div class="wrap main" id="dashboard">

    <!-- LEFT: SIDEBAR -->
    <aside class="panel" aria-label="Navigation">
      <div class="profile">
        <div class="avatar" id="avatar">SM</div>
        <div>
          <div style="font-weight:800">Learner</div>
          <div id="addr-full" class="addr muted">Not connected</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:10px">
        <button id="btn-disconnect" class="btn btn-ghost hide"><i class="fa-solid fa-right-from-bracket"></i> Disconnect</button>
        <button id="btn-reconnect" class="btn btn-ghost hide"><i class="fa-solid fa-plug-circle-bolt"></i> Reconnect</button>
      </div>

      <h3 style="margin-top:4px">Areas</h3>
      <div id="menu" class="side-menu"></div>

      <h3 style="margin-top:16px">Shortcuts</h3>
      <div class="side-menu">
        <button class="sbtn" data-tab="overview"><i class="fa-regular fa-grid-2"></i> Overview <span class="tag">Home</span></button>
        <button class="sbtn" data-tab="syllabus"><i class="fa-regular fa-list-check"></i> Syllabus <span class="tag">All</span></button>
        <button class="sbtn" data-tab="progress"><i class="fa-regular fa-chart-line"></i> Progress <span class="tag">Stats</span></button>
        <button class="sbtn" data-tab="resources"><i class="fa-regular fa-folder-open"></i> Resources <span class="tag">Links</span></button>
      </div>
    </aside>

    <!-- CENTER: CURRICULUM -->
    <main class="panel" aria-live="polite">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div class="searchbar" role="search"><i class="fa-solid fa-magnifying-glass"></i><input id="search" type="search" placeholder="Search modules, themes, objectives‚Ä¶" aria-label="Search modules"></div>
        <div class="filter-row" id="filters">
          <button class="chip active" data-filter="all">All</button>
          <button class="chip" data-filter="core">Core</button>
          <button class="chip" data-filter="sovereign">Sovereign</button>
          <button class="chip" data-filter="not-started">Not started</button>
          <button class="chip" data-filter="in-progress">In progress</button>
          <button class="chip" data-filter="completed">Completed</button>
        </div>
      </div>

      <div id="views">
        <!-- Overview -->
        <section id="view-overview">
          <div id="grid-overview" class="grid" role="list"></div>
        </section>

        <!-- Syllabus -->
        <section id="view-syllabus" class="hide">
          <div id="grid-syllabus" class="grid" role="list"></div>
        </section>

        <!-- Progress -->
        <section id="view-progress" class="hide">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
            <div class="card">
              <div class="row"><strong>Total Completion</strong><span class="pill" id="pill-total">0%</span></div>
              <div class="progress"><span id="bar-total"></span></div>
              <div class="muted"><span id="done-total">0</span>/<span id="count-total">0</span> modules</div>
            </div>
            <div class="card">
              <div class="row"><strong>Core</strong><span class="pill" id="pill-core">0%</span></div>
              <div class="progress"><span id="bar-core"></span></div>
              <div class="muted"><span id="done-core">0</span>/<span id="count-core">0</span></div>
            </div>
            <div class="card">
              <div class="row"><strong>Sovereign</strong><span class="pill" id="pill-sov">0%</span></div>
              <div class="progress"><span id="bar-sov"></span></div>
              <div class="muted"><span id="done-sov">0</span>/<span id="count-sov">0</span></div>
            </div>

            <!-- üìä Gamification cards -->
            <div class="card">
              <div class="row"><strong>XP</strong><span class="pill" id="pill-xp">0</span></div>
              <div class="muted">Earn +50 XP per module completion. <span id="streak-text" class="pill" style="margin-left:6px">Streak: 0</span></div>
            </div>
            <div class="card">
              <div class="row"><strong>Rank</strong><span class="pill" id="pill-rank">‚Äî</span></div>
              <div class="muted" id="rank-desc">Complete more to boost your rank.</div>
            </div>
          </div>
          <div id="grid-progress" class="grid" style="margin-top:12px"></div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="hide">
          <div class="card">
            <h3 style="margin:6px 0 8px">Resources & Downloads</h3>
            <ul class="muted">
              <li>üìù Worksheets: Sovereignty Audit, Resource Audit, Boundaries Scripts</li>
              <li>üéß Practices: Deep Listening, Micro-Surrender, Box Breathing (4-4-6-2)</li>
              <li>üìö Reading: Presence, Nonviolent Communication, Essentialism</li>
            </ul>
          </div>
        </section>
      </div>

      <!-- Detail (inline) -->
      <section id="detail" class="detail" aria-describedby="detail-title">
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <div style="display:flex; align-items:center; gap:10px">
            <div class="badge" id="detail-num">1</div>
            <h3 id="detail-title" style="margin:0">Module</h3>
          </div>
        <span class="pill" id="detail-area">Area</span>
        <span class="pill" id="detail-status">Not Started</span>
        <span class="pill" id="detail-theme">Theme</span>
        </div>
        <div id="detail-body" style="margin-top:8px"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn btn-ghost" id="btn-prev"><i class="fa-solid fa-arrow-left-long"></i> Prev</button>
          <div style="flex:1"></div>
          <button class="chip" id="btn-mark"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
          <button class="btn" id="btn-full"><i class="fa-regular fa-expand"></i> Full View</button>
          <button class="btn btn-ghost" id="btn-next">Next <i class="fa-solid fa-arrow-right-long"></i></button>
        </div>
      </section>
    </main>

    <!-- RIGHT: GATE + CERT -->
    <aside class="panel" aria-label="Access & Certificate">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Access Gate</h3>
        <div class="ring" id="ring" data-label="0%"></div>
      </div>
      <p class="muted" id="gate-note">Connect wallet to explore Sovereignty Mastery.</p>
      <div class="card">
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center">
            <i class="fa-solid fa-coins" style="color:var(--mint)"></i>
            <div><div class="muted">Your balance</div><strong id="token-balance">‚Äî</strong></div>
          </div>
          <button id="btn-gate-connect" class="btn btn-ghost"><i class="fa-solid fa-plug-circle-bolt"></i> Connect</button>
        </div>
      </div>

      <h3 style="margin:12px 0 8px">Certificate</h3>
      <div class="cert-img"><img src="https://blush-worthy-ape-39.mypinata.cloud/ipfs/bafybeidmaskps5ouvljx7li667xnvalle566d577vixhtj5rejphrx5bua/Key%20of%20Ascension.PNG" alt="Certificate"/></div>
      <div class="row" style="margin:10px 0"><span class="muted">Status</span><strong id="cert-status">Locked</strong></div>
      <div class="row" style="margin:6px 0"><span class="muted">Progress</span><strong id="cert-progress">0 / 21</strong></div>
      <button class="btn" id="btn-mint" disabled><i class="fa-solid fa-certificate"></i> Mint Certificate</button>
      <div id="mint-status" class="muted" style="margin-top:8px"></div>

      <!-- Metadata preview -->
      <div id="nft-preview" class="card" style="margin-top:12px; display:none">
        <div class="row"><strong>Certificate Preview</strong><span class="pill" id="nft-edition">Edition ‚Äî</span></div>
        <div class="muted" id="nft-name">‚Äî</div>
        <div class="muted" id="nft-attrs" style="margin-top:6px">Attributes: ‚Äî</div>
        <div id="share-wrap" style="margin-top:10px; display:none">
          <a id="share-x" class="btn btn-ghost" target="_blank" rel="noopener"><i class="fa-brands fa-x-twitter"></i> Share on X</a>
        </div>
      </div>
    </aside>

  </div>

  <!-- üîó Conversion Sections -->
  <section class="section wrap">
    <h3>FAQ</h3>
    <dl class="faq">
      <dt>What is token-gated access?</dt>
      <dd>Holding the required tokens unlocks the Sovereign track automatically when your wallet is connected.</dd>
      <dt>Which chain?</dt>
      <dd>BNB Smart Chain (BSC). You‚Äôll be prompted to switch or add the network if needed.</dd>
      <dt>Do I need crypto to learn?</dt>
      <dd>No. You can preview Core content and locked lesson snippets without tokens.</dd>
    </dl>
  </section>

  <section class="section wrap">
    <h3>What Learners Say</h3>
    <div class="testis">
      <blockquote class="quote">‚ÄúThis program gave me language and structure for power I always felt but couldn‚Äôt name.‚Äù ‚Äî <strong>Amara</strong></blockquote>
      <blockquote class="quote">‚ÄúThe daily practices + Web3 proof of progress hit different.‚Äù ‚Äî <strong>Jalen</strong></blockquote>
      <blockquote class="quote">‚ÄúSovereignty finally feels embodied, not theoretical.‚Äù ‚Äî <strong>Rae</strong></blockquote>
    </div>
  </section>

  <section class="section wrap">
    <h3>Access Tiers</h3>
    <div class="pricing">
      <div class="price-card">
        <div class="price">Free</div>
        <div class="muted">Preview Core lessons, see Sovereign snippets.</div>
      </div>
      <div class="price-card">
        <div class="price">Sovereign</div>
        <div class="muted">Hold required tokens to unlock all modules + on-chain certificate.</div>
      </div>
    </div>
  </section>

  <footer>¬© Sovereignty Mastery ‚Äî Built with love & Web3 ‚ú®</footer>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="modal-title" style="margin:0; display:flex; align-items:center; gap:10px"><span class="badge" id="modal-num">1</span> <span id="modal-name">Module</span></h3>
      <button class="x" id="modal-close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG ‚Äî TOKEN GATE + NFT
========================= */
const TOKEN_ADDRESS    = '0x7a732Ae6b2Db2ceACc3Ffe6F63F3B9B0Ce94A026'; // ERC-20
const REQUIRED_TOKENS  = 5;
const CHAIN_ID         = 56;  // BNB Smart Chain
const CHAIN_NAME       = 'BNB Smart Chain';
const RPC_URL          = 'https://bsc-dataseed.binance.org';

const NFT_ADDRESS      = '0xDA76d35742190283E340dbeE2038ecc978a56950'; // ERC-721 (Thirdweb-style)
const TOKEN_URI        = 'ipfs://bafybeifssvwf74gv25c3r76cxfdqraerll7l4kgruqaox6cskrqsu2e2by';

/* Minimal ABIs */
const ERC20_ABI       = ['function balanceOf(address) view returns (uint256)','function decimals() view returns (uint8)','function symbol() view returns (string)'];
const ERC721_MINT_ABI = ['function mintTo(address _to, string _uri) payable'];

/* Utils */
const toHex = (n)=>'0x'+Number(n).toString(16);
function showError(msg){
  console.error(msg);
  const el = document.getElementById('gate-note');
  if(el) el.innerHTML = `<span style="color:#ff9aa8"><i class="fa-solid fa-triangle-exclamation"></i> ${msg}</span>`;
}

/* =========================
   COURSE DATA (Core 7 + Sovereign 14)
   (same base content; snippets added)
========================= */
const COURSE = {
  areas: [
    {
      id:'core', name:'Core Program', description:'7-module path to awakening & embodiment', modules: [
        { id:'1', order:1, title:'Foundations of Self-Awareness', theme:'Becoming the Observer',
          objectives:['Lost-in-thought vs observing thought','Daily mindfulness practices','Journaling for clarity','3-Layer Belief Audit'],
          preview:`Self-awareness is the doorway. Learn to witness thoughts without getting pulled under.`,
          content:`<h3>Core Concept</h3><p>Self-awareness is the foundation of awakening‚Äîstepping out of unconscious streams to observe with clarity and compassion.</p>
                   <div class="lesson"><strong>Practice ‚Äî Thought Observation</strong><p>Set a 5-minute timer and label thoughts ‚Äúthinking‚Ä¶‚Äù as they arise. Let them pass.</p></div>
                   <h3>Journaling</h3><ul><li>What thoughts keep recurring?</li><li>What emotions am I skipping?</li><li>Where did I operate on autopilot?</li></ul>` },
        { id:'2', order:2, title:'Breaking the Illusion of Ego', theme:'You Are Not Your Story',
          objectives:['Ego vs Essence','Roles & labels','Silent Watcher practice','Ego defenses'],
          preview:`See through roles and labels. Meet the silent watcher beyond identity.`,
          content:`<h3>Core Concept</h3><p>See through roles and labels; meet the silent watcher beyond narrative identity.</p>
                   <div class="lesson"><strong>Practice ‚Äî Identity Inventory</strong><p>List identities you wear; ask: ‚ÄúWithout this, am I still here?‚Äù</p></div>` },
        { id:'3', order:3, title:'Entering the Now', theme:'Presence is Power',
          objectives:['Past/Future fixation','Sensory anchoring','Listening as meditation','Finding the silent gap'],
          preview:`Anchor attention in breath and senses; reclaim power from past/future loops.`,
          content:`<h3>Core Concept</h3><p>Anchor attention in breath and senses; find the gap between thoughts.</p>
                   <div class="lesson"><strong>Practice ‚Äî Deep Listening</strong><p>Offer another your full attention; return to pure hearing whenever mind wanders.</p></div>` },
        { id:'4', order:4, title:'Surrender & Emotional Alchemy', theme:'Freedom Through Letting Go',
          objectives:['What surrender is','Somatic flow of emotion','3-Step alchemy','Forgiveness as liberation'],
          preview:`Transmute emotion by allowing, feeling, and releasing. Freedom is in the letting go.`,
          content:`<h3>Core Concept</h3><p>Transmute emotion by allowing, feeling, and releasing.</p>
                   <div class="lesson"><strong>Practice ‚Äî Micro-Surrender</strong><p>Choose one irritation today; say a conscious ‚Äúyes‚Äù to it and feel the shift.</p></div>` },
        { id:'5', order:5, title:'The Illusion of Separation', theme:'Remembering Oneness',
          objectives:['Seeing through duality','Relational mirrors','Nature as teacher','Entanglement & connection'],
          preview:`See the unity behind duality; meet relationships and nature as mirrors.`,
          content:`<h3>Core Concept</h3><p>See the unity behind duality; meet relationships and nature as mirrors.</p>` },
        { id:'6', order:6, title:'Embodied Enlightenment', theme:'Wisdom in Action',
          objectives:['Transcendence ‚Üí integration','4 pillars of embodiment','Shadow & wholeness','Chop wood, carry water'],
          preview:`Bring realization into rhythm. Design practices that keep truth alive in motion.`,
          content:`<h3>Core Concept</h3><p>Integrate realization into daily life: design rhythms, embrace shadow, act with presence.</p>` },
        { id:'7', order:7, title:'Living as Awareness', theme:'The Unfolding Mystery',
          objectives:['Form & formlessness','Flow & spontaneity','Gift of impermanence','Beyond seeking'],
          preview:`Rest as awareness; move with spontaneity and ease.`,
          content:`<h3>Core Concept</h3><p>Rest as awareness; move with spontaneity, impermanence, and effortless action.</p>` }
      ]
    },
    {
      id:'sovereign', name:'The Sovereign Self', description:'14-module journey into inner authority & stewardship', modules: [
        { id:'sv1',order:1, title:'Foundation of Sovereignty', theme:'Understanding Personal Power',
          objectives:['Roots of sovereignty','Where you surrendered authority','Ego vs soul power','Daily practice','Declaration'],
          preview:`Sovereignty is your birthright: clean authority over thought, emotion, choice, energy.`,
          content:`<h3>Core Concept</h3><p>Sovereignty is your birthright to complete authority over your being‚Äîthoughts, emotions, choices, energy.</p>
                   <div class="lesson"><strong>Action:</strong> Reclaim one area within 48 hours.</div>` },
        { id:'sv2',order:2, title:'Boundaries & Energy Protection', theme:'Creating Safe Containers',
          objectives:['Map patterns','Guilt-free limits','Protection techniques','Respond to violations','Context rules'],
          preview:`Boundaries define where you end & others begin. Craft them without guilt.`,
          content:`<h3>Core Concept</h3><p>Boundaries define where you end & others begin.</p>` },
        { id:'sv3',order:3, title:'Authentic Decision Making', theme:'Listening to Inner Wisdom',
          objectives:['Spot fear patterns','Guidance rituals','Decondition reactivity','Values filters','Act on intuition'],
          preview:`Aligned choices emerge from values, body wisdom, and intuition.`,
          content:`<h3>Core Concept</h3><p>Aligned choices emerge from values, body wisdom, and intuition.</p>` },
        { id:'sv4',order:4, title:'Sovereign Communication', theme:'Expressing Truth with Power',
          objectives:['Express needs','Active listening','Center conflict','Release blame','Language upgrades'],
          preview:`Truth + compassion + clarity ‚Äî without attachment to outcome.`,
          content:`<h3>Core Concept</h3><p>Clarity + compassion + conviction‚Äîwithout attachment to outcome.</p>` },
        { id:'sv5',order:5, title:'Financial Sovereignty', theme:'Wealth as Energy Exchange',
          objectives:['Audit beliefs','Align income','Spend by values','Flow mindset','Systems'],
          preview:`Shift from scarcity to stewardship; architect systems for freedom.`,
          content:`<h3>Core Concept</h3><p>Shift from scarcity to stewardship; build systems for freedom.</p>` },
        { id:'sv6',order:6, title:'Sovereign Relationships', theme:'Connecting Without Losing Self',
          objectives:['Spot patterns','Self-connection','Mutual respect','Closeness/space','Ask clearly'],
          preview:`Intimacy with autonomy: presence without enmeshment.`,
          content:`<h3>Core Concept</h3><p>Intimacy with autonomy; presence without enmeshment.</p>` },
        { id:'sv7',order:7, title:'Living as Sovereign Being', theme:'Integration & Mastery',
          objectives:['Daily ritualization','Resilience','Environment design','Aligned default','Intentional creation'],
          preview:`Make sovereignty your default operating system.`,
          content:`<h3>Core Concept</h3><p>Make sovereignty your default OS.</p>` },
        { id:'sv8',order:8, title:'Lawful Foundations', theme:'Rights, Duties, Jurisdiction',
          objectives:['Rights vs privileges','Jurisdictions','Identity docs','Lawful comms','Records'],
          preview:`Distinguish frameworks and act accordingly.`,
          content:`<h3>Core Concept</h3><p>Distinguish frameworks and act accordingly.</p>` },
        { id:'sv9',order:9, title:'Status Correction Essentials', theme:'Identity, Notice, Standing',
          objectives:['Map status','Declarations','Timelines','Consistency','Avoid contradictions'],
          preview:`Clean declarations + consistent conduct.`,
          content:`<h3>Core Concept</h3><p>Clean declarations + consistent conduct.</p>` },
        { id:'sv10',order:10, title:'Affidavits & Notices', theme:'Truth in the Record',
          objectives:['Structure','Facts not fluff','Service','Track responses','Close loop'],
          preview:`Affidavits are sworn truth; notices create process.`,
          content:`<h3>Core Concept</h3><p>Affidavits are sworn truth; notices create process.</p>` },
        { id:'sv11',order:11, title:'Trusts & PMA', theme:'Private Structures',
          objectives:['Purpose','Roles & duties','Bylaws','Separate capacities','Minutes & records'],
          preview:`Structure stewardship & community privately.`,
          content:`<h3>Core Concept</h3><p>Structure stewardship & community.</p>` },
        { id:'sv12',order:12, title:'Right to Travel (Education)', theme:'Safety, Notice, Documentation',
          objectives:['ID packet','Calm scripts','Escalation','Recording','Debrief'],
          preview:`Preparation turns pressure into poise.`,
          content:`<h3>Core Concept</h3><p>Preparation turns pressure into poise.</p>` },
        { id:'sv13',order:13, title:'Commercial Remedies (Education)', theme:'Invoices, Liens, Cures',
          objectives:['Remedy ladder','Notices before claims','Track timelines','Avoid frivolous','Seek counsel'],
          preview:`Match remedy to facts and forum.`,
          content:`<h3>Core Concept</h3><p>Match remedy to facts and forum.</p>` },
        { id:'sv14',order:14, title:'Record & Publish', theme:'Make it Real in the World',
          objectives:['Choose venues','Organize repos','Consistent formats','Versioning','Cold backups'],
          preview:`Records are the spine of sovereignty.`,
          content:`<h3>Core Concept</h3><p>Records are the spine of sovereignty.</p>` }
      ]
    }
  ]
};

/* =========================
   STATE, ELEMENTS, STORAGE
========================= */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const STORAGE = { PROGRESS:'sv_progress_v4', OPEN:'sv_open_v1', XP:'sv_xp_v1', STREAK:'sv_streak_v1' };

let accessGranted=false, tokenSymbolCached='TOKEN';
let state={ tab:'overview', filter:'all', search:'', openId:null };
let web3Modal, extProvider, provider, signer, token, account=null;

const E = {
  // header + hero
  btnConnect: $('#btn-connect'), heroConnect: $('#hero-connect'),
  addrChip: $('#addr-chip'), addrShort: $('#addr-short'),
  chipText: $('#chip-text'), xpChip: $('#xp-chip'), xpText: $('#xp-text'),
  heroMsg: $('#hero-msg'), heroRing: $('#hero-ring'), reqTokens: $('#req-tokens'),
  // sidebar
  avatar: $('#avatar'), addrFull: $('#addr-full'),
  btnDisconnect: $('#btn-disconnect'), btnReconnect: $('#btn-reconnect'),
  menu: $('#menu'),
  // center
  filters: $('#filters'), search: $('#search'),
  viewOverview: $('#view-overview'), viewSyllabus: $('#view-syllabus'), viewProgress: $('#view-progress'), viewResources: $('#view-resources'),
  gridOverview: $('#grid-overview'), gridSyllabus: $('#grid-syllabus'), gridProgress: $('#grid-progress'),
  detail: $('#detail'), detailNum: $('#detail-num'), detailTitle: $('#detail-title'),
  detailArea: $('#detail-area'), detailStatus: $('#detail-status'), detailTheme: $('#detail-theme'), detailBody: $('#detail-body'),
  btnPrev: $('#btn-prev'), btnNext: $('#btn-next'), btnFull: $('#btn-full'), btnMark: $('#btn-mark'),
  // right
  ring: $('#ring'), tokenBalance: $('#token-balance'), tokenSymbol: $('#tokenSymbol'),
  btnGateConnect: $('#btn-gate-connect'), certStatus: $('#cert-status'), certProgress: $('#cert-progress'),
  btnMint: $('#btn-mint'), mintStatus: $('#mint-status'),
  // progress KPIs
  pillTotal: $('#pill-total'), barTotal: $('#bar-total'), doneTotal: $('#done-total'), countTotal: $('#count-total'),
  pillCore: $('#pill-core'), barCore: $('#bar-core'), doneCore: $('#done-core'), countCore: $('#count-core'),
  pillSov: $('#pill-sov'), barSov: $('#bar-sov'), doneSov: $('#done-sov'), countSov: $('#count-sov'),
  // gamification
  pillXP: $('#pill-xp'), streakText: $('#streak-text'), pillRank: $('#pill-rank'), rankDesc: $('#rank-desc'),
  // modal
  modal: $('#modal'), modalClose: $('#modal-close'),
  modalNum: $('#modal-num'), modalName: $('#modal-name'), modalBody: $('#modal-body'),
  // nft preview
  nftPreview: $('#nft-preview'), nftName: $('#nft-name'), nftAttrs: $('#nft-attrs'), nftEdition: $('#nft-edition'), shareWrap: $('#share-wrap'), shareX: $('#share-x'),
};
if(E.reqTokens) E.reqTokens.textContent = REQUIRED_TOKENS;

/* =========================
   HELPERS: Progress / XP / Streak
========================= */
function allModules(){ return COURSE.areas.flatMap(a => a.modules.map(m => ({...m, areaId:a.id, areaName:a.name}))); }
function progressLoad(){ try{return JSON.parse(localStorage.getItem(STORAGE.PROGRESS))||{}}catch{return{}} }
function progressSave(p){ localStorage.setItem(STORAGE.PROGRESS, JSON.stringify(p)); }
function keyOf(m){ return `${m.areaId}:${m.id}` }
function progressOf(m){ const p=progressLoad(); return p[keyOf(m)]||{status:'not-started', percent:0} }
function setProgress(m, status){
  const p = progressLoad(); const k = keyOf(m);
  const prev = p[k] || {percent:0};
  p[k] = { status, percent: status==='completed' ? 100 : status==='in-progress' ? Math.max(prev.percent,25) : 0 };
  progressSave(p);
  if(status==='completed' && prev.percent<100){ addXP(50); tickStreak(); }
  renderAll();
}
function percentCompleted(areaId){
  const mods = allModules().filter(m => !areaId || m.areaId===areaId);
  const done = mods.filter(m => progressOf(m).status==='completed').length;
  return {done, total:mods.length, pct:mods.length ? Math.round(done/mods.length*100) : 0};
}
function gateLocked(areaId){ return areaId==='sovereign' && !accessGranted; }
function notifyOK(msg){ if(typeof confetti==='function'){ confetti({particleCount:90, spread:64, origin:{y:.85}, colors:["#7ae9ff","#8d7bff","#69ffb4"]}); } console.log(msg); }
function loadXP(){ return Number(localStorage.getItem(STORAGE.XP)||0); }
function saveXP(v){ localStorage.setItem(STORAGE.XP, String(v)); }
function addXP(n){ const v=loadXP()+n; saveXP(v); }
function loadStreak(){ try{return JSON.parse(localStorage.getItem(STORAGE.STREAK))||{count:0,last:''}}catch{return{count:0,last:''}} }
function saveStreak(s){ localStorage.setItem(STORAGE.STREAK, JSON.stringify(s)); }
function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
function tickStreak(){
  const s=loadStreak(); const t=todayStr();
  if(s.last===t) return;
  const last = s.last ? new Date(s.last) : null;
  const diff = last ? Math.round((new Date(t)-last)/86400000) : null;
  s.count = diff===1 ? s.count+1 : 1;
  s.last=t; saveStreak(s);
}

/* =========================
   RENDER ‚Äî SIDEBAR, CARDS, LISTS, PROGRESS
========================= */
function renderSidebar(){
  E.menu.innerHTML='';
  COURSE.areas.forEach(area=>{
    const head = document.createElement('button');
    head.className='sbtn'; head.innerHTML=`<i class="fa-solid fa-layer-group"></i> ${area.name} <span class="tag">${area.modules.length}</span>`;
    head.onclick = ()=>{ switchTab('syllabus'); setFilter(area.id); };
    E.menu.appendChild(head);
    area.modules.forEach(m=>{
      const st = progressOf({areaId:area.id, id:m.id}).status;
      const badge = st==='completed' ? '<i class="fa-solid fa-check"></i>' : st==='in-progress' ? '‚Ä¢' : '‚Äì';
      const btn = document.createElement('button');
      btn.className='sbtn'; if(gateLocked(area.id)) btn.classList.add('lock');
      btn.innerHTML = `<span class="badge" title="${st}">${badge}</span> <strong>${area.id==='core'?m.order:m.id.replace('sv','')}</strong> ${m.title} <span class="tag">${area.id==='core'?'Core':'Sovereign'}</span>`;
      btn.onclick = ()=> gateLocked(area.id) ? E.btnGateConnect.click() : openModule(area.id, m.id);
      E.menu.appendChild(btn);
    });
  });
}
function matchFilters(m){
  const st = progressOf(m).status;
  const f = state.filter;
  const byStatus = f==='all' ? true :
    f==='not-started'? st==='not-started' :
    f==='in-progress'? st==='in-progress' :
    f==='completed'? st==='completed' :
    f===m.areaId;
  const s = state.search.trim().toLowerCase();
  const bySearch = !s || [m.title, m.theme, ...(m.objectives||[]), m.preview||''].join(' ').toLowerCase().includes(s);
  return byStatus && bySearch;
}
function cardFor(m){
  const p = progressOf(m);
  const el = document.createElement('div');
  el.className = 'card' + (gateLocked(m.areaId)?' lock':'');
  el.setAttribute('role','listitem');
  el.innerHTML = `
    <div class="row">
      <div style="display:flex; gap:10px; align-items:center">
        <div class="badge">${m.areaId==='core'?m.order:m.id.replace('sv','')}</div>
        <div><strong>${m.title}</strong><div class="muted">${m.theme}</div></div>
      </div>
      <span class="pill">${m.areaId==='core'?'Core':'Sovereign'}</span>
    </div>
    <div class="muted preview-snippet">${m.preview||'‚Äî'}</div>
    <div class="progress" aria-hidden="true"><span style="width:${p.percent}%"></span></div>
    <div class="row">
      <span class="muted">${p.status==='completed'?'Completed':p.status==='in-progress'?'In Progress':'Not Started'}</span>
      <div style="display:flex; gap:8px">
        <button class="chip" data-act="in">Mark In-Progress</button>
        <button class="btn" data-act="open"><i class="fa-regular fa-book-open"></i> ${gateLocked(m.areaId)?'Unlock':'Open'}</button>
      </div>
    </div>
  `;
  el.querySelector('[data-act="in"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : setProgress(m,'in-progress');
  el.querySelector('[data-act="open"]').onclick = ()=> gateLocked(m.areaId) ? E.btnGateConnect.click() : openModule(m.areaId, m.id);

  if(gateLocked(m.areaId)){
    const overlay = document.createElement('div'); overlay.className='lock-overlay';
    overlay.innerHTML = `
      <div class="lock-box">
        <i class="fa-solid fa-lock"></i>
        <div><strong>Locked</strong></div>
        <div class="muted" style="max-width:360px">You hold <span id="overlay-hold">0</span> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock Sovereign track.</div>
        <button class="btn btn-ghost" data-act="connect"><i class="fa-solid fa-plug-circle-bolt"></i> Connect</button>
      </div>`;
    overlay.querySelector('[data-act="connect"]').onclick = ()=> E.btnGateConnect.click();
    el.appendChild(overlay);
  }
  return el;
}
function renderOverview(){
  E.gridOverview.innerHTML = '';
  allModules().filter(matchFilters).sort((a,b)=> (a.areaId===b.areaId ? (a.order||0)-(b.order||0) : a.areaId.localeCompare(b.areaId))).forEach(m=>{
    E.gridOverview.appendChild(cardFor(m));
  });
}
function renderSyllabus(){
  E.gridSyllabus.innerHTML = '';
  COURSE.areas.forEach(area=>{
    const head = document.createElement('div');
    head.className='card';
    head.innerHTML = `<div class="row"><div style="display:flex; gap:10px; align-items:center"><i class="fa-solid fa-layer-group"></i><strong>${area.name}</strong></div><span class="muted">${area.description}</span></div>`;
    E.gridSyllabus.appendChild(head);
    area.modules.filter(m=>matchFilters({...m, areaId:area.id})).forEach(m=>{
      E.gridSyllabus.appendChild(cardFor({...m, areaId:area.id, areaName:area.name}));
    });
  });
}
function renderProgress(){
  const all = percentCompleted(); const core = percentCompleted('core'); const sov = percentCompleted('sovereign');
  E.doneTotal.textContent = all.done; E.countTotal.textContent = all.total; E.pillTotal.textContent = all.pct+'%'; E.barTotal.style.width = all.pct+'%';
  E.doneCore.textContent = core.done; E.countCore.textContent = core.total; E.pillCore.textContent = core.pct+'%'; E.barCore.style.width = core.pct+'%';
  E.doneSov.textContent = sov.done; E.countSov.textContent = sov.total; E.pillSov.textContent = sov.pct+'%'; E.barSov.style.width = sov.pct+'%';

  const xp = loadXP(); if(E.pillXP) E.pillXP.textContent = xp+' XP'; if(E.xpText) E.xpText.textContent = xp+' XP';
  const sr = loadStreak(); if(E.streakText) E.streakText.textContent = 'Streak: '+sr.count;

  const maxXP = (all.total)*50;
  const percentile = maxXP ? Math.round((xp/maxXP)*100) : 0;
  const rankTxt = percentile>=90?'Top 10%':percentile>=70?'Top 30%':percentile>=50?'Top 50%':'Rising';
  if(E.pillRank) E.pillRank.textContent = rankTxt;
  if(E.rankDesc) E.rankDesc.textContent = `You‚Äôve earned ${xp} / ${maxXP} XP (${percentile}%).`;

  E.gridProgress.innerHTML='';
  allModules().forEach(m=> E.gridProgress.appendChild(cardFor(m)));
}

/* =========================
   DETAIL & MODAL
========================= */
function openModule(areaId, id){
  state.tab = 'syllabus';
  const list = allModules();
  const idx = list.findIndex(x=>x.areaId===areaId && x.id===id);
  const m = list[idx]; if(!m) return;

  if(progressOf(m).status==='not-started') setProgress(m,'in-progress');

  $('#view-syllabus').classList.add('hide');
  E.detail.classList.add('show'); state.openId = keyOf(m); localStorage.setItem(STORAGE.OPEN, state.openId);

  E.detailNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.detailTitle.textContent = m.title;
  E.detailArea.textContent = m.areaName;
  E.detailTheme.textContent = m.theme;
  const st = progressOf(m).status; E.detailStatus.textContent = st==='completed'?'Completed':st==='in-progress'?'In Progress':'Not Started';
  E.detailBody.innerHTML = `<h3>Objectives</h3><ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>${m.content||''}`;

  E.btnPrev.onclick = ()=>{
    const prev = list[idx-1] || list[list.length-1];
    return gateLocked(prev.areaId) ? E.btnGateConnect.click() : openModule(prev.areaId, prev.id);
  };
  E.btnNext.onclick = ()=>{
    const next = list[idx+1] || list[0];
    return gateLocked(next.areaId) ? E.btnGateConnect.click() : openModule(next.areaId, next.id);
  };
  E.btnFull.onclick = ()=> openModal(m);
  E.btnMark.onclick = ()=>{
    const cur = progressOf(m).status;
    setProgress(m, cur==='completed' ? 'in-progress' : 'completed');
    openModule(areaId, id);
  };
  renderTabs();
}
function openModal(m){
  E.modal.classList.add('show');
  E.modalNum.textContent = m.areaId==='core'?m.order:m.id.replace('sv','');
  E.modalName.textContent = m.title;
  E.modalBody.innerHTML = `
    <div class="muted" style="margin-bottom:8px">${m.areaName} ‚Ä¢ ${m.theme}</div>
    <h3>Objectives</h3>
    <ul>${m.objectives.map(o=>`<li>${o}</li>`).join('')}</ul>
    ${m.content||''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
      <button class="chip" id="modal-mark-in"><i class="fa-regular fa-bookmark"></i> Save Progress</button>
      <button class="btn" id="modal-mark-done"><i class="fa-regular fa-circle-check"></i> Mark Complete</button>
    </div>`;
  $('#modal-mark-in').onclick = ()=> setProgress(m,'in-progress');
  $('#modal-mark-done').onclick = ()=>{
    setProgress(m,'completed');
    const all = percentCompleted(); if(all.done===all.total){ notifyOK('All modules complete!'); }
  };
}
if(E.modalClose) E.modalClose.onclick = ()=> E.modal.classList.remove('show');
if(E.modal) E.modal.addEventListener('click', e=>{ if(e.target===E.modal) E.modal.classList.remove('show'); });

/* =========================
   TABS, FILTERS, SEARCH
========================= */
function renderTabs(){
  E.viewOverview.classList.toggle('hide', state.tab!=='overview');
  E.viewSyllabus.classList.toggle('hide', state.tab!=='syllabus' || !!state.openId);
  E.viewProgress.classList.toggle('hide', state.tab!=='progress');
  E.viewResources.classList.toggle('hide', state.tab!=='resources');
  if(state.tab!=='syllabus'){ E.detail.classList.remove('show'); state.openId=null; localStorage.removeItem(STORAGE.OPEN); }
}
function switchTab(tab){ state.tab = tab; renderTabs(); }
function setFilter(f){
  state.filter = f;
  $$('#filters .chip').forEach(c=> c.classList.toggle('active', c.dataset.filter===f));
  renderCenter();
}
function renderCenter(){ renderOverview(); renderSyllabus(); renderProgress(); }

/* =========================
   HEADER/RIGHT/ HERO UI
========================= */
function updateHeaderAndRight(){
  const all = percentCompleted();
  E.chipText.textContent = `${all.done}/${all.total} Complete`;
  E.certProgress.textContent = `${all.done} / ${all.total}`;
  const pct = Math.min(100, all.pct);
  E.ring.style.setProperty('--p', pct+'%'); E.ring.setAttribute('data-label', pct+'%');
  if(E.heroRing){ E.heroRing.style.setProperty('--p', pct+'%'); E.heroRing.setAttribute('data-label', pct+'%'); }
  const canMint = all.done===all.total;
  E.certStatus.textContent = canMint ? 'Ready to Mint' : 'Locked';
  E.btnMint.disabled = !canMint;
}

/* =========================
   WEB3: CONNECT / GATE / MINT
========================= */
function setupWeb3(){
  if(!window.Web3Modal){ showError('Web3Modal script not found.'); return; }
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider?.default || window.WalletConnectProvider,
      options: { rpc: { [CHAIN_ID]: RPC_URL }, chainId: CHAIN_ID }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions, theme:'dark' });
}

async function connect(){
  try{
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if(!isSecure){ showError('Wallets require HTTPS or localhost.'); return; }

    extProvider = await web3Modal.connect();
    if(!extProvider){ showError('No wallet provider returned.'); return; }

    provider = new ethers.providers.Web3Provider(extProvider, 'any');
    signer = provider.getSigner(); account = await signer.getAddress().catch(()=>null);

    extProvider.removeAllListeners?.();
    extProvider.on?.('accountsChanged', accs=>{ if(!accs?.length) return disconnect(); account=accs[0]; checkGate(); });
    extProvider.on?.('chainChanged', ()=>{ provider = new ethers.providers.Web3Provider(extProvider,'any'); signer = provider.getSigner(); token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider); checkGate(); });
    extProvider.on?.('disconnect', ()=> disconnect());

    const net = await provider.getNetwork();
    if(Number(net.chainId) !== Number(CHAIN_ID)){
      try{
        await extProvider.request({ method:'wallet_switchEthereumChain', params:[{ chainId: toHex(CHAIN_ID) }] });
      }catch(switchErr){
        try{
          await extProvider.request({ method:'wallet_addEthereumChain', params:[{
            chainId: toHex(CHAIN_ID), chainName: CHAIN_NAME,
            nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18},
            rpcUrls:[RPC_URL], blockExplorerUrls:['https://bscscan.com']
          }] });
        }catch(addErr){ showError(`Please switch to ${CHAIN_NAME} in your wallet.`); throw addErr; }
      }
    }

    token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

    E.btnConnect?.classList.add('hide'); E.addrChip?.classList.remove('hide');
    const short = account ? `${account.slice(0,6)}‚Ä¶${account.slice(-4)}` : '0x‚Ä¶';
    if(E.addrShort) E.addrShort.textContent = short;
    if(E.addrFull)  E.addrFull.textContent  = account || '‚Äî';
    if(E.avatar && account) E.avatar.textContent = account.slice(2,4).toUpperCase();
    E.btnDisconnect?.classList.remove('hide'); E.btnReconnect?.classList.add('hide');

    await checkGate();
  }catch(err){
    console.error('connect() failed:', err);
    showError('Could not connect. If using WalletConnect, try MetaMask/injected or refresh over HTTPS.');
    E.btnReconnect?.classList.remove('hide');
  }
}

async function disconnect(){
  try{ await web3Modal?.clearCachedProvider?.(); }catch{}
  try{ if(extProvider?.disconnect && typeof extProvider.disconnect==='function'){ await extProvider.disconnect(); } }catch{}
  provider=signer=token=extProvider=null; account=null; accessGranted=false;
  E.btnConnect?.classList.remove('hide'); E.addrChip?.classList.add('hide'); E.btnDisconnect?.classList.add('hide'); E.btnReconnect?.classList.add('hide');
  if(E.addrFull) E.addrFull.textContent='Not connected'; if(E.avatar) E.avatar.textContent='SM'; if(E.tokenBalance) E.tokenBalance.textContent='‚Äî';
  if(E.heroMsg) E.heroMsg.textContent = 'Connect wallet to explore Sovereignty Mastery.';
  renderAll();
}

async function checkGate(){
  try{
    if(!provider || !account){
      const node = $('#gate-note'); if(node) node.textContent='Connect wallet to explore Sovereignty Mastery.';
      if(E.heroMsg) E.heroMsg.textContent='Connect wallet to explore Sovereignty Mastery.';
      return;
    }
    const read = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);
    const [raw, dec, sym] = await Promise.all([
      read.balanceOf(account),
      read.decimals().catch(()=>18),
      read.symbol().catch(()=> 'TOKEN')
    ]);
    tokenSymbolCached = sym || 'TOKEN';
    if(E.tokenSymbol) E.tokenSymbol.textContent = tokenSymbolCached;
    const bal = Number(ethers.utils.formatUnits(raw, dec));
    if(E.tokenBalance) E.tokenBalance.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:4})} ${tokenSymbolCached}`;

    const gateNote = $('#gate-note');
    if(bal < REQUIRED_TOKENS){
      if(E.heroMsg) E.heroMsg.innerHTML = `You hold <strong>${bal}</strong> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock Sovereign track.`;
      if(gateNote) gateNote.innerHTML = `You hold <strong>${bal}</strong> ${tokenSymbolCached}. <strong>${REQUIRED_TOKENS}</strong> required to unlock the Sovereign track.`;
    }else{
      if(E.heroMsg) E.heroMsg.innerHTML = `<strong>Access Granted.</strong> Sovereign modules unlocked.`;
      if(gateNote) gateNote.innerHTML = `Access granted. You can open all Sovereign modules.`;
    }

    accessGranted = bal >= REQUIRED_TOKENS;
    renderAll();
  }catch(e){ console.error('Gate read error', e); showError('Failed to read token balance. Check RPC/contract.'); }
}

/* Bind connect controls */
if(E.btnGateConnect) E.btnGateConnect.addEventListener('click', connect);
E.btnConnect?.addEventListener('click', connect);
E.heroConnect?.addEventListener('click', connect);
E.btnDisconnect?.addEventListener('click', disconnect);
E.btnReconnect?.addEventListener('click', connect);

/* =========================
   CERT MINT ‚Äî ERC-721 mintTo
========================= */
E.btnMint?.addEventListener('click', async ()=>{
  const all = percentCompleted();
  if(all.done!==all.total) return;
  if(!signer){ await connect(); if(!signer) return; }
  try{
    E.btnMint.disabled = true; if(E.mintStatus) E.mintStatus.textContent = 'Minting‚Ä¶';
    const nft = new ethers.Contract(NFT_ADDRESS, ERC721_MINT_ABI, signer);
    const tx = await nft.mintTo(account, TOKEN_URI);
    const receipt = await tx.wait();
    notifyOK('Certificate minted!');
    if(E.nftPreview){ E.nftPreview.style.display='block'; }
    if(E.nftName)    E.nftName.textContent = 'Sovereignty Mastery ‚Äî Key of Ascension';
    if(E.nftEdition) E.nftEdition.textContent = 'Edition: On-chain';
    if(E.nftAttrs)   E.nftAttrs.textContent = 'Attributes: Completion, Sovereign Track, Proof of Mastery';
    if(E.shareWrap && E.shareX){
      const shareText = encodeURIComponent('I just minted my Sovereignty Mastery certificate on BNB. On-chain proof of progress. #Web3 #Sovereignty');
      const shareUrl  = encodeURIComponent('https://bscscan.com/tx/'+receipt.transactionHash);
      E.shareWrap.style.display='block'; E.shareX.href = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;
    }
    if(E.mintStatus) E.mintStatus.innerHTML = '<span style="color:#a5ffcf"><i class="fa-solid fa-check"></i> Minted!</span>';
  }catch(err){
    console.error(err);
    if(E.mintStatus) E.mintStatus.innerHTML = '<span style="color:#ff9aa8"><i class="fa-solid fa-triangle-exclamation"></i> Mint failed. Check console.</span>';
    E.btnMint.disabled = false;
  }
});

/* =========================
   EVENTS ‚Äî FILTERS, SEARCH, TABS
========================= */
E.filters?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip'); if(!btn) return;
  setFilter(btn.dataset.filter);
});
E.search?.addEventListener('input', e=>{ state.search = e.target.value; renderCenter(); });
$$('.side-menu .sbtn[data-tab]').forEach(b=> b.addEventListener('click', ()=> { switchTab(b.dataset.tab); renderAll(); window.scrollTo({top:0, behavior:'smooth'}); }));

/* =========================
   PARTICLES ‚Äî soft floating stars
========================= */
(function particles(){
  const c = document.getElementById('auroraParticles'); if(!c) return;
  const ctx = c.getContext('2d'); let W=0,H=0, dots=[];
  function resize(){ W=c.width=window.innerWidth; H=c.height=Math.min(360, window.innerHeight*0.36); dots = Array.from({length:80}, ()=>({x:Math.random()*W,y:Math.random()*H, r:Math.random()*1.6+0.3, vx:(Math.random()-0.5)*0.15, vy:(Math.random()-0.5)*0.15})); }
  function step(){
    ctx.clearRect(0,0,W,H); ctx.globalAlpha=0.7;
    dots.forEach(d=>{
      d.x+=d.vx; d.y+=d.vy;
      if(d.x<0||d.x>W) d.vx*=-1; if(d.y<0||d.y>H) d.vy*=-1;
      ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
      ctx.fillStyle='rgba(122,233,255,.35)'; ctx.fill();
    });
    requestAnimationFrame(step);
  }
  window.addEventListener('resize', resize); resize(); step();
})();

/* =========================
   ROUTING & INIT
========================= */
function renderAll(){ renderSidebar(); renderCenter(); renderTabs(); updateHeaderAndRight(); }
function route(){
  const hash = location.hash.replace(/^#\//,'');
  if(!hash){ switchTab('overview'); return; }
  const [kind,a,b] = hash.split('/');
  if(kind==='tab'){ switchTab(a||'overview'); return; }
  if(kind==='module' && a && b){ switchTab('syllabus'); openModule(a,b); return; }
  switchTab('overview');
}
function restoreOpenDetail(){
  const openKey = localStorage.getItem(STORAGE.OPEN);
  if(openKey){
    const [areaId, id] = openKey.split(':');
    if(areaId && id){ switchTab('syllabus'); openModule(areaId, id); }
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  setupWeb3();
  renderAll();
  route();
  restoreOpenDetail();
  if(window.Web3Modal && web3Modal?.cachedProvider){ connect().catch(()=>{}); }
});
window.addEventListener('hashchange', route);
</script>
</body>
</html>
