<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sovereignty Mastery Program</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#0b0f14; --card:#121825; --card-2:#0f1522; --text:#e8eefc; --muted:#aeb7c9;
      --accent:#7c7cff; --accent-2:#5fe1b9; --gold:#f6c667; --danger:#ff6b6b; --ok:#22c55e;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px;
      --transition:all .3s ease;
    }
    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f6f8ff; --card:#ffffff; --card-2:#f3f6ff; --text:#0f162a; --muted:#4b587a;
      --border:rgba(15,22,42,.12); --shadow:0 10px 30px rgba(0,0,0,.08);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{background:linear-gradient(180deg,var(--bg) 0%, #0e1320 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;overflow-x:hidden}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    /* Header */
    .header{padding:2rem 0 1rem;display:flex;flex-direction:column;gap:.75rem;margin-bottom:1.5rem;position:relative}
    .header h1{margin:0;font-weight:800;letter-spacing:-.5px;font-size:2.5rem;background:linear-gradient(135deg,var(--accent-2),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{margin:0;color:var(--muted);font-size:1.1rem;max-width:800px}

    /* Theme toggle */
    .theme-toggle{position:absolute;top:1rem;right:1rem;background:rgba(255,255,255,.1);border:1px solid var(--border);color:var(--text);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition)}
    .theme-toggle:hover{background:rgba(255,255,255,.2)}

    /* Wallet */
    .wallet-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:1rem;padding:1rem;background:rgba(15,23,42,.6);border-radius:var(--radius);border:1px solid var(--border)}
    .wallet-btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;color:#0b0f14;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}
    .wallet-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(124,124,255,.3)}
    .chip{background:rgba(15,21,35,.8);border:1px solid var(--border);border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:8px;font-size:.9rem;transition:var(--transition)}
    .chip:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .chip .dot{width:8px;height:8px;border-radius:50%;background:#777}
    .chip.ok .dot{background:var(--ok)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;letter-spacing:.2px}
    .small-btn{background:transparent;border:1px solid var(--border);color:#cfe2ff;border-radius:8px;padding:4px 8px;cursor:pointer;transition:var(--transition)}
    .small-btn:hover{background:rgba(255,255,255,.1)}

    /* Nav */
    .main-nav{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}
    .nav-item{padding:.5rem 1rem;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid var(--border);cursor:pointer;transition:var(--transition)}
    .nav-item:hover,.nav-item.active{background:linear-gradient(90deg,var(--accent),#8a7cff);color:#fff}

    /* Progress */
    .progress-container{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin:1.5rem 0;box-shadow:var(--shadow);transition:var(--transition)}
    .progress-container:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.4)}
    .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .progress-title{font-weight:700;font-size:1.2rem}
    .progress-percentage{font-weight:700;color:var(--accent);font-size:1.2rem}
    .progress-bar{height:12px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;margin-bottom:.5rem}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#8a7cff,var(--gold));border-radius:999px;transition:width .7s ease;position:relative;overflow:hidden}
    .progress-fill:after{content:'';position:absolute;inset:0;background-image:linear-gradient(-45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent);background-size:20px 20px;animation:move 1s linear infinite}
    @keyframes move{0%{background-position:0 0}100%{background-position:20px 20px}}
    .progress-stats{display:flex;gap:1.5rem;color:var(--muted);font-size:.95rem;flex-wrap:wrap}

    /* Modules */
    .modules-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px;margin:2rem 0}
    .module-card{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;display:flex;flex-direction:column;gap:1rem;box-shadow:var(--shadow);transition:var(--transition);position:relative;overflow:hidden;height:100%}
    .module-card:before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent),var(--accent-2));opacity:0;transition:var(--transition)}
    .module-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.4)}
    .module-card:hover:before{opacity:1}
    .module-header{display:grid;grid-template-columns:auto 1fr;grid-template-rows:auto auto;column-gap:12px}
    .module-badge{height:40px;width:40px;border-radius:10px;background:rgba(124,124,255,.16);border:1px solid rgba(124,124,255,.3);display:grid;place-items:center;font-weight:800;color:#bfbfff;font-size:1.1rem}
    .module-title{margin:0;font-size:1.3rem;font-weight:700}
    .module-theme{grid-column:2;color:var(--muted);font-size:.95rem;margin-top:-2px}
    .module-content{color:var(--muted);flex-grow:1}
    .module-description{margin-bottom:1rem}
    .learning-objectives h4{margin:.5rem 0 .5rem;font-weight:600;color:#dfe6fb;display:flex;align-items:center;gap:8px}
    .objectives-list{margin:.5rem 0 0 1.1rem}
    .objectives-list li{margin:.35rem 0}
    .objectives-list li::marker{color:var(--accent)}
    .module-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .module-status{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.9rem}
    .status-indicator{width:10px;height:10px;border-radius:50%;background:#777;transition:var(--transition)}
    .status-indicator.completed{background:var(--ok);box-shadow:0 0 10px rgba(34,197,94,.5)}
    .status-indicator.in-progress{background:#f59e0b;box-shadow:0 0 10px rgba(245,158,11,.5)}
    .module-button{background:linear-gradient(90deg,var(--accent),#8a7cff);border:none;color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:8px;transition:var(--transition)}
    .module-button[disabled]{opacity:.6;cursor:not-allowed}
    .module-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(124,124,255,.3)}
    .module-button:focus-visible{outline:3px solid rgba(124,124,255,.45)}

    /* Detail */
    .back-to-modules{display:none;margin:1.5rem 0 1rem;color:#cfe2ff;padding:.5rem 1rem;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid var(--border);width:fit-content;transition:var(--transition)}
    .back-to-modules:hover{background:rgba(255,255,255,.1)}
    .module-detail{display:none;background:linear-gradient(180deg,#0f1522,#0b101b);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);margin-bottom:2rem;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .detail-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
    .detail-title{margin:0;font-size:1.8rem;font-weight:700}
    .detail-theme{color:var(--muted);font-size:1.1rem;margin-top:.5rem}
    .detail-close{background:transparent;border:1px solid var(--border);color:#98a4c8;height:40px;width:40px;border-radius:8px;cursor:pointer;transition:var(--transition)}
    .detail-close:hover{background:rgba(255,255,255,.1)}
    .detail-content{line-height:1.7}
    .detail-content h3{margin:1.5rem 0 .75rem;color:var(--accent-2);font-weight:600}
    .detail-content p{margin:.75rem 0}
    .detail-content ul,.detail-content ol{margin:.75rem 0;padding-left:1.5rem}
    .detail-content li{margin:.5rem 0}
    .practice-box{background:rgba(124,124,255,.08);border:1px dashed rgba(124,124,255,.35);border-radius:12px;padding:1.25rem;margin:1.25rem 0}
    .key-quote{background:rgba(255,255,255,.04);border-left:4px solid var(--gold);padding:1rem 1.25rem;border-radius:8px;margin:1.25rem 0;font-style:italic}
    .module-complete{margin:1.25rem 0;padding:1rem;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:8px;display:flex;align-items:center;gap:10px}
    .module-next{color:#b7c7ff;text-decoration:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px;margin-top:1rem;padding:.5rem 1rem;border-radius:8px;background:rgba(183,199,255,.1);transition:var(--transition)}
    .module-next:hover{background:rgba(183,199,255,.2)}

    /* Wealth Codes nav */
    .nav-container{display:flex;gap:.75rem;flex-wrap:wrap;margin:1.5rem 0}
    .nav-button{background:#12172a;border:1px solid var(--border);color:#dfe6fb;border-radius:999px;padding:8px 16px;cursor:pointer;transition:var(--transition)}
    .nav-button:hover,.nav-button.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#0b0f14;border:none}

    /* Hidden source */
    #courseContent{display:none}

    /* Toast */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f1422;color:#eaf2ff;border:1px solid var(--border);padding:12px 18px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:1000;display:flex;align-items:center;gap:8px}
    .toast.show{opacity:1}

    /* Footer */
    .footer{margin-top:3rem;padding:2rem 0;border-top:1px solid var(--border);text-align:center;color:var(--muted);font-size:.9rem}

    /* Responsive */
    @media (max-width:768px){
      .header h1{font-size:2rem}
      .modules-grid{grid-template-columns:1fr}
      .progress-stats{flex-direction:column;gap:.5rem}
      .wallet-bar{flex-direction:column;align-items:flex-start}
      .detail-header{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sovereignty Mastery Program</h1>
      <p>A 7-module transformative journey to reclaim your personal power and live with authentic authority</p>

      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>

      <!-- Wallet bar -->
      <div class="wallet-bar">
        <button id="connectBtn" class="wallet-btn"><i class="fa-solid fa-wallet"></i> Connect Wallet</button>
        <button id="switchPolygon" class="small-btn" title="Switch to Polygon"><i class="fa-solid fa-plug-circle-bolt"></i> Polygon</button>

        <div id="provChip" class="chip">
          <i class="fa-solid fa-triangle-exclamation" style="color:#ffd28a"></i>
          <span>No wallet detected</span>
        </div>
        <div id="addrChip" class="chip" style="display:none">
          <span class="dot"></span><i class="fa-regular fa-id-card"></i>
          <span id="addrShort" class="mono">0x…</span>
          <button id="copyAddr" class="small-btn" title="Copy"><i class="fa-regular fa-copy"></i></button>
        </div>
        <div id="chainChip" class="chip" style="display:none"><i class="fa-solid fa-network-wired"></i> <span id="chainName">Chain</span></div>
        <div id="balChip" class="chip" style="display:none"><i class="fa-solid fa-coins"></i> <span id="nativeBal" class="mono">0.0000</span> <button id="refreshBal" class="small-btn" title="Refresh"><i class="fa-solid fa-rotate"></i></button></div>
        <div id="gateChip" class="chip" style="display:none"><i class="fa-solid fa-key"></i> <span id="gateText">Checking access…</span></div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="main-nav">
      <div class="nav-item active" data-target="modules">Modules</div>
      <div class="nav-item" data-target="progress">Progress</div>
      <div class="nav-item" data-target="resources">Resources</div>
      <div class="nav-item" data-target="community">Community</div>
    </div>

    <!-- Progress -->
    <div class="progress-container" aria-live="polite">
      <div class="progress-header">
        <div class="progress-title">Your Progress</div>
        <div class="progress-percentage" id="progressPct">0% Complete</div>
      </div>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-stats">
        <span id="progressCount">0 of 7 Modules Completed</span>
        <span>Estimated 12 hours to complete</span>
        <span id="timeSpent">Time spent: 0h 0m</span>
      </div>
    </div>

    <!-- Modules Grid -->
    <div class="modules-grid" id="modulesGrid" role="list">
      <!-- Cards 1–7 -->
      <div class="module-card" role="listitem" data-module="1">
        <div class="module-header">
          <div class="module-badge">1</div>
          <h3 class="module-title">Foundations of Self-Awareness</h3>
          <div class="module-theme">Becoming the Observer</div>
        </div>
        <div class="module-content">
          <p class="module-description">Self-awareness is the foundation of awakening—stepping out of unconscious streams to observe with clarity and compassion.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-brain"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Lost-in-thought vs observing thought</li>
              <li>Daily mindfulness practices</li>
              <li>Journaling for clarity</li>
              <li>3-Layer Belief Audit</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(1)"><i class="fas fa-book-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="2">
        <div class="module-header">
          <div class="module-badge">2</div>
          <h3 class="module-title">Breaking the Illusion of Ego</h3>
          <div class="module-theme">You Are Not Your Story</div>
        </div>
        <div class="module-content">
          <p class="module-description">See through roles and labels; meet the silent watcher beyond narrative identity.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-bolt"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Ego vs Essence</li>
              <li>Roles, labels & identity</li>
              <li>Silent Watcher practice</li>
              <li>Ego defenses</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(2)"><i class="fas fa-play-circle"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="3">
        <div class="module-header">
          <div class="module-badge">3</div>
          <h3 class="module-title">Entering the Now</h3>
          <div class="module-theme">Presence is Power</div>
        </div>
        <div class="module-content">
          <p class="module-description">Anchor attention in breath and senses; find the gap between thoughts.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-water"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Past/Future fixation</li>
              <li>Sensory anchoring</li>
              <li>Listening as meditation</li>
              <li>Finding the silent gap</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(3)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="4">
        <div class="module-header">
          <div class="module-badge">4</div>
          <h3 class="module-title">Surrender & Emotional Alchemy</h3>
          <div class="module-theme">Freedom Through Letting Go</div>
        </div>
        <div class="module-content">
          <p class="module-description">Transmute emotion by allowing, feeling, and releasing; discover power in surrender.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-feather"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>What surrender truly is</li>
              <li>Somatic flow of emotion</li>
              <li>3-Step alchemy</li>
              <li>Forgiveness as liberation</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(4)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="5">
        <div class="module-header">
          <div class="module-badge">5</div>
          <h3 class="module-title">The Illusion of Separation</h3>
          <div class="module-theme">Remembering Oneness</div>
        </div>
        <div class="module-content">
          <p class="module-description">See the unity behind duality; meet relationships and nature as mirrors.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-infinity"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Seeing through duality</li>
              <li>Relational mirrors</li>
              <li>Nature as teacher</li>
              <li>Entanglement & connection</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(5)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="6">
        <div class="module-header">
          <div class="module-badge">6</div>
          <h3 class="module-title">Embodied Enlightenment</h3>
          <div class="module-theme">Wisdom in Action</div>
        </div>
        <div class="module-content">
          <p class="module-description">Integrate realization into daily life: shadow work, pillars of practice, sacred mundanity.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-seedling"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Transcendence → integration</li>
              <li>4 pillars of embodiment</li>
              <li>Shadow & wholeness</li>
              <li>Chop wood, carry water</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(6)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>

      <div class="module-card" role="listitem" data-module="7">
        <div class="module-header">
          <div class="module-badge">7</div>
          <h3 class="module-title">Living as Awareness</h3>
          <div class="module-theme">The Unfolding Mystery</div>
        </div>
        <div class="module-content">
          <p class="module-description">Rest as awareness; move with spontaneity, impermanence, and effortless action.</p>
          <div class="learning-objectives">
            <h4><i class="fas fa-mountain-sun"></i> Learning Objectives</h4>
            <ul class="objectives-list">
              <li>Form & formlessness</li>
              <li>Flow & spontaneity</li>
              <li>Gift of impermanence</li>
              <li>Beyond seeking</li>
            </ul>
          </div>
        </div>
        <div class="module-footer">
          <div class="module-status"><div class="status-indicator"></div><span class="status-text">Not Started</span></div>
          <button class="module-button" onclick="showModule(7)"><i class="fas fa-lock-open"></i> Open</button>
        </div>
      </div>
    </div>

    <!-- Detail View -->
    <a href="#" class="back-to-modules" id="backToModules" onclick="hideModule();return false;">
      <i class="fas fa-arrow-left"></i> Back to All Modules
    </a>
    <div id="moduleDetail" class="module-detail" aria-live="polite">
      <div class="detail-header">
        <div>
          <h2 class="detail-title" id="detailTitle">Module</h2>
          <div class="detail-theme" id="detailTheme">Theme</div>
        </div>
        <button class="detail-close" onclick="hideModule()" aria-label="Close module details">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="detailBody" class="detail-content"></div>
    </div>

    <!-- Hidden source Course Content (full block pasted) -->
    <div id="courseContent">
      <!-- ===================== -->
      <!-- Path of Awakening (7) -->
      <!-- ===================== -->
      <h2>The Path of Awakening: Dissolving Illusion & Living in Truth</h2>
      <p>This 7-module course is a transformational journey into self-realization, presence, and embodied truth. Each module builds upon the last, guiding you through progressive stages of awakening.</p>

      <!-- Module 1 -->
      <article id="module1">
        <h3>Module 1: Foundations of Self-Awareness</h3>
        <h4>Theme: Becoming the Observer</h4>
        <p>Self-awareness is the foundation of awakening. It's the ability to step out of the stream of unconscious thoughts and emotions, observing them without judgment. When you become the observer, you stop identifying with the mental chatter and start to see your true nature beyond the mind.</p>
        <ul>
          <li><strong>What is self-awareness?</strong><br>Self-awareness is the conscious recognition of your thoughts, emotions, and behaviors as they arise. It's the difference between being <em>lost in thought</em> and <em>observing thought</em>…</li>
          <li><strong>Mindfulness Practices for Daily Life:</strong><br>5 Senses Grounding Technique…</li>
          <li><strong>Journaling for Clarity and Self-Discovery:</strong><br>Stream-of-consciousness & structured reflection…</li>
          <li><strong>Identifying Unconscious Patterns:</strong><br>The <em>3-Layer Belief Audit</em>…</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>5-Minute Breath + Journaling Meditation</strong>…</p></div>
        <div class="key-quote"><p><em>"You are not your thoughts. You are the awareness behind them."</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule1" data-track="awakening-1">
          <label for="completeModule1">Mark as complete</label>
        </div>

        <!-- Extra resources -->
        <div class="resources-section">
          <h3><i class="fas fa-book"></i> Additional Resources</h3>
          <div class="resources-grid">
            <div class="resource-card">
              <div class="resource-icon"><i class="fas fa-file-pdf"></i></div>
              <h4 class="resource-title">3-Layer Belief Audit Worksheet</h4>
              <p>Step-by-step guide to uncovering limiting beliefs</p>
            </div>
            <div class="resource-card">
              <div class="resource-icon"><i class="fas fa-headphones"></i></div>
              <h4 class="resource-title">Guided 5-Senses Grounding</h4>
              <p>Short audio to anchor presence quickly</p>
            </div>
          </div>
        </div>
      </article>

      <!-- Module 2 -->
      <article id="module2">
        <h3>Module 2: Breaking the Illusion of Ego</h3>
        <h4>Theme: You Are Not Your Story</h4>
        <p>The ego is not who you are—it is a mask…</p>
        <ul>
          <li><strong>Understanding Ego vs. Essence:</strong> …</li>
          <li><strong>The Trap of Roles, Labels, and Identity:</strong> …</li>
          <li><strong>The Silent Watcher:</strong> …</li>
          <li><strong>Ego's Defense Mechanisms:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>"Who am I?" Self-Inquiry Meditation (10 min)</strong>…</p></div>
        <div class="key-quote"><p><em>"The ego dies when you realize you were never it."</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule2" data-track="awakening-2">
          <label for="completeModule2">Mark as complete</label>
        </div>
      </article>

      <!-- Module 3 -->
      <article id="module3">
        <h3>Module 3: Entering the Now</h3>
        <h4>Theme: Presence is Power</h4>
        <p>Presence is the art of fully inhabiting this moment…</p>
        <ul>
          <li><strong>The Mind's Obsession with Past/Future:</strong> …</li>
          <li><strong>Anchoring in the Breath and Senses:</strong> …</li>
          <li><strong>Listening as Meditation:</strong> …</li>
          <li><strong>The Gap Between Thoughts:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>Presence Scan + Nature-Based Stillness</strong>…</p></div>
        <div class="key-quote"><p><em>"The present moment is not just a place of peace. It is where your true power resides."</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule3" data-track="awakening-3">
          <label for="completeModule3">Mark as complete</label>
        </div>
      </article>

      <!-- Module 4 -->
      <article id="module4">
        <h3>Module 4: Surrender & Emotional Alchemy</h3>
        <h4>Theme: Freedom Through Letting Go</h4>
        <p>Surrender is not weakness — it is the ultimate strength…</p>
        <ul>
          <li><strong>What is Surrender?</strong> …</li>
          <li><strong>Allowing Emotions to Move:</strong> …</li>
          <li><strong>The 3 Steps of Emotional Alchemy:</strong> …</li>
          <li><strong>Forgiveness as Liberation:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>Surrender Breathwork (15 min)</strong>…</p></div>
        <div class="key-quote"><p><em>"Peace comes not from controlling life, but from surrendering to it."</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule4" data-track="awakening-4">
          <label for="completeModule4">Mark as complete</label>
        </div>
      </article>

      <!-- Module 5 -->
      <article id="module5">
        <h3>Module 5: The Illusion of Separation</h3>
        <h4>Theme: Remembering Oneness</h4>
        <p>The sense of being a separate "self" is the root of all suffering…</p>
        <ul>
          <li><strong>Seeing Through the Veil of Duality:</strong> …</li>
          <li><strong>The Mirror of Relationships:</strong> …</li>
          <li><strong>Nature as Teacher:</strong> …</li>
          <li><strong>Quantum Entanglement & Spiritual Connection:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>Oneness Meditation (20 min)</strong>…</p></div>
        <div class="key-quote"><p><em>"You are not a drop in the ocean. You are the entire ocean in a drop." — Rumi</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule5" data-track="awakening-5">
          <label for="completeModule5">Mark as complete</label>
        </div>
      </article>

      <!-- Module 6 -->
      <article id="module6">
        <h3>Module 6: Embodied Enlightenment</h3>
        <h4>Theme: Wisdom in Action</h4>
        <p>Awakening is not an escape from life, but a deeper engagement with it…</p>
        <ul>
          <li><strong>From Transcendence to Integration:</strong> …</li>
          <li><strong>The 4 Pillars of Embodied Awakening:</strong> …</li>
          <li><strong>Shadow Work & Wholeness:</strong> …</li>
          <li><strong>Sacred Mundanity:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>Walking Meditation + Energy Grounding</strong>…</p></div>
        <div class="key-quote"><p><em>"Before enlightenment, chop wood, carry water. After enlightenment, chop wood, carry water." — Zen Proverb</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule6" data-track="awakening-6">
          <label for="completeModule6">Mark as complete</label>
        </div>
      </article>

      <!-- Module 7 -->
      <article id="module7">
        <h3>Module 7: Living as Awareness</h3>
        <h4>Theme: The Unfolding Mystery</h4>
        <p>The final module is not an ending, but a new beginning…</p>
        <ul>
          <li><strong>The Dance of Form and Formlessness:</strong> …</li>
          <li><strong>Spontaneity & Flow:</strong> …</li>
          <li><strong>The Gift of Impermanence:</strong> …</li>
          <li><strong>Beyond Seeking:</strong> …</li>
        </ul>
        <div class="practice-box"><h4>Practice</h4><p><strong>Open-Eye Awareness Meditation (30 min)</strong>…</p></div>
        <div class="key-quote"><p><em>"You are not a person seeking enlightenment. You are enlightenment recognizing itself."</em></p></div>
        <div class="module-complete">
          <input type="checkbox" id="completeModule7" data-track="awakening-7">
          <label for="completeModule7">Mark as complete</label>
        </div>
      </article>

      <!-- Bonus -->
      <div class="bonus-section">
        <h3>Bonus: The Alchemy of Consciousness</h3>
        <p>These bonus materials explore the deeper symbology of awakening and consciousness.</p>
        <ul>
          <li><strong>The Meditation</strong> — guided visualization</li>
          <li><strong>Sacred Awareness</strong> — presence in daily life</li>
          <li><strong>AR Meditation Space</strong> — immersive experience</li>
        </ul>
        <button id="arToggleBtn" class="wisdom-cta" style="margin-top: 1.5rem;">Toggle AR Meditation Space</button>
      </div>

      <div class="community-section">
        <h3>Join the Wisdom Circle</h3>
        <p>Connect with fellow travelers on the path…</p>
        <ul>
          <li>Weekly wisdom shares</li>
          <li>Monthly live Q&A sessions</li>
          <li>Meditation gatherings</li>
        </ul>
        <button id="joinCommunityBtn" class="wisdom-cta" style="margin-top: 1.5rem;">Access Community Portal</button>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.08);margin:2.5rem 0" />

      <!-- ============================= -->
      <!-- Spiritual Wealth Codes (7)    -->
      <!-- ============================= -->
      <h2>Spiritual Wealth Codes</h2>
      <p class="subtitle">Activate your divine financial blueprint</p>

      <div class="nav-container" aria-label="Wealth Codes Navigation" style="margin:1rem 0 2rem; display:flex; gap:.5rem; flex-wrap:wrap">
        <button class="nav-button active" onclick="showModule('swc1')">Code 1: Frequency</button>
        <button class="nav-button" onclick="showModule('swc2')">Code 2: Clearing</button>
        <button class="nav-button" onclick="showModule('swc3')">Code 3: Exchange</button>
        <button class="nav-button" onclick="showModule('swc4')">Code 4: CEO</button>
        <button class="nav-button" onclick="showModule('swc5')">Code 5: Ancient Systems</button>
        <button class="nav-button" onclick="showModule('swc6')">Code 6: Estate</button>
        <button class="nav-button" onclick="showModule('swc7')">Code 7: Crystalline</button>
      </div>

      <!-- Codes 1..7 -->
      <div id="swc1" class="module-card" style="display:block;">
        <div class="code-number">1</div>
        <div class="module-title">Money Is Frequency</div>
        <div class="module-content">
          <h3>Essence</h3>
          <p>Money is a mirror of internal resonance…</p>
          <h3>Deepening Understanding</h3>
          <p>Quantum physics reveals that everything is energy…</p>
          <h3>Reflection</h3>
          <ul>
            <li>Do I see money as energy or survival?</li>
            <li>What energetic tone do I project when I spend?</li>
            <li>How does my body feel when I think about money?</li>
            <li>What frequency am I emitting around abundance?</li>
          </ul>
          <div class="practice-box">
            <h4>Daily Practice</h4>
            <p>Before any transaction, pause for three breaths… “I am a conduit for divine abundance.”</p>
          </div>
          <h3>Activation</h3>
          <blockquote>“I do not chase currency — I become the current.”</blockquote>
          <div class="module-footer" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete1" data-track="swc-1">
              <label for="complete1">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc2')" style="cursor:pointer">Next: Clearing →</a>
          </div>
        </div>
      </div>

      <div id="swc2" class="module-card" style="display:none;">
        <div class="code-number">2</div>
        <div class="module-title">Clearing the Poverty Program</div>
        <div class="module-content">
          <h3>Essence</h3><p>The subconscious beliefs you inherited around money shape your reality…</p>
          <h3>Deepening Understanding</h3><p>Research in epigenetics shows…</p>
          <h3>Reflection</h3>
          <ul>
            <li>What did my bloodline teach me about money?</li><li>Do I associate wealth with guilt or power?</li>
            <li>What financial fears have I inherited?</li><li>How does my family history with money affect me today?</li>
          </ul>
          <div class="practice-box"><h4>Ancestral Clearing Meditation</h4><p>Visualize a golden light connecting you to your ancestors…</p></div>
          <h3>Activation</h3><blockquote>“I return all lack programming to sender…”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete2" data-track="swc-2">
              <label for="complete2">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc3')" style="cursor:pointer">Next: Divine Exchange →</a>
          </div>
        </div>
      </div>

      <div id="swc3" class="module-card" style="display:none;">
        <div class="code-number">3</div>
        <div class="module-title">Divine Exchange</div>
        <div class="module-content">
          <h3>Essence</h3><p>Energy is never lost — only exchanged…</p>
          <h3>Deepening Understanding</h3><p>In indigenous wisdom traditions, exchange was sacred…</p>
          <h3>Reflection</h3><ul><li>Is my offer birthed from soul or survival?</li><li>Am I afraid to receive what I'm worth?</li><li>Do I give with strings attached?</li><li>How can I make my exchanges more sacred?</li></ul>
          <div class="practice-box"><h4>Sacred Exchange Practice</h4><p>Bless the exchange before receiving payment…</p></div>
          <h3>Activation</h3><blockquote>“My gifts are sacred, and I receive in divine measure.”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete3" data-track="swc-3">
              <label for="complete3">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc4')" style="cursor:pointer">Next: Higher Self CEO →</a>
          </div>
        </div>
      </div>

      <div id="swc4" class="module-card" style="display:none;">
        <div class="code-number">4</div>
        <div class="module-title">Higher Self CEO</div>
        <div class="module-content">
          <h3>Essence</h3><p>Your soul is your strategist…</p>
          <h3>Deepening Understanding</h3><p>Neuroscience reveals intuitive integration…</p>
          <h3>Reflection</h3><ul><li>Am I operating from pressure or presence?</li><li>What would my Higher Self build today?</li><li>How can I better hear guidance?</li><li>Where am I forcing vs allowing?</li></ul>
          <div class="practice-box"><h4>CEO Meditation</h4><p>Each morning, seat your Higher Self in the CEO chair…</p></div>
          <h3>Activation</h3><blockquote>“I take divine direction, not desperate action.”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete4" data-track="swc-4">
              <label for="complete4">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc5')" style="cursor:pointer">Next: Ancient Wealth Systems →</a>
          </div>
        </div>
      </div>

      <div id="swc5" class="module-card" style="display:none;">
        <div class="code-number">5</div>
        <div class="module-title">Ancient Wealth Systems</div>
        <div class="module-content">
          <h3>Essence</h3><p>Your ancestors traded in gold, land, cattle, spiritual access…</p>
          <h3>Deepening Understanding</h3><p>Ancient African & Indigenous civilizations saw wealth holistically…</p>
          <h3>Reflection</h3><ul><li>What did the Moors, Nubians, or Kemites teach?</li><li>How do I restore sacred commerce?</li><li>What non-material wealth do I have?</li><li>How do I bring ancestral wisdom forward?</li></ul>
          <div class="practice-box"><h4>Ancestral Wealth Inventory</h4><p>List 10 non-material forms of wealth…</p></div>
          <h3>Activation</h3><blockquote>“I reclaim the wealth systems of my bloodline.”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete5" data-track="swc-5">
              <label for="complete5">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc6')" style="cursor:pointer">Next: Claiming the Estate →</a>
          </div>
        </div>
      </div>

      <div id="swc6" class="module-card" style="display:none;">
        <div class="code-number">6</div>
        <div class="module-title">Claiming the Estate</div>
        <div class="module-content">
          <h3>Essence</h3><p>Your estate is more than land — it's spiritual jurisdiction…</p>
          <h3>Deepening Understanding</h3><p>Legal fiction vs living soul…</p>
          <h3>Reflection</h3><ul><li>What name do I claim under?</li><li>Is my wealth privately held?</li><li>How do I relate to ownership systems?</li><li>What would true sovereignty mean?</li></ul>
          <div class="practice-box"><h4>Sovereignty Declaration</h4><p>Write and read daily for 21 days…</p></div>
          <h3>Activation</h3><blockquote>“I am the living heir… I operate from sovereignty.”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete6" data-track="swc-6">
              <label for="complete6">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc7')" style="cursor:pointer">Next: Crystalline Currency →</a>
          </div>
        </div>
      </div>

      <div id="swc7" class="module-card" style="display:none;">
        <div class="code-number">7</div>
        <div class="module-title">Crystalline Currency Activation</div>
        <div class="module-content">
          <h3>Essence</h3><p>You are the vault — ideas, downloads, visions…</p>
          <h3>Deepening Understanding</h3><p>Crystals store/amplify energy; your consciousness can too…</p>
          <h3>Reflection</h3><ul><li>What wealth codes remain locked?</li><li>Where am I holding back ideas?</li><li>How can I steward inspiration?</li><li>What would full trust look like?</li></ul>
          <div class="practice-box"><h4>Crystalline Meditation</h4><p>Visualize your body as a luminous crystal…</p></div>
          <h3>Activation</h3><blockquote>“I am the oracle, the offer, and the overflow.”</blockquote>
          <div class="module-footer">
            <div class="completion-checkbox">
              <input type="checkbox" id="complete7" data-track="swc-7">
              <label for="complete7">Mark as completed</label>
            </div>
            <a class="module-next" onclick="showModule('swc1')" style="cursor:pointer">Return to Code 1 ↺</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>Sovereignty Mastery Program &copy; 2023 • All rights reserved</p>
      <p>Designed for awakening consciousness and reclaiming personal sovereignty</p>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"><i class="fas fa-check-circle"></i> Saved</div>

  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // ===== helpers =====
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const toast = (m='Saved ✔️', icon='check-circle') => {
      const t = $('#toast'); t.innerHTML = `<i class="fas fa-${icon}"></i> ${m}`;
      t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1500);
    };

    // ===== progress state =====
    const STORAGE_KEY = 'sovereignty-progress-v3';
    const state = {
      completed: new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')),
      timeSpent: parseInt(localStorage.getItem('sovereignty-time') || '0'),
      achievements: JSON.parse(localStorage.getItem('sovereignty-achievements') || '[]')
    };

    function updateProgressUI() {
      const keys = ['awakening-1','awakening-2','awakening-3','awakening-4','awakening-5','awakening-6','awakening-7'];
      const done = keys.filter(k => state.completed.has(k)).length;
      const pct = Math.round((done/keys.length)*100);

      $('#progressPct').textContent = `${pct}% Complete`;
      $('#progressFill').style.width = `${pct}%`;
      $('#progressCount').textContent = `${done} of ${keys.length} Modules Completed`;

      const hours = Math.floor(state.timeSpent / 60);
      const minutes = state.timeSpent % 60;
      $('#timeSpent').textContent = `Time spent: ${hours}h ${minutes}m`;

      // card status
      $$('.modules-grid .module-card').forEach(card => {
        const n = card.getAttribute('data-module');
        const key = `awakening-${n}`;
        const ind = $('.status-indicator', card);
        const text = $('.status-text', card);
        if (state.completed.has(key)) { ind.classList.add('completed'); ind.classList.remove('in-progress'); text.textContent = 'Completed'; }
        else if (card.dataset.opened === '1') { ind.classList.add('in-progress'); ind.classList.remove('completed'); text.textContent = 'In Progress'; }
        else { ind.classList.remove('completed','in-progress'); text.textContent = 'Not Started'; }
      });

      checkAchievements();
      // refresh disabled state in case gate toggled
      paintButtonsDisabled();
    }

    function saveProgress(silent=false){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(state.completed)));
      localStorage.setItem('sovereignty-time', state.timeSpent.toString());
      localStorage.setItem('sovereignty-achievements', JSON.stringify(state.achievements));
      updateProgressUI();
      if(!silent) toast('Progress saved');
    }

    function checkAchievements(){
      const keys = ['awakening-1','awakening-2','awakening-3','awakening-4','awakening-5','awakening-6','awakening-7'];
      const done = keys.filter(k => state.completed.has(k)).length;
      const newly = [];
      if (done >= 1 && !state.achievements.includes('first-step')) { state.achievements.push('first-step'); newly.push('First Step: Completed your first module!'); }
      if (done >= 3 && !state.achievements.includes('journey-begun')) { state.achievements.push('journey-begun'); newly.push('Journey Begun: Completed 3 modules!'); }
      if (done >= 7 && !state.achievements.includes('sovereign-master')) { state.achievements.push('sovereign-master'); newly.push('Sovereign Master: Completed all modules!'); }
      if (newly.length){
        localStorage.setItem('sovereignty-achievements', JSON.stringify(state.achievements));
        newly.forEach((ach,i)=> setTimeout(()=> toast(ach,'trophy'), 400*i));
      }
    }

    // ===== detail view injection =====
    function injectArticle(el){
      const title = $('h3', el)?.textContent || 'Module';
      const theme = $('h4', el)?.textContent?.replace(/^Theme:\s*/,'') || '';
      $('#detailTitle').textContent = title;
      $('#detailTheme').textContent = theme;

      const body = $('#detailBody'); body.innerHTML = '';
      Array.from(el.children).forEach(ch => body.appendChild(ch.cloneNode(true)));

      // wire completion
      $$('#detailBody .module-complete input[type="checkbox"]').forEach(cb => {
        const k = cb.getAttribute('data-track'); cb.checked = state.completed.has(k);
        cb.addEventListener('change', e => {
          if (e.target.checked) state.completed.add(k); else state.completed.delete(k);
          saveProgress();
        });
      });

      // SWC internal nav
      $$('#detailBody .nav-button').forEach(b => b.addEventListener('click', () => {
        const m = /Code\s+(\d+)/i.exec(b.textContent.trim()); if (m) showModule('swc'+m[1]);
      }));

      startTimeTracking();
    }

    let timeTrackingInterval;
    function startTimeTracking(){ clearInterval(timeTrackingInterval); timeTrackingInterval = setInterval(()=>{ state.timeSpent++; saveProgress(true); }, 60000); }
    function stopTimeTracking(){ clearInterval(timeTrackingInterval); }

    // Gate flag used by showModule + buttons
    let accessGranted = false;

    function showModule(id){
      if (CONFIG.ENABLE_GATE && !accessGranted){
        toast(`Access locked — need ${CONFIG.MIN_TOKEN} KLY`, 'lock');
        return;
      }
      let src;
      if (typeof id === 'number' || /^[1-7]$/.test(String(id))){
        src = $(`#courseContent article#module${id}`);
        const card = $(`.modules-grid .module-card[data-module="${id}"]`); if (card) card.dataset.opened = '1';
      } else if (/^swc[1-7]$/.test(String(id))) {
        src = $(`#courseContent #${id}`);
      }
      if (!src){ console.warn('Module not found', id); return; }
      injectArticle(src);
      $('#moduleDetail').style.display = 'block';
      $('#backToModules').style.display = 'inline-block';
      $('#moduleDetail').scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateProgressUI();
    }

    function hideModule(){ $('#moduleDetail').style.display = 'none'; $('#backToModules').style.display = 'none'; stopTimeTracking(); }

    function restoreCheckboxes(){
      $$('#courseContent .module-complete input[type="checkbox"]').forEach(cb => {
        const k = cb.getAttribute('data-track'); cb.checked = state.completed.has(k);
      });
      updateProgressUI();
    }

    // ===== wallet (ethers v5) =====
    const CHAIN_NAMES = {
      '0x1':'Ethereum','0xaa36a7':'Sepolia','0x89':'Polygon','0xa4b1':'Arbitrum','0xa':'Optimism','0x38':'BNB'
    };
    const NATIVE_SYM = id => (CHAIN_NAMES[id]==='Polygon' ? 'MATIC' : 'ETH');
    const CONFIG = {
      ENABLE_GATE: true,
      TOKEN_ADDRESS: '0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52', // KLY example
      MIN_TOKEN: 500,
      ERC20_ABI: ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"]
    };

    let provider, signer, account, chainId;

    const connectBtn = $('#connectBtn'),
          switchPolygonBtn = $('#switchPolygon'),
          provChip = $('#provChip'),
          addrChip = $('#addrChip'),
          chainChip = $('#chainChip'),
          balChip = $('#balChip'),
          gateChip = $('#gateChip');

    function short(a){ return `${a.slice(0,6)}…${a.slice(-4)}`; }

    async function connectWallet(){
      if (!window.ethereum){
        toast('Install MetaMask', 'exclamation-triangle');
        window.open('https://metamask.io/download','_blank');
        return;
      }
      try{
        const accs = await ethereum.request({ method:'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        account = accs[0];
        chainId = await ethereum.request({ method:'eth_chainId' });

        paintWallet();
        await refreshNative();
        if (CONFIG.ENABLE_GATE) await checkGate();

        ethereum.on('accountsChanged', async a=>{
          if (!a.length){ account=null; accessGranted=false; paintWallet(); return; }
          account=a[0]; paintWallet(); await refreshNative(); if (CONFIG.ENABLE_GATE) await checkGate();
        });
        ethereum.on('chainChanged', async cid=>{
          chainId=cid; paintWallet(); await refreshNative(); if (CONFIG.ENABLE_GATE) await checkGate();
        });
      }catch(e){ console.error(e); toast('Wallet connection failed','exclamation-triangle'); }
    }

    function paintWallet(){
      const hasEth = !!window.ethereum;
      provChip.style.display = hasEth ? 'none' : 'inline-flex';
      if (account){
        $('#addrShort').textContent = short(account);
        $('#chainName').textContent = CHAIN_NAMES[chainId] || `Chain ${chainId}`;
        addrChip.style.display='inline-flex'; addrChip.classList.add('ok');
        chainChip.style.display='inline-flex';
        balChip.style.display='inline-flex';
        connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected'; connectBtn.disabled = true;
      }else{
        addrChip.style.display='none'; chainChip.style.display='none'; balChip.style.display='none'; gateChip.style.display='none';
        connectBtn.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet'; connectBtn.disabled = false;
      }
      paintButtonsDisabled();
    }

    function paintButtonsDisabled(){
      const btns = $$('.module-button');
      btns.forEach(b => {
        const disabled = CONFIG.ENABLE_GATE && !accessGranted;
        b.disabled = disabled;
        b.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      });
    }

    async function refreshNative(){
      if (!provider || !account) return;
      try{
        $('#refreshBal').innerHTML = '<span class="loader" style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite"></span>';
        const wei = await provider.getBalance(account);
        const amt = Number(ethers.utils.formatEther(wei));
        $('#nativeBal').textContent = `${amt.toLocaleString(undefined,{maximumFractionDigits:6})} ${NATIVE_SYM(chainId)}`;
      }catch(e){ console.error(e); toast('Balance update failed','exclamation-triangle'); }
      finally{ $('#refreshBal').innerHTML = '<i class="fa-solid fa-rotate"></i>'; }
    }

    async function checkGate(){
      try{
        if (!provider || !account){ gateChip.style.display='none'; accessGranted=false; paintButtonsDisabled(); return; }
        gateChip.style.display='inline-flex';
        $('#gateText').innerHTML = '<span class="loader" style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite"></span> Checking access…';

        const token = new ethers.Contract(CONFIG.TOKEN_ADDRESS, CONFIG.ERC20_ABI, provider);
        const [raw, dec] = await Promise.all([token.balanceOf(account), token.decimals()]);
        const bal = Number(ethers.utils.formatUnits(raw, dec));

        if (bal >= CONFIG.MIN_TOKEN){
          accessGranted = true;
          $('#gateText').innerHTML = `✅ ${bal.toFixed(2)} KLY — Access Granted`;
          gateChip.classList.add('ok');
        }else{
          accessGranted = false;
          $('#gateText').innerHTML = `❌ ${bal.toFixed(2)} KLY — Need ${CONFIG.MIN_TOKEN}+`;
          gateChip.classList.remove('ok');
        }
      }catch(e){
        console.error(e);
        accessGranted = false;
        $('#gateText').innerHTML = 'Error checking token';
      }
      paintButtonsDisabled();
    }

    // Switch to Polygon
    async function switchToPolygon(){
      if (!window.ethereum){ toast('No wallet found','exclamation-triangle'); return; }
      try{
        await ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x89' }] });
      }catch(switchError){
        // If the chain is not added, add it
        if (switchError.code === 4902){
          try{
            await ethereum.request({ method:'wallet_addEthereumChain', params:[{
              chainId:'0x89', chainName:'Polygon Mainnet',
              nativeCurrency:{ name:'MATIC', symbol:'MATIC', decimals:18 },
              rpcUrls:['https://polygon-rpc.com/'], blockExplorerUrls:['https://polygonscan.com/']
            }]});
          }catch(addErr){ console.error(addErr); toast('Failed to add Polygon','exclamation-triangle'); }
        }else{
          console.error(switchError); toast('Network switch rejected','exclamation-triangle');
        }
      }
    }

    // ===== theme toggle =====
    function initTheme(){
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }
    function toggleTheme(){
      const curr = document.documentElement.getAttribute('data-theme');
      const next = curr === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    }
    function updateThemeIcon(theme){
      const icon = $('#themeToggle i');
      icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      restoreCheckboxes();

      document.addEventListener('keydown', e => { if (e.key === 'Escape') hideModule(); });

      $('#themeToggle').addEventListener('click', toggleTheme);
      $('#copyAddr').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(account || ''); toast('Address copied','copy'); }
        catch{ toast('Copy failed','exclamation-triangle'); }
      });

      connectBtn.addEventListener('click', connectWallet);
      $('#refreshBal').addEventListener('click', refreshNative);
      switchPolygonBtn.addEventListener('click', switchToPolygon);

      // Top nav placeholders
      $$('.nav-item').forEach(item=>{
        item.addEventListener('click', ()=>{
          $$('.nav-item').forEach(i=>i.classList.remove('active'));
          item.classList.add('active');
          toast(`Showing ${item.dataset.target}`, 'eye');
        });
      });

      // Auto-open M1 once
      if (!localStorage.getItem('__opened_once__')){ showModule(1); localStorage.setItem('__opened_once__','1'); }

      // Paint initial (no provider/account)
      paintWallet();
    });
  </script>
</body>
</html>
