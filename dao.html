<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KLY DAO</title>
  <style>
    body { background: #0c0c0c; color: white; font-family: sans-serif; text-align: center; padding: 2rem; }
    h1, h2 { color: #00ffe0; }
    input, textarea, button { margin: 0.5rem auto; padding: 0.6rem; border-radius: 6px; display: block; width: 80%; max-width: 400px; }
    .proposal { background: #111; padding: 1rem; margin: 1rem auto; border-radius: 10px; max-width: 600px; }
    button { background: #00ffe0; color: black; cursor: pointer; }
  </style>
</head>
<body>
  <h1>KLY DAO Governance</h1>
  <button id="connectWallet">Connect Wallet</button>
  <div id="walletAddress"></div>

  <h2>DAO Proposals</h2>
  <div id="proposals">Loading...</div>

  <h2>Create Proposal</h2>
  <input id="target" placeholder="Target contract (e.g. 0x...)" />
  <input id="signature" placeholder="Function signature (e.g. transfer(address,uint256))" />
  <input id="params" placeholder='Function parameters (e.g. ["0x123", "1000000000000000000"])' />
  <textarea id="description" placeholder="Proposal description"></textarea>
  <button id="submitProposal">Submit</button>
  <div id="status"></div>

<script type="module">
  import { ethers } from "https://cdn.skypack.dev/ethers";
  import {
    createThirdwebClient,
    getContract,
    prepareContractCall,
    sendTransaction
  } from "https://cdn.skypack.dev/thirdweb";
  import { defineChain } from "https://cdn.skypack.dev/thirdweb/chains";

  const client = createThirdwebClient({ clientId: "YOUR_CLIENT_ID" });
  const contract = getContract({ client, chain: defineChain(56), address: "0x796Bce7F95662774243177D1F546eBA0B3465579" });

  let walletAddress = "";

  async function connect() {
    const [account] = await window.ethereum.request({ method: "eth_requestAccounts" });
    walletAddress = account;
    document.getElementById("walletAddress").innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
    loadProposals();
  }

  async function loadProposals() {
    const list = await contract.read("getAllProposals");
    const container = document.getElementById("proposals");
    container.innerHTML = "";
    list.forEach(p => {
      const el = document.createElement("div");
      el.className = "proposal";
      el.innerHTML = `
        <h3>Proposal #${p.proposalId}</h3>
        <p>${p.description}</p>
        <button onclick="vote(${p.proposalId}, 1)">Vote For</button>
        <button onclick="vote(${p.proposalId}, 0)">Vote Against</button>
      `;
      container.appendChild(el);
    });
  }

  window.vote = async (id, support) => {
    const tx = await prepareContractCall({
      contract,
      method: "function castVote(uint256 proposalId, uint8 support) returns (uint256)",
      params: [id, support]
    });
    const result = await sendTransaction({ transaction: tx, account: walletAddress });
    alert(`Voted! Tx: ${result.transactionHash}`);
  };

  document.getElementById("connectWallet").onclick = connect;

  document.getElementById("submitProposal").onclick = async () => {
    const target = document.getElementById("target").value.trim();
    const signature = document.getElementById("signature").value.trim();
    const paramStr = document.getElementById("params").value.trim();
    const desc = document.getElementById("description").value.trim();
    const status = document.getElementById("status");

    if (!target || !signature || !paramStr || !desc) return status.innerText = "Fill all fields.";

    try {
      const iface = new ethers.utils.Interface([`function ${signature}`]);
      const calldata = iface.encodeFunctionData(signature.split("(")[0], JSON.parse(paramStr));

      const tx = await prepareContractCall({
        contract,
        method: "function propose(address[], uint256[], bytes[], string) returns (uint256)",
        params: [[target], [0], [calldata], desc]
      });
      const result = await sendTransaction({ transaction: tx, account: walletAddress });
      status.innerText = `Proposal submitted: ${result.transactionHash}`;
      loadProposals();
    } catch (e) {
      console.error(e);
      status.innerText = "Failed to submit proposal.";
    }
  };
</script>
</body>
</html>
