<section id="daoSection" class="card">
  <h2>KLY DAO Voting</h2>
  <p>Propose, vote, and shape the future of the KLY ecosystem.</p>
  <a href="https://thirdweb.com/0x796Bce7F95662774243177D1F546eBA0B3465579/governance" target="_blank">
    View Full DAO Dashboard
  </a>
  <button onclick="connectWallet()">Connect Wallet</button>
  <div id="proposalList"></div>
</section>

<script type="module">
  import { ThirdwebSDK } from "https://esm.sh/@thirdweb-dev/sdk@latest";
  import { ethers } from "https://esm.sh/ethers";

  let sdk, signer;

  window.connectWallet = async function () {
    if (window.ethereum) {
      const provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      sdk = ThirdwebSDK.fromSigner(signer, "binance");

      loadProposals();
    } else {
      alert("Please install MetaMask.");
    }
  };

  async function loadProposals() {
    try {
      const vote = await sdk.getContract("0x796Bce7F95662774243177D1F546eBA0B3465579", "vote");
      const proposals = await vote.getAll();

      const list = document.getElementById("proposalList");
      list.innerHTML = ""; // Clear previous content

      proposals.forEach((p) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <h4>${p.description}</h4>
          <button onclick="submitVote('${p.proposalId}', 1)">Yes</button>
          <button onclick="submitVote('${p.proposalId}', 0)">No</button>
          <hr>
        `;
        list.appendChild(div);
      });
    } catch (err) {
      console.error("Failed to load proposals:", err);
      document.getElementById("proposalList").innerText = "Error loading proposals.";
    }
  }

  window.submitVote = async function (proposalId, choice) {
    try {
      const vote = await sdk.getContract("0x796Bce7F95662774243177D1F546eBA0B3465579", "vote");
      await vote.vote(proposalId, choice);
      alert("Vote submitted!");
    } catch (err) {
      console.error("Vote failed:", err);
      alert("Failed to submit vote.");
    }
  };
</script>
