<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLY Sovereign Marketplace</title>
  <meta name="description" content="The official KLY Sovereign Marketplace on BNB Chain — buy and sell Sovereign Art & Tamaquah Nation NFTs." />
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #101010;
      --ink: #ededed;
      --line: #2a2a2a;
      --gold: #d6b25e;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--line); padding-bottom: 14px;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width: 42px; height: 42px; border-radius: 50%;
      background: radial-gradient(60% 60% at 50% 50%, #2e2e2e 0%, #111 100%);
      border: 1px solid #3a3a3a; display:grid; place-items:center; font-weight:800; color: var(--gold);
      letter-spacing: 0.5px;
    }
    .title { line-height: 1.1; margin: 0; font-size: clamp(18px, 3.6vw, 28px); }
    .actions { display:flex; gap:10px; align-items:center; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--line);
      background: #171717; color: var(--ink); cursor: pointer; font-weight: 600;
    }
    .btn:hover { background:#1f1f1f }
    .btn.gold { background: linear-gradient(180deg, #f2d88a, #b9943a); color: #121212; border: none; }
    .grid {
      display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      padding-top: 18px;
    }
    .card {
      background: var(--card); border: 1px solid var(--line); border-radius: 14px; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; background:#0f0f0f }
    .pad { padding: 12px 12px 14px; display:flex; flex-direction:column; gap:8px; }
    .name { font-weight: 700; font-size: 15px; margin: 2px 0 0; }
    .muted { opacity: .8; font-size: 13px; }
    .foot { display:flex; align-items:center; gap:8px; margin-top: 6px; }
    .badge { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--line); font-size: 12px; }
    .buy { margin-left: auto; }
    footer { margin: 26px 0 10px; opacity: .8; font-size: 12px; text-align:center; }
    .notice { border:1px dashed var(--line); padding:10px 12px; border-radius:10px; margin-top:14px; opacity:.95 }
    a { color: var(--gold); text-decoration: none }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">KLY</div>
        <div>
          <h1 class="title">KLY Sovereign Marketplace</h1>
          <div style="font-size:12px; opacity:.8">BNB Smart Chain · Powered by Thirdweb</div>
        </div>
      </div>
      <div class="actions">
        <button id="connect" class="btn">Connect Wallet</button>
        <button id="switch" class="btn">Switch to BNB</button>
      </div>
    </header>

    <div id="alert" class="notice" style="display:none"></div>
    <div id="grid" class="grid"></div>

    <footer>
      1% fee funds KLY staking & Tamaquah Nation development. Thirdweb platform fee 2.5% also applies.
    </footer>
  </div>

<!-- Thirdweb UMD build -->
<script src="https://unpkg.com/thirdweb@latest/dist/thirdweb.umd.js"></script>
<script>
  (function () {
    const CLIENT_ID   = "8f565f3207b79f423c869244e75d34ae"; // public key only
    const MARKETPLACE = "0x43159d07010ec59acc8b7df16eb9657667AD243A";
    const CHAIN       = (window.thirdweb && thirdweb.chains.binance);

    const $connect = document.getElementById("connect");
    const $switch  = document.getElementById("switch");
    const $grid    = document.getElementById("grid");
    const $alert   = document.getElementById("alert");

    const siteUrl = window.location.origin + window.location.pathname;

    function showAlert(msg) {
      if (!$alert) return;
      $alert.style.display = "block";
      $alert.textContent = msg;
      setTimeout(() => ($alert.style.display = "none"), 5000);
    }

    // Wait until script is ready and DOM is loaded
    function ready(fn){ document.readyState !== "loading" ? fn() : document.addEventListener("DOMContentLoaded", fn); }

    ready(async function init() {
      // 1) SDK loaded?
      if (!window.thirdweb) {
        showAlert("Thirdweb SDK failed to load.");
        return;
      }

      // 2) Client + contract
      const client = thirdweb.createThirdwebClient({ clientId: CLIENT_ID });
      const contract = thirdweb.getContract({ client, chain: thirdweb.chains.binance, address: MARKETPLACE });

      let wallet = null;
      window.__klyWallet = null; // for admin page reuse

      // Helper: connect with multiple providers; deep-link fallback for MetaMask mobile
      async function connectWallet() {
        try {
          wallet = await thirdweb.connect({
            client,
            wallets: [
              thirdweb.wallets.metamask(),
              thirdweb.wallets.walletConnect(),      // any mobile wallet via WC
              thirdweb.wallets.coinbaseWallet()      // coinbase option
            ],
            chain: thirdweb.chains.binance,
          });
          window.__klyWallet = wallet;
          showAlert("Wallet connected.");
          return wallet;
        } catch (e) {
          console.error("connect error:", e);

          // No injected provider? Offer MetaMask deep link (mobile)
          const isMobile = /iphone|ipad|ipod|android/i.test(navigator.userAgent);
          const hasInjected = typeof window.ethereum !== "undefined";
          if (isMobile && !hasInjected) {
            const deeplink = "https://metamask.app.link/dapp/" +
              window.location.host + window.location.pathname;
            showAlert("Opening MetaMask…");
            window.location.href = deeplink;
          } else {
            showAlert("Could not open wallet. Make sure a wallet is installed or try WalletConnect.");
          }
          throw e;
        }
      }

      // Bind buttons
      if ($connect) {
        $connect.addEventListener("click", async () => {
          try { await connectWallet(); } catch (_) {}
        }, { passive: true });
      }

      if ($switch) {
        $switch.addEventListener("click", async () => {
          try {
            if (!wallet) await connectWallet();
            await wallet.switchChain(thirdweb.chains.binance);
            showAlert("Switched to BNB Chain.");
          } catch (e) {
            console.error("switch error:", e);
            showAlert("Switch failed. Approve in your wallet or add BNB Chain (ID 56).");
          }
        }, { passive: true });
      }

      // --- Load Listings (defensive) ---
      async function loadListings() {
        try {
          const listings = await contract.read("getAllValidListings", []);
          if (!Array.isArray(listings) || listings.length === 0) {
            $grid.innerHTML =
              '<div class="notice">No active listings yet. Create a direct listing in your admin page or Thirdweb.</div>';
            return;
          }

          const ipfs = (u) => !u ? "" : u.startsWith("ipfs://")
            ? "https://ipfs.io/ipfs/" + u.slice(7)
            : u;

          async function resolveMetadata(l) {
            const assetAddr = l.assetContract || l.asset?.contractAddress;
            const tokenId   = l.tokenId ?? l.asset?.id;
            let name = `Listing #${l.id}`, image = "";

            try {
              if (assetAddr && tokenId !== undefined) {
                const nft = thirdweb.getContract({ client, chain: thirdweb.chains.binance, address: assetAddr });
                // Try ERC721 tokenURI
                try {
                  const uri = await nft.read("tokenURI", [tokenId]);
                  if (uri) {
                    const res = await fetch(ipfs(uri));
                    const meta = await res.json().catch(()=> ({}));
                    name  = meta.name || name;
                    image = ipfs(meta.image || meta.image_url || "");
                  }
                } catch {
                  try {
                    // ERC1155 uri(id) with {id} pattern
                    let uri1155 = await nft.read("uri", [tokenId]);
                    if (uri1155) {
                      const hexId = BigInt(tokenId).toString(16).padStart(64, "0");
                      uri1155 = uri1155.replace("{id}", hexId);
                      const res = await fetch(ipfs(uri1155));
                      const meta = await res.json().catch(()=> ({}));
                      name  = meta.name || name;
                      image = ipfs(meta.image || meta.image_url || "");
                    }
                  } catch {}
                }
              }
            } catch (e) { console.warn("meta fail:", e); }

            if (!name && l.asset?.name)  name  = l.asset.name;
            if (!image && l.asset?.image) image = ipfs(l.asset.image);
            return { name, image };
          }

          $grid.innerHTML = "";
          for (const l of listings) {
            const priceWei = typeof l.pricePerToken === "bigint"
              ? l.pricePerToken
              : BigInt(l.pricePerToken || 0);
            const priceBNB = Number(priceWei) / 1e18;

            const meta = await resolveMetadata(l);
            const name = meta.name;
            const img  = meta.image || "";

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <img class="img" src="${img}" alt="${name}" onerror="this.style.display='none'"/>
              <div class="pad">
                <div class="name">${name}</div>
                <div class="muted">${priceBNB} BNB</div>
                <div class="foot">
                  <span class="badge">Direct</span>
                  <button class="btn gold buy">Buy</button>
                </div>
              </div>
            `;
            card.querySelector(".buy").onclick = async () => {
              try {
                if (!wallet) await connectWallet();
                await wallet.switchChain(thirdweb.chains.binance);
                await contract.write("buyFromListing", [
                  l.id, 1n, "0x0000000000000000000000000000000000000000"
                ]);
                showAlert("Purchase sent—check your wallet.");
              } catch (e) {
                console.error("buy error:", e);
                showAlert("Buy failed. Ensure BNB balance and that the listing is active.");
              }
            };
            $grid.appendChild(card);
          }
        } catch (e) {
          console.error("loadListings error:", e);
          $grid.innerHTML = '<div class="notice">Couldn’t load listings. Check Client ID, domain allowlist, and contract.</div>';
        }
      }

      await loadListings();

      // Soft checks that often block connect:
      // - Domain allowlist
      // - Missing BNB network in wallet
      setTimeout(() => {
        if (!CLIENT_ID) showAlert("Missing Client ID.");
        const host = location.hostname.toLowerCase();
        if (!/kellylegacyestates\.com$/.test(host)) {
          console.log("Tip: Add your domain to Thirdweb → Settings → Domains");
        }
      }, 300);
    });
  })();
</script>
</body>
</html>
