<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamaquah Sovereign Market — Live Listings</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  :root{--bg:#0A1A24;--bg2:#051018;--ink:#EAF7FF;--sub:#9CCBE3;--acc:#73E1FF;--gold:#e2c675;--card:rgba(255,255,255,.06);--card-hover:rgba(255,255,255,.1);--line:rgba(255,255,255,.12);--ok:#4ade80;--warn:#fbbf24;--err:#f87171;--shadow:0 4px 20px rgba(0,0,0,.3);--radius:16px;--radius-sm:8px;--transition:.3s ease}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Space Grotesk',system-ui,sans-serif}
  html,body{background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);min-height:100vh;line-height:1.6}
  .wrap{max-width:1400px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--line);flex-wrap:wrap;gap:16px}
  .brand{font-weight:800;letter-spacing:.08em;font-size:1.5rem;color:var(--acc);text-shadow:0 0 10px rgba(115,225,255,.3);text-transform:uppercase;display:flex;align-items:center;gap:12px}
  .brand i{font-size:1.8rem}
  .pill{padding:.5rem 1rem;border-radius:999px;background:rgba(0,0,0,.2);font-size:.9rem;border:1px solid var(--line);display:flex;align-items:center;gap:6px}
  button,.btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--ink);padding:.7rem 1.2rem;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;transition:var(--transition);display:flex;align-items:center;gap:8px}
  .btn:hover{background:var(--card-hover);transform:translateY(-2px);box-shadow:var(--shadow)}
  .btn-primary{background:linear-gradient(90deg,var(--acc),#a9ffcb);color:#001018;border-color:#2e6b77}
  .btn-primary:hover{background:linear-gradient(90deg,#a9ffcb,var(--acc));transform:translateY(-2px)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none!important}
  .btn:focus-visible{outline:3px solid #a9ffcb;outline-offset:2px}
  .hero{text-align:center;padding:40px 0 30px;max-width:800px;margin:0 auto}
  .hero h1{font-size:clamp(1.8rem,4vw,3rem);letter-spacing:.05em;text-transform:uppercase;margin:8px 0 16px;background:linear-gradient(90deg,var(--acc),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
  .hero p{color:var(--sub);font-size:1.1rem;margin-bottom:24px}
  .controls{display:flex;justify-content:space-between;align-items:center;margin:24px 0;flex-wrap:wrap;gap:16px}
  .search-box{position:relative;max-width:400px;width:100%}
  .search-box input{width:100%;padding:12px 16px 12px 42px;border-radius:var(--radius-sm);background:var(--card);border:1px solid var(--line);color:var(--ink);font-size:1rem}
  .search-box i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--sub)}
  .filters{display:flex;gap:12px;flex-wrap:wrap}
  .filter-btn{padding:8px 16px;border-radius:var(--radius-sm);background:var(--card);border:1px solid var(--line);color:var(--sub);cursor:pointer;transition:var(--transition)}
  .filter-btn.active,.filter-btn[aria-pressed="true"]{background:var(--acc);color:var(--bg);border-color:var(--acc)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px;margin-top:24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:var(--transition);display:flex;flex-direction:column;height:100%}
  .card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.4);border-color:rgba(115,225,255,.3)}
  .row{display:flex;justify-content:space-between;align-items:center;margin:.5rem 0;gap:10px;flex-wrap:wrap}
  .thumb-container{position:relative;width:100%;border-radius:12px;overflow:hidden;margin-bottom:12px}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:linear-gradient(45deg,#0c1d27,#0a2738);transition:var(--transition)}
  .card:hover .thumb{transform:scale(1.05)}
  .token-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:var(--ink);padding:4px 8px;border-radius:6px;font-size:.8rem;backdrop-filter:blur(5px)}
  .sub{color:var(--sub);font-size:.9rem}
  .status{min-height:18px;font-size:.9rem;margin-top:6px;display:flex;align-items:center;gap:6px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .price{font-size:1.2rem;font-weight:700;color:var(--gold)}
  .card-actions{display:flex;gap:10px;margin-top:auto;padding-top:12px}
  .card-actions .btn{flex:1;justify-content:center}
  footer{margin:40px 0 0;text-align:center;color:var(--sub);font-size:.9rem;padding-top:20px;border-top:1px solid var(--line)}
  .loading{display:flex;justify-content:center;align-items:center;padding:40px;flex-direction:column;gap:16px}
  .spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.1);border-left:4px solid var(--acc);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  @media (max-width:768px){.wrap{padding:16px}header{flex-direction:column;text-align:center}.controls{flex-direction:column;align-items:stretch}.search-box{max-width:100%}.grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}}
  @media (max-width:480px){.grid{grid-template-columns:1fr}.brand{font-size:1.2rem}.hero h1{font-size:1.6rem}}
  .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

  /* === Skeleton styles === */
  @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
  .skeleton{border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,.06) 25%,rgba(255,255,255,.12) 37%,rgba(255,255,255,.06) 63%);background-size:400% 100%;animation:shimmer 1.4s ease-in-out infinite}
  .skeleton-thumb{width:100%;aspect-ratio:1/1;margin-bottom:12px}
  .skeleton-text{height:16px;margin-bottom:10px}
  .skeleton-text.short{width:60%}
  .skeleton-btn{height:42px;flex:1}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <i class="fas fa-seedling" aria-hidden="true"></i>
      <span>TAMAQUAH SOVEREIGN MARKET</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center">
      <span class="pill"><i class="fas fa-store"></i> Marketplace: <span id="mpAddrShort">—</span></span>
      <span class="pill"><i class="fas fa-link"></i> Chain: BNB</span>
      <button id="connect" class="btn"><i class="fas fa-wallet"></i> Connect Wallet</button>
      <span id="who" class="pill" style="display:none"><i class="fas fa-user"></i> <span id="whoAddr">—</span></span>
    </div>
  </header>

  <section class="hero">
    <h1>Live Listings</h1>
    <p>Pulled from your MarketplaceV3 contract. Auto-refreshes every 30s.</p>
    <div class="pill" aria-live="polite"><i class="fas fa-sync-alt"></i> Auto-refresh enabled</div>
  </section>

  <section class="controls" role="region" aria-label="Search and filters">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <label class="sr-only" for="search">Search listings</label>
      <input type="text" id="search" placeholder="Search by name, token ID, or contract address..." autocomplete="off" inputmode="search"/>
    </div>
    <div class="filters" role="toolbar" aria-label="Listing filters">
      <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
      <button class="filter-btn" data-filter="erc721" aria-pressed="false">ERC-721</button>
      <button class="filter-btn" data-filter="erc1155" aria-pressed="false">ERC-1155</button>
      <button class="filter-btn" data-filter="native" aria-pressed="false">BNB</button>
      <button class="filter-btn" data-filter="kly" aria-pressed="false">KLY</button>
      <!-- Collection filters -->
      <button class="filter-btn" data-filter="coll:0xdC5aA33c45Aa3777d3ccf51521cE329B03D39ea7" aria-pressed="false">9 Genesis Mythic Avatars</button>
      <button class="filter-btn" data-filter="coll:0x2EB40e1dCaA7faFc14040352d7aa37C6D6FBA989" aria-pressed="false">Ancestral Mechs</button>
      <button class="filter-btn" data-filter="coll:0xF98796F28c40b2d0A238B951E72C14Cdf2C4Da11" aria-pressed="false">Tribal Punk Cryptids</button>
    </div>
  </section>

  <section>
    <p id="err" class="status err" style="text-align:center"></p>
    <div id="listings" class="grid" aria-live="polite">
      <!-- initial skeletons -->
      <div class="card">
        <div class="skeleton skeleton-thumb"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="card-actions">
          <div class="skeleton skeleton-btn"></div>
          <div class="skeleton skeleton-btn"></div>
        </div>
      </div>
      <div class="card">
        <div class="skeleton skeleton-thumb"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="card-actions">
          <div class="skeleton skeleton-btn"></div>
          <div class="skeleton skeleton-btn"></div>
        </div>
      </div>
      <div class="card">
        <div class="skeleton skeleton-thumb"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="card-actions">
          <div class="skeleton skeleton-btn"></div>
          <div class="skeleton skeleton-btn"></div>
        </div>
      </div>
    </div>
    <p id="empty" class="sub" style="display:none;text-align:center;padding:40px">
      <i class="fas fa-box-open" style="font-size:3rem;margin-bottom:16px;opacity:.5"></i><br>
      No active listings found.
    </p>
  </section>

  <footer>
    <p>They took the land. We took the future.</p>
    <p style="margin-top:8px;font-size:.8rem;opacity:.7">Tamaquah Sovereign Market • Powered by ethers</p>
  </footer>
</div>

<script type="module">
/* ===================== CONFIG ===================== */
const RPC = "https://bsc-dataseed.binance.org/";
const CHAIN_ID = 56; // BNB Chain
const MARKETPLACE_ADDR = "0x43159d07010ec59acc8b7df16eb9657667AD243A";

const ZERO = "0x0000000000000000000000000000000000000000";
const NATIVE_SENTINEL = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee".toLowerCase(); // Thirdweb's native marker

// Known currencies
const KNOWN = {
  [ZERO]: { symbol: "BNB", decimals: 18, isNative: true },
  [NATIVE_SENTINEL]: { symbol: "BNB", decimals: 18, isNative: true },
  "0x2e4feb2fe668c8ebe84f19e6c8fe8cf8131b4e52": { symbol: "KLY", decimals: 18, isNative: false },
};

// Collection names (lowercased keys)
const COLLECTIONS = {
  "0xdc5aa33c45aa3777d3ccf51521ce329b03d39ea7": "9 Genesis Mythic Avatars",
  "0x2eb40e1dcaa7fafc14040352d7aa37c6d6fba989": "Ancestral Mechs: Bloodline Codex",
  "0xf98796f28c40b2d0a238b951e72c14cdf2c4da11": "Tribal Punk Cryptids"
};

/* ===================== ABIs (trimmed) ===================== */
const MARKET_ABI = [
  {"inputs":[],"name":"totalListings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"_startId","type":"uint256"},{"internalType":"uint256","name":"_endId","type":"uint256"}],"name":"getAllListings","outputs":[{"components":[
    {"internalType":"uint256","name":"listingId","type":"uint256"},
    {"internalType":"uint256","name":"tokenId","type":"uint256"},
    {"internalType":"uint256","name":"quantity","type":"uint256"},
    {"internalType":"uint256","name":"pricePerToken","type":"uint256"},
    {"internalType":"uint128","name":"startTimestamp","type":"uint128"},
    {"internalType":"uint128","name":"endTimestamp","type":"uint128"},
    {"internalType":"address","name":"listingCreator","type":"address"},
    {"internalType":"address","name":"assetContract","type":"address"},
    {"internalType":"address","name":"currency","type":"address"},
    {"internalType":"uint8","name":"tokenType","type":"uint8"},
    {"internalType":"uint8","name":"status","type":"uint8"},
    {"internalType":"bool","name":"reserved","type":"bool"}
  ],"internalType":"struct IDirectListings.Listing[]","name":"_allListings","type":"tuple[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"_listingId","type":"uint256"}],"name":"getListing","outputs":[{"components":[
    {"internalType":"uint256","name":"listingId","type":"uint256"},
    {"internalType":"uint256","name":"tokenId","type":"uint256"},
    {"internalType":"uint256","name":"quantity","type":"uint256"},
    {"internalType":"uint256","name":"pricePerToken","type":"uint256"},
    {"internalType":"uint128","name":"startTimestamp","type":"uint128"},
    {"internalType":"uint128","name":"endTimestamp","type":"uint128"},
    {"internalType":"address","name":"listingCreator","type":"address"},
    {"internalType":"address","name":"assetContract","type":"address"},
    {"internalType":"address","name":"currency","type":"address"},
    {"internalType":"uint8","name":"tokenType","type":"uint8"},
    {"internalType":"uint8","name":"status","type":"uint8"},
    {"internalType":"bool","name":"reserved","type":"bool"}
  ],"internalType":"struct IDirectListings.Listing","name":"listing","type":"tuple"}],"stateMutability":"view","type":"function"},
  {"inputs":[
    {"internalType":"uint256","name":"_listingId","type":"uint256"},
    {"internalType":"address","name":"_buyFor","type":"address"},
    {"internalType":"uint256","name":"_quantity","type":"uint256"},
    {"internalType":"address","name":"_currency","type":"address"},
    {"internalType":"uint256","name":"_expectedTotalPrice","type":"uint256"}
  ],"name":"buyFromListing","outputs":[],"stateMutability":"payable","type":"function"}
];

const ERC20_MIN_ABI = [
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];
const ERC721_MIN_ABI = [
  "function tokenURI(uint256 tokenId) view returns (string)",
  "function name() view returns (string)"
];
const ERC1155_MIN_ABI = [
  "function uri(uint256 id) view returns (string)"
];

/* ===================== IPFS HELPERS (encoded + rotating) ===================== */
const DEBUG_META = true; // set to false after you verify in console

const IPFS_GWS = [
  "https://blush-worthy-ape-39.mypinata.cloud/ipfs/",
  "https://ipfs.io/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/"
];

// Encode each path segment (handles spaces, unicode, etc.)
function encodeIpfsPath(path) {
  const [pure, tail=""] = path.split(/([?#].*)/); // keep ?query / #hash intact
  const parts = pure.split("/").map(p => encodeURIComponent(p));
  return parts.join("/") + tail;
}

// Turn any ipfs-ish URL into an ordered list of HTTP URLs (encoded)
function resolveIPFS(urlOrIpfs){
  if (!urlOrIpfs) return [];
  if (/^https?:\/\//i.test(urlOrIpfs)) return [urlOrIpfs]; // already HTTP(S)

  let path = null;
  if (urlOrIpfs.startsWith("ipfs://")) path = urlOrIpfs.slice(7);
  else {
    const m = urlOrIpfs.split("/ipfs/");
    if (m.length > 1) path = m[1];
  }
  if (!path) return [urlOrIpfs];

  const enc = encodeIpfsPath(path);
  const urls = IPFS_GWS.map(gw => gw + enc);
  if (DEBUG_META) console.log("[IPFS] resolved", { input:urlOrIpfs, encPath:enc, urls });
  return urls;
}

// Try all gateways for JSON
async function fetchJsonWithGateways(urlOrIpfs){
  const urls = resolveIPFS(urlOrIpfs);
  for (const url of urls){
    try{
      const r = await fetch(url, { cache:"no-cache", referrerPolicy:"no-referrer" });
      if (r.ok) {
        const j = await r.json();
        if (DEBUG_META) console.log("[META] OK", url, j);
        return j;
      }
      if (DEBUG_META) console.warn("[META] HTTP not ok", url, r.status);
    }catch(e){
      if (DEBUG_META) console.warn("[META] fetch error", url, e?.message||e);
    }
  }
  return null;
}

// Rotate <img> src across gateways on error
function setImgWithFallback(imgEl, urlOrIpfs){
  const urls = resolveIPFS(urlOrIpfs);
  if (urls.length === 0){ imgEl.removeAttribute("src"); return; }
  let i = 0;
  const trySet = ()=> { imgEl.src = urls[i]; if (DEBUG_META) console.log("[IMG] try", imgEl.alt, urls[i]); i++; };
  imgEl.onerror = ()=> { if (i < urls.length) trySet(); };
  trySet();
}
/* ===================== PROVIDERS / STATE ===================== */
const rpcProvider = new ethers.providers.JsonRpcProvider(RPC, { name:"bsc", chainId: CHAIN_ID });
const marketRead = new ethers.Contract(MARKETPLACE_ADDR, MARKET_ABI, rpcProvider);

let web3prov = null, signer = null, me = null;

$("connect").addEventListener("click", async ()=>{
  $("err").textContent = "";
  try{
    if(!window.ethereum) throw new Error("MetaMask not detected in this browser.");
    web3prov = new ethers.providers.Web3Provider(window.ethereum, "any");
    await web3prov.send("eth_requestAccounts", []);
    const net = await web3prov.getNetwork();
    if (Number(net.chainId) !== CHAIN_ID){
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: "0x"+CHAIN_ID.toString(16)}] });
    }
    signer = web3prov.getSigner();
    me = await signer.getAddress();
    $("whoAddr").textContent = short(me);
    $("who").style.display = "inline-block";
    $("connect").style.display = "none";
  }catch(e){ $("err").textContent = e?.message || "Failed to connect wallet."; }
});

/* ===================== SKELETON BUILDER ===================== */
function skeletonCards(n=6){
  const one = `
    <div class="card">
      <div class="skeleton skeleton-thumb"></div>
      <div class="skeleton skeleton-text"></div>
      <div class="skeleton skeleton-text short"></div>
      <div class="card-actions">
        <div class="skeleton skeleton-btn"></div>
        <div class="skeleton skeleton-btn"></div>
      </div>
    </div>`;
  return new Array(n).fill(one).join('');
}

/* ===================== LOAD LISTINGS ===================== */
let loading=false, refreshTimer=null;

async function loadListings(){
  if (loading) return; loading = true;
  $("err").textContent = "";
  $("empty").style.display = "none";
  $("listings").innerHTML = skeletonCards(6);

  try{
    const total = (await marketRead.totalListings()).toNumber();
    if (total === 0){ $("listings").innerHTML=""; $("empty").style.display="block"; loading=false; return; }
    const listings = await marketRead.getAllListings(0, total-1);

    // Normalize
    const rows = listings.map(L => ({
      id: Number(L.listingId),
      asset: L.assetContract,
      tokenId: L.tokenId.toString(),
      quantity: Number(L.quantity),
      pricePerToken: L.pricePerToken, // BigNumber
      start: L.startTimestamp.toString(),
      end: L.endTimestamp.toString(),
      creator: L.listingCreator,
      currency: (L.currency || ZERO).toLowerCase(),
      tokenType: Number(L.tokenType), // 1=ERC721, 0=ERC1155
      status: Number(L.status),
      reserved: Boolean(L.reserved),
    }));

    await render(rows);
  }catch(e){
    console.error(e);
    $("listings").innerHTML="";
    $("err").textContent = e?.message || "Couldn't load listings.";
    $("empty").style.display="block";
  } finally { loading=false; }
}

/* ===================== STATUS ===================== */
function deriveStatus(row){
  const now = Math.floor(Date.now()/1000);
  if (typeof row.status === "number" && row.status !== 1) return {label:"Inactive", cls:"warn", actionable:false};
  if (row.quantity === 0) return {label:"Completed", cls:"warn", actionable:false};
  if (row.reserved) return {label:"Reserved", cls:"warn", actionable:false};
  if (row.end && Number(row.end) !== 0 && Number(row.end) < now) return {label:"Expired", cls:"warn", actionable:false};
  if (row.start && Number(row.start) !== 0 && Number(row.start) > now) return {label:"Scheduled", cls:"warn", actionable:false};
  return {label:"Active", cls:"ok", actionable:true};
}

/* ===================== META HELPERS ===================== */
const erc20Cache = new Map();
async function getCurrencyMeta(addr){
  const a = (addr||ZERO).toLowerCase();
  if (KNOWN[a]) return KNOWN[a];
  if (erc20Cache.has(a)) return erc20Cache.get(a);
  try{
    const erc = new ethers.Contract(a, ERC20_MIN_ABI, rpcProvider);
    const [dec, sym] = await Promise.all([erc.decimals(), erc.symbol()]);
    const meta = { decimals: Number(dec), symbol: String(sym||"ERC20"), isNative:false };
    erc20Cache.set(a, meta); return meta;
  }catch{
    const meta = { decimals: 18, symbol: "ERC20", isNative:false };
    erc20Cache.set(a, meta); return meta;
  }
}

async function getNFTMeta(asset, tokenId, tokenType){
  try{
    if (tokenType === 1){ // ERC721
      const c721 = new ethers.Contract(asset, ERC721_MIN_ABI, rpcProvider);
      const uri = await c721.tokenURI(tokenId);
      const json = await fetchJsonWithGateways(uri);
      return {
        name: json?.name || `Token #${tokenId}`,
        image: (json?.image || json?.image_url || json?.imageUri || ""),
        description: json?.description || ""
      };
    } else { // ERC1155
      const c1155 = new ethers.Contract(asset, ERC1155_MIN_ABI, rpcProvider);
      const tpl  = await c1155.uri(tokenId);
      const meta = resolve1155Uri(tpl, tokenId);
      const json = await fetchJsonWithGateways(meta);
      return {
        name: json?.name || `Token #${tokenId}`,
        image: (json?.image || json?.image_url || json?.imageUri || ""),
        description: json?.description || ""
      };
    }
  }catch(e){
    console.error("getNFTMeta error:", { asset, tokenId: String(tokenId), tokenType, error: e });
    return { name: `Token #${tokenId}`, image: "", description: "" };
  }
}

/* ===================== SEARCH / FILTERS ===================== */
function setupSearchAndFilter(){
  const searchInput = $('search');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const apply = ()=> filterListings(searchInput.value.toLowerCase(), getActiveFilter());
  const debouncedApply = debounce(apply, 200);
  searchInput.oninput = debouncedApply;
  filterButtons.forEach(btn=>{
    btn.onclick = function(){
      filterButtons.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      this.classList.add('active'); this.setAttribute('aria-pressed','true');
      apply();
    };
  });
}
function getActiveFilter(){ const a=document.querySelector('.filter-btn.active'); return a ? a.getAttribute('data-filter') : 'all'; }
function filterListings(searchTerm, filter){
  const cards = document.querySelectorAll('.card[data-contract]'); let visible=0;
  cards.forEach(card=>{
    const tokenType = card.getAttribute('data-token-type');
    const currency = card.getAttribute('data-currency');
    const name = (card.getAttribute('data-name')||"").toLowerCase();
    const tokenId = (card.getAttribute('data-token-id')||"").toLowerCase();
    const contract = (card.getAttribute('data-contract')||"").toLowerCase();
    let ok = true;
    if (filter !== 'all') {
      if (filter === 'erc721') ok = tokenType === 'erc721';
      else if (filter === 'erc1155') ok = tokenType === 'erc1155';
      else if (filter === 'native') ok = currency === 'bnb';
      else if (filter === 'kly') ok = currency === 'kly';
      else if (filter.startsWith('coll:')) ok = contract === filter.slice(5).toLowerCase();
    }
    let sOK = true;
    if (searchTerm) sOK = name.includes(searchTerm) || tokenId.includes(searchTerm) || contract.includes(searchTerm);
    if (ok && sOK){ card.style.display='flex'; visible++; } else card.style.display='none';
  });
  $('empty').style.display = visible === 0 ? 'block' : 'none';
}

/* ===================== RENDER ===================== */
async function render(rows){
  const grid = $("listings"); grid.innerHTML = "";

  // concurrency limiter
  const limit = (n)=>{ const q=[]; let a=0;
    const run=fn=>new Promise((res,rej)=>{ const step=()=>{ if(a>=n) return q.push(step); a++; fn().then(res,rej).finally(()=>{ a--; (q.shift()||(()=>{}))();});}; step();});
    return run;
  };
  const run = limit(6);

  const cards = await Promise.all(rows.map(r=>run(async ()=>{
    const [curMeta, md] = await Promise.all([ getCurrencyMeta(r.currency), getNFTMeta(r.asset, r.tokenId, r.tokenType) ]);
    const st = deriveStatus(r);
    const priceStr = `${prettyUnits(r.pricePerToken, curMeta.decimals)} ${curMeta.symbol}`;
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("data-token-type", r.tokenType === 1 ? "erc721" : "erc1155");
    card.setAttribute("data-currency", (curMeta.symbol||"").toLowerCase());
    card.setAttribute("data-name", (md.name||"").toLowerCase());
    card.setAttribute("data-token-id", r.tokenId);
    card.setAttribute("data-contract", r.asset.toLowerCase());

    const collName = COLLECTIONS[r.asset.toLowerCase()] || short(r.asset);
    const placeholder = `https://via.placeholder.com/600/0c1d27/73E1FF?text=${encodeURIComponent(r.tokenId)}`;

    card.innerHTML = `
      <div class="thumb-container">
        <img class="thumb" id="img-${r.id}" loading="lazy" decoding="async" referrerpolicy="no-referrer" alt="NFT preview for ${escapeHtml(md.name)}">
        <div class="token-badge">${st.label} • ${r.tokenType===1?"ERC-721":"ERC-1155"}</div>
      </div>
      <div class="row" style="margin-top:.5rem">
        <strong>${escapeHtml(md.name)}</strong>
        <span class="sub">${escapeHtml(collName)} • Listing #${r.id}</span>
      </div>
      <div class="row">
        <span class="sub">${short(r.asset)} · #${r.tokenId}</span>
        <span class="price">${priceStr}</span>
      </div>
      ${md.description ? `<div class="sub" style="margin-top:8px;font-size:.85rem;line-height:1.4">${escapeHtml(md.description.length>140?md.description.slice(0,140)+'…':md.description)}</div>` : ''}
      <div class="card-actions">
        <a class="btn" href="https://thirdweb.com/binance/${MARKETPLACE_ADDR}/listings/${r.id}" target="_blank" rel="noopener">
          <i class="fas fa-external-link-alt"></i> Details
        </a>
        ${st.actionable ? `
          <button class="btn btn-primary" data-buy="${r.id}">
            <i class="fas fa-shopping-cart"></i> Buy Now
          </button>` : `
          <button class="btn" disabled title="Not purchasable right now">
            <i class="fas fa-ban"></i> Unavailable
          </button>`}
      </div>
      <div id="st-${r.id}" class="status ${st.cls}" role="status" aria-live="polite">${st.label}</div>
    `;

    // mount image with fallback gateways
    const imgEl = card.querySelector(`#img-${r.id}`);
    if (md.image) {
      setImgWithFallback(imgEl, md.image);
      imgEl.onerror = ()=>{ imgEl.onerror=null; imgEl.src = placeholder; };
    } else {
      imgEl.src = placeholder;
    }

    return card;
  })));

  for(const c of cards) if(c) grid.appendChild(c);
  setupSearchAndFilter();
}

/* ===================== BUY ===================== */
$("listings").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-buy]"); if(!btn) return;
  const id = Number(btn.getAttribute("data-buy"));
  const st = $("st-"+id);
  $("err").textContent = "";

  try{
    if (!window.ethereum) throw new Error("MetaMask not detected.");
    if (!signer) await $("connect").click();
    if (!signer) return;

    const marketWrite = new ethers.Contract(MARKETPLACE_ADDR, MARKET_ABI, signer);
    const L = await marketRead.getListing(id); // fresh read
    const currency = (L.currency || ZERO).toLowerCase();
    const qty = ethers.BigNumber.from(1);
    const total = L.pricePerToken.mul(qty);

    // client-side checks
    const row = {
      quantity: Number(L.quantity),
      status: Number(L.status),
      reserved: Boolean(L.reserved),
      start: L.startTimestamp.toString(),
      end: L.endTimestamp.toString()
    };
    const s = deriveStatus(row);
    if (!s.actionable) throw new Error(`Listing is ${s.label.toLowerCase()}`);

    // If ERC20 -> ensure allowance
    if (currency !== ZERO && currency !== NATIVE_SENTINEL){
      const erc = new ethers.Contract(currency, ERC20_MIN_ABI, signer);
      const owner = await signer.getAddress();
      const allowance = await erc.allowance(owner, MARKETPLACE_ADDR);
      if (allowance.lt(total)){
        st.className="status"; st.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Approving...";
        const txa = await erc.approve(MARKETPLACE_ADDR, total);
        await txa.wait();
      }
    }

    st.className="status"; st.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Buying...";

    const overrides = {};
    if (currency === ZERO || currency === NATIVE_SENTINEL){ overrides.value = total; }

    const tx = await marketWrite.buyFromListing(
      id,
      await signer.getAddress(),
      qty,
      currency,
      total,
      overrides
    );
    await tx.wait();

    st.className="status ok"; st.innerHTML = `<i class="fas fa-check"></i> Purchase confirmed`;
    loadListings();
  }catch(err){
    console.error(err);
    st.className="status err";
    st.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${escapeHtml(err?.error?.message || err?.message || "Transaction failed")}`;
  }
});

/* ===================== BOOT ===================== */
async function start(){
  await loadListings();
  clearInterval(refreshTimer);
  refreshTimer = setInterval(loadListings, 30000);
}
start();
</script>
</body>
</html>
