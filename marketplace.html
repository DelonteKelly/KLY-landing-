<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tamaquah Sovereign Marketplace — Live Listings</title>

<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

<style>
  :root{
    --bg:#0A1A24; --bg2:#051018; --ink:#EAF7FF; --sub:#9CCBE3; --accent:#73E1FF; --gold:#e2c675;
    --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
    --ok:#4ade80; --warn:#fbbf24; --err:#f87171;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Space Grotesk',system-ui,sans-serif}
  html,body{background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);min-height:100vh}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .brand{font-weight:800;letter-spacing:.08em;font-size:1.35rem;color:var(--accent);text-shadow:0 0 10px rgba(115,225,255,.3);text-transform:uppercase}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:.5rem .9rem;border-radius:999px;background:rgba(0,0,0,.2);font-size:.9rem}
  button, .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--ink);padding:.6rem .9rem;border-radius:10px;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#a9ffcb);color:#001018;border-color:#2e6b77}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hero{margin:14px 0 8px}
  .hero h1{font-size:clamp(1.6rem,3.5vw,2.4rem);letter-spacing:.05em;text-transform:uppercase;background:linear-gradient(90deg,var(--accent),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .hero p{color:var(--sub);margin-top:6px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,.3)}
  .row{display:flex;justify-content:space-between;align-items:center;margin:.25rem 0}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid var(--line);object-fit:cover;background:linear-gradient(45deg,#0c1d27,#0a2738)}
  .sub{color:var(--sub);font-size:.9rem}
  .status{min-height:18px;font-size:.9rem;margin-top:6px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  footer{margin:22px 0 0;text-align:center;color:var(--sub);font-size:.9rem}
  @media (max-width:640px){ .wrap{padding:18px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">TAMAQUAH SOVEREIGN MARKET</div>
    <div class="controls">
      <span class="pill">Marketplace: <span id="mpAddrShort">—</span></span>
      <span class="pill">Chain: BNB</span>
      <label class="pill" style="display:flex;gap:8px;align-items:center">
        <input id="buyToggle" type="checkbox" />
        Enable Buy Button
      </label>
      <button id="connect" class="btn">Connect Wallet</button>
      <span id="who" class="pill" style="display:none"></span>
    </div>
  </header>

  <section class="hero">
    <h1>Live Listings</h1>
    <p>All active listings fetched directly from your MarketplaceV3 smart contract. Auto-refreshes every 30s.</p>
  </section>

  <section>
    <div id="listings" class="grid"></div>
    <p id="empty" class="sub" style="display:none">No active listings.</p>
    <p id="err" class="status err"></p>
  </section>

  <footer>They took the land. We took the future.</footer>
</div>

<script type="module">
/* ================= CONFIG ================= */
const MARKETPLACE_ADDR = "0x43159d07010ec59acc8b7df16eb9657667AD243A";
const BSC_CHAIN_ID = 56;

// RPC rotation (auto-fallback)
const RPC_POOL = [
  "https://bsc-dataseed1.ninicoin.io/",
  "https://bsc-dataseed1.defibit.io/",
  "https://bsc-dataseed1.bnbchain.org/",
  "https://bsc-dataseed.binance.org/"
];

// Known currencies for instant price formatting
const KNOWN = {
  "0x0000000000000000000000000000000000000000": { symbol:"BNB", decimals:18 },
  "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52": { symbol:"KLY", decimals:18 }
};

/* ================= ABIs ================= */
const MP_ABI = [
  // Common getters (some builds have only one of these)
  "function getAllListings(uint256 start,uint256 count) view returns (tuple(uint256 id,address tokenOwner,address assetContract,uint256 tokenId,uint256 startTime,uint256 endTime,address seller,address currency,uint256 reservePricePerToken,uint256 buyoutPricePerToken,uint256 quantity,uint8 tokenType,uint8 listingType,uint8 status)[])",
  "function getAllValidListings(uint256 start,uint256 count) view returns (tuple(uint256 id,address assetContract,uint256 tokenId,uint256 startTime,uint256 endTime,address seller,address currency,uint256 reservePricePerToken,uint256 buyoutPricePerToken,uint256 quantity,uint8 tokenType,uint8 listingType)[])",
  "function getAllActiveListings(uint256 start,uint256 count) view returns (tuple(uint256 id,address assetContract,uint256 tokenId,uint256 startTime,uint256 endTime,address seller,address currency,uint256 reservePricePerToken,uint256 buyoutPricePerToken,uint256 quantity,uint8 tokenType,uint8 listingType)[])",
  // Buy
  "function buyFromListing(uint256,address,uint256,address,uint256) payable"
];
const ERC721_READ = ["function tokenURI(uint256) view returns (string)"];
const ERC1155_READ = ["function uri(uint256) view returns (string)"];
const ERC20_MIN = [
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

/* ================= Providers (with fallback) ================= */
let rpcIdx = 0;
let readProvider = new ethers.JsonRpcProvider(RPC_POOL[rpcIdx]);
function rotateProvider(){
  rpcIdx = (rpcIdx + 1) % RPC_POOL.length;
  readProvider = new ethers.JsonRpcProvider(RPC_POOL[rpcIdx]);
}
const mpRead = ()=> new ethers.Contract(MARKETPLACE_ADDR, MP_ABI, readProvider);

let walletProvider=null, signer=null, me=null, mpWrite=null;

/* ================= DOM helpers ================= */
const $ = (id)=>document.getElementById(id);
const short = (a)=> a ? `${a.slice(0,6)}…${a.slice(-4)}` : "—";
$("mpAddrShort").textContent = short(MARKETPLACE_ADDR);

/* ================= UX helpers ================= */
const ZERO = "0x0000000000000000000000000000000000000000";
const gateways = ["https://ipfs.io/ipfs/","https://cloudflare-ipfs.com/ipfs/","https://gateway.pinata.cloud/ipfs/"];
const ipfs = (u,i=0)=>u?.startsWith("ipfs://")? gateways[Math.min(i,gateways.length-1)] + u.slice(7): u;
async function fetchJsonFallback(u){
  let err;
  for (let i=0;i<gateways.length;i++){
    try{
      const r=await fetch(ipfs(u,i),{referrerPolicy:"no-referrer"});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(e){ err=e; }
  }
  throw err||new Error("IPFS fetch failed");
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ============== Connect (optional for Buy) ============== */
$("connect").addEventListener("click", connect);
$("buyToggle").addEventListener("change", ()=> render(lastListings));

async function connect(){
  $("err").textContent="";
  try{
    if(!window.ethereum) throw new Error("MetaMask not detected");
    walletProvider = new ethers.BrowserProvider(window.ethereum,'any');
    await walletProvider.send("eth_requestAccounts",[]);
    const net = await walletProvider.getNetwork();
    if (Number(net.chainId)!==BSC_CHAIN_ID){
      try{
        await walletProvider.send("wallet_switchEthereumChain",[{chainId:"0x"+BSC_CHAIN_ID.toString(16)}]);
      }catch(e){
        if (e?.code===4902){
          await walletProvider.send("wallet_addEthereumChain",[{
            chainId:"0x"+BSC_CHAIN_ID.toString(16),
            chainName:"BNB Smart Chain",
            nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
            rpcUrls:[RPC_POOL[rpcIdx]],
            blockExplorerUrls:["https://bscscan.com"]
          }]);
        }else{ throw e; }
      }
    }
    signer = await walletProvider.getSigner();
    me = await signer.getAddress();
    mpWrite = new ethers.Contract(MARKETPLACE_ADDR, MP_ABI, signer);
    $("who").textContent = short(me);
    $("who").style.display = "inline-block";
    $("connect").style.display = "none";
    window.ethereum.on?.('accountsChanged', ()=>location.reload());
    window.ethereum.on?.('chainChanged',  ()=>location.reload());
    render(lastListings);
  }catch(e){ $("err").textContent = e?.message || "Failed to connect wallet."; }
}

/* ============== Listings loader with method/RPC fallback ============== */
let lastListings = [];
let loading = false;
const spinner = document.createElement("p");
spinner.className = "sub"; spinner.textContent = "Loading listings…";
async function loadListings(){
  if (loading) return; loading=true;
  $("err").textContent=""; $("empty").style.display="none";
  $("listings").innerHTML=""; $("listings").appendChild(spinner);

  for (let tries=0; tries<RPC_POOL.length; tries++){
    try{
      const mp = mpRead();
      let rows;
      // try the 3 shapes in order
      try {
        rows = await mp.getAllListings(0, 60);
        rows = rows.filter(r => Number(r.status) === 1);
      } catch {
        try {
          rows = await mp.getAllValidListings(0, 60);
        } catch {
          rows = await mp.getAllActiveListings(0, 60);
        }
      }

      lastListings = rows.map(n => ({
        id: Number(n.id),
        asset: n.assetContract,
        tokenId: Number(n.tokenId),
        tokenType: Number(n.tokenType),      // 0:1155, 1:721
        listingType: Number(n.listingType),  // 0:Direct, 1:Auction
        currency: n.currency,
        buyout: n.buyoutPricePerToken
      }));

      $("listings").removeChild(spinner);
      if (!lastListings.length){ $("empty").style.display="block"; }
      await render(lastListings);
      loading=false;
      return;
    }catch(e){
      // rotate RPC and retry
      rotateProvider();
      if (tries === RPC_POOL.length-1){
        $("listings").removeChild(spinner);
        $("err").textContent = "Couldn't load listings — check Marketplace address/RPC.";
        $("empty").style.display="block";
        loading=false;
      }
    }
  }
}

/* ============== Metadata cache ============== */
const metaCache = new Map(); // key: `${asset}-${tokenId}`
async function getPreview(asset, tokenId, tokenType){
  const key = `${asset}-${tokenId}`;
  if (metaCache.has(key)) return metaCache.get(key);

  let name = `#${tokenId}`, image = "";
  try{
    if (tokenType===1){ // ERC-721
      const c = new ethers.Contract(asset, ERC721_READ, readProvider);
      const uri = await c.tokenURI(tokenId);
      const j = await fetchJsonFallback(uri);
      image = ipfs(j.image || j.image_url || ""); name = j.name || name;
    }else{ // ERC-1155
      const c = new ethers.Contract(asset, ERC1155_READ, readProvider);
      let uri = await c.uri(tokenId);
      if (uri.includes("{id}")){
        const hex = tokenId.toString(16).padStart(64,"0").toLowerCase();
        uri = uri.replace("{id}", hex);
      }
      const j = await fetchJsonFallback(uri);
      image = ipfs(j.image || j.image_url || ""); name = j.name || name;
    }
  }catch{/* ignore */}
  const out = { name, image };
  metaCache.set(key, out);
  return out;
}

/* ============== Render ============== */
async function render(rows){
  const grid = $("listings");
  grid.innerHTML = "";
  const doBuy = $("buyToggle").checked && signer && mpWrite;

  // parallelize previews (fast) with safe fallbacks
  const previews = await Promise.all(rows.map(r => getPreview(r.asset, r.tokenId, r.tokenType)));

  rows.forEach((L, i) => {
    // currency format
    const cur = (L.currency || ZERO).toLowerCase();
    let sym="BNB", dec=18;
    if (KNOWN[cur]) { sym=KNOWN[cur].symbol; dec=KNOWN[cur].decimals; }

    const price = ethers.formatUnits(L.buyout, dec);
    const { name, image } = previews[i];

    const card = document.createElement("div");
    card.className = "card";
    const safeName = escapeHtml(name);
    card.innerHTML = `
      <img class="thumb" src="${image || `https://via.placeholder.com/600/0c1d27/73E1FF?text=${L.tokenId}`}" 
           alt="NFT preview for ${safeName}">
      <div class="row" style="margin-top:.5rem"><strong>${safeName}</strong><span class="sub">#${L.id}</span></div>
      <div class="row"><span class="sub">${short(L.asset)} · #${L.tokenId}</span><strong>${price} ${sym}</strong></div>
      <div class="row" style="gap:8px">
        <a class="btn" href="https://thirdweb.com/binance/${MARKETPLACE_ADDR}/listings/${L.id}" target="_blank" rel="noopener">View</a>
        ${doBuy && L.listingType===0 ? `<button class="btn btn-primary" data-buy="${L.id}">Buy 1</button>` : ``}
      </div>
      <div id="st-${L.id}" class="status"></div>
    `;
    grid.appendChild(card);
  });
}

/* ============== Buy handler (debounced) ============== */
$("listings").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-buy]");
  if (!btn) return;
  const id = Number(btn.getAttribute("data-buy"));
  const st = $("st-"+id);

  if (!signer || !mpWrite){ $("err").textContent="Connect wallet to buy."; return; }

  btn.disabled = true; st.textContent="Preparing…"; $("err").textContent="";
  try{
    const mp = mpRead();
    // fresh pull of this one listing
    let L;
    try { [L] = await mp.getAllListings(id,1); if (Number(L.status)!==1) throw new Error(); }
    catch {
      [L] = await mp.getAllValidListings(id,1);
    }
    const cur = (L.currency || ZERO).toLowerCase();

    if (cur !== ZERO){
      const erc = new ethers.Contract(L.currency, ERC20_MIN, signer);
      const allowance = await erc.allowance(me || await signer.getAddress(), MARKETPLACE_ADDR);
      if (allowance < L.buyoutPricePerToken){
        st.textContent="Approving…";
        const txa = await erc.approve(MARKETPLACE_ADDR, L.buyoutPricePerToken);
        await txa.wait();
      }
    }

    st.textContent="Buying…";
    const ov = (cur===ZERO) ? { value: L.buyoutPricePerToken } : {};
    const tx = await mpWrite.buyFromListing(Number(L.id), me || await signer.getAddress(), 1, L.currency, L.buyoutPricePerToken, ov);
    await tx.wait();
    st.className="status ok"; st.textContent="Success ✅";
    await loadListings();
  }catch(err){
    st.className="status err";
    st.textContent = err?.shortMessage || err?.message || "Failed";
  }finally{
    btn.disabled = false;
  }
});

/* ============== Boot (auto refresh) ============== */
let timer=null;
async function start(){
  await loadListings();
  clearInterval(timer);
  timer = setInterval(loadListings, 30000);
}
start();
</script>
</body>
</html>
