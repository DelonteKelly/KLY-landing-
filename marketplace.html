<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamaquah Sovereign Market â€” Live Listings</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/thirdweb/dist/thirdweb.min.js"></script
<style>
  :root {
    --bg: #0A1A24;
    --bg2: #051018;
    --ink: #EAF7FF;
    --sub: #9CCBE3;
    --acc: #73E1FF;
    --gold: #e2c675;
    --card: rgba(255, 255, 255, 0.06);
    --card-hover: rgba(255, 255, 255, 0.1);
    --line: rgba(255, 255, 255, 0.12);
    --ok: #4ade80;
    --warn: #fbbf24;
    --err: #f87171;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    --radius: 16px;
    --radius-sm: 8px;
    --transition: all 0.3s ease;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Space Grotesk', system-ui, sans-serif; }
  html, body { background: linear-gradient(180deg, var(--bg), var(--bg2)); color: var(--ink); min-height: 100vh; line-height: 1.6; }
  .wrap { max-width: 1400px; margin: 0 auto; padding: 24px; }

  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--line); flex-wrap: wrap; gap: 16px; }
  .brand { font-weight: 800; letter-spacing: .08em; font-size: 1.5rem; color: var(--acc); text-shadow: 0 0 10px rgba(115, 225, 255, 0.3); text-transform: uppercase; display: flex; align-items: center; gap: 12px; }
  .brand i { font-size: 1.8rem; }
  .pill { padding: .5rem 1rem; border-radius: 999px; background: rgba(0, 0, 0, 0.2); font-size: .9rem; border: 1px solid var(--line); display: flex; align-items: center; gap: 6px; }

  button, .btn { appearance: none; border: 1px solid var(--line); background: var(--card); color: var(--ink); padding: .7rem 1.2rem; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
  .btn:hover { background: var(--card-hover); transform: translateY(-2px); box-shadow: var(--shadow); }
  .btn-primary { background: linear-gradient(90deg, var(--acc), #a9ffcb); color: #001018; border-color: #2e6b77; }
  .btn-primary:hover { background: linear-gradient(90deg, #a9ffcb, var(--acc)); transform: translateY(-2px); }
  .btn:disabled { opacity: .55; cursor: not-allowed; transform: none !important; }
  .btn:focus-visible { outline: 3px solid #a9ffcb; outline-offset: 2px; }

  .hero { text-align: center; padding: 40px 0 30px; max-width: 800px; margin: 0 auto; }
  .hero h1 { font-size: clamp(1.8rem, 4vw, 3rem); letter-spacing: .05em; text-transform: uppercase; margin: 8px 0 16px;
    background: linear-gradient(90deg, var(--acc), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; }
  .hero p { color: var(--sub); font-size: 1.1rem; margin-bottom: 24px; }

  .controls { display: flex; justify-content: space-between; align-items: center; margin: 24px 0; flex-wrap: wrap; gap: 16px; }
  .search-box { position: relative; max-width: 400px; width: 100%; }
  .search-box input { width: 100%; padding: 12px 16px 12px 42px; border-radius: var(--radius-sm); background: var(--card); border: 1px solid var(--line); color: var(--ink); font-size: 1rem; }
  .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--sub); }

  .filters { display: flex; gap: 12px; flex-wrap: wrap; }
  .filter-btn { padding: 8px 16px; border-radius: var(--radius-sm); background: var(--card); border: 1px solid var(--line); color: var(--sub); cursor: pointer; transition: var(--transition); }
  .filter-btn.active { background: var(--acc); color: var(--bg); border-color: var(--acc); }
  .filter-btn[aria-pressed="true"] { background: var(--acc); color: var(--bg); border-color: var(--acc); }
  .filter-btn:hover { background: var(--card-hover); }

  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-top: 24px; }
  .card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); transition: var(--transition); display: flex; flex-direction: column; height: 100%; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); border-color: rgba(115, 225, 255, 0.3); }

  .row { display: flex; justify-content: space-between; align-items: center; margin: .5rem 0; gap: 10px; flex-wrap: wrap; }

  .thumb-container { position: relative; width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 12px; }
  .thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: linear-gradient(45deg, #0c1d27, #0a2738); transition: var(--transition); }
  .card:hover .thumb { transform: scale(1.05); }

  .token-badge { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: var(--ink); padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; backdrop-filter: blur(5px); }
  .sub { color: var(--sub); font-size: .9rem; }

  .status { min-height: 18px; font-size: .9rem; margin-top: 6px; display: flex; align-items: center; gap: 6px; }
  .ok { color: var(--ok); } .warn { color: var(--warn); } .err { color: var(--err); }
  .price { font-size: 1.2rem; font-weight: 700; color: var(--gold); }

  .card-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 12px; }
  .card-actions .btn { flex: 1; justify-content: center; }

  footer { margin: 40px 0 0; text-align: center; color: var(--sub); font-size: .9rem; padding-top: 20px; border-top: 1px solid var(--line); }

  .loading { display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column; gap: 16px; }
  .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.1); border-left: 4px solid var(--acc); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  @media (max-width: 768px) {
    .wrap { padding: 16px; }
    header { flex-direction: column; text-align: center; }
    .controls { flex-direction: column; align-items: stretch; }
    .search-box { max-width: 100%; }
    .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  }
  @media (max-width: 480px) {
    .grid { grid-template-columns: 1fr; }
    .brand { font-size: 1.2rem; }
    .hero h1 { font-size: 1.6rem; }
  }
  @media (prefers-reduced-motion: reduce) {
    * { transition: none !important; animation: none !important; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <i class="fas fa-seedling" aria-hidden="true"></i>
      <span>TAMAQUAH SOVEREIGN MARKET</span>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center">
      <span class="pill"><i class="fas fa-store" aria-hidden="true"></i> Marketplace: <span id="mpAddrShort">â€”</span></span>
      <span class="pill"><i class="fas fa-link" aria-hidden="true"></i> Chain: BNB</span>
      <button id="connect" class="btn"><i class="fas fa-wallet" aria-hidden="true"></i> Connect Wallet</button>
      <span id="who" class="pill" style="display:none"><i class="fas fa-user" aria-hidden="true"></i> <span id="whoAddr">â€”</span></span>
    </div>
  </header>

  <section class="hero">
    <h1>Live Listings</h1>
    <p>Pulled directly from your MarketplaceV3 contract. Auto-refreshes every 30s.</p>
    <div class="pill" aria-live="polite"><i class="fas fa-sync-alt" aria-hidden="true"></i> Auto-refresh enabled</div>
  </section>

  <section class="controls" role="region" aria-label="Search and filters">
    <div class="search-box">
      <i class="fas fa-search" aria-hidden="true"></i>
      <label class="sr-only" for="search" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">Search listings</label>
      <input type="text" id="search" placeholder="Search by name, token ID, or contract address..." autocomplete="off" inputmode="search" />
    </div>
    <div class="filters" role="toolbar" aria-label="Listing filters">
      <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
      <button class="filter-btn" data-filter="erc721" aria-pressed="false">ERC-721</button>
      <button class="filter-btn" data-filter="erc1155" aria-pressed="false">ERC-1155</button>
      <button class="filter-btn" data-filter="native" aria-pressed="false">BNB</button>
      <button class="filter-btn" data-filter="kly" aria-pressed="false">KLY</button>
    </div>
  </section>

  <section>
    <div id="listings" class="grid" aria-live="polite">
      <div class="loading">
        <div class="spinner" role="status" aria-label="Loading marketplace listings"></div>
        <div>Loading marketplace listings...</div>
      </div>
    </div>
    <p id="empty" class="sub" style="display:none;text-align:center;padding:40px">
      <i class="fas fa-box-open" style="font-size:3rem;margin-bottom:16px;opacity:0.5" aria-hidden="true"></i><br>
      No active listings found.
    </p>
    <p id="err" class="status err" style="text-align:center" role="status" aria-live="polite"></p>
  </section>

  <footer>
    <p>They took the land. We took the future.</p>
    <p style="margin-top:8px;font-size:0.8rem;opacity:0.7">Tamaquah Sovereign Market â€¢ Powered by ThirdWeb</p>
  </footer>
</div>
<script type="module">
/* ================= Thirdweb setup (no ethers) ================= */
const { createThirdwebClient, getContract } = thirdweb;
const { defineChain } = thirdweb.chains;
const { marketplace } = thirdweb.extensions.marketplace;
const erc721 = thirdweb.extensions.erc721;
const erc1155 = thirdweb.extensions.erc1155;

/* ================= Config ================= */
const client = createThirdwebClient({ clientId: "YOUR_CLIENT_ID" }); // ðŸ‘ˆ put your clientId
const BSC_CHAIN_ID = 56;
const MARKETPLACE_ADDR = "0x43159d07010ec59acc8b7df16eb9657667AD243A";
const contract = getContract({ client, chain: defineChain(BSC_CHAIN_ID), address: MARKETPLACE_ADDR });

/* ================= DOM + utils ================= */
const $ = (id)=>document.getElementById(id);
const ZERO = "0x0000000000000000000000000000000000000000";
const short = (a)=> a ? `${a.slice(0,6)}â€¦${a.slice(-4)}` : "â€”";
$("mpAddrShort")?.textContent = short(MARKETPLACE_ADDR);

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function ipfs(u){ return (u && u.startsWith("ipfs://")) ? "https://ipfs.io/ipfs/"+u.slice(7) : (u||""); }
function safeURL(u){ if(!u) return ""; if(u.startsWith("ipfs://")) return ipfs(u); try{ const url=new URL(u); return /https?:/.test(url.protocol)?u:""; }catch{ return ""; } }
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};

/* bigint formatUnits + pretty */
function formatUnits(bi, decimals){
  let v = typeof bi === "bigint" ? bi : BigInt(bi);
  const neg = v < 0n; if(neg) v = -v;
  const base = 10n ** BigInt(decimals);
  const whole = v / base, frac = v % base;
  let s = whole.toString();
  if (frac) {
    let f = frac.toString().padStart(Number(decimals), '0').replace(/0+$/,'');
    s += '.' + f;
  }
  return neg ? ('-' + s) : s;
}
function prettyUnits(v, d){
  const s = formatUnits(v, d);
  let [a,b=""] = s.split(".");
  b = b.slice(0,6).replace(/0+$/,"");
  return b ? `${a}.${b}` : a;
}

/* ================= Currency meta ================= */
const KNOWN = {
  [ZERO]: { symbol:"BNB", decimals:18, isNative:true },
  "0x2e4feb2fe668c8ebe84f19e6c8fe8cf8131b4e52": { symbol:"KLY", decimals:18, isNative:false },
};
const erc20Meta = new Map();
async function getCurrencyMeta(addr){
  const lower = String(addr||ZERO).toLowerCase();
  if (KNOWN[lower]) return KNOWN[lower];
  if (erc20Meta.has(lower)) return erc20Meta.get(lower);
  try{
    const token = getContract({ client, chain: defineChain(BSC_CHAIN_ID), address: lower });
    const decimals = (await token.read.decimals?.()) ?? 18;
    const symbol = (await token.read.symbol?.()) ?? "ERC20";
    const meta = { decimals:Number(decimals), symbol:String(symbol), isNative:false };
    erc20Meta.set(lower, meta); return meta;
  }catch{
    const meta = { decimals:18, symbol:"ERC20", isNative:false };
    erc20Meta.set(lower, meta); return meta;
  }
}

/* ================= Wallet via Thirdweb (MetaMask) ================= */
let wallet=null, account=null;
$("connect")?.addEventListener("click", async ()=>{
  $("err").textContent = "";
  try{
    wallet = thirdweb.createWallet("io.metamask");
    await wallet.connect({ client, chain: defineChain(BSC_CHAIN_ID) });
    account = wallet.getAccount();
    $("whoAddr").textContent = short(account.address);
    $("who").style.display = "inline-block";
    $("connect").style.display = "none";
  }catch(e){ $("err").textContent = e?.message || "Failed to connect wallet."; }
});

/* ================= Listings (SDK) ================= */
let inFlight=false, timer=null;

async function loadListings(){
  $("err").textContent = "";
  $("empty").style.display = "none";
  $("listings").innerHTML = `
    <div class="loading">
      <div class="spinner" role="status" aria-label="Loading"></div>
      <div>Loading marketplace listings...</div>
    </div>`;

  if (inFlight) return; inFlight = true;
  try{
    const direct = await marketplace.getAllListings({ contract }); // all direct (not only valid)
    if (!direct?.length){ $("listings").innerHTML=""; $("empty").style.display="block"; inFlight=false; return; }

    const rows = direct.map(n => ({
      id: Number(n.id),
      asset: String(n.assetContractAddress || n.assetContract || n.asset),
      tokenId: String(n.tokenId),
      tokenType: Number(n.tokenType ?? (n.type === "ERC721" ? 1 : 0)), // 1=721, 0=1155
      currency: String(n.currencyContractAddress || n.currency || ZERO),
      buyout: (n.buyoutPricePerToken ?? n.pricePerToken ?? "0").toString(),
      quantity: Number(n.quantity ?? 1),
      startTime: BigInt(n.startTimeInSeconds ?? n.startTime ?? 0),
      endTime: BigInt(n.endTimeInSeconds ?? n.endTime ?? 0),
    }));

    await render(rows);
  }catch(e){
    console.error(e);
    $("listings").innerHTML=""; $("err").textContent = e?.message || "Couldn't load listings."; $("empty").style.display="block";
  } finally { inFlight=false; }
}

/* ================= Status ================= */
function deriveStatus(row){
  const now = BigInt(Math.floor(Date.now()/1000));
  if (row.quantity === 0) return {label:"Completed", cls:"warn", actionable:false};
  if (row.endTime && row.endTime !== 0n && row.endTime < now) return {label:"Expired", cls:"warn", actionable:false};
  if (row.startTime && row.startTime !== 0n && row.startTime > now) return {label:"Scheduled", cls:"warn", actionable:false};
  return {label:"Active", cls:"ok", actionable:true};
}

/* ================= NFT metadata (Thirdweb) ================= */
async function getNFTMeta(asset, tokenId, tokenType){
  try{
    const nftContract = getContract({ client, chain: defineChain(BSC_CHAIN_ID), address: asset });
    if (tokenType === 1){
      const nft = await erc721.getNFT({ contract: nftContract, tokenId });
      const md = nft?.metadata || {};
      return {
        name: md.name || `Token #${tokenId}`,
        image: safeURL(md.image || md.image_url || ""),
        description: md.description || ""
      };
    } else {
      const nft = await erc1155.getNFT({ contract: nftContract, tokenId });
      const md = nft?.metadata || {};
      return {
        name: md.name || `Token #${tokenId}`,
        image: safeURL(md.image || md.image_url || ""),
        description: md.description || ""
      };
    }
  }catch{
    return { name:`Token #${tokenId}`, image:"", description:"" };
  }
}

/* ================= Render ================= */
async function render(rows){
  const grid = $("listings"); grid.innerHTML = "";

  // simple concurrency limiter
  const limit = (n)=>{ const q=[]; let a=0;
    const run=fn=> new Promise((res,rej)=>{ const step=()=>{ if(a>=n) return q.push(step); a++; fn().then(res,rej).finally(()=>{ a--; (q.shift()||(()=>{}))();});}; step();});
    return run;
  }; const run = limit(6);

  const cards = await Promise.all(rows.map(r => run(async ()=>{
    const [curMeta, md] = await Promise.all([ getCurrencyMeta(r.currency), getNFTMeta(r.asset, r.tokenId, r.tokenType) ]);
    const priceStr = `${prettyUnits(r.buyout, curMeta.decimals)} ${curMeta.symbol}`;
    const st = deriveStatus(r);

    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("data-token-type", r.tokenType === 1 ? "erc721" : "erc1155");
    card.setAttribute("data-currency", curMeta.symbol.toLowerCase());
    card.setAttribute("data-name", (md.name||"").toLowerCase());
    card.setAttribute("data-token-id", r.tokenId);
    card.setAttribute("data-contract", r.asset.toLowerCase());

    const placeholder = `https://via.placeholder.com/600/0c1d27/73E1FF?text=${encodeURIComponent(r.tokenId)}`;
    card.innerHTML = `
      <div class="thumb-container">
        <img class="thumb" loading="lazy" decoding="async" referrerpolicy="no-referrer"
             src="${md.image || placeholder}" alt="NFT preview for ${escapeHtml(md.name)}">
        <div class="token-badge">${st.label} â€¢ ${r.tokenType===1?"ERC-721":"ERC-1155"}</div>
      </div>
      <div class="row" style="margin-top:.5rem">
        <strong>${escapeHtml(md.name)}</strong>
        <span class="sub">Listing #${r.id}</span>
      </div>
      <div class="row">
        <span class="sub">${short(r.asset)} Â· #${r.tokenId}</span>
        <span class="price">${priceStr}</span>
      </div>
      ${md.description ? `<div class="sub" style="margin-top:8px;font-size:0.85rem;line-height:1.4">${escapeHtml(md.description.length>140?md.description.slice(0,140)+'â€¦':md.description)}</div>` : ''}
      <div class="card-actions">
        <a class="btn" href="https://thirdweb.com/binance/${MARKETPLACE_ADDR}/listings/${r.id}" target="_blank" rel="noopener">
          <i class="fas fa-external-link-alt" aria-hidden="true"></i> Details
        </a>
        ${st.actionable ? `
          <button class="btn btn-primary" data-buy="${r.id}">
            <i class="fas fa-shopping-cart" aria-hidden="true"></i> Buy Now
          </button>
        ` : `
          <button class="btn" disabled title="Not purchasable right now">
            <i class="fas fa-ban" aria-hidden="true"></i> Unavailable
          </button>
        `}
      </div>
      <div id="st-${r.id}" class="status ${st.cls}" role="status" aria-live="polite">${st.label}</div>
    `;
    return card;
  })));

  for (const c of cards) if (c) grid.appendChild(c);
  setupSearchAndFilter();
}

/* ================= Search & Filter ================= */
function setupSearchAndFilter(){
  const searchInput = $('search');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const apply = ()=> filterListings(searchInput.value.toLowerCase(), getActiveFilter());
  const debouncedApply = debounce(apply, 200);
  searchInput.removeEventListener('input', searchInput._boundDebouncedApply || (()=>{}));
  searchInput._boundDebouncedApply = function(){ debouncedApply(); };
  searchInput.addEventListener('input', searchInput._boundDebouncedApply);
  filterButtons.forEach(btn=>{
    btn.addEventListener('click', function(){
      filterButtons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      this.classList.add('active'); this.setAttribute('aria-pressed','true');
      apply();
    });
  });
}
function getActiveFilter(){ const a=document.querySelector('.filter-btn.active'); return a ? a.getAttribute('data-filter') : 'all'; }
function filterListings(searchTerm, filter){
  const cards = document.querySelectorAll('.card'); let visible=0;
  cards.forEach(card=>{
    const tokenType = card.getAttribute('data-token-type');
    const currency = card.getAttribute('data-currency');
    const name = card.getAttribute('data-name');
    const tokenId = card.getAttribute('data-token-id') || "";
    const contract = card.getAttribute('data-contract');
    let ok = true;
    if (filter !== 'all') {
      if (filter === 'erc721') ok = tokenType === 'erc721';
      else if (filter === 'erc1155') ok = tokenType === 'erc1155';
      else if (filter === 'native') ok = currency === 'bnb';
      else if (filter === 'kly') ok = currency === 'kly';
    }
    let sOK = true;
    if (searchTerm) sOK = name.includes(searchTerm) || tokenId.toLowerCase().includes(searchTerm) || contract.includes(searchTerm);
    if (ok && sOK) { card.style.display='flex'; visible++; } else card.style.display='none';
  });
  $('empty').style.display = visible === 0 ? 'block' : 'none';
}

/* ================= Buy (Thirdweb SDK) ================= */
$("listings")?.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-buy]"); if(!btn) return;
  const id = Number(btn.getAttribute("data-buy"));
  const st = $("st-"+id); $("err").textContent = "";
  try{
    if (!wallet || !account){
      await $("connect").click();
      if (!wallet || !account) return;
    }
    st.className="status"; st.innerHTML = "<i class='fas fa-spinner fa-spin' aria-hidden='true'></i> Buying...";
    await marketplace.buyFromListing({
      contract,
      listingId: id,
      quantity: 1,
      recipient: account.address,
      account,
    });
    st.className="status ok"; st.innerHTML = `<i class="fas fa-check" aria-hidden="true"></i> Purchase sent â€” check wallet`;
    await loadListings();
  }catch(err){
    console.error(err);
    st.className="status err";
    st.innerHTML = `<i class="fas fa-exclamation-triangle" aria-hidden="true"></i> ${escapeHtml(String(err?.message || "Transaction failed"))}`;
  }
});

/* ================= Boot ================= */
async function start(){
  await loadListings();
  clearInterval(timer);
  timer = setInterval(loadListings, 30000);
}
start();
</script>
</body>
</html>
