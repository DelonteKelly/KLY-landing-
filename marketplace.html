<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamaquah Sovereign Market â€” Live Listings</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  :root {
    --bg: #0A1A24; --bg2: #051018; --ink: #EAF7FF; --sub: #9CCBE3; --acc: #73E1FF;
    --gold: #e2c675; --card: rgba(255,255,255,.06); --card-hover: rgba(255,255,255,.1);
    --line: rgba(255,255,255,.12); --ok: #4ade80; --warn: #fbbf24; --err: #f87171;
    --shadow: 0 4px 20px rgba(0,0,0,.3); --radius: 16px; --radius-sm: 8px; --transition: .3s ease; --pulse: pulse 2s infinite;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Space Grotesk', system-ui, sans-serif; }
  html, body { background: linear-gradient(180deg, var(--bg), var(--bg2)); color: var(--ink); min-height: 100vh; line-height: 1.6; overflow-x: hidden; }
  .wrap { max-width: 1400px; margin: 0 auto; padding: 24px; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--line); flex-wrap: wrap; gap: 16px; }
  .brand { font-weight: 800; letter-spacing: .08em; font-size: 1.5rem; color: var(--acc); text-shadow: 0 0 10px rgba(115,225,255,.3); text-transform: uppercase; display: flex; align-items: center; gap: 12px; }
  .brand i { font-size: 1.8rem; }
  .pill { padding: .5rem 1rem; border-radius: 999px; background: rgba(0,0,0,.2); font-size: .9rem; border: 1px solid var(--line); display: flex; align-items: center; gap: 6px; }
  button, .btn { appearance: none; border: 1px solid var(--line); background: var(--card); color: var(--ink); padding: .7rem 1.2rem; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: var(--transition); display: flex; align-items: center; gap: 8px; position: relative; overflow: hidden; }
  .btn:hover { background: var(--card-hover); transform: translateY(-2px); box-shadow: var(--shadow); }
  .btn-primary { background: linear-gradient(90deg, var(--acc), #a9ffcb); color: #001018; border-color: #2e6b77; }
  .btn-primary:hover { background: linear-gradient(90deg, #a9ffcb, var(--acc)); transform: translateY(-2px); }
  .btn:disabled { opacity: .55; cursor: not-allowed; transform: none !important; }
  .btn:focus-visible { outline: 3px solid #a9ffcb; outline-offset: 2px; }
  .btn-loading::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent); animation: shimmer 1.5s infinite; }
  .hero { text-align: center; padding: 40px 0 30px; max-width: 800px; margin: 0 auto; }
  .hero h1 { font-size: clamp(1.8rem, 4vw, 3rem); letter-spacing: .05em; text-transform: uppercase; margin: 8px 0 16px;
    background: linear-gradient(90deg, var(--acc), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; }
  .hero p { color: var(--sub); font-size: 1.1rem; margin-bottom: 24px; }
  .controls { display: flex; justify-content: space-between; align-items: center; margin: 24px 0; flex-wrap: wrap; gap: 16px; }
  .tabs { display: flex; gap: 10px; flex-wrap: wrap; }
  .tab-btn { padding: 8px 14px; border-radius: var(--radius-sm); border: 1px solid var(--line); background: var(--card); color: var(--sub); cursor: pointer; }
  .tab-btn.active { background: var(--acc); color: var(--bg); border-color: var(--acc); }
  .search-box { position: relative; max-width: 400px; width: 100%; }
  .search-box input { width: 100%; padding: 12px 16px 12px 42px; border-radius: var(--radius-sm); background: var(--card); border: 1px solid var(--line); color: var(--ink); font-size: 1rem; transition: var(--transition); }
  .search-box input:focus { border-color: var(--acc); box-shadow: 0 0 0 2px rgba(115,225,255,.2); outline: none; }
  .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--sub); }
  .filters { display: flex; gap: 12px; flex-wrap: wrap; }
  .filter-btn { padding: 8px 16px; border-radius: var(--radius-sm); background: var(--card); border: 1px solid var(--line); color: var(--sub); cursor: pointer; transition: var(--transition); }
  .filter-btn.active, .filter-btn[aria-pressed="true"] { background: var(--acc); color: var(--bg); border-color: var(--acc); }
  .sort-controls { display: flex; align-items: center; gap: 8px; }
  .sort-select { background: var(--card); border: 1px solid var(--line); color: var(--ink); padding: 8px 12px; border-radius: var(--radius-sm); font-size: .9rem; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-top: 24px; }
  .card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); transition: var(--transition); display: flex; flex-direction: column; height: 100%; position: relative; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,.4); border-color: rgba(115,225,255,.3); }
  .row { display: flex; justify-content: space-between; align-items: center; margin: .5rem 0; gap: 10px; flex-wrap: wrap; }
  .thumb-container { position: relative; width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 12px; background: linear-gradient(45deg, #0c1d27, #0a2738); }
  .thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; opacity: 0; transition: opacity .5s ease, transform var(--transition); }
  .thumb.loaded { opacity: 1; }
  .card:hover .thumb { transform: scale(1.05); }
  .token-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,.7); color: var(--ink); padding: 4px 8px; border-radius: 6px; font-size: .8rem; backdrop-filter: blur(5px); }
  .sub { color: var(--sub); font-size: .9rem; }
  .status { min-height: 18px; font-size: .9rem; margin-top: 6px; display: flex; align-items: center; gap: 6px; }
  .ok { color: var(--ok); } .warn { color: var(--warn); } .err { color: var(--err); }
  .price { font-size: 1.2rem; font-weight: 700; color: var(--gold); }
  .card-actions { display: flex; gap: 10px; margin-top: auto; padding-top: 12px; }
  .card-actions .btn { flex: 1; justify-content: center; }
  footer { margin: 40px 0 0; text-align: center; color: var(--sub); font-size: .9rem; padding-top: 20px; border-top: 1px solid var(--line); }
  .loading { display: flex; justify-content: center; align-items: center; padding: 40px; flex-direction: column; gap: 16px; }
  .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,.1); border-left: 4px solid var(--acc); border-radius: 50%; animation: spin 1s linear infinite; }
  .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.05) 25%, rgba(255,255,255,.1) 50%, rgba(255,255,255,.05) 75%); background-size: 200% 100%; animation: var(--pulse); border-radius: 4px; }
  .skeleton-thumb { width: 100%; aspect-ratio: 1/1; margin-bottom: 12px; }
  .skeleton-text { height: 16px; margin-bottom: 8px; }
  .skeleton-text.short { width: 60%; }
  .notification { position: fixed; top: 20px; right: 20px; padding: 16px 20px; border-radius: var(--radius-sm); background: var(--card); border: 1px solid var(--line); box-shadow: var(--shadow); z-index: 1000; display: flex; align-items: center; gap: 10px; max-width: 400px; transform: translateX(150%); transition: transform .3s ease; }
  .notification.show { transform: translateX(0); }
  .notification.success { border-left: 4px solid var(--ok); }
  .notification.error { border-left: 4px solid var(--err); }
  .notification.warning { border-left: 4px solid var(--warn); }
  .favorite-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,.7); color: var(--sub); border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); transition: var(--transition); z-index: 2; }
  .favorite-btn:hover, .favorite-btn.active { color: var(--err); }
  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.8); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all .3s ease; backdrop-filter: blur(5px); }
  .modal.show { opacity: 1; visibility: visible; }
  .modal-content { background: var(--bg); border: 1px solid var(--line); border-radius: var(--radius); padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; transform: scale(.9); transition: transform .3s ease; }
  .modal.show .modal-content { transform: scale(1); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .modal-close { background: none; border: none; color: var(--sub); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
  @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: .5; } 100% { opacity: 1; } }
  @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
  @media (max-width: 768px) { .wrap { padding: 16px; } header { flex-direction: column; text-align: center; } .controls { flex-direction: column; align-items: stretch; } .search-box { max-width: 100%; } .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; } .modal-content { width: 95%; padding: 16px; } }
  @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } .brand { font-size: 1.2rem; } .hero h1 { font-size: 1.6rem; } .filters { justify-content: center; } }
  .sr-only { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><i class="fas fa-seedling" aria-hidden="true"></i><span>TAMAQUAH SOVEREIGN MARKET</span></div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center">
      <span class="pill"><i class="fas fa-store"></i> Marketplace: <span id="mpAddrShort">â€”</span></span>
      <span class="pill"><i class="fas fa-link"></i> Chain: BNB</span>
      <button id="connect" class="btn"><i class="fas fa-wallet"></i> Connect Wallet</button>
      <span id="who" class="pill" style="display:none"><i class="fas fa-user"></i> <span id="whoAddr">â€”</span></span>
    </div>
  </header>

  <section class="hero">
    <h1>Live Listings</h1>
    <p>Pulled from your MarketplaceV3 contract. Auto-refreshes every 30s.</p>
    <div class="pill" aria-live="polite"><i class="fas fa-sync-alt"></i> Auto-refresh enabled</div>
  </section>

  <section class="controls" role="region" aria-label="Search and filters">
    <div class="tabs" role="tablist">
      <button id="tab-all" class="tab-btn active" role="tab" aria-selected="true">All Listings</button>
      <button id="tab-mine" class="tab-btn" role="tab" aria-selected="false">My Listings</button>
    </div>
    <div class="search-box">
      <i class="fas fa-search"></i>
      <label class="sr-only" for="search">Search listings</label>
      <input type="text" id="search" placeholder="Search by name, token ID, or contract address..." autocomplete="off" inputmode="search"/>
    </div>
    <div class="filters" role="toolbar" aria-label="Listing filters">
      <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
      <button class="filter-btn" data-filter="erc721" aria-pressed="false">ERC-721</button>
      <button class="filter-btn" data-filter="erc1155" aria-pressed="false">ERC-1155</button>
      <button class="filter-btn" data-filter="native" aria-pressed="false">BNB</button>
      <button class="filter-btn" data-filter="kly" aria-pressed="false">KLY</button>
    </div>
    <div class="sort-controls">
      <label for="sort" class="sub">Sort by:</label>
      <select id="sort" class="sort-select">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="price-low">Price: Low to High</option>
        <option value="price-high">Price: High to Low</option>
        <option value="name">Name A-Z</option>
      </select>
    </div>
  </section>

  <section>
    <p id="err" class="status err" style="text-align:center"></p>
    <div id="listings" class="grid" aria-live="polite">
      <!-- initial skeletons -->
      <div class="card"><div class="skeleton skeleton-thumb"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div><div class="card-actions"><div class="skeleton skeleton-text" style="height: 40px;"></div><div class="skeleton skeleton-text" style="height: 40px;"></div></div></div>
      <div class="card"><div class="skeleton skeleton-thumb"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div><div class="card-actions"><div class="skeleton skeleton-text" style="height: 40px;"></div><div class="skeleton skeleton-text" style="height: 40px;"></div></div></div>
      <div class="card"><div class="skeleton skeleton-thumb"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div><div class="card-actions"><div class="skeleton skeleton-text" style="height: 40px;"></div><div class="skeleton skeleton-text" style="height: 40px;"></div></div></div>
    </div>
    <p id="empty" class="sub" style="display:none;text-align:center;padding:40px">
      <i class="fas fa-box-open" style="font-size:3rem;margin-bottom:16px;opacity:.5"></i><br>
      No listings match your filters.
    </p>
  </section>

  <footer>
    <p>They took the land. We took the future.</p>
    <p style="margin-top:8px;font-size:.8rem;opacity:.7">Tamaquah Sovereign Market â€¢ Powered by ethers</p>
  </footer>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Purchase Modal -->
<div id="purchase-modal" class="modal" aria-hidden="true" role="dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirm Purchase</h2>
      <button class="modal-close" aria-label="Close modal">&times;</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script type="module">
/* ===================== CONFIG ===================== */
const RPC = "https://bsc-dataseed.binance.org/";
const CHAIN_ID = 56; // BNB Chain mainnet
const MARKETPLACE_ADDR = "0x43159d07010ec59acc8b7df16eb9657667AD243A";

const ZERO = "0x0000000000000000000000000000000000000000";
const NATIVE_SENTINEL = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee".toLowerCase(); // used by some SDKs

$("mpAddrShort").textContent = short(MARKETPLACE_ADDR);

/* Known currencies */
const KNOWN = {
  [ZERO]: { symbol: "BNB", decimals: 18, isNative: true },
  [NATIVE_SENTINEL]: { symbol: "BNB", decimals: 18, isNative: true },
  "0x2e4feb2fe668c8ebe84f19e6c8fe8cf8131b4e52": { symbol: "KLY", decimals: 18, isNative: false }, // add more as needed
};

/* ===================== ABIs (trimmed to what we use) ===================== */
const MARKET_ABI = [
  {"inputs":[],"name":"totalListings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"_startId","type":"uint256"},{"internalType":"uint256","name":"_endId","type":"uint256"}],"name":"getAllListings","outputs":[{"components":[
    {"internalType":"uint256","name":"listingId","type":"uint256"},
    {"internalType":"uint256","name":"tokenId","type":"uint256"},
    {"internalType":"uint256","name":"quantity","type":"uint256"},
    {"internalType":"uint256","name":"pricePerToken","type":"uint256"},
    {"internalType":"uint128","name":"startTimestamp","type":"uint128"},
    {"internalType":"uint128","name":"endTimestamp","type":"uint128"},
    {"internalType":"address","name":"listingCreator","type":"address"},
    {"internalType":"address","name":"assetContract","type":"address"},
    {"internalType":"address","name":"currency","type":"address"},
    {"internalType":"uint8","name":"tokenType","type":"uint8"},
    {"internalType":"uint8","name":"status","type":"uint8"},
    {"internalType":"bool","name":"reserved","type":"bool"}
  ],"internalType":"struct IDirectListings.Listing[]","name":"_allListings","type":"tuple[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"_listingId","type":"uint256"}],"name":"getListing","outputs":[{"components":[
    {"internalType":"uint256","name":"listingId","type":"uint256"},
    {"internalType":"uint256","name":"tokenId","type":"uint256"},
    {"internalType":"uint256","name":"quantity","type":"uint256"},
    {"internalType":"uint256","name":"pricePerToken","type":"uint256"},
    {"internalType":"uint128","name":"startTimestamp","type":"uint128"},
    {"internalType":"uint128","name":"endTimestamp","type":"uint128"},
    {"internalType":"address","name":"listingCreator","type":"address"},
    {"internalType":"address","name":"assetContract","type":"address"},
    {"internalType":"address","name":"currency","type":"address"},
    {"internalType":"uint8","name":"tokenType","type":"uint8"},
    {"internalType":"uint8","name":"status","type":"uint8"},
    {"internalType":"bool","name":"reserved","type":"bool"}
  ],"internalType":"struct IDirectListings.Listing","name":"listing","type":"tuple"}],"stateMutability":"view","type":"function"},
  {"inputs":[
    {"internalType":"uint256","name":"_listingId","type":"uint256"},
    {"internalType":"address","name":"_buyFor","type":"address"},
    {"internalType":"uint256","name":"_quantity","type":"uint256"},
    {"internalType":"address","name":"_currency","type":"address"},
    {"internalType":"uint256","name":"_expectedTotalPrice","type":"uint256"}
  ],"name":"buyFromListing","outputs":[],"stateMutability":"payable","type":"function"}
];

const ERC20_MIN_ABI = [
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];
const ERC721_MIN_ABI = [ "function tokenURI(uint256) view returns (string)" ];
const ERC1155_MIN_ABI = [ "function uri(uint256) view returns (string)" ];

/* ===================== HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
function short(a){ return a ? `${a.slice(0,6)}â€¦${a.slice(-4)}` : "â€”"; }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function prettyUnits(bn,dec){ const v = ethers.BigNumber.from(bn); const s = ethers.utils.formatUnits(v, dec); const [a,b=""]=s.split("."); const bb=b.slice(0,6).replace(/0+$/,""); return bb?`${a}.${bb}`:a; }

/* Notifications */
function showNotification(message, type='info', ms=5000){
  const c = $('#notification-container'); const el = document.createElement('div');
  el.className = `notification ${type}`;
  const icon = type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-triangle':type==='warning'?'fa-exclamation-circle':'fa-info-circle';
  el.innerHTML = `<i class="fas ${icon}"></i><span>${escapeHtml(message)}</span>`;
  c.appendChild(el); setTimeout(()=>el.classList.add('show'), 10);
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); }, ms);
}

/* Modal */
function showModal(content){ const m=$('#purchase-modal'); $('#modal-body').innerHTML=content; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
function hideModal(){ const m=$('#purchase-modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
document.querySelector('.modal-close').addEventListener('click', hideModal);
document.getElementById('purchase-modal').addEventListener('click', (e)=>{ if(e.target.id==='purchase-modal') hideModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $('#purchase-modal').classList.contains('show')) hideModal(); });

/* ===================== IPFS HELPERS ===================== */
const IPFS_GATEWAYS = [
  "https://ipfs.io/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  "https://gateway.pinata.cloud/ipfs/",
];
function ipfsToHttp(u, gw=IPFS_GATEWAYS[0]){ if(!u) return ""; return u.startsWith("ipfs://") ? gw+u.slice(7) : u; }
function resolve1155Uri(tpl, tokenId, gw){
  if(!tpl) return "";
  const hexId = ethers.utils.hexZeroPad(ethers.utils.hexlify(ethers.BigNumber.from(tokenId)), 32).slice(2);
  return ipfsToHttp(tpl.replace("{id}", hexId), gw);
}
async function fetchJSONWithGateways(ipfsUrlOrHttp, is1155=false, tokenId="0"){
  const urls=[];
  if (ipfsUrlOrHttp?.startsWith("ipfs://")){
    for (const gw of IPFS_GATEWAYS){
      urls.push(is1155 ? resolve1155Uri(ipfsUrlOrHttp, tokenId, gw) : ipfsToHttp(ipfsUrlOrHttp, gw));
    }
  } else if (ipfsUrlOrHttp) {
    urls.push(ipfsUrlOrHttp);
  }
  for (const url of urls){
    try{
      const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(),5000);
      const r=await fetch(url,{signal:ctl.signal, cache:"no-cache"}); clearTimeout(t);
      if(!r.ok) throw new Error(`HTTP ${r.status}`); const j=await r.json(); return { json:j, from:url };
    }catch(e){}
  }
  throw new Error("Failed to fetch metadata from all gateways");
}
function normalizeMediaLink(link){
  if(!link) return "";
  if (link.startsWith("ipfs://")) return ipfsToHttp(link);
  try{ const u=new URL(link); if(/^https?:$/.test(u.protocol)) return link; }catch{}
  return "";
}
async function getNFTMetaByAddress(assetAddress, tokenId, tokenType, provider){
  try{
    if (Number(tokenType) === 1){
      const erc721=new ethers.Contract(assetAddress, ERC721_MIN_ABI, provider);
      const uri=await erc721.tokenURI(tokenId).catch(()=> "");
      const { json } = await fetchJSONWithGateways(uri, false, tokenId);
      return { name: json?.name || `Token #${tokenId}`, description: json?.description || "", image: normalizeMediaLink(json?.image || json?.image_url), raw: json };
    } else {
      const erc1155=new ethers.Contract(assetAddress, ERC1155_MIN_ABI, provider);
      const tpl=await erc1155.uri(tokenId).catch(()=> "");
      const { json } = await fetchJSONWithGateways(tpl, true, tokenId);
      return { name: json?.name || `Token #${tokenId}`, description: json?.description || "", image: normalizeMediaLink(json?.image || json?.image_url), raw: json };
    }
  }catch(e){ return { name:`Token #${tokenId}`, description:"", image:"" }; }
}

/* ===================== PROVIDERS / STATE ===================== */
const rpcProvider = new ethers.providers.JsonRpcProvider(RPC, { name:"bsc", chainId: CHAIN_ID });
const marketRead = new ethers.Contract(MARKETPLACE_ADDR, MARKET_ABI, rpcProvider);

let web3prov=null, signer=null, me=null;
let allListings=[], filtered=[], activeTab='all'; // 'all' | 'mine'
let erc20Cache=new Map(), nftMetaCache=new Map();
let refreshTimer=null, loading=false;

/* Connect wallet */
$("connect").addEventListener("click", async ()=>{
  $("#err").textContent = "";
  try{
    if(!window.ethereum) throw new Error("MetaMask not detected in this browser.");
    web3prov = new ethers.providers.Web3Provider(window.ethereum, "any");
    await web3prov.send("eth_requestAccounts", []);
    const net = await web3prov.getNetwork();
    if (Number(net.chainId) !== CHAIN_ID){
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: "0x"+CHAIN_ID.toString(16)}] });
    }
    signer = web3prov.getSigner();
    me = await signer.getAddress();
    $("whoAddr").textContent = short(me);
    $("who").style.display = "inline-block";
    $("connect").style.display = "none";
    showNotification("Wallet connected", "success");
    // when connecting, if "My Listings" tab is active, reapply filters
    applyAllFilters();
  }catch(e){
    $("#err").textContent = e?.message || "Failed to connect wallet.";
    showNotification(e?.message || "Failed to connect wallet.", "error");
  }
});

/* ===================== LOAD LISTINGS ===================== */
async function loadListings(){
  if (loading) return; loading=true;
  try{
    const total = (await marketRead.totalListings()).toNumber();
    if (total === 0){ allListings=[]; render([]); $("#empty").style.display="block"; loading=false; return; }
    const rows = await marketRead.getAllListings(0, Math.max(total-1,0));
    allListings = rows.map(L => ({
      id: Number(L.listingId),
      asset: String(L.assetContract),
      tokenId: L.tokenId.toString(),
      quantity: Number(L.quantity),
      pricePerToken: ethers.BigNumber.from(L.pricePerToken),
      start: Number(L.startTimestamp),
      end: Number(L.endTimestamp),
      creator: String(L.listingCreator),
      currency: String(L.currency || ZERO).toLowerCase(),
      tokenType: Number(L.tokenType), // 1=ERC721, 0=ERC1155
      status: Number(L.status),
      reserved: Boolean(L.reserved),
    }));
    applyAllFilters(); // will call render
  }catch(e){
    console.error(e);
    $("#listings").innerHTML=""; $("#err").textContent = e?.message || "Couldn't load listings."; $("#empty").style.display="block";
    showNotification("Failed to load listings", "error");
  }finally{ loading=false; }
}

/* ===================== STATUS & META ===================== */
function deriveStatus(row){
  const now = Math.floor(Date.now()/1000);
  if (typeof row.status === "number" && row.status !== 1) return {label:"Inactive", cls:"warn", actionable:false};
  if (row.quantity === 0) return {label:"Completed", cls:"warn", actionable:false};
  if (row.reserved) return {label:"Reserved", cls:"warn", actionable:false};
  if (row.end && row.end !== 0 && row.end < now) return {label:"Expired", cls:"warn", actionable:false};
  if (row.start && row.start !== 0 && row.start > now) return {label:"Scheduled", cls:"warn", actionable:false};
  return {label:"Active", cls:"ok", actionable:true};
}
async function getCurrencyMeta(addr){
  const a=(addr||ZERO).toLowerCase();
  if (KNOWN[a]) return KNOWN[a];
  if (erc20Cache.has(a)) return erc20Cache.get(a);
  try{
    const erc = new ethers.Contract(a, ERC20_MIN_ABI, rpcProvider);
    const [dec, sym] = await Promise.all([erc.decimals(), erc.symbol()]);
    const meta = { decimals: Number(dec), symbol: String(sym||"ERC20"), isNative:false };
    erc20Cache.set(a, meta); return meta;
  }catch{
    const meta = { decimals:18, symbol:"ERC20", isNative:false };
    erc20Cache.set(a, meta); return meta;
  }
}
async function getNftMetaCached(asset, tokenId, tokenType){
  const key = `${asset.toLowerCase()}:${tokenType}:${tokenId}`;
  if (nftMetaCache.has(key)) return nftMetaCache.get(key);
  const md = await getNFTMetaByAddress(asset, tokenId, tokenType, rpcProvider);
  nftMetaCache.set(key, md); return md;
}

/* ===================== RENDER ===================== */
async function render(rows){
  const grid = $("#listings");
  grid.innerHTML = "";
  if (!rows?.length){ $("#empty").style.display="block"; return; } else { $("#empty").style.display="none"; }

  // concurrency limiter
  const limit = (n)=>{ const q=[]; let a=0; const run=fn=>new Promise((res,rej)=>{ const step=()=>{ if(a>=n) return q.push(step); a++; fn().then(res,rej).finally(()=>{ a--; (q.shift()||(()=>{}))();});}; step();}); return run; };
  const run = limit(6);

  const cards = await Promise.all(rows.map(r => run(async ()=>{
    const [curMeta, md] = await Promise.all([ getCurrencyMeta(r.currency), getNftMetaCached(r.asset, r.tokenId, r.tokenType) ]);
    const priceStr = `${prettyUnits(r.pricePerToken, curMeta.decimals)} ${curMeta.symbol}`;
    const st = deriveStatus(r);

    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("data-token-type", r.tokenType === 1 ? "erc721" : "erc1155");
    card.setAttribute("data-currency", curMeta.symbol.toLowerCase());
    card.setAttribute("data-name", (md.name||"").toLowerCase());
    card.setAttribute("data-token-id", r.tokenId);
    card.setAttribute("data-contract", r.asset.toLowerCase());
    card.setAttribute("data-creator", r.creator.toLowerCase());

    const placeholder = `https://via.placeholder.com/800/0c1d27/73E1FF?text=${encodeURIComponent(r.tokenId)}`;

    const img = new Image();
    img.src = md.image || placeholder;
    img.alt = `NFT preview for ${escapeHtml(md.name||'Token')}`;
    img.loading = "lazy";
    img.decoding = "async";
    img.referrerPolicy = "no-referrer";
    img.className = "thumb";
    img.addEventListener('load', ()=> img.classList.add('loaded'));

    const thumbWrap = document.createElement('div');
    thumbWrap.className = "thumb-container";
    thumbWrap.appendChild(img);

    const badge = document.createElement('div');
    badge.className = "token-badge";
    badge.textContent = `${st.label} â€¢ ${r.tokenType===1?'ERC-721':'ERC-1155'}`;
    thumbWrap.appendChild(badge);

    const nameRow = document.createElement('div');
    nameRow.className="row";
    nameRow.style.marginTop = ".5rem";
    nameRow.innerHTML = `<strong>${escapeHtml(md.name||`Token #${r.tokenId}`)}</strong><span class="sub">Listing #${r.id}</span>`;

    const infoRow = document.createElement('div');
    infoRow.className="row";
    infoRow.innerHTML = `<span class="sub">${short(r.asset)} Â· #${r.tokenId}</span><span class="price">${priceStr}</span>`;

    const desc = (md.description||"").trim();
    const descEl = document.createElement('div');
    if (desc){
      descEl.className = "sub";
      descEl.style.cssText = "margin-top:8px;font-size:0.9rem;line-height:1.4";
      descEl.textContent = desc.length>160? (desc.slice(0,160)+"â€¦") : desc;
    }

    const actions = document.createElement('div');
    actions.className = "card-actions";
    const link = document.createElement('a');
    link.className = "btn";
    link.href = `https://thirdweb.com/binance/${MARKETPLACE_ADDR}/listings/${r.id}`;
    link.target = "_blank"; link.rel = "noopener";
    link.innerHTML = `<i class="fas fa-external-link-alt" aria-hidden="true"></i> Details`;

    const buy = document.createElement('button');
    buy.className = st.actionable ? "btn btn-primary" : "btn";
    buy.disabled = !st.actionable;
    buy.setAttribute("data-buy", String(r.id));
    buy.innerHTML = st.actionable ? `<i class="fas fa-shopping-cart" aria-hidden="true"></i> Buy Now` : `<i class="fas fa-ban" aria-hidden="true"></i> Unavailable`;

    actions.appendChild(link); actions.appendChild(buy);

    const status = document.createElement('div');
    status.id = `st-${r.id}`;
    status.className = `status ${st.cls}`;
    status.setAttribute("role","status");
    status.setAttribute("aria-live","polite");
    status.textContent = st.label;

    card.appendChild(thumbWrap);
    card.appendChild(nameRow);
    card.appendChild(infoRow);
    if(desc) card.appendChild(descEl);
    card.appendChild(actions);
    card.appendChild(status);

    return card;
  })));

  for (const c of cards) grid.appendChild(c);
}

/* ===================== FILTERS / SEARCH / SORT / TABS ===================== */
function getActiveFilter(){ const a=document.querySelector('.filter-btn.active'); return a ? a.getAttribute('data-filter') : 'all'; }
function sortRows(rows){
  const v = $("#sort").value;
  if (v==="oldest") rows.sort((a,b)=> a.id-b.id);
  else if (v==="newest") rows.sort((a,b)=> b.id-a.id);
  else if (v==="price-low") rows.sort((a,b)=> a.pricePerToken.sub(b.pricePerToken));
  else if (v==="price-high") rows.sort((a,b)=> b.pricePerToken.sub(a.pricePerToken));
  else if (v==="name") rows.sort((a,b)=> {
    const na=(nftMetaCache.get(`${a.asset.toLowerCase()}:${a.tokenType}:${a.tokenId}`)?.name||"").toLowerCase();
    const nb=(nftMetaCache.get(`${b.asset.toLowerCase()}:${b.tokenType}:${b.tokenId}`)?.name||"").toLowerCase();
    return na.localeCompare(nb);
  });
  return rows;
}
function applyAllFilters(){
  const filter = getActiveFilter();
  const searchTerm = $("#search").value.trim().toLowerCase();
  const mineOnly = (activeTab==='mine' && me);

  filtered = allListings.filter(r=>{
    if (mineOnly && r.creator.toLowerCase() !== me?.toLowerCase()) return false;
    if (filter !== 'all'){
      if (filter==='erc721' && r.tokenType!==1) return false;
      if (filter==='erc1155' && r.tokenType!==0) return false;
      if (filter==='native' && ![ZERO,NATIVE_SENTINEL].includes(r.currency)) return false;
      if (filter==='kly' && r.currency!=="0x2e4feb2fe668c8ebe84f19e6c8fe8cf8131b4e52") return false;
    }
    if (searchTerm){
      const key = `${r.asset}:${r.tokenId}:${r.creator}`.toLowerCase();
      const md = nftMetaCache.get(`${r.asset.toLowerCase()}:${r.tokenType}:${r.tokenId}`);
      const name = (md?.name||"").toLowerCase();
      if (!(name.includes(searchTerm) || key.includes(searchTerm))) return false;
    }
    return true;
  });

  sortRows(filtered);
  render(filtered);
}

/* Wire UI controls */
(function setupControls(){
  const searchInput = $('#search');
  const deb = debounce(applyAllFilters, 200);
  searchInput.addEventListener('input', deb);

  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', function(){
      document.querySelectorAll('.filter-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      this.classList.add('active'); this.setAttribute('aria-pressed','true');
      applyAllFilters();
    });
  });

  $('#sort').addEventListener('change', applyAllFilters);

  // tabs
  $('#tab-all').addEventListener('click', ()=>{
    activeTab='all';
    $('#tab-all').classList.add('active'); $('#tab-all').setAttribute('aria-selected','true');
    $('#tab-mine').classList.remove('active'); $('#tab-mine').setAttribute('aria-selected','false');
    applyAllFilters();
  });
  $('#tab-mine').addEventListener('click', ()=>{
    activeTab='mine';
    if (!me) showNotification("Connect your wallet to view your listings", "warning");
    $('#tab-mine').classList.add('active'); $('#tab-mine').setAttribute('aria-selected','true');
    $('#tab-all').classList.remove('active'); $('#tab-all').setAttribute('aria-selected','false');
    applyAllFilters();
  });
})();

/* ===================== BUY FLOW ===================== */
$("#listings").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-buy]"); if(!btn) return;
  const id = Number(btn.getAttribute("data-buy"));
  const st = $("#st-"+id); $("#err").textContent = "";

  try{
    if (!signer) { await $("#connect").click(); if(!signer) return; }
    const marketWrite = new ethers.Contract(MARKETPLACE_ADDR, MARKET_ABI, signer);

    // refetch listing for fresh price & currency
    const L = await marketWrite.getListing(id);
    const currency = String(L.currency || ZERO).toLowerCase();
    const pricePerToken = ethers.BigNumber.from(L.pricePerToken);
    const quantity = 1; // this UI buys 1
    const expectedTotal = pricePerToken.mul(quantity);
    const buyFor = await signer.getAddress();

    const row = {
      quantity: Number(L.quantity),
      start: Number(L.startTimestamp),
      end: Number(L.endTimestamp),
      status: Number(L.status),
      reserved: Boolean(L.reserved),
    };
    const s = deriveStatus(row);
    if (!s.actionable) throw new Error(`Listing is ${s.label.toLowerCase()}`);

    // build modal confirm UI
    const curMeta = await getCurrencyMeta(currency);
    const totalStr = `${prettyUnits(expectedTotal, curMeta.decimals)} ${curMeta.symbol}`;
    showModal(`
      <p class="sub" style="margin-bottom:10px">Listing #${id}</p>
      <p>You're about to purchase <strong>1</strong> token for <strong>${totalStr}</strong>.</p>
      <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end">
        <button id="modal-cancel" class="btn">Cancel</button>
        <button id="modal-confirm" class="btn btn-primary"><i class="fas fa-check"></i> Confirm</button>
      </div>
    `);
    document.getElementById('modal-cancel').onclick = hideModal;

    document.getElementById('modal-confirm').onclick = async ()=>{
      document.getElementById('modal-confirm').disabled = true;
      st.className="status"; st.innerHTML = "<i class='fas fa-spinner fa-spin' aria-hidden='true'></i> Preparing transaction...";
      try{
        // ERC20 approval if needed
        let overrides = {};
        if (![ZERO, NATIVE_SENTINEL].includes(currency)){
          const erc = new ethers.Contract(currency, ERC20_MIN_ABI, signer);
          const allowance = await erc.allowance(buyFor, MARKETPLACE_ADDR);
          if (allowance.lt(expectedTotal)){
            st.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Approving token...";
            const txa = await erc.approve(MARKETPLACE_ADDR, expectedTotal);
            await txa.wait();
          }
        } else {
          // send native value
          overrides = { value: expectedTotal };
        }

        st.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Sending purchase...";
        const tx = await marketWrite.buyFromListing(id, buyFor, quantity, currency, expectedTotal, overrides);
        showNotification("Transaction sent. Waiting for confirmationâ€¦", "info");
        await tx.wait();
        hideModal();
        st.className="status ok"; st.innerHTML = `<i class="fas fa-check"></i> Purchase confirmed`;
        showNotification("Purchase confirmed ðŸŽ‰", "success");
        loadListings();
      }catch(err){
        console.error(err);
        st.className="status err";
        st.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${escapeHtml(err?.message || "Transaction failed")}`;
        showNotification(err?.message || "Transaction failed", "error");
      }finally{
        document.getElementById('modal-confirm').disabled = false;
      }
    };
  }catch(err){
    console.error(err);
    st.className="status err";
    st.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${escapeHtml(err?.message || "Transaction failed")}`;
    showNotification(err?.message || "Transaction failed", "error");
  }
});

/* ===================== BOOT ===================== */
async function start(){
  await loadListings();
  clearInterval(refreshTimer);
  refreshTimer = setInterval(loadListings, 30000);
}
start();
</script>
</body>
</html>
