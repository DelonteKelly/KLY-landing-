<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLY Sovereign Marketplace</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet" />
<style>
  :root { --bg:#0b0b0d; --panel:#121216; --ink:#f1f5f9; --muted:#9aa4af; --gold:#e6c15a; --line:#24262d; --ok:#3ddc97; --err:#ff6b6b; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1080px;margin:0 auto;padding:20px}
  .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 14px}
  .brand{display:flex;gap:10px;align-items:center}
  .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1115;color:var(--muted);font-size:13px}
  .btn{appearance:none;border:1px solid var(--line);background:#15171d;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,var(--gold),#caa43f);color:#1a1a1a;border-color:#a0802c}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .tabs{display:flex;gap:10px;margin:16px 0}
  .tabs button{border-radius:999px;padding:10px 14px}
  .tabs .active{background:#1a1d24;color:var(--gold);border-color:#383b46}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:920px){ .grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:620px){ .grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .card .pad{padding:14px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:14px}
  .sub{color:var(--muted);font-size:13px}
  .price{font-weight:800}
  .img{width:100%;aspect-ratio:1/1;background:#0f1115;display:grid;place-items:center;color:#333}
  .status{margin:10px 0 0;color:var(--muted);font-size:12px}
  .warn{color:#ffce67} .ok{color:var(--ok)} .err{color:var(--err)}
  .foot{margin:22px 0 0;color:#839; font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="pill">KLY Sovereign Marketplace · BNB Chain</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="net" class="pill">Not connected</span>
      <button id="switch" class="btn">Switch to BNB</button>
      <button id="connect" class="btn primary">Connect Wallet</button>
    </div>
  </div>

  <div class="tabs">
    <button data-tab="all" class="btn active">All Listings</button>
    <button data-tab="available" class="btn">Available</button>
    <button data-tab="sold" class="btn">Sold</button>
  </div>

  <div id="grid" class="grid"></div>
  <p id="empty" class="sub" style="display:none;margin-top:16px">No listings found.</p>

  <p class="foot">1% fee funds KLY staking & Tamaquah Nation. (Thirdweb protocol fee may apply.)</p>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* -------------------- CONFIG -------------------- */
const MARKETPLACE_ADDRESS = "0xYOUR_MARKETPLACE_V3_ADDRESS";   // <-- paste your MarketplaceV3
const BSC_CHAIN_ID        = 56;
const BSC_RPC             = "https://bsc-dataseed.bnbchain.org/";
const THIRDWEB_LISTING_URL = (id) => `https://thirdweb.com/binance/${MARKETPLACE_ADDRESS}/listings/${id}`;

/* ---- Minimal ABIs ---- */
// MarketplaceV3 essentials
const MP_ABI = [
  "function getAllValidListings(uint256 start,uint256 count) view returns (tuple(uint256 id,address assetContract,uint256 tokenId,uint256 startTime,uint256 endTime,address seller,address currency,uint256 reservePricePerToken,uint256 buyoutPricePerToken,uint256 quantity,uint8 tokenType,uint8 listingType)[])",
  "function buyFromListing(uint256 _listingId,address _buyFor,uint256 _quantity,address _currency,uint256 _pricePerToken) payable",
  "function totalListings() view returns (uint256)"
];
// ERC721 + ERC1155 + ERC20 fragments for display / payments
const ERC721_ABI = [
  "function tokenURI(uint256) view returns (string)",
  "function ownerOf(uint256) view returns (address)"
];
const ERC1155_ABI = [
  "function uri(uint256) view returns (string)",
  "function balanceOf(address,uint256) view returns (uint256)"
];
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)"
];

let web3Modal, extProv, provider, signer, me;
let readProvider, mp;

/* -------------------- INIT -------------------- */
async function init() {
  web3Modal = new window.Web3Modal.default({ cacheProvider:true });
  readProvider = new ethers.providers.JsonRpcProvider(BSC_RPC, {name:"bnb", chainId:BSC_CHAIN_ID});
  mp = new ethers.Contract(MARKETPLACE_ADDRESS, MP_ABI, readProvider);

  bindUI();
  await loadListings(); // show even before connect
}
function bindUI(){
  document.querySelectorAll('.tabs button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      render(lastListings, btn.dataset.tab);
    });
  });

  document.getElementById('connect').addEventListener('click', connect);
  document.getElementById('switch').addEventListener('click', switchToBnb);
}

/* -------------------- CONNECT -------------------- */
async function connect(){
  try{
    extProv = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(extProv);
    signer   = provider.getSigner();
    me       = await signer.getAddress();
    const net = await provider.getNetwork();
    if(net.chainId !== BSC_CHAIN_ID) {
      await switchToBnb();
    }
    document.getElementById('net').textContent = `Connected · ${short(me)}`;
    // re-render so Buy buttons are enabled
    render(lastListings, currentTab());
    // handle account/chain changes
    extProv.on?.('accountsChanged',()=>location.reload());
    extProv.on?.('chainChanged',  ()=>location.reload());
  }catch(e){ console.warn(e); }
}
async function switchToBnb(){
  if(!provider){ provider = new ethers.providers.Web3Provider(window.ethereum || extProv); }
  const hex = "0x" + BSC_CHAIN_ID.toString(16);
  try { await provider.send("wallet_switchEthereumChain", [{ chainId: hex }]); }
  catch(e){
    if(e?.code === 4902){
      await provider.send("wallet_addEthereumChain", [{
        chainId: hex,
        chainName: "BNB Smart Chain",
        nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
        rpcUrls: [BSC_RPC],
        blockExplorerUrls: ["https://bscscan.com"]
      }]);
    } else { throw e; }
  }
}

/* -------------------- LISTINGS -------------------- */
let lastListings = [];
async function loadListings(){
  try{
    const listings = await mp.getAllValidListings(0, 50);
    lastListings = listings.map(normalizeListing);
    render(lastListings, currentTab());
  }catch(e){
    console.error(e);
    document.getElementById('empty').style.display = 'block';
    document.getElementById('empty').textContent = "Couldn't load listings. Check Marketplace address.";
  }
}
function normalizeListing(L){
  // L fields align with tuple; cast BigNumbers
  const bn = ethers.BigNumber.isBigNumber;
  return {
    id:          bn(L.id) ? L.id.toNumber() : Number(L.id),
    asset:       L.assetContract,
    tokenId:     bn(L.tokenId) ? L.tokenId.toString() : String(L.tokenId),
    start:       bn(L.startTime) ? L.startTime.toNumber() : Number(L.startTime),
    end:         bn(L.endTime) ? L.endTime.toNumber() : Number(L.endTime),
    seller:      L.seller,
    currency:    L.currency,
    reserve:     L.reservePricePerToken?.toString?.() ?? "0",
    buyout:      L.buyoutPricePerToken?.toString?.() ?? "0",
    quantity:    bn(L.quantity) ? L.quantity.toString() : String(L.quantity),
    tokenType:   Number(L.tokenType),     // 0=ERC1155, 1=ERC721
    listingType: Number(L.listingType),   // 0=Direct, 1=Auction
  };
}
function currentTab(){
  return document.querySelector('.tabs .active')?.dataset.tab || 'all';
}
function render(listings, tab='all'){
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  grid.innerHTML = "";

  // simple tab logic; "sold" if endTime < now
  const now = Math.floor(Date.now()/1000);
  let rows = listings.slice();
  if(tab === 'available') rows = rows.filter(r => r.end === 0 || r.end > now);
  if(tab === 'sold')      rows = rows.filter(r => r.end > 0 && r.end <= now);

  empty.style.display = rows.length ? 'none' : 'block';
  if(!rows.length) { empty.textContent = "No listings in this tab."; return; }

  rows.forEach(async (r) => {
    const card = document.createElement('div');
    card.className = "card";

    // Try to load a preview (best-effort from tokenURI/uri)
    const preview = await getPreview(r).catch(()=>null);

    card.innerHTML = `
      <div class="img">${ preview ? `<img src="${preview}" alt="" style="width:100%;height:100%;object-fit:cover">` : "No preview" }</div>
      <div class="pad">
        <div class="row"><span class="sub">Listing #${r.id}</span><span class="sub">${r.listingType===0?'Direct':'Auction'}</span></div>
        <div class="row"><span class="sub">Asset</span><span class="sub">${short(r.asset)} · #${r.tokenId}</span></div>
        <div class="row"><span class="sub">Price</span><span class="price" id="p-${r.id}">—</span></div>
        <div class="row">
          <button class="btn" onclick="window.open('${THIRDWEB_LISTING_URL(r.id)}','_blank')">View</button>
          <button class="btn primary" id="buy-${r.id}" ${r.listingType!==0?'disabled':''}>Buy 1</button>
        </div>
        <div class="status" id="s-${r.id}"></div>
      </div>
    `;
    grid.appendChild(card);

    // Fill price + enable buy if we can
    fillPriceAndWireBuy(r);
  });
}

/* -------- helpers: preview/price/buy ---------- */
async function getPreview(list){
  const p = readProvider;
  if(list.tokenType === 1){ // ERC721
    const nft = new ethers.Contract(list.asset, ERC721_ABI, p);
    const uri = await nft.tokenURI(list.tokenId);
    return resolveImageFromURI(uri);
  } else { // ERC1155
    const col = new ethers.Contract(list.asset, ERC1155_ABI, p);
    let uri = await col.uri(list.tokenId);
    return resolveImageFromURI(uri);
  }
}
async function resolveImageFromURI(uri){
  // Handle ipfs:// and http(s)
  let u = uri;
  if (uri.startsWith("ipfs://")) u = "https://ipfs.io/ipfs/" + uri.replace("ipfs://","");
  const res = await fetch(u);
  const j = await res.json();
  let img = j.image || j.image_url;
  if(img && img.startsWith("ipfs://")) img = "https://ipfs.io/ipfs/" + img.replace("ipfs://","");
  return img || null;
}
async function fillPriceAndWireBuy(r){
  const pEl = document.getElementById(`p-${r.id}`);
  const bEl = document.getElementById(`buy-${r.id}`);
  const sEl = document.getElementById(`s-${r.id}`);

  // currency symbol
  let symbol = "BNB";
  let decimals = 18;
  const ZERO = "0x0000000000000000000000000000000000000000";
  if (r.currency && r.currency.toLowerCase() !== ZERO) {
    try{
      const erc20 = new ethers.Contract(r.currency, ERC20_ABI, readProvider);
      symbol = await erc20.symbol().catch(()=>symbol);
      decimals = await erc20.decimals().catch(()=>decimals);
    }catch{}
  }

  // price per token
  const fmt = (x, d=18) => ethers.utils.formatUnits(x, d);
  const price = r.buyout; // buyoutPricePerToken
  pEl.textContent = `${fmt(price, decimals)} ${symbol}`;

  // wire buy for Direct listings
  if (r.listingType === 0) {
    bEl.disabled = false;
    bEl.onclick = async () => {
      if (!signer) { await connect(); if (!signer) return; }
      try{
        sEl.textContent = "Preparing…";
        // if ERC20, ensure allowance
        if (r.currency.toLowerCase() !== ZERO){
          const erc20 = new ethers.Contract(r.currency, ERC20_ABI, signer);
          const allowance = await erc20.allowance(await signer.getAddress(), MARKETPLACE_ADDRESS);
          const need = ethers.BigNumber.from(r.buyout).mul(1); // quantity 1
          if (allowance.lt(need)) {
            const txA = await erc20.approve(MARKETPLACE_ADDRESS, need);
            sEl.textContent = "Approving…";
            await txA.wait();
          }
        }

        // call buyFromListing
        const mpWrite = mp.connect(signer);
        const args = [ r.id, await signer.getAddress(), 1, r.currency, r.buyout ];
        const overrides = (r.currency.toLowerCase() === ZERO) ? { value: r.buyout } : {};
        sEl.textContent = "Buying…";
        const tx = await mpWrite.buyFromListing(...args, overrides);
        await tx.wait();
        sEl.innerHTML = `<span class="ok">Success ✅</span>`;
      }catch(e){
        console.error(e);
        sEl.innerHTML = `<span class="err">${e?.error?.message || e?.message || 'Failed'}</span>`;
      }
    };
  } else {
    // Auction → guide to Thirdweb page
    bEl.disabled = true;
    sEl.innerHTML = `<span class="warn">Auction listing — use “View”.</span>`;
  }
}

/* ----------------- utils ----------------- */
const short = (a)=> a ? `${a.slice(0,6)}…${a.slice(-4)}` : "—";

/* ----------------- start ----------------- */
init();
</script>
</body>
</html>
