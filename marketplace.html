<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLY Sovereign Marketplace</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet" />
<style>
  :root { --bg:#0b0b0d; --panel:#121216; --ink:#f1f5f9; --muted:#9aa4af; --gold:#e6c15a; --line:#24262d; --ok:#3ddc97; --err:#ff6b6b; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1080px;margin:0 auto;padding:20px}
  .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0 14px;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1115;color:var(--muted);font-size:13px}
  .btn{appearance:none;border:1px solid var(--line);background:#15171d;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,var(--gold),#caa43f);color:#1a1a1a;border-color:#a0802c}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap}
  .tabs button{border-radius:999px;padding:10px 14px}
  .tabs .active{background:#1a1d24;color:var(--gold);border-color:#383b46}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:920px){ .grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:620px){ .grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .card .pad{padding:14px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:14px}
  .sub{color:var(--muted);font-size:13px}
  .price{font-weight:800}
  .img{width:100%;aspect-ratio:1/1;background:#0f1115;display:grid;place-items:center;color:#333}
  .status{margin:10px 0 0;color:var(--muted);font-size:12px}
  .warn{color:#ffce67} .ok{color:var(--ok)} .err{color:var(--err)}
  .foot{margin:22px 0 0;color:#839; font-size:12px;text-align:center}
  #listBox input{width:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="pill">KLY Sovereign Marketplace ¬∑ BNB Chain</div>
      <div id="net" class="pill">Not connected</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="switch" class="btn">Switch to BNB</button>
      <button id="connect" class="btn primary">Connect Wallet</button>
    </div>
  </div>

  <!-- LIST NFT PANEL -->
  <div id="listBox" style="margin:14px 0 18px; padding:14px; border:1px solid #24262d; border-radius:12px; background:#121216">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <strong>List an NFT</strong>
      <span class="sub">ERC-721 or ERC-1155</span>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:10px">
      <input id="in_asset"  placeholder="NFT contract (0x‚Ä¶)" />
      <input id="in_token"  placeholder="Token ID" />
      <input id="in_qty"    placeholder="Quantity (1 for 721)" value="1" />
      <input id="in_price"  placeholder="Price per token (e.g., 100 for KLY or 0.05 for BNB)" />
    </div>

    <div style="display:flex;gap:10px;margin-top:10px;align-items:center;flex-wrap:wrap">
      <input id="in_currency" placeholder="Currency (0x0 = BNB, or ERC-20 address e.g. KLY)" style="flex:1" />
      <button id="btn_list" class="btn primary">Create Listing</button>
      <span id="list_msg" class="sub"></span>
    </div>

    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <label class="sub" style="align-self:center">Quick collections:</label>
      <button type="button" class="btn" id="pick_kor721" style="padding:8px 12px">KOR ERC-721</button>
    </div>
  </div>

  <div class="tabs">
    <button data-tab="all" class="btn active">All Listings</button>
    <button data-tab="available" class="btn">Available</button>
    <button data-tab="sold" class="btn">Sold</button>
  </div>

  <div id="grid" class="grid"></div>
  <p id="empty" class="sub" style="display:none;margin-top:16px">No listings found.</p>

  <p class="foot">1% fee funds KLY staking & Tamaquah Nation. (Thirdweb protocol fee may apply.)</p>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@thirdweb-dev/sdk@latest/dist/browser/thirdweb.min.js"></script>
<script>
/* -------------------- CONFIG -------------------- */
const MARKETPLACE_ADDRESS = "0x43159d07010ec59acc8b7df16eb9657667AD243A";   // MarketplaceV3 (yours)
const BSC_CHAIN_ID        = 56;
const BSC_RPC             = "https://bsc-dataseed.bnbchain.org/";
const THIRDWEB_LISTING_URL = (id) => `https://thirdweb.com/binance/${MARKETPLACE_ADDRESS}/listings/${id}`;

// KLY token address (for pricing in KLY)
const KLY_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";

// Known currencies: native BNB + KLY
const KNOWN = {
  "0x0000000000000000000000000000000000000000": { symbol: "BNB", decimals: 18 },
  [KLY_ADDRESS.toLowerCase()]: { symbol: "KLY", decimals: 18 }
};

// Your ERC-721 collection shortcut
const KOR_ERC721 = "0xdC5aA33c45Aa3777d3ccf51521cE329B03D39ea7";

// üëâ Put your Thirdweb Client ID here (Dashboard ‚Üí Settings)
const TW_CLIENT_ID = "YOUR_THIRDWEB_CLIENT_ID";

/* ---- Minimal ABIs ---- */
const MP_ABI = [
  "function getAllValidListings(uint256 start,uint256 count) view returns (tuple(uint256 id,address assetContract,uint256 tokenId,uint256 startTime,uint256 endTime,address seller,address currency,uint256 reservePricePerToken,uint256 buyoutPricePerToken,uint256 quantity,uint8 tokenType,uint8 listingType)[])",
  "function buyFromListing(uint256 _listingId,address _buyFor,uint256 _quantity,address _currency,uint256 _pricePerToken) payable",
  "function totalListings() view returns (uint256)"
];
const ERC721_ABI = [
  "function tokenURI(uint256) view returns (string)",
  "function ownerOf(uint256) view returns (address)",
  "function isApprovedForAll(address,address) view returns (bool)",
  "function setApprovalForAll(address,bool)"
];
const ERC1155_ABI = [
  "function uri(uint256) view returns (string)",
  "function balanceOf(address,uint256) view returns (uint256)",
  "function isApprovedForAll(address,address) view returns (bool)",
  "function setApprovalForAll(address,bool)"
];
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)"
];

let web3Modal, extProv, provider, signer, me;
let readProvider, mp;

/* -------------------- INIT -------------------- */
async function init() {
  web3Modal = new window.Web3Modal.default({ cacheProvider:true });
  readProvider = new ethers.providers.JsonRpcProvider(BSC_RPC, {name:"bnb", chainId:BSC_CHAIN_ID});
  mp = new ethers.Contract(MARKETPLACE_ADDRESS, MP_ABI, readProvider);

  // Prefill form
  document.getElementById('in_asset').value = KOR_ERC721;
  document.getElementById('pick_kor721').addEventListener('click', ()=>{
    document.getElementById('in_asset').value = KOR_ERC721;
  });
  // Default currency to KLY (can be cleared for BNB)
  document.getElementById('in_currency').value = KLY_ADDRESS;

  bindUI();
  await loadListings(); // show even before connect
}
function bindUI(){
  document.querySelectorAll('.tabs button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      render(lastListings, btn.dataset.tab);
    });
  });

  document.getElementById('connect').addEventListener('click', connect);
  document.getElementById('switch').addEventListener('click', switchToBnb);
  document.getElementById('btn_list').addEventListener('click', createListingFlow);
}

/* -------------------- CONNECT -------------------- */
async function connect(){
  try{
    extProv = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(extProv);
    signer   = provider.getSigner();
    me       = await signer.getAddress();
    const net = await provider.getNetwork();
    if(net.chainId !== BSC_CHAIN_ID) {
      await switchToBnb();
    }
    document.getElementById('net').textContent = `Connected ¬∑ ${short(me)}`;
    // re-render so Buy buttons are enabled
    render(lastListings, currentTab());
    // handle account/chain changes
    extProv.on?.('accountsChanged',()=>location.reload());
    extProv.on?.('chainChanged',  ()=>location.reload());
  }catch(e){ console.warn(e); }
}
async function switchToBnb(){
  if(!provider){ provider = new ethers.providers.Web3Provider(window.ethereum || extProv); }
  const hex = "0x" + BSC_CHAIN_ID.toString(16);
  try { await provider.send("wallet_switchEthereumChain", [{ chainId: hex }]); }
  catch(e){
    if(e?.code === 4902){
      await provider.send("wallet_addEthereumChain", [{
        chainId: hex,
        chainName: "BNB Smart Chain",
        nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
        rpcUrls: [BSC_RPC],
        blockExplorerUrls: ["https://bscscan.com"]
      }]);
    } else { throw e; }
  }
}

/* -------------------- LISTINGS -------------------- */
let lastListings = [];
async function loadListings(){
  try{
    const listings = await mp.getAllValidListings(0, 50);
    lastListings = listings.map(normalizeListing);
    render(lastListings, currentTab());
  }catch(e){
    console.error(e);
    document.getElementById('empty').style.display = 'block';
    document.getElementById('empty').textContent = "Couldn't load listings. Check Marketplace address.";
  }
}
function normalizeListing(L){
  const bn = ethers.BigNumber.isBigNumber;
  return {
    id:          bn(L.id) ? L.id.toNumber() : Number(L.id),
    asset:       L.assetContract,
    tokenId:     bn(L.tokenId) ? L.tokenId.toString() : String(L.tokenId),
    start:       bn(L.startTime) ? L.startTime.toNumber() : Number(L.startTime),
    end:         bn(L.endTime) ? L.endTime.toNumber() : Number(L.endTime),
    seller:      L.seller,
    currency:    L.currency,
    reserve:     L.reservePricePerToken?.toString?.() ?? "0",
    buyout:      L.buyoutPricePerToken?.toString?.() ?? "0",
    quantity:    bn(L.quantity) ? L.quantity.toString() : String(L.quantity),
    tokenType:   Number(L.tokenType),     // 0=ERC1155, 1=ERC721
    listingType: Number(L.listingType),   // 0=Direct, 1=Auction
  };
}
function currentTab(){
  return document.querySelector('.tabs .active')?.dataset.tab || 'all';
}
function render(listings, tab='all'){
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  grid.innerHTML = "";

  const now = Math.floor(Date.now()/1000);
  let rows = listings.slice();
  if(tab === 'available') rows = rows.filter(r => r.end === 0 || r.end > now);
  if(tab === 'sold')      rows = rows.filter(r => r.end > 0 && r.end <= now);

  empty.style.display = rows.length ? 'none' : 'block';
  if(!rows.length) { empty.textContent = "No listings in this tab."; return; }

  rows.forEach(async (r) => {
    const card = document.createElement('div');
    card.className = "card";

    const preview = await getPreview(r).catch(()=>null);

    card.innerHTML = `
      <div class="img">${ preview ? `<img src="${preview}" alt="" style="width:100%;height:100%;object-fit:cover">` : "No preview" }</div>
      <div class="pad">
        <div class="row"><span class="sub">Listing #${r.id}</span><span class="sub">${r.listingType===0?'Direct':'Auction'}</span></div>
        <div class="row"><span class="sub">Asset</span><span class="sub">${short(r.asset)} ¬∑ #${r.tokenId}</span></div>
        <div class="row"><span class="sub">Price</span><span class="price" id="p-${r.id}">‚Äî</span></div>
        <div class="row">
          <button class="btn" onclick="window.open('${THIRDWEB_LISTING_URL(r.id)}','_blank')">View</button>
          <button class="btn primary" id="buy-${r.id}" ${r.listingType!==0?'disabled':''}>Buy 1</button>
        </div>
        <div class="status" id="s-${r.id}"></div>
      </div>
    `;
    grid.appendChild(card);

    fillPriceAndWireBuy(r);
  });
}

/* -------- helpers: preview/price/buy ---------- */
async function getPreview(list){
  const p = readProvider;
  if(list.tokenType === 1){ // ERC721
    const nft = new ethers.Contract(list.asset, ERC721_ABI, p);
    const uri = await nft.tokenURI(list.tokenId);
    return resolveImageFromURI(uri);
  } else { // ERC1155
    const col = new ethers.Contract(list.asset, ERC1155_ABI, p);
    let uri = await col.uri(list.tokenId);
    return resolveImageFromURI(uri);
  }
}
async function resolveImageFromURI(uri){
  let u = uri;
  if (uri.startsWith("ipfs://")) u = "https://ipfs.io/ipfs/" + uri.replace("ipfs://","");
  const res = await fetch(u);
  const j = await res.json();
  let img = j.image || j.image_url;
  if(img && img.startsWith("ipfs://")) img = "https://ipfs.io/ipfs/" + img.replace("ipfs://","");
  return img || null;
}
async function fillPriceAndWireBuy(r){
  const pEl = document.getElementById(`p-${r.id}`);
  const bEl = document.getElementById(`buy-${r.id}`);
  const sEl = document.getElementById(`s-${r.id}`);

  // currency symbol/decimals
  const ZERO = "0x0000000000000000000000000000000000000000";
  const cur = (r.currency || ZERO).toLowerCase();
  let symbol = "BNB", decimals = 18;

  if (KNOWN[cur]) {
    symbol = KNOWN[cur].symbol;
    decimals = KNOWN[cur].decimals;
  } else if (cur !== ZERO) {
    try {
      const erc20 = new ethers.Contract(r.currency, ERC20_ABI, readProvider);
      symbol = await erc20.symbol().catch(()=>symbol);
      decimals = await erc20.decimals().catch(()=>decimals);
    } catch {}
  }

  const fmt = (x, d=18) => ethers.utils.formatUnits(x, d);
  pEl.textContent = `${fmt(r.buyout, decimals)} ${symbol}`;

  if (r.listingType === 0) {
    bEl.disabled = false;
    bEl.onclick = async () => {
      if (!signer) { await connect(); if (!signer) return; }
      try{
        sEl.textContent = "Preparing‚Ä¶";
        if (cur !== ZERO){
          const erc20 = new ethers.Contract(r.currency, ERC20_ABI, signer);
          const allowance = await erc20.allowance(await signer.getAddress(), MARKETPLACE_ADDRESS);
          const need = ethers.BigNumber.from(r.buyout);
          if (allowance.lt(need)) {
            const txA = await erc20.approve(MARKETPLACE_ADDRESS, need);
            sEl.textContent = "Approving‚Ä¶";
            await txA.wait();
          }
        }
        const mpWrite = mp.connect(signer);
        const args = [ r.id, await signer.getAddress(), 1, r.currency, r.buyout ];
        const overrides = (cur === ZERO) ? { value: r.buyout } : {};
        sEl.textContent = "Buying‚Ä¶";
        const tx = await mpWrite.buyFromListing(...args, overrides);
        await tx.wait();
        sEl.innerHTML = `<span class="ok">Success ‚úÖ</span>`;
      }catch(e){
        console.error(e);
        sEl.innerHTML = `<span class="err">${e?.error?.message || e?.message || 'Failed'}</span>`;
      }
    };
  } else {
    bEl.disabled = true;
    sEl.innerHTML = `<span class="warn">Auction listing ‚Äî use ‚ÄúView‚Äù.</span>`;
  }
}

/* ----------------- LIST NFT (create) ----------------- */
async function createListingFlow(){
  const msg = document.getElementById('list_msg');
  msg.textContent = "";
  if (!signer) { await connect(); if (!signer) return; }

  const asset     = (document.getElementById('in_asset').value || "").trim();
  const tokenId   = (document.getElementById('in_token').value || "").trim();
  const qtyStr    = (document.getElementById('in_qty').value || "1").trim();
  const priceStr  = (document.getElementById('in_price').value || "").trim();
  let   currency  = (document.getElementById('in_currency').value || "").trim();

  if (!asset || !tokenId || !priceStr) {
    msg.textContent = "Please enter NFT contract, tokenId and price.";
    return;
  }
  const quantity = Math.max(1, parseInt(qtyStr, 10));
  if (!currency) currency = "0x0000000000000000000000000000000000000000"; // BNB

  try{
    msg.textContent = "Checking collection type & approval‚Ä¶";
    // Detect 721 vs 1155 (ERC165)
    const ERC165_ABI = ["function supportsInterface(bytes4) view returns (bool)"];
    const c165 = new ethers.Contract(asset, ERC165_ABI, signer);
    const is1155 = await c165.supportsInterface("0xd9b67a26").catch(()=>false);
    const is721  = await c165.supportsInterface("0x80ac58cd").catch(()=>false);

    if (!(is1155 || is721)) { msg.textContent = "Contract is not ERC721 or ERC1155."; return; }

    const col = new ethers.Contract(asset, is1155 ? ERC1155_ABI : ERC721_ABI, signer);
    const ok = await col.isApprovedForAll(me, MARKETPLACE_ADDRESS);
    if (!ok){
      const t = await col.setApprovalForAll(MARKETPLACE_ADDRESS, true);
      msg.textContent = "Approving collection‚Ä¶";
      await t.wait();
    }

    // Thirdweb SDK (programmatic only)
    const sdk = new window.ThirdwebSDK.ThirdwebSDK({ signer, clientId: TW_CLIENT_ID, chainId: BSC_CHAIN_ID });
    const mp3 = await sdk.getContract(MARKETPLACE_ADDRESS, "marketplace-v3");

    const start  = new Date(Date.now() - 60_000);
    const end    = new Date(Date.now() + 30*86400000);

    msg.textContent = "Creating Direct listing‚Ä¶";
    const receipt = await mp3.directListings.createListing({
      assetContractAddress: asset,
      tokenId,
      quantity,
      currencyAddress: currency,      // 0x0=BNB or ERC-20 (e.g., KLY)
      pricePerToken: priceStr,        // human string ("100" for KLY, "0.05" for BNB)
      startTimestamp: start,
      endTimestamp: end,
      isReservedListing: false
    });

    msg.innerHTML = `<span class="ok">Listing created! #${receipt.id}</span>`;
    await loadListings();
  }catch(e){
    console.error(e);
    msg.innerHTML = `<span class="err">${e?.message || "Failed to list"}</span>`;
  }
}

/* ----------------- utils ----------------- */
const short = (a)=> a ? `${a.slice(0,6)}‚Ä¶${a.slice(-4)}` : "‚Äî";

/* ----------------- start ----------------- */
init();
</script>
</body>
</html>
