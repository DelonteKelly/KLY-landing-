<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>The KLY Vault | Chamber of Secrets</title>
  <meta name="description" content="Unlock the sacred artifacts of the KLY Legacy with your Key of Ascension NFT">
  <meta property="og:title" content="The KLY Vault | Chamber of Secrets">
  <meta property="og:description" content="Unlock the sacred artifacts of the KLY Legacy with your Key of Ascension NFT">
  <meta property="og:image" content="/og-vault.jpg">
  <meta name="theme-color" content="#0a0a0a">

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/png" href="favicon.png">

  <style>
    :root{
      --gold-primary:#ffd700; --gold-secondary:#c5a042; --gold-dark:#8a6d0b;
      --bg-dark:#0a0a0a; --bg-darker:#050505; --text-light:#f5f5f5; --text-dim:#bdbdbd;
      --accent-glow:0 0 15px rgba(255,215,0,.7); --transition:all .4s cubic-bezier(.165,.84,.44,1)
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{background:var(--bg-dark);color:var(--text-light);font-family:"Montserrat",sans-serif;overflow-x:hidden;position:relative}
    a{cursor:pointer}

    /* Loader */
    .loader{position:fixed;inset:0;background:var(--bg-darker);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .8s ease-out}
    .loader-spinner{width:50px;height:50px;border:5px solid rgba(255,215,0,.3);border-radius:50%;border-top-color:var(--gold-primary);animation:spin 1s ease-in-out infinite;margin-bottom:20px}
    .loader-text{color:var(--gold-primary);font-family:"Cinzel Decorative",serif;letter-spacing:2px;text-transform:uppercase}

    /* Header */
    .vault-header{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:20px 40px;background:rgba(10,10,10,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--gold-secondary);transition:var(--transition)}
    .vault-header.scrolled{background:rgba(5,5,5,.95);box-shadow:0 5px 30px rgba(0,0,0,.5)}
    .vault-logo{font-family:"Cinzel Decorative",serif;font-size:1.8rem;color:var(--gold-primary);text-shadow:var(--accent-glow);letter-spacing:2px;transition:var(--transition)}
    .vault-logo:hover{text-shadow:0 0 20px rgba(255,215,0,.9)}
    .vault-nav{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
    .vault-nav a{color:#cfcfcf;text-decoration:none;font-size:.9rem;transition:var(--transition);position:relative;font-family:"Cinzel Decorative",serif;letter-spacing:1px}
    .vault-nav a:hover{color:var(--gold-primary);text-shadow:0 0 5px var(--gold-primary)}
    .vault-nav a::after{content:"";position:absolute;bottom:-5px;left:0;width:0;height:1px;background:var(--gold-primary);transition:width .3s ease}
    .vault-nav a:hover::after{width:100%}
    #connectWalletBtn{border:1px solid var(--gold-secondary);padding:8px 16px;border-radius:20px;background:transparent;color:var(--text-light);transition:var(--transition);font-family:"Cinzel Decorative",serif;letter-spacing:1px;display:flex;align-items:center;gap:8px}
    #connectWalletBtn:hover{background:rgba(255,215,0,.1);border-color:var(--gold-primary);transform:translateY(-2px)}
    #connectWalletBtn.connected{background:rgba(255,215,0,.1);border-color:var(--gold-primary)}
    #walletAddress{font-size:.85rem;color:var(--gold-primary);font-family:"Montserrat",sans-serif}

    /* Background canvas + particles */
    #threejs-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1;opacity:.5;pointer-events:none}
    .particles{position:fixed;inset:0;z-index:2;pointer-events:none}
    .particle{position:absolute;background:var(--gold-primary);border-radius:50%;opacity:.6;filter:blur(1px)}

    /* Main content */
    .vault-content{position:relative;z-index:5;text-align:center;max-width:1200px;padding:100px 20px;margin:auto}
    .vault-title{font-family:"Cinzel Decorative",serif;font-size:clamp(2.5rem,5vw,4rem);color:var(--gold-primary);margin-bottom:20px;text-shadow:0 0 20px rgba(255,215,0,.5);letter-spacing:3px;position:relative}
    .vault-title::after{content:"";position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);width:100px;height:2px;background:var(--gold-primary)}
    .vault-subtitle{font-size:clamp(1rem,2vw,1.2rem);color:var(--text-dim);margin:40px auto;line-height:1.6;max-width:700px}
    .enhanced-door{position:relative;width:100%;max-width:800px;margin:60px auto;z-index:3;transition:var(--transition);transform:translateY(0);perspective:1000px;will-change:transform}
    .enhanced-door:hover{transform:translateY(-5px)}
    .vault-image{width:100%;border:2px solid var(--gold-secondary);box-shadow:0 0 30px rgba(255,215,0,.3);border-radius:10px;transition:var(--transition)}
    .enhanced-door:hover .vault-image{box-shadow:0 0 40px rgba(255,215,0,.5)}
    .door-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;backdrop-filter:blur(3px);background:rgba(0,0,0,.5);text-align:center;border-radius:8px;transition:var(--transition)}
    .vault-door-title{font-family:"Cinzel Decorative",serif;font-size:clamp(1.5rem,3vw,1.8rem);color:var(--gold-primary);margin-bottom:20px;text-shadow:var(--accent-glow)}
    .unlock-btn{background:transparent;color:var(--gold-primary);border:1px solid var(--gold-secondary);padding:12px 30px;font-family:"Cinzel Decorative",serif;font-size:1.1rem;letter-spacing:1px;border-radius:30px;cursor:pointer;position:relative;overflow:hidden;transition:var(--transition)}
    .unlock-btn:hover{background:rgba(197,160,66,.2);box-shadow:0 0 20px rgba(197,160,66,.4);transform:translateY(-2px)}
    .unlock-btn::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,215,0,.3),transparent);transition:all .8s ease}
    .unlock-btn:hover::before{left:100%}

    /* Vault container & items */
    .vault-container{background:radial-gradient(circle at center,rgba(20,5,40,.9) 0%,rgba(5,0,15,.95) 100%);border:1px solid rgba(255,215,0,.15);border-radius:16px;padding:2rem;box-shadow:0 0 30px rgba(123,31,162,.2);margin-top:2rem}
    .vault-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;perspective:1000px;margin-top:2rem;opacity:0;transform:translateY(20px);transition:var(--transition)}
    .vault-items.visible{opacity:1;transform:translateY(0)}
    .vault-item{position:relative;background:rgba(15,5,30,.7);border:1px solid rgba(197,160,66,.3);border-radius:12px;padding:1.5rem;transition:all .4s cubic-bezier(.175,.885,.32,1.275);cursor:pointer;overflow:hidden;transform-style:preserve-3d;opacity:0;transform:translateY(20px);will-change:transform}
    .vault-item.visible{opacity:1;transform:translateY(0)}
    .vault-item:hover{transform:translateY(-5px) rotateX(5deg);box-shadow:0 10px 25px rgba(123,31,162,.5)}
    .vault-item::before{content:"";position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(to right,transparent,var(--gold-primary),transparent);opacity:0;transition:opacity .3s ease}
    .vault-item:hover::before{opacity:1}
    .knowledge-item  { border-color: rgba(75,0,130,.3) }
    .wealth-item     { border-color: rgba(0,255,127,.3) }
    .oracle-item     { border-color: rgba(138,43,226,.3) }
    .defense-item    { border-color: rgba(220,20,60,.3) }
    .memory-item     { border-color: rgba(100,149,237,.3) }
    .knowledge-item:hover  { border-color: rgba(75,0,130,.7) }
    .wealth-item:hover     { border-color: rgba(0,255,127,.7) }
    .oracle-item:hover     { border-color: rgba(138,43,226,.7) }
    .defense-item:hover    { border-color: rgba(220,20,60,.7) }
    .memory-item:hover     { border-color: rgba(100,149,237,.7) }
    .item-icon{font-size:2.5rem;margin-bottom:1rem;position:relative;display:inline-block;transition:transform .3s ease}
    .icon-aura{position:absolute;inset:-10px;border-radius:50%;opacity:0;transition:opacity .3s ease}
    .knowledge-item  .icon-aura{background:radial-gradient(circle,rgba(75,0,130,.4) 0%,transparent 70%)}
    .wealth-item     .icon-aura{background:radial-gradient(circle,rgba(0,255,127,.4) 0%,transparent 70%)}
    .oracle-item     .icon-aura{background:radial-gradient(circle,rgba(138,43,226,.4) 0%,transparent 70%)}
    .defense-item    .icon-aura{background:radial-gradient(circle,rgba(220,20,60,.4) 0%,transparent 70%)}
    .memory-item     .icon-aura{background:radial-gradient(circle,rgba(100,149,237,.4) 0%,transparent 70%)}
    .vault-item:hover .icon-aura{opacity:.6}
    .vault-item:hover .item-icon{transform:scale(1.1) rotate(5deg)}
    .item-title{font-size:1.4rem;margin-bottom:.8rem;background:linear-gradient(90deg,#fff,#aaa);-webkit-background-clip:text;background-clip:text;color:transparent;font-family:"Cinzel Decorative",serif}
    .item-desc{color:rgba(200,200,220,.85);line-height:1.5;margin-bottom:1.5rem;position:relative;font-size:.95rem}
    .hidden-text{display:block;font-style:italic;color:rgba(255,255,255,.55);margin-bottom:.5rem;opacity:0;height:0;transition:all .3s ease}
    .vault-item:hover .hidden-text{opacity:1;height:auto}
    .blockchain-data{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;font-family:monospace;font-size:.9rem;color:rgba(150,200,255,.8)}
    .live-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;background:#0f0;box-shadow:0 0 5px #0f0;animation:pulse 2s infinite}
    .relic-cta{background:transparent;border:1px solid;color:white;padding:.5rem 1rem;border-radius:20px;cursor:pointer;transition:all .3s ease;font-weight:bold;width:100%;font-family:"Montserrat",sans-serif}
    .knowledge-item .relic-cta{border-color:indigo;color:indigo}
    .wealth-item .relic-cta{border-color:lime;color:lime}
    .oracle-item .relic-cta{border-color:mediumpurple;color:mediumpurple}
    .defense-item .relic-cta{border-color:crimson;color:crimson}
    .memory-item .relic-cta{border-color:cornflowerblue;color:cornflowerblue}
    .relic-cta:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.3)}

    /* Easter egg */
    .hidden-relic{border-color:rgba(255,255,255,.5)!important;animation:glow 3s infinite alternate}
    @keyframes glow{from{box-shadow:0 0 5px rgba(255,255,255,.3)}to{box-shadow:0 0 20px rgba(255,255,255,.7)}}

    /* Status overlay */
    .status-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,.95);color:var(--gold-primary);padding:25px 50px;border:1px solid var(--gold-secondary);font-family:"Cinzel Decorative",serif;z-index:9999;border-radius:10px;text-align:center;box-shadow:0 0 30px rgba(0,0,0,.8);display:flex;flex-direction:column;align-items:center;gap:15px;opacity:0;transition:var(--transition);pointer-events:none}
    .status-overlay.visible{opacity:1}
    .status-icon{font-size:2rem}
    .status-text{font-size:1.1rem;letter-spacing:1px}
    .progress-bar{width:100%;height:3px;background:rgba(255,215,0,.2);border-radius:3px;overflow:hidden;margin-top:15px}
    .progress-fill{height:100%;background:linear-gradient(to right,var(--gold-dark),var(--gold-primary));width:0;transition:width .3s ease}

    /* Footer */
    .vault-footer{position:relative;z-index:10;text-align:center;padding:50px 30px;margin-top:50px;color:#c7c7c7;font-size:.85rem;border-top:1px solid rgba(197,160,66,.1)}

    /* Animations */
    @keyframes doorOpen{0%{transform:scale(1);opacity:1}100%{transform:scale(.8) rotateY(90deg);opacity:0}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}100%{opacity:.7;transform:scale(1)}}

    /* Responsive */
    @media (max-width:768px){
      .vault-header{flex-direction:column;padding:15px}
      .vault-logo{margin-bottom:10px}
      .vault-content{padding:80px 20px}
      .enhanced-door{margin:30px auto}
      .vault-container{padding:1rem}
      .vault-items{grid-template-columns:1fr}
    }
    @media (max-width:480px){
      .vault-title{font-size:2rem}
      .unlock-btn{padding:10px 20px;font-size:1rem}
      .status-overlay{width:90%;padding:20px}
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .loader-spinner{animation:none}
      #threejs-canvas,.particles{display:none}
      .vault-item,.enhanced-door{transition:none}
    }

    .hidden{display:none!important}

    /* ===== Sigil Smithy modal ===== */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:10000
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(920px,92vw);background:rgba(15,5,30,.95);border:1px solid rgba(197,160,66,.3);
      border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(197,160,66,.2)
    }
    .modal-title{font-family:"Cinzel Decorative",serif;font-size:1.2rem;color:var(--gold-primary);letter-spacing:1px}
    .modal-body{display:flex;gap:18px;flex-wrap:wrap;padding:16px}
    .sigil-canvas-wrap{
      flex:2;min-width:300px;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(255,255,255,.04), transparent 70%);
      border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:10px
    }
    #sigilCanvas{width:100%;height:auto;max-height:60vh;border-radius:10px;background:#0b0b13}
    .control-panel{
      flex:1;min-width:260px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px
    }
    .control-panel label{font-size:.85rem;color:#e5e5e5;margin-bottom:4px}
    .control-panel input[type="text"]{
      width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(20,20,30,.6);color:#fff;font-family:monospace
    }
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      padding:8px 10px;border-radius:10px;border:1px solid rgba(197,160,66,.4);background:transparent;color:#f6f6f6;cursor:pointer;transition:.25s;
      font-weight:600
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .btn.primary{border-color:var(--gold-primary);color:var(--gold-primary)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;font-size:.8rem;color:#ddd
    }
    .color-dot{width:14px;height:14px;border-radius:50%}
    .modal-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid rgba(197,160,66,.2)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#111;border:1px solid #333;border-bottom-width:2px;color:#eee;padding:2px 6px;border-radius:6px}

    /* ===== Breathe Sanctuary modal ===== */
    .breathe-wrap{display:flex;gap:18px;flex-wrap:wrap;padding:16px}
    .breathe-stage{flex:2;min-width:280px;display:grid;place-items:center}
    .breathe-controls{flex:1;min-width:260px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .breathe-sphere{
      width:min(360px,70vw);aspect-ratio:1/1;border-radius:50%;
      background:radial-gradient(circle at 40% 40%, rgba(255,215,0,.35), rgba(255,215,0,.08) 60%, rgba(255,255,255,.03) 70%, transparent 80%),
                 radial-gradient(circle at 50% 50%, rgba(197,160,66,.15), rgba(10,10,16,.85) 70%);
      box-shadow:0 0 60px rgba(255,215,0,.12), inset 0 0 40px rgba(255,255,255,.06);
      display:grid;place-items:center;position:relative;transition:transform 1s ease-in-out;
    }
    .breathe-ring{
      position:absolute; inset:0; border-radius:50%;
      background:conic-gradient(var(--gold-primary) 0deg, rgba(255,255,255,.08) 0deg);
      -webkit-mask:radial-gradient(circle 46% at 50% 50%, transparent 98%, #000 100%);
              mask:radial-gradient(circle 46% at 50% 50%, transparent 98%, #000 100%);
      filter:drop-shadow(0 0 10px rgba(255,215,0,.25));
      transition:background 0.6s linear;
    }
    .breathe-text{font-family:"Cinzel Decorative",serif;color:var(--gold-primary);letter-spacing:.6px;text-shadow:0 0 12px rgba(255,215,0,.35); user-select:none}
    .breathe-phase{font-size:1.25rem;margin-top:8px}
    .breathe-timer{font-size:2.2rem}
    .select, .input, .btn.thin{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:rgba(20,20,30,.6);color:#fff;font-family:inherit
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
/* Backdrops fill screen and can scroll on iOS */
#breatheModalBackdrop,
#sigilModalBackdrop{
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: none;                 /* your JS toggles .show */
  background: rgba(0,0,0,.55);
  /* CRITICAL: allow scrolling inside the overlay */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* keep content off the device bars/safe areas */
  padding:
    max(12px, env(safe-area-inset-top))
    max(12px, env(safe-area-inset-right))
    calc(max(12px, env(safe-area-inset-bottom)) + 8px)
    max(12px, env(safe-area-inset-left));
  overscroll-behavior: contain;  /* avoid rubber-banding the page behind */
}

#breatheModalBackdrop.show,
#sigilModalBackdrop.show{
  display: block;
}

/* Panel centers but will NEVER exceed the viewport height */
.breathe-panel, .sigil-panel{
  width: min(720px, 100%);
  margin: 0 auto;
  background: radial-gradient(120% 120% at 50% -10%, #2a2037 0%, #130e1b 60%);
  border: 1px solid rgba(255,215,0,.15);
  border-radius: 16px;
  box-shadow: 0 12px 48px rgba(0,0,0,.5);
  /* CRITICAL: constrain to viewport and let inside area scroll */
  max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* If you have a header/footer in the panel, make body scrollable */
.breathe-content, .sigil-content{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
}

/* Optional: sticky header in the panel */
.breathe-header, .sigil-header{
  position: sticky;
  top: 0;
  z-index: 1;
  background: linear-gradient(180deg, rgba(19,14,27,.95), rgba(19,14,27,.85));
  backdrop-filter: blur(6px);
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255,215,0,.12);
}

/* Lock background scroll when a modal is open */
body.modal-open{
  position: fixed;
  width: 100%;
  overflow: hidden;
}
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div class="loader" id="pageLoader">
    <div class="loader-spinner" aria-hidden="true"></div>
    <div class="loader-text">Entering the Vault...</div>
  </div>

  <header class="vault-header" id="mainHeader">
    <div class="vault-logo">THE KLY VAULT</div>
    <nav class="vault-nav" aria-label="Primary">
      <a href="/portal.html">Portal</a>
      <a href="/kly-academy.html">Academy</a>
      <a href="/oracle.html">Oracle</a>
      <a href="status_correction.html">Status Correction</a>
      <button id="connectWalletBtn" aria-label="Connect wallet">
        <i class="fas fa-wallet" aria-hidden="true"></i><span>Connect Wallet</span>
      </button>
      <span id="walletAddress" class="hidden" aria-live="polite"></span>
    </nav>
  </header>

  <canvas id="threejs-canvas"></canvas>
  <div class="particles" id="particles" aria-hidden="true"></div>

  <main class="vault-content" id="main" role="main" aria-describedby="pageTagline">
    <h1 class="vault-title">CHAMBER OF SECRETS</h1>
    <p id="pageTagline" class="vault-subtitle">WHAT IS SOUGHT<br>IS FOUND WITHIN</p>

    <div class="enhanced-door">
      <img src="vault-door.png" alt="Ancient Vault Door with intricate carvings" class="vault-image">
      <div class="door-overlay">
        <h2 class="vault-door-title">Key of Ascension Required</h2>
        <button class="unlock-btn" id="unlockBtn" aria-label="Enter the vault after verification">
          <i class="fas fa-key" aria-hidden="true"></i> Enter the Vault
        </button>
      </div>
    </div>

    <div class="vault-container">
      <div class="vault-items" id="vaultItems">
        <!-- Academy Library -->
        <article class="vault-item knowledge-item" onclick="interactWithRelic(this, 'academy')">
          <div class="item-icon" aria-hidden="true">📚<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Academy Library</h3>
          <p class="item-desc">
            <span class="hidden-text">Sift the signal from the noise.</span>
            Premium lessons, meditations, and exercises curated for Initiates. New drops weekly.
          </p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Access: <code>Key of Ascension</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openAcademy()" aria-label="Enter Academy">Enter Academy</button>
        </article>

       <!-- Staking & Rewards -->
<article class="vault-item wealth-item" onclick="interactWithRelic(this, 'stake')">
  <div class="item-icon" aria-hidden="true">
    💠<div class="icon-aura" aria-hidden="true"></div>
  </div>
  <h3 class="item-title">Staking & Rewards</h3>
  <p class="item-desc">
    <span class="hidden-text">Let your KLY do the work.</span>
    Stake KLY to accrue rewards and unlock seasonal Vault perks & allowlists.
  </p>
  <div class="blockchain-data">
    <span class="live-indicator" aria-hidden="true"></span>
    <span>Network: <code>BSC</code></span>
  </div>
  <button class="relic-cta" onclick="event.stopPropagation(); openStaking()" aria-label="Open Stake">
    Open Stake
  </button>
</article>

        <!-- Altar of Flames -->
        <article class="vault-item wealth-item altar-item" onclick="interactWithRelic(this, 'altar')">
          <div class="item-icon" aria-hidden="true">🔥<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Altar of Flames</h3>
          <p class="item-desc"><span class="hidden-text">Offer what no longer serves; receive what endures.</span>Burn your $KLY to unlock hidden boons, seasonal allowlists, or relic drops.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Action: <code>Burn $KLY → Perks</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openAltarModal()" aria-label="Open Altar">Make Offering</button>
        </article>

        <!-- Oracle Readings -->
        <article class="vault-item oracle-item" onclick="interactWithRelic(this, 'oracle')">
          <div class="item-icon" aria-hidden="true">🔮<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Oracle Readings</h3>
          <p class="item-desc"><span class="hidden-text">When the path is unclear, ask.</span>Personalized AI-guided spreads seeded with on-chain signals and lunar cycles.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Status: <code>Live</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); launchOracle()" aria-label="Ask the Oracle">Ask the Oracle</button>
        </article>

        <!-- 🌬️ Breathe Sanctuary (replaces Security Center) -->
        <article class="vault-item defense-item" onclick="interactWithRelic(this, 'breathe')">
          <div class="item-icon" aria-hidden="true">🌬️<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Breathe Sanctuary</h3>
          <p class="item-desc">
            <span class="hidden-text">The Vault breathes with you.</span>
            A guided space to restore balance — timed inhales, exhales, and stillness.
          </p>
          <div class="blockchain-data">
            <span class="live-indicator" aria-hidden="true"></span><span>Mode: <code>Breathwork</code></span>
          </div>
          <button class="relic-cta" onclick="event.stopPropagation(); openBreatheSanctuary()" aria-label="Open Breathe Sanctuary">Begin Practice</button>
        </article>

        <!-- 🔮 Sigil Smithy -->
        <article class="vault-item memory-item" onclick="interactWithRelic(this, 'sigil')">
          <div class="item-icon" aria-hidden="true">🧿<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Sigil Smithy</h3>
          <p class="item-desc">
            <span class="hidden-text">Forge the mark of your lineage.</span>
            Generate a unique crest from your wallet entropy or a custom seed. Save it as a high-res PNG.
          </p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Mode: <code>Generative</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openSigilSmithy()" aria-label="Open Sigil Smithy">Open Sigil Smithy</button>
        </article>

        <!-- Hidden Relic -->
        <article class="vault-item hidden-relic" id="thirdEyeRelic" style="display:none;">
          <div class="item-icon" aria-hidden="true">👁️<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">The Third Eye</h3>
          <p class="item-desc">You've proven your dedication. The deepest mysteries await...</p>
          <button class="relic-cta" onclick="initiateAscension()" aria-label="Begin initiation">Begin Initiation</button>
        </article>
      </div>
    </div>
  </main>

  <!-- Status overlay -->
  <div class="status-overlay" id="statusOverlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="status-icon" id="statusIcon" aria-hidden="true">🔍</div>
    <div class="status-text" id="statusText">Verifying access...</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>

  <!-- ===== Sigil Smithy Modal ===== -->
  <div class="modal-backdrop" id="sigilModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sigilModalTitle">
      <div class="modal-header">
        <div class="pill"><span class="color-dot" id="paletteDot" style="background:#ffd700"></span> Active Palette</div>
        <div class="modal-title" id="sigilModalTitle">Sigil Smithy</div>
        <button class="btn" id="closeSigilBtn" aria-label="Close Sigil Smithy">✖</button>
      </div>
      <div class="modal-body">
        <div class="sigil-canvas-wrap">
          <canvas id="sigilCanvas" width="1024" height="1024" aria-label="Generated sigil canvas"></canvas>
        </div>
        <div class="control-panel">
          <div>
            <label for="seedInput">Seed (wallet address or any text)</label>
            <input type="text" id="seedInput" placeholder="auto: your wallet, or type anything…" spellcheck="false">
          </div>
          <div class="btn-row">
            <button class="btn" id="generateBtn">Generate</button>
            <button class="btn" id="shufflePaletteBtn">Shuffle Palette</button>
            <button class="btn" id="randomizeBtn">Randomize</button>
            <button class="btn" id="toggleAnimBtn">⏸ Pause</button>
            <button class="btn" id="copySeedBtn">Copy Seed</button>
            <button class="btn" id="downloadBtn">Download PNG</button>
          </div>
          <div style="opacity:.85;font-size:.85rem;line-height:1.45">
            Tips:
            <ul style="margin:.4rem 0 .2rem 1rem">
              <li>Use your wallet address for a deterministic crest.</li>
              <li>Hit <span class="kbd">Shuffle Palette</span> to keep geometry but recolor.</li>
              <li>Art is rendered at 1024×1024 for clean prints.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span style="color:#c9c9c9">Hash-bound geometry • Symmetry • Noise fields</span>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="pill" id="sigilMeta">—</div>
          <button class="btn" id="toggleAnimBtnFooter">⏸ Pause</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Breathe Sanctuary Modal ===== -->
  <div class="modal-backdrop" id="breatheModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="breatheTitle">
      <div class="modal-header">
        <div class="pill"><span class="color-dot" style="background:#7b1fa2"></span> Breathe</div>
        <div class="modal-title" id="breatheTitle">Breathe Sanctuary</div>
        <button class="btn" id="closeBreatheBtn" aria-label="Close Breathe Sanctuary">✖</button>
      </div>

      <div class="breathe-wrap">
        <div class="breathe-stage">
          <div class="breathe-sphere" id="breatheSphere" aria-live="polite" aria-atomic="true">
            <div class="breathe-ring" id="breatheRing"></div>
            <div class="breathe-text">
              <div class="breathe-timer" id="breatheTimer">00:00</div>
              <div class="breathe-phase" id="breathePhase">Ready</div>
            </div>
          </div>
        </div>

        <div class="breathe-controls">
          <label for="patternSelect">Pattern</label>
          <select id="patternSelect" class="select">
            <option value="box">Box (4-4-4-4)</option>
            <option value="478">4-7-8 (calm)</option>
            <option value="coherence">Coherence (5-5)</option>
          </select>

          <div class="row">
            <div style="flex:1">
              <label for="minutesInput">Minutes</label>
              <input type="number" id="minutesInput" class="input" value="5" min="1" max="60">
            </div>
            <div style="flex:1">
              <label for="soundToggle">Chime</label>
              <select id="soundToggle" class="select">
                <option value="on">On</option>
                <option value="off" selected>Off</option>
              </select>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn primary" id="startBreatheBtn">Start</button>
            <button class="btn" id="pauseBreatheBtn">Pause</button>
            <button class="btn ghost" id="resetBreatheBtn">Reset</button>
          </div>

          <div style="opacity:.85;font-size:.85rem;line-height:1.45">
            Tips:
            <ul style="margin:.4rem 0 .2rem 1rem">
              <li>Let the sphere guide your inhale / hold / exhale / hold.</li>
              <li>Coherence = smooth inhale 5s, exhale 5s.</li>
              <li>4-7-8 is great before sleep.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span style="color:#c9c9c9">Presence • Balance • Clarity</span>
        <div class="pill" id="breatheMeta">Pattern: Box • 5 min</div>
      </div>
    </div>
  </div>

  <footer class="vault-footer">
    © 2025 Kelly Legacy Estates — Tamaquah Nation • Cycle 42 of the Great Alignment
  </footer>

  <!-- App -->
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js";

    // ================== Config ==================
    const CONTRACT_ADDRESS = "0xDA76d35742190283E340dbeE2038ecc978a56950";
    const CONTRACT_ABI = [
      { inputs:[{ internalType:"address", name:"owner", type:"address"}], name:"balanceOf",
        outputs:[{ internalType:"uint256", name:"", type:"uint256"}], stateMutability:"view", type:"function" }
    ];
    const BNB_CHAIN_ID = "0x38";

    // ================== DOM (safe refs) ==================
    const walletButton       = document.getElementById("connectWalletBtn");
    const walletAddressEl    = document.getElementById("walletAddress");
    const unlockBtn          = document.getElementById("unlockBtn");
    const vaultItems         = document.getElementById("vaultItems");
    const statusOverlay      = document.getElementById("statusOverlay");
    const statusIcon         = document.getElementById("statusIcon");
    const statusText         = document.getElementById("statusText");
    const progressFill       = document.getElementById("progressFill");
    const pageLoader         = document.getElementById("pageLoader");
    const mainHeader         = document.getElementById("mainHeader");
    const particlesContainer = document.getElementById("particles");

    // Sigil Modal DOM
    const modalBackdrop      = document.getElementById('sigilModalBackdrop');
    const closeSigilBtn      = document.getElementById('closeSigilBtn');
    const seedInput          = document.getElementById('seedInput');
    const generateBtn        = document.getElementById('generateBtn');
    const shufflePaletteBtn  = document.getElementById('shufflePaletteBtn');
    const randomizeBtn       = document.getElementById('randomizeBtn');
    const copySeedBtn        = document.getElementById('copySeedBtn');
    const downloadBtn        = document.getElementById('downloadBtn');
    const paletteDot         = document.getElementById('paletteDot');
    const sigilMeta          = document.getElementById('sigilMeta');
    const sigilCanvas        = document.getElementById('sigilCanvas');
    const ctx                = sigilCanvas ? sigilCanvas.getContext('2d') : null;
    const toggleAnimBtn      = document.getElementById('toggleAnimBtn');
    const toggleAnimBtnFooter= document.getElementById('toggleAnimBtnFooter');

    // ================== Init ==================
    document.addEventListener("DOMContentLoaded", async () => {
      // Loader + failsafe
      setTimeout(() => {
        if (pageLoader) pageLoader.style.opacity = "0";
        setTimeout(async () => {
          if (pageLoader) pageLoader.style.display = "none";
          initScrollHandler();
          createParticles();
          initThreeJS();

          const acct = await getActiveAccount();
          if (acct) updateWalletUI(true, acct);

          walletButton?.addEventListener("click", connectWallet);
          unlockBtn?.addEventListener("click", verifyNFTAccess);
        }, 800);
      }, 1000);
      setTimeout(() => { if (pageLoader) { pageLoader.style.opacity="0"; pageLoader.style.display="none"; }}, 4000);

      // Smithy events
      closeSigilBtn?.addEventListener('click', closeSigilSmithy);
      modalBackdrop?.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeSigilSmithy(); });
      generateBtn?.addEventListener('click', () => renderSigil(getEffectiveSeed(), currentPaletteIndex));
      shufflePaletteBtn?.addEventListener('click', () => { cyclePalette(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });
      randomizeBtn?.addEventListener('click', () => { if (seedInput) seedInput.value = randomSeed(); cyclePalette(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });
      copySeedBtn?.addEventListener('click', async () => { await navigator.clipboard.writeText(getEffectiveSeed()); toast('Seed copied', 'success'); });
      downloadBtn?.addEventListener('click', () => {
        if (!sigilCanvas) return;
        const link = document.createElement('a');
        const fileSeed = getEffectiveSeed().replace(/[^a-zA-Z0-9_-]/g,'').slice(0,32) || 'sigil';
        link.download = `kly-sigil_${fileSeed}.png`;
        link.href = sigilCanvas.toDataURL('image/png');
        link.click();
      });
      seedInput?.addEventListener('change', () => { saveSigilState(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });

      // Animation toggle buttons
      toggleAnimBtn?.addEventListener('click', toggleAnimation);
      toggleAnimBtnFooter?.addEventListener('click', toggleAnimation);

      const saved = JSON.parse(localStorage.getItem('kly_sigil_state') || '{}');
      if (saved.seed && seedInput) seedInput.value = saved.seed;
      if (Number.isInteger(saved.paletteIndex)) currentPaletteIndex = saved.paletteIndex;

      // Breathe Sanctuary events
      setupBreathe();
    });

    // ================== Particles ==================
    function createParticles(){
      if (!particlesContainer) return;
      const particleCount = window.matchMedia("(prefers-reduced-motion: reduce)").matches ? 0 : (window.innerWidth < 768 ? 24 : 48);
      for(let i=0;i<particleCount;i++){
        const p = document.createElement("div");
        p.className = "particle";
        const size = Math.random()*4+1;
        p.style.width = `${size}px`; p.style.height = `${size}px`;
        p.style.left = `${Math.random()*100}%`; p.style.top = `${Math.random()*100}%`;
        p.style.opacity = (Math.random()*0.5 + 0.1).toFixed(2);
        animateParticle(p, Math.random()*15+10, Math.random()*10);
        particlesContainer.appendChild(p);
      }
    }
    function animateParticle(particle, duration, delay){
      let start=null; const initialX=parseFloat(particle.style.left); const initialY=parseFloat(particle.style.top);
      function step(ts){
        if(!start) start=ts;
        const progress=(ts-start)/(duration*1000);
        if(progress<1){
          const newX = initialX + Math.sin(progress*Math.PI*2)*5;
          const newY = initialY - progress*100;
          const opacity = 0.1 + 0.4*(1-progress);
          particle.style.left = `${newX}%`; particle.style.top = `${newY}%`; particle.style.opacity = opacity;
          if(newY < -5){ particle.style.top = "105%"; particle.style.left = `${initialX}%`; particle.style.opacity = "0.1"; start = ts - delay*1000; }
          requestAnimationFrame(step);
        } else {
          particle.style.top = "105%"; particle.style.left = `${initialX}%`; particle.style.opacity = "0.1"; start = null;
          setTimeout(()=>{ start = performance.now(); requestAnimationFrame(step); }, delay*1000);
        }
      }
      setTimeout(()=>requestAnimationFrame(step), delay*1000);
    }

    // ================== Three.js BG ==================
    function initThreeJS(){
      if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
      const canvas = document.getElementById("threejs-canvas");
      if (!canvas) return;
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, .1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);

      const segs = window.innerWidth < 768 ? 96 : 192;
      const radial = window.innerWidth < 768 ? 16 : 32;
      const geometry = new THREE.TorusKnotGeometry(12, 3, segs, radial);
      const material = new THREE.MeshBasicMaterial({ color:0xd4af37, wireframe:true, transparent:true, opacity:.2 });
      const knot = new THREE.Mesh(geometry, material);
      scene.add(knot);

      const glowGeometry = new THREE.SphereGeometry(15, 32, 32);
      const glowMaterial = new THREE.MeshBasicMaterial({ color:0xd4af37, transparent:true, opacity:.05 });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      scene.add(glow);

      camera.position.z = 30;
      function animate(){
        requestAnimationFrame(animate);
        knot.rotation.x += .001; knot.rotation.y += .002;
        glow.rotation.x += .0005; glow.rotation.y += .0005;
        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    // ================== Header Scroll ==================
    function initScrollHandler(){
      if (!mainHeader) return;
      window.addEventListener("scroll", () => {
        if (window.scrollY > 50) mainHeader.classList.add("scrolled");
        else mainHeader.classList.remove("scrolled");
      });
    }

   // ================== Wallet helpers (mobile-safe) ==================
let provider = null;

function detectProvider(){
  // Prefer MetaMask, then Coinbase, then first detected
  if (window.ethereum?.providers?.length){
    provider =
      window.ethereum.providers.find(p => p.isMetaMask) ||
      window.ethereum.providers.find(p => p.isCoinbaseWallet) ||
      window.ethereum.providers[0];
  } else if (window.ethereum){
    provider = window.ethereum;
  } else if (window.trustwallet){        // Trust Wallet legacy
    provider = window.trustwallet;
  } else if (window.BinanceChain){       // Binance Wallet legacy
    provider = window.BinanceChain;
  }
  return provider || null;
}

async function getActiveAccount(){
  detectProvider();
  if(!provider) return null;
  try{
    const accounts = await provider.request({ method:"eth_accounts" });
    return accounts?.[0] ?? null;
  }catch{ return null; }
}

async function connectWallet(){
  detectProvider();

  if(!provider){
    showStatus("⚠️ No wallet detected — open in your wallet’s dapp browser.", "error");
    return;
  }

  try{
    showStatus("🔓 Connecting wallet...", "info");
    const accounts = await provider.request({ method:"eth_requestAccounts" });

    await verifyNetwork();
    updateWalletUI(true, accounts[0]);
    showStatus("✅ Wallet connected", "success");

    // Rebind listeners on the active provider
    provider.removeAllListeners?.("accountsChanged");
    provider.removeAllListeners?.("chainChanged");
    provider.on?.("accountsChanged", handleAccountsChanged);
    provider.on?.("chainChanged", handleChainChanged);
  }catch(err){
    const cancelled = err?.code === 4001;
    showStatus(cancelled ? "🛑 Request cancelled" : "⚠️ Connection failed", cancelled ? "warning" : "error");
    console.error("Wallet connection error:", err);
  }
}

async function verifyNetwork(){
  detectProvider();
  if (!provider) return;

  const currentChainId = await provider.request({ method:"eth_chainId" });
  if (currentChainId !== BNB_CHAIN_ID){
    showStatus("🌐 Switching to BSC...", "info");
    try {
      await provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BNB_CHAIN_ID }] });
    } catch (switchError) {
      if (switchError.code === 4902) {
        await provider.request({
          method:"wallet_addEthereumChain",
          params:[{
            chainId: BNB_CHAIN_ID,
            chainName: "Binance Smart Chain",
            nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls: ["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls: ["https://bscscan.com"]
          }]
        });
      } else {
        showStatus("⚠️ Please switch to BSC", "error");
        throw switchError;
      }
    }
  }
}

function handleAccountsChanged(accounts){
  if (!accounts.length){ updateWalletUI(false); showStatus("⚠️ Wallet disconnected", "warning"); }
  else { updateWalletUI(true, accounts[0]); }
}
function handleChainChanged(){ location.reload(); }

function updateWalletUI(connected, account=""){
  if (!walletButton || !walletAddressEl) return;
  if (connected){
    const short = shortenAddress(account);
    walletButton.innerHTML = `<i class="fas fa-check-circle" aria-hidden="true"></i><span>${short}</span>`;
    walletButton.classList.add("connected");
    walletAddressEl.textContent = short;
    walletAddressEl.classList.remove("hidden");
  } else {
    walletButton.innerHTML = '<i class="fas fa-wallet" aria-hidden="true"></i><span>Connect Wallet</span>';
    walletButton.classList.remove("connected");
    walletAddressEl.classList.add("hidden");
  }
}
const shortenAddress = (a) => `${a.substring(0,6)}...${a.substring(a.length-4)}`;

async function verifyNFTAccess(){
  detectProvider();
  if (!provider){ showStatus("🔑 Connect wallet first", "warning"); return; }
  try{
    const accounts = await provider.request({ method:"eth_requestAccounts" });
    const owner = accounts[0];
    showStatus("🔍 Verifying NFT...", "info"); simulateProgress();
    await verifyNetwork();

    const ethersProvider = new ethers.providers.Web3Provider(provider);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider);
    const balance = await contract.balanceOf(owner);

    const hasAccess = ethers.BigNumber.isBigNumber(balance) ? balance.gt(0) : Number(balance) > 0;
    if (hasAccess){ showStatus("✅ Access granted!", "success"); unlockVault(); }
    else { showStatus("⛔ Key of Ascension required", "error"); }
  }catch(e){
    const cancelled = e?.code === 4001;
    showStatus(cancelled ? "🛑 Request cancelled" : "⚠️ Verification failed", cancelled ? "warning" : "error");
    console.error("NFT verification error:", e);
  }
}

    function simulateProgress(){
      if (!progressFill) return;
      let progress = 0;
      const id = setInterval(()=>{
        progress += Math.random()*10;
        progressFill.style.width = `${Math.min(progress,100)}%`;
        if(progress >= 100) clearInterval(id);
      }, 200);
    }

    function unlockVault(){
      const doorOverlay = document.querySelector(".door-overlay");
      if (!doorOverlay || !vaultItems) return;
      doorOverlay.style.animation = "doorOpen 1s forwards";
      setTimeout(() => {
        doorOverlay.style.display = "none";
        vaultItems.classList.add("visible");
        document.querySelectorAll(".vault-item").forEach((item, idx)=>setTimeout(()=>item.classList.add("visible"), idx*100));
        setTimeout(()=>vaultItems.scrollIntoView({ behavior:"smooth", block:"start" }), 300);
      }, 900);
    }

    // ================== Status Overlay ==================
    function showStatus(message, type="info"){
      statusIcon && (statusIcon.textContent = ({ success:"✅", error:"❌", warning:"⚠️", info:"🔍" }[type] || "🔍"));
      statusText && (statusText.textContent = message);
      progressFill && (progressFill.style.width = "0");
      statusOverlay?.classList.add("visible");
      if (type !== "error"){
        setTimeout(()=>statusOverlay?.classList.remove("visible"), type === "success" ? 1800 : 2600);
      }
    }
    function toast(msg, type="info"){ showStatus(msg, type); }

    // ================== Easter Egg ==================
    let vaultClicks = 0;
    const vaultContainer = document.querySelector(".vault-container");
    vaultContainer?.addEventListener("click", () => {
      vaultClicks++;
      if (vaultClicks >= 7){
        const egg = document.getElementById("thirdEyeRelic");
        if (egg) egg.style.display = "block";
        try { new Audio("mystical_chime.mp3").play(); } catch {}
      }
    });
    window.initiateAscension = () => toast("✨ Initiation pathway coming soon…", "info");

    // ================== Relic interactions ==================
    function interactWithRelic(el, type){
      el.classList.add("relic-active");
      setTimeout(()=> el.classList.remove("relic-active"), 500);
      try { window.navigator.vibrate?.(10); } catch {}
      try { new Audio("relic_interaction.mp3").play(); } catch {}
      window.dispatchEvent(new CustomEvent("vault:relicClick", { detail:{ type, ts:Date.now() }}));
    }
  const VAULT_ROUTES = { 
  academy: "/kly-academy.html", 
  staking: "/stake.html",        // corrected filename
  oracle:  "/oracle.html", 
  security:"https://revoke.cash" 
};

async function openAcademy(){ 
  toast("Entering Academy…", "success"); 
  location.href = VAULT_ROUTES.academy; 
}

async function openStaking(){ 
  toast("Opening Staking…", "info"); 
  location.href = VAULT_ROUTES.staking; 
}

async function launchOracle(){ 
  toast("Consulting the Oracle…", "info"); 
  location.href = VAULT_ROUTES.oracle; 
}

function openAltarModal(){ 
  toast("🔥 Altar opening soon…", "info"); 
}

    // ================== 🔮 Sigil Smithy ==================
    const palettes = [
      ["#ffd700","#c5a042","#8a6d0b","#ffffff","#111111"],
      ["#7b1fa2","#e040fb","#ce93d8","#f3e5f5","#0b0b13"],
      ["#00ffa3","#00d1ff","#0077ff","#e6fff9","#0b0b13"],
      ["#ff5252","#ff1744","#ff8a80","#ffe5e5","#0b0b13"],
      ["#64b5f6","#1e88e5","#0d47a1","#e3f2fd","#0b0b13"]
    ];
    let currentPaletteIndex = 0, walletRawAddress = null, animReq = null, animOn = true, activeSeed = '', activeCfg = null;
    const TAU = Math.PI * 2;
    let DPR = 1, CSS_SIZE = 512, W = 512, H = 512;

    function resizeSigilCanvas(){
      if (!sigilCanvas || !ctx) return;
      DPR = Math.min(window.devicePixelRatio || 1, 2);
      CSS_SIZE = Math.min(window.innerWidth, window.innerHeight) * 0.8;
      W = CSS_SIZE; H = CSS_SIZE;
      sigilCanvas.width  = Math.round(W * DPR);
      sigilCanvas.height = Math.round(H * DPR);
      sigilCanvas.style.width  = `${W}px`;
      sigilCanvas.style.height = `${H}px`;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
    }
    resizeSigilCanvas();
    window.addEventListener("resize", resizeSigilCanvas);

    function getEffectiveSeed(){ return (seedInput?.value && seedInput.value.trim()) || walletRawAddress || randomSeed(); }
    function randomSeed(){ return 'seed-' + Math.random().toString(36).slice(2,10); }
    function saveSigilState(){ localStorage.setItem('kly_sigil_state', JSON.stringify({ seed: seedInput?.value || '', paletteIndex: currentPaletteIndex })); }
    function cyclePalette(){ currentPaletteIndex = (currentPaletteIndex+1)%palettes.length; saveSigilState(); }

    // bg cache
    const bgCache = document.createElement('canvas'); const bgCtx = bgCache.getContext('2d'); bgCache.width=1024; bgCache.height=1024;

    // helpers
    function h32(n){ n|=0; n=(n^(n>>>16))*0x45d9f3b; n=(n^(n>>>16))*0x45d9f3b; return (n^(n>>>16))>>>0; }
    function noise2D(x,y,seed=0){ const xi=Math.floor(x), yi=Math.floor(y); const xf=x-xi, yf=y-yi; const s=t=>t*t*(3-2*t);
      function rnd(ix,iy){ return (h32(ix*374761393 ^ iy*668265263 ^ seed) % 10000)/10000; }
      const v00=rnd(xi,yi), v10=rnd(xi+1,yi), v01=rnd(xi,yi+1), v11=rnd(xi+1,yi+1);
      const x1=v00+s(xf)*(v10-v00), x2=v01+s(xf)*(v11-v01); return x1+s(yf)*(x2-x1); }
    function fbm(x,y,seed,oct=4,fall=0.5,amp=1,freq=1){ let v=0,a=amp,f=freq; for(let i=0;i<oct;i++){ v+=a*noise2D(x*f,y*f,seed+i*11); a*=fall; f*=2;} return v; }
    function polygonPath(c,sides,r){ c.moveTo(r,0); const step=TAU/sides; for(let i=1;i<=sides;i++){ const a=i*step; c.lineTo(r*Math.cos(a), r*Math.sin(a)); } }
    function starPath(c,points,rO,rI){ const step=TAU/(points*2); c.moveTo(rO,0); for(let i=1;i<points*2;i++){ const r=(i%2===0)?rO:rI, a=i*step; c.lineTo(r*Math.cos(a), r*Math.sin(a)); } c.closePath(); }
    function rosePoint(k,a,r){ const rad=r*Math.cos(k*a); return [rad*Math.cos(a), rad*Math.sin(a)]; }
    function hexToRgb(hex){ const n=hex.replace('#',''); const v=parseInt(n.length===3?n.split('').map(c=>c+c).join(''):n,16); return [(v>>16)&255,(v>>8)&255,v&255]; }
    function hexA(hex,a){ const [r,g,b]=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
    function ringGradient(c,r0,r1,ca,cb,aA=.95,aB=.1){ const g=c.createRadialGradient(0,0,r0,0,0,r1); g.addColorStop(0,hexA(ca,aA)); g.addColorStop(1,hexA(cb,aB)); return g; }
    function drawRune(c,size,id,color){ const rnd=id%12; c.save(); c.strokeStyle=color; c.lineWidth=Math.max(1,size*0.08); c.lineCap='round';
      switch(rnd){case 0:c.beginPath();c.moveTo(-size,0);c.lineTo(size,0);c.stroke();break;case 1:c.beginPath();c.moveTo(0,-size);c.lineTo(0,size);c.stroke();break;
      case 2:c.beginPath();c.moveTo(-size,-size);c.lineTo(size,size);c.stroke();break;case 3:c.beginPath();c.moveTo(-size,size);c.lineTo(size,-size);c.stroke();break;
      case 4:c.beginPath();polygonPath(c,3,size);c.closePath();c.stroke();break;case 5:c.beginPath();polygonPath(c,4,size);c.closePath();c.stroke();break;
      case 6:c.beginPath();polygonPath(c,5,size);c.closePath();c.stroke();break;case 7:c.beginPath();starPath(c,5,size,size*0.45);c.stroke();break;
      case 8:c.beginPath();c.arc(0,0,size,0,TAU);c.stroke();break;case 9:c.beginPath();c.moveTo(-size,0);c.lineTo(0,-size);c.lineTo(size,0);c.stroke();break;
      case 10:c.beginPath();c.moveTo(-size,-size);c.lineTo(0,0);c.lineTo(size,-size);c.stroke();break;case 11:c.beginPath();c.arc(0,0,size,0,Math.PI);c.stroke();break;}
      c.restore(); }
    function makeBackground(colors){ const c=bgCtx; c.save(); const S=1024; c.clearRect(0,0,S,S);
      const base=c.createLinearGradient(0,0,S,S); base.addColorStop(0,hexA(colors[4],.98)); base.addColorStop(1,hexA(colors[4],.92)); c.fillStyle=base; c.fillRect(0,0,S,S);
      const glow=c.createRadialGradient(S/2,S/2,80,S/2,S/2,520); glow.addColorStop(0,hexA(colors[3],.15)); glow.addColorStop(1,'rgba(0,0,0,.65)'); c.fillStyle=glow; c.fillRect(0,0,S,S);
      c.globalAlpha=.12; for(let y=0;y<S;y+=2){for(let x=0;x<S;x+=2){ const v=fbm(x/240,y/240,h32(1337),3,.6); const g=Math.floor(20+v*28); c.fillStyle=`rgb(${g},${g},${g})`; c.fillRect(x,y,2,2);}}
      c.globalAlpha=1; c.strokeStyle=hexA(colors[2],.06); c.lineWidth=1; c.beginPath(); for(let a=0;a<TAU;a+=TAU/36){ c.moveTo(S/2,S/2); c.lineTo(S/2+520*Math.cos(a), S/2+520*Math.sin(a)); } c.stroke(); c.restore(); }
    function hash32(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
    function buildSigilConfig(seed){
      const n = hash32(seed); const rnd=(i=0)=>(h32(n+i*1013904223)%10000)/10000;
      const sym=8+Math.floor(rnd(1)*10), layers=3+Math.floor(rnd(2)*3), ringCount=3+Math.floor(rnd(3)*3);
      const rings=Array.from({length:ringCount},(_,i)=>140+i*60+Math.floor(rnd(4+i)*30));
      return { sym,layers,rings, arcCount:6+Math.floor(rnd(7)*8), coreRadius:20+rnd(8)*26, wiggle:0.08+rnd(9)*0.12,
               speed:0.25+rnd(10)*0.55, runeCount:28+Math.floor(rnd(11)*16), roseK:(rnd(12)*3+2)|0, starPts:5+(rnd(13)*3|0), seedInt:n };
    }

    function drawFrame(t){
      if (!activeCfg || !ctx) return;
      const CW=W, CH=H, cx=CW/2, cy=CH/2, colors=palettes[currentPaletteIndex];
      const { sym,layers,rings,arcCount,coreRadius,wiggle,speed,runeCount,roseK,starPts,seedInt }=activeCfg;
      const time=animOn? t*0.001*speed : 0;
      ctx.clearRect(0,0,CW,CH); ctx.drawImage(bgCache,0,0,CW,CH); ctx.save(); ctx.translate(cx,cy);
      const rOuter=rings[rings.length-1]+28, rInner=rings[0]-26;
      ctx.fillStyle=ringGradient(ctx,rInner*0.35,rOuter,colors[1],colors[2],.35,.02); ctx.beginPath(); ctx.arc(0,0,rOuter,0,TAU); ctx.fill();
      rings.forEach((r,i)=>{ const rr=r*(1+0.015*Math.sin(time*1.7+i)); ctx.strokeStyle=hexA(colors[0],.9); ctx.lineWidth=2.2;
        ctx.beginPath(); ctx.arc(0,0,rr,0,TAU); ctx.stroke(); ctx.strokeStyle=hexA('#ffffff',.12); ctx.lineWidth=3.5;
        ctx.beginPath(); ctx.arc(0,0,rr,time*0.8,time*0.8+Math.PI*0.35); ctx.stroke(); });
      for(let L=0; L<layers; L++){
        for(let i=0;i<sym;i++){
          const a0=(i/sym)*TAU+L*0.07+time*0.2;
          const a=a0+(fbm(Math.cos(a0)*1.2,Math.sin(a0)*1.2,seedInt+L*13,3,.55)-.5)*wiggle*TAU;
          const r1=Math.max(coreRadius+18,rings[0]-30);
          const r2=rings[Math.min(L,rings.length-1)]-6+16*Math.sin(time+i*0.35);
          ctx.strokeStyle=hexA(colors[1],.85); ctx.lineWidth=1.4+L*0.6;
          ctx.beginPath(); ctx.moveTo(r1*Math.cos(a),r1*Math.sin(a)); ctx.lineTo(r2*Math.cos(a),r2*Math.sin(a)); ctx.stroke();
          ctx.save(); ctx.translate(r2*Math.cos(a), r2*Math.sin(a)); ctx.rotate(a+time*0.4);
          ctx.fillStyle=hexA(colors[2],.85);
          switch((i+L)%4){
            case 0: ctx.fillRect(-7,-7,14,14); break;
            case 1: ctx.beginPath(); ctx.moveTo(0,-9); ctx.lineTo(8,7); ctx.lineTo(-8,7); ctx.closePath(); ctx.fill(); break;
            case 2: ctx.beginPath(); ctx.arc(0,0,8,0,TAU); ctx.fill(); break;
            case 3: ctx.beginPath(); ctx.moveTo(-9,0); ctx.lineTo(0,-9); ctx.lineTo(9,0); ctx.lineTo(0,9); ctx.closePath(); ctx.fill(); break;
          }
          ctx.restore();
        }
      }
      ctx.strokeStyle=hexA(colors[0],.65); ctx.lineWidth=1.6; ctx.beginPath();
      const Rk=rings[Math.floor(rings.length/2)]-18;
      for(let i=0;i<=720;i++){
        const a=(i/720)*TAU*2+time*0.6;
        const [x,y]=rosePoint(roseK,a,Rk);
        const n=(noise2D(Math.cos(a)*1.8,Math.sin(a)*1.8,seedInt)-.5)*10;
        if(i===0) ctx.moveTo(x+n,y+n); else ctx.lineTo(x+n,y+n);
      }
      ctx.stroke();

      ctx.strokeStyle=hexA(colors[0],.55); ctx.lineWidth=2.2;
      for(let i=0;i<arcCount;i++){
        const r=rInner+(i/(arcCount-1))*(rOuter-rInner);
        const start=time*0.4+(i/arcCount)*TAU;
        const len=Math.PI*0.35+Math.sin(time+i)*Math.PI*0.25;
        ctx.beginPath(); ctx.arc(0,0,r,start,start+len); ctx.stroke();
      }

      const RR=rOuter-14, runeSize=10+(CW/1024)*4;
      for(let i=0;i<runeCount;i++){
        const a=(i/runeCount)*TAU+time*0.15;
        const x=RR*Math.cos(a), y=RR*Math.sin(a);
        ctx.save(); ctx.translate(x,y); ctx.rotate(a+Math.PI/2);
        drawRune(ctx,runeSize,seedInt+i*97,hexA(colors[0],.92));
        ctx.restore();
      }

      ctx.save();
      ctx.fillStyle=ringGradient(ctx,0,coreRadius*2.2,colors[2],colors[1],.9,.15);
      ctx.beginPath(); starPath(ctx,5,coreRadius*1.25,coreRadius*0.55); ctx.fill();
      ctx.globalCompositeOperation='lighter';
      ctx.fillStyle=hexA(colors[1],.85);
      ctx.beginPath(); ctx.arc(0,0,coreRadius*(1+0.08*Math.sin(time*2.2)),0,TAU); ctx.fill();
      ctx.globalCompositeOperation='source-over';
      ctx.strokeStyle=hexA(colors[2],.8); ctx.lineWidth=1.6;
      ctx.beginPath(); ctx.moveTo(-coreRadius-14,0); ctx.lineTo(coreRadius+14,0);
      ctx.moveTo(0,-coreRadius-14); ctx.lineTo(0,coreRadius+14); ctx.stroke();
      ctx.restore();

      ctx.globalCompositeOperation='screen';
      ctx.strokeStyle=hexA(colors[0],.08); ctx.lineWidth=22;
      ctx.beginPath(); ctx.arc(0,0,rOuter+12,0,TAU); ctx.stroke();
      ctx.globalCompositeOperation='source-over';

      ctx.restore();
      if (animOn) animReq = requestAnimationFrame(drawFrame);
    }

    function toggleAnimation(){
      animOn = !animOn;
      const label = animOn ? "⏸ Pause" : "▶ Animate";
      if (toggleAnimBtn) toggleAnimBtn.textContent = label;
      if (toggleAnimBtnFooter) toggleAnimBtnFooter.textContent = label;
      cancelAnimationFrame(animReq);
      animOn ? (animReq = requestAnimationFrame(drawFrame)) : drawFrame(0);
    }
    window.toggleAnimation = toggleAnimation;

    function renderSigil(seed, paletteIndex=0){
      if (!sigilCanvas || !ctx) return;
      const colors = palettes[paletteIndex];
      if (paletteDot) paletteDot.style.background = colors[0];
      makeBackground(colors);
      activeSeed = seed;
      activeCfg = buildSigilConfig(seed);
      if (sigilMeta) sigilMeta.textContent = `seed: ${seed.slice(0,10)}… • sym:${activeCfg.sym} • palette:#${paletteIndex+1}`;
      cancelAnimationFrame(animReq);
      animOn ? (animReq = requestAnimationFrame(drawFrame)) : drawFrame(0);
    }

    async function openSigilSmithy(){
      if (!modalBackdrop) return;
      const acct = await getActiveAccount?.();
      walletRawAddress = acct || null;
      if (seedInput && !seedInput.value) seedInput.value = acct || randomSeed();
      modalBackdrop.classList.add('show');
      animOn = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      resizeSigilCanvas();
      renderSigil(getEffectiveSeed(), currentPaletteIndex);
    }
    function closeSigilSmithy(){
      if (!modalBackdrop) return;
      modalBackdrop.classList.remove('show');
      saveSigilState();
      animOn = false;
      cancelAnimationFrame(animReq); animReq = null;
    }
    window.openSigilSmithy = openSigilSmithy;

    // ================== 🌬️ Breathe Sanctuary ==================
    function setupBreathe(){
      const backdrop = document.getElementById('breatheModalBackdrop');
      const closeBtn = document.getElementById('closeBreatheBtn');
      const startBtn = document.getElementById('startBreatheBtn');
      const pauseBtn = document.getElementById('pauseBreatheBtn');
      const resetBtn = document.getElementById('resetBreatheBtn');
      const patternSel = document.getElementById('patternSelect');
      const minutesInput = document.getElementById('minutesInput');
      const soundToggle = document.getElementById('soundToggle');
      const sphere = document.getElementById('breatheSphere');
      const ring = document.getElementById('breatheRing');
      const phaseEl = document.getElementById('breathePhase');
      const timerEl = document.getElementById('breatheTimer');
      const metaEl = document.getElementById('breatheMeta');

      if (!backdrop) return;

      let running = false, paused = false, raf = 0;
      let sessionMs = 5*60*1000, startTime=0, elapsed=0;
      let pattern = 'box';
      let phaseIdx = 0, phaseName = 'Ready', phaseStart=0, phaseDur=0;

      const ding = new Audio();
      ding.src = 'data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQA='; // silent stub (safe)
      const playChime = ()=>{ if (soundToggle.value === 'on'){ try{ ding.currentTime=0; ding.play(); }catch{} } };

      const PATTERNS = {
        box:        [{n:'Inhale',s:4},{n:'Hold',s:4},{n:'Exhale',s:4},{n:'Hold',s:4}],
        "478":      [{n:'Inhale',s:4},{n:'Hold',s:7},{n:'Exhale',s:8}],
        coherence:  [{n:'Inhale',s:5},{n:'Exhale',s:5}],
      };

      function fmt(ms){ const t=Math.max(0, Math.ceil((sessionMs - ms)/1000)); const m = Math.floor(t/60); const s = t%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

      function nextPhase(now){
        const seq = PATTERNS[pattern];
        phaseIdx = (phaseIdx + 1) % seq.length;
        const p = seq[phaseIdx];
        phaseName = p.n;
        phaseDur = p.s * 1000;
        phaseStart = now;
        phaseEl.textContent = p.n;
        playChime();
      }

      function setPhase(idx, now){
        const seq = PATTERNS[pattern];
        phaseIdx = idx % seq.length;
        const p = seq[phaseIdx];
        phaseName = p.n;
        phaseDur = p.s * 1000;
        phaseStart = now;
        phaseEl.textContent = p.n;
      }

      function progressRing(frac){ // 0..1
        const deg = Math.floor(frac*360);
        ring.style.background = `conic-gradient(var(--gold-primary) ${deg}deg, rgba(255,255,255,.08) ${deg}deg)`;
      }

      function sphereScaleForPhase(name, frac){
        // inhale: scale up 0.9->1.08, exhale: scale down 1.08->0.9, holds keep steady
        const baseIn = 0.90, baseOut = 1.08;
        let scale = 1;
        if (name === 'Inhale') scale = baseIn + (baseOut-baseIn)*frac;
        else if (name === 'Exhale') scale = baseOut - (baseOut-baseIn)*frac;
        else scale = (name === 'Hold') ? 1.02 : 1.00;
        sphere.style.transform = `scale(${scale})`;
      }

      function updateMeta(){
        metaEl.textContent = `Pattern: ${pattern === 'box' ? 'Box' : pattern === '478' ? '4-7-8' : 'Coherence'} • ${Math.round(sessionMs/60000)} min`;
      }

      function loop(now){
        if (!running) return;
        if (!startTime) startTime = now - elapsed;
        const t = now - startTime;
        elapsed = t;
        timerEl.textContent = fmt(t);

        if (t >= sessionMs){ stop(); return; }

        const dt = now - phaseStart;
        const frac = Math.min(1, dt / phaseDur);
        progressRing((t % 1000) / 1000); // subtle moving ring
        sphereScaleForPhase(phaseName, frac);

        if (dt >= phaseDur){ nextPhase(now); }
        raf = requestAnimationFrame(loop);
      }

      function start(){
        if (running && paused){ // resume
          paused = false; running = true;
          requestAnimationFrame(loop);
          return;
        }
        // new session
        pattern = patternSel.value === '478' ? '478' : patternSel.value;
        sessionMs = Math.min(60, Math.max(1, Number(minutesInput.value)||5)) * 60 * 1000;
        startTime = 0; elapsed = 0;
        setPhase(-1, performance.now()); // prepare to start at first phase on next tick
        nextPhase(performance.now());
        updateMeta();
        running = true; paused = false;
        requestAnimationFrame(loop);
      }
      function pause(){ if (!running) return; paused = true; running = false; cancelAnimationFrame(raf); }
      function stop(){ running = false; paused = false; cancelAnimationFrame(raf); timerEl.textContent = "00:00"; phaseEl.textContent = "Complete"; sphere.style.transform = "scale(1)"; }
      function reset(){ pause(); elapsed=0; timerEl.textContent="00:00"; phaseEl.textContent="Ready"; ring.style.background='conic-gradient(var(--gold-primary) 0deg, rgba(255,255,255,.08) 0deg)'; sphere.style.transform='scale(1)'; }

      function open(){ backdrop.classList.add('show'); reset(); updateMeta(); }
      function close(){ pause(); backdrop.classList.remove('show'); }

      // bindings
      document.getElementById('openBreatheSanctuary')?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      startBtn?.addEventListener('click', start);
      pauseBtn?.addEventListener('click', ()=> paused ? start() : pause());
      resetBtn?.addEventListener('click', reset);
      backdrop?.addEventListener('click', (e)=>{ if (e.target === backdrop) close(); });

      // expose
      window.openBreatheSanctuary = open;
    }

    // ================== Expose ==================
    window.interactWithRelic   = interactWithRelic;
    window.openAcademy         = openAcademy;
    window.openStaking         = openStaking;
    window.launchOracle        = launchOracle;

  </script>
</body>
</html>
