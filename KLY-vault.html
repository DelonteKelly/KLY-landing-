<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THE VAULT | KLY</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold-primary: #FFD700;
      --gold-secondary: #D4AF37;
      --gold-dark: #996515;
      --gold-darker: #5a4a1f;
      --platinum-light: #E5E4E2;
      --platinum-dark: #B4B4B4;
      --bg-dark: #0A0A0A;
      --bg-darker: #050505;
      --bg-light: #1A1A1A;
      --success: #28A745;
      --warning: #FFC107;
      --error: #DC3545;
      --text-muted: #888;
      --text-light: #F8F9FA;
      --text-gold: linear-gradient(135deg, #FFD700, #D4AF37);
    }

    body {
      margin: 0;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(153, 101, 21, 0.1) 0%, transparent 30%),
        radial-gradient(circle at 80% 70%, rgba(153, 101, 21, 0.1) 0%, transparent 30%),
        linear-gradient(to bottom, var(--bg-darker), var(--bg-dark));
      font-family: 'Montserrat', sans-serif;
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
    }

    .vault-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 2rem auto;
      perspective: 1000px;
    }

    .vault-content {
      width: 100%;
      padding: 3rem;
      background: 
        linear-gradient(145deg, rgba(17, 17, 17, 0.9), rgba(26, 26, 26, 0.9)),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="%23996515" stroke-width="0.5" opacity="0.3"/></svg>');
      border-radius: 20px;
      border: 1px solid rgba(153, 101, 21, 0.3);
      box-shadow: 
        0 0 30px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 215, 0, 0.1),
        0 0 20px rgba(255, 215, 0, 0.2) inset;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
      transition: transform 0.5s ease;
      backdrop-filter: blur(5px);
    }

    .vault-content:hover {
      transform: rotateY(1deg) rotateX(1deg);
    }

    .vault-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at center, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
        linear-gradient(135deg, transparent 45%, rgba(255, 215, 0, 0.03) 50%, transparent 55%);
      animation: rotateGlow 60s linear infinite;
      pointer-events: none;
    }

    .vault-content::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
      z-index: 2;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
      margin-top: 0;
      background: var(--text-gold);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 10px rgba(153, 101, 21, 0.3);
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      letter-spacing: 1px;
      position: relative;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold-dark), transparent);
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    h3 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    p {
      margin: 0.5rem 0;
      line-height: 1.6;
      font-weight: 300;
    }

    .wallet-info {
      background: rgba(10, 10, 10, 0.7);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      border-left: 3px solid var(--gold-dark);
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .wallet-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.03), transparent);
      pointer-events: none;
    }

    .wallet-info p {
      display: flex;
      justify-content: space-between;
      margin: 1rem 0;
      font-size: 0.95rem;
    }

    .wallet-info span:first-child {
      color: var(--platinum-light);
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    .wallet-info span:last-child {
      font-family: 'Montserrat', monospace;
      color: var(--gold-primary);
    }

    hr {
      border: none;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold-dark), transparent);
      margin: 2rem 0;
      position: relative;
    }

    hr::after {
      content: '✦';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-dark);
      padding: 0 1rem;
      color: var(--gold-primary);
      font-size: 1.2rem;
    }

    input {
      width: 100%;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--gold-darker);
      margin-bottom: 1.5rem;
      font-size: 1rem;
      background: rgba(10, 10, 10, 0.7);
      color: var(--text-light);
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    input:focus {
      outline: none;
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
    }

    input::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    .input-group {
      position: relative;
      margin-bottom: 2rem;
    }

    .input-group label {
      position: absolute;
      top: -10px;
      left: 15px;
      background: var(--bg-dark);
      padding: 0 10px;
      font-size: 0.85rem;
      color: var(--gold-secondary);
      font-weight: 500;
      letter-spacing: 0.5px;
      z-index: 1;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    button {
      padding: 16px 24px;
      font-weight: 600;
      font-size: 1rem;
      color: #000;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-family: 'Montserrat', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
      letter-spacing: 0.5px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: all 0.5s ease;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
    }

    button:hover::before {
      left: 100%;
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button:disabled::before {
      display: none;
    }

    #stakeButton {
      grid-column: span 2;
      font-size: 1.1rem;
      padding: 18px;
    }

    .dashboard-box {
      background: rgba(10, 10, 10, 0.7);
      padding: 2rem;
      border: 1px solid var(--gold-dark);
      border-radius: 15px;
      margin-top: 2.5rem;
      position: relative;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .dashboard-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
    }

    .dashboard-row {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255, 215, 0, 0.1);
      align-items: center;
    }

    .dashboard-row:last-child {
      border-bottom: none;
    }

    .dashboard-label {
      color: var(--platinum-light);
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    .dashboard-value {
      font-weight: 600;
      color: var(--gold-primary);
      font-family: 'Montserrat', monospace;
    }

    .status {
      padding: 1.2rem;
      border-radius: 10px;
      margin: 1.5rem 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
    }

    .status-processing {
      background-color: rgba(255, 193, 7, 0.1);
      border-left: 3px solid var(--warning);
      color: var(--warning);
    }

    .status-success {
      background-color: rgba(40, 167, 69, 0.1);
      border-left: 3px solid var(--success);
      color: var(--success);
    }

    .status-error {
      background-color: rgba(220, 53, 69, 0.1);
      border-left: 3px solid var(--error);
      color: var(--error);
    }

    /* Animations */
    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes vaultGlow {
      0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
      100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    .kly-coin {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: radial-gradient(circle, var(--gold-primary), var(--gold-dark));
      border-radius: 50%;
      box-shadow: 0 0 25px var(--gold-primary);
      animation: vaultGlow 1s ease-out forwards;
      z-index: 9999;
    }

    .pulse-effect {
      animation: pulse 2s infinite;
    }

    .float-effect {
      animation: float 4s ease-in-out infinite;
    }

    /* Connect Wallet Button */
    .connect-container {
      text-align: center;
      margin: 2rem 0 3rem;
      position: relative;
      z-index: 1;
    }

    #connectWallet {
      padding: 16px 32px;
      font-weight: 600;
      font-size: 1.1rem;
      color: #000;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #connectWallet:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
    }

    /* Max button */
    .input-with-button {
      position: relative;
    }

    #maxButton {
      position: absolute;
      right: 10px;
      top: 10px;
      padding: 8px 16px;
      font-size: 0.85rem;
      background: rgba(255, 215, 0, 0.2);
      color: var(--gold-primary);
      border: 1px solid var(--gold-dark);
      border-radius: 8px;
      font-weight: 600;
    }

    #maxButton:hover {
      background: rgba(255, 215, 0, 0.3);
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin-top: 1.5rem;
      color: var(--platinum-light);
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 250px;
      background-color: var(--bg-darker);
      color: var(--platinum-light);
      text-align: center;
      border-radius: 10px;
      padding: 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid var(--gold-dark);
      font-size: 0.85rem;
      line-height: 1.5;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      font-weight: 300;
    }

    .tooltip .tooltiptext::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--gold-dark) transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Vault Door Effect */
    .vault-door {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    .vault-door.active {
      opacity: 1;
      pointer-events: all;
    }

    .vault-wheel {
      width: 150px;
      height: 150px;
      border: 10px solid var(--gold-dark);
      border-radius: 50%;
      position: relative;
      margin-bottom: 2rem;
      animation: spin 10s linear infinite;
    }

    .vault-wheel::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      background: var(--gold-primary);
      border-radius: 50%;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .vault-content {
        padding: 2rem;
      }
      
      .button-group {
        grid-template-columns: 1fr;
      }
      
      #stakeButton {
        grid-column: span 1;
      }

      h1 {
        font-size: 2.2rem;
      }

      .dashboard-box {
        padding: 1.5rem;
      }
    }

    /* Loading spinner */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Luxury badge */
    .luxury-badge {
      position: absolute;
      top: -15px;
      right: 30px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
      color: #000;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      z-index: 2;
    }
  </style>
</head>
<body>
  <div class="connect-container">
    <button id="connectWallet" class="pulse-effect float-effect">
      🔐 Connect Exclusive Wallet
    </button>
  </div>

  <div class="vault-container">
    <div class="luxury-badge">Platinum Tier</div>
    <div class="vault-content">
      <h1>✦ THE KLY VAULT ✦</h1>
      
      <div class="wallet-info">
        <p><span>Connected Wallet:</span> <span id="walletAddress">-</span></p>
        <p><span>Network:</span> <span id="networkName">-</span></p>
        <p><span>Chain ID:</span> <span id="chainId">-</span></p>
      </div>

      <hr>

      <h2>✦ Stake KLY Tokens</h2>
      <div class="input-group">
        <label for="stakeAmount">Amount to Stake</label>
        <div class="input-with-button">
          <input id="stakeAmount" placeholder="Enter KLY amount" type="number" />
          <button id="maxButton">MAX</button>
        </div>
      </div>
      
      <div class="button-group">
        <button id="stakeButton" disabled>
          <span>Stake</span>
        </button>
        <button id="withdrawButton" disabled>
          <span>Withdraw</span>
        </button>
        <button id="claimButton" disabled>
          <span>Claim Rewards</span>
        </button>
      </div>

      <div id="status" class="status" style="display: none;"></div>

      <div class="dashboard-box">
        <h3>✦ Staking Dashboard</h3>
        <div class="dashboard-row">
          <span class="dashboard-label">KLY Balance:</span>
          <span id="userKLY" class="dashboard-value">-</span>
        </div>
        <div class="dashboard-row">
          <span class="dashboard-label">Staked Amount:</span>
          <span id="userStaked" class="dashboard-value">-</span>
        </div>
        <div class="dashboard-row">
          <span class="dashboard-label">Pending Rewards:</span>
          <span id="userRewards" class="dashboard-value">-</span>
        </div>
        <div class="dashboard-row">
          <span class="dashboard-label">Estimated APY:</span>
          <span id="apyValue" class="dashboard-value">18.5%</span>
        </div>
      </div>

      <div class="tooltip">
        ℹ️ Exclusive Staking Information
        <span class="tooltiptext">
          The KLY Vault offers premium staking rewards for our most valued members.
          Minimum stake: 100 KLY. Rewards are calculated hourly and compounded automatically.
          Platinum tier members enjoy priority access and enhanced rewards.
        </span>
      </div>
    </div>
  </div>

  <div class="vault-door" id="vaultDoor">
    <div class="vault-wheel"></div>
    <h2 style="color: var(--gold-primary);">ACCESSING THE VAULT</h2>
    <p style="color: var(--platinum-light);">Authenticating your credentials...</p>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm";

    const TOKEN_CONTRACT_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
    const STAKE_CONTRACT_ADDRESS = "0x7bBa73C25cf5384b58DBA280eCB49c9749437823";

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function allowance(address owner, address spender) public view returns (uint256)",
      "function balanceOf(address owner) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function symbol() public view returns (string)"
    ];

    const STAKING_ABI = [
      "function stake(uint256 _amount) payable",
      "function claim()",
      "function withdraw()",
      "function getStakedAmount(address _user) external view returns (uint256)",
      "function getPendingRewards(address _user) external view returns (uint256)"
    ];

    let provider, signer, walletAddress, tokenContract, stakingContract;
    let tokenDecimals = 18;
    let tokenSymbol = "KLY";

    // Format number with commas and optional decimals
    function formatNumber(num, decimals = 4) {
      return parseFloat(num).toLocaleString(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: decimals
      });
    }

    // Show vault door animation
    function showVaultDoor(show) {
      const vaultDoor = document.getElementById('vaultDoor');
      if (show) {
        vaultDoor.classList.add('active');
      } else {
        vaultDoor.classList.remove('active');
      }
    }

    // Create coin animation
    function createCoinAnimation() {
      const coin = document.createElement("div");
      coin.className = "kly-coin";
      document.body.appendChild(coin);
      
      setTimeout(() => {
        coin.remove();
      }, 1000);
    }

    // Show status message
    function showStatus(message, type) {
      const status = document.getElementById("status");
      status.style.display = "flex";
      status.className = `status-${type}`;
      status.innerHTML = `<span>${message}</span>`;
      
      if (type === "success") {
        setTimeout(() => {
          status.style.display = "none";
        }, 5000);
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        showStatus("Please install MetaMask to access the vault", "error");
        return;
      }

      try {
        showVaultDoor(true);
        
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();

        // Initialize contracts
        tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, ERC20_ABI, signer);
        stakingContract = new ethers.Contract(STAKE_CONTRACT_ADDRESS, STAKING_ABI, signer);

        // Get token details
        tokenSymbol = await tokenContract.symbol();
        tokenDecimals = await tokenContract.decimals();

        // Update UI
        document.getElementById("walletAddress").textContent = 
          `${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
        
        // Get network info
        const network = await provider.getNetwork();
        document.getElementById("networkName").textContent = network.name.charAt(0).toUpperCase() + network.name.slice(1);
        document.getElementById("chainId").textContent = network.chainId;

        // Enable buttons
        document.getElementById("stakeButton").disabled = false;
        document.getElementById("withdrawButton").disabled = false;
        document.getElementById("claimButton").disabled = false;
        
        // Update connect button
        document.getElementById("connectWallet").innerHTML = 
          `✔️ ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
        document.getElementById("connectWallet").classList.remove("pulse-effect");
        
        // Load user data
        await loadUserData();
        
        // Set up event listeners
        setupEventListeners();
        
        showStatus("✓ Wallet authenticated successfully", "success");
        setTimeout(() => showVaultDoor(false), 1500);
        
      } catch (err) {
        console.error("Vault access error:", err);
        showStatus("✗ Failed to authenticate wallet", "error");
        showVaultDoor(false);
      }
    }

    async function loadUserData() {
      try {
        showVaultDoor(true);
        
        // Get token balance
        const balance = await tokenContract.balanceOf(walletAddress);
        const balanceFormatted = ethers.utils.formatUnits(balance, tokenDecimals);
        document.getElementById("userKLY").textContent = formatNumber(balanceFormatted);
        
        // Get staked amount
        const stakedAmount = await stakingContract.getStakedAmount(walletAddress);
        const stakedFormatted = ethers.utils.formatUnits(stakedAmount, tokenDecimals);
        document.getElementById("userStaked").textContent = formatNumber(stakedFormatted);
        
        // Get pending rewards
        const pendingRewards = await stakingContract.getPendingRewards(walletAddress);
        const rewardsFormatted = ethers.utils.formatUnits(pendingRewards, tokenDecimals);
        document.getElementById("userRewards").textContent = formatNumber(rewardsFormatted);
        
        showVaultDoor(false);
      } catch (err) {
        console.error("Error loading vault data:", err);
        showStatus("✗ Failed to load vault data", "error");
        showVaultDoor(false);
      }
    }

    async function stakeKLY() {
      const amount = document.getElementById("stakeAmount").value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        showStatus("✗ Please enter a valid amount to stake", "error");
        return;
      }

      showStatus("⚙️ Processing stake request...", "processing");
      showVaultDoor(true);

      try {
        const parsedAmount = ethers.utils.parseUnits(amount, tokenDecimals);
        
        // Check allowance
        const allowance = await tokenContract.allowance(walletAddress, STAKE_CONTRACT_ADDRESS);
        if (allowance.lt(parsedAmount)) {
          showStatus("⚙️ Approving token transfer...", "processing");
          const approveTx = await tokenContract.approve(STAKE_CONTRACT_ADDRESS, parsedAmount);
          await approveTx.wait();
        }

        showStatus("⚙️ Executing stake transaction...", "processing");
        const stakeTx = await stakingContract.stake(parsedAmount);
        await stakeTx.wait();
        
        showStatus(`✓ Successfully staked ${formatNumber(amount)} ${tokenSymbol}`, "success");
        createCoinAnimation();
        await loadUserData();
        
      } catch (err) {
        console.error("Staking error:", err);
        showStatus("✗ Failed to execute stake", "error");
      } finally {
        showVaultDoor(false);
      }
    }

    async function claimRewards() {
      showStatus("⚙️ Processing reward claim...", "processing");
      showVaultDoor(true);
      
      try {
        const claimTx = await stakingContract.claim();
        await claimTx.wait();
        
        showStatus("✓ Rewards claimed successfully", "success");
        createCoinAnimation();
        await loadUserData();
        
      } catch (err) {
        console.error("Claim error:", err);
        showStatus("✗ Failed to claim rewards", "error");
      } finally {
        showVaultDoor(false);
      }
    }

    async function withdrawStake() {
      showStatus("⚙️ Processing withdrawal...", "processing");
      showVaultDoor(true);

      try {
        const withdrawTx = await stakingContract.withdraw();
        await withdrawTx.wait();
        
        showStatus("✓ Stake withdrawn successfully", "success");
        createCoinAnimation();
        await loadUserData();
        
      } catch (err) {
        console.error("Withdraw error:", err);
        showStatus("✗ Failed to withdraw stake", "error");
      } finally {
        showVaultDoor(false);
      }
    }

    function setupEventListeners() {
      // Max button
      document.getElementById("maxButton").addEventListener("click", async () => {
        const balance = await tokenContract.balanceOf(walletAddress);
        const balanceFormatted = ethers.utils.formatUnits(balance, tokenDecimals);
        document.getElementById("stakeAmount").value = parseFloat(balanceFormatted).toFixed(4);
      });
      
      // Network change detection
      window.ethereum.on("chainChanged", (chainId) => {
        window.location.reload();
      });
      
      // Account change detection
      window.ethereum.on("accountsChanged", (accounts) => {
        if (accounts.length === 0) {
          // Wallet disconnected
          window.location.reload();
        } else {
          // Account changed
          walletAddress = accounts[0];
          document.getElementById("walletAddress").textContent = 
            `${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
          document.getElementById("connectWallet").innerHTML = 
            `✔️ ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
          loadUserData();
        }
      });
    }

    // Initialize
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    document.getElementById("stakeButton").addEventListener("click", stakeKLY);
    document.getElementById("claimButton").addEventListener("click", claimRewards);
    document.getElementById("withdrawButton").addEventListener("click", withdrawStake);
  </script>
</body>
</html>
