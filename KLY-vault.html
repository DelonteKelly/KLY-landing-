<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The KLY Vault | Chamber of Secrets</title>
  <meta name="description" content="Unlock the sacred artifacts of the KLY Legacy with your Key of Ascension NFT">
  <meta property="og:title" content="The KLY Vault | Chamber of Secrets">
  <meta property="og:description" content="Unlock the sacred artifacts of the KLY Legacy with your Key of Ascension NFT">
  <meta property="og:image" content="/og-vault.jpg">
  <meta name="theme-color" content="#0a0a0a">

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="icon" type="image/png" href="favicon.png">

  <style>
    :root{
      --gold-primary:#ffd700; --gold-secondary:#c5a042; --gold-dark:#8a6d0b;
      --bg-dark:#0a0a0a; --bg-darker:#050505; --text-light:#f5f5f5; --text-dim:#bdbdbd;
      --accent-glow:0 0 15px rgba(255,215,0,.7); --transition:all .4s cubic-bezier(.165,.84,.44,1)
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{background:var(--bg-dark);color:var(--text-light);font-family:"Montserrat",sans-serif;overflow-x:hidden;position:relative}
    a{cursor:pointer}

    /* Loader */
    .loader{position:fixed;inset:0;background:var(--bg-darker);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .8s ease-out}
    .loader-spinner{width:50px;height:50px;border:5px solid rgba(255,215,0,.3);border-radius:50%;border-top-color:var(--gold-primary);animation:spin 1s ease-in-out infinite;margin-bottom:20px}
    .loader-text{color:var(--gold-primary);font-family:"Cinzel Decorative",serif;letter-spacing:2px;text-transform:uppercase}

    /* Header */
    .vault-header{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:20px 40px;background:rgba(10,10,10,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--gold-secondary);transition:var(--transition)}
    .vault-header.scrolled{background:rgba(5,5,5,.95);box-shadow:0 5px 30px rgba(0,0,0,.5)}
    .vault-logo{font-family:"Cinzel Decorative",serif;font-size:1.8rem;color:var(--gold-primary);text-shadow:var(--accent-glow);letter-spacing:2px;transition:var(--transition)}
    .vault-logo:hover{text-shadow:0 0 20px rgba(255,215,0,.9)}
    .vault-nav{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
    .vault-nav a{color:#cfcfcf;text-decoration:none;font-size:.9rem;transition:var(--transition);position:relative;font-family:"Cinzel Decorative",serif;letter-spacing:1px}
    .vault-nav a:hover{color:var(--gold-primary);text-shadow:0 0 5px var(--gold-primary)}
    .vault-nav a::after{content:"";position:absolute;bottom:-5px;left:0;width:0;height:1px;background:var(--gold-primary);transition:width .3s ease}
    .vault-nav a:hover::after{width:100%}
    #connectWalletBtn{border:1px solid var(--gold-secondary);padding:8px 16px;border-radius:20px;background:transparent;color:var(--text-light);transition:var(--transition);font-family:"Cinzel Decorative",serif;letter-spacing:1px;display:flex;align-items:center;gap:8px}
    #connectWalletBtn:hover{background:rgba(255,215,0,.1);border-color:var(--gold-primary);transform:translateY(-2px)}
    #connectWalletBtn.connected{background:rgba(255,215,0,.1);border-color:var(--gold-primary)}
    #walletAddress{font-size:.85rem;color:var(--gold-primary);font-family:"Montserrat",sans-serif}

    /* Background canvas + particles */
    #threejs-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1;opacity:.5;pointer-events:none}
    .particles{position:fixed;inset:0;z-index:2;pointer-events:none}
    .particle{position:absolute;background:var(--gold-primary);border-radius:50%;opacity:.6;filter:blur(1px)}

    /* Main content */
    .vault-content{position:relative;z-index:5;text-align:center;max-width:1200px;padding:100px 20px;margin:auto}
    .vault-title{font-family:"Cinzel Decorative",serif;font-size:clamp(2.5rem,5vw,4rem);color:var(--gold-primary);margin-bottom:20px;text-shadow:0 0 20px rgba(255,215,0,.5);letter-spacing:3px;position:relative}
    .vault-title::after{content:"";position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);width:100px;height:2px;background:var(--gold-primary)}
    .vault-subtitle{font-size:clamp(1rem,2vw,1.2rem);color:var(--text-dim);margin:40px auto;line-height:1.6;max-width:700px}
    .enhanced-door{position:relative;width:100%;max-width:800px;margin:60px auto;z-index:3;transition:var(--transition);transform:translateY(0);perspective:1000px;will-change:transform}
    .enhanced-door:hover{transform:translateY(-5px)}
    .vault-image{width:100%;border:2px solid var(--gold-secondary);box-shadow:0 0 30px rgba(255,215,0,.3);border-radius:10px;transition:var(--transition)}
    .enhanced-door:hover .vault-image{box-shadow:0 0 40px rgba(255,215,0,.5)}
    .door-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;backdrop-filter:blur(3px);background:rgba(0,0,0,.5);text-align:center;border-radius:8px;transition:var(--transition)}
    .vault-door-title{font-family:"Cinzel Decorative",serif;font-size:clamp(1.5rem,3vw,1.8rem);color:var(--gold-primary);margin-bottom:20px;text-shadow:var(--accent-glow)}
    .unlock-btn{background:transparent;color:var(--gold-primary);border:1px solid var(--gold-secondary);padding:12px 30px;font-family:"Cinzel Decorative",serif;font-size:1.1rem;letter-spacing:1px;border-radius:30px;cursor:pointer;position:relative;overflow:hidden;transition:var(--transition)}
    .unlock-btn:hover{background:rgba(197,160,66,.2);box-shadow:0 0 20px rgba(197,160,66,.4);transform:translateY(-2px)}
    .unlock-btn::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,215,0,.3),transparent);transition:all .8s ease}
    .unlock-btn:hover::before{left:100%}

    /* Vault container & items */
    .vault-container{background:radial-gradient(circle at center,rgba(20,5,40,.9) 0%,rgba(5,0,15,.95) 100%);border:1px solid rgba(255,215,0,.15);border-radius:16px;padding:2rem;box-shadow:0 0 30px rgba(123,31,162,.2);margin-top:2rem}
    .vault-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;perspective:1000px;margin-top:2rem;opacity:0;transform:translateY(20px);transition:var(--transition)}
    .vault-items.visible{opacity:1;transform:translateY(0)}
    .vault-item{position:relative;background:rgba(15,5,30,.7);border:1px solid rgba(197,160,66,.3);border-radius:12px;padding:1.5rem;transition:all .4s cubic-bezier(.175,.885,.32,1.275);cursor:pointer;overflow:hidden;transform-style:preserve-3d;opacity:0;transform:translateY(20px);will-change:transform}
    .vault-item.visible{opacity:1;transform:translateY(0)}
    .vault-item:hover{transform:translateY(-5px) rotateX(5deg);box-shadow:0 10px 25px rgba(123,31,162,.5)}
    .vault-item::before{content:"";position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(to right,transparent,var(--gold-primary),transparent);opacity:0;transition:opacity .3s ease}
    .vault-item:hover::before{opacity:1}
    .knowledge-item  { border-color: rgba(75,0,130,.3) }
    .wealth-item     { border-color: rgba(0,255,127,.3) }
    .oracle-item     { border-color: rgba(138,43,226,.3) }
    .defense-item    { border-color: rgba(220,20,60,.3) }
    .memory-item     { border-color: rgba(100,149,237,.3) }
    .knowledge-item:hover  { border-color: rgba(75,0,130,.7) }
    .wealth-item:hover     { border-color: rgba(0,255,127,.7) }
    .oracle-item:hover     { border-color: rgba(138,43,226,.7) }
    .defense-item:hover    { border-color: rgba(220,20,60,.7) }
    .memory-item:hover     { border-color: rgba(100,149,237,.7) }
    .item-icon{font-size:2.5rem;margin-bottom:1rem;position:relative;display:inline-block;transition:transform .3s ease}
    .icon-aura{position:absolute;inset:-10px;border-radius:50%;opacity:0;transition:opacity .3s ease}
    .knowledge-item  .icon-aura{background:radial-gradient(circle,rgba(75,0,130,.4) 0%,transparent 70%)}
    .wealth-item     .icon-aura{background:radial-gradient(circle,rgba(0,255,127,.4) 0%,transparent 70%)}
    .oracle-item     .icon-aura{background:radial-gradient(circle,rgba(138,43,226,.4) 0%,transparent 70%)}
    .defense-item    .icon-aura{background:radial-gradient(circle,rgba(220,20,60,.4) 0%,transparent 70%)}
    .memory-item     .icon-aura{background:radial-gradient(circle,rgba(100,149,237,.4) 0%,transparent 70%)}
    .vault-item:hover .icon-aura{opacity:.6}
    .vault-item:hover .item-icon{transform:scale(1.1) rotate(5deg)}
    .item-title{font-size:1.4rem;margin-bottom:.8rem;background:linear-gradient(90deg,#fff,#aaa);-webkit-background-clip:text;background-clip:text;color:transparent;font-family:"Cinzel Decorative",serif}
    .item-desc{color:rgba(200,200,220,.85);line-height:1.5;margin-bottom:1.5rem;position:relative;font-size:.95rem}
    .hidden-text{display:block;font-style:italic;color:rgba(255,255,255,.55);margin-bottom:.5rem;opacity:0;height:0;transition:all .3s ease}
    .vault-item:hover .hidden-text{opacity:1;height:auto}
    .blockchain-data{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;font-family:monospace;font-size:.9rem;color:rgba(150,200,255,.8)}
    .live-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;background:#0f0;box-shadow:0 0 5px #0f0;animation:pulse 2s infinite}
    .relic-cta{background:transparent;border:1px solid;color:white;padding:.5rem 1rem;border-radius:20px;cursor:pointer;transition:all .3s ease;font-weight:bold;width:100%;font-family:"Montserrat",sans-serif}
    .knowledge-item .relic-cta{border-color:indigo;color:indigo}
    .wealth-item .relic-cta{border-color:lime;color:lime}
    .oracle-item .relic-cta{border-color:mediumpurple;color:mediumpurple}
    .defense-item .relic-cta{border-color:crimson;color:crimson}
    .memory-item .relic-cta{border-color:cornflowerblue;color:cornflowerblue}
    .relic-cta:hover{background:rgba(255,255,255,.08);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.3)}

    /* Easter egg */
    .hidden-relic{border-color:rgba(255,255,255,.5)!important;animation:glow 3s infinite alternate}
    @keyframes glow{from{box-shadow:0 0 5px rgba(255,255,255,.3)}to{box-shadow:0 0 20px rgba(255,255,255,.7)}}

    /* Status overlay */
    .status-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,.95);color:var(--gold-primary);padding:25px 50px;border:1px solid var(--gold-secondary);font-family:"Cinzel Decorative",serif;z-index:9999;border-radius:10px;text-align:center;box-shadow:0 0 30px rgba(0,0,0,.8);display:flex;flex-direction:column;align-items:center;gap:15px;opacity:0;transition:var(--transition);pointer-events:none}
    .status-overlay.visible{opacity:1}
    .status-icon{font-size:2rem}
    .status-text{font-size:1.1rem;letter-spacing:1px}
    .progress-bar{width:100%;height:3px;background:rgba(255,215,0,.2);border-radius:3px;overflow:hidden;margin-top:15px}
    .progress-fill{height:100%;background:linear-gradient(to right,var(--gold-dark),var(--gold-primary));width:0;transition:width .3s ease}

    /* Footer */
    .vault-footer{position:relative;z-index:10;text-align:center;padding:50px 30px;margin-top:50px;color:#c7c7c7;font-size:.85rem;border-top:1px solid rgba(197,160,66,.1)}

    /* Animations */
    @keyframes doorOpen{0%{transform:scale(1);opacity:1}100%{transform:scale(.8) rotateY(90deg);opacity:0}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}100%{opacity:.7;transform:scale(1)}}

    /* Responsive */
    @media (max-width:768px){
      .vault-header{flex-direction:column;padding:15px}
      .vault-logo{margin-bottom:10px}
      .vault-content{padding:80px 20px}
      .enhanced-door{margin:30px auto}
      .vault-container{padding:1rem}
      .vault-items{grid-template-columns:1fr}
    }
    @media (max-width:480px){
      .vault-title{font-size:2rem}
      .unlock-btn{padding:10px 20px;font-size:1rem}
      .status-overlay{width:90%;padding:20px}
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .loader-spinner{animation:none}
      #threejs-canvas,.particles{display:none}
      .vault-item,.enhanced-door{transition:none}
    }

    .hidden{display:none!important}

    /* ===== Sigil Smithy modal ===== */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:10000
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(920px,92vw);background:rgba(15,5,30,.95);border:1px solid rgba(197,160,66,.3);
      border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(197,160,66,.2)
    }
    .modal-title{font-family:"Cinzel Decorative",serif;font-size:1.2rem;color:var(--gold-primary);letter-spacing:1px}
    .modal-body{display:flex;gap:18px;flex-wrap:wrap;padding:16px}
    .sigil-canvas-wrap{
      flex:2;min-width:300px;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(255,255,255,.04), transparent 70%);
      border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:10px
    }
    #sigilCanvas{width:100%;height:auto;max-height:60vh;border-radius:10px;background:#0b0b13}
    .control-panel{
      flex:1;min-width:260px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px
    }
    .control-panel label{font-size:.85rem;color:#e5e5e5;margin-bottom:4px}
    .control-panel input[type="text"]{
      width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(20,20,30,.6);color:#fff;font-family:monospace
    }
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      padding:8px 10px;border-radius:10px;border:1px solid rgba(197,160,66,.4);background:transparent;color:#f6f6f6;cursor:pointer;transition:.25s;
      font-weight:600
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .btn.primary{border-color:var(--gold-primary);color:var(--gold-primary)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;font-size:.8rem;color:#ddd
    }
    .color-dot{width:14px;height:14px;border-radius:50%}
    .modal-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid rgba(197,160,66,.2)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#111;border:1px solid #333;border-bottom-width:2px;color:#eee;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div class="loader" id="pageLoader">
    <div class="loader-spinner" aria-hidden="true"></div>
    <div class="loader-text">Entering the Vault...</div>
  </div>

  <header class="vault-header" id="mainHeader">
    <div class="vault-logo">THE KLY VAULT</div>
    <nav class="vault-nav" aria-label="Primary">
      <a href="/portal.html">Portal</a>
      <a href="/kly-academy.html">Academy</a>
      <a href="/oracle.html">Oracle</a>
      <a href="status_correction.html">Status Correction</a>
      <button id="connectWalletBtn" aria-label="Connect wallet">
        <i class="fas fa-wallet" aria-hidden="true"></i><span>Connect Wallet</span>
      </button>
      <span id="walletAddress" class="hidden" aria-live="polite"></span>
    </nav>
  </header>

  <canvas id="threejs-canvas"></canvas>
  <div class="particles" id="particles" aria-hidden="true"></div>

  <main class="vault-content" id="main" role="main" aria-describedby="pageTagline">
    <h1 class="vault-title">CHAMBER OF SECRETS</h1>
    <p id="pageTagline" class="vault-subtitle">WHAT IS SOUGHT<br>IS FOUND WITHIN</p>

    <div class="enhanced-door">
      <img src="vault-door.png" alt="Ancient Vault Door with intricate carvings" class="vault-image">
      <div class="door-overlay">
        <h2 class="vault-door-title">Key of Ascension Required</h2>
        <button class="unlock-btn" id="unlockBtn" aria-label="Enter the vault after verification">
          <i class="fas fa-key" aria-hidden="true"></i> Enter the Vault
        </button>
      </div>
    </div>

    <div class="vault-container">
      <div class="vault-items" id="vaultItems">
        <!-- Academy Library -->
        <article class="vault-item knowledge-item" onclick="interactWithRelic(this, 'academy')">
          <div class="item-icon" aria-hidden="true">📚<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Academy Library</h3>
          <p class="item-desc">
            <span class="hidden-text">Sift the signal from the noise.</span>
            Premium lessons, meditations, and exercises curated for Initiates. New drops weekly.
          </p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Access: <code>Key of Ascension</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openAcademy()" aria-label="Enter Academy">Enter Academy</button>
        </article>

        <!-- Staking & Rewards -->
        <article class="vault-item wealth-item" onclick="interactWithRelic(this, 'staking')">
          <div class="item-icon" aria-hidden="true">💠<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Staking & Rewards</h3>
          <p class="item-desc"><span class="hidden-text">Let your KLY do the work.</span>Stake KLY to accrue rewards and unlock seasonal Vault perks & allowlists.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Network: <code>BSC</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openStaking()" aria-label="Open Staking">Open Staking</button>
        </article>

        <!-- Altar of Flames -->
        <article class="vault-item wealth-item altar-item" onclick="interactWithRelic(this, 'altar')">
          <div class="item-icon" aria-hidden="true">🔥<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Altar of Flames</h3>
          <p class="item-desc"><span class="hidden-text">Offer what no longer serves; receive what endures.</span>Burn your $KLY to unlock hidden boons, seasonal allowlists, or relic drops.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Action: <code>Burn $KLY → Perks</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openAltarModal()" aria-label="Open Altar">Make Offering</button>
        </article>

        <!-- Oracle Readings -->
        <article class="vault-item oracle-item" onclick="interactWithRelic(this, 'oracle')">
          <div class="item-icon" aria-hidden="true">🔮<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Oracle Readings</h3>
          <p class="item-desc"><span class="hidden-text">When the path is unclear, ask.</span>Personalized AI-guided spreads seeded with on-chain signals and lunar cycles.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Status: <code>Live</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); launchOracle()" aria-label="Ask the Oracle">Ask the Oracle</button>
        </article>

        <!-- Security Center -->
        <article class="vault-item defense-item" onclick="interactWithRelic(this, 'security')">
          <div class="item-icon" aria-hidden="true">🛡️<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Security Center</h3>
          <p class="item-desc"><span class="hidden-text">Armor first. Adventure second.</span>Run wallet health checks, revoke risky approvals, and enable session guards.</p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Tools: <code>Approvals • Phishing</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openSecurityCheck()" aria-label="Run security check">Run Checkup</button>
        </article>

        <!-- 🔮 NEW: Sigil Smithy (replaces Lore) -->
        <article class="vault-item memory-item" onclick="interactWithRelic(this, 'sigil')">
          <div class="item-icon" aria-hidden="true">🧿<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">Sigil Smithy</h3>
          <p class="item-desc">
            <span class="hidden-text">Forge the mark of your lineage.</span>
            Generate a unique crest from your wallet entropy or a custom seed. Save it as a high-res PNG.
          </p>
          <div class="blockchain-data"><span class="live-indicator" aria-hidden="true"></span><span>Mode: <code>Generative</code></span></div>
          <button class="relic-cta" onclick="event.stopPropagation(); openSigilSmithy()" aria-label="Open Sigil Smithy">Open Sigil Smithy</button>
        </article>

        <!-- Hidden Relic -->
        <article class="vault-item hidden-relic" id="thirdEyeRelic" style="display:none;">
          <div class="item-icon" aria-hidden="true">👁️<div class="icon-aura" aria-hidden="true"></div></div>
          <h3 class="item-title">The Third Eye</h3>
          <p class="item-desc">You've proven your dedication. The deepest mysteries await...</p>
          <button class="relic-cta" onclick="initiateAscension()" aria-label="Begin initiation">Begin Initiation</button>
        </article>
      </div>
    </div>
  </main>

  <!-- Status overlay -->
  <div class="status-overlay" id="statusOverlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="status-icon" id="statusIcon" aria-hidden="true">🔍</div>
    <div class="status-text" id="statusText">Verifying access...</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>


  <!-- ===== Sigil Smithy Modal ===== -->
  <div class="modal-backdrop" id="sigilModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sigilModalTitle">
      <div class="modal-header">
        <div class="pill"><span class="color-dot" id="paletteDot" style="background:#ffd700"></span> Active Palette</div>
        <div class="modal-title" id="sigilModalTitle">Sigil Smithy</div>
        <button class="btn" id="closeSigilBtn" aria-label="Close Sigil Smithy">✖</button>
      </div>
      <div class="modal-body">
        <div class="sigil-canvas-wrap">
          <canvas id="sigilCanvas" width="1024" height="1024" aria-label="Generated sigil canvas"></canvas>
        </div>
        <div class="control-panel">
          <div>
            <label for="seedInput">Seed (wallet address or any text)</label>
            <input type="text" id="seedInput" placeholder="auto: your wallet, or type anything…" spellcheck="false">
          </div>
          <div class="btn-row">
            <button class="btn" id="generateBtn">Generate</button>
            <button class="btn" id="shufflePaletteBtn">Shuffle Palette</button>
            <button class="btn" id="randomizeBtn">Randomize</button>
            <button class="btn" id="toggleAnimBtn">⏸ Pause</button>
            <button class="btn" id="copySeedBtn">Copy Seed</button>
            <button class="btn" id="downloadBtn">Download PNG</button>
          </div>
          <div style="opacity:.85;font-size:.85rem;line-height:1.45">
            Tips:
            <ul style="margin:.4rem 0 .2rem 1rem">
              <li>Use your wallet address for a deterministic crest.</li>
              <li>Hit <span class="kbd">Shuffle Palette</span> to keep geometry but recolor.</li>
              <li>Art is rendered at 1024×1024 for clean prints.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span style="color:#c9c9c9">Hash-bound geometry • Symmetry • Noise fields</span>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="pill" id="sigilMeta">—</div>
          <button class="btn" id="toggleAnimBtnFooter">⏸ Pause</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="vault-footer">
    © 2025 Kelly Legacy Estates — Tamaquah Nation • Cycle 42 of the Great Alignment
  </footer>

  <!-- App -->
<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js";

  // ================== Config ==================
  const CONTRACT_ADDRESS = "0xDA76d35742190283E340dbeE2038ecc978a56950";
  const CONTRACT_ABI = [
    { inputs:[{ internalType:"address", name:"owner", type:"address"}], name:"balanceOf",
      outputs:[{ internalType:"uint256", name:"", type:"uint256"}], stateMutability:"view", type:"function" }
  ];
  const BNB_CHAIN_ID = "0x38";

  // ================== DOM ==================
  const walletButton = document.getElementById("connectWalletBtn");
  const walletAddressEl = document.getElementById("walletAddress");
  const unlockBtn = document.getElementById("unlockBtn");
  const vaultItems = document.getElementById("vaultItems");
  const statusOverlay = document.getElementById("statusOverlay");
  const statusIcon = document.getElementById("statusIcon");
  const statusText = document.getElementById("statusText");
  const progressFill = document.getElementById("progressFill");
  const pageLoader = document.getElementById("pageLoader");
  const mainHeader = document.getElementById("mainHeader");
  const particlesContainer = document.getElementById("particles");

  // Sigil Modal DOM
  const modalBackdrop = document.getElementById('sigilModalBackdrop');
  const closeSigilBtn = document.getElementById('closeSigilBtn');
  const seedInput = document.getElementById('seedInput');
  const generateBtn = document.getElementById('generateBtn');
  const shufflePaletteBtn = document.getElementById('shufflePaletteBtn');
  const randomizeBtn = document.getElementById('randomizeBtn');
  const copySeedBtn = document.getElementById('copySeedBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const paletteDot = document.getElementById('paletteDot');
  const sigilMeta = document.getElementById('sigilMeta');
  const sigilCanvas = document.getElementById('sigilCanvas');
  const ctx = sigilCanvas.getContext('2d');
  const toggleAnimBtn = document.getElementById('toggleAnimBtn');
  const toggleAnimBtnFooter = document.getElementById('toggleAnimBtnFooter');

  // ================== Init ==================
  document.addEventListener("DOMContentLoaded", async () => {
    // Loader
    setTimeout(() => {
      pageLoader.style.opacity = "0";
      setTimeout(async () => {
        pageLoader.style.display = "none";
        initScrollHandler();
        createParticles();
        initThreeJS();

        const acct = await getActiveAccount();
        if (acct) updateWalletUI(true, acct);

        walletButton.addEventListener("click", connectWallet);
        unlockBtn.addEventListener("click", verifyNFTAccess);
      }, 800);
    }, 1000);

    // Smithy events
    closeSigilBtn.addEventListener('click', closeSigilSmithy);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeSigilSmithy(); });
    generateBtn.addEventListener('click', () => renderSigil(getEffectiveSeed(), currentPaletteIndex));
    shufflePaletteBtn.addEventListener('click', () => { cyclePalette(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });
    randomizeBtn.addEventListener('click', () => { seedInput.value = randomSeed(); cyclePalette(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });
    copySeedBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(getEffectiveSeed());
      toast('Seed copied', 'success');
    });
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      const fileSeed = getEffectiveSeed().replace(/[^a-zA-Z0-9_-]/g,'').slice(0,32) || 'sigil';
      link.download = `kly-sigil_${fileSeed}.png`;
      link.href = sigilCanvas.toDataURL('image/png');
      link.click();
    });
    seedInput.addEventListener('change', () => { saveSigilState(); renderSigil(getEffectiveSeed(), currentPaletteIndex); });

    // Animation toggle buttons
    toggleAnimBtn.addEventListener('click', toggleAnimation);
    toggleAnimBtnFooter.addEventListener('click', toggleAnimation);

    const saved = JSON.parse(localStorage.getItem('kly_sigil_state') || '{}');
    if (saved.seed) seedInput.value = saved.seed;
    if (Number.isInteger(saved.paletteIndex)) currentPaletteIndex = saved.paletteIndex;
  });

  // ================== Particles ==================
  function createParticles(){
    const particleCount = window.matchMedia("(prefers-reduced-motion: reduce)").matches
      ? 0
      : (window.innerWidth < 768 ? 24 : 48);
    for(let i=0;i<particleCount;i++){
      const p = document.createElement("div");
      p.className = "particle";
      const size = Math.random()*4+1;
      p.style.width = `${size}px`; p.style.height = `${size}px`;
      p.style.left = `${Math.random()*100}%`; p.style.top = `${Math.random()*100}%`;
      p.style.opacity = (Math.random()*0.5 + 0.1).toFixed(2);
      animateParticle(p, Math.random()*15+10, Math.random()*10);
      particlesContainer.appendChild(p);
    }
  }
  function animateParticle(particle, duration, delay){
    let start=null; const initialX=parseFloat(particle.style.left); const initialY=parseFloat(particle.style.top);
    function step(ts){
      if(!start) start=ts;
      const progress=(ts-start)/(duration*1000);
      if(progress<1){
        const newX = initialX + Math.sin(progress*Math.PI*2)*5;
        const newY = initialY - progress*100;
        const opacity = 0.1 + 0.4*(1-progress);
        particle.style.left = `${newX}%`;
        particle.style.top = `${newY}%`;
        particle.style.opacity = opacity;
        if(newY < -5){
          particle.style.top = "105%"; particle.style.left = `${initialX}%`; particle.style.opacity = "0.1"; start = ts - delay*1000;
        }
        requestAnimationFrame(step);
      } else {
        particle.style.top = "105%"; particle.style.left = `${initialX}%`; particle.style.opacity = "0.1"; start = null;
        setTimeout(()=>{ start = performance.now(); requestAnimationFrame(step); }, delay*1000);
      }
    }
    setTimeout(()=>requestAnimationFrame(step), delay*1000);
  }

  // ================== Three.js BG ==================
  function initThreeJS(){
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
    const canvas = document.getElementById("threejs-canvas");
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, .1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);

    const segs = window.innerWidth < 768 ? 96 : 192;
    const radial = window.innerWidth < 768 ? 16 : 32;
    const geometry = new THREE.TorusKnotGeometry(12, 3, segs, radial);
    const material = new THREE.MeshBasicMaterial({ color:0xd4af37, wireframe:true, transparent:true, opacity:.2 });
    const knot = new THREE.Mesh(geometry, material);
    scene.add(knot);

    const glowGeometry = new THREE.SphereGeometry(15, 32, 32);
    const glowMaterial = new THREE.MeshBasicMaterial({ color:0xd4af37, transparent:true, opacity:.05 });
    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
    scene.add(glow);

    camera.position.z = 30;
    function animate(){
      requestAnimationFrame(animate);
      knot.rotation.x += .001; knot.rotation.y += .002;
      glow.rotation.x += .0005; glow.rotation.y += .0005;
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }

  // ================== Header Scroll ==================
  function initScrollHandler(){
    window.addEventListener("scroll", () => {
      if (window.scrollY > 50) mainHeader.classList.add("scrolled");
      else mainHeader.classList.remove("scrolled");
    });
  }

  // ================== Wallet helpers ==================
  async function getActiveAccount(){
    if(!window.ethereum) return null;
    const accounts = await window.ethereum.request({ method:"eth_accounts" });
    return accounts?.[0] ?? null;
  }

  async function connectWallet(){
    try{
      if(!window.ethereum){ showStatus("⚠️ MetaMask not found", "error"); setTimeout(()=>openExternal("https://metamask.io/download.html"), 1200); return; }
      showStatus("🔓 Connecting wallet...", "info");
      const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
      await verifyNetwork();
      updateWalletUI(true, accounts[0]);
      showStatus("✅ Wallet connected", "success");

      window.ethereum.on("accountsChanged", handleAccountsChanged);
      window.ethereum.on("chainChanged", handleChainChanged);
    }catch(err){
      const cancelled = err?.code === 4001;
      showStatus(cancelled ? "🛑 Request cancelled" : "⚠️ Connection failed", cancelled ? "warning" : "error");
      console.error("Wallet connection error:", err);
    }
  }

  async function verifyNetwork(){
    const currentChainId = await window.ethereum.request({ method:"eth_chainId" });
    if (currentChainId !== BNB_CHAIN_ID){
      showStatus("🌐 Switching to BSC...", "info");
      try {
        await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BNB_CHAIN_ID }] });
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method:"wallet_addEthereumChain",
              params:[{
                chainId: BNB_CHAIN_ID,
                chainName: "Binance Smart Chain",
                nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
                rpcUrls: ["https://bsc-dataseed.binance.org/"],
                blockExplorerUrls: ["https://bscscan.com"]
              }]
            });
          } catch (addError) {
            showStatus("⚠️ Please add/switch to BSC", "error"); throw addError;
          }
        } else {
          showStatus("⚠️ Please switch to BSC", "error"); throw switchError;
        }
      }
    }
  }

  function handleAccountsChanged(accounts){
    if (!accounts.length){ updateWalletUI(false); showStatus("⚠️ Wallet disconnected", "warning"); }
    else { updateWalletUI(true, accounts[0]); }
  }
  function handleChainChanged(){ location.reload(); }

  function updateWalletUI(connected, account=""){
    if (connected){
      const short = shortenAddress(account);
      walletButton.innerHTML = `<i class="fas fa-check-circle" aria-hidden="true"></i><span>${short}</span>`;
      walletButton.classList.add("connected");
      walletAddressEl.textContent = short;
      walletAddressEl.classList.remove("hidden");
    } else {
      walletButton.innerHTML = '<i class="fas fa-wallet" aria-hidden="true"></i><span>Connect Wallet</span>';
      walletButton.classList.remove("connected");
      walletAddressEl.classList.add("hidden");
    }
  }
  const shortenAddress = (a) => `${a.substring(0,6)}...${a.substring(a.length-4)}`;

  // ================== Gate: NFT Verify ==================
  async function verifyNFTAccess(){
    if (!window.ethereum){ showStatus("🔑 Connect wallet first", "warning"); return; }
    try{
      const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
      const owner = accounts[0];
      showStatus("🔍 Verifying NFT...", "info"); simulateProgress();
      await verifyNetwork();

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
      const balance = await contract.balanceOf(owner);

      const hasAccess = ethers.BigNumber.isBigNumber(balance) ? balance.gt(0) : Number(balance) > 0;
      if (hasAccess){ showStatus("✅ Access granted!", "success"); unlockVault(); }
      else { showStatus("⛔ Key of Ascension required", "error"); }
    }catch(e){
      const cancelled = e?.code === 4001;
      showStatus(cancelled ? "🛑 Request cancelled" : "⚠️ Verification failed", cancelled ? "warning" : "error");
      console.error("NFT verification error:", e);
    }
  }

  function simulateProgress(){
    let progress = 0;
    const id = setInterval(()=>{
      progress += Math.random()*10;
      progressFill.style.width = `${Math.min(progress,100)}%`;
      if(progress >= 100) clearInterval(id);
    }, 200);
  }

  function unlockVault(){
    const doorOverlay = document.querySelector(".door-overlay");
    doorOverlay.style.animation = "doorOpen 1s forwards";
    setTimeout(() => {
      doorOverlay.style.display = "none";
      vaultItems.classList.add("visible");
      document.querySelectorAll(".vault-item").forEach((item, idx)=>setTimeout(()=>item.classList.add("visible"), idx*100));
      setTimeout(()=>vaultItems.scrollIntoView({ behavior:"smooth", block:"start" }), 300);
    }, 900);
  }

  // ================== Status Overlay ==================
  function showStatus(message, type="info"){
    const iconMap = { success:"✅", error:"❌", warning:"⚠️", info:"🔍" };
    statusIcon.textContent = iconMap[type] || "🔍";
    statusText.textContent = message;
    progressFill.style.width = "0";
    statusOverlay.classList.add("visible");
    if (type !== "error"){
      setTimeout(()=>statusOverlay.classList.remove("visible"), type === "success" ? 1800 : 2600);
    }
  }
  function toast(msg, type="info"){ showStatus(msg, type); }

  // ================== Easter Egg ==================
  let vaultClicks = 0;
  const vaultContainer = document.querySelector(".vault-container");
  if (vaultContainer){
    vaultContainer.addEventListener("click", () => {
      vaultClicks++;
      if (vaultClicks >= 7){
        const egg = document.getElementById("thirdEyeRelic");
        if (egg) egg.style.display = "block";
        try { new Audio("mystical_chime.mp3").play(); } catch {}
      }
    });
  }
  window.initiateAscension = () => toast("✨ Initiation pathway coming soon…", "info");

  // ================== Relic interactions ==================
  function interactWithRelic(el, type){
    el.classList.add("relic-active");
    setTimeout(()=> el.classList.remove("relic-active"), 500);
    try { window.navigator.vibrate?.(10); } catch {}
    try { new Audio("relic_interaction.mp3").play(); } catch {}
    window.dispatchEvent(new CustomEvent("vault:relicClick", { detail:{ type, ts:Date.now() }}));
  }
  const VAULT_ROUTES = { academy:"/kly-academy.html", staking:"/staking.html", oracle:"/oracle.html", security:"https://revoke.cash" };
  const openExternal = (url) => window.open(url, "_blank", "noopener,noreferrer");
  async function openAcademy(){ toast("Entering Academy…", "success"); location.href = VAULT_ROUTES.academy; }
  async function openStaking(){ toast("Opening Staking…", "info"); openExternal(VAULT_ROUTES.staking); }
  async function launchOracle(){ toast("Consulting the Oracle…", "info"); location.href = VAULT_ROUTES.oracle; }
  async function openSecurityCheck(){ toast("Running security tools…", "info"); openExternal(VAULT_ROUTES.security); }

  // Altar placeholders
  let _altarOpen = false;
  function openAltarModal(){ toast("Altar coming soon — burn-to-perk flow in progress.", "warning"); _altarOpen = true; }
  function performBurn(){ toast("Burn simulation — connect final contract when ready.", "info"); }
  function setAltarPercent(pct){ console.log("Altar percent set to", pct); }
  function closeAltarModal(){ _altarOpen = false; }

/* ============== 🔮 Sigil Smithy: Ancient Talisman Upgrade ============== */
/* Helpers: light hash/noise, param shapes, metallic shading, runes */
let currentPaletteIndex = 0;
let walletRawAddress = null;
let animReq = null, animOn = true, activeSeed = '', activeCfg = null;
const TAU = Math.PI * 2;

// fast int hash
function h32(n){ n|=0; n = (n ^ (n>>>16)) * 0x45d9f3b; n = (n ^ (n>>>16)) * 0x45d9f3b; return (n ^ (n>>>16))>>>0; }
// scalar noise (value noise w/ smoothstep)
function noise2D(x, y, seed=0){
  const xi = Math.floor(x), yi = Math.floor(y);
  const xf = x - xi, yf = y - yi;
  const s = (t)=>t*t*(3-2*t);
  function rnd(ix,iy){ return (h32(ix*374761393 ^ iy*668265263 ^ seed) % 10000)/10000; }
  const v00 = rnd(xi,yi), v10 = rnd(xi+1,yi), v01 = rnd(xi,yi+1), v11 = rnd(xi+1,yi+1);
  const x1 = v00 + s(xf)*(v10 - v00);
  const x2 = v01 + s(xf)*(v11 - v01);
  return x1 + s(yf)*(x2 - x1);
}
function fbm(x,y,seed,oct=4,fall=0.5,amp=1, freq=1){
  let v=0, a=amp, f=freq;
  for(let i=0;i<oct;i++){ v+= a*noise2D(x*f, y*f, seed+i*11); a*=fall; f*=2; }
  return v;
}

function polygonPath(ctx, sides, r){
  ctx.moveTo(r,0);
  const step = TAU/sides;
  for(let i=1;i<=sides;i++){
    const a= i*step; ctx.lineTo(r*Math.cos(a), r*Math.sin(a));
  }
}
function starPath(ctx, points, rOuter, rInner){
  const step = TAU/(points*2);
  ctx.moveTo(rOuter,0);
  for(let i=1;i<points*2;i++){
    const r = (i%2===0)? rOuter : rInner;
    const a = i*step;
    ctx.lineTo(r*Math.cos(a), r*Math.sin(a));
  }
  ctx.closePath();
}
function rosePoint(k, a, r){ // rhodonea curve: r = cos(kθ)
  const rad = r*Math.cos(k*a);
  return [rad*Math.cos(a), rad*Math.sin(a)];
}
function ringGradient(ctx, r0, r1, colA, colB, alphaA=.95, alphaB=.1){
  const g = ctx.createRadialGradient(0,0, r0, 0,0, r1);
  g.addColorStop(0, hexA(colA,alphaA));
  g.addColorStop(1, hexA(colB,alphaB));
  return g;
}
function hexA(hex, a){
  // hex like "#ffd700"
  const [r,g,b]=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`;
}
function hexToRgb(hex){
  const n = hex.replace('#','');
  const bigint = parseInt(n.length===3 ? n.split('').map(c=>c+c).join('') : n,16);
  return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
}

/* Minimal rune set (deterministic): 12 simple strokes/marks */
function drawRune(ctx, size, id, color){
  const rnd = id%12;
  ctx.save(); ctx.strokeStyle=color; ctx.lineWidth = Math.max(1, size*0.08); ctx.lineCap='round';
  switch(rnd){
    case 0: ctx.beginPath(); ctx.moveTo(-size,0); ctx.lineTo(size,0); ctx.stroke(); break;                  // — 
    case 1: ctx.beginPath(); ctx.moveTo(0,-size); ctx.lineTo(0,size); ctx.stroke(); break;                  // |
    case 2: ctx.beginPath(); ctx.moveTo(-size,-size); ctx.lineTo(size,size); ctx.stroke(); break;           // \
    case 3: ctx.beginPath(); ctx.moveTo(-size,size); ctx.lineTo(size,-size); ctx.stroke(); break;           // /
    case 4: ctx.beginPath(); polygonPath(ctx, 3, size); ctx.closePath(); ctx.stroke(); break;               // △
    case 5: ctx.beginPath(); polygonPath(ctx, 4, size); ctx.closePath(); ctx.stroke(); break;               // ◻
    case 6: ctx.beginPath(); polygonPath(ctx, 5, size); ctx.closePath(); ctx.stroke(); break;               // ⯃
    case 7: ctx.beginPath(); starPath(ctx, 5, size, size*0.45); ctx.stroke(); break;                        // ✷
    case 8: ctx.beginPath(); ctx.arc(0,0,size,0,TAU); ctx.stroke(); break;                                  // ○
    case 9: ctx.beginPath(); ctx.moveTo(-size,0); ctx.lineTo(0,-size); ctx.lineTo(size,0); ctx.stroke();    // ∧
    case 10: ctx.beginPath(); ctx.moveTo(-size,-size); ctx.lineTo(0,0); ctx.lineTo(size,-size); ctx.stroke(); break; // V cap
    case 11: ctx.beginPath(); ctx.arc(0,0,size,0,Math.PI); ctx.stroke(); break;                             // ⌒
  }
  ctx.restore();
}

/* ===== Background: aged stone + faint lattice ===== */
function makeBackground(colors, rnd){
  const c = bgCtx; c.save();
  const S = 1024;
  c.clearRect(0,0,S,S);

  // vignetted parchment/stone
  const base = c.createLinearGradient(0,0,S,S);
  base.addColorStop(0, hexA(colors[4], .98));
  base.addColorStop(1, hexA(colors[4], .92));
  c.fillStyle = base; c.fillRect(0,0,S,S);

  // soft radial glow
  const glow = c.createRadialGradient(S/2,S/2,80, S/2,S/2, 520);
  glow.addColorStop(0, hexA(colors[3], .15));
  glow.addColorStop(1, 'rgba(0,0,0,.65)');
  c.fillStyle = glow; c.fillRect(0,0,S,S);

  // stone pores (fbm)
  c.globalAlpha=.12;
  for(let y=0;y<S;y+=2){
    for(let x=0;x<S;x+=2){
      const v = fbm(x/240, y/240, h32(1337), 3, 0.6);
      const g = Math.floor(20+v*28);
      c.fillStyle = `rgb(${g},${g},${g})`;
      c.fillRect(x,y,2,2);
    }
  }
  c.globalAlpha=1;

  // lattice lines
  c.strokeStyle = hexA(colors[2], .06); c.lineWidth=1;
  c.beginPath();
  for(let a=0;a<TAU;a+=TAU/36){
    c.moveTo(S/2,S/2);
    c.lineTo(S/2 + 520*Math.cos(a), S/2 + 520*Math.sin(a));
  }
  c.stroke();
  c.restore();
}

/* ===== Parameter config from seed ===== */
function buildSigilConfig(seed){
  const n = hash32(seed);
  const rnd = (i=0)=> (h32(n + i*1013904223) % 10000) / 10000;
  const sym = 8 + Math.floor(rnd(1)*10);     // 8..17
  const layers = 3 + Math.floor(rnd(2)*3);   // 3..5
  const ringCount = 3 + Math.floor(rnd(3)*3);
  const rings = Array.from({length:ringCount}, (_,i)=> 140 + i*60 + Math.floor(rnd(4+i)*30));
  return {
    sym,
    layers,
    rings,
    arcCount: 6 + Math.floor(rnd(7)*8),
    coreRadius: 20 + rnd(8)*26,
    wiggle: 0.08 + rnd(9)*0.12,
    speed: 0.25 + rnd(10)*0.55,
    runeCount: 28 + Math.floor(rnd(11)*16),
    roseK: (rnd(12)*3 + 2)|0,                        // 2..4
    starPts: 5 + (rnd(13)*3|0),                      // 5..7
    seedInt: n
  };
}
function hash32(str){
  let h = 2166136261>>>0;
  for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h>>>0;
}

/* ===== Main renderer ===== */
function drawFrame(t){
  if (!activeCfg) return;

  // logical canvas size (accounting for DPR scaling already applied)
  const CW = sigilCanvas.width;
  const CH = sigilCanvas.height;
  const cx = CW/2, cy = CH/2;

  const colors = palettes[currentPaletteIndex];
  const {
    sym, layers, rings, arcCount, coreRadius,
    wiggle, speed, runeCount, roseK, starPts, seedInt
  } = activeCfg;

  const time = animOn ? t*0.001*speed : 0;

  // background
  ctx.clearRect(0,0,CW,CH);
  ctx.drawImage(bgCache, 0,0, CW,CH);

  ctx.save();
  ctx.translate(cx,cy);

  /* metallic disc (inner halo) */
  const rOuter = rings[rings.length-1] + 28;
  const rInner = rings[0] - 26;
  ctx.fillStyle = ringGradient(ctx, rInner*0.35, rOuter, colors[1], colors[2], .35, .02);
  ctx.beginPath(); ctx.arc(0,0,rOuter,0,TAU); ctx.fill();

  /* etched rings with specular */
  rings.forEach((r,i)=>{
    const breathe = 1 + 0.015*Math.sin(time*1.7 + i);
    const rr = r*breathe;

    // base ring
    ctx.strokeStyle = hexA(colors[0], .9); ctx.lineWidth = 2.2;
    ctx.beginPath(); ctx.arc(0,0, rr, 0, TAU); ctx.stroke();

    // specular highlight
    ctx.strokeStyle = hexA('#ffffff', .12);
    ctx.lineWidth = 3.5;
    ctx.beginPath();
    ctx.arc(0,0, rr, time*0.8, time*0.8 + Math.PI*0.35);
    ctx.stroke();
  });

  /* symmetry spokes + end glyphs (squares/triangles/circles), woven with a small noise offset */
  for(let L=0; L<layers; L++){
    for(let i=0;i<sym;i++){
      const a0 = (i/sym)*TAU + L*0.07 + time*0.2;
      const noffset = (fbm(Math.cos(a0)*1.2, Math.sin(a0)*1.2, seedInt+L*13, 3, .55) - .5)*wiggle*TAU;
      const a = a0 + noffset;
      const r1 = Math.max(coreRadius+18, rings[0]-30);
      const r2 = rings[Math.min(L, rings.length-1)] - 6 + 16*Math.sin(time + i*0.35);

      // spoke
      ctx.strokeStyle = hexA(colors[1], .85);
      ctx.lineWidth = 1.4 + L*0.6;
      ctx.beginPath();
      ctx.moveTo(r1*Math.cos(a), r1*Math.sin(a));
      ctx.lineTo(r2*Math.cos(a), r2*Math.sin(a));
      ctx.stroke();

      // terminal glyph
      ctx.save();
      ctx.translate(r2*Math.cos(a), r2*Math.sin(a));
      ctx.rotate(a + time*0.4);
      ctx.fillStyle = hexA(colors[2], .85);
      const glyph = (i+L)%4;
      switch(glyph){
        case 0: ctx.fillRect(-7,-7,14,14); break;
        case 1:
          ctx.beginPath(); ctx.moveTo(0,-9); ctx.lineTo(8,7); ctx.lineTo(-8,7); ctx.closePath(); ctx.fill(); break;
        case 2: ctx.beginPath(); ctx.arc(0,0,8,0,TAU); ctx.fill(); break;
        case 3:
          ctx.beginPath(); ctx.moveTo(-9,0); ctx.lineTo(0,-9); ctx.lineTo(9,0); ctx.lineTo(0,9); ctx.closePath(); ctx.fill(); break;
      }
      ctx.restore();
    }
  }

  /* braided rose-knot overlay */
  ctx.strokeStyle = hexA(colors[0], .65);
  ctx.lineWidth = 1.6;
  ctx.beginPath();
  const Rk = rings[Math.floor(rings.length/2)] - 18;
  for(let i=0;i<=720;i++){
    const a = (i/720)*TAU*2 + time*0.6;
    const [x,y] = rosePoint(roseK, a, Rk);
    const n = (noise2D(Math.cos(a)*1.8, Math.sin(a)*1.8, seedInt) - .5)*10;
    if(i===0) ctx.moveTo(x+n, y+n); else ctx.lineTo(x+n, y+n);
  }
  ctx.stroke();

  /* moving arcs (like engraved crescents) */
  ctx.strokeStyle = hexA(colors[0], .55);
  ctx.lineWidth = 2.2;
  for(let i=0;i<arcCount;i++){
    const r = rInner + (i/(arcCount-1))*(rOuter-rInner);
    const start = time*0.4 + (i/arcCount)*TAU;
    const len = Math.PI*0.35 + Math.sin(time + i)*Math.PI*0.25;
    ctx.beginPath(); ctx.arc(0,0, r, start, start+len); ctx.stroke();
  }

  /* runic ring */
  const RR = rOuter - 14;
  const runeSize = 10 + (CW/1024)*4;
  for(let i=0;i<runeCount;i++){
    const a = (i/runeCount)*TAU + time*0.15;
    const x = RR*Math.cos(a), y = RR*Math.sin(a);
    ctx.save(); ctx.translate(x,y); ctx.rotate(a + Math.PI/2);
    drawRune(ctx, runeSize, seedInt+i*97, hexA(colors[0], .92));
    ctx.restore();
  }

  /* center—star + core */
  ctx.save();
  ctx.fillStyle = ringGradient(ctx, 0, coreRadius*2.2, colors[2], colors[1], .9,.15);
  ctx.beginPath(); starPath(ctx, starPts, coreRadius*1.25, coreRadius*0.55); ctx.fill();

  ctx.globalCompositeOperation = 'lighter';
  ctx.fillStyle = hexA(colors[1], .85);
  ctx.beginPath(); ctx.arc(0,0, coreRadius*(1+0.08*Math.sin(time*2.2)), 0, TAU); ctx.fill();
  ctx.globalCompositeOperation = 'source-over';

  // crosshair etch
  ctx.strokeStyle = hexA(colors[2], .8); ctx.lineWidth=1.6;
  ctx.beginPath();
  ctx.moveTo(-coreRadius-14,0); ctx.lineTo(coreRadius+14,0);
  ctx.moveTo(0,-coreRadius-14); ctx.lineTo(0,coreRadius+14);
  ctx.stroke();
  ctx.restore();

  /* faint outer glow */
  ctx.globalCompositeOperation = 'screen';
  ctx.strokeStyle = hexA(colors[0], .08);
  ctx.lineWidth = 22;
  ctx.beginPath(); ctx.arc(0,0, rOuter+12, 0, TAU); ctx.stroke();
  ctx.globalCompositeOperation = 'source-over';

  ctx.restore();

  if (animOn) animReq = requestAnimationFrame(drawFrame);
}
  async function openSigilSmithy(){
    const acct = await getActiveAccount();
    walletRawAddress = acct || null;
    if (!seedInput.value) seedInput.value = acct || randomSeed();
    modalBackdrop.classList.add('show');
    animOn = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    renderSigil(getEffectiveSeed(), currentPaletteIndex);
  }
  
  function closeSigilSmithy(){
    modalBackdrop.classList.remove('show');
    saveSigilState();
    animOn = false;
    cancelAnimationFrame(animReq); 
    animReq = null;
  }
  
  window.openSigilSmithy = openSigilSmithy;

  // ================== Expose ==================
  window.interactWithRelic = interactWithRelic;
  window.openAcademy = openAcademy;
  window.openStaking = openStaking;
  window.launchOracle = launchOracle;
  window.openSecurityCheck = openSecurityCheck;
  window.openAltarModal = openAltarModal;
  window.performBurn = performBurn;
  window.setAltarPercent = setAltarPercent;
  window.closeAltarModal = closeAltarModal;
</script>
</body>
</html>
