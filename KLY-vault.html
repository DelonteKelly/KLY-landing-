<!-- Enhanced KLY Oracle Section -->
<section id="kly-oracle" style="background: radial-gradient(circle at center, #0d0d0d 0%, #000000 100%); padding: 80px 0; position: relative; overflow: hidden;">
  <!-- Animated Background Elements -->
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; opacity: 0.15;">
    <div style="position: absolute; top: 20%; left: 10%; width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle, rgba(138,43,226,0.8) 0%, rgba(0,0,0,0) 70%); animation: float 12s infinite ease-in-out;"></div>
    <div style="position: absolute; top: 60%; left: 80%; width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle, rgba(75,0,130,0.6) 0%, rgba(0,0,0,0) 70%); animation: float 15s infinite ease-in-out reverse;"></div>
    <div style="position: absolute; top: 30%; left: 65%; width: 30px; height: 30px; border-radius: 50%; background: radial-gradient(circle, rgba(147,112,219,0.7) 0%, rgba(0,0,0,0) 70%); animation: float 18s infinite ease-in-out 2s;"></div>
  </div>

  <!-- Section Content -->
  <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 2;">
    <!-- Section Header -->
    <div style="text-align: center; margin-bottom: 40px;">
      <h2 class="section-title" style="color: #ffffff; font-family: 'Cinzel', serif; font-size: clamp(28px, 3vw, 42px); margin-bottom: 15px; letter-spacing: 1px; text-shadow: 0 0 15px rgba(147, 112, 219, 0.5);">
        🔮 KLY Oracle
      </h2>
      <p style="color: #cccccc; font-size: clamp(14px, 1.5vw, 18px); max-width: 600px; margin: 0 auto 25px; line-height: 1.6;">
        The decentralized oracle protocol delivering secure, reliable off-chain data to smart contracts.
      </p>

      <!-- Connect Wallet Button -->
      <div id="wallet-section" style="margin-top: 15px;">
        <button id="connect-button" style="padding: 10px 20px; background: #9370DB; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(147, 112, 219, 0.4); transition: background 0.3s;">
          🔗 Connect Wallet
        </button>
        <p id="wallet-address" style="color: #aaa; font-size: 14px; margin-top: 8px;"></p>
      </div>

      <!-- Tier Access Indicator -->
      <div id="access-indicator" style="background: rgba(20, 20, 20, 0.7); border: 1px solid #333; border-radius: 50px; padding: 8px 20px; display: inline-flex; align-items: center; gap: 10px; margin-top: 25px;">
        <div id="access-status" style="width: 12px; height: 12px; border-radius: 50%; background: #555;"></div>
        <span id="access-message" style="color: #aaa; font-size: 14px;">
          💡 Connect wallet & hold KLY to unlock Oracle tiers
        </span>
      </div>

      <!-- Tier Progress Bar -->
      <div style="max-width: 400px; margin: 15px auto 30px; background: rgba(40, 40, 40, 0.7); height: 6px; border-radius: 3px; overflow: hidden;">
        <div id="tier-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4B0082, #9370DB); transition: width 0.5s ease;"></div>
      </div>
    </div>

    <!-- Loader -->
    <div id="oracle-loader" style="text-align: center; padding: 40px 0; transition: opacity 0.5s ease;">
      <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 20px;">
        <img src="/assets/kly-oracle-loader.gif" alt="Loading Oracle" width="80" style="animation: pulse 2s infinite ease-in-out;" />
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(147, 112, 219, 0.3); animation: ripple 2s infinite ease-out;"></div>
      </div>
      <p style="color: #aaa; margin-top: 15px; font-size: 16px;">Activating KLY Oracle...</p>
      <p style="color: #666; margin-top: 10px; font-size: 13px;">Initializing secure connection to decentralized oracle network</p>
    </div>

    <!-- Oracle Frame -->
    <div style="border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); transition: all 0.5s ease; opacity: 0; transform: translateY(20px);" id="iframe-container">
      <iframe
        id="oracle-frame"
        src=""
        width="100%"
        height="1200px"
        style="display: none; border: none;"
        allowfullscreen
        allow="clipboard-write"
        loading="eager">
      </iframe>
    </div>
  </div>
</section>

<!-- Styles -->
<style>
  @keyframes float {
    0%, 100% { transform: translateY(0) translateX(0); }
    50% { transform: translateY(-20px) translateX(10px); }
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
  }
  @keyframes ripple {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(1.5); opacity: 0; }
  }
  #access-indicator:hover {
    border-color: #9370DB;
    transition: all 0.3s ease;
  }
  #iframe-container.show {
    opacity: 1;
    transform: translateY(0);
  }
  @media (max-width: 768px) {
    #oracle-frame {
      height: 1600px;
    }
    #kly-oracle {
      padding: 50px 0;
    }
  }
</style>

<!-- Web3 Script -->
<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.7.0/+esm";

  const connectButton = document.getElementById('connect-button');
  const walletAddressDisplay = document.getElementById('wallet-address');
  const accessStatus = document.getElementById('access-status');
  const accessMessage = document.getElementById('access-message');
  const tierProgress = document.getElementById('tier-progress');
  const iframe = document.getElementById('oracle-frame');
  const loader = document.getElementById('oracle-loader');
  const iframeContainer = document.getElementById('iframe-container');

  const KLY_TOKEN_ADDRESS = "0xYourKLYTokenAddressHere"; // 🔁 REPLACE THIS
  const KLY_TOKEN_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)"
  ];

  let provider, signer, address;

  async function connectWallet() {
    if (window.ethereum) {
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();
      walletAddressDisplay.textContent = `✅ Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
      connectButton.style.display = 'none';
      await checkKLYBalance(address);
    } else {
      alert("Please install MetaMask!");
    }
  }

  async function checkKLYBalance(userAddress) {
    const token = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, provider);
    const rawBalance = await token.balanceOf(userAddress);
    const decimals = await token.decimals();
    const balance = parseFloat(ethers.formatUnits(rawBalance, decimals));

    if (balance >= 1000) {
      accessStatus.style.background = "#9370DB";
      accessMessage.textContent = "🔓 Tier 3 Access: Full Oracle Capabilities";
      tierProgress.style.width = "100%";
    } else if (balance >= 250) {
      accessStatus.style.background = "#4CAF50";
      accessMessage.textContent = "🔓 Tier 2 Access: Advanced Oracle Features";
      tierProgress.style.width = "66%";
    } else if (balance > 0) {
      accessStatus.style.background = "#FFC107";
      accessMessage.textContent = "🔓 Tier 1 Access: Basic Oracle Features";
      tierProgress.style.width = "33%";
    } else {
      accessMessage.textContent = "🔒 No KLY tokens detected.";
    }

    // Trigger iframe after confirmation
    setTimeout(() => {
      iframe.src = "https://oraclekly.replit.app";
    }, 1000);
  }

  iframe.onload = () => {
    loader.style.opacity = '0';
    setTimeout(() => {
      loader.style.display = 'none';
      iframe.style.display = 'block';
      iframeContainer.classList.add('show');
    }, 500);
  };

  connectButton.addEventListener("click", connectWallet);
</script>
