<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KLY VAULT — Oracle × Frequency Locker</title>

<style>
/* --- Variables --- */
:root {
  --neon-green: #00ffe7;
  --neon-pink: #ff00aa;
  --neon-purple: #aa00ff;
  --neon-gold: #ffd700;
  --dark-bg: #000;
  --panel-bg: rgba(0,0,0,0.75);
  --text-primary: #e0e0e0;
  --text-secondary: #888;
}

/* --- Base --- */
body, html {
  margin: 0;
  padding: 0;
  background: var(--dark-bg);
  color: var(--text-primary);
  font-family: 'Rajdhani', 'Orbitron', sans-serif;
  min-height: 100vh;
}

.hidden { display:none!important; }
.container { max-width: 1200px; margin: 0 auto; padding: 6rem 1.25rem; }

/* Vault Door */
.vault-door {
  display:grid; place-items:center;
  position:relative; border:2px solid var(--neon-green);
  border-radius:50%; height:60vh; max-width:480px;
  margin:0 auto 4rem; box-shadow:0 0 30px rgba(0,255,231,.2);
}
.door-ring {
  position:absolute; inset:-20%;
  border:2px solid var(--neon-purple); border-radius:50%;
  animation: spin 12s linear infinite; opacity:.2;
}
@keyframes spin { to {transform:rotate(360deg);} }

.vault-btn {
  z-index:10; padding:1rem 1.8rem; border:none;
  background:linear-gradient(135deg,var(--neon-green),var(--neon-purple));
  color:#000; font-family:'Orbitron',sans-serif; border-radius:10px;
  cursor:pointer; box-shadow:0 0 20px var(--neon-green); letter-spacing:1px;
}
.vault-btn:hover { transform:scale(1.05); }

.tier-hint { position:absolute; bottom:2rem; font-size:.9rem; color:var(--neon-green); }

/* Section Titles */
.section-title {
  font-family:'Orbitron',sans-serif;
  color:var(--neon-green);
  text-shadow:0 0 12px var(--neon-green);
  text-transform:uppercase;
  letter-spacing:2px;
  margin:3rem 0 1rem;
}

/* Oracle */
.oracle-console { background:var(--panel-bg); border:1px solid var(--neon-green); padding:1rem; border-radius:10px; margin-bottom:3rem; }
.oracle-messages { height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:.75rem; margin-bottom:1rem; }
.msg { padding:.7rem 1rem; border-radius:8px; }
.msg.user { background:rgba(0,255,231,.08); border:1px solid rgba(0,255,231,.2); align-self:flex-end; }
.msg.oracle { background:rgba(170,0,255,.08); border:1px solid rgba(170,0,255,.2); align-self:flex-start; }
.oracle-input { display:flex; gap:.5rem; }
.oracle-input input { flex:1; padding:.7rem 1rem; border:1px solid var(--neon-green); background:#000; color:var(--text-primary); border-radius:8px; }
.oracle-input button { background:var(--neon-green); color:#000; border:none; border-radius:8px; padding:.7rem 1rem; cursor:pointer; font-family:'Orbitron'; }

/* Frequency Chamber */
.frequency-player { display:grid; gap:1rem; margin-bottom:1rem; }
#freqViz { width:100%; height:160px; background:rgba(0,0,0,.4); border:1px solid var(--neon-purple); border-radius:8px; }
.frequency-tracks { display:flex; flex-wrap:wrap; gap:.7rem; margin-bottom:3rem; justify-content:center; }
.track { border:1px solid var(--neon-green); padding:.5rem .9rem; border-radius:8px; background:rgba(0,0,0,.6); color:var(--neon-green); cursor:pointer; }
.track.locked { border-color:var(--neon-pink); color:var(--neon-pink); cursor:not-allowed; opacity:.5; }

/* Relics */
.relic-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:1rem; }
.relic-card { background:var(--panel-bg); border:1px solid var(--neon-green); border-radius:10px; padding:1.2rem; text-align:center; text-decoration:none; color:var(--text-primary); }
.relic-card.locked { border-color:var(--neon-pink); color:var(--neon-pink); filter:grayscale(.4); cursor:not-allowed; }

</style>
</head>

<body>
<div class="container">

  <!-- Vault Door -->
  <section class="vault-door" id="vaultDoor">
    <div class="door-ring"></div>
    <button id="connectWalletBtn" class="vault-btn">CONNECT WALLET TO UNLOCK</button>
    <p class="tier-hint" id="tierHint">Visitor Mode • Limited Access</p>
  </section>

  <!-- Vault Inner -->
  <section id="vaultInner" class="hidden">

    <!-- Oracle -->
    <h2 class="section-title">KLY ORACLE</h2>
    <div class="oracle-console">
      <div class="oracle-messages" id="oracleMessages"></div>
      <div class="oracle-input">
        <input type="text" id="oracleQuestion" placeholder="Ask the Oracle..." />
        <button id="askOracleBtn">ASK</button>
      </div>
    </div>

    <!-- Frequency Chamber -->
    <h2 class="section-title">FREQUENCY CHAMBER</h2>
    <div class="frequency-player">
      <audio id="freqAudio" controls></audio>
      <canvas id="freqViz"></canvas>
    </div>
    <div class="frequency-tracks" id="frequencyTracks"></div>

    <!-- Relics -->
    <h2 class="section-title">DIGITAL RELICS</h2>
    <div class="relic-grid" id="relicGrid"></div>

  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
<script>
/* ================== CONFIG ================== */
const KLY_TOKEN = {
  address: "0xYourKlyTokenAddressHere", // Replace with your real KLY contract address
  abi: [
    "function balanceOf(address owner) view returns (uint256)",
    "function decimals() view returns (uint8)"
  ],
  decimals: 18
};

const THRESHOLDS = { tier1: 500, tier2: 5000, tier3: 50000 };

const FREQUENCY_TRACKS = [
  { title: "Visitor Teaser", tier: 0, src: "/audio/teaser.mp3" },
  { title: "Alpha Waves", tier: 1, src: "/audio/tier1/alpha-waves.mp3" },
  { title: "DNA Upgrade", tier: 2, src: "/audio/tier2/dna-528hz.mp3" },
  { title: "Founder Stream", tier: 3, src: "/audio/tier3/founder.mp3" }
];

const RELICS = [
  { title: "Visitor Scroll", tier: 0, href: "/pdf/visitor.pdf" },
  { title: "Sovereignty Blueprint", tier: 1, href: "/pdf/blueprint.pdf" },
  { title: "Advanced Strategy Scroll", tier: 2, href: "/pdf/advanced.pdf" },
  { title: "Founder's Notes", tier: 3, href: "/pdf/founder.pdf" }
];

let currentTier = 0;

/* ================== WALLET ================== */
async function connectWallet() {
  if (!window.ethereum) {
    alert("No Web3 wallet detected. Please install MetaMask.");
    return;
  }

  const provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = await provider.getSigner();
  const address = await signer.getAddress();

  const contract = new ethers.Contract(KLY_TOKEN.address, KLY_TOKEN.abi, provider);
  const rawBalance = await contract.balanceOf(address);
  const balance = Number(ethers.formatUnits(rawBalance, KLY_TOKEN.decimals));

  currentTier = getTier(balance);
  openVault();
  mountTracks();
  mountRelics();
}

function getTier(balance) {
  if (balance >= THRESHOLDS.tier3) return 3;
  if (balance >= THRESHOLDS.tier2) return 2;
  if (balance >= THRESHOLDS.tier1) return 1;
  return 0;
}

function openVault() {
  document.getElementById("vaultDoor").classList.add("hidden");
  document.getElementById("vaultInner").classList.remove("hidden");
  document.getElementById("tierHint").innerText = `Tier ${currentTier}`;
}

/* ================== FREQUENCY ================== */
function mountTracks() {
  const container = document.getElementById("frequencyTracks");
  container.innerHTML = "";
  FREQUENCY_TRACKS.forEach(track => {
    const btn = document.createElement("button");
    btn.className = "track";
    btn.textContent = track.title;
    if (track.tier > currentTier) {
      btn.classList.add("locked");
    } else {
      btn.addEventListener("click", () => {
        document.getElementById("freqAudio").src = track.src;
        document.getElementById("freqAudio").play();
      });
    }
    container.appendChild(btn);
  });
}

/* ================== RELICS ================== */
function mountRelics() {
  const grid = document.getElementById("relicGrid");
  grid.innerHTML = "";
  RELICS.forEach(item => {
    const card = document.createElement("a");
    card.className = "relic-card";
    card.innerText = item.title;
    if (item.tier > currentTier) {
      card.classList.add("locked");
      card.href = "javascript:void(0)";
    } else {
      card.href = item.href;
      card.target = "_blank";
    }
    grid.appendChild(card);
  });
}

/* ================== ORACLE ================== */
async function askOracle() {
  const q = document.getElementById("oracleQuestion").value.trim();
  if (!q) return;
  appendOracle("user", q);
  document.getElementById("oracleQuestion").value = "";

  try {
    const response = await fetch("/api/oracle", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: q, tier: currentTier })
    });
    const data = await response.json();
    appendOracle("oracle", data.answer || "Oracle is silent.");
  } catch (e) {
    appendOracle("oracle", "Error contacting Oracle.");
  }
}

function appendOracle(role, text) {
  const container = document.getElementById("oracleMessages");
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.innerText = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

/* ================== EVENTS ================== */
document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);
document.getElementById("askOracleBtn").addEventListener("click", askOracle);
document.getElementById("oracleQuestion").addEventListener("keydown", e => { if (e.key === "Enter") askOracle(); });
</script>
</body>
</html>

export default async function handler(req, res) {
  const { question, tier } = req.body;
  const tiers = [
    "Visitor: Expand your KLY balance to unlock deeper messages.",
    "Tier 1: Focus on self-awareness and daily frequency alignment.",
    "Tier 2: Begin legacy building with sovereignty codes.",
    "Tier 3: Founder wisdom activated. Build the nation."
  ];
  const answer = `You asked: "${question}"\n\n${tiers[tier] || tiers[0]}`;
  res.status(200).json({ answer });
}
