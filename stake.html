<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/GlitchPass.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/BloomPass.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ascension Portal | KLY Token</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --neon-green: #00ffe7;
  --neon-pink: #ff00aa;
  --neon-purple: #aa00ff;
  --neon-blue: #00aaff;
  --neon-orange: #ff6b00;
  --neon-yellow: #fff000;
  --dark-bg: #000000;
  --darker-bg: #0a0a0a;
  --panel-bg: rgba(0, 0, 0, 0.85);
  --text-primary: #e0e0e0;
  --text-secondary: #888888;
  --glow-green: 0 0 10px var(--neon-green);
  --glow-pink: 0 0 10px var(--neon-pink);
  --glow-purple: 0 0 10px var(--neon-purple);
  --glow-blue: 0 0 10px var(--neon-blue);
  --glow-orange: 0 0 10px var(--neon-orange);
  --transition-medium: 0.3s;
  --transition-slow: 0.6s;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Orbitron', 'Rajdhani', sans-serif;
  background: var(--dark-bg);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
  background-image: 
    radial-gradient(circle at 20% 30%, rgba(0, 255, 231, 0.05) 0%, transparent 20%),
    radial-gradient(circle at 80% 70%, rgba(170, 0, 255, 0.05) 0%, transparent 20%),
    linear-gradient(to bottom, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.95));
}

/* Animated background elements */
.background-element {
  position: fixed;
  border-radius: 50%;
  filter: blur(60px);
  opacity: 0.15;
  z-index: -1;
  animation: float 15s infinite ease-in-out;
}

.background-element:nth-child(1) {
  width: 300px;
  height: 300px;
  background: var(--neon-green);
  top: 10%;
  left: 10%;
  animation-delay: 0s;
}

.background-element:nth-child(2) {
  width: 400px;
  height: 400px;
  background: var(--neon-purple);
  top: 60%;
  left: 70%;
  animation-delay: 3s;
}

.background-element:nth-child(3) {
  width: 200px;
  height: 200px;
  background: var(--neon-pink);
  top: 30%;
  left: 80%;
  animation-delay: 6s;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  25% { transform: translate(20px, 20px) rotate(5deg); }
  50% { transform: translate(0, 30px) rotate(0deg); }
  75% { transform: translate(-20px, 20px) rotate(-5deg); }
}

/* Particle effects */
.particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  pointer-events: none;
}

.particle {
  position: absolute;
  background: var(--neon-green);
  border-radius: 50%;
  opacity: 0.3;
  animation: particle-float linear infinite;
}

@keyframes particle-float {
  to { transform: translateY(-100vh); }
}

header {
  background: var(--panel-bg);
  border-bottom: 1px solid var(--neon-green);
  box-shadow: var(--glow-green);
  padding: 1rem 2rem;
  position: relative;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(5px);
}

.logo {
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--neon-green);
  text-shadow: var(--glow-green);
  letter-spacing: 2px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.nav-links {
  display: flex;
  gap: 1.5rem;
}

.nav-links a {
  color: var(--text-primary);
  text-decoration: none;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 1.5px;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  background-color: rgba(0, 0, 0, 0.8);
  box-shadow: 
    0 0 8px var(--neon-green),
    inset 0 0 4px var(--neon-green),
    0 0 0 1px rgba(0, 255, 231, 0.3);
  transition: all var(--transition-medium) ease;
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
}

.nav-links a::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    to bottom right,
    rgba(0, 255, 231, 0) 0%,
    rgba(0, 255, 231, 0) 30%,
    rgba(0, 255, 231, 0.3) 45%,
    rgba(0, 255, 231, 0) 60%,
    rgba(0, 255, 231, 0) 100%
  );
  transform: rotate(30deg);
  transition: all var(--transition-slow) ease;
}

.nav-links a:hover::before {
  animation: shine 1.5s infinite;
}

@keyframes shine {
  0% { left: -100%; top: -100%; }
  100% { left: 100%; top: 100%; }
}

.nav-links a:hover {
  color: var(--neon-green);
  text-shadow: 0 0 8px var(--neon-green);
  transform: translateY(-3px);
  box-shadow: 
    0 3px 15px var(--neon-green),
    inset 0 0 8px var(--neon-green),
    0 0 0 2px rgba(0, 255, 231, 0.5);
}

/* Mobile menu */
.mobile-menu-btn {
  display: none;
  background: none;
  border: none;
  color: var(--neon-green);
  font-size: 1.5rem;
  cursor: pointer;
}

/* Hero section */
.hero {
  position: relative;
  padding: 4rem 2rem;
  text-align: center;
  overflow: hidden;
  height: 60vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at center, rgba(0, 255, 231, 0.1) 0%, transparent 70%),
    linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.2));
  z-index: -1;
}

.hero-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  z-index: 2;
}

@media (max-width: 768px) {
  #portal3d-container {
    position: relative;
    top: auto;
    left: auto;
    transform: none;
    width: 90vw;
    height: 300px;
    margin: 0 auto 2rem;
  }

  .portal-overlay-text {
    position: static;
    transform: none;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .portal-overlay-text h2 {
    font-size: 2rem;
  }

  .portal-overlay-text p {
    font-size: 1rem;
  }

  .portal-container {
    grid-template-columns: 1fr;
    padding: 1rem;
  }

  .portal-header h1 {
    font-size: 2.2rem;
  }

  .portal-header p {
    font-size: 1rem;
    padding: 0 1rem;
  }
}
/* Animated gradient border */
.gradient-border {
  position: relative;
  border-radius: 16px;
  overflow: hidden;
}

.gradient-border::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(
    45deg,
    var(--neon-green),
    var(--neon-purple),
    var(--neon-pink),
    var(--neon-green)
  );
  background-size: 400% 400%;
  z-index: -1;
  border-radius: 18px;
  animation: gradient-border 6s ease infinite;
}

@keyframes gradient-border {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.stake-panel, .nft-panel {
  background: var(--panel-bg);
  border: 1px solid rgba(0, 255, 231, 0.2);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 0 20px rgba(0, 255, 231, 0.1);
  transition: all var(--transition-medium) ease;
  position: relative;
  overflow: hidden;
}

.stake-panel:hover, .nft-panel:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 255, 231, 0.3);
}

.panel-title {
  font-size: 1.5rem;
  color: var(--neon-green);
  margin-bottom: 1.5rem;
  position: relative;
  display: inline-block;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.panel-title::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--neon-green);
  box-shadow: var(--glow-green);
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-item {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1rem;
  transition: all var(--transition-medium) ease;
}

.stat-item:hover {
  transform: translateY(-3px);
  box-shadow: var(--glow-green);
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 5px;
}

.stat-value {
  font-size: 1.2rem;
  color: var(--neon-green);
  font-weight: bold;
  text-shadow: 0 0 5px var(--neon-green);
}

.wallet-btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--neon-green), var(--neon-purple));
  color: #000;
  border: none;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-weight: bold;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
  margin-bottom: 1.5rem;
  box-shadow: 0 0 15px var(--neon-green);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.wallet-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to right,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.2) 50%,
    rgba(255, 255, 255, 0) 100%
  );
  transform: translateX(-100%);
  transition: all var(--transition-slow) ease;
}

.wallet-btn:hover::after {
  transform: translateX(100%);
}

.wallet-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 25px var(--neon-purple);
}

.stake-form {
  margin-top: 1.5rem;
}

.input-group {
  margin-bottom: 1.5rem;
  position: relative;
}

.input-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.input-group input, .input-group textarea {
  width: 100%;
  padding: 0.8rem;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: 'Orbitron', sans-serif;
  transition: all var(--transition-medium) ease;
}

.input-group input:focus, .input-group textarea:focus {
  outline: none;
  border-color: var(--neon-purple);
  box-shadow: 0 0 10px var(--neon-purple);
}

.input-group textarea {
  min-height: 100px;
  resize: vertical;
}

.input-group .max-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 255, 231, 0.2);
  color: var(--neon-green);
  border: 1px solid var(--neon-green);
  border-radius: 4px;
  padding: 0.2rem 0.5rem;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
}

.input-group .max-btn:hover {
  background: rgba(0, 255, 231, 0.4);
}

.action-btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--neon-green), var(--neon-pink));
  color: #000;
  border: none;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-weight: bold;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
  margin-top: 1rem;
  box-shadow: 0 0 15px var(--neon-green);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 25px var(--neon-pink);
}

.action-btn.secondary {
  background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
  box-shadow: 0 0 15px var(--neon-purple);
}

.action-btn.secondary:hover {
  box-shadow: 0 0 25px var(--neon-blue);
}

.nft-display {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  margin-bottom: 2rem;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.nft-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    linear-gradient(
      135deg,
      rgba(0, 255, 231, 0.05) 0%,
      rgba(170, 0, 255, 0.05) 50%,
      rgba(0, 255, 231, 0.05) 100%
    );
  z-index: 0;
}

.nft-image {
  max-width: 150px;
  border-radius: 8px;
  margin-bottom: 1rem;
  box-shadow: 0 0 15px var(--neon-green);
  transition: all var(--transition-medium) ease;
  position: relative;
  z-index: 1;
}

.nft-image:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px var(--neon-purple);
}

.nft-name {
  font-size: 1.2rem;
  color: var(--neon-green);
  text-shadow: 0 0 5px var(--neon-green);
  position: relative;
  z-index: 1;
}

.nft-attributes {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 1rem;
  position: relative;
  z-index: 1;
}

.nft-attribute {
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid var(--neon-green);
  border-radius: 4px;
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
}

/* Transaction Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-medium) ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--panel-bg);
  border: 1px solid var(--neon-green);
  border-radius: 16px;
  padding: 2rem;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 0 30px var(--neon-green);
  transform: translateY(20px);
  transition: all var(--transition-medium) ease;
  position: relative;
  overflow: hidden;
}

.modal-overlay.active .modal-content {
  transform: translateY(0);
}

.modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    linear-gradient(
      135deg,
      rgba(0, 255, 231, 0.05) 0%,
      rgba(170, 0, 255, 0.05) 50%,
      rgba(0, 255, 231, 0.05) 100%
    );
  z-index: -1;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.modal-title {
  font-size: 1.5rem;
  color: var(--neon-green);
  margin: 0;
  text-shadow: var(--glow-green);
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 1.5rem;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
}

.modal-close:hover {
  color: var(--neon-green);
  transform: rotate(90deg);
}

.tx-details {
  margin-bottom: 1.5rem;
}

.tx-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.8rem;
  padding-bottom: 0.8rem;
  border-bottom: 1px solid rgba(0, 255, 231, 0.2);
}

.tx-label {
  color: var(--text-secondary);
}

.tx-value {
  color: var(--text-primary);
  font-weight: bold;
}

.tx-fee {
  color: var(--neon-orange);
}

.tx-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
}

.tx-btn {
  flex: 1;
  padding: 0.8rem;
  border: none;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-weight: bold;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
}

.tx-btn-cancel {
  background: rgba(255, 0, 0, 0.2);
  color: #ff5555;
  border: 1px solid #ff5555;
}

.tx-btn-confirm {
  background: linear-gradient(135deg, var(--neon-green), var(--neon-purple));
  color: #000;
}

.tx-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 255, 231, 0.3);
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0, 255, 231, 0.3);
  border-radius: 50%;
  border-top-color: var(--neon-green);
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Progress bar */
.progress-container {
  width: 100%;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 8px;
  margin: 1rem 0;
  overflow: hidden;
  border: 1px solid var(--neon-green);
}

.progress-bar {
  height: 10px;
  background: linear-gradient(90deg, var(--neon-green), var(--neon-purple));
  width: 0%;
  transition: width 0.3s ease;
}

/* Toast notifications */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1100;
}

.toast {
  background: var(--panel-bg);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 0 20px rgba(0, 255, 231, 0.3);
  display: flex;
  align-items: center;
  gap: 10px;
  transform: translateX(120%);
  transition: all 0.3s ease;
  max-width: 300px;
}

.toast.show {
  transform: translateX(0);
}

.toast.success {
  border-color: var(--neon-green);
}

.toast.error {
  border-color: #ff5555;
}

.toast-icon {
  font-size: 1.2rem;
}

.toast.success .toast-icon {
  color: var(--neon-green);
}

.toast.error .toast-icon {
  color: #ff5555;
}

.toast-message {
  flex: 1;
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
}

/* Analytics Section */
.analytics-panel {
  grid-column: 1 / -1;
  background: var(--panel-bg);
  border: 1px solid rgba(0, 255, 231, 0.2);
  border-radius: 16px;
  padding: 2rem;
  margin-top: 2rem;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}

.analytics-item {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  transition: all var(--transition-medium) ease;
}

.analytics-item:hover {
  transform: translateY(-5px);
  box-shadow: var(--glow-green);
}

.analytics-value {
  font-size: 1.5rem;
  color: var(--neon-green);
  font-weight: bold;
  margin: 0.5rem 0;
}

.analytics-label {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

/* Tier system */
.tiers-container {
  display: flex;
  justify-content: space-between;
  margin: 2rem 0;
  gap: 1rem;
}

.tier {
  flex: 1;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  transition: all var(--transition-medium) ease;
  position: relative;
  overflow: hidden;
}

.tier:hover {
  transform: translateY(-5px);
  box-shadow: var(--glow-green);
}

.tier::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: var(--neon-green);
}

.tier.tier-1::before {
  background: var(--neon-green);
}

.tier.tier-2::before {
  background: var(--neon-blue);
}

.tier.tier-3::before {
  background: var(--neon-purple);
}

.tier.tier-4::before {
  background: var(--neon-pink);
}

.tier-name {
  font-size: 1.2rem;
  color: var(--neon-green);
  margin-bottom: 1rem;
  text-transform: uppercase;
}

.tier-requirement {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

.tier-benefits {
  text-align: left;
  font-size: 0.9rem;
  margin-top: 1rem;
}

.tier-benefits li {
  margin-bottom: 0.5rem;
  position: relative;
  padding-left: 1.5rem;
}

.tier-benefits li::before {
  content: '✓';
  position: absolute;
  left: 0;
  color: var(--neon-green);
}

/* Achievement System */
.achievements-panel {
  grid-column: 1 / -1;
  background: var(--panel-bg);
  border: 1px solid rgba(0, 255, 231, 0.2);
  border-radius: 16px;
  padding: 2rem;
  margin-top: 2rem;
}

.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.achievement-badge {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-green);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  transition: all var(--transition-medium) ease;
  position: relative;
  overflow: hidden;
}

.achievement-badge::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    135deg,
    rgba(0, 255, 231, 0.05) 0%,
    rgba(170, 0, 255, 0.05) 50%,
    rgba(0, 255, 231, 0.05) 100%
  );
  z-index: 0;
}

.achievement-badge i {
  font-size: 2rem;
  color: var(--neon-green);
  margin-bottom: 0.5rem;
  display: block;
}

.achievement-badge h4 {
  margin: 0.5rem 0;
  color: var(--neon-green);
}

.achievement-badge p {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin: 0;
}

.achievement-badge.locked {
  opacity: 0.5;
  filter: grayscale(80%);
}

.achievement-badge.locked i {
  color: var(--text-secondary);
}

.achievement-badge.locked h4 {
  color: var(--text-secondary);
}

/* Disconnect Button */
.disconnect-btn {
  background: rgba(255, 0, 0, 0.2);
  color: #ff5555;
  border: 1px solid #ff5555;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
  margin-left: 1rem;
  display: flex;
  align-items: center;
  gap: 5px;
}

.disconnect-btn:hover {
  background: rgba(255, 0, 0, 0.3);
  transform: translateY(-2px);
}

/* Metamask Fallback */
.metamask-fallback {
  display: none;
  background: rgba(255, 165, 0, 0.1);
  border: 1px solid var(--neon-orange);
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  text-align: center;
}

.metamask-fallback p {
  color: var(--neon-orange);
  margin-bottom: 1rem;
}

.metamask-btn {
  background: linear-gradient(135deg, #f6851b, #e2761b);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.8rem 1.5rem;
  font-family: 'Orbitron', sans-serif;
  font-weight: bold;
  cursor: pointer;
  transition: all var(--transition-medium) ease;
}

.metamask-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 15px #f6851b;
}

/* Status Messages */
.status-message {
  margin: 1rem 0;
  font-weight: bold;
  transition: all 0.3s ease;
  text-align: center;
}

.status-success {
  color: var(--neon-green);
  text-shadow: 0 0 5px var(--neon-green);
}

.status-error {
  color: #ff5555;
  text-shadow: 0 0 5px #ff5555;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .analytics-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .tiers-container {
    flex-wrap: wrap;
  }
  
  .tier {
    min-width: calc(50% - 0.5rem);
  }
  
  #portal3d-container {
    width: 500px;
    height: 500px;
  }
}

@media (max-width: 768px) {
  .portal-container {
    grid-template-columns: 1fr;
    padding: 1rem;
  }
  
  .portal-header h1 {
    font-size: 2.5rem;
  }
  
  .nav-links {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: var(--panel-bg);
    flex-direction: column;
    padding: 1rem;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    z-index: 99;
  }
  
  .nav-links.active {
    display: flex;
  }
  
  .mobile-menu-btn {
    display: block;
  }
  
  .analytics-grid {
    grid-template-columns: 1fr;
  }
  
  #portal3d-container {
    width: 400px;
    height: 400px;
  }
  
  .portal-overlay-text h2 {
    font-size: 2rem;
  }
}

@media (max-width: 480px) {
  .portal-header h1 {
    font-size: 2rem;
  }
  
  .tx-actions {
    flex-direction: column;
  }
  
  .tier {
    min-width: 100%;
  }
  
  header {
    padding: 1rem;
  }
  
  .logo {
    font-size: 1.5rem;
  }
  
  #portal3d-container {
    width: 300px;
    height: 300px;
  }
  
  .portal-overlay-text h2 {
    font-size: 1.5rem;
  }
  
  .portal-overlay-text p {
    font-size: 1rem;
  }
  
  .hero {
    height: 50vh;
  }
}
  </style>
</head>
<body>
  <!-- Background elements -->
  <div class="background-element"></div>
  <div class="background-element"></div>
  <div class="background-element"></div>
  
  <!-- Particle effects -->
  <div class="particles" id="particles"></div>
  
  <!-- Toast notifications container -->
  <div class="toast-container" id="toastContainer"></div>

  <header>
    <div class="logo">
      <i class="fas fa-cubes logo-icon"></i>
      <span>KLY TOKEN</span>
    </div>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
    <div class="nav-links" id="navLinks">
      <a href="/portal.html"><i class="fas fa-door-open"></i> Portal</a>
      <a href="/kly-academy.html"><i class="fas fa-graduation-cap"></i> Academy</a>
      <a href="/oracle.html"><i class="fas fa-eye"></i> Oracle</a>
    </div>
  </header>

  <main>
    <div class="hero">
      <div id="portal3d-container">
        <div id="portal3d"></div>
        <div class="portal-overlay-text">
          <h2>ENTER THE ASCENSION</h2>
          <p>Stake to activate the portal</p>
        </div>
      </div>
      <div class="hero-content">
        <div class="portal-header">
          <h1>ASCENSION PORTAL</h1>
          <p>Stake KLY tokens, mint Ascenders NFTs, and unlock exclusive rewards in our decentralized ecosystem. Earn passive income while participating in the future of digital assets.</p>
        </div>
      </div>
    </div>

    <div class="portal-container">
      <div class="stake-panel gradient-border">
        <h2 class="panel-title"><i class="fas fa-lock"></i> STAKING VAULT</h2>
        
        <div class="wallet-connect-container">
          <button class="wallet-btn" id="connectWallet">
            <i class="fas fa-wallet"></i> CONNECT WALLET
          </button>
          <button class="disconnect-btn" id="disconnectWallet" style="display: none;">
            <i class="fas fa-power-off"></i> DISCONNECT
          </button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-chart-line"></i> TVL</div>
            <div class="stat-value" id="tvlValue">1,250,000 KLY</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-coins"></i> Your Staked</div>
            <div class="stat-value" id="stakedValue">0 KLY</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-gift"></i> Daily Reward</div>
            <div class="stat-value" id="rewardValue">12.5 KLY</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-percentage"></i> APY</div>
            <div class="stat-value" id="apyValue">365%</div>
          </div>
        </div>
        
        <div class="stake-form">
          <div class="input-group">
            <label for="stakeAmount"><i class="fas fa-arrow-up"></i> Amount to Stake</label>
            <input type="number" id="stakeAmount" placeholder="Enter KLY amount">
            <button class="max-btn" id="maxBtn">MAX</button>
          </div>
          <button class="action-btn" id="stakeBtn">
            <i class="fas fa-lock"></i> STAKE KLY
          </button>
          <button class="action-btn secondary" id="claimBtn" style="display: none;">
            <i class="fas fa-hand-holding-usd"></i> CLAIM REWARDS
          </button>
          <button class="action-btn secondary" id="unstakeBtn" style="display: none;">
            <i class="fas fa-unlock"></i> UNSTAKE KLY
          </button>
        </div>
      </div>

      <div id="transactionStatus" class="status-message"></div>

      <div class="nft-panel gradient-border">
        <h2 class="panel-title"><i class="fas fa-crown"></i> ASCENDERS NFT</h2>
        
        <div class="nft-display">
          <img src="https://via.placeholder.com/150/000000/00ffe7?text=KLY+NFT" alt="Ascender NFT" class="nft-image" id="nftImage">
          <div class="nft-name" id="nftName">Connect Wallet to View</div>
          <div class="nft-attributes" id="nftAttributes">
            <!-- Attributes will be added dynamically -->
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-layer-group"></i> Total Minted</div>
            <div class="stat-value">1,025</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-tag"></i> Mint Price</div>
            <div class="stat-value">500 KLY</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-fire"></i> Rarity</div>
            <div class="stat-value" id="nftRarity">Common</div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><i class="fas fa-star"></i> Tier</div>
            <div class="stat-value" id="nftTier">1</div>
          </div>
        </div>
        
        <button class="action-btn" id="mintBtn">
          <i class="fas fa-plus-circle"></i> MINT ASCENDER
        </button>
        
        <div class="metamask-fallback" id="metamaskFallback">
          <p><i class="fas fa-exclamation-triangle"></i> Having trouble with WalletConnect? Try MetaMask directly:</p>
          <button class="metamask-btn" id="metamaskBtn">
            <i class="fab fa-ethereum"></i> Connect with MetaMask
          </button>
        </div>
      </div>
      
      <!-- Achievement System -->
      <div class="achievements-panel">
        <h2 class="panel-title"><i class="fas fa-trophy"></i> ACHIEVEMENTS</h2>
        <div class="achievements-grid" id="achievementsContainer">
          <div class="achievement-badge">
            <i class="fas fa-seedling"></i>
            <h4>First Stake</h4>
            <p>Make your first KLY stake</p>
          </div>
          <div class="achievement-badge locked">
            <i class="fas fa-medal"></i>
            <h4>KLY Veteran</h4>
            <p>Stake for 30+ days</p>
          </div>
          <div class="achievement-badge locked">
            <i class="fas fa-trophy"></i>
            <h4>Top 100 Staker</h4>
            <p>Reach top 100 by TVL</p>
          </div>
          <div class="achievement-badge locked">
            <i class="fas fa-gem"></i>
            <h4>NFT Collector</h4>
            <p>Mint 5+ Ascenders</p>
          </div>
        </div>
      </div>
      
      <!-- Tier System -->
      <div class="analytics-panel">
        <h2 class="panel-title"><i class="fas fa-medal"></i> TIER SYSTEM</h2>
        <div class="tiers-container">
          <div class="tier tier-1">
            <h3 class="tier-name">Initiate</h3>
            <div class="tier-requirement">Stake 1,000+ KLY</div>
            <ul class="tier-benefits">
              <li>Basic rewards (365% APY)</li>
              <li>Access to community</li>
              <li>Monthly airdrops</li>
            </ul>
          </div>
          <div class="tier tier-2">
            <h3 class="tier-name">Adept</h3>
            <div class="tier-requirement">Stake 5,000+ KLY</div>
            <ul class="tier-benefits">
              <li>Enhanced rewards (400% APY)</li>
              <li>Exclusive NFT drops</li>
              <li>Governance voting rights</li>
            </ul>
          </div>
          <div class="tier tier-3">
            <h3 class="tier-name">Ascendant</h3>
            <div class="tier-requirement">Stake 25,000+ KLY</div>
            <ul class="tier-benefits">
              <li>Premium rewards (450% APY)</li>
              <li>VIP event access</li>
              <li>Early product access</li>
            </ul>
          </div>
          <div class="tier tier-4">
            <h3 class="tier-name">Archon</h3>
            <div class="tier-requirement">Stake 100,000+ KLY</div>
            <ul class="tier-benefits">
              <li>Elite rewards (500% APY)</li>
              <li>1-on-1 with team</li>
              <li>Revenue share</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="analytics-panel">
        <h2 class="panel-title"><i class="fas fa-chart-pie"></i> STAKING ANALYTICS</h2>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">Total Value Locked</div>
            <div class="analytics-value" id="analyticsTvl">1,250,000 KLY</div>
            <div class="analytics-label">Across all vaults</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">Current APY</div>
            <div class="analytics-value" id="analyticsApy">365%</div>
            <div class="analytics-label">Annual Percentage Yield</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">Total Stakers</div>
            <div class="analytics-value" id="analyticsStakers">1,842</div>
            <div class="analytics-label">Active participants</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">Daily Rewards</div>
            <div class="analytics-value" id="analyticsRewards">45,000 KLY</div>
            <div class="analytics-label">Distributed to stakers</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Transaction Modal -->
  <div class="modal-overlay" id="txModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-file-signature"></i> TRANSACTION CONFIRMATION</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="tx-details">
        <div class="tx-row">
          <span class="tx-label">Network:</span>
          <span class="tx-value" id="txNetwork">BNB Smart Chain</span>
        </div>
        <div class="tx-row">
          <span class="tx-label">Request from:</span>
          <span class="tx-value">kellylegacyestates.com</span>
        </div>
        <div class="tx-row">
          <span class="tx-label">Transaction Type:</span>
          <span class="tx-value" id="txType">NFT Mint</span>
        </div>
        <div class="tx-row">
          <span class="tx-label">Network Fee:</span>
          <span class="tx-value tx-fee" id="txFee">0.0262 BNB ($20.67)</span>
        </div>
        <div class="tx-row">
          <span class="tx-label">Speed:</span>
          <span class="tx-value">Site suggested</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="txProgress"></div>
        </div>
      </div>
      <div class="tx-actions">
        <button class="tx-btn tx-btn-cancel" id="cancelTx"><i class="fas fa-times"></i> CANCEL</button>
        <button class="tx-btn tx-btn-confirm" id="confirmTx"><i class="fas fa-check"></i> CONFIRM</button>
      </div>
    </div>
  </div>

<script>
  // Enhanced 3D Portal with Effects
  let portalScene, portalCamera, portalRenderer, portal, composer;
  let isMouseOver = false;
  let mouseX = 0, mouseY = 0;
  
  function initPortal() {
    // Scene setup
    portalScene = new THREE.Scene();
    portalScene.background = null;
    
    // Camera setup
    portalCamera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    portalCamera.position.z = 30;
    
    // Renderer setup
    portalRenderer = new THREE.WebGLRenderer({ 
      antialias: true,
      alpha: true 
    });
    portalRenderer.setPixelRatio(window.devicePixelRatio);
    portalRenderer.setSize(600, 600);
    portalRenderer.domElement.style.width = '100%';
    portalRenderer.domElement.style.height = '100%';
    document.getElementById('portal3d').appendChild(portalRenderer.domElement);
    
    // Create portal geometry - more complex shape
    const geometry = new THREE.TorusKnotGeometry(8, 3, 256, 32);
    
    // Advanced material with emissive properties
    const material = new THREE.MeshPhongMaterial({
      color: 0x000000,
      emissive: 0x00ff00,
      emissiveIntensity: 0.5,
      specular: 0x00ffaa,
      shininess: 100,
      transparent: true,
      opacity: 0.9,
      wireframe: true
    });
    
    portal = new THREE.Mesh(geometry, material);
    portalScene.add(portal);
    
    // Add ambient and directional light
    const ambientLight = new THREE.AmbientLight(0x00ff00, 0.3);
    portalScene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0x00ff88, 1);
    directionalLight.position.set(1, 1, 1);
    portalScene.add(directionalLight);
    
    // Add glowing particles inside portal
    const particleGeometry = new THREE.BufferGeometry();
    const particleCount = 1000;
    const posArray = new Float32Array(particleCount * 3);
    
    for(let i = 0; i < particleCount * 3; i++) {
      posArray[i] = (Math.random() - 0.5) * 20;
    }
    
    particleGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    const particleMaterial = new THREE.PointsMaterial({
      size: 0.1,
      color: 0x00ff00,
      transparent: true,
      opacity: 0.8,
      blending: THREE.AdditiveBlending
    });
    
    const particles = new THREE.Points(particleGeometry, particleMaterial);
    portal.add(particles);
    
    // Post-processing effects
    composer = new THREE.EffectComposer(portalRenderer);
    const renderPass = new THREE.RenderPass(portalScene, portalCamera);
    composer.addPass(renderPass);
    
    const bloomPass = new THREE.BloomPass(
      1.5,    // strength
      25,     // kernel size
      4,      // sigma 
      256     // blur scale
    );
    composer.addPass(bloomPass);
    
    // Mouse move interaction
    document.addEventListener('mousemove', (event) => {
      mouseX = (event.clientX / window.innerWidth) * 2 - 1;
      mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
    });
    
    document.getElementById('portal3d-container').addEventListener('mouseenter', () => {
      isMouseOver = true;
    });
    
    document.getElementById('portal3d-container').addEventListener('mouseleave', () => {
      isMouseOver = false;
    });
    
    // Handle window resize
    window.addEventListener('resize', onWindowResize);
    
    // Start animation loop
    animatePortal();
  }
  
  function onWindowResize() {
    portalCamera.aspect = 1;
    portalCamera.updateProjectionMatrix();
    portalRenderer.setSize(600, 600);
  }
  
  function animatePortal() {
    requestAnimationFrame(animatePortal);
    
    // Rotate portal
    portal.rotation.x += 0.005;
    portal.rotation.y += 0.007;
    
    // Interactive response to mouse
    if(isMouseOver) {
      portal.rotation.z = mouseX * 0.2;
      portal.rotation.x += mouseY * 0.01;
      portal.material.emissiveIntensity = 1.0;
    } else {
      portal.rotation.z = THREE.MathUtils.lerp(portal.rotation.z, 0, 0.05);
      portal.material.emissiveIntensity = 0.5;
    }
    
    // Pulsing effect
    const time = Date.now() * 0.001;
    portal.scale.setScalar(1 + Math.sin(time * 2) * 0.05);
    portal.material.opacity = 0.8 + Math.sin(time * 3) * 0.1;
    
    // Render with effects
    composer.render();
  }
  
  // Initialize when page loads
  window.addEventListener('load', initPortal);
  
  // Make portal reactive to staking events
  function onStakeEvent(amount) {
    // Flash effect when staking occurs
    gsap.to(portal.material, {
      emissiveIntensity: 2.0,
      duration: 0.5,
      ease: "power2.out",
      yoyo: true,
      repeat: 1
    });
    
    // Add particles explosion
    if(amount > 1000) {
      const explosionGeometry = new THREE.BufferGeometry();
      const explosionCount = 500;
      const explosionArray = new Float32Array(explosionCount * 3);
      
      for(let i = 0; i < explosionCount * 3; i++) {
        explosionArray[i] = (Math.random() - 0.5) * 10;
      }
      
      explosionGeometry.setAttribute('position', new THREE.BufferAttribute(explosionArray, 3));
      
      const explosionMaterial = new THREE.PointsMaterial({
        size: 0.2,
        color: 0x00ff00,
        transparent: true,
        opacity: 1,
        blending: THREE.AdditiveBlending
      });
      
      const explosion = new THREE.Points(explosionGeometry, explosionMaterial);
      portalScene.add(explosion);
      
      // Animate explosion
      gsap.to(explosion.position, {
        z: 50,
        duration: 2,
        ease: "power2.out",
        onComplete: () => portalScene.remove(explosion)
      });
      
      gsap.to(explosion.material, {
        opacity: 0,
        duration: 2,
        ease: "power2.out"
      });
    }
  }

  // Staking Contract Configuration
  const CONFIG = {
    KLY_TOKEN: "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52",
    STAKE_CONTRACT: "0xe9417Fbe4e1D1E70aaE00b76e9B54599707c49e0",
    MIN_STAKE: 100,
    stakingABI: [
      "function stake(uint256 amount) external",
      "function unstake(uint256 amount) external",
      "function claim() external",
      "function getUserStake(address user) external view returns (uint256)",
      "function getPendingRewards(address user) external view returns (uint256)",
      "function totalValueLocked() external view returns (uint256)"
    ],
    erc20ABI: [
      "function balanceOf(address) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function decimals() view returns (uint8)"
    ]
  };

  const state = {
    provider: null,
    signer: null,
    contract: null,
    tokenContract: null,
    address: null,
    decimals: 18,
    tokenBalance: 0
  };

  const elements = {
    connectWallet: document.getElementById("connectWallet"),
    disconnectWallet: document.getElementById("disconnectWallet"),
    stakeAmount: document.getElementById("stakeAmount"),
    stakeBtn: document.getElementById("stakeBtn"),
    unstakeBtn: document.getElementById("unstakeBtn"),
    claimBtn: document.getElementById("claimBtn"),
    stakedValue: document.getElementById("stakedValue"),
    rewardValue: document.getElementById("rewardValue"),
    tvlValue: document.getElementById("tvlValue"),
    maxBtn: document.getElementById("maxBtn"),
    transactionStatus: document.getElementById("transactionStatus"),
    mintBtn: document.getElementById("mintBtn"),
    nftImage: document.getElementById("nftImage"),
    nftName: document.getElementById("nftName"),
    nftAttributes: document.getElementById("nftAttributes"),
    nftRarity: document.getElementById("nftRarity"),
    nftTier: document.getElementById("nftTier"),
    mobileMenuBtn: document.getElementById("mobileMenuBtn"),
    navLinks: document.getElementById("navLinks"),
    txModal: document.getElementById("txModal"),
    closeModal: document.getElementById("closeModal"),
    cancelTx: document.getElementById("cancelTx"),
    confirmTx: document.getElementById("confirmTx"),
    txNetwork: document.getElementById("txNetwork"),
    txType: document.getElementById("txType"),
    txFee: document.getElementById("txFee"),
    txProgress: document.getElementById("txProgress"),
    metamaskFallback: document.getElementById("metamaskFallback"),
    metamaskBtn: document.getElementById("metamaskBtn")
  };

  // Achievements system
  const achievements = [
    { id: 1, name: "First Stake", icon: "fa-seedling", earned: false, condition: (stakeAmount) => stakeAmount > 0 },
    { id: 2, name: "KLY Veteran", icon: "fa-medal", earned: false, condition: (_, stakingDays) => stakingDays >= 30 },
    { id: 3, name: "Top 100 Staker", icon: "fa-trophy", earned: false, condition: (stakeAmount) => stakeAmount >= 50000 },
    { id: 4, name: "NFT Collector", icon: "fa-gem", earned: false, condition: (_, __, nftCount) => nftCount >= 5 }
  ];

  async function connectWallet() {
    try {
      if (!window.ethereum) {
        elements.metamaskFallback.style.display = "block";
        throw new Error("No Ethereum provider found");
      }

      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      state.address = accounts[0];
      state.provider = new ethers.providers.Web3Provider(window.ethereum);
      state.signer = state.provider.getSigner();
      state.tokenContract = new ethers.Contract(CONFIG.KLY_TOKEN, CONFIG.erc20ABI, state.signer);
      state.contract = new ethers.Contract(CONFIG.STAKE_CONTRACT, CONFIG.stakingABI, state.signer);

      state.decimals = await state.tokenContract.decimals();

      elements.connectWallet.style.display = "none";
      elements.disconnectWallet.style.display = "inline-block";
      elements.metamaskFallback.style.display = "none";

      await updateStakingData();
      checkAchievements();
      
      showToast("Wallet connected successfully!", "success");
    } catch (err) {
      showError("Wallet connection failed: " + err.message);
      showToast("Wallet connection failed", "error");
    }
  }

  async function updateStakingData() {
    try {
      const [balance, staked, rewards, tvl] = await Promise.all([
        state.tokenContract.balanceOf(state.address),
        state.contract.getUserStake(state.address),
        state.contract.getPendingRewards(state.address),
        state.contract.totalValueLocked()
      ]);

      state.tokenBalance = ethers.utils.formatUnits(balance, state.decimals);
      const stakedAmount = ethers.utils.formatUnits(staked, state.decimals);
      const rewardAmount = ethers.utils.formatUnits(rewards, state.decimals);
      const tvlAmount = ethers.utils.formatUnits(tvl, state.decimals);

      elements.stakedValue.textContent = stakedAmount + " KLY";
      elements.rewardValue.textContent = rewardAmount + " KLY";
      elements.tvlValue.textContent = tvlAmount + " KLY";

      // Show/hide buttons based on staked amount
      if (parseFloat(stakedAmount) > 0) {
        elements.claimBtn.style.display = "block";
        elements.unstakeBtn.style.display = "block";
        elements.stakeBtn.textContent = "ADD TO STAKE";
      } else {
        elements.claimBtn.style.display = "none";
        elements.unstakeBtn.style.display = "none";
        elements.stakeBtn.textContent = "STAKE KLY";
      }

      return {
        stakedAmount: parseFloat(stakedAmount),
        rewardAmount: parseFloat(rewardAmount),
        tvlAmount: parseFloat(tvlAmount)
      };
    } catch (err) {
      showError("Failed to update staking data: " + err.message);
      return null;
    }
  }

  async function stakeTokens() {
    const amount = parseFloat(elements.stakeAmount.value);
    if (!amount || amount < CONFIG.MIN_STAKE) {
      return showError(`Minimum stake is ${CONFIG.MIN_STAKE} KLY`);
    }

    try {
      showStatus("Approving KLY...", "status-success");
      const amountWei = ethers.utils.parseUnits(amount.toString(), state.decimals);
      
      // Show transaction modal
      showTransactionModal("Token Approval", "Approve KLY tokens for staking", "0.0012 BNB ($0.95)");
      
      const approval = await state.tokenContract.approve(CONFIG.STAKE_CONTRACT, amountWei);
      await approval.wait();

      showStatus("Staking tokens...", "status-success");
      updateTransactionModal("Staking", "Staking KLY tokens", "0.0035 BNB ($2.80)");
      
      const tx = await state.contract.stake(amountWei);
      await tx.wait();

      showToast("Staked successfully!", "success");
      onStakeEvent(amount); // Trigger portal animation
      await updateStakingData();
      checkAchievements();
      hideTransactionModal();
    } catch (err) {
      showToast("Staking failed: " + err.message, "error");
      hideTransactionModal();
    }
  }

  async function unstakeTokens() {
    const amount = parseFloat(elements.stakeAmount.value);
    if (!amount || amount <= 0) {
      return showError("Enter a valid unstake amount.");
    }

    try {
      showStatus("Unstaking...", "status-success");
      showTransactionModal("Unstaking", "Unstaking KLY tokens", "0.0035 BNB ($2.80)");
      
      const amountWei = ethers.utils.parseUnits(amount.toString(), state.decimals);
      const tx = await state.contract.unstake(amountWei);
      await tx.wait();
      
      showToast("Unstaked successfully!", "success");
      await updateStakingData();
      checkAchievements();
      hideTransactionModal();
    } catch (err) {
      showToast("Unstaking failed: " + err.message, "error");
      hideTransactionModal();
    }
  }

  async function claimRewards() {
    try {
      showStatus("Claiming rewards...", "status-success");
      showTransactionModal("Claim Rewards", "Claiming staking rewards", "0.0035 BNB ($2.80)");
      
      const tx = await state.contract.claim();
      await tx.wait();
      
      showToast("Rewards claimed!", "success");
      await updateStakingData();
      hideTransactionModal();
    } catch (err) {
      showToast("Claim failed: " + err.message, "error");
      hideTransactionModal();
    }
  }

  async function mintNFT() {
    try {
      showStatus("Minting NFT...", "status-success");
      showTransactionModal("Mint NFT", "Minting Ascender NFT", "0.005 BNB ($4.00)");
      
      // Simulate NFT minting (replace with actual contract call)
      await new Promise(resolve => setTimeout(resolve, 3000));
      
      // Generate random NFT attributes
      const rarities = ["Common", "Uncommon", "Rare", "Epic", "Legendary"];
      const tiers = ["1", "2", "3", "4", "5"];
      const randomRarity = rarities[Math.floor(Math.random() * rarities.length)];
      const randomTier = tiers[Math.floor(Math.random() * tiers.length)];
      
      // Update UI with new NFT
      elements.nftName.textContent = `Ascender #${Math.floor(Math.random() * 10000)}`;
      elements.nftRarity.textContent = randomRarity;
      elements.nftTier.textContent = randomTier;
      
      // Generate random color for NFT image
      const colors = ["00ffe7", "ff00aa", "aa00ff", "00aaff", "ff6b00", "fff000"];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      elements.nftImage.src = `https://via.placeholder.com/150/000000/${randomColor}?text=KLY+NFT`;
      
      // Generate random attributes
      elements.nftAttributes.innerHTML = '';
      const attributes = ["Power", "Speed", "Intelligence", "Luck", "Charisma"];
      attributes.forEach(attr => {
        const value = Math.floor(Math.random() * 100);
        const attributeEl = document.createElement('div');
        attributeEl.className = 'nft-attribute';
        attributeEl.textContent = `${attr}: ${value}`;
        elements.nftAttributes.appendChild(attributeEl);
      });
      
      showToast("NFT minted successfully!", "success");
      checkAchievements();
      hideTransactionModal();
    } catch (err) {
      showToast("Minting failed: " + err.message, "error");
      hideTransactionModal();
    }
  }

  function checkAchievements() {
    // In a real app, you would check on-chain data for these conditions
    const stakedAmount = parseFloat(elements.stakedValue.textContent) || 0;
    const stakingDays = Math.floor(Math.random() * 60); // Simulate random staking days
    const nftCount = Math.floor(Math.random() * 10); // Simulate random NFT count
    
    achievements.forEach(ach => {
      if (!ach.earned && ach.condition(stakedAmount, stakingDays, nftCount)) {
        ach.earned = true;
        unlockAchievement(ach);
      }
    });
  }

  function unlockAchievement(achievement) {
    const badges = document.querySelectorAll('.achievement-badge');
    const badge = badges[achievement.id - 1];
    
    if (badge) {
      badge.classList.remove('locked');
      badge.querySelector('i').style.color = "var(--neon-green)";
      badge.querySelector('h4').style.color = "var(--neon-green)";
      
      showToast(`Achievement Unlocked: ${achievement.name}`, "success");
      
      // Add animation
      gsap.fromTo(badge, 
        { scale: 0.8, opacity: 0.5 },
        { scale: 1.1, opacity: 1, duration: 0.5, ease: "back.out" }
      );
      
      gsap.to(badge, {
        boxShadow: "0 0 20px var(--neon-green)",
        duration: 0.5,
        yoyo: true,
        repeat: 1
      });
    }
  }

  function showTransactionModal(type, description, fee) {
    elements.txType.textContent = type;
    elements.txFee.textContent = fee;
    elements.txModal.classList.add('active');
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
      progress += 5;
      elements.txProgress.style.width = `${Math.min(progress, 90)}%`;
      if (progress >= 90) clearInterval(interval);
    }, 200);
  }

  function updateTransactionModal(type, description, fee) {
    elements.txType.textContent = type;
    elements.txFee.textContent = fee;
    elements.txProgress.style.width = "0%";
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
      progress += 5;
      elements.txProgress.style.width = `${Math.min(progress, 90)}%`;
      if (progress >= 90) clearInterval(interval);
    }, 200);
  }

  function hideTransactionModal() {
    elements.txModal.classList.remove('active');
    elements.txProgress.style.width = "0%";
  }

  // Toast helper
  function showToast(message, type = "success") {
    const container = document.getElementById("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast ${type} show`;
    toast.innerHTML = `
      <span class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i></span>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  function showStatus(msg, type = "status-success") {
    elements.transactionStatus.textContent = msg;
    elements.transactionStatus.className = `status-message ${type}`;
  }

  function showError(msg) {
    elements.transactionStatus.textContent = msg;
    elements.transactionStatus.className = "status-message status-error";
  }

  function setupListeners() {
    // Wallet connection
    elements.connectWallet.addEventListener("click", connectWallet);
    elements.disconnectWallet.addEventListener("click", () => window.location.reload());
    elements.metamaskBtn.addEventListener("click", connectWallet);
    
    // Staking actions
    elements.stakeBtn.addEventListener("click", stakeTokens);
    elements.unstakeBtn.addEventListener("click", unstakeTokens);
    elements.claimBtn.addEventListener("click", claimRewards);
    
    // NFT actions
    elements.mintBtn.addEventListener("click", mintNFT);
    
    // Max button
    elements.maxBtn.addEventListener("click", () => {
      elements.stakeAmount.value = state.tokenBalance;
    });
    
    // Mobile menu
    elements.mobileMenuBtn.addEventListener("click", () => {
      elements.navLinks.classList.toggle('active');
    });
    
    // Transaction modal
    elements.closeModal.addEventListener("click", hideTransactionModal);
    elements.cancelTx.addEventListener("click", hideTransactionModal);
    elements.confirmTx.addEventListener("click", () => {
      elements.txProgress.style.width = "100%";
      setTimeout(hideTransactionModal, 1000);
    });
    
    // Close modal when clicking outside
    elements.txModal.addEventListener("click", (e) => {
      if (e.target === elements.txModal) {
        hideTransactionModal();
      }
    });
  }

  // Initialize particles
  function initParticles() {
    const container = document.getElementById('particles');
    const particleCount = 100;
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      
      // Random properties
      const size = Math.random() * 5 + 1;
      const posX = Math.random() * 100;
      const delay = Math.random() * 10;
      const duration = Math.random() * 20 + 10;
      
      particle.style.width = `${size}px`;
      particle.style.height = `${size}px`;
      particle.style.left = `${posX}%`;
      particle.style.animationDelay = `${delay}s`;
      particle.style.animationDuration = `${duration}s`;
      
      // Random neon color
      const colors = ['--neon-green', '--neon-purple', '--neon-pink', '--neon-blue'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      particle.style.background = `var(${randomColor})`;
      
      container.appendChild(particle);
    }
  }

  window.addEventListener("load", () => {
    initParticles();
    setupListeners();
    
    if (window.ethereum) {
      // Check if wallet is already connected
      window.ethereum.request({ method: 'eth_accounts' })
        .then(accounts => {
          if (accounts.length > 0) {
            connectWallet();
          }
        });
      
      // Handle account changes
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          // Wallet disconnected
          window.location.reload();
        } else {
          // Account changed
          state.address = accounts[0];
          updateStakingData();
        }
      });
      
      // Handle chain changes
      window.ethereum.on('chainChanged', () => {
        window.location.reload();
      });
    } else {
      showError("MetaMask or Web3 wallet not detected.");
      elements.metamaskFallback.style.display = "none";
    }
  });
</script>
</body>
</html>
