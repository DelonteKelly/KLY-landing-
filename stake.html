<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KLY Advanced Staking Vault</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@0.5.24/dist/vanta.net.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary:#00f0ff; --secondary:#7b2dff; --accent:#ff2d7b; --bg-dark:#0a0a20; --bg-light:#1a1a3a; --panel-glow:0 0 15px rgba(0,240,255,.3); --text-glow:0 0 8px rgba(0,240,255,.7); }
    html,body{margin:0;padding:0;overflow-x:hidden;background:radial-gradient(ellipse at center,var(--bg-dark) 0%,#000 100%);font-family:'Rajdhani',sans-serif;color:#fff;scrollbar-width:none}
    body::-webkit-scrollbar{display:none}
    #app-container{width:100vw;min-height:100vh;display:grid;grid-template-columns:1fr 1fr;position:relative;overflow:hidden}
    #vanta-bg{position:fixed;inset:0;z-index:-1;opacity:.7}
    #visualization-container{position:relative;width:100%;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
    #holographic-display{width:80%;height:80%;position:relative;border-radius:16px;background:radial-gradient(circle,rgba(0,240,255,.05) 0%,rgba(0,240,255,0) 70%);box-shadow:0 0 100px rgba(0,240,255,.1);display:flex;flex-direction:column;padding:2rem}
    #holographic-display::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(120deg,transparent,rgba(0,240,255,.1),transparent);transform:rotate(25deg);animation:shine 8s linear infinite;pointer-events:none}
    .vault-charge-cell{position:relative;overflow:visible}
    .orb-container{position:relative;width:80px;height:80px;margin:0 auto;display:flex;align-items:center;justify-content:center}
    .pulse-orb{width:60px;height:60px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(0,240,255,.8) 0%,rgba(123,45,255,.6) 70%);box-shadow:0 0 20px rgba(0,240,255,.5),0 0 40px rgba(123,45,255,.3);animation:orb-pulse 2s infinite alternate;position:relative}
    .pulse-orb::before{content:'';position:absolute;inset:-10px;border-radius:50%;border:2px solid rgba(0,240,255,.3);animation:orb-ripple 3s infinite}
    .pulse-orb::after{content:'';position:absolute;inset:-5px;border-radius:50%;border:1px solid rgba(255,45,123,.3);animation:orb-ripple 3s infinite .5s}
    .charge-level{position:absolute;font-family:'Orbitron',sans-serif;font-weight:bold;color:#fff;text-shadow:0 0 10px var(--primary);font-size:1.2rem;z-index:2}
    .pulse-orb.low-charge{background:radial-gradient(circle at 30% 30%,rgba(255,45,123,.8) 0%,rgba(255,100,45,.6) 70%);box-shadow:0 0 20px rgba(255,45,123,.5),0 0 40px rgba(255,100,45,.3)}
    .pulse-orb.medium-charge{background:radial-gradient(circle at 30% 30%,rgba(255,215,0,.8) 0%,rgba(255,140,0,.6) 70%);box-shadow:0 0 20px rgba(255,215,0,.5),0 0 40px rgba(255,140,0,.3)}
    .pulse-orb.high-charge{background:radial-gradient(circle at 30% 30%,rgba(0,240,255,.8) 0%,rgba(123,45,255,.6) 70%);box-shadow:0 0 20px rgba(0,240,255,.5),0 0 40px rgba(123,45,255,.3)}
    .chart-container{position:relative;width:100%;height:60%;margin-bottom:1rem}
    .data-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:auto}
    .data-cell{background:rgba(0,240,255,.05);border:1px solid rgba(0,240,255,.2);border-radius:8px;padding:1rem;text-align:center;transition:all .4s cubic-bezier(.175,.885,.32,1.275)}
    .data-cell:hover{transform:translateY(-5px) scale(1.02);box-shadow:0 10px 25px rgba(0,240,255,.3),inset 0 0 15px rgba(0,240,255,.2)}
    .data-label{display:block;font-size:.8rem;color:rgba(255,255,255,.7);margin-bottom:.5rem;text-transform:uppercase}
    .data-value{font-family:'Orbitron',sans-serif;color:var(--primary);font-size:1.2rem;text-shadow:var(--text-glow)}
    .control-panel{padding:2rem;display:flex;flex-direction:column;justify-content:center;z-index:10;overflow-y:auto;height:100vh;background:rgba(10,10,32,.7);backdrop-filter:blur(10px);border-left:1px solid rgba(0,240,255,.2)}
    .panel-section{background:linear-gradient(145deg,rgba(26,26,58,.7) 0%,rgba(10,10,32,.9) 100%);border:1px solid rgba(0,240,255,.2);border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:var(--panel-glow);position:relative;overflow:hidden}
    .panel-section::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(to bottom right,transparent 0%,rgba(0,240,255,.05) 50%,transparent 100%);transform:rotate(30deg);animation:shine 6s infinite linear}
    h1,h2{margin-top:0;font-family:'Orbitron',sans-serif;text-transform:uppercase;letter-spacing:2px}
    h1{font-size:2.5rem;background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:var(--text-glow);margin-bottom:1.5rem;font-weight:900}
    h2{color:var(--primary);font-size:1.5rem;margin-bottom:1.5rem;position:relative;display:inline-block}
    h2::after{content:'';position:absolute;bottom:-8px;left:0;width:100%;height:2px;background:linear-gradient(90deg,var(--primary),transparent)}
    .balance-display{font-size:1.5rem;margin:1.5rem 0;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .balance-display span{font-family:'Orbitron',sans-serif;color:var(--primary);font-size:1.8rem}
    .slider-container{position:relative;margin:1.5rem 0}
    input[type="range"]{width:100%;-webkit-appearance:none;height:12px;background:rgba(0,240,255,.1);border-radius:6px;outline:none;margin:1rem 0;border:1px solid rgba(0,240,255,.3)}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;background:var(--primary);border-radius:50%;cursor:pointer;box-shadow:0 0 10px var(--primary),0 0 20px var(--primary);border:2px solid #fff;transform:scale(1);transition:transform .2s ease}
    .slider-labels{display:flex;justify-content:space-between;font-family:'Orbitron',sans-serif;color:rgba(255,255,255,.7);font-size:.9rem}
    .stake-button{padding:1.2rem 2.5rem;background:linear-gradient(45deg,var(--primary),var(--secondary));border:none;font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:bold;color:#000;cursor:pointer;border-radius:12px;box-shadow:0 0 20px rgba(0,240,255,.5);transition:all .3s ease;margin:1rem 0;text-transform:uppercase;letter-spacing:1px;position:relative;overflow:hidden;width:100%;z-index:1}
    .button-group{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    .stake-button::after{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;animation:borderMove 3s linear infinite}
    @keyframes borderMove{0%{background-position:0% 50%}100%{background-position:100% 50%}}
    .status-message{min-height:24px;color:var(--accent);margin-top:1rem;text-align:center;font-family:'Orbitron',sans-serif;font-size:.9rem}
    .connection-status{position:absolute;top:2rem;right:2rem;display:flex;align-items:center;font-family:'Orbitron',sans-serif;font-size:.9rem;color:var(--primary);z-index:100}
    .connection-dot{width:10px;height:10px;border-radius:50%;background:#ff2d7b;margin-right:8px;animation:pulse 2s infinite}
    .network-indicator{position:absolute;top:2rem;left:2rem;background:rgba(0,240,255,.2);padding:.5rem 1rem;border-radius:20px;font-family:'Orbitron',sans-serif;font-size:.8rem;color:var(--primary);border:1px solid rgba(0,240,255,.5)}
    .modal-overlay{position:fixed;inset:0;background:rgba(10,10,32,.9);backdrop-filter:blur(6px);z-index:999;display:flex;align-items:center;justify-content:center}
    .modal-box{background:#111930;border:1px solid var(--primary);box-shadow:0 0 20px rgba(0,240,255,.4);border-radius:16px;padding:2rem;max-width:400px;text-align:center;font-family:'Orbitron',sans-serif}
    .modal-actions{display:flex;justify-content:space-between;margin-top:2rem;gap:1rem}
    @keyframes shine{0%{transform:translateX(-100%) rotate(30deg)}100%{transform:translateX(100%) rotate(30deg)}}
    @keyframes orb-pulse{0%{transform:scale(1);box-shadow:0 0 20px rgba(0,240,255,.5)}100%{transform:scale(1.05);box-shadow:0 0 30px rgba(0,240,255,.8)}}
    @keyframes orb-ripple{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
    @keyframes pulse{0%{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}100%{opacity:.5;transform:scale(1)}}
    @keyframes orb-glow{0%,100%{box-shadow:0 0 15px rgba(0,240,255,.4),0 0 30px rgba(0,240,255,.6)}50%{box-shadow:0 0 25px rgba(0,240,255,.8),0 0 40px rgba(123,45,255,.4)}}
    .orb-glow{animation-name:orb-glow;animation-timing-function:ease-in-out;animation-iteration-count:infinite}
    @media (max-width:1024px){#app-container{grid-template-columns:1fr;grid-template-rows:50vh auto}.control-panel{height:auto;border-left:none;border-top:1px solid rgba(0,240,255,.2)}#visualization-container{height:50vh}}
    @media (max-width:768px){h1{font-size:2rem}.panel-section{padding:1.5rem}.button-group{grid-template-columns:1fr}.data-grid{grid-template-columns:1fr}.orb-container{width:60px;height:60px}.pulse-orb{width:50px;height:50px}}
  </style>
</head>
<body>
  <div id="vanta-bg"></div>
  <div id="app-container">
    <div id="visualization-container">
      <div id="holographic-display">
        <div class="chart-container"><canvas id="stakeChart"></canvas></div>
        <div class="data-grid">
          <div class="data-cell vault-charge-cell">
            <span class="data-label">VAULT CHARGE</span>
            <div class="orb-container">
              <div class="pulse-orb" id="vaultChargeOrb"></div>
              <div class="charge-level" id="chargeLevel">0%</div>
            </div>
          </div>
          <div class="data-cell">
            <span class="data-label">TOTAL STAKED</span>
            <span class="data-value" id="visual-total">0 KLY</span>
          </div>
          <div class="data-cell">
            <span class="data-label">YOUR SHARE</span>
            <span class="data-value" id="visual-share">0%</span>
          </div>
        </div>
      </div>
      <div class="network-indicator" id="network-indicator">NETWORK: DISCONNECTED</div>
    </div>

    <div class="control-panel">
      <div class="connection-status" id="connection-status">
        <div class="connection-dot"></div>
        <span id="walletAddress">DISCONNECTED</span>
      </div>

      <div class="panel-section">
        <h1><i class="fas fa-vault"></i> KLY STAKING VAULT</h1>
        <div class="balance-display">WALLET BALANCE: <span id="wallet-balance">0</span> KLY</div>
      </div>

      <div class="panel-section">
        <h2><i class="fas fa-coins"></i> STAKE TOKENS</h2>
        <div class="slider-container">
          <input type="range" id="stake-slider" min="0" max="100" value="50" step="1">
          <div class="slider-labels"><span>0%</span><span>100%</span></div>
        </div>
        <div class="reward-counter"><span id="apy-display">‚Äî</span></div>
        <button id="connectWalletBtn" class="stake-button"><i class="fas fa-wallet"></i> Connect Wallet</button>
        <div class="status-message" id="status-message"></div>
      </div>

      <div class="balance-display">STAKE AMOUNT: <span id="calculated-stake">0</span> KLY</div>
      <button id="stake-button" class="stake-button"><i class="fas fa-lock"></i> STAKE</button>

      <div class="panel-section">
        <h2><i class="fas fa-chart-line"></i> YOUR POSITION</h2>
        <div class="balance-display">STAKED: <span id="staked-amount">0</span> KLY</div>
        <div class="balance-display">REWARDS: <span id="reward-amount">0</span> KLY</div>
        <div class="button-group">
          <button id="claim-button" class="stake-button" disabled><i class="fas fa-gift"></i> CLAIM</button>
          <button id="withdraw-button" class="stake-button" disabled><i class="fas fa-wallet"></i> WITHDRAW</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stake Confirmation Modal -->
  <div id="stakeModal" style="display:none;" class="modal-overlay">
    <div class="modal-box">
      <h2>Confirm Stake</h2>
      <p>You are about to stake <strong><span id="modal-stake-amount">0</span> KLY</strong>.</p>
      <div class="modal-actions">
        <button id="confirmStakeBtn" class="stake-button">Confirm</button>
        <button id="cancelStakeBtn" class="stake-button" style="background:#333;color:#fff;">Cancel</button>
      </div>
    </div>
  </div>

<script>
/** ---------- CONFIG (Real Contracts) ---------- **/
const CHAIN_HEX = '0x38'; // BNB Mainnet (56)
const KLY_TOKEN_ADDRESS = "0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52";
const STAKING_CONTRACT_ADDRESS = "0x7bBa73C25cf5384b58DBA280eCB49c9749437823";

/** ---------- ABIs ---------- **/
const KLY_TOKEN_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)"
];

const STAKING_ABI = [
  // actions
  "function stake(uint256 amount) external",
  "function withdraw(uint256 amount) external",
  "function claimRewards() external",
  "function getReward() external",
  "function exit() external",
  // views (fallbacks)
  "function getStaked(address) view returns (uint256)",
  "function stakedBalanceOf(address) view returns (uint256)",
  "function balanceOf(address) view returns (uint256)",
  "function totalStaked() view returns (uint256)",
  "function totalSupply() view returns (uint256)",
  "function earned(address) view returns (uint256)",
  "function rewards(address) view returns (uint256)",
  "function rewardRate() view returns (uint256)"
];

let provider, signer, userAddress, klyToken, stakingContract;
let decimals = 18, symbol = "KLY";
let stakeChart, cachedStakeAmount = ethers.constants.Zero;

/** ---------- UI Helpers ---------- **/
function showStatus(msg){
  const el = document.getElementById('status-message');
  el.textContent = msg; el.style.opacity = 1;
  setTimeout(()=>{el.style.opacity=0; el.textContent="";}, 3500);
}
function short(addr){ return addr ? `${addr.slice(0,6)}...${addr.slice(-4)}` : ""; }
function setConnectedUI(isOn){
  document.getElementById('stake-slider').disabled   = !isOn;
  document.getElementById('stake-button').disabled   = !isOn;
  document.getElementById('claim-button').disabled   = !isOn;
  document.getElementById('withdraw-button').disabled= !isOn;
  if(!isOn){
    document.getElementById('calculated-stake').textContent = "0";
    document.getElementById('wallet-balance').textContent   = "0";
    document.getElementById('staked-amount').textContent    = "0";
    document.getElementById('reward-amount').textContent    = "0";
  }
}
function formatKLYSafe(bn){
  try{
    const n = Number(ethers.utils.formatUnits(bn||0, decimals||18));
    if(!isFinite(n)) return "0";
    return n.toLocaleString(undefined,{maximumFractionDigits:6});
  }catch{ return "0"; }
}

/** ---------- Connect (mobile-safe) ---------- **/
async function connectWallet(){
  if(!window.ethereum){ showStatus("‚ö†Ô∏è Open this page in a Web3 wallet (MetaMask / Trust)."); return; }

  try{
    // Some mobile wallets require accounts first
    const accounts = await ethereum.request({ method:'eth_requestAccounts' });
    if(!accounts || !accounts.length) throw new Error("No accounts");
    userAddress = accounts[0];

    // Try to switch chain; if wallet doesn't support, continue
    const cid = await ethereum.request({ method:'eth_chainId' });
    if(cid !== CHAIN_HEX){
      try{
        await ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: CHAIN_HEX }] });
      }catch(e){
        if(!(e && (e.code===4902 || e.code===-32601))){
          throw e;
        }
        showStatus("‚ö†Ô∏è Make sure you're on BNB Chain (56).");
      }
    }

    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer   = provider.getSigner();
    klyToken = new ethers.Contract(KLY_TOKEN_ADDRESS, KLY_TOKEN_ABI, signer);
    stakingContract = new ethers.Contract(STAKING_CONTRACT_ADDRESS, STAKING_ABI, signer);

    // Token meta (non-blocking)
    try{
      const meta = await Promise.all([klyToken.decimals().catch(()=>18), klyToken.symbol().catch(()=> "KLY")]);
      decimals = meta[0]; symbol = meta[1];
    }catch{}

    document.getElementById('walletAddress').textContent = short(userAddress);
    document.getElementById('connection-status').classList.add('connected');
    document.getElementById('network-indicator').textContent = "NETWORK: BSC MAINNET";

    setConnectedUI(true);
    initChart();
    await refreshAll();

    ethereum.on("accountsChanged", ()=> window.location.reload());
    ethereum.on("chainChanged",   ()=> window.location.reload());
  }catch(err){
    const msg = err?.code===4001 ? "Request rejected" : (err?.message || "Connect failed");
    showStatus("Connection failed: " + msg);
    console.error(err);
  }
}

/** ---------- Chart ---------- **/
function initChart(){
  const ctx = document.getElementById('stakeChart').getContext('2d');
  stakeChart = new Chart(ctx,{
    type:'doughnut',
    data:{ labels:['Your Stake','Other Stakers'], datasets:[{ data:[0.0001,100], borderWidth:1, cutout:'70%'}] },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:'bottom', labels:{ color:'#fff', font:{ family:'Rajdhani', size:12 }}} },
      animation:{ animateScale:true, animateRotate:true }
    }
  });
}

/** ---------- View call helper ---------- **/
async function callView(fnNames, args=[], def=ethers.constants.Zero){
  for(const n of fnNames){
    if(!stakingContract[n]) continue;
    try{ return await stakingContract[n](...args); }catch{}
  }
  return def;
}

/** ---------- Reads ---------- **/
async function getYourStaked(){ return callView(["getStaked","stakedBalanceOf","balanceOf"], [userAddress]); }
async function getTotalStaked(){ return callView(["totalStaked","totalSupply"], []); }
async function getRewards(){ return callView(["earned","rewards"], [userAddress]); }
async function getAPYDisplay(){
  const r = await callView(["rewardRate"], [], null);
  document.getElementById('apy-display').textContent = (!r || r.eq?.(0)) ? "‚Äî" : "variable";
}

async function updateVisualization(){
  const [yourStake,totalStaked] = await Promise.all([getYourStaked(), getTotalStaked()]);
  const yourF  = Number(ethers.utils.formatUnits(yourStake, decimals||18)) || 0;
  const otherF = Math.max(Number(ethers.utils.formatUnits(totalStaked.sub(yourStake), decimals||18)) || 0, 0);

  stakeChart.data.datasets[0].data = [yourF<=0?0.0001:yourF, otherF<=0?0.0001:otherF];
  stakeChart.update();

  document.getElementById('visual-total').textContent = `${formatKLYSafe(totalStaked)} ${symbol}`;
  const share = totalStaked.gt(0) ? yourStake.mul(10000).div(totalStaked).toNumber()/100 : 0;
  document.getElementById('visual-share').textContent = `${share.toFixed(2)}%`;
}

async function updateVaultCharge(){
  const [sBN,tBN,rBN] = await Promise.all([getYourStaked(), getTotalStaked(), getRewards()]);
  const s = Number(ethers.utils.formatUnits(sBN, decimals||18))||0;
  const t = Number(ethers.utils.formatUnits(tBN, decimals||18))||0;
  const r = Number(ethers.utils.formatUnits(rBN, decimals||18))||0;
  const share = t>0 ? (s/t)*100 : 0;
  const chargePercent = Math.min(100, Math.floor((Math.log1p(s)*15) + (share*0.7) + (s>0?(r/s)*100:0)));

  const orb = document.getElementById('vaultChargeOrb');
  const display = document.getElementById('chargeLevel');
  display.textContent = `${isFinite(chargePercent) ? chargePercent : 0}%`;

  orb.className = 'pulse-orb';
  if (chargePercent < 30) orb.classList.add('low-charge');
  else if (chargePercent < 70) orb.classList.add('medium-charge');
  else orb.classList.add('high-charge');

  const duration = Math.max(0.8, 3 - (chargePercent/50));
  orb.style.animationDuration = `${duration}s`;
  orb.classList.add('orb-glow');
}

async function updateBalances(){
  if(!userAddress || !klyToken) return;
  const [bal, staked, rewards] = await Promise.all([klyToken.balanceOf(userAddress), getYourStaked(), getRewards()]);
  document.getElementById('wallet-balance').textContent = formatKLYSafe(bal);
  document.getElementById('staked-amount').textContent  = formatKLYSafe(staked);
  document.getElementById('reward-amount').textContent  = formatKLYSafe(rewards);
  document.getElementById('claim-button').disabled   = rewards.eq(0);
  document.getElementById('withdraw-button').disabled= staked.eq(0);
}

async function refreshAll(){ await Promise.all([updateBalances(), updateVisualization(), updateVaultCharge(), getAPYDisplay()]); }

/** ---------- Actions ---------- **/
async function updateStakeAmount(){
  if(!userAddress || !klyToken){ document.getElementById('calculated-stake').textContent="0"; return; }
  try{
    const percent = parseInt(document.getElementById('stake-slider').value||"0", 10);
    const rawBal  = await klyToken.balanceOf(userAddress);
    const stake   = rawBal.mul(percent).div(100);
    document.getElementById('calculated-stake').textContent = formatKLYSafe(stake);
  }catch{
    document.getElementById('calculated-stake').textContent="0";
  }
}

async function stakeTokens(){
  if(!userAddress) return showStatus("Connect wallet first");
  const percent = parseInt(document.getElementById('stake-slider').value||"0",10);
  const rawBal  = await klyToken.balanceOf(userAddress);
  cachedStakeAmount = rawBal.mul(percent).div(100);
  if(cachedStakeAmount.eq(0)) return showStatus("Choose an amount > 0");
  document.getElementById('modal-stake-amount').textContent = formatKLYSafe(cachedStakeAmount);
  document.getElementById('stakeModal').style.display = "flex";
}

async function confirmStakeExecution(){
  const btn = document.getElementById('confirmStakeBtn');
  try{
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing';
    const allowance = await klyToken.allowance(userAddress, STAKING_CONTRACT_ADDRESS);
    if(allowance.lt(cachedStakeAmount)){
      const aTx = await klyToken.approve(STAKING_CONTRACT_ADDRESS, ethers.constants.MaxUint256);
      await aTx.wait();
    }
    const tx = await stakingContract.stake(cachedStakeAmount);
    await tx.wait();
    showStatus("‚úÖ Stake successful");
    await refreshAll();
  }catch(err){
    console.error(err);
    showStatus("‚ö†Ô∏è Staking failed: " + (err?.reason || err?.message || "Unknown error"));
  }finally{
    document.getElementById('stakeModal').style.display = "none";
    btn.disabled=false; btn.innerHTML='Confirm';
  }
}

async function claimRewards(){
  const btn = document.getElementById('claim-button');
  try{
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Claiming';
    let tx;
    if(stakingContract.claimRewards){
      try{ tx = await stakingContract.claimRewards(); }
      catch{ tx = await stakingContract.getReward(); }
    }else{ tx = await stakingContract.getReward(); }
    await tx.wait();
    showStatus("üéâ Rewards claimed");
    await refreshAll();
  }catch(err){
    console.error(err);
    showStatus("‚ö†Ô∏è Claim failed: " + (err?.reason||err?.message||"Unknown error"));
  }finally{
    btn.disabled=false; btn.innerHTML='<i class="fas fa-gift"></i> CLAIM';
  }
}

async function withdrawTokens(){
  const btn = document.getElementById('withdraw-button');
  try{
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Withdrawing';
    const staked = await getYourStaked();
    if(staked.eq(0)){ showStatus("Nothing to withdraw"); return; }
    const tx = await stakingContract.withdraw(staked);
    await tx.wait();
    showStatus("üèÅ Withdrawal complete");
    await refreshAll();
  }catch(err){
    console.error(err);
    showStatus("‚ö†Ô∏è Withdrawal failed: " + (err?.reason||err?.message||"Unknown error"));
  }finally{
    btn.disabled=false; btn.innerHTML='<i class="fas fa-wallet"></i> WITHDRAW';
  }
}

/** ---------- Boot ---------- **/
window.onload = function(){
  // Start with disabled controls
  setConnectedUI(false);

  // Vanta bg
  VANTA.NET({ el:"#vanta-bg", color:0x00f0ff, backgroundColor:0x0a0a20, points:12.0, maxDistance:19.0, spacing:14.0 });

  // Listeners
  document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
  document.getElementById('stake-slider').addEventListener('input', updateStakeAmount);
  document.getElementById('stake-button').addEventListener('click', stakeTokens);
  document.getElementById('confirmStakeBtn').addEventListener('click', confirmStakeExecution);
  document.getElementById('cancelStakeBtn').addEventListener('click', ()=>{ document.getElementById('stakeModal').style.display="none"; });
  document.getElementById('claim-button').addEventListener('click', claimRewards);
  document.getElementById('withdraw-button').addEventListener('click', withdrawTokens);

  // Periodic pulse
  setInterval(()=>{ if(userAddress) updateVaultCharge(); }, 30000);
};
</script>
</body>
</html>
