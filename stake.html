<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KLY Stake — Web3 Staking Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- === Web3 libs (add inside <head>) === -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>

  <style>
    :root{
      --primary:#7c3aed;--primary-dark:#6d28d9;--secondary:#10b981;
      --dark:#1e293b;--darker:#0f172a;--light:#f8fafc;--gray:#9aa7bd;
      --danger:#ef4444;--warning:#f59e0b;--radius:12px;
      --shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --transition:all .3s ease
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    body{background:var(--darker);color:var(--light);line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:rgba(15,23,42,.8);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.08)}
    .navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;gap:1rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:10px;font-size:1.4rem;font-weight:700}
    .logo-icon{color:var(--primary);font-size:1.6rem}
    .nav-links{display:flex;gap:1.25rem;flex-wrap:wrap}
    .nav-links a{color:var(--gray);text-decoration:none;font-weight:600;transition:var(--transition)}
    .nav-links a:hover,.nav-links a.active{color:var(--light)}
    .wallet-connect{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;padding:.7rem 1.1rem;border-radius:var(--radius);font-weight:700;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px}
    .wallet-connect:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .wallet-connected{background:var(--dark);display:none;align-items:center;gap:10px;padding:.6rem 1rem;border-radius:var(--radius)}
    .wallet-address{font-size:.9rem;background:rgba(255,255,255,.1);padding:.25rem .6rem;border-radius:20px}
    .hero{padding:3.5rem 0;text-align:center;background:radial-gradient(circle at top, rgba(124,58,237,.12), transparent 70%)}
    .hero h1{font-size:3rem;margin-bottom:.75rem;background:linear-gradient(to right,#7c3aed,#10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero p{font-size:1.1rem;color:var(--gray);max-width:700px;margin:0 auto 1.5rem}
    .stats{display:flex;justify-content:center;gap:1.25rem;margin-top:1.25rem;flex-wrap:wrap}
    .stat-card{background:var(--dark);padding:1rem;border-radius:var(--radius);min-width:180px;box-shadow:var(--shadow)}
    .stat-value{font-size:1.6rem;font-weight:800;color:var(--primary)}
    .stat-label{color:var(--gray);font-size:.9rem}
    .dashboard{padding:2.5rem 0}
    .section-title{text-align:center;font-size:1.8rem;margin-bottom:1.5rem}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}
    .card{background:var(--dark);border-radius:var(--radius);padding:1.25rem;box-shadow:var(--shadow);transition:var(--transition)}
    .card:hover{transform:translateY(-4px)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.1rem}
    .card-title{font-size:1.15rem;font-weight:700}
    .card-icon{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem}
    .bg-primary{background:rgba(124,58,237,.2);color:var(--primary)}
    .bg-success{background:rgba(16,185,129,.2);color:var(--secondary)}
    .bg-warning{background:rgba(245,158,11,.2);color:var(--warning)}
    .stake-amount{font-size:1.7rem;font-weight:800;margin:.7rem 0}
    .apy-badge{background:var(--secondary);color:#fff;padding:.25rem .7rem;border-radius:20px;font-size:.9rem;font-weight:700;display:inline-block;margin-bottom:.6rem}
    .progress-bar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;margin:1rem 0;overflow:hidden}
    .progress{height:100%;background:linear-gradient(to right,var(--primary),var(--secondary));border-radius:4px;width:0%}
    .btn{padding:.8rem 1.1rem;border-radius:var(--radius);font-weight:800;cursor:pointer;transition:var(--transition);border:none;width:100%;margin-top:.7rem}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .btn-outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
    .btn-outline:hover{background:rgba(124,58,237,.12)}
    .tiers{padding:2.5rem 0;background:rgba(15,23,42,.5)}
    .tiers-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}
    .tier-card{position:relative;background:var(--dark);border-radius:var(--radius);padding:1.5rem;text-align:center;box-shadow:var(--shadow);transition:var(--transition);border:1px solid transparent}
    .tier-card.featured{border-color:var(--primary);transform:scale(1.03)}
    .tier-card:hover{transform:translateY(-4px)}
    .tier-name{font-size:1.3rem;font-weight:800;margin-bottom:.6rem}
    .tier-apy{font-size:2rem;font-weight:800;color:var(--secondary);margin:.6rem 0}
    .tier-requirements{list-style:none;margin:1rem 0}
    .tier-requirements li{padding:.45rem 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .tier-requirements li:last-child{border-bottom:none}
    .tier-badge{background:var(--primary);color:#fff;padding:.25rem .8rem;border-radius:20px;font-size:.8rem;position:absolute;top:-10px;right:16px}
    footer{background:var(--darker);padding:2.5rem 0 1.2rem;margin-top:2rem}
    .footer-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:1.2rem}
    .footer-column h3{font-size:1.05rem;margin-bottom:1rem}
    .footer-links{list-style:none}
    .footer-links li{margin-bottom:.7rem}
    .footer-links a{color:var(--gray);text-decoration:none;transition:var(--transition)}
    .footer-links a:hover{color:var(--light)}
    .social-links{display:flex;gap:.8rem;margin-top:.7rem}
    .social-links a{width:40px;height:40px;border-radius:50%;background:var(--dark);display:flex;align-items:center;justify-content:center;color:var(--gray);transition:var(--transition)}
    .social-links a:hover{background:var(--primary);color:#fff}
    .copyright{text-align:center;padding-top:1rem;border-top:1px solid rgba(255,255,255,.08);color:var(--gray);font-size:.9rem}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--dark);width:90%;max-width:500px;border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-title{font-size:1.25rem;font-weight:800}
    .close-modal{background:none;border:none;color:var(--gray);font-size:1.5rem;cursor:pointer}
    .form-group{margin-bottom:1rem}
    .form-label{display:block;margin-bottom:.4rem;font-weight:700}
    .form-input{width:100%;padding:.75rem 1rem;border-radius:var(--radius);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:var(--light);font-size:1rem}
    .form-input:focus{outline:none;border-color:var(--primary)}
    .balance{font-size:.9rem;color:var(--gray);margin-top:.3rem}
    @media (max-width:768px){
      .hero h1{font-size:2.3rem}
      .tier-card.featured{transform:scale(1)}
    }
    @supports not (backdrop-filter: blur(10px)) {
      header{background:#0f172a;}
    }
    .nav-links a:focus-visible,button:focus-visible,.form-input:focus-visible{outline:2px solid #c7d2fe;outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav class="navbar" aria-label="Main">
        <div class="logo">
          <i class="fas fa-coins logo-icon" aria-hidden="true"></i>
          <span>KLY Stake</span>
        </div>
        <div class="nav-links">
          <a href="#" class="active">Dashboard</a>
          <a href="#">Stake</a>
          <a href="#">Earn</a>
          <a href="#">Governance</a>
          <a href="#">Docs</a>
        </div>
        <button class="wallet-connect" id="connectWallet" type="button" aria-haspopup="dialog">
          <i class="fas fa-wallet" aria-hidden="true"></i> Connect Wallet
        </button>
        <div class="wallet-connected" id="walletInfo" aria-live="polite">
          <i class="fas fa-check-circle" style="color:var(--secondary)" aria-hidden="true"></i>
          <span class="wallet-address" id="walletAddress">—</span>
          <span id="network">BNB Smart Chain</span>
        </div>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Stake KLY, Earn Rewards</h1>
      <p>Non-custodial staking dashboard for the KLY ecosystem on BNB Smart Chain. Connect your wallet to load real data.</p>
      <div class="stats" aria-label="Key metrics">
        <div class="stat-card"><div class="stat-value" id="avgApy">—</div><div class="stat-label">Average APY</div></div>
        <div class="stat-card"><div class="stat-value" id="tvl">—</div><div class="stat-label">Total Value Locked</div></div>
        <div class="stat-card"><div class="stat-value" id="activeStakers">—</div><div class="stat-label">Active Stakers</div></div>
      </div>
    </div>
  </section>

  <section class="dashboard">
    <div class="container">
      <h2 class="section-title">Your Staking Dashboard</h2>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">KLY Staked</h3>
            <div class="card-icon bg-primary"><i class="fas fa-lock"></i></div>
          </div>
          <div class="stake-amount" id="stakedKly">0 KLY</div>
          <div class="apy-badge">APY: <span id="apyCurrent">—</span></div>
          <p>Your staked KLY tokens earn rewards in real time.</p>
          <div class="progress-bar" aria-label="Staking Progress">
            <div class="progress" id="stakeProgress" style="width:0%"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:.9rem;">
            <span>Staking Progress</span><span id="stakeProgressLabel">0%</span>
          </div>
          <button class="btn btn-primary" id="stakeBtn" type="button">Stake KLY</button>
          <button class="btn btn-outline" id="unstakeBtn" type="button">Unstake</button>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">KLY Rewards</h3>
            <div class="card-icon bg-success"><i class="fas fa-gift"></i></div>
          </div>
          <div class="stake-amount" id="rewardsKly">0 KLY</div>
          <div class="apy-badge">Est. Monthly: <span id="rewardsMonthly">—</span></div>
          <p>Your accumulated staking rewards. Claim anytime.</p>
          <div style="margin-top:1.3rem;">
            <div style="display:flex;justify-content:space-between;margin-bottom:.4rem;">
              <span>Last Claim:</span><span id="lastClaim">—</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Next Reward:</span><span id="nextReward">—</span>
            </div>
          </div>
          <button class="btn btn-primary" id="claimBtn" type="button">Claim Rewards</button>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">KLY Vault</h3>
            <div class="card-icon bg-warning"><i class="fas fa-shield-alt"></i></div>
          </div>
          <div class="stake-amount" id="vaultKly">0 KLY</div>
          <div class="apy-badge">Vault Status: <span id="vaultStatus">—</span></div>
          <p>Your tokens remain in your wallet; staking uses contracts on BNB Smart Chain.</p>
          <div style="margin-top:1.1rem;">
            <div style="display:flex;justify-content:space-between;margin-bottom:.4rem;">
              <span>Vault Health:</span><span id="vaultHealth" style="color:var(--secondary)">—</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Time-lock:</span><span id="timelock">—</span>
            </div>
          </div>
          <button class="btn btn-outline" id="vaultBtn" type="button">Vault Details</button>
        </div>
      </div>
    </div>
  </section>

  <section class="tiers">
    <div class="container">
      <h2 class="section-title">Staking Tiers</h2>
      <div class="tiers-grid">
        <div class="tier-card">
          <div class="tier-name">Basic</div>
          <div class="tier-apy" id="tierBasicApy">10% APY</div>
          <ul class="tier-requirements">
            <li>Minimum 100 KLY</li>
            <li>Manual Claiming</li>
            <li>Standard Security</li>
            <li>No Fee Discount</li>
          </ul>
          <button class="btn btn-outline" type="button">Select Tier</button>
        </div>

        <div class="tier-card featured">
          <div class="tier-badge">Most Popular</div>
          <div class="tier-name">Klystron</div>
          <div class="tier-apy" id="tierKlystronApy">15% APY</div>
          <ul class="tier-requirements">
            <li>Minimum 1,000 KLY</li>
            <li>Auto-Compounding</li>
            <li>Enhanced Security</li>
            <li>25% Fee Discount</li>
          </ul>
          <button class="btn btn-primary" type="button">Select Tier</button>
        </div>

        <div class="tier-card">
          <div class="tier-name">Apex</div>
          <div class="tier-apy" id="tierApexApy">18% APY</div>
          <ul class="tier-requirements">
            <li>Minimum 10,000 KLY</li>
            <li>Advanced Features</li>
            <li>Maximum Security</li>
            <li>50% Fee Discount</li>
          </ul>
          <button class="btn btn-outline" type="button">Select Tier</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-column">
          <h3>KLY Stake</h3>
          <p>Non-custodial staking platform for the KLY ecosystem.</p>
          <div class="social-links">
            <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" aria-label="Discord"><i class="fab fa-discord"></i></a>
            <a href="#" aria-label="Telegram"><i class="fab fa-telegram"></i></a>
            <a href="#" aria-label="GitHub"><i class="fab fa-github"></i></a>
          </div>
        </div>
        <div class="footer-column">
          <h3>Platform</h3>
          <ul class="footer-links">
            <li><a href="#">Dashboard</a></li><li><a href="#">Staking</a></li>
            <li><a href="#">Rewards</a></li><li><a href="#">Governance</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Resources</h3>
          <ul class="footer-links">
            <li><a href="#">Documentation</a></li><li><a href="#">API</a></li>
            <li><a href="#">Blog</a></li><li><a href="#">Help Center</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Legal</h3>
          <ul class="footer-links">
            <li><a href="#">Privacy Policy</a></li><li><a href="#">Terms of Service</a></li>
            <li><a href="#">Disclaimer</a></li>
          </ul>
        </div>
      </div>
      <div class="copyright">© <span id="year"></span> KLY Stake. All rights reserved.</div>
    </div>
  </footer>

  <!-- Stake Modal -->
  <div class="modal" id="stakeModal" role="dialog" aria-modal="true" aria-labelledby="stakeTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="stakeTitle">Stake KLY</h3>
        <button class="close-modal" data-close="stakeModal" aria-label="Close">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="stakeAmount">Amount to Stake</label>
        <input class="form-input" id="stakeAmount" placeholder="0.0" inputmode="decimal" />
        <div class="balance">Balance: <span id="klyBalance">0</span> KLY</div>
      </div>
      <div class="form-group">
        <label class="form-label" for="stakeTier">Select Staking Tier</label>
        <select class="form-input" id="stakeTier">
          <option>Basic (10% APY)</option>
          <option selected>Klystron (15% APY)</option>
          <option>Apex (18% APY)</option>
        </select>
      </div>
      <button class="btn btn-primary" id="confirmStake" type="button">Confirm Stake</button>
    </div>
  </div>

  <!-- Unstake Modal -->
  <div class="modal" id="unstakeModal" role="dialog" aria-modal="true" aria-labelledby="unstakeTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="unstakeTitle">Unstake KLY</h3>
        <button class="close-modal" data-close="unstakeModal" aria-label="Close">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="unstakeAmount">Amount to Unstake</label>
        <input class="form-input" id="unstakeAmount" placeholder="0.0" inputmode="decimal" />
        <div class="balance">Staked: <span id="stakedForUnstake">0</span> KLY</div>
      </div>
      <p style="color:var(--warning);font-size:.9rem;"><i class="fas fa-exclamation-triangle"></i> Unstaking initiates a 7-day cooldown before funds are available.</p>
      <button class="btn btn-primary" id="confirmUnstake" type="button">Confirm Unstake</button>
    </div>
  </div>
<script>
// -------- Config --------
const BSC = {
  chainIdHex: '0x38', // 56
  chainIdDec: 56,
  name: 'BNB Smart Chain',
  rpc: 'https://bsc-dataseed.binance.org/',
  explorer: 'https://bscscan.com/'
};

// Your contracts
const TOKEN_ADDR   = '0x2e4fEB2Fe668c8Ebe84f19e6c8fE8Cf8131B4E52'; // KLY ERC-20
const STAKING_ADDR = '0x7bBa73C25cf5384b58DBA280eCB49c9749437823'; // Staking

// Minimal ABIs
const ERC20_ABI = [
  'function decimals() view returns (uint8)',
  'function balanceOf(address) view returns (uint256)',
  'function allowance(address owner, address spender) view returns (uint256)',
  'function approve(address spender, uint256 amount) returns (bool)'
];

const STAKING_ABI = [
  'function stake(uint256 amount) external',
  'function unstake(uint256 amount) external',
  'function claimRewards() external',
  'function stakedBalance(address user) view returns (uint256)',
  'function pendingRewards(address user) view returns (uint256)',
  'function totalStaked() view returns (uint256)',
  // Optional — if your contract exposes these:
  'function timelockSeconds() view returns (uint256)'
];

// -------- DOM helpers --------
const $  = (id)=>document.getElementById(id);
const fmt = (n, d=2)=> {
  if (n === '—' || n == null) return '—';
  const num = Number(n);
  if (!isFinite(num)) return '—';
  return num.toLocaleString(undefined, {maximumFractionDigits:d});
};
function shorten(addr){ return addr ? addr.slice(0,6)+'...'+addr.slice(-4) : '—'; }
function notify(msg, type='success'){
  const n = document.createElement('div');
  n.textContent = msg;
  Object.assign(n.style, {
    position:'fixed', top:'20px', right:'20px', padding:'14px 18px',
    borderRadius:'12px', color:'#fff', fontWeight:'800', zIndex:'10000',
    boxShadow:'var(--shadow)', transition:'var(--transition)',
    background: type==='success' ? 'var(--secondary)' : 'var(--danger)'
  });
  document.body.appendChild(n);
  setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateX(80px)'; setTimeout(()=>n.remove(),300); }, 2500);
}
$('year') && ($('year').textContent = new Date().getFullYear());

// -------- State --------
let web3Modal, provider, externalProvider, signer, account;
let token, staking, tokenDecimals = 18;

// -------- Web3Modal setup --------
const providerOptions = {
  walletconnect: {
    package: window.WalletConnectProvider.default,
    options: { rpc: { [BSC.chainIdDec]: BSC.rpc } }
  }
};
web3Modal = new window.Web3Modal.default({
  cacheProvider: false,
  providerOptions,
  theme: 'dark'
});

// -------- Chain guards --------
async function ensureBSC(eth){
  const current = await eth.request({ method: 'eth_chainId' });
  if (current.toLowerCase() === BSC.chainIdHex) return true;
  try {
    await eth.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: BSC.chainIdHex }]
    });
    return true;
  } catch (e){
    // Add chain and retry
    if (e.code === 4902 || (e.data && e.data.originalError && e.data.originalError.code === 4902)) {
      await eth.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: BSC.chainIdHex,
          chainName: BSC.name,
          nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
          rpcUrls: [BSC.rpc],
          blockExplorerUrls: [BSC.explorer]
        }]
      });
      return true;
    }
    throw e;
  }
}

// -------- Connect wallet --------
$('connectWallet').addEventListener('click', connectWallet);

async function connectWallet(){
  try {
    externalProvider = await web3Modal.connect();
    // Force BSC
    await ensureBSC(externalProvider);
    provider = new window.ethers.providers.Web3Provider(externalProvider, 'any');
    signer = provider.getSigner();
    account = await signer.getAddress();

    // Instances
    token   = new window.ethers.Contract(TOKEN_ADDR, ERC20_ABI, signer);
    staking = new window.ethers.Contract(STAKING_ADDR, STAKING_ABI, signer);
    tokenDecimals = await token.decimals();

    // UI
    $('connectWallet').style.display = 'none';
    $('walletInfo').style.display = 'flex';
    $('walletAddress').textContent = shorten(account);
    $('network').textContent = BSC.name;

    // Listeners
    externalProvider.on && externalProvider.on('accountsChanged', () => location.reload());
    externalProvider.on && externalProvider.on('chainChanged',   () => location.reload());
    externalProvider.on && externalProvider.on('disconnect',     () => location.reload());

    await refreshAll();
    notify('Wallet connected on BNB Smart Chain','success');
  } catch (err){
    console.error(err);
    notify(parseError(err),'error');
  }
}

// -------- Read & paint --------
async function refreshAll(){
  if (!signer) return;

  // Balances
  const [klyBalRaw, stakedRaw, rewardsRaw, tvlRaw] = await Promise.allSettled([
    token.balanceOf(account),
    staking.stakedBalance(account),
    staking.pendingRewards(account),
    staking.totalStaked()
  ]);

  const klyBal = settled(klyBalRaw, '0');
  const staked = settled(stakedRaw, '0');
  const rewards = settled(rewardsRaw, '0');
  const tvl = settled(tvlRaw, '0');

  const klyBalF = window.ethers.utils.formatUnits(klyBal, tokenDecimals);
  const stakedF = window.ethers.utils.formatUnits(staked, tokenDecimals);
  const rewardsF = window.ethers.utils.formatUnits(rewards, tokenDecimals);
  const tvlF = window.ethers.utils.formatUnits(tvl, tokenDecimals);

  // Dashboard
  setText('klyBalance', fmt(klyBalF, 4));
  setText('stakedKly', `${fmt(stakedF, 4)} KLY`);
  setText('rewardsKly', `${fmt(rewardsF, 4)} KLY`);
  setText('vaultKly', `${fmt(stakedF, 4)} KLY`);

  // Unknown from-chain — keep APY placeholders
  setText('apyCurrent', '—');
  setText('avgApy', '—');
  setText('rewardsMonthly', '—');

  // Vault info (optional)
  try {
    const tl = await staking.timelockSeconds();
    setText('timelock', `${Number(tl)/3600} hours`);
  } catch { setText('timelock', '—'); }

  setText('vaultStatus', 'Connected');
  setText('vaultHealth', '—');

  // Global stats
  setText('tvl', `${fmt(tvlF, 0)} KLY`);
  setText('activeStakers', '—');

  // Progress bar: arbitrary example (staked vs 10k target)
  const target = 10000;
  const pct = Math.max(0, Math.min(100, (Number(stakedF)/target)*100));
  $('stakeProgress').style.width = `${pct.toFixed(0)}%`;
  setText('stakeProgressLabel', `${pct.toFixed(0)}%`);

  // Prefill unstake modal
  setText('stakedForUnstake', fmt(stakedF, 4));
}

function settled(p, fallback){
  return p.status === 'fulfilled' ? p.value : window.ethers.BigNumber.from(fallback);
}
function setText(id, value){ const el=$(id); if(el) el.textContent = value; }

// -------- Stake / Approve (exact amount) --------
$('confirmStake').addEventListener('click', doStake);
$('confirmUnstake').addEventListener('click', doUnstake);
$('claimBtn').addEventListener('click', doClaim);

// Open modals
$('stakeBtn').addEventListener('click', ()=> openModal('stakeModal'));
$('unstakeBtn').addEventListener('click', ()=> openModal('unstakeModal'));

// Modal helpers
function openModal(id){ const m=$(id); if(!m) return; m.style.display='flex'; m.querySelector('.close-modal').focus(); }
function closeModal(id){ const m=$(id); if(!m) return; m.style.display='none'; }
document.querySelectorAll('.close-modal').forEach(btn=>{
  btn.addEventListener('click', e=> closeModal(e.currentTarget.dataset.close));
});
window.addEventListener('click', (e)=>{
  if(e.target === $('stakeModal')) closeModal('stakeModal');
  if(e.target === $('unstakeModal')) closeModal('unstakeModal');
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ closeModal('stakeModal'); closeModal('unstakeModal'); }
});

async function doStake(){
  try {
    requireConnected();
    const raw = $('stakeAmount').value.trim();
    if (!raw || Number(raw) <= 0) throw new Error('Enter a valid stake amount.');

    const amt = window.ethers.utils.parseUnits(raw, tokenDecimals);

    // Check allowance
    const allowance = await token.allowance(account, STAKING_ADDR);
    if (allowance.lt(amt)) {
      const approveTx = await token.approve(STAKING_ADDR, amt); // exact amount
      notify('Approving KLY spend…');
      await approveTx.wait();
    }

    // Stake
    const tx = await staking.stake(amt);
    notify('Staking submitted…');
    await tx.wait();
    notify('Stake confirmed!', 'success');

    closeModal('stakeModal');
    await refreshAll();
  } catch (err){
    console.error(err);
    notify(parseError(err), 'error');
  }
}

async function doUnstake(){
  try {
    requireConnected();
    const raw = $('unstakeAmount').value.trim();
    if (!raw || Number(raw) <= 0) throw new Error('Enter a valid unstake amount.');

    const amt = window.ethers.utils.parseUnits(raw, tokenDecimals);
    const tx = await staking.unstake(amt);
    notify('Unstake submitted…');
    await tx.wait();
    notify('Unstake initiated (cooldown may apply).', 'success');

    closeModal('unstakeModal');
    await refreshAll();
  } catch (err){
    console.error(err);
    notify(parseError(err), 'error');
  }
}

async function doClaim(){
  try {
    requireConnected();
    const tx = await staking.claimRewards();
    notify('Claiming rewards…');
    await tx.wait();
    notify('Rewards claimed!', 'success');
    await refreshAll();
  } catch (err){
    console.error(err);
    notify(parseError(err), 'error');
  }
}

function requireConnected(){
  if (!signer || !account) throw new Error('Connect your wallet first.');
}

// -------- Error parsing --------
function parseError(e){
  const s = e?.data?.message || e?.error?.message || e?.message || String(e);
  // Common wallet warnings
  if (/user rejected|denied transaction/i.test(s)) return 'Transaction rejected.';
  if (/insufficient funds/i.test(s)) return 'Insufficient funds for gas.';
  if (/chain id/i.test(s)) return 'Wrong network. Please switch to BNB Smart Chain.';
  return s.length > 180 ? s.slice(0,180)+'…' : s;
}
</script>
</body>
</html>
